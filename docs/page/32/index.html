<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"syxdevcode.github.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.24.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="syxdevcode的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="syxdevcode博客">
<meta property="og:url" content="https://syxdevcode.github.com/page/32/index.html">
<meta property="og:site_name" content="syxdevcode博客">
<meta property="og:description" content="syxdevcode的个人博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="syxdevcode">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://syxdevcode.github.com/page/32/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/32/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>syxdevcode博客</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">syxdevcode博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">syxdevcode</p>
  <div class="site-description" itemprop="description">syxdevcode的个人博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">619</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">157</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">241</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/syxdevcode" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;syxdevcode" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/29/MongoDB%E5%9C%A8C-%E4%B8%AD%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | syxdevcode博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/29/MongoDB%E5%9C%A8C-%E4%B8%AD%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">MongoDB在C#中使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-29 14:31:05" itemprop="dateCreated datePublished" datetime="2020-09-29T14:31:05+08:00">2020-09-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-08-13 13:49:51" itemprop="dateModified" datetime="2025-08-13T13:49:51+08:00">2025-08-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MongoDB.Bson;</span><br><span class="line"><span class="keyword">using</span> MongoDB.Driver;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MongoDBTest</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> MongoDBConnection = <span class="string">&quot;mongodb://localhost:27017/admin&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> IMongoClient _client = <span class="keyword">new</span> MongoClient(MongoDBConnection);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> IMongoDatabase _database = _client.GetDatabase(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> IMongoCollection&lt;CollectionModel&gt; _collection = _database.GetCollection&lt;CollectionModel&gt;(<span class="string">&quot;TestCollection&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 添加</span></span><br><span class="line">            <span class="keyword">await</span> InsertOneAsyncTest();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;-----------FindAsyncTest输出---------------&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> FindAsyncTest();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;-----------Query输出---------------&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> Query(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;-----------SkipAndSortAndLimitAndProjections输出---------------&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> request = <span class="keyword">new</span> PageRequest &#123;PageIndex = <span class="number">1</span>, PageSize = <span class="number">2</span>&#125;;</span><br><span class="line">            <span class="keyword">await</span> SkipAndSortAndLimitAndProjections(request);</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 查询，支持模糊查询</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;keyword&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Query</span>(<span class="params"><span class="built_in">string</span> keyword</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            FilterDefinitionBuilder&lt;CollectionModel&gt; builder = Builders&lt;CollectionModel&gt;.Filter;</span><br><span class="line">            <span class="built_in">string</span> p = keyword == <span class="literal">null</span> ? <span class="string">$&quot;.*<span class="subst">&#123;Regex.Escape(<span class="string">&quot;&quot;</span>)&#125;</span>.*&quot;</span> : <span class="string">$&quot;.*<span class="subst">&#123;Regex.Escape(keyword)&#125;</span>.*&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//1,条件为空</span></span><br><span class="line">            <span class="comment">//FilterDefinition&lt;CollectionModel&gt; filter2 = FilterDefinition&lt;CollectionModel&gt;.Empty;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//2,不区分大小写</span></span><br><span class="line">            FilterDefinition&lt;CollectionModel&gt; filter2 = builder.Regex(<span class="string">&quot;title&quot;</span>, <span class="keyword">new</span> BsonRegularExpression(<span class="keyword">new</span> Regex(p, RegexOptions.IgnoreCase)));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 以下两种写法区分大小写</span></span><br><span class="line">            <span class="comment">//FilterDefinition&lt;CollectionModel&gt; filter2 = builder.Regex(&quot;title&quot;, new BsonRegularExpression(p));</span></span><br><span class="line">            <span class="comment">//BsonDocument filter2 = new BsonDocument &#123; &#123; &quot;title&quot;, $&quot;/&#123;keyword&#125;/&quot; &#125; &#125;;</span></span><br><span class="line"></span><br><span class="line">            FindOptions&lt;CollectionModel&gt; options = <span class="keyword">new</span> FindOptions&lt;CollectionModel&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                BatchSize = <span class="number">2</span>,</span><br><span class="line">                NoCursorTimeout = <span class="literal">false</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">var</span> cursor = <span class="keyword">await</span> _collection.FindAsync(filter2, options);</span><br><span class="line">            <span class="keyword">var</span> batch = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">await</span> cursor.MoveNextAsync())</span><br><span class="line">            &#123;</span><br><span class="line">                batch++;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;Batch: <span class="subst">&#123;batch&#125;</span>&quot;</span>);</span><br><span class="line">                IEnumerable&lt;CollectionModel&gt; documents = cursor.Current;</span><br><span class="line">                <span class="keyword">foreach</span> (CollectionModel document <span class="keyword">in</span> documents)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(document.ToJson());</span><br><span class="line">                    Console.WriteLine();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Skip, Sort, Limit, Projections</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;request&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">SkipAndSortAndLimitAndProjections</span>(<span class="params">PageRequest request</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">await</span> _collection.Find(FilterDefinition&lt;CollectionModel&gt;.Empty)</span><br><span class="line">                .Skip((request.PageIndex - <span class="number">1</span>) * request.PageSize)</span><br><span class="line">                .Limit(request.PageSize)</span><br><span class="line">                <span class="comment">//.Sort(Builders&lt;CollectionModel&gt;.Sort.Descending(&quot;title&quot;))</span></span><br><span class="line">                <span class="comment">//.Sort(Builders&lt;CollectionModel&gt;.Sort.Descending(x =&gt; x.title).Ascending(x =&gt; x.content))</span></span><br><span class="line">                .Sort(<span class="string">&quot;&#123;title: 1&#125;&quot;</span>)</span><br><span class="line">                .Project(x =&gt; <span class="keyword">new</span> &#123; x.m_id, x.title, x.content, x.userinfo &#125;)</span><br><span class="line">                .ForEachAsync(</span><br><span class="line">                    obj =&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        Console.WriteLine(<span class="string">$&quot;S/N: <span class="subst">&#123;count&#125;</span>, \t Id: <span class="subst">&#123;obj.m_id&#125;</span>, title: <span class="subst">&#123;obj.title&#125;</span>, content: <span class="subst">&#123;obj.content&#125;</span>, serinfo.name: <span class="subst">&#123;obj?.userinfo?.name&#125;</span>&quot;</span>);</span><br><span class="line">                        count++;</span><br><span class="line">                    &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">InsertOneAsyncTest</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            CollectionModel model = <span class="keyword">new</span> CollectionModel();</span><br><span class="line">            model.title = <span class="string">&quot;A1&quot;</span>;</span><br><span class="line">            model.content = <span class="string">&quot;可以测试&quot;</span>;</span><br><span class="line">            model.userinfo = <span class="keyword">new</span> UserModel</span><br><span class="line">            &#123;</span><br><span class="line">                name = <span class="string">&quot;测试&quot;</span>,</span><br><span class="line">                addressList = <span class="keyword">new</span> List&lt;AddressModel&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">new</span> AddressModel &#123; address = <span class="string">&quot;北京&quot;</span> &#125;,</span><br><span class="line">                    <span class="keyword">new</span> AddressModel &#123; address = <span class="string">&quot;上海&quot;</span> &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">await</span> _collection.InsertOneAsync(model);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">FindAsyncTest</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> IAsyncCursor&lt;CollectionModel&gt; cursor = <span class="keyword">await</span> _collection.FindAsync(<span class="keyword">new</span> BsonDocument());</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">await</span> cursor.MoveNextAsync())</span><br><span class="line">            &#123;</span><br><span class="line">                IEnumerable&lt;CollectionModel&gt; batch = cursor.Current;</span><br><span class="line">                <span class="keyword">foreach</span> (CollectionModel document <span class="keyword">in</span> batch)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(document.ToJson());</span><br><span class="line">                    Console.WriteLine();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="公共类"><a href="#公共类" class="headerlink" title="公共类"></a>公共类</h2><p>做通用查询的时候，可以使用。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 公共页面请求参数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PageRequest</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> PageIndex &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> PageSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 公用页面参数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ParameterBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> CollectName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> PageIndex &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> PageSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 公用页面参数-MongoDB</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PageMongoParameter</span> : <span class="title">ParameterBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> BsonDocument Sort &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> BsonDocument Skip &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> BsonDocument Limit &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> BsonDocument Filter2 &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BsonDocument[] Pipeline &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PageMongoParameter</span>(<span class="params">PageRequest req, <span class="built_in">string</span> collectName, BsonDocument filter = <span class="literal">null</span>, </span></span></span><br><span class="line"><span class="params"><span class="function">            BsonDocument sort = <span class="literal">null</span>, BsonDocument filter2 = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        CollectName = collectName;</span><br><span class="line">        PageIndex = req.PageIndex;</span><br><span class="line">        PageSize = req.PageSize;</span><br><span class="line">        Limit = <span class="keyword">new</span> BsonDocument &#123; &#123; <span class="string">&quot;$limit&quot;</span>, PageSize &#125; &#125;;</span><br><span class="line">        Skip = <span class="keyword">new</span> BsonDocument &#123; &#123; <span class="string">&quot;$skip&quot;</span>, (PageIndex - <span class="number">1</span>) * PageSize &#125; &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sort == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(req.Order)) Sort = <span class="keyword">new</span> BsonDocument &#123; &#123; <span class="string">&quot;$sort&quot;</span>, <span class="keyword">new</span> BsonDocument &#123; &#123; req.Order, <span class="number">1</span> &#125; &#125; &#125; &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Sort = sort;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (filter != <span class="literal">null</span> &amp;&amp; filter2 == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> dom = filter.GetElement(<span class="number">0</span>);</span><br><span class="line">            Filter2 = BsonDocument.Parse(dom.Value.ToJson());</span><br><span class="line">        &#125;</span><br><span class="line">        Filter2 ??= <span class="keyword">new</span> BsonDocument();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (filter == <span class="literal">null</span> &amp;&amp; Sort == <span class="literal">null</span>)</span><br><span class="line">            Pipeline = <span class="keyword">new</span>[] &#123; Skip, Limit &#125;;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="literal">null</span> &amp;&amp; Sort != <span class="literal">null</span>)</span><br><span class="line">                Pipeline = <span class="keyword">new</span>[] &#123; filter, Skip, Limit, Sort &#125;;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Pipeline = filter == <span class="literal">null</span> ? <span class="keyword">new</span>[] &#123; Skip, Limit, Sort &#125; : <span class="keyword">new</span>[] &#123; filter, Skip, Limit &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/28/MongoDB%20Dotnet%20Core%E6%95%B0%E6%8D%AE%E6%98%A0%E5%B0%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | syxdevcode博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/28/MongoDB%20Dotnet%20Core%E6%95%B0%E6%8D%AE%E6%98%A0%E5%B0%84/" class="post-title-link" itemprop="url">MongoDB Dotnet Core数据映射</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-28 13:56:36" itemprop="dateCreated datePublished" datetime="2020-09-28T13:56:36+08:00">2020-09-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-08-13 13:49:51" itemprop="dateModified" datetime="2025-08-13T13:49:51+08:00">2025-08-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>作为一个数据库，基本的操作就是 <code>CRUD</code>。<code>MongoDB</code> 的 <code>CRUD</code>，不使用 <code>SQL</code> 来写，而是提供了更简单的方式。</p>
<p><strong>BsonDocument方式</strong></p>
<p><code>BsonDocument</code> 方式，适合能熟练使用 <code>MongoDB Shell</code> 的开发者。<code>MongoDB Driver</code> 提供了完全覆盖 <code>Shell</code> 命令的各种方式，来处理用户的 <code>CRUD</code> 操作。</p>
<p>这种方法自由度很高，可以在不需要知道完整数据集结构的情况下，完成数据库的CRUD操作。</p>
<p><strong>数据映射方式</strong></p>
<p>数据映射是最常用的一种方式。准备好需要处理的数据类，直接把数据类映射到 <code>MongoDB</code>，并对数据集进行 <code>CRUD</code> 操作。</p>
<h2 id="字段映射"><a href="#字段映射" class="headerlink" title="字段映射"></a>字段映射</h2><h3 id="ID字段"><a href="#ID字段" class="headerlink" title="ID字段"></a>ID字段</h3><p><code>MongoDB</code> 数据集中存放的数据，称之为文档（<code>Document</code>）。每个文档在存放时，都需要有一个ID，而这个 <code>ID</code> 的名称，固定叫 <code>_id</code>，类型是 <code>MongoDB.Bson.ObjectId</code>。</p>
<p>当建立映射时，如果给出 <code>_id</code> 字段，则 <code>MongoDB</code> 会采用这个 <code>ID</code> 做为这个文档的 <code>ID</code> ，如果不给出，<code>MongoDB</code> 会自动添加一个 <code>_id</code> 字段。在使用上是完全一样的。唯一的区别是，如果映射类中不写 <code>_id</code>，则 <code>MongoDB</code> 自动添加 <code>_id</code> 时，会用 <code>ObjectId</code> 作为这个字段的数据类型。</p>
<p><code>ObjectId</code> 是一个全局唯一的数据。</p>
<p><code>MongoDB</code> 允许使用其它类型的数据作为 <code>ID</code>，例如：<code>string</code>，<code>int</code>，<code>long</code>，<code>GUID</code> 等，但这就需要你自己去保证这些数据不超限并且唯一。</p>
<p>可以在类中修改 <code>_id</code> 名称为别的名称，但需要加一个描述属性 <code>BsonId</code>，<code>BsonId</code> 属性会告诉映射，<code>topic_id</code> 就是这个文档数据的<code>ID</code> 。<code>MongoDB</code>在保存时，会将这个 <code>topic_id</code> 转成 <code>_id</code> 保存到数据集中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CollectionModel</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">BsonId</span>]</span><br><span class="line">    <span class="keyword">public</span> ObjectId topic_id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> content &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注：在 <code>MongoDB</code> 数据集中，<code>ID</code> 字段的名称固定叫 <code>_id</code>。为了代码的阅读方便，可以在类中改为别的名称，但这不会影响 <code>MongoDB</code> 中存放的 <code>ID</code> 名称。</p>
<h2 id="2-特殊类型-Decimal"><a href="#2-特殊类型-Decimal" class="headerlink" title="2. 特殊类型 - Decimal"></a>2. 特殊类型 - Decimal</h2><p><code>MongoDB</code> 在早期，是不支持 <code>Decimal</code> 的。直到 <code>MongoDB v3.4</code> 开始，数据库才正式支持 <code>Decimal</code>。</p>
<p>所以，如果使用的是 <code>v3.4</code> 以后的版本，可以直接使用，而如果是以前的版本，需要用以下的方式：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonRepresentation(BsonType.Double, AllowTruncation = true)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">decimal</span> price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>其实就是把 <code>Decimal</code> 通过映射，转为 <code>Double</code> 存储。</p>
<h2 id="类字段"><a href="#类字段" class="headerlink" title="类字段"></a>类字段</h2><p>添加两个类 <code>Contact</code> 和 <code>Author</code>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Contact</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> mobile &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Author</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;Contact&gt; contacts &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CollectionModel</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">BsonId</span>]</span><br><span class="line">    <span class="keyword">public</span> ObjectId topic_id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> content &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> favor &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> Author author &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">调用 代码:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Demo</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    CollectionModel new_item = <span class="keyword">new</span> CollectionModel()</span><br><span class="line">    &#123;</span><br><span class="line">        title = <span class="string">&quot;Demo&quot;</span>,</span><br><span class="line">        content = <span class="string">&quot;Demo content&quot;</span>,</span><br><span class="line">        favor = <span class="number">100</span>,</span><br><span class="line">        author = <span class="keyword">new</span> Author</span><br><span class="line">        &#123;</span><br><span class="line">            name = <span class="string">&quot;WangPlus&quot;</span>,</span><br><span class="line">            contacts = <span class="keyword">new</span> List&lt;Contact&gt;(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    Contact contact_item1 = <span class="keyword">new</span> Contact()</span><br><span class="line">    &#123;</span><br><span class="line">        mobile = <span class="string">&quot;13800000000&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    Contact contact_item2 = <span class="keyword">new</span> Contact()</span><br><span class="line">    &#123;</span><br><span class="line">        mobile = <span class="string">&quot;13811111111&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    new_item.author.contacts.Add(contact_item1);</span><br><span class="line">    new_item.author.contacts.Add(contact_item2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> _collection.InsertOneAsync(new_item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文档结构：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5ef1e635ce129908a22dfb5e&quot;</span>), </span><br><span class="line">    <span class="string">&quot;title&quot;</span> : <span class="string">&quot;Demo&quot;</span>, </span><br><span class="line">    <span class="string">&quot;content&quot;</span> : <span class="string">&quot;Demo content&quot;</span>, </span><br><span class="line">    <span class="string">&quot;favor&quot;</span> : NumberInt(<span class="number">100</span>),</span><br><span class="line">    <span class="string">&quot;author&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;WangPlus&quot;</span>, </span><br><span class="line">        <span class="string">&quot;contacts&quot;</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;mobile&quot;</span> : <span class="string">&quot;13800000000&quot;</span></span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;mobile&quot;</span> : <span class="string">&quot;13811111111&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="枚举字段"><a href="#枚举字段" class="headerlink" title="枚举字段"></a>枚举字段</h2><p>创建一个枚举 <code>TagEnumeration</code>:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> TagEnumeration</span><br><span class="line">&#123;</span><br><span class="line">    CSharp = <span class="number">1</span>,</span><br><span class="line">    Python = <span class="number">2</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加到 <code>CollectionModel</code> 中:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CollectionModel</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">BsonId</span>]</span><br><span class="line">    <span class="keyword">public</span> ObjectId topic_id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> content &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> favor &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> Author author &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> TagEnumeration tag &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Demo代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Demo</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    CollectionModel new_item = <span class="keyword">new</span> CollectionModel()</span><br><span class="line">    &#123;</span><br><span class="line">        title = <span class="string">&quot;Demo&quot;</span>,</span><br><span class="line">        content = <span class="string">&quot;Demo content&quot;</span>,</span><br><span class="line">        favor = <span class="number">100</span>,</span><br><span class="line">        author = <span class="keyword">new</span> Author</span><br><span class="line">        &#123;</span><br><span class="line">            name = <span class="string">&quot;WangPlus&quot;</span>,</span><br><span class="line">            contacts = <span class="keyword">new</span> List&lt;Contact&gt;(),</span><br><span class="line">        &#125;,</span><br><span class="line">        tag = TagEnumeration.CSharp,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    Contact contact_item1 = <span class="keyword">new</span> Contact()</span><br><span class="line">    &#123;</span><br><span class="line">        mobile = <span class="string">&quot;13800000000&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    Contact contact_item2 = <span class="keyword">new</span> Contact()</span><br><span class="line">    &#123;</span><br><span class="line">        mobile = <span class="string">&quot;13811111111&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    new_item.author.contacts.Add(contact_item1);</span><br><span class="line">    new_item.author.contacts.Add(contact_item2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> _collection.InsertOneAsync(new_item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>保存后的文档：注意，<code>tag</code> 保存了枚举的值。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5ef1eb87cbb6b109031fcc31&quot;</span>), </span><br><span class="line">    <span class="string">&quot;title&quot;</span> : <span class="string">&quot;Demo&quot;</span>, </span><br><span class="line">    <span class="string">&quot;content&quot;</span> : <span class="string">&quot;Demo content&quot;</span>, </span><br><span class="line">    <span class="string">&quot;favor&quot;</span> : NumberInt(<span class="number">100</span>), </span><br><span class="line">    <span class="string">&quot;author&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;WangPlus&quot;</span>, </span><br><span class="line">        <span class="string">&quot;contacts&quot;</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;mobile&quot;</span> : <span class="string">&quot;13800000000&quot;</span></span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;mobile&quot;</span> : <span class="string">&quot;13811111111&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">&quot;tag&quot;</span> : NumberInt(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以保存枚举的字符串。只要在 <code>CollectionModel</code> 中，<code>tag</code> 声明上加个属性：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonRepresentation(BsonType.String)</span>]</span><br><span class="line"><span class="keyword">public</span> TagEnumeration tag &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>数据会变成：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5ef1ec448f1d540919d15904&quot;</span>), </span><br><span class="line">    <span class="string">&quot;title&quot;</span> : <span class="string">&quot;Demo&quot;</span>, </span><br><span class="line">    <span class="string">&quot;content&quot;</span> : <span class="string">&quot;Demo content&quot;</span>, </span><br><span class="line">    <span class="string">&quot;favor&quot;</span> : NumberInt(<span class="number">100</span>), </span><br><span class="line">    <span class="string">&quot;author&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;WangPlus&quot;</span>, </span><br><span class="line">        <span class="string">&quot;contacts&quot;</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;mobile&quot;</span> : <span class="string">&quot;13800000000&quot;</span></span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;mobile&quot;</span> : <span class="string">&quot;13811111111&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">&quot;tag&quot;</span> : <span class="string">&quot;CSharp&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="日期字段"><a href="#日期字段" class="headerlink" title="日期字段"></a>日期字段</h2><p><code>CollectionModel</code> 中增加一个时间字段：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DateTime post_time &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p><code>MongoDB</code> 的 <code>datetime</code> 存储的是 <code>unixtimestamp</code> ，所以默认只能是 <code>utc0</code> 时区的，它问题出在 <code>C#</code> 的 <code>DateTime</code> 对时区的处理上遗留的问题，可以换成 <code>DateTimeOffset</code>。</p>
<p>如果只是保存（像上边这样），或者查询时使用时间作为条件（例如查询 <code>post_time &lt; DateTime.Now</code> 的数据）时，是可以使用的，不会出现问题。</p>
<p>但是，如果是查询结果中有时间字段，那这个字段，会被 <code>DateTime</code> 默认设置为 <code>DateTimeKind.Unspecified</code> 类型。而这个类型，是无时区信息的，输出显示时，会造成混乱。</p>
<p>为了避免这种情况，在进行时间字段的映射时，需要加上属性：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonDateTimeOptions(Kind = DateTimeKind.Local)</span>]</span><br><span class="line"><span class="keyword">public</span> DateTime post_time &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>这样做，会强制 <code>DateTime</code> 类型的字段为 <code>DateTimeKind.Local</code> 类型。这时候，从显示到使用就正确了。</p>
<p>数据集中存放的是 <code>UTC</code> 时间，跟我们正常的时间有8小时时差，如果我们需要按日统计，比方每天的销售额&#x2F;点击量。</p>
<p><strong>按年月日时分秒拆开存放</strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Post_Time</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> year &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> month &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> day &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> hour &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> minute &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> second &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>MyDateTimeSerializer</strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyDateTimeSerializer</span> : <span class="title">DateTimeSerializer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> DateTime <span class="title">Deserialize</span>(<span class="params">BsonDeserializationContext context, BsonDeserializationArgs <span class="keyword">args</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> obj = <span class="keyword">base</span>.Deserialize(context, <span class="keyword">args</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DateTime(obj.Ticks, DateTimeKind.Unspecified);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Serialize</span>(<span class="params">BsonSerializationContext context, BsonSerializationArgs <span class="keyword">args</span>, DateTime <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> utcValue = <span class="keyword">new</span> DateTime(<span class="keyword">value</span>.Ticks, DateTimeKind.Utc);</span><br><span class="line">        <span class="keyword">base</span>.Serialize(context, <span class="keyword">args</span>, utcValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：使用这个方法，一定不要添加时间的属性 <code>[BsonDateTimeOptions(Kind = DateTimeKind.Local)]</code></p>
<p>对某个特定映射的特定字段使用，比方只对 <code>CollectionModel</code> 的 <code>post_time</code> 字段来使用，可以这么写：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonSerializer(typeof(MyDateTimeSerializer))</span>]</span><br><span class="line"><span class="keyword">public</span> DateTime post_time &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//或者全局使用：</span></span><br><span class="line"></span><br><span class="line">BsonSerializer.RegisterSerializer(<span class="keyword">typeof</span>(DateTime), <span class="keyword">new</span> MongoDBDateTimeSerializer());</span><br><span class="line"></span><br><span class="line"><span class="comment">// BsonSerializer是 MongoDB.Driver 的全局对象,可以放到使用数据库前的任何地方。例如在Demo中，放在Main里：</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    BsonSerializer.RegisterSerializer(<span class="keyword">typeof</span>(DateTime), <span class="keyword">new</span> MyDateTimeSerializer());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> Demo();</span><br><span class="line">    Console.ReadKey();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Dictionary字段"><a href="#Dictionary字段" class="headerlink" title="Dictionary字段"></a>Dictionary字段</h2><p>数据声明很简单：</p>
<p><code>public Dictionary&lt;string, int&gt; extra_info &#123; get; set; &#125;</code></p>
<p><code>MongoDB</code> 定义了三种保存属性：<code>Document</code>、<code>ArrayOfDocuments</code>、<code>ArrayOfArrays</code>，默认是 <code>Document</code>。</p>
<p>属性写法是这样的：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonDictionaryOptions(DictionaryRepresentation.ArrayOfDocuments)</span>]</span><br><span class="line"><span class="keyword">public</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">int</span>&gt; extra_info &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>这三种属性下，保存在数据集中的数据结构有区别。多数情况用 <code>DictionaryRepresentation.ArrayOfDocuments</code>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DictionaryRepresentation.Document：</span></span><br><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;extra_info&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> NumberInt(<span class="number">1</span>)<span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;mode&quot;</span> <span class="punctuation">:</span> NumberInt(<span class="number">2</span>)</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// DictionaryRepresentation.ArrayOfDocuments：</span></span><br><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;extra_info&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;k&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;type&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;v&quot;</span> <span class="punctuation">:</span> NumberInt(<span class="number">1</span>)</span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;k&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;mode&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;v&quot;</span> <span class="punctuation">:</span> NumberInt(<span class="number">2</span>)</span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DictionaryRepresentation.ArrayOfArrays：</span></span><br><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;extra_info&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;type&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            NumberInt(<span class="number">1</span>)</span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;mode&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            NumberInt(<span class="number">2</span>)</span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这三种方式，从数据保存上并没有什么区别，但从查询来讲，如果这个字段需要进行查询，那三种方式区别很大。</p>
<p>如果采用 <code>BsonDocument</code> 方式查询，<code>DictionaryRepresentation.Document</code> 无疑是写着最方便的。</p>
<p>如果用 <code>Builder</code> 方式查询，<code>DictionaryRepresentation.ArrayOfDocuments</code> 是最容易写的。</p>
<p><code>DictionaryRepresentation.ArrayOfArrays</code> 就算了。数组套数组，查询条件写死人。</p>
<h2 id="BsonElement属性"><a href="#BsonElement属性" class="headerlink" title="BsonElement属性"></a>BsonElement属性</h2><p>用来改数据集中的字段名称。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonElement(<span class="string">&quot;pt&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> DateTime post_time &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>在不加 <code>BsonElement</code> 的情况下，通过数据映射写到数据集中的文档，字段名就是变量名，上面这个例子，字段名就是 <code>post_time</code> 。</p>
<p>加上 <code>BsonElement</code> 后，数据集中的字段名会变为 <code>pt</code>。</p>
<h2 id="BsonDefaultValue属性"><a href="#BsonDefaultValue属性" class="headerlink" title="BsonDefaultValue属性"></a>BsonDefaultValue属性</h2><p>设置字段的默认值。<br>当写入的时候，如果映射中不传入值，则数据库会把这个默认值存到数据集中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonDefaultValue(<span class="string">&quot;This is a default title&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<h2 id="BsonRepresentation属性"><a href="#BsonRepresentation属性" class="headerlink" title="BsonRepresentation属性"></a>BsonRepresentation属性</h2><p>用来在映射类中的数据类型和数据集中的数据类型做转换。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonRepresentation(BsonType.String)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> favor &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>表示，在映射类中，<code>favor</code> 字段是 <code>int</code> 类型的，而存到数据集中，会保存为 <code>string</code> 类型。</p>
<p>前边 <code>Decimal</code> 转换和枚举转换，就是用的这个属性。</p>
<h2 id="BsonIgnore属性"><a href="#BsonIgnore属性" class="headerlink" title="BsonIgnore属性"></a>BsonIgnore属性</h2><p>用来忽略某些字段。<br>忽略的意思是：映射类中某些字段，不希望被保存到数据集中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonIgnore</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> ignore_string &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>这样，在保存数据时，字段 <code>ignore_string</code> 就不会被保存到数据集中。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/M3zdBDc2ci5xfL-fazTH7A">MongoDB via Dotnet Core数据映射详解</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/28/hexo%E6%B7%BB%E5%8A%A0categories%E5%92%8Ctags%E9%A1%B5%E9%9D%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | syxdevcode博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/28/hexo%E6%B7%BB%E5%8A%A0categories%E5%92%8Ctags%E9%A1%B5%E9%9D%A2/" class="post-title-link" itemprop="url">hexo添加categories和tags页面</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-28 10:40:24" itemprop="dateCreated datePublished" datetime="2020-09-28T10:40:24+08:00">2020-09-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-08-13 13:49:52" itemprop="dateModified" datetime="2025-08-13T13:49:52+08:00">2025-08-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Hexo/" itemprop="url" rel="index"><span itemprop="name">Hexo</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>默认是没有 <code>categories</code> 和 <code>tags</code> 的：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo new page <span class="string">&quot;tags&quot;</span></span><br><span class="line">hexo new page <span class="string">&quot;categories&quot;</span></span><br></pre></td></tr></table></figure>

<p>编辑 <code>/tags/index.md</code></p>
<p>添加：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span>: tags</span><br><span class="line">layout: tags</span><br></pre></td></tr></table></figure>

<p><code>/categories/index.md</code></p>
<p>添加：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span>: categories</span><br><span class="line">layout: categories</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/28/%E8%8B%B1%E8%AF%AD%E6%9C%88%E4%BB%BD%E5%8D%95%E8%AF%8D%E7%AE%80%E5%86%99%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | syxdevcode博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/28/%E8%8B%B1%E8%AF%AD%E6%9C%88%E4%BB%BD%E5%8D%95%E8%AF%8D%E7%AE%80%E5%86%99%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">英语月份单词简写记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-28 10:30:20" itemprop="dateCreated datePublished" datetime="2020-09-28T10:30:20+08:00">2020-09-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-08-13 13:49:52" itemprop="dateModified" datetime="2025-08-13T13:49:52+08:00">2025-08-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%8D%95%E8%AF%8D%E6%94%B6%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">单词收录</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>一月 January，缩写 Jan</li>
<li>二月 February，缩写 Feb</li>
<li>三月 March，缩写 Mar</li>
<li>四月 April，缩写 Apr</li>
<li>五月 May，缩写 May</li>
<li>六月 June，缩写 Jun</li>
<li>七月 July，缩写 Jul</li>
<li>八月 August，缩写 Aug</li>
<li>九月 September，缩写 Sep&#x2F;Sept</li>
<li>十月 October，缩写 Oct</li>
<li>十一月 November，缩写 Nov</li>
<li>十二月 December，缩写 Dec</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/28/linux%E6%9F%A5%E7%9C%8B%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | syxdevcode博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/28/linux%E6%9F%A5%E7%9C%8B%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97/" class="post-title-link" itemprop="url">linux查看系统日志</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-28 10:19:47" itemprop="dateCreated datePublished" datetime="2020-09-28T10:19:47+08:00">2020-09-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-08-13 13:49:52" itemprop="dateModified" datetime="2025-08-13T13:49:52+08:00">2025-08-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/" itemprop="url" rel="index"><span itemprop="name">Linux基础命令</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="常见文件注解"><a href="#常见文件注解" class="headerlink" title="常见文件注解"></a>常见文件注解</h2><p>linux系统文件通常在 <code>/var/log</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 系统启动后的信息和错误日志</span></span><br><span class="line">/var/log/message</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与安全相关的日志信息</span></span><br><span class="line">/var/log/secure</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与邮件相关的日志信息</span></span><br><span class="line">/var/log/maillog</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与定时任务相关的日志信息</span></span><br><span class="line">/var/log/cron</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与UUCP和news设备相关的日志信息</span></span><br><span class="line">/var/log/spooler</span><br><span class="line"></span><br><span class="line"><span class="comment"># 守护进程启动和停止相关的日志消息</span></span><br><span class="line">/var/log/boot.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久记录每个用户登录、注销及系统的启动、停机的事件</span></span><br><span class="line">/var/log/wtmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录当前正在登录系统的用户信息</span></span><br><span class="line">/var/run/utmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录失败的登录尝试信息</span></span><br><span class="line">/var/log/btmp</span><br></pre></td></tr></table></figure>

<h2 id="历史记录"><a href="#历史记录" class="headerlink" title="历史记录"></a>历史记录</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看重启的命令</span></span><br><span class="line">last | grep reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 历史操作</span></span><br><span class="line"><span class="built_in">history</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 立即清空当前所有的历史记录</span></span><br><span class="line"><span class="built_in">history</span> -c </span><br></pre></td></tr></table></figure>

<h2 id="最近重启记录"><a href="#最近重启记录" class="headerlink" title="最近重启记录"></a>最近重启记录</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有重启日志信息</span></span><br><span class="line">last reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看最近的一条</span></span><br><span class="line">last reboot | <span class="built_in">head</span> -1</span><br><span class="line"></span><br><span class="line">last -x|grep shutdown | <span class="built_in">head</span> -1</span><br><span class="line"></span><br><span class="line"><span class="comment"># -x：显示系统关机和运行等级改变信息</span></span><br><span class="line">last</span><br><span class="line">last -x</span><br><span class="line">last -x reboot</span><br><span class="line">last -x shutdown</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机时间</span></span><br><span class="line"><span class="built_in">uptime</span> -s</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gzy19870815/article/details/88632729">linux系统重启 查看日志及历史记录</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/25/MongoDB-%E9%AB%98%E7%BA%A7%E6%93%8D%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | syxdevcode博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/25/MongoDB-%E9%AB%98%E7%BA%A7%E6%93%8D%E4%BD%9C/" class="post-title-link" itemprop="url">MongoDB 高级操作</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-25 09:53:19" itemprop="dateCreated datePublished" datetime="2020-09-25T09:53:19+08:00">2020-09-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-08-13 13:49:51" itemprop="dateModified" datetime="2025-08-13T13:49:51+08:00">2025-08-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ObjectId"><a href="#ObjectId" class="headerlink" title="ObjectId"></a>ObjectId</h2><p>ObjectId 是一个12字节 <code>BSON</code> 类型数据，有以下格式：</p>
<ul>
<li>前4个字节表示时间戳</li>
<li>接下来的3个字节是机器标识码</li>
<li>紧接的两个字节由进程id组成（PID）</li>
<li>最后三个字节是随机数。</li>
</ul>
<p><code>MongoDB</code> 中存储的文档必须有一个 <code>_id</code> 键。这个键的值可以是任何类型的，默认是个 <code>ObjectId</code> 对象。</p>
<p>在一个集合里面，每个文档都有唯一的 <code>_id</code> 值，来确保集合里面每个文档都能被唯一标识。</p>
<p><code>MongoDB</code> 采用 <code>ObjectId</code>，而不是其他比较常规的做法（比如自动增加的主键）的主要原因，因为在多个服务器上同步自动增加主键值既费力还费时。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.创建新的ObjectId</span></span><br><span class="line">newObjectId = ObjectId()</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">ObjectId(<span class="string">&quot;5f6d62d8b7424d4010318ac6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以使用生成的id来取代MongoDB自动生成的ObjectId：</span></span><br><span class="line">myObjectId = ObjectId(<span class="string">&quot;5f6d62d8b7424d4010318ac6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.创建文档的时间戳</span></span><br><span class="line"><span class="comment"># 由于 ObjectId 中存储了4个字节的时间戳，所以你不需要为你的文档保存时间戳字段，</span></span><br><span class="line"><span class="comment"># 可以通过 getTimestamp 函数来获取文档的创建时间:</span></span><br><span class="line">ObjectId(<span class="string">&quot;5f6d62d8b7424d4010318ac6&quot;</span>).getTimestamp()</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">ISODate(<span class="string">&quot;2020-09-25T03:24:08Z&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.ObjectId 转换为字符串</span></span><br><span class="line">new ObjectId().str</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">5f6d6374b7424d4010318ac7</span><br></pre></td></tr></table></figure>

<h2 id="文档关系"><a href="#文档关系" class="headerlink" title="文档关系"></a>文档关系</h2><p><code>MongoDB</code> 中的关系分为：<code>嵌入式关系</code> 和 <code>引用式关系</code>。</p>
<h3 id="嵌入式关系"><a href="#嵌入式关系" class="headerlink" title="嵌入式关系"></a>嵌入式关系</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span>ObjectId(<span class="string">&quot;52ffc33cd85242f436000001&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;phone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123345345&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;pincode&quot;</span><span class="punctuation">:</span> <span class="number">123456</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;beijing&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;California&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;pincode&quot;</span><span class="punctuation">:</span> <span class="number">456789</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shanghai&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Illinois&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询：</p>
<p><code>db.users.findOne(&#123;&quot;name&quot;:&quot;test&quot;&#125;,&#123;&quot;address&quot;:1&#125;)</code></p>
<p>这种数据结构的缺点是，如果用户和用户地址在不断增加，数据量不断变大，会影响读写性能。</p>
<h3 id="引用式关系"><a href="#引用式关系" class="headerlink" title="引用式关系"></a>引用式关系</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span>ObjectId(<span class="string">&quot;52ffc33cd85242f436000001&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;contact&quot;</span><span class="punctuation">:</span> <span class="string">&quot;987654321&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;dob&quot;</span><span class="punctuation">:</span> <span class="string">&quot;01-01-1991&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;address_ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      ObjectId(<span class="string">&quot;52ffc4a5d85242602e000000&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">      ObjectId(<span class="string">&quot;52ffc4a5d85242602e000001&quot;</span>)</span><br><span class="line">   <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var result = db.users.findOne(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;test&quot;</span>&#125;,&#123;<span class="string">&quot;address_ids&quot;</span>:1&#125;)</span><br><span class="line">var addresses = db.address.find(&#123;<span class="string">&quot;_id&quot;</span>:&#123;<span class="string">&quot;<span class="variable">$in</span>&quot;</span>:result[<span class="string">&quot;address_ids&quot;</span>]&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">var result = db.users.find(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;test&quot;</span>&#125;,&#123;<span class="string">&quot;address_ids&quot;</span>:1&#125;)</span><br><span class="line">var addresses = db.address.find(&#123;<span class="string">&quot;_id&quot;</span>:&#123;<span class="string">&quot;<span class="variable">$in</span>&quot;</span>:result[0][<span class="string">&quot;address_ids&quot;</span>]&#125;&#125;)</span><br></pre></td></tr></table></figure>

<p>注意：<code>find</code> 返回的数据类型是数组，<code>findOne</code> 返回的数据类型是对象。</p>
<h2 id="引用关系"><a href="#引用关系" class="headerlink" title="引用关系"></a>引用关系</h2><p><code>MongoDB</code> 引用有两种：</p>
<ul>
<li>手动引用（Manual References）</li>
<li>DBRefs</li>
</ul>
<h3 id="DBRefs"><a href="#DBRefs" class="headerlink" title="DBRefs"></a>DBRefs</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># $ref：集合名称</span></span><br><span class="line"><span class="comment"># $id：引用的id</span></span><br><span class="line"><span class="comment"># $db:数据库名称，可选参数</span></span><br><span class="line">&#123; <span class="variable">$ref</span> : , <span class="variable">$id</span> : , <span class="variable">$db</span> :  &#125;</span><br></pre></td></tr></table></figure>

<p>实例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span>ObjectId(<span class="string">&quot;53402597d852426020000002&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;address_home&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;$id&quot;</span><span class="punctuation">:</span> ObjectId(<span class="string">&quot;534009e4d852427820000002&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;$db&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runoob&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;contact&quot;</span><span class="punctuation">:</span> <span class="string">&quot;987654321&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;dob&quot;</span><span class="punctuation">:</span> <span class="string">&quot;01-01-1991&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var user = db.users.findOne(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;test1&quot;</span>&#125;)</span><br><span class="line">var dbRef = user.address</span><br><span class="line"></span><br><span class="line">db[dbRef.<span class="variable">$ref</span>].findOne(&#123;<span class="string">&quot;_id&quot;</span>:(dbRef.<span class="variable">$id</span>)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># MongoDB4.0 版本写法</span></span><br><span class="line">db[dbRef.<span class="variable">$ref</span>].findOne(&#123;<span class="string">&quot;_id&quot;</span>:ObjectId(dbRef.<span class="variable">$id</span>)&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="覆盖索引查询"><a href="#覆盖索引查询" class="headerlink" title="覆盖索引查询"></a>覆盖索引查询</h2><p>官方的 <code>MongoDB</code> 的文档中说明，覆盖查询是以下的查询：</p>
<ul>
<li>所有的查询字段是索引的一部分</li>
<li>所有的查询返回字段在同一个索引中</li>
</ul>
<p>由于所有出现在查询中的字段是索引的一部分， <code>MongoDB</code> 无需在整个数据文档中检索匹配查询条件和返回使用相同索引的查询结果。<br>因为索引存在于 <code>RAM</code> 中，从索引中获取数据比通过扫描文档读取数据要快得多。</p>
<h3 id="使用覆盖索引查询"><a href="#使用覆盖索引查询" class="headerlink" title="使用覆盖索引查询"></a>使用覆盖索引查询</h3><p>实例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> ObjectId(<span class="string">&quot;53402597d852426020000002&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;contact&quot;</span><span class="punctuation">:</span> <span class="string">&quot;987654321&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;dob&quot;</span><span class="punctuation">:</span> <span class="string">&quot;01-01-1991&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test1&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;user_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tombenzamin&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在 <code>users</code> 集合中创建联合索引，字段为 <code>gender</code> 和 <code>user_name</code> :</p>
<p><code>db.users.createIndex(&#123;gender:1,user_name:1&#125;)</code></p>
<p>该索引会覆盖以下查询：</p>
<p><code>db.users.find(&#123;gender:&quot;M&quot;&#125;,&#123;user_name:1,_id:0&#125;)</code></p>
<p>上述查询，<code>MongoDB</code> 的不会去数据库文件中查找。它会从索引中提取数据，这是非常快速的数据查询。</p>
<p>由于索引中不包括 <code>_id</code> 字段，<code>_id</code> 在查询中会默认返回，我们可以在 <code>MongoDB</code> 的查询结果集中排除它。</p>
<p>下面的实例没有排除 <code>_id</code>，查询就不会被覆盖：</p>
<p><code>db.users.find(&#123;gender:&quot;M&quot;&#125;,&#123;user_name:1&#125;)</code></p>
<p>最后，如果是以下的查询，不能使用覆盖索引查询：</p>
<ul>
<li>所有索引字段是一个数组</li>
<li>所有索引字段是一个子文档</li>
</ul>
<h2 id="查询分析"><a href="#查询分析" class="headerlink" title="查询分析"></a>查询分析</h2><p><code>MongoDB</code> 查询分析常用函数有：<code>explain()</code> 和 <code>hint()</code>。</p>
<h3 id="explain"><a href="#explain" class="headerlink" title="explain()"></a>explain()</h3><p><code>explain</code> 操作提供了查询信息，使用索引及查询统计等。有利于我们对索引的优化。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># users 集合中创建 gender 和 user_name 的索引：</span></span><br><span class="line">db.users.createIndex(&#123;gender:1,user_name:1&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在查询语句中使用 explain ：</span></span><br><span class="line">db.users.find(&#123;gender:<span class="string">&quot;M&quot;</span>&#125;,&#123;user_name:1,_id:0&#125;).explain()</span><br></pre></td></tr></table></figure>

<p> explain() 查询返回:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;cursor&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;BtreeCursor gender_1_user_name_1&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;isMultiKey&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;n&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;nscannedObjects&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;nscanned&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;nscannedObjectsAllPlans&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;nscannedAllPlans&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;scanAndOrder&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;indexOnly&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;nYields&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;nChunkSkips&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;millis&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;indexBounds&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">         <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;M&quot;</span></span><br><span class="line">         <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;user_name&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">         <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;$minElement&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;$maxElement&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">         <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>结果集的字段：</p>
<ul>
<li>indexOnly: 字段为 true ，表示我们使用了索引。</li>
<li>cursor：因为这个查询使用了索引，<code>MongoDB</code> 中索引存储在B树结构中，所以这是也使用了 <code>BtreeCursor</code> 类型的游标。如果没有使用索引，游标的类型是 <code>BasicCursor</code>。这个键还会给出你所使用的索引的名称，你通过这个名称可以查看当前数据库下的 <code>system.indexes</code> 集合（系统自动创建，由于存储索引信息，这个稍微会提到）来得到索引的详细信息。</li>
<li>n：当前查询返回的文档数量。</li>
<li>nscanned&#x2F;nscannedObjects：表明当前这次查询一共扫描了集合中多少个文档，我们的目的是，让这个数值和返回文档的数量越接近越好。</li>
<li>millis：当前查询所需时间，毫秒数。</li>
<li>indexBounds：当前查询具体使用的索引。</li>
</ul>
<h3 id="hint"><a href="#hint" class="headerlink" title="hint()"></a>hint()</h3><p><code>hint()</code> 来强制 <code>MongoDB</code> 使用一个指定的索引。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.users.find(&#123;gender:<span class="string">&quot;M&quot;</span>&#125;,&#123;user_name:1,_id:0&#125;).hint(&#123;gender:1,user_name:1&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以使用 explain() 函数来分析以上查询：</span></span><br><span class="line">db.users.find(&#123;gender:<span class="string">&quot;M&quot;</span>&#125;,&#123;user_name:1,_id:0&#125;).hint(&#123;gender:1,user_name:1&#125;).explain()</span><br></pre></td></tr></table></figure>

<h2 id="原子操作"><a href="#原子操作" class="headerlink" title="原子操作"></a>原子操作</h2><p><code>MongoDB</code> 提供了许多原子操作，比如文档的保存，修改，删除等，都是原子操作。</p>
<p>所谓原子操作就是要么这个文档保存到 <code>MongoDB</code>，要么没有保存到 <code>MongoDB</code>，不会出现查询到的文档没有保存完整的情况。</p>
<p><code>db.collection.findAndModify()</code> 方法来判断书籍是否可结算并更新新的结算信息。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.books.findAndModify ( &#123;</span><br><span class="line">   query: &#123;</span><br><span class="line">            _id: 123456789,</span><br><span class="line">            available: &#123; <span class="variable">$gt</span>: 0 &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">   update: &#123;</span><br><span class="line">             <span class="variable">$inc</span>: &#123; available: -1 &#125;,</span><br><span class="line">             <span class="variable">$push</span>: &#123; checkout: &#123; by: <span class="string">&quot;abc&quot;</span>, <span class="built_in">date</span>: new Date() &#125; &#125;</span><br><span class="line">           &#125;</span><br><span class="line">&#125; )</span><br></pre></td></tr></table></figure>

<h3 id="原子操作常用命令"><a href="#原子操作常用命令" class="headerlink" title="原子操作常用命令"></a>原子操作常用命令</h3><p><strong>$set</strong></p>
<p>用来指定一个键并更新键值，若键不存在并创建。</p>
<p><code>&#123; $set : &#123; field : value &#125; &#125;</code></p>
<p><strong>$unset</strong></p>
<p>用来删除一个键。</p>
<p><code>&#123; $unset : &#123; field : 1&#125; &#125;</code></p>
<p><strong>$inc</strong></p>
<p>$inc可以对文档的某个值为数字型（只能为满足要求的数字）的键进行增减的操作。</p>
<p><code>&#123; $inc : &#123; field : value &#125; &#125;</code></p>
<p><strong>$push</strong></p>
<p>把value追加到field里面去，field一定要是数组类型才行，如果field不存在，会新增一个数组类型加进去。</p>
<p><code>&#123; $push : &#123; field : value &#125; &#125;</code></p>
<p><strong>$pushAll</strong></p>
<p>同 <code>$push</code>,只是一次可以追加多个值到一个数组字段内。</p>
<p><code>&#123; $pushAll : &#123; field : value_array &#125; &#125;</code></p>
<p><strong>$pull</strong></p>
<p>从数组field内删除一个等于value值。</p>
<p><code>&#123; $pull : &#123; field : _value &#125; &#125;</code></p>
<p><strong>$addToSet</strong></p>
<p>增加一个值到数组内，而且只有当这个值不在数组内才增加。</p>
<p><strong>$pop</strong></p>
<p>删除数组的第一个或最后一个元素</p>
<p><code>&#123; $pop : &#123; field : 1 &#125; &#125;</code></p>
<p><strong>$rename</strong></p>
<p>修改字段名称</p>
<p><code>&#123; $rename : &#123; old_field_name : new_field_name &#125; &#125;</code></p>
<p><strong>$bit</strong></p>
<p>位操作，integer类型</p>
<p><code>&#123;$bit : &#123; field : &#123;and : 5&#125;&#125;&#125;</code></p>
<p><strong>偏移操作符</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">t.<span class="function"><span class="title">find</span></span>() &#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;4b97e62bf1d8c7152c9ccb74&quot;</span>), <span class="string">&quot;title&quot;</span> : <span class="string">&quot;ABC&quot;</span>, <span class="string">&quot;comments&quot;</span> : [ &#123; <span class="string">&quot;by&quot;</span> : <span class="string">&quot;joe&quot;</span>, <span class="string">&quot;votes&quot;</span> : 3 &#125;, &#123; <span class="string">&quot;by&quot;</span> : <span class="string">&quot;jane&quot;</span>, <span class="string">&quot;votes&quot;</span> : 7 &#125; ] &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 重点</span></span><br><span class="line">t.update( &#123;<span class="string">&#x27;comments.by&#x27;</span>:<span class="string">&#x27;joe&#x27;</span>&#125;, &#123;<span class="variable">$inc</span>:&#123;<span class="string">&#x27;comments.$.votes&#x27;</span>:1&#125;&#125;, <span class="literal">false</span>, <span class="literal">true</span> )</span><br><span class="line"> </span><br><span class="line">t.<span class="function"><span class="title">find</span></span>() &#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;4b97e62bf1d8c7152c9ccb74&quot;</span>), <span class="string">&quot;title&quot;</span> : <span class="string">&quot;ABC&quot;</span>, <span class="string">&quot;comments&quot;</span> : [ &#123; <span class="string">&quot;by&quot;</span> : <span class="string">&quot;joe&quot;</span>, <span class="string">&quot;votes&quot;</span> : 4 &#125;, &#123; <span class="string">&quot;by&quot;</span> : <span class="string">&quot;jane&quot;</span>, <span class="string">&quot;votes&quot;</span> : 7 &#125; ] &#125;</span><br></pre></td></tr></table></figure>

<h2 id="高级索引"><a href="#高级索引" class="headerlink" title="高级索引"></a>高级索引</h2><p>实例 文档集合（users）包含了 <code>address</code> 子文档和 <code>tags</code> 数组：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Los Angeles&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;California&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pincode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123&quot;</span></span><br><span class="line">   <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;music&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;cricket&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;blogs&quot;</span></span><br><span class="line">   <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Tom Benzamin&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="索引数组字段"><a href="#索引数组字段" class="headerlink" title="索引数组字段"></a>索引数组字段</h3><p>在数组中创建索引，需要对数组中的每个字段依次建立索引。所以在我们为数组 <code>tags</code> 创建索引时，会为 <code>music、cricket、blogs</code> 三个值建立单独的索引。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建数组索引：</span></span><br><span class="line"></span><br><span class="line">db.users.createIndex(&#123;<span class="string">&quot;tags&quot;</span>:1&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建索引后，我们可以这样检索集合的 tags 字段：</span></span><br><span class="line">db.users.find(&#123;tags:<span class="string">&quot;cricket&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为了验证我们使用使用了索引，可以使用 explain 命令：</span></span><br><span class="line"><span class="comment"># 执行结果中会显示 &quot;cursor&quot; : &quot;BtreeCursor tags_1&quot; ，则表示已经使用了索引。</span></span><br><span class="line">db.users.find(&#123;tags:<span class="string">&quot;cricket&quot;</span>&#125;).explain()</span><br></pre></td></tr></table></figure>

<h3 id="索引子文档字段"><a href="#索引子文档字段" class="headerlink" title="索引子文档字段"></a>索引子文档字段</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为子文档的三个字段创建索引，命令如下：</span></span><br><span class="line">db.users.createIndex(&#123;<span class="string">&quot;address.city&quot;</span>:1,<span class="string">&quot;address.state&quot;</span>:1,<span class="string">&quot;address.pincode&quot;</span>:1&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一旦创建索引，我们可以使用子文档的字段来检索数据：</span></span><br><span class="line">db.users.find(&#123;<span class="string">&quot;address.city&quot;</span>:<span class="string">&quot;Los Angeles&quot;</span>&#125;)   </span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询表达不一定遵循指定的索引的顺序，mongodb 会自动优化。所以上面创建的索引将支持以下查询：</span></span><br><span class="line">db.users.find(&#123;<span class="string">&quot;address.state&quot;</span>:<span class="string">&quot;California&quot;</span>,<span class="string">&quot;address.city&quot;</span>:<span class="string">&quot;Los Angeles&quot;</span>&#125;) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 同样支持以下查询：</span></span><br><span class="line">db.users.find(&#123;<span class="string">&quot;address.city&quot;</span>:<span class="string">&quot;Los Angeles&quot;</span>,<span class="string">&quot;address.state&quot;</span>:<span class="string">&quot;California&quot;</span>,<span class="string">&quot;address.pincode&quot;</span>:<span class="string">&quot;123&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="索引限制"><a href="#索引限制" class="headerlink" title="索引限制"></a>索引限制</h2><p><strong>额外开销</strong></p>
<p>每个索引占据一定的存储空间，在进行插入，更新和删除操作时也需要对索引进行操作。所以，如果你很少对集合进行读取操作，建议不使用索引。</p>
<p><strong>内存(RAM)使用</strong></p>
<p>由于索引是存储在内存( <code>RAM</code> )中,你应该确保该索引的大小不超过内存的限制。</p>
<p>如果索引的大小大于内存的限制，<code>MongoDB</code> 会删除一些索引，这将导致性能下降。</p>
<p><strong>查询限制</strong></p>
<p>索引不能被以下的查询使用：</p>
<p>正则表达式及非操作符，如 <code>$nin</code>, <code>$not</code>, 等。<br>算术运算符，如 <code>$mod</code>, 等。<br><code>$where</code> 子句<br>所以，检测你的语句是否使用索引是一个好的习惯，可以用 <code>explain</code> 来查看。</p>
<p><strong>索引键限制</strong></p>
<p>从2.6版本开始，如果现有的索引字段的值超过索引键的限制，<code>MongoDB</code> 中不会创建索引。</p>
<p><strong>插入文档超过索引键限制</strong></p>
<p>如果文档的索引字段值超过了索引键的限制，<code>MongoDB</code> 不会将任何文档转换成索引的集合。与 <code>mongorestore</code> 和 <code>mongoimport</code> 工具类似。</p>
<p><strong>最大范围</strong></p>
<p>集合中索引不能超过64个<br>索引名的长度不能超过128个字符<br>一个复合索引最多可以有31个字段</p>
<h2 id="Map-Reduce"><a href="#Map-Reduce" class="headerlink" title="Map Reduce"></a>Map Reduce</h2><p><code>Map-Reduce</code> 是一种计算模型，简单的说就是将大批量的工作（数据）分解（<code>MAP</code>）执行，然后再将结果合并成最终结果（<code>REDUCE</code>）。</p>
<p><code>MongoDB</code> 提供的 <code>Map-Reduce</code> 非常灵活，对于大规模数据分析也相当实用。</p>
<p><code>MapReduce 命令基本语法</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.collection.mapReduce(</span><br><span class="line">   <span class="function"><span class="title">function</span></span>() &#123;emit(key,value);&#125;,  //map 函数</span><br><span class="line">   <span class="keyword">function</span>(key,values) &#123;<span class="built_in">return</span> reduceFunction&#125;,   //reduce 函数</span><br><span class="line">   &#123;</span><br><span class="line">      out: collection,</span><br><span class="line">      query: document,</span><br><span class="line">      <span class="built_in">sort</span>: document,</span><br><span class="line">      <span class="built_in">limit</span>: number</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>使用 <code>MapReduce</code> 要实现两个函数 <code>Map</code> 函数和 <code>Reduce</code> 函数,<code>Map</code> 函数调用 <code>emit(key, value)</code>, 遍历 <code>collection</code> 中所有的记录, 将 <code>key</code> 与 <code>value</code> 传递给 <code>Reduce</code> 函数进行处理。</p>
<p><code>Map</code> 函数必须调用 <code>emit(key, value)</code> 返回键值对。</p>
<p>参数说明:</p>
<ul>
<li><code>map</code> ：映射函数 (生成键值对序列,作为 <code>reduce</code> 函数参数)。</li>
<li><code>reduce</code> 统计函数，<code>reduce</code> 函数的任务就是将 <code>key-values</code> 变成 <code>key-value</code> ，也就是把 <code>values</code> 数组变成一个单一的值 <code>value</code>。。</li>
<li><code>out</code> 统计结果存放集合 (不指定则使用临时集合，在客户端断开后自动删除)。</li>
<li><code>query</code> 一个筛选条件，只有满足条件的文档才会调用 <code>map</code> 函数。（ <code>query</code>,<code>limit</code>，<code>sort</code>可以随意组合）</li>
<li><code>sort</code> 和 <code>limit</code> 结合的 <code>sort</code> 排序参数（也是在发往 <code>map</code> 函数前给文档排序），可以优化分组机制</li>
<li><code>limit</code> 发往 <code>map</code> 函数的文档数量的上限（要是没有 <code>limit</code>，单独使用 <code>sort</code> 的用处不大）</li>
</ul>
<p>以下实例在集合 <code>orders</code> 中查找 <code>status:&quot;A&quot;</code> 的数据，并根据 <code>cust_id</code> 来分组，并计算 <code>amount</code> 的总和。</p>
<p><img src="/img/map-reduce.bakedsvg.svg" alt="map-reduce.bakedsvg.svg"></p>
<p><strong>使用MapReduce</strong></p>
<p>在 <code>posts</code> 集合中使用 <code>mapReduce</code> 函数来选取已发布的文章(status:”active”)，并通过 <code>user_name</code> 分组，计算每个用户的文章数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">db.posts.mapReduce( </span><br><span class="line">   <span class="function"><span class="title">function</span></span>() &#123; emit(this.user_name,1); &#125;, </span><br><span class="line">   <span class="keyword">function</span>(key, values) &#123;<span class="built_in">return</span> Array.<span class="built_in">sum</span>(values)&#125;, </span><br><span class="line">      &#123;  </span><br><span class="line">         query:&#123;status:<span class="string">&quot;active&quot;</span>&#125;,  </span><br><span class="line">         out:<span class="string">&quot;post_total&quot;</span> </span><br><span class="line">      &#125;</span><br><span class="line">)</span><br><span class="line">db.post_total.find()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;runoob&quot;</span>, <span class="string">&quot;value&quot;</span> : 1 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;mark&quot;</span>, <span class="string">&quot;value&quot;</span> : 4 &#125;</span><br></pre></td></tr></table></figure>

<h2 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a>全文检索</h2><p>全文检索对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。MongoDB 从 2.4 版本开始支持全文检索，MongoDB 从3.2 版本以后添加了对中文索引的支持。</p>
<p><strong>启用全文检索</strong></p>
<p>MongoDB 在 2.6 版本以后是默认开启全文检索的，如果你使用之前的版本，你需要使用以下代码来启用全文检索:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.adminCommand(&#123;setParameter:<span class="literal">true</span>,textSearchEnabled:<span class="literal">true</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用命令：</span></span><br><span class="line">mongod --setParameter textSearchEnabled=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>创建全文索引</strong></p>
<p>实例：posts 集合的文档数据，包含了文章内容（post_text）及标签(tags)：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="string">&quot;post_text&quot;</span>: <span class="string">&quot;enjoy the mongodb articles on Runoob&quot;</span>,</span><br><span class="line">   <span class="string">&quot;tags&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;mongodb&quot;</span>,</span><br><span class="line">      <span class="string">&quot;runoob&quot;</span></span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对 post_text 字段建立全文索引，这样我们可以搜索文章内的内容：</p>
<p><code>db.posts.createIndex(&#123;post_text:&quot;text&quot;&#125;)</code></p>
<p><strong>使用全文索引</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.posts.find(&#123;<span class="variable">$text</span>:&#123;<span class="variable">$search</span>:<span class="string">&quot;runoob&quot;</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果：</span></span><br><span class="line">&#123; </span><br><span class="line">   <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;53493d14d852429c10000002&quot;</span>), </span><br><span class="line">   <span class="string">&quot;post_text&quot;</span> : <span class="string">&quot;enjoy the mongodb articles on Runoob&quot;</span>, </span><br><span class="line">   <span class="string">&quot;tags&quot;</span> : [ <span class="string">&quot;mongodb&quot;</span>, <span class="string">&quot;runoob&quot;</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>旧版本的 MongoDB，可以使用以下命令：</p>
<p><code>db.posts.runCommand(&quot;text&quot;,&#123;search:&quot;runoob&quot;&#125;)</code></p>
<p>使用全文索引可以提高搜索效率。</p>
<p><strong>删除全文索引</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除已存在的全文索引，可以使用 find 命令查找索引名：</span></span><br><span class="line">db.posts.getIndexes()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行以下命令来删除索引：</span></span><br><span class="line">db.posts.dropIndex(<span class="string">&quot;post_text_text&quot;</span>)</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/23/Linux-CentOS7%E7%A3%81%E7%9B%98%E6%89%A9%E5%85%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | syxdevcode博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/23/Linux-CentOS7%E7%A3%81%E7%9B%98%E6%89%A9%E5%85%85/" class="post-title-link" itemprop="url">Linux-CentOS7磁盘扩充</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-23 17:52:59" itemprop="dateCreated datePublished" datetime="2020-09-23T17:52:59+08:00">2020-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-08-13 13:49:50" itemprop="dateModified" datetime="2025-08-13T13:49:50+08:00">2025-08-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux-LVM/" itemprop="url" rel="index"><span itemprop="name">Linux LVM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建物理卷</span></span><br><span class="line">pvcreate  /dev/vdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扩展卷组</span></span><br><span class="line">vgextend centos /dev/vdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扩展逻辑卷大小</span></span><br><span class="line">lvextend -L +500G /dev/mapper/centos-root</span><br><span class="line"><span class="comment"># 或 将卷组 100% 分配到 逻辑卷unicomvol</span></span><br><span class="line">lvextend -l 100%VG /dev/mapper/centos-root</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认文件系统是xfs</span></span><br><span class="line"><span class="built_in">cat</span> /etc/fstab | grep centos-root</span><br><span class="line"></span><br><span class="line"><span class="comment"># xfs_growfs: 调整一个 xfs 文件系统大小（只能扩展)</span></span><br><span class="line">xfs_growfs /dev/mapper/centos-root</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选，resize2fs</span></span><br><span class="line"><span class="comment"># resize2fs -p /dev/mapper/centos-root</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line"><span class="built_in">df</span> -hT</span><br></pre></td></tr></table></figure>

<p>xfs 相关：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">xfs_admin: 调整 xfs 文件系统的各种参数</span><br><span class="line">xfs_copy: 拷贝 xfs 文件系统的内容到一个或多个目标系统（并行方式） </span><br><span class="line">xfs_db: 调试或检测 xfs 文件系统（查看文件系统碎片等） </span><br><span class="line">xfs_check: 检测 xfs 文件系统的完整性 </span><br><span class="line">xfs_bmap: 查看一个文件的块映射 </span><br><span class="line">xfs_repair: 尝试修复受损的 xfs 文件系统 </span><br><span class="line">xfs_fsr: 碎片整理 </span><br><span class="line">xfs_quota: 管理 xfs 文件系统的磁盘配额 </span><br><span class="line">xfs_metadump: 将 xfs 文件系统的元数据 (metadata) 拷贝到一个文件中 </span><br><span class="line">xfs_mdrestore: 从一个文件中将元数据 (metadata) 恢复到 xfs 文件系统 </span><br><span class="line">xfs_growfs: 调整一个 xfs 文件系统大小（只能扩展） </span><br><span class="line">xfs_freeze    暂停（-f）和恢复（-u）xfs 文件系统</span><br><span class="line">xfs_logprint: 打印xfs文件系统的日志 </span><br><span class="line">xfs_mkfile: 创建xfs文件系统 </span><br><span class="line">xfs_info: 查询文件系统详细信息 </span><br><span class="line">xfs_ncheck: generate pathnames from i-numbers <span class="keyword">for</span> XFS </span><br><span class="line">xfs_rtcp: XFS实时拷贝命令 </span><br><span class="line">xfs_io: 调试xfs I/O路径</span><br></pre></td></tr></table></figure>

<p>resize2fs 相关</p>
<p>此命令的适用范围：<code>RedHat、RHEL、Ubuntu、CentOS、SUSE、openSUSE、Fedora</code>。</p>
<p>调整 <code>ext2\ext3\ext4</code> 文件系统的大小，它可以放大或者缩小没有挂载的文件系统的大小。如果文件系统已经挂载，它可以扩大文件系统的大小，前提是内核支持在线调整大小。</p>
<p><code>size</code> 参数指定所请求的文件系统的新大小。如果没有指定任何单元，那么 <code>size</code> 参数的单位应该是文件系统的文件系统块大小。<code>size</code> 参数可以由下列单位编号之一后缀：<code>s</code>、<code>K</code>、<code>M</code> 或 <code>G</code>，分别用于512字节扇区、千字节、兆字节或千兆字节。文件系统的大小可能永远不会大于分区的大小。如果未指定 <code>Size</code> 参数，则它将默认为分区的大小。</p>
<p><code>resize2fs</code> 程序不操作分区的大小。如果希望扩大文件系统，必须首先确保可以扩展基础分区的大小。如果您使用逻辑卷管理器 <code>LVM(8)</code> ，可以使用 <code>fdisk(8)</code> 删除分区并以更大的大小重新创建它，或者使用 <code>lvexport(8)</code> 。在重新创建分区时，请确保使用与以前相同的启动磁盘圆柱来创建分区！否则，调整大小操作肯定无法工作，您可能会丢失整个文件系统。运行 <code>fdisk(8)</code> 后，运行 <code>resize2fs</code> 来调整 <code>ext 2</code>文件系统的大小，以使用新扩大的分区中的所有空间。</p>
<p>如果希望缩小 <code>ext2</code> 分区，请首先使用 <code>resize2fs</code> 缩小文件系统的大小。然后可以使用 <code>fdisk(8)</code> 缩小分区的大小。缩小分区大小时，请确保不使其小于 <code>ext2</code> 文件系统的新大小。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 语法相关</span></span><br><span class="line">resize2fs  [选项]  device  [size]</span><br><span class="line">resize2fs  [ -fFpPM ]  [ -d debug-flags ]  [ -S RAID-stride ]  device  [ size ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 选项列表</span></span><br><span class="line">-d debug-flags</span><br><span class="line">    打开各种resize2fs调试特性，如果它们已经编译成二进制文件的话。调试标志应该通过从以下列表中添加所需功能的数量来计算：</span><br><span class="line">    2，调试块重定位。</span><br><span class="line">    4，调试iNode重定位。</span><br><span class="line">    8，调试移动inode表。</span><br><span class="line">-f  强制执行，覆盖一些通常强制执行的安全检查。</span><br><span class="line">-F  执行之前，刷新文件系统的缓冲区</span><br><span class="line">-M  将文件系统缩小到最小值</span><br><span class="line">-p  显示已经完成任务的百分比</span><br><span class="line">-P  显示文件系统的最小值</span><br><span class="line">-S RAID-stride</span><br></pre></td></tr></table></figure>

<p><code>resize2fs</code> 程序将启发式地确定在创建文件系统时指定的 <code>RAID</code> 步长。此选项允许用户显式地指定 <code>RAID</code> 步长设置，以便由 <code>resize2fs</code> 代替。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/23/Linux-red-hat-CentOS7%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | syxdevcode博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/23/Linux-red-hat-CentOS7%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99/" class="post-title-link" itemprop="url">Linux Red hat/CentOS7关闭防火墙</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-23 11:06:19" itemprop="dateCreated datePublished" datetime="2020-09-23T11:06:19+08:00">2020-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-08-13 13:49:50" itemprop="dateModified" datetime="2025-08-13T13:49:50+08:00">2025-08-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看防火状态</span></span><br><span class="line"><span class="comment"># CentOS7</span></span><br><span class="line">systemctl status firewalld</span><br><span class="line"><span class="comment"># Red hat</span></span><br><span class="line">service iptables status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂时关闭防火墙</span></span><br><span class="line"><span class="comment"># CentOS7</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="comment"># Red hat</span></span><br><span class="line">service iptables stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启防火墙</span></span><br><span class="line"><span class="comment"># CentOS7</span></span><br><span class="line">systemctl <span class="built_in">enable</span> firewalld</span><br><span class="line"><span class="comment"># Red hat</span></span><br><span class="line">service iptables restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久关闭防火墙</span></span><br><span class="line"><span class="comment"># CentOS7</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"><span class="comment"># Red hat</span></span><br><span class="line">chkconfig iptables off</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/22/MongoDB-%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | syxdevcode博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/22/MongoDB-%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5/" class="post-title-link" itemprop="url">MongoDB 增删改查</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-22 16:25:18" itemprop="dateCreated datePublished" datetime="2020-09-22T16:25:18+08:00">2020-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-08-13 13:49:51" itemprop="dateModified" datetime="2025-08-13T13:49:51+08:00">2025-08-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="MongoDB-连接"><a href="#MongoDB-连接" class="headerlink" title="MongoDB 连接"></a>MongoDB 连接</h2><p>标准 URI 连接语法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]</span><br></pre></td></tr></table></figure>

<ul>
<li><p>mongodb:&#x2F;&#x2F; 这是固定的格式，必须要指定。</p>
</li>
<li><p>username:password@ 可选项，如果设置，在连接数据库服务器之后，驱动都会尝试登录这个数据库</p>
</li>
<li><p>host1 必须的指定至少一个host, host1 是这个URI唯一要填写的。它指定了要连接服务器的地址。如果要连接复制集，请指定多个主机地址。</p>
</li>
<li><p>portX 可选的指定端口，如果不填，默认为27017</p>
</li>
<li><p>&#x2F;database 如果指定username:password@，连接并验证登录指定数据库。若不指定，默认打开 test 数据库。</p>
</li>
<li><p>?options 是连接选项。如果不使用 <code>/database</code>，则前面需要加上&#x2F;。所有连接选项都是键值对name&#x3D;value，键值对之间通过&amp;或;（分号）隔开</p>
</li>
</ul>
<p>标准的连接格式包含了多个选项(options):</p>
<p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200922163649.png" alt="微信截图_20200922163649.png"></p>
<h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><p><strong>语法格式</strong></p>
<p>MongoDB 创建数据库的语法格式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use DATABASE_NAME</span><br></pre></td></tr></table></figure>

<p><strong>实例</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> use test1</span><br><span class="line">switched <span class="keyword">to</span> db test1</span><br><span class="line"><span class="operator">&gt;</span> db</span><br><span class="line">test1</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">show</span> dbs</span><br><span class="line">admin   <span class="number">0.000</span>GB</span><br><span class="line">config  <span class="number">0.000</span>GB</span><br><span class="line"><span class="keyword">local</span>   <span class="number">0.000</span>GB</span><br><span class="line"><span class="operator">&gt;</span> db.test1.insert(&#123;&quot;name&quot;:&quot;test1&quot;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot; : <span class="number">1</span> &#125;)</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">show</span> dbs</span><br><span class="line">admin   <span class="number">0.000</span>GB</span><br><span class="line">config  <span class="number">0.000</span>GB</span><br><span class="line"><span class="keyword">local</span>   <span class="number">0.000</span>GB</span><br><span class="line">test1   <span class="number">0.000</span>GB</span><br></pre></td></tr></table></figure>

<p>如果数据库不存在，则创建数据库，否则切换到指定数据库。</p>
<p>ongoDB 中默认的数据库为 test，如果你没有创建新的数据库，集合将存放在 test 数据库中。</p>
<p>注意: 在 MongoDB 中，集合只有在内容插入后才会创建! 就是说，创建集合(数据表)后要再插入一个文档(记录)，集合才会真正创建。</p>
<h2 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h2><p><strong>语法格式</strong></p>
<p>MongoDB 删除数据库的语法格式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.dropDatabase()</span><br></pre></td></tr></table></figure>

<p>删除当前数据库，默认为 test，你可以使用 db 命令查看当前数据库名。</p>
<p><strong>实例</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> use test1</span><br><span class="line">switched <span class="keyword">to</span> db test1</span><br><span class="line"><span class="operator">&gt;</span> db.dropDatabase()</span><br><span class="line">&#123; &quot;dropped&quot; : &quot;test1&quot;, &quot;ok&quot; : <span class="number">1</span> &#125;</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">show</span> dbs</span><br><span class="line">admin   <span class="number">0.000</span>GB</span><br><span class="line">config  <span class="number">0.000</span>GB</span><br><span class="line"><span class="keyword">local</span>   <span class="number">0.000</span>GB</span><br></pre></td></tr></table></figure>

<h2 id="创建集合"><a href="#创建集合" class="headerlink" title="创建集合"></a>创建集合</h2><p><strong>语法格式</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection(name, options)</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li>name: 要创建的集合名称</li>
<li>options: 可选参数, 指定有关内存大小及索引的选项</li>
</ul>
<p>options 可以是如下参数</p>
<p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200922165116.png" alt="微信截图_20200922165116.png"></p>
<p>在插入文档时，MongoDB 首先检查固定集合的 size 字段，然后检查 max 字段。</p>
<p>在 MongoDB 中，你不需要创建集合。当你插入一些文档时，MongoDB 会自动创建集合。</p>
<p>可以使用 <code>show collections</code> 或 <code>show tables</code> 命令查看已有集合。</p>
<h2 id="删除集合"><a href="#删除集合" class="headerlink" title="删除集合"></a>删除集合</h2><p><strong>语法格式：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.drop()</span><br></pre></td></tr></table></figure>

<p>如果成功删除选定集合，则 drop() 方法返回 true，否则返回 false。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.createCollection(<span class="string">&quot;test1&quot;</span>)</span><br><span class="line">&#123; <span class="string">&quot;ok&quot;</span> : 1 &#125;</span><br><span class="line">&gt; db.test1.drop()</span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="插入文档"><a href="#插入文档" class="headerlink" title="插入文档"></a>插入文档</h2><p>所有存储在集合中的数据都是 BSON 格式。</p>
<p>BSON 是一种类似 JSON 的二进制形式的存储格式，是 Binary JSON 的简称。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 若插入的数据主键已经存在，则会抛 org.springframework.dao.DuplicateKeyException 异常，提示主键重复，不保存当前数据。</span></span><br><span class="line">db.COLLECTION_NAME.insert(document)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 该方法新版本中已废弃</span></span><br><span class="line">db.COLLECTION_NAME.save(document)</span><br></pre></td></tr></table></figure>


<p>3.2 版本之后新增insertOne,insertMany</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参数说明：</span></span><br><span class="line"><span class="comment"># document：要写入的文档。</span></span><br><span class="line"><span class="comment"># writeConcern：写入策略，默认为 1，即要求确认写操作，0 是不要求。</span></span><br><span class="line"><span class="comment"># ordered：指定是否按顺序写入，默认 true，按顺序写入。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 向集合插入一个新文档</span></span><br><span class="line">db.collection.insertOne(</span><br><span class="line">   &lt;document&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">      writeConcern: &lt;document&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 向集合插入一个多个文档</span></span><br><span class="line">db.collection.insertMany(</span><br><span class="line">   [ &lt;document 1&gt; , &lt;document 2&gt;, ... ],</span><br><span class="line">   &#123;</span><br><span class="line">      writeConcern: &lt;document&gt;,</span><br><span class="line">      ordered: &lt;boolean&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="异常级别"><a href="#异常级别" class="headerlink" title="异常级别"></a>异常级别</h2><ul>
<li>WriteConcern.NONE:没有异常抛出</li>
<li>WriteConcern.NORMAL:仅抛出网络错误异常，没有服务器错误异常</li>
<li>WriteConcern.SAFE:抛出网络错误异常、服务器错误异常；并等待服务器完成写操作。</li>
<li>WriteConcern.MAJORITY: 抛出网络错误异常、服务器错误异常；并等待一个主服务器完成写操作。</li>
<li>WriteConcern.FSYNC_SAFE: 抛出网络错误异常、服务器错误异常；写操作等待服务器将数据刷新到磁盘。</li>
<li>WriteConcern.JOURNAL_SAFE:抛出网络错误异常、服务器错误异常；写操作等待服务器提交到磁盘的日志文件。</li>
<li>WriteConcern.REPLICAS_SAFE:抛出网络错误异常、服务器错误异常；等待至少2台服务器完成写操作。</li>
</ul>
<h2 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h2><h3 id="update-方法"><a href="#update-方法" class="headerlink" title="update() 方法"></a>update() 方法</h3><p><strong>语法格式</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.collection.update(</span><br><span class="line">   &lt;query&gt;,</span><br><span class="line">   &lt;update&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">     upsert: &lt;boolean&gt;,</span><br><span class="line">     multi: &lt;boolean&gt;,</span><br><span class="line">     writeConcern: &lt;document&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li>query : update的查询条件，类似sql update查询内where后面的。</li>
<li>update : update的对象和一些更新的操作符（如$,$inc…）等，也可以理解为sql update查询内set后面的</li>
<li>upsert : 可选，这个参数的意思是，如果不存在update的记录，是否插入objNew,true为插入，默认是false，不插入。</li>
<li>multi : 可选，mongodb 默认是false,只更新找到的第一条记录，如果这个参数为true,就把按条件查出来多条记录全部更新。</li>
<li>writeConcern :可选，抛出异常的级别。</li>
</ul>
<p><strong>实例</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.test1.update(&#123;<span class="string">&#x27;title&#x27;</span>:<span class="string">&#x27;MongoDB 教程&#x27;</span>&#125;,&#123;<span class="variable">$set</span>:&#123;<span class="string">&#x27;title&#x27;</span>:<span class="string">&#x27;MongoDB&#x27;</span>&#125;&#125;)</span><br><span class="line">db.test1.find().pretty()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以上语句只会修改第一条发现的文档，如果你要修改多条相同的文档，</span></span><br><span class="line"><span class="comment"># 则需要设置 multi 参数为 true。</span></span><br><span class="line">db.test1.update(&#123;<span class="string">&#x27;title&#x27;</span>:<span class="string">&#x27;MongoDB 教程&#x27;</span>&#125;,&#123;<span class="variable">$set</span>:&#123;<span class="string">&#x27;title&#x27;</span>:<span class="string">&#x27;MongoDB&#x27;</span>&#125;&#125;,&#123;multi:<span class="literal">true</span>&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="save-方法"><a href="#save-方法" class="headerlink" title="save() 方法"></a>save() 方法</h3><p>save() 方法通过传入的文档来替换已有文档，_id 主键存在就更新，不存在就插入。</p>
<p><strong>语法格式如下：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.collection.save(</span><br><span class="line">   &lt;document&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">     writeConcern: &lt;document&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li>document : 文档数据。</li>
<li>writeConcern :可选，抛出异常的级别。</li>
</ul>
<p>在3.2版本开始，MongoDB提供以下更新集合文档的方法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 向指定集合更新单个文档</span></span><br><span class="line">db.collection.updateOne()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 向指定集合更新多个文档</span></span><br><span class="line">db.collection.updateMany()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移除集合中的键值对，使用的 $unset 操作符：</span></span><br><span class="line">db.col.update(&#123;<span class="string">&quot;_id&quot;</span>:<span class="string">&quot;56064f89ade2f21f36b03136&quot;</span>&#125;, &#123;<span class="variable">$set</span>:&#123; <span class="string">&quot;test2&quot;</span> : <span class="string">&quot;OK&quot;</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line">db.col.update(&#123;<span class="string">&quot;_id&quot;</span>:<span class="string">&quot;56064f89ade2f21f36b03136&quot;</span>&#125;, &#123;<span class="variable">$unset</span>:&#123; <span class="string">&quot;test2&quot;</span> : <span class="string">&quot;OK&quot;</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h2><p>MongoDB 最早删除文档使用的是 <code>remove()</code> 方法，后来官方把它移除了因为 <code>remove()</code> 并不会真正释放空间。需要继续执行 <code>db.repairDatabase()</code> 来回收磁盘空间。</p>
<p>建议在执行删除文档函数前先执行 <code>find()</code> 命令来判断执行的条件是否正确 <code>db.test1.find()</code> 。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.repairDatabase()</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">db.runCommand(&#123;repairDatabase: 1&#125;)</span><br></pre></td></tr></table></figure>

<p>官方推荐使用 <code>deleteOne()</code> 和 <code>deleteMany()</code> 方法。</p>
<p><strong>语法</strong></p>
<p><code>deleteOne()</code> 语法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.collection.deleteOne(</span><br><span class="line">   &lt;filter&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">      writeConcern: &lt;document&gt;,</span><br><span class="line">      collation: &lt;document&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>deleteMany()</code> 语法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.collection.deleteMany(</span><br><span class="line">   &lt;filter&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">      writeConcern: &lt;document&gt;,</span><br><span class="line">      collation: &lt;document&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除集合下全部文档</span></span><br><span class="line">db.inventory.deleteMany(&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 status 等于 A 的全部文档</span></span><br><span class="line">db.inventory.deleteMany(&#123; status : <span class="string">&quot;A&quot;</span> &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h2><p>MongoDB 查询文档使用 <code>find()</code>, <code>findOne()</code> 方法。</p>
<p><code>find()</code> 方法以非结构化的方式来显示所有文档。</p>
<p><strong>语法格式</strong></p>
<p><code>db.collection.find(query, projection)</code></p>
<ul>
<li>query ：可选，使用查询操作符指定查询条件</li>
<li>projection ：可选，使用投影操作符指定返回的键。若不指定 projection，则默认返回所有键（默认省略）。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># projection入参格式为&#123;columnA : 0/1,columnB : 0/1&#125;</span></span><br><span class="line"><span class="comment"># columnA 和 columnB 表示你要查询的表中的字段，0/1 表示取或不取。</span></span><br><span class="line">db.collection.find(query, projection)</span><br></pre></td></tr></table></figure>

<p>如：<code>&#123;title:1&#125;</code>，表示查询出的每条记录中只显示 title 字段内容。<code>&#123;description:0&#125;</code>，表示查询出的每条记录中不显示 description 字段内容(其他字段都展示)。</p>
<p>注：_id(主键)字段默认为 1，可指定 {_id:0} 来不输出 _id 字段值。</p>
<p>指定 <code>projection</code> 格式如下，有两种模式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(query, &#123;title: 1, by: 1&#125;) // inclusion模式 指定返回的键，不返回其他键</span><br><span class="line">db.collection.find(query, &#123;title: 0, by: 0&#125;) // exclusion模式 指定不返回的键,返回其他键</span><br></pre></td></tr></table></figure>

<p>两种模式不可混用（因为这样的话无法推断其他键是否应返回）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(query, &#123;title: 1, by: 0&#125;) <span class="comment"># 错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只能全1或全0，除了在inclusion模式时可以指定_id为0</span></span><br><span class="line">db.collection.find(query, &#123;_id:0, title: 1, by: 1&#125;) <span class="comment"># 正确</span></span><br></pre></td></tr></table></figure>

<p>若不想指定查询条件参数 <code>query</code> 可以 用 <code>&#123;&#125;</code> 代替，但是需要指定 <code>projection</code> 参数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">querydb.collection.find(&#123;&#125;, &#123;title: 1&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>AND 条件</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.test1.find(&#123;key1:value1, key2:value2&#125;).pretty()</span><br></pre></td></tr></table></figure>

<p><strong>OR 条件</strong></p>
<p>使用关键字 <code>$or</code>,语法格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.test1.find(</span><br><span class="line">   &#123;</span><br><span class="line">      $or: [</span><br><span class="line">         &#123;key1: value1&#125;, &#123;key2:value2&#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">).pretty()</span><br></pre></td></tr></table></figure>

<p><strong>AND 和 OR 联合使用</strong></p>
<p><code>where likes&gt;50 AND (by = &#39;test1&#39; OR title = &#39;MongoDB&#39;)</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.test1.find(&#123;<span class="string">&quot;likes&quot;</span>: &#123;<span class="variable">$gt</span>:50&#125;, <span class="variable">$or</span>: [&#123;<span class="string">&quot;by&quot;</span>: <span class="string">&quot;test1&quot;</span>&#125;,&#123;<span class="string">&quot;title&quot;</span>: <span class="string">&quot;MongoDB&quot;</span>&#125;]&#125;).pretty()</span><br></pre></td></tr></table></figure>

<p><strong>模糊查询</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询 title 包含&quot;教&quot;字的文档：</span></span><br><span class="line">db.col.find(&#123;title:/教/&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询 title 字段以&quot;教&quot;字开头的文档：</span></span><br><span class="line">db.col.find(&#123;title:/^教/&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询 titl e字段以&quot;教&quot;字结尾的文档：</span></span><br><span class="line">db.col.find(&#123;title:/教$/&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="条件操作符"><a href="#条件操作符" class="headerlink" title="条件操作符"></a>条件操作符</h2><p>结合查询语句使用。</p>
<ul>
<li>$gt — greater than  &gt;</li>
<li>$gte — gt equal  &gt;&#x3D;</li>
<li>$lt — less than  &lt;</li>
<li>$lte — lt equal  &lt;&#x3D;</li>
<li>$ne — not equal  !&#x3D;</li>
<li>$eq —  equal  &#x3D;</li>
</ul>
<h2 id="type-操作符"><a href="#type-操作符" class="headerlink" title="$type 操作符"></a>$type 操作符</h2><p><code>$type</code> 操作符是基于BSON类型来检索集合中匹配的数据类型，并返回结果。</p>
<p>获取 <code>test1</code> 集合中 title 为 String 的数据</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.test1.find(&#123;<span class="string">&quot;title&quot;</span> : &#123;<span class="variable">$type</span> : 2&#125;&#125;)</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">db.test1.find(&#123;<span class="string">&quot;title&quot;</span> : &#123;<span class="variable">$type</span> : <span class="string">&#x27;string&#x27;</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="Limit与Skip方法"><a href="#Limit与Skip方法" class="headerlink" title="Limit与Skip方法"></a>Limit与Skip方法</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Limit() 方法</span></span><br><span class="line">db.COLLECTION_NAME.find().<span class="built_in">limit</span>(NUMBER)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果你们没有指定limit()方法中的参数则显示集合中的所有数据。</span></span><br><span class="line">db.test1.find(&#123;&#125;,&#123;<span class="string">&quot;title&quot;</span>:1,_id:0&#125;).<span class="built_in">limit</span>(2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Skip() 方法</span></span><br><span class="line"><span class="comment"># skip()方法默认参数为 0</span></span><br><span class="line">db.COLLECTION_NAME.find().<span class="built_in">limit</span>(NUMBER).skip(NUMBER)</span><br></pre></td></tr></table></figure>

<p>skip 和limit方法只适合小数据量分页，如果是百万级效率就会非常低，因为skip方法是一条条数据数过去的，建议使用 <code>where limit</code>。</p>
<h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><p><code>sort()</code> 方法对数据进行排序，<code>sort()</code> 方法可以通过参数指定排序的字段，并使用 1 和 -1 来指定排序的方式，其中 1 为升序排列，而 -1 是用于降序排列。</p>
<p>语法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 语法</span></span><br><span class="line">db.COLLECTION_NAME.find().<span class="built_in">sort</span>(&#123;KEY:1&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例</span></span><br><span class="line"><span class="comment"># 按字段 likes 的降序排列</span></span><br><span class="line">db.test1.find(&#123;&#125;,&#123;<span class="string">&quot;title&quot;</span>:1,_id:0&#125;).<span class="built_in">sort</span>(&#123;<span class="string">&quot;likes&quot;</span>:-1&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p>3.0.0 版本前创建索引方法为 <code>db.collection.ensureIndex()</code> ，之后的版本使用了 <code>db.collection.createIndex()</code> 方法，<code>ensureIndex()</code> 还能用，但只是 <code>createIndex()</code> 的别名。</p>
<p><strong>语法</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.collection.createIndex(keys, options)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例</span></span><br><span class="line">db.test1.createIndex(&#123;<span class="string">&quot;title&quot;</span>:1&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以设置使用多个字段创建索引（关系型数据库中称作复合索引）</span></span><br><span class="line">db.test1.createIndex(&#123;<span class="string">&quot;title&quot;</span>:1,<span class="string">&quot;description&quot;</span>:-1&#125;)</span><br></pre></td></tr></table></figure>

<p>语法中 Key 值为你要创建的索引字段，1 为指定按升序创建索引 -1 按降序来创建索引。</p>
<p>可选参数:</p>
<p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200924134809.png" alt="微信截图_20200924134809.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集合索引</span></span><br><span class="line">db.test1.getIndexes()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集合索引大小</span></span><br><span class="line">db.test1.totalIndexSize()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除集合所有索引</span></span><br><span class="line">db.test1.dropIndexes()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除集合指定索引</span></span><br><span class="line">db.test1.dropIndex(<span class="string">&quot;索引名称&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="TTL索引"><a href="#TTL索引" class="headerlink" title="TTL索引"></a>TTL索引</h3><p>保存最近三个月的文档（单位秒），当中途修改了createdAt的值时，<br>则不会删除文档（指定的时间是字段与当前时间的差值）。</p>
<p><code>db.user.createIndex(&#123;&quot;createdAt&quot;: 1&#125;,&#123;expireAfterSeconds: 60*60*24*3&#125;);</code></p>
<p>若需求变动，需要将三个月修改为一个月可以使用collMod，如下：</p>
<p><code>db.runCommand(&#123;collMod: &#39;user&#39;, index: &#123;keyPattern:&#123;&quot;createdAt&quot;: 1&#125;, expireAfterSeconds:60*60*24*1&#125;&#125;);</code></p>
<p>TTL索引限制：</p>
<ul>
<li>TTL索引是单字段索引，不能使用在聚合索引上</li>
<li>不能在普通索引上再创建TTL索引，只能删除再建</li>
<li>_id主键上不能建立TTL索引</li>
<li>一个集合上可以建立多个TTL索引</li>
<li>索引不能包含多个字段</li>
<li>TTL索引可以用于普通索引一样进行排序和查询</li>
<li>如果定义的字段不存在，则永不过期</li>
<li>不能对capped集合创建TTL索引</li>
<li>TTL索引会每分钟检查超时文档，并进行删除操作。需要注意删除时候的并发问题（不要影响线上业务）</li>
</ul>
<h2 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h2><p>MongoDB中聚合( <code>aggregate</code> )主要用于处理数据(诸如统计平均值,求和等)，并返回计算后的数据结果。有点类似sql语句中的 <code>count(*)</code>。</p>
<p><strong>aggregate() 方法</strong></p>
<p><code>db.COLLECTION_NAME.aggregate(AGGREGATE_OPERATION)</code></p>
<p>聚合的表达式：</p>
<p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200924142403.png" alt="微信截图_20200924142403.png"></p>
<p>实例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">db.test1.aggregate([&#123;<span class="variable">$group</span> : &#123;_id : <span class="string">&quot;<span class="variable">$by_user</span>&quot;</span>, num_tutorial : &#123;<span class="variable">$sum</span> : 1&#125;&#125;&#125;])</span><br><span class="line"><span class="comment"># 类似：</span></span><br><span class="line"><span class="keyword">select</span> by_user, count(*) from mycol group by by_user</span><br><span class="line"></span><br><span class="line"><span class="comment"># $project实例</span></span><br><span class="line"><span class="comment"># 只展示_id,tilte和author三个字段</span></span><br><span class="line">db.article.aggregate(</span><br><span class="line">    &#123; <span class="variable">$project</span> : &#123;</span><br><span class="line">        title : 1 ,</span><br><span class="line">        author : 1 ,</span><br><span class="line">    &#125;&#125;</span><br><span class="line"> );</span><br><span class="line"></span><br><span class="line"><span class="comment"># $match实例</span></span><br><span class="line">db.article.aggregate(</span><br><span class="line">    &#123; <span class="variable">$project</span> : &#123;</span><br><span class="line">        _id : 0 ,</span><br><span class="line">        title : 1 ,</span><br><span class="line">        author : 1</span><br><span class="line">    &#125;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment"># $match实例</span></span><br><span class="line">db.articles.aggregate( [</span><br><span class="line">                        &#123; <span class="variable">$match</span> : &#123; score : &#123; <span class="variable">$gt</span> : 70, <span class="variable">$lte</span> : 90 &#125; &#125; &#125;,</span><br><span class="line">                        &#123; <span class="variable">$group</span>: &#123; _id: null, count: &#123; <span class="variable">$sum</span>: 1 &#125; &#125; &#125;</span><br><span class="line">                       ] );</span><br></pre></td></tr></table></figure>

<h2 id="管道操作"><a href="#管道操作" class="headerlink" title="管道操作"></a>管道操作</h2><p><code>MongoDB</code> 的聚合管道将 <code>MongoDB</code> 文档在一个管道处理完毕后将结果传递给下一个管道处理。管道操作是可以重复的。</p>
<ul>
<li>$project：修改输入文档的结构。可以用来重命名、增加或删除域，也可以用于创建计算结果以及嵌套文档。</li>
<li>$match：用于过滤数据，只输出符合条件的文档。<code>$match</code> 使用 <code>MongoDB</code> 的标准查询操作。</li>
<li>$limit：用来限制 <code>MongoDB</code> 聚合管道返回的文档数。</li>
<li>$skip：在聚合管道中跳过指定数量的文档，并返回余下的文档。</li>
<li>$unwind：将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值。</li>
<li>$group：将集合中的文档分组，可用于统计结果。</li>
<li>$sort：将输入文档排序后输出。</li>
<li>$geoNear：输出接近某一地理位置的有序文档。</li>
</ul>
<p>注意：当 <code>match</code> 条件和 <code>group</code> 同时存在时，顺序会影响检索结果，必须先写 <code>match</code> 在前面。</p>
<p>时间关键字如下：</p>
<ul>
<li>$dayOfYear: 返回该日期是这一年的第几天（全年 366 天）。</li>
<li>$dayOfMonth: 返回该日期是这一个月的第几天（1到31）。</li>
<li>$dayOfWeek: 返回的是这个周的星期几（1：星期日，7：星期六）。</li>
<li>$year: 返回该日期的年份部分。</li>
<li>$month： 返回该日期的月份部分（ 1 到 12）。</li>
<li>$week： 返回该日期是所在年的第几个星期（ 0 到 53）。</li>
<li>$hour： 返回该日期的小时部分。</li>
<li>$minute: 返回该日期的分钟部分。</li>
<li>$second: 返回该日期的秒部分（以0到59之间的数字形式返回日期的第二部分，但可以是60来计算闰秒）。</li>
<li>$millisecond：返回该日期的毫秒部分（ 0 到 999）。</li>
<li>$dateToString： { $dateToString: { format: , date: } }。</li>
</ul>
<p>实例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">&#x27;m_msg_tb&#x27;</span>).aggregate(</span><br><span class="line">[</span><br><span class="line">    &#123;<span class="variable">$match</span>:&#123;m_id:10001,mark_time:&#123;<span class="variable">$gt</span>:new Date(2017,8,0)&#125;&#125;&#125;,</span><br><span class="line">    &#123;<span class="variable">$group</span>: &#123;</span><br><span class="line">       _id: &#123;<span class="variable">$dayOfMonth</span>:<span class="string">&#x27;$mark_time&#x27;</span>&#125;,</span><br><span class="line">        pv: &#123;<span class="variable">$sum</span>: 1&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;<span class="variable">$sort</span>: &#123;<span class="string">&quot;_id&quot;</span>: 1&#125;&#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/mongodb/mongodb-tutorial.html">MongoDB 教程</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/22/MySql-%E4%BF%AE%E6%94%B9%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%BAutf8mb4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | syxdevcode博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/22/MySql-%E4%BF%AE%E6%94%B9%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%BAutf8mb4/" class="post-title-link" itemprop="url">MySql 修改字符集为utf8mb4</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-22 09:56:56" itemprop="dateCreated datePublished" datetime="2020-09-22T09:56:56+08:00">2020-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-08-13 13:49:51" itemprop="dateModified" datetime="2025-08-13T13:49:51+08:00">2025-08-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySql/" itemprop="url" rel="index"><span itemprop="name">MySql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><code>utf8mb4</code> 的最低mysql版本支持版本为5.5.3+，若不是，请升级到较新版本。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> VARIABLES <span class="keyword">WHERE</span> Variable_name <span class="keyword">LIKE</span> <span class="string">&#x27;character_set_%&#x27;</span> <span class="keyword">OR</span> Variable_name <span class="keyword">LIKE</span> <span class="string">&#x27;collation%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name            <span class="operator">|</span> <span class="keyword">Value</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> character_set_client     <span class="operator">|</span> utf8                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_connection <span class="operator">|</span> utf8                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_database   <span class="operator">|</span> utf8                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_filesystem <span class="operator">|</span> <span class="type">binary</span>                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_results    <span class="operator">|</span> utf8                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_server     <span class="operator">|</span> utf8                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_system     <span class="operator">|</span> utf8                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_sets_dir       <span class="operator">|</span> <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>mysql<span class="operator">/</span>share<span class="operator">/</span>charsets<span class="operator">/</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> collation_connection     <span class="operator">|</span> utf8_general_ci                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> collation_database       <span class="operator">|</span> utf8_general_ci                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> collation_server         <span class="operator">|</span> utf8_general_ci                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+----------------------------------+</span></span><br><span class="line"><span class="number">11</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 修改database默认的字符集</span><br><span class="line"># 虽然修改了database的字符集为utf8mb4，但是实际只是修改了database新创建的表，默认使用utf8mb4，</span><br><span class="line"># 原来已经存在的表，字符集并没有跟着改变，需要手动为每张表设置字符集</span><br><span class="line">ALTER DATABASE database_name CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci</span><br><span class="line"></span><br><span class="line"># 修改表默认的字符集 </span><br><span class="line">ALTER TABLE table_name DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</span><br><span class="line"></span><br><span class="line"># 修改表默认的字符集和所有字符列的字符集 </span><br><span class="line">ALTER TABLE table_name CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure>

<h2 id="修改MySQL配置文件"><a href="#修改MySQL配置文件" class="headerlink" title="修改MySQL配置文件"></a>修改MySQL配置文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 对本地的mysql客户端的配置</span><br><span class="line">[client]</span><br><span class="line">default-character-set = utf8mb4</span><br><span class="line"></span><br><span class="line"># 对其他远程连接的mysql客户端的配置</span><br><span class="line">[mysql]</span><br><span class="line">default-character-set = utf8mb4</span><br><span class="line"></span><br><span class="line"># 本地mysql服务的配置</span><br><span class="line">[mysqld]</span><br><span class="line">character-set-client-handshake = FALSE</span><br><span class="line">character-set-server = utf8mb4</span><br><span class="line">collation-server = utf8mb4_unicode_ci</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 必须保证一下系统变量是 utf8mb4</span><br><span class="line"></span><br><span class="line"># 客户端来源数据使用的字符集</span><br><span class="line">character_set_client</span><br><span class="line"></span><br><span class="line"># 连接层字符集</span><br><span class="line">character_set_connection</span><br><span class="line"></span><br><span class="line"># 当前选中数据库的默认字符集</span><br><span class="line">character_set_database</span><br><span class="line"></span><br><span class="line"># 查询结果字符集</span><br><span class="line">character_set_results</span><br><span class="line"></span><br><span class="line"># 默认的内部操作字符集</span><br><span class="line">character_set_server</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39390545/article/details/106946166">MySQL中的 utf8 并不是真正的UTF-8编码 ! !</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wang666/p/10282755.html">mysql 修改字符集为utf8mb4</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/eagle89/article/details/82148751">更改MySQL数据库的编码为utf8mb4</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/31/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><span class="page-number current">32</span><a class="page-number" href="/page/33/">33</a><span class="space">&hellip;</span><a class="page-number" href="/page/62/">62</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/33/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">syxdevcode</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/syxdevcode" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
