
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Redis-Cluster集群部署 | syxdevcode博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="syxdevcode">
    
    <meta name="description" content="修改系统参数修改最大可打开文件数参考：Linux最大文件打开数 
TCP监听队列大小参考：Linux设置TCP监听队列
OOM相关：vm.overcommit_memory参考：Linux OOM机制简介
Linux Transparent HugePages(透明大页)参考：Linux Trans">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="syxdevcode博客" title="syxdevcode博客"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="syxdevcode博客">syxdevcode博客</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/tags">tags</a></li>
					
						<li><a href="/categories">categories</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:syxdevcode.github.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/08/03/Redis-Cluster集群部署/" title="Redis-Cluster集群部署" itemprop="url">Redis-Cluster集群部署</a>
  </h1>
  <p class="article-author">By
    
      <a href="https://syxdevcode.github.com" title="syxdevcode">syxdevcode</a>
    </p>
  <p class="article-time">
    <time datetime="2020-08-03T15:14:41.000Z" itemprop="datePublished">2020-08-03</time>
    更新日期:<time datetime="2020-08-17T06:00:22.923Z" itemprop="dateModified">2020-08-17</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#修改系统参数"><span class="toc-number">1.</span> <span class="toc-text">修改系统参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#修改最大可打开文件数"><span class="toc-number">1.1.</span> <span class="toc-text">修改最大可打开文件数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP监听队列大小"><span class="toc-number">1.2.</span> <span class="toc-text">TCP监听队列大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OOM相关：vm-overcommit-memory"><span class="toc-number">1.3.</span> <span class="toc-text">OOM相关：vm.overcommit_memory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-Transparent-HugePages-透明大页"><span class="toc-number">1.4.</span> <span class="toc-text">Linux Transparent HugePages(透明大页)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#目录结构"><span class="toc-number">2.</span> <span class="toc-text">目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置redis"><span class="toc-number">3.</span> <span class="toc-text">配置redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#公共配置-：redis-conf"><span class="toc-number">3.1.</span> <span class="toc-text">公共配置 ：redis.conf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#禁止指定命令"><span class="toc-number">3.2.</span> <span class="toc-text">禁止指定命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#端口配置：redis-PORT-conf"><span class="toc-number">3.3.</span> <span class="toc-text">端口配置：redis-PORT.conf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建和启动redis集群"><span class="toc-number">4.</span> <span class="toc-text">创建和启动redis集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#加上进程监控"><span class="toc-number">4.1.</span> <span class="toc-text">加上进程监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis集群TCP端口（Redis-Cluster-TCP-ports）"><span class="toc-number">4.2.</span> <span class="toc-text">Redis集群TCP端口（Redis Cluster TCP ports）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快速创建-启动redis集群"><span class="toc-number">4.3.</span> <span class="toc-text">快速创建,启动redis集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建redis-cluster"><span class="toc-number">4.4.</span> <span class="toc-text">创建redis cluster</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#群集操作"><span class="toc-number">5.</span> <span class="toc-text">群集操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#新增主（master）节点"><span class="toc-number">5.1.</span> <span class="toc-text">新增主（master）节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#新增从（slave）节点"><span class="toc-number">5.2.</span> <span class="toc-text">新增从（slave）节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除节点"><span class="toc-number">5.3.</span> <span class="toc-text">删除节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#slots相关命令"><span class="toc-number">5.4.</span> <span class="toc-text">slots相关命令</span></a></li></ol></li></ol>
		</div>
		
		<h2 id="修改系统参数"><a href="#修改系统参数" class="headerlink" title="修改系统参数"></a>修改系统参数</h2><h3 id="修改最大可打开文件数"><a href="#修改最大可打开文件数" class="headerlink" title="修改最大可打开文件数"></a>修改最大可打开文件数</h3><p>参考：<a href="https://syxdevcode.github.io/2020/08/04/Linux%E6%9C%80%E5%A4%A7%E6%96%87%E4%BB%B6%E6%89%93%E5%BC%80%E6%95%B0/" target="_blank" rel="noopener">Linux最大文件打开数 </a></p>
<h3 id="TCP监听队列大小"><a href="#TCP监听队列大小" class="headerlink" title="TCP监听队列大小"></a>TCP监听队列大小</h3><p>参考：<a href="https://syxdevcode.github.io/2020/08/04/Linux%E8%AE%BE%E7%BD%AETCP%E7%9B%91%E5%90%AC%E9%98%9F%E5%88%97/" target="_blank" rel="noopener">Linux设置TCP监听队列</a></p>
<h3 id="OOM相关：vm-overcommit-memory"><a href="#OOM相关：vm-overcommit-memory" class="headerlink" title="OOM相关：vm.overcommit_memory"></a>OOM相关：vm.overcommit_memory</h3><p>参考：<a href="https://syxdevcode.github.io/2020/08/05/Linux%20OOM%E6%9C%BA%E5%88%B6%E7%AE%80%E4%BB%8B/" target="_blank" rel="noopener">Linux OOM机制简介</a></p>
<h3 id="Linux-Transparent-HugePages-透明大页"><a href="#Linux-Transparent-HugePages-透明大页" class="headerlink" title="Linux Transparent HugePages(透明大页)"></a>Linux Transparent HugePages(透明大页)</h3><p>参考：<a href="https://syxdevcode.github.io/2020/08/05/Linux%20Transparent%20HugePages(%E9%80%8F%E6%98%8E%E5%A4%A7%E9%A1%B5)/" target="_blank" rel="noopener">Linux Transparent HugePages(透明大页)</a></p>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p>完成公共的 redis.conf 和一个端口号的，如 <code>redis-6379.conf</code>，其它端口号的配置文件基于一个修改后的端口号配置文件即可。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@host-192-125-30-59 redis-cluster]<span class="comment"># ls</span></span><br><span class="line">data  <span class="built_in">log</span>  redis-6379.conf  redis-6380.conf  redis-6381.conf  redis.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line">mkdir /usr/<span class="built_in">local</span>/redis-cluster</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/redis-cluster</span><br><span class="line">mkdir -p data <span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/redis-cluster/data</span><br><span class="line">mkdir -p 6379 6380 6381</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/redis-cluster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成共有配置文件</span></span><br><span class="line">touch redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成端口文件</span></span><br><span class="line">touch redis-6379.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成不同端口的配置文件</span></span><br><span class="line">sed <span class="string">'s/6379/6380/g'</span> redis-6379.conf &gt; /usr/<span class="built_in">local</span>/redis-cluster/redis-6380.conf</span><br><span class="line">sed <span class="string">'s/6379/6381/g'</span> redis-6379.conf &gt; /usr/<span class="built_in">local</span>/redis-cluster/redis-6381.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/redis-server /usr/<span class="built_in">local</span>/redis-cluster/redis-6379.conf</span><br><span class="line">/usr/<span class="built_in">local</span>/bin/redis-server /usr/<span class="built_in">local</span>/redis-cluster/redis-6380.conf</span><br><span class="line">/usr/<span class="built_in">local</span>/bin/redis-server /usr/<span class="built_in">local</span>/redis-cluster/redis-6381.conf</span><br></pre></td></tr></table></figure>

<p>查看redis运行情况：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">netstat -tunpl | grep 6379</span><br><span class="line">netstat -tunpl | grep 6380</span><br><span class="line">netstat -tunpl | grep 6381</span><br><span class="line">ps aux | grep redis</span><br><span class="line"></span><br><span class="line">[root@host-192-125-30-111 redis-cluster]<span class="comment"># netstat -tunpl | grep 6379</span></span><br><span class="line">tcp        0      0 0.0.0.0:16379           0.0.0.0:*               LISTEN      6184/redis-server * </span><br><span class="line">tcp        0      0 0.0.0.0:6379            0.0.0.0:*               LISTEN      6184/redis-server * </span><br><span class="line">tcp6       0      0 :::16379                :::*                    LISTEN      6184/redis-server * </span><br><span class="line">tcp6       0      0 :::6379                 :::*                    LISTEN      6184/redis-server * </span><br><span class="line">[root@host-192-125-30-111 redis-cluster]<span class="comment"># netstat -tunpl | grep 6380</span></span><br><span class="line">tcp        0      0 0.0.0.0:16380           0.0.0.0:*               LISTEN      6189/redis-server * </span><br><span class="line">tcp        0      0 0.0.0.0:6380            0.0.0.0:*               LISTEN      6189/redis-server * </span><br><span class="line">tcp6       0      0 :::16380                :::*                    LISTEN      6189/redis-server * </span><br><span class="line">tcp6       0      0 :::6380                 :::*                    LISTEN      6189/redis-server * </span><br><span class="line">[root@host-192-125-30-111 redis-cluster]<span class="comment"># netstat -tunpl | grep 6381</span></span><br><span class="line">tcp        0      0 0.0.0.0:16381           0.0.0.0:*               LISTEN      6194/redis-server * </span><br><span class="line">tcp        0      0 0.0.0.0:6381            0.0.0.0:*               LISTEN      6194/redis-server * </span><br><span class="line">tcp6       0      0 :::16381                :::*                    LISTEN      6194/redis-server * </span><br><span class="line">tcp6       0      0 :::6381                 :::*                    LISTEN      6194/redis-server * </span><br><span class="line">[root@host-192-125-30-111 redis-cluster]<span class="comment"># ps aux|grep redis</span></span><br><span class="line">root      6184  0.0  0.0 156964  7724 ?        Ssl  10:38   0:00 /usr/<span class="built_in">local</span>/bin/redis-server *:6379 [cluster]</span><br><span class="line">root      6189  0.0  0.0 153892  7692 ?        Ssl  10:39   0:00 /usr/<span class="built_in">local</span>/bin/redis-server *:6380 [cluster]</span><br><span class="line">root      6194  0.0  0.0 153892  7692 ?        Ssl  10:39   0:00 /usr/<span class="built_in">local</span>/bin/redis-server *:6381 [cluster]</span><br><span class="line">root      6339  0.0  0.0 112724   992 pts/1    S+   10:42   0:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>

<h2 id="配置redis"><a href="#配置redis" class="headerlink" title="配置redis"></a>配置redis</h2><p>指定端口的配置文件 <code>redis-PORT.conf</code>；<br>该文件定义所有与端口相关的配置项，PORT需要替换为具体的端口，如6379</p>
<h3 id="公共配置-：redis-conf"><a href="#公共配置-：redis-conf" class="headerlink" title="公共配置 ：redis.conf"></a>公共配置 ：redis.conf</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis configuration file example.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note that in order to read the configuration file, Redis must be</span></span><br><span class="line"><span class="comment"># started with the file path as first argument:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ./redis-server /path/to/redis.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Note on units: when memory size is needed, it is possible to specify</span></span><br><span class="line"><span class="comment"># it in the usual form of 1k 5GB 4M and so forth:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1k =&gt; 1000 bytes</span></span><br><span class="line"><span class="comment"># 1kb =&gt; 1024 bytes</span></span><br><span class="line"><span class="comment"># 1m =&gt; 1000000 bytes</span></span><br><span class="line"><span class="comment"># 1mb =&gt; 1024*1024 bytes</span></span><br><span class="line"><span class="comment"># 1g =&gt; 1000000000 bytes</span></span><br><span class="line"><span class="comment"># 1gb =&gt; 1024*1024*1024 bytes</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># units are case insensitive so 1GB 1Gb 1gB are all the same.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 建议</span></span><br><span class="line"><span class="comment"># 1,引用公共的配置文件，建议为全路径值</span></span><br><span class="line"><span class="comment"># include redis.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># yes表示以集群方式运行，为no表示以非集群方式运行</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志级别，建议为notice，</span></span><br><span class="line"><span class="comment"># 另外注意redis是不会滚动日志文件的，每次写日志都是先打开日志文件再写日志再关闭方式</span></span><br><span class="line"><span class="comment"># debug</span></span><br><span class="line"><span class="comment"># verbose</span></span><br><span class="line"><span class="comment"># notice</span></span><br><span class="line"><span class="comment"># warning</span></span><br><span class="line">loglevel notice</span><br><span class="line"></span><br><span class="line"><span class="comment"># 密码</span></span><br><span class="line">requirepass password</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选</span></span><br><span class="line"><span class="comment"># 最大连接数</span></span><br><span class="line">maxclients 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选</span></span><br><span class="line"><span class="comment"># 客户端多长（秒）时间没发包过来关闭它，0表示永不关闭</span></span><br><span class="line">timeout 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群中的节点最大不可用时长，在这个时长内，不会被判定为fail。</span></span><br><span class="line"><span class="comment"># 对于master节点，当不可用时长超过此值时，slave在延迟至少0.5秒后会发起选举</span></span><br><span class="line"><span class="comment"># 进行failover成为master。Redis集群的很多其它值与cluster-node-timeout有关。</span></span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.0 以下使用cluster-slave-validity-factor</span></span><br><span class="line"><span class="comment"># 如果设置为0，则slave总是尝试成为master，无论slave和master间的链接断开时间的长短。</span></span><br><span class="line"><span class="comment"># 如果是一个大于0的值，则最大可断开时长为：(cluster-slave-validity-factor * cluster-node-timeout)。</span></span><br><span class="line"><span class="comment"># 例如：当cluster-node-timeout值为5，cluster-slave-validity-factor值为10时，</span></span><br><span class="line"><span class="comment"># slave和master间的连接断开50秒内，slave不会尝试成为master。</span></span><br><span class="line">cluster-replica-validity-factor 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个参数一定不能小于repl-ping-replica-period，</span></span><br><span class="line"><span class="comment"># 可以考虑为repl-ping-replica-period的3倍或更大。定义多长时间内均PING不通时，</span></span><br><span class="line"><span class="comment"># 判定心跳超时。对于redis集群，达到这个值并不会发生主从切换,主从何时切换由</span></span><br><span class="line"><span class="comment"># 参数cluster-node-timeout控制，只有master状态为fail后，它的slaves才能发起选举。</span></span><br><span class="line">repl-timeout 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.0 以下使用 repl-ping-slave-period</span></span><br><span class="line"><span class="comment"># 定义slave多久（秒）ping一次master，如果超过repl-timeout指定的时长都没有收到响应，</span></span><br><span class="line"><span class="comment"># 则认为master挂了</span></span><br><span class="line">repl-ping-replica-period 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.0 以下使用 slave-read-only</span></span><br><span class="line"><span class="comment"># slave是否只读</span></span><br><span class="line">replica-read-only yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.0 以下使用 slave-serve-stale-data</span></span><br><span class="line"><span class="comment"># 当slave与master断开连接，slave是否继续提供服务</span></span><br><span class="line">replica-serve-stale-data yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.0 以下使用 slave-priority</span></span><br><span class="line"><span class="comment"># slave权重值，当master挂掉，只有权重最大的slave接替master</span></span><br><span class="line">replica-priority 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.0新增配置项，用于控制是否启用RDB-AOF混用，值为no表示关闭</span></span><br><span class="line">aof-use-rdb-preamble yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当同时写AOF或RDB，则redis启动时只会加载AOF，AOF包含了全量数据。</span></span><br><span class="line"><span class="comment"># 如果当队列使用，入队压力又很大，建议设置为no</span></span><br><span class="line">appendonly yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可取值everysec，其中no表示由系统自动，</span></span><br><span class="line"><span class="comment"># 当写压力很大时，建议设置为no，否则容易造成整个集群不可用</span></span><br><span class="line"><span class="comment"># appendfsync always</span></span><br><span class="line"><span class="comment"># appendfsync everysec</span></span><br><span class="line"><span class="comment"># appendfsync no</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以守护进程运行 Redis 实例</span></span><br><span class="line"><span class="comment"># 相关配置项pidfile</span></span><br><span class="line">daemonize yes                          </span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.2.0新增的配置项，默认值为yes，限制从其它机器登录Redis server，而只能从127.0.0.1登录。</span></span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line"><span class="comment"># 取值不能超过系统的/proc/sys/net/core/somaxconn</span></span><br><span class="line"><span class="comment"># 此参数是指：已完成三次握手的TCP连接队列，默认值511，</span></span><br><span class="line"><span class="comment"># 但是Linux系统内核参数socket最大连接的值默认是128，对应文件/proc/sys/net/core/somaxconn，</span></span><br><span class="line"><span class="comment"># 当系统并发量大且客户端连接缓慢时，应该将两个值进行参考设置。</span></span><br><span class="line">tcp-backlog 511</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置自动rewite AOF文件（手工rewrite只需要调用命令BGREWRITEAOF）</span></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 触发rewrite的AOF文件大小，只有大于此大小时才会触发rewrite</span></span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子进程在做rewrite时，主进程不调用fsync（由内核默认调度）</span></span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果因为磁盘故障等导致保存rdb失败，停止写操作，可设置为NO。</span></span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为no表示有slots不可服务时其它slots仍然继续服务，建议值为no，以提供最高的可用性</span></span><br><span class="line">cluster-require-full-coverage no</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置最大的内存，单位为字节 </span></span><br><span class="line"><span class="comment"># 26843545600(25GB)</span></span><br><span class="line"><span class="comment"># 19327352832(18GB)</span></span><br><span class="line"><span class="comment"># 注意，在 64bit 系统下，maxmemory 设置为 0 表示不限制 Redis 内存使用，</span></span><br><span class="line"><span class="comment"># 在 32bit 系统下，maxmemory 隐式不能超过 3GB。 </span></span><br><span class="line">maxmemory 19327352832</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置达到最大内存时的淘汰策略</span></span><br><span class="line">maxmemory-policy volatile-lru</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置master端的客户端缓存，三种：normal、replica和pubsub</span></span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit replica 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最少slave(replica)数，用来保证集群中不会有裸奔的master。当某个master节点的slave(replica)节点挂掉裸奔后，</span></span><br><span class="line"><span class="comment"># 会从其他富余的master节点分配一个slave(replica)节点过来，确保每个master节点都有至少一个slave(replica)节点，</span></span><br><span class="line"><span class="comment"># 不至于因为master节点挂掉而没有相应slave(replica)节点替换为master节点导致集群崩溃不可用。</span></span><br><span class="line">cluster-migration-barrier 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当slave(replica)失联时的，环形复制缓区大小，值越大可容忍更长的slave(replica)失联时长</span></span><br><span class="line">repl-backlog-size 1mb</span><br><span class="line"></span><br><span class="line"><span class="comment"># slave失联的时长达到该值时，释放backlog缓冲区</span></span><br><span class="line"><span class="comment"># repl-backlog-ttl 3600</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新快照（RDB）到磁盘的策略，根据实际调整值，</span></span><br><span class="line"><span class="comment"># “save 900 1”表示900秒后至少有1个key被修改才触发save操作，其它类推。</span></span><br><span class="line"><span class="comment"># 注意执行flushall命令也会产生RDB文件，不过是空文件。</span></span><br><span class="line"><span class="comment"># 如果不想生成RDB文件，可以将save全注释掉。</span></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure>

<h3 id="禁止指定命令"><a href="#禁止指定命令" class="headerlink" title="禁止指定命令"></a>禁止指定命令</h3><p>KEYS命令很耗时，FLUSHDB和FLUSHALL命令可能导致误删除数据，所以线上环境最好禁止使用，可以在Redis配置文件增加如下配置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rename-command KEYS <span class="string">""</span></span><br><span class="line">rename-command FLUSHDB <span class="string">""</span></span><br><span class="line">rename-command FLUSHALL <span class="string">""</span></span><br></pre></td></tr></table></figure>

<h3 id="端口配置：redis-PORT-conf"><a href="#端口配置：redis-PORT-conf" class="headerlink" title="端口配置：redis-PORT.conf"></a>端口配置：redis-PORT.conf</h3><p>注：PORT 需要改成具体端口；</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1,引用公共的配置文件，建议为全路径值</span></span><br><span class="line">include /usr/<span class="built_in">local</span>/redis-cluster/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 必须</span></span><br><span class="line"><span class="comment"># 端口号</span></span><br><span class="line">port PORT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 必须</span></span><br><span class="line"><span class="comment"># 默认放在dir指定的目录，注意不能包含目录，纯文件名，为redis-server进程自动维护，不能手工修改</span></span><br><span class="line">cluster-config-file nodes-PORT.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#  可选</span></span><br><span class="line"><span class="comment">#  只有当daemonize值为yes时，才有意义；并且这个要求对目录/var/run有写权限，否则可以考虑设置为/#  tmp/redis-PORT.pid，或者放在bin或log目录下，如：/data/redis/log/redis-PORT.pid。只有当配#  置项daemonize的值为yes时，才会产生这个文件。</span></span><br><span class="line">pidfile /var/run/redis-PORT.pid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作目录。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># DB 将写入此目录，并指定文件名</span></span><br><span class="line"><span class="comment"># 以上使用"dbfilename"配置指令。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 仅追加文件也将在此目录中创建。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 请注意，您必须在此处指定目录，而不是文件名。</span></span><br><span class="line">dir /usr/<span class="built_in">local</span>/redis-cluster/data/PORT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 纯文件名，位于dir指定的目录下，不能包含目录，</span></span><br><span class="line"><span class="comment"># 否则报错“appendfilename can't be a path, just # a filename”。</span></span><br><span class="line"><span class="comment"># 如果开启了AOF，REdis进程启动时并不会读取RDB文件，</span></span><br><span class="line"><span class="comment"># 所以配置上可以考虑关闭RDB，这样可以提升REdis稳定性。</span></span><br><span class="line">dbfilename dump-PORT.rdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 纯文件名，位于dir指定的目录下，不能包含目录，</span></span><br><span class="line"><span class="comment"># 否则报错“appendfilename can't be a path, just a filename”</span></span><br><span class="line">appendfilename <span class="string">"appendonly-PORT.aof"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志文件，包含目录和文件名，注意redis不会自动滚动日志文件</span></span><br><span class="line">logfile /usr/<span class="built_in">local</span>/redis-cluster/<span class="built_in">log</span>/redis-PORT.log</span><br></pre></td></tr></table></figure>

<h2 id="创建和启动redis集群"><a href="#创建和启动redis集群" class="headerlink" title="创建和启动redis集群"></a>创建和启动redis集群</h2><h3 id="加上进程监控"><a href="#加上进程监控" class="headerlink" title="加上进程监控"></a>加上进程监控</h3><p>使用 <a href="https://github.com/eyjian/libmooon/blob/master/shell/process_monitor.sh" target="_blank" rel="noopener">https://github.com/eyjian/libmooon/blob/master/shell/process_monitor.sh</a></p>
<p>监控示例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REDIS_HOME=/usr/<span class="built_in">local</span></span><br><span class="line">* * * * * /usr/<span class="built_in">local</span>/bin/process_monitor.sh <span class="string">"<span class="variable">$REDIS_HOME</span>/bin/redis-server 6379"</span> <span class="string">"<span class="variable">$REDIS_HOME</span>/bin/redis-server <span class="variable">$REDIS_HOME</span>/redis-cluster/redis-6379.conf"</span></span><br><span class="line">* * * * * /usr/<span class="built_in">local</span>/bin/process_monitor.sh <span class="string">"<span class="variable">$REDIS_HOME</span>/bin/redis-server 6380"</span> <span class="string">"<span class="variable">$REDIS_HOME</span>/bin/redis-server <span class="variable">$REDIS_HOME</span>/redis-cluster/redis-6380.conf"</span></span><br><span class="line">* * * * * /usr/<span class="built_in">local</span>/bin/process_monitor.sh <span class="string">"<span class="variable">$REDIS_HOME</span>/bin/redis-server 6381"</span> <span class="string">"<span class="variable">$REDIS_HOME</span>/bin/redis-server <span class="variable">$REDIS_HOME</span>/redis-cluster/redis-6381.conf"</span></span><br></pre></td></tr></table></figure>

<p>注意：redis的日志文件不会自动滚动，<code>redis-server</code> 每次在写日志时，均会以追加方式调用fopen写日志，而不处理滚动。<br>也可借助linux自带的 <code>logrotate</code> 来滚动redis日志，命令 <code>logrotate</code> 一般位于目录 <code>/usr/sbin</code> 下。</p>
<p>滚动日志（可选）:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* * * * * <span class="built_in">log</span>=<span class="variable">$REDIS_HOME</span>/redis-cluster/<span class="built_in">log</span>/redis-6379.log;<span class="keyword">if</span> <span class="built_in">test</span> `ls -l <span class="variable">$log</span>|cut -d<span class="string">' '</span> -f5` -gt 104857600; <span class="keyword">then</span> mv <span class="variable">$log</span> <span class="variable">$log</span>.old; <span class="keyword">fi</span></span><br><span class="line">* * * * * <span class="built_in">log</span>=<span class="variable">$REDIS_HOME</span>/redis-cluster/<span class="built_in">log</span>/redis-6380.log;<span class="keyword">if</span> <span class="built_in">test</span> `ls -l <span class="variable">$log</span>|cut -d<span class="string">' '</span> -f5` -gt 104857600; <span class="keyword">then</span> mv <span class="variable">$log</span> <span class="variable">$log</span>.old; <span class="keyword">fi</span></span><br><span class="line">* * * * * <span class="built_in">log</span>=<span class="variable">$REDIS_HOME</span>/redis-cluster/<span class="built_in">log</span>/redis-6381.log;<span class="keyword">if</span> <span class="built_in">test</span> `ls -l <span class="variable">$log</span>|cut -d<span class="string">' '</span> -f5` -gt 104857600; <span class="keyword">then</span> mv <span class="variable">$log</span> <span class="variable">$log</span>.old; <span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="Redis集群TCP端口（Redis-Cluster-TCP-ports）"><a href="#Redis集群TCP端口（Redis-Cluster-TCP-ports）" class="headerlink" title="Redis集群TCP端口（Redis Cluster TCP ports）"></a>Redis集群TCP端口（Redis Cluster TCP ports）</h3><p>每个Redis集群中的节点都需要打开两个TCP连接。一个连接用于正常的给Client提供服务，比如6379，还有一个额外的端口（通过在这个端口号上加10000）作为数据端口，比如16379。第二个端口（本例中就是16379）用于集群总线，这是一个用二进制协议的点对点通信信道。这个集群总线（Cluster bus）用于节点的失败侦测、配置更新、故障转移授权，等等。客户端从来都不应该尝试和这些集群总线端口通信，它们只应该和正常的Redis命令端口进行通信。注意，确保在你的防火墙中开放着两个端口，否则，Redis集群节点之间将无法通信。</p>
<p>命令端口和集群总线端口的偏移量总是10000。</p>
<p>注意，如果想要集群按照你想的那样工作，那么集群中的每个节点应该：</p>
<p>正常的客户端通信端口（通常是6379）用于和所有可到达集群的所有客户端通信<br>集群总线端口（the client port + 10000）必须对所有的其它节点是可到达的<br>也就是，要想集群正常工作，集群中的每个节点需要做到以下两点：</p>
<p>正常的客户端通信端口（通常是6379）必须对所有的客户端都开放，换言之，所有的客户端都可以访问<br>集群总线端口（客户端通信端口 + 10000）必须对集群中的其它节点开放，换言之，其它任意节点都可以访问<br>如果你没有开放TCP端口，你的集群可能不会像你期望的那样工作。集群总线用一个不同的二进制协议通信，用于节点之间的数据交换。</p>
<h3 id="快速创建-启动redis集群"><a href="#快速创建-启动redis集群" class="headerlink" title="快速创建,启动redis集群"></a>快速创建,启动redis集群</h3><p>如果只是想快速创建和启动redis集群，而不关心过程，可使用redis官方提供的脚本 <code>create-cluster</code>，两步完成：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create-cluster start</span><br><span class="line">create-cluster create</span><br></pre></td></tr></table></figure>

<p>第二步 <code>create-cluster create</code> 是一个交互式过程，当提示时，请输入 <code>yes</code> 再回车继续，第一个节点的端口号为 30001，一共会启动六个redis节点。</p>
<p>create-cluster位于redis源代码的 <code>utils/create-cluster</code> 目录下，是一个bash脚本文件。</p>
<p>停止集群：<code>create-cluster stop</code>。</p>
<h3 id="创建redis-cluster"><a href="#创建redis-cluster" class="headerlink" title="创建redis cluster"></a>创建redis cluster</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注：由于只有两台服务器，故在服务器1上部署两个主节点，一个从节点，服务器2上部署两个从节点，一个主节点。</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/redis-cli --cluster create 192.125.30.111:6379 192.125.30.111:6380 192.125.30.59:6381 192.125.30.59:6379 192.125.30.59:6380 192.125.30.111:6381 --cluster-replicas 1</span><br></pre></td></tr></table></figure>

<p>如果群集设置着密码，需要使用 <code>-a 密码</code>，否则会报错：<code>(error)NOAUTH Authentication required</code>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/bin/redis-cli -a <span class="built_in">test</span> --cluster create 192.125.30.111:6379 192.125.30.111:6380 192.125.30.59:6381 192.125.30.59:6379 192.125.30.59:6380 192.125.30.111:6381 --cluster-replicas 1</span><br></pre></td></tr></table></figure>

<p>注意：如果报以下错误，需要停止单个redis节点，并把对应的数据目录删除重建。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Warning: Using a password with <span class="string">'-a'</span> or <span class="string">'-u'</span> option on the <span class="built_in">command</span> line interface may not be safe.</span><br><span class="line">[ERR] Node 192.125.30.59:6381 is not empty. Either the node already knows other nodes (check with CLUSTER NODES) or contains some key <span class="keyword">in</span> database 0.</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#停止节点，</span></span><br><span class="line">[root@host-192-125-30-111 ~]<span class="comment"># ps aux | grep redis</span></span><br><span class="line">root     10547  0.0  0.0 112724   988 pts/0    R+   11:03   0:00 grep --color=auto redis</span><br><span class="line">root     17367  0.1  0.0 156452  7920 ?        Ssl  8月15   3:56 /usr/<span class="built_in">local</span>/bin/redis-server *:6379 [cluster]</span><br><span class="line">root     17372  0.1  0.0 153892  7844 ?        Ssl  8月15   3:21 /usr/<span class="built_in">local</span>/bin/redis-server *:6380 [cluster]</span><br><span class="line">root     17377  0.1  0.0 153892  7848 ?        Ssl  8月15   3:20 /usr/<span class="built_in">local</span>/bin/redis-server *:6381 [cluster]</span><br><span class="line">[root@host-192-125-30-111 ~]<span class="comment"># kill -9 17367</span></span><br><span class="line">[root@host-192-125-30-111 ~]<span class="comment"># kill -9 17372</span></span><br><span class="line">[root@host-192-125-30-111 ~]<span class="comment"># kill -9 17377</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除数据目录</span></span><br><span class="line">[root@host-192-125-30-111 ~]<span class="comment"># cd /usr/local/</span></span><br><span class="line">[root@host-192-125-30-111 <span class="built_in">local</span>]<span class="comment"># ls</span></span><br><span class="line">bin  etc  games  include  lib  lib64  libexec  redis-cluster  sbin  share  src</span><br><span class="line">[root@host-192-125-30-111 <span class="built_in">local</span>]<span class="comment"># cd redis-cluster</span></span><br><span class="line">[root@host-192-125-30-111 redis-cluster]<span class="comment"># ls</span></span><br><span class="line">data  <span class="built_in">log</span>  redis-6379.conf  redis-6380.conf  redis-6381.conf  redis.conf</span><br><span class="line">[root@host-192-125-30-111 redis-cluster]<span class="comment"># cd data</span></span><br><span class="line">[root@host-192-125-30-111 data]<span class="comment"># ls</span></span><br><span class="line">6379  6380  6381</span><br><span class="line">[root@host-192-125-30-111 data]<span class="comment"># rm -rf 63*</span></span><br><span class="line">[root@host-192-125-30-111 data]<span class="comment"># ls</span></span><br><span class="line">[root@host-192-125-30-111 data]<span class="comment"># mkdir -p 6379 6380 6381</span></span><br><span class="line">[root@host-192-125-30-111 data]<span class="comment"># cd ..</span></span><br><span class="line">[root@host-192-125-30-111 redis-cluster]<span class="comment"># ls</span></span><br><span class="line">data  <span class="built_in">log</span>  redis-6379.conf  redis-6380.conf  redis-6381.conf  redis.conf</span><br><span class="line">[root@host-192-125-30-111 redis-cluster]<span class="comment"># cd log</span></span><br><span class="line">[root@host-192-125-30-111 <span class="built_in">log</span>]<span class="comment"># ls</span></span><br><span class="line">redis-6379.log  redis-6380.log  redis-6381.log</span><br><span class="line">[root@host-192-125-30-111 <span class="built_in">log</span>]<span class="comment"># rm -rf redis-*.log</span></span><br><span class="line">[root@host-192-125-30-111 <span class="built_in">log</span>]<span class="comment"># ls</span></span><br><span class="line">[root@host-192-125-30-111 <span class="built_in">log</span>]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><code>redis-cli</code> 的参数说明：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 表示创建一个redis集群。</span></span><br><span class="line">create</span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示为集群中的每一个主节点指定一个从节点，即一比一的复制。</span></span><br><span class="line">--cluster-replicas 1</span><br></pre></td></tr></table></figure>

<p>注意：如果配置项 <code>cluster-enabled</code> 的值不为yes，则执行时会报错 <code>[ERR] Node 192.168.0.251:6381 is not configured as a cluster node.</code></p>
<p>输出：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@host-192-125-30-111 redis-cluster]<span class="comment"># /usr/local/bin/redis-cli -a Perfect1 --cluster create 192.125.30.111:6379 192.125.30.111:6380 192.125.30.59:6381 192.125.30.59:6379 192.125.30.59:6380 192.125.30.111:6381 --cluster-replicas 1</span></span><br><span class="line">Warning: Using a password with <span class="string">'-a'</span> or <span class="string">'-u'</span> option on the <span class="built_in">command</span> line interface may not be safe.</span><br><span class="line">&gt;&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383</span><br><span class="line">Adding replica 192.125.30.59:6380 to 192.125.30.111:6379</span><br><span class="line">Adding replica 192.125.30.111:6381 to 192.125.30.59:6381</span><br><span class="line">Adding replica 192.125.30.59:6379 to 192.125.30.111:6380</span><br><span class="line">M: 9df266851fa7d8d9363d584a5bc644f36ea1d052 192.125.30.111:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: 932a6ab157056e2d36e3915780b5d77138bbabdb 192.125.30.111:6380</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">M: fb9923083a70ca2131b3fb6c7633bc7275dfe33c 192.125.30.59:6381</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">S: 53ab782834f304013ac055a35e5275e5004b30c7 192.125.30.59:6379</span><br><span class="line">   replicates 932a6ab157056e2d36e3915780b5d77138bbabdb</span><br><span class="line">S: 7854f8ed0234945e89af5079331ce7779449d632 192.125.30.59:6380</span><br><span class="line">   replicates 9df266851fa7d8d9363d584a5bc644f36ea1d052</span><br><span class="line">S: 1141e28e7b135db55cdb1c87c143ee0c0502d26d 192.125.30.111:6381</span><br><span class="line">   replicates fb9923083a70ca2131b3fb6c7633bc7275dfe33c</span><br><span class="line">Can I <span class="built_in">set</span> the above configuration? (<span class="built_in">type</span> <span class="string">'yes'</span> to accept): yes</span><br><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting <span class="keyword">for</span> the cluster to join</span><br><span class="line">..</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 192.125.30.111:6379)</span><br><span class="line">M: 9df266851fa7d8d9363d584a5bc644f36ea1d052 192.125.30.111:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 1141e28e7b135db55cdb1c87c143ee0c0502d26d 192.125.30.111:6381</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates fb9923083a70ca2131b3fb6c7633bc7275dfe33c</span><br><span class="line">M: 932a6ab157056e2d36e3915780b5d77138bbabdb 192.125.30.111:6380</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 7854f8ed0234945e89af5079331ce7779449d632 192.125.30.59:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 9df266851fa7d8d9363d584a5bc644f36ea1d052</span><br><span class="line">S: 53ab782834f304013ac055a35e5275e5004b30c7 192.125.30.59:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 932a6ab157056e2d36e3915780b5d77138bbabdb</span><br><span class="line">M: fb9923083a70ca2131b3fb6c7633bc7275dfe33c 192.125.30.59:6381</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>

<p><strong>ps aux|grep redis-server</strong></p>
<p>查看redis进程是否已切换为集群状态（cluster）</p>
<p>停止redis实例，直接使用kill命令即可，如：kill 3825，重启和单机版相同。</p>
<p><strong>从slaves读数据</strong></p>
<p>默认不能从slaves读取数据，但建立连接后，执行一次命令 <code>READONLY</code> ，即可从slaves读取数据。如果想再次恢复不能从slaves读取数据，可以执行下命令 <code>READWRITE</code>。</p>
<h2 id="群集操作"><a href="#群集操作" class="headerlink" title="群集操作"></a>群集操作</h2><h3 id="新增主（master）节点"><a href="#新增主（master）节点" class="headerlink" title="新增主（master）节点"></a>新增主（master）节点</h3><p>注意一定要保证新节点里面没有添加过任何数据</p>
<p>以添加 <code>192.168.0.251:6390</code> 为例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.0.251:6381 为集群中任一可用的节点</span></span><br><span class="line">redis-cli --cluster add-node 192.168.0.251:6390 192.168.0.251:6381</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">redis-cli -c -p 6381 cluster nodes|grep master</span><br></pre></td></tr></table></figure>

<p>新加入的master节点上没有任何数据（slots，运行redis命令cluster nodes可以看到这个情况）。当一个slave想成为master时，由于这个新的master节点不管理任何slots，它不参与选举。可以使用redis-cli的reshard为这个新master节点分配slots，如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster reshard 192.168.0.251:6390</span><br></pre></td></tr></table></figure>

<h3 id="新增从（slave）节点"><a href="#新增从（slave）节点" class="headerlink" title="新增从（slave）节点"></a>新增从（slave）节点</h3><p>以添加 <code>192.168.0.251:6390</code> 为例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster add-node 192.168.0.251:6390 192.168.0.251:6381 --cluster-slave</span><br></pre></td></tr></table></figure>

<p><code>192.168.0.251:6390</code> 为新添加的从节点，<code>192.168.0.251:6381</code> 可为集群中已有的任意节点，这种方法随机为6390指定一个master，如果想明确指定master，假设目标master的ID为<code>3c3a0c74aae0b56170ccb03a76b60cfe7dc1912e</code>，则：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster add-node 192.168.0.251:6390 192.168.0.251:6381 --cluster-slave --cluster-master-id 3c3a0c74aae0b56170ccb03a76b60cfe7dc1912e</span><br></pre></td></tr></table></figure>

<h3 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h3><p>从集群中删除一个节点命令格式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 127.0.0.1:7000 为集群中任意一个非待删除节点，node-id 为待删除节点的ID。</span></span><br><span class="line">redis-cli --cluster del-node 127.0.0.1:7000 `&lt;node-id&gt;`</span><br></pre></td></tr></table></figure>

<p>如果待删除的是master节点，则在删除之前需要将该master负责的slots先全部迁到其它master。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./redis-cli --cluster del-node 192.168.0.251:6381 082c079149a9915612d21cca8e08c831a4edeade</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Removing node 082c079149a9915612d21cca8e08c831a4edeade from cluster 192.168.0.251:6381</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; SHUTDOWN the node.</span><br></pre></td></tr></table></figure>

<p>如果删除后，其它节点还看得到这个被删除的节点，则可通过FORGET命令解决，需要在所有还看得到的其它节点上执行：</p>
<p>CLUSTER FORGET <code>&lt;node-id&gt;</code></p>
<p>FORGET做两件事：</p>
<p>1) 从节点表剔除节点；</p>
<p>2) 在60秒的时间内，阻止相同ID的节点加进来。</p>
<h3 id="slots相关命令"><a href="#slots相关命令" class="headerlink" title="slots相关命令"></a>slots相关命令</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CLUSTER ADDSLOTS slot1 [slot2] ... [slotN]</span><br><span class="line">CLUSTER DELSLOTS slot1 [slot2] ... [slotN]</span><br><span class="line">CLUSTER SETSLOT slot NODE node</span><br><span class="line">CLUSTER SETSLOT slot MIGRATING node</span><br><span class="line">CLUSTER SETSLOT slot IMPORTING node</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a href="https://blog.csdn.net/Aquester/article/details/90511200" target="_blank" rel="noopener">Redis-5.0.0集群配置</a></p>
<p><a href="https://www.cnblogs.com/cjsblog/p/9048545.html" target="_blank" rel="noopener">Redis集群</a></p>
<p><a href="https://www.cnblogs.com/esofar/p/10486621.html" target="_blank" rel="noopener">分布式缓存 Redis 集群搭建</a></p>
<p><a href="https://www.cnblogs.com/zh-dream/p/12275031.html" target="_blank" rel="noopener">redis集群配置文件</a></p>
<p><a href="https://www.cnblogs.com/ysocean/p/9074787.html" target="_blank" rel="noopener">Redis详解（二）– redis的配置文件介绍</a></p>
<p><a href="https://www.cnblogs.com/renpingsheng/p/9833740.html" target="_blank" rel="noopener">高可用Redis(十一)：使用redis-trib.rb工具搭建集群</a></p>
<p><a href="https://redis.io/topics/cluster-tutorial" target="_blank" rel="noopener">Redis cluster tutorial</a></p>
<p><a href="https://redis.io/topics/cluster-spec" target="_blank" rel="noopener">Redis Cluster Specification</a></p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/安装部署/">安装部署</a><a href="/tags/CentOS7/">CentOS7</a><a href="/tags/Redis/">Redis</a><a href="/tags/群集/">群集</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Redis/">Redis</a>
</div>



<div class="article-share" id="share">

  <div data-url="https://syxdevcode.github.com/2020/08/03/Redis-Cluster%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/" data-title="Redis-Cluster集群部署 | syxdevcode博客" data-tsina="" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2020/08/04/Linux Shell echo命令/" title="Linux Shell echo命令">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Linux Shell echo命令</span>
</a>
</div>


<div class="next">
<a href="/2020/08/03/Alpha、Beta、RC、GA版本的区别/"  title="Alpha、Beta、RC、GA版本的区别">
 <strong>NEXT:</strong><br/> 
 <span>Alpha、Beta、RC、GA版本的区别
</span>
</a>
</div>

</nav>

	
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#修改系统参数"><span class="toc-number">1.</span> <span class="toc-text">修改系统参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#修改最大可打开文件数"><span class="toc-number">1.1.</span> <span class="toc-text">修改最大可打开文件数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP监听队列大小"><span class="toc-number">1.2.</span> <span class="toc-text">TCP监听队列大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OOM相关：vm-overcommit-memory"><span class="toc-number">1.3.</span> <span class="toc-text">OOM相关：vm.overcommit_memory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-Transparent-HugePages-透明大页"><span class="toc-number">1.4.</span> <span class="toc-text">Linux Transparent HugePages(透明大页)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#目录结构"><span class="toc-number">2.</span> <span class="toc-text">目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置redis"><span class="toc-number">3.</span> <span class="toc-text">配置redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#公共配置-：redis-conf"><span class="toc-number">3.1.</span> <span class="toc-text">公共配置 ：redis.conf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#禁止指定命令"><span class="toc-number">3.2.</span> <span class="toc-text">禁止指定命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#端口配置：redis-PORT-conf"><span class="toc-number">3.3.</span> <span class="toc-text">端口配置：redis-PORT.conf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建和启动redis集群"><span class="toc-number">4.</span> <span class="toc-text">创建和启动redis集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#加上进程监控"><span class="toc-number">4.1.</span> <span class="toc-text">加上进程监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis集群TCP端口（Redis-Cluster-TCP-ports）"><span class="toc-number">4.2.</span> <span class="toc-text">Redis集群TCP端口（Redis Cluster TCP ports）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快速创建-启动redis集群"><span class="toc-number">4.3.</span> <span class="toc-text">快速创建,启动redis集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建redis-cluster"><span class="toc-number">4.4.</span> <span class="toc-text">创建redis cluster</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#群集操作"><span class="toc-number">5.</span> <span class="toc-text">群集操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#新增主（master）节点"><span class="toc-number">5.1.</span> <span class="toc-text">新增主（master）节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#新增从（slave）节点"><span class="toc-number">5.2.</span> <span class="toc-text">新增从（slave）节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除节点"><span class="toc-number">5.3.</span> <span class="toc-text">删除节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#slots相关命令"><span class="toc-number">5.4.</span> <span class="toc-text">slots相关命令</span></a></li></ol></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Net-Standard/" title=".Net Standard">.Net Standard<sup>2</sup></a></li>
		
			<li><a href="/categories/net异步与并行/" title=".net异步与并行">.net异步与并行<sup>10</sup></a></li>
		
			<li><a href="/categories/ABP/" title="ABP">ABP<sup>27</sup></a></li>
		
			<li><a href="/categories/ASP-NET-IIS请求处理管道/" title="ASP.NET/IIS请求处理管道">ASP.NET/IIS请求处理管道<sup>2</sup></a></li>
		
			<li><a href="/categories/ApplicationPoolIdentify/" title="ApplicationPoolIdentify">ApplicationPoolIdentify<sup>1</sup></a></li>
		
			<li><a href="/categories/CSharp基础/" title="CSharp基础">CSharp基础<sup>11</sup></a></li>
		
			<li><a href="/categories/CentOS7/" title="CentOS7">CentOS7<sup>11</sup></a></li>
		
			<li><a href="/categories/Chrome/" title="Chrome">Chrome<sup>1</sup></a></li>
		
			<li><a href="/categories/CodeDOM/" title="CodeDOM">CodeDOM<sup>3</sup></a></li>
		
			<li><a href="/categories/Consul/" title="Consul">Consul<sup>3</sup></a></li>
		
			<li><a href="/categories/Crontab/" title="Crontab">Crontab<sup>1</sup></a></li>
		
			<li><a href="/categories/Docker/" title="Docker">Docker<sup>7</sup></a></li>
		
			<li><a href="/categories/Docker-Compose/" title="Docker Compose">Docker Compose<sup>3</sup></a></li>
		
			<li><a href="/categories/DotNetCore/" title="DotNetCore">DotNetCore<sup>3</sup></a></li>
		
			<li><a href="/categories/DotNet面试题解析/" title="DotNet面试题解析">DotNet面试题解析<sup>8</sup></a></li>
		
			<li><a href="/categories/EasyNetQ/" title="EasyNetQ">EasyNetQ<sup>1</sup></a></li>
		
			<li><a href="/categories/Elasticsearch/" title="Elasticsearch">Elasticsearch<sup>1</sup></a></li>
		
			<li><a href="/categories/Emit-反射发出/" title="Emit(反射发出)">Emit(反射发出)<sup>6</sup></a></li>
		
			<li><a href="/categories/Expression-Tree/" title="Expression Tree">Expression Tree<sup>2</sup></a></li>
		
			<li><a href="/categories/Git/" title="Git">Git<sup>2</sup></a></li>
		
			<li><a href="/categories/HostService/" title="HostService">HostService<sup>1</sup></a></li>
		
			<li><a href="/categories/JavaScript-JQuery/" title="JavaScript/JQuery">JavaScript/JQuery<sup>1</sup></a></li>
		
			<li><a href="/categories/Jenkins/" title="Jenkins">Jenkins<sup>2</sup></a></li>
		
			<li><a href="/categories/Jexus/" title="Jexus">Jexus<sup>1</sup></a></li>
		
			<li><a href="/categories/Json-Net/" title="Json.Net">Json.Net<sup>1</sup></a></li>
		
			<li><a href="/categories/LINQ/" title="LINQ">LINQ<sup>3</sup></a></li>
		
			<li><a href="/categories/Let’s-Encrypt/" title="Let’s Encrypt">Let’s Encrypt<sup>1</sup></a></li>
		
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>5</sup></a></li>
		
			<li><a href="/categories/Linux基础命令/" title="Linux基础命令">Linux基础命令<sup>9</sup></a></li>
		
			<li><a href="/categories/MSIL指令/" title="MSIL指令">MSIL指令<sup>2</sup></a></li>
		
			<li><a href="/categories/MVC-Web-API/" title="MVC/Web API">MVC/Web API<sup>2</sup></a></li>
		
			<li><a href="/categories/MariaDB/" title="MariaDB">MariaDB<sup>1</sup></a></li>
		
			<li><a href="/categories/MarkDown/" title="MarkDown">MarkDown<sup>1</sup></a></li>
		
			<li><a href="/categories/MinIo/" title="MinIo">MinIo<sup>1</sup></a></li>
		
			<li><a href="/categories/MongoDB/" title="MongoDB">MongoDB<sup>3</sup></a></li>
		
			<li><a href="/categories/Moq/" title="Moq">Moq<sup>1</sup></a></li>
		
			<li><a href="/categories/MySql/" title="MySql">MySql<sup>6</sup></a></li>
		
			<li><a href="/categories/Naudio/" title="Naudio">Naudio<sup>2</sup></a></li>
		
			<li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>2</sup></a></li>
		
			<li><a href="/categories/Nodejs/" title="Nodejs">Nodejs<sup>3</sup></a></li>
		
			<li><a href="/categories/OAuth2-0/" title="OAuth2.0">OAuth2.0<sup>2</sup></a></li>
		
			<li><a href="/categories/Ocelot/" title="Ocelot">Ocelot<sup>1</sup></a></li>
		
			<li><a href="/categories/Openssl/" title="Openssl">Openssl<sup>2</sup></a></li>
		
			<li><a href="/categories/PAM/" title="PAM">PAM<sup>1</sup></a></li>
		
			<li><a href="/categories/Polly/" title="Polly">Polly<sup>2</sup></a></li>
		
			<li><a href="/categories/PostGresqlSql/" title="PostGresqlSql">PostGresqlSql<sup>1</sup></a></li>
		
			<li><a href="/categories/Python/" title="Python">Python<sup>1</sup></a></li>
		
			<li><a href="/categories/RESTful/" title="RESTful">RESTful<sup>2</sup></a></li>
		
			<li><a href="/categories/RabbitMQ/" title="RabbitMQ">RabbitMQ<sup>2</sup></a></li>
		
			<li><a href="/categories/Redis/" title="Redis">Redis<sup>8</sup></a></li>
		
			<li><a href="/categories/Resharper/" title="Resharper">Resharper<sup>1</sup></a></li>
		
			<li><a href="/categories/SSH/" title="SSH">SSH<sup>1</sup></a></li>
		
			<li><a href="/categories/SSL-TLS/" title="SSL/TLS">SSL/TLS<sup>2</sup></a></li>
		
			<li><a href="/categories/Shell脚本/" title="Shell脚本">Shell脚本<sup>1</sup></a></li>
		
			<li><a href="/categories/Skywalking/" title="Skywalking">Skywalking<sup>1</sup></a></li>
		
			<li><a href="/categories/Sql/" title="Sql">Sql<sup>5</sup></a></li>
		
			<li><a href="/categories/TDD/" title="TDD">TDD<sup>1</sup></a></li>
		
			<li><a href="/categories/TPL-DataFlow/" title="TPL DataFlow">TPL DataFlow<sup>2</sup></a></li>
		
			<li><a href="/categories/WCF时间类型序列化/" title="WCF时间类型序列化">WCF时间类型序列化<sup>1</sup></a></li>
		
			<li><a href="/categories/WSL/" title="WSL">WSL<sup>1</sup></a></li>
		
			<li><a href="/categories/WebForm/" title="WebForm">WebForm<sup>2</sup></a></li>
		
			<li><a href="/categories/WinDbg/" title="WinDbg">WinDbg<sup>1</sup></a></li>
		
			<li><a href="/categories/WinSCP/" title="WinSCP">WinSCP<sup>1</sup></a></li>
		
			<li><a href="/categories/Windows系统/" title="Windows系统">Windows系统<sup>1</sup></a></li>
		
			<li><a href="/categories/ab/" title="ab">ab<sup>1</sup></a></li>
		
			<li><a href="/categories/hexo/" title="hexo">hexo<sup>2</sup></a></li>
		
			<li><a href="/categories/idea/" title="idea">idea<sup>2</sup></a></li>
		
			<li><a href="/categories/java/" title="java">java<sup>4</sup></a></li>
		
			<li><a href="/categories/shadowsocks/" title="shadowsocks">shadowsocks<sup>1</sup></a></li>
		
			<li><a href="/categories/supervisor/" title="supervisor">supervisor<sup>2</sup></a></li>
		
			<li><a href="/categories/zookeeper/" title="zookeeper">zookeeper<sup>1</sup></a></li>
		
			<li><a href="/categories/内存泄漏/" title="内存泄漏">内存泄漏<sup>1</sup></a></li>
		
			<li><a href="/categories/分布式/" title="分布式">分布式<sup>1</sup></a></li>
		
			<li><a href="/categories/分布式事务/" title="分布式事务">分布式事务<sup>1</sup></a></li>
		
			<li><a href="/categories/单词收录/" title="单词收录">单词收录<sup>14</sup></a></li>
		
			<li><a href="/categories/反射/" title="反射">反射<sup>4</sup></a></li>
		
			<li><a href="/categories/委托与事件/" title="委托与事件">委托与事件<sup>4</sup></a></li>
		
			<li><a href="/categories/工具/" title="工具">工具<sup>1</sup></a></li>
		
			<li><a href="/categories/并发模型/" title="并发模型">并发模型<sup>1</sup></a></li>
		
			<li><a href="/categories/插件/" title="插件">插件<sup>1</sup></a></li>
		
			<li><a href="/categories/时间-时间戳转换/" title="时间/时间戳转换">时间/时间戳转换<sup>1</sup></a></li>
		
			<li><a href="/categories/消息队列/" title="消息队列">消息队列<sup>1</sup></a></li>
		
			<li><a href="/categories/程序集/" title="程序集">程序集<sup>2</sup></a></li>
		
			<li><a href="/categories/算法/" title="算法">算法<sup>3</sup></a></li>
		
			<li><a href="/categories/线性表/" title="线性表">线性表<sup>1</sup></a></li>
		
			<li><a href="/categories/线程池/" title="线程池">线程池<sup>1</sup></a></li>
		
			<li><a href="/categories/缓存/" title="缓存">缓存<sup>3</sup></a></li>
		
			<li><a href="/categories/计算机基础/" title="计算机基础">计算机基础<sup>3</sup></a></li>
		
			<li><a href="/categories/认证与授权/" title="认证与授权">认证与授权<sup>1</sup></a></li>
		
			<li><a href="/categories/设计模式/" title="设计模式">设计模式<sup>3</sup></a></li>
		
			<li><a href="/categories/链表/" title="链表">链表<sup>2</sup></a></li>
		
			<li><a href="/categories/集合与泛型/" title="集合与泛型">集合与泛型<sup>4</sup></a></li>
		
			<li><a href="/categories/音频-视频/" title="音频/视频">音频/视频<sup>1</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist" style="clear:both;">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Net-Standard/" title=".Net Standard">.Net Standard<sup>2</sup></a></li>
		
			<li><a href="/tags/net异步与并行/" title=".net异步与并行">.net异步与并行<sup>12</sup></a></li>
		
			<li><a href="/tags/ABP/" title="ABP">ABP<sup>27</sup></a></li>
		
			<li><a href="/tags/ASP-NET-IIS请求处理管道/" title="ASP.NET/IIS请求处理管道">ASP.NET/IIS请求处理管道<sup>7</sup></a></li>
		
			<li><a href="/tags/AWS/" title="AWS">AWS<sup>7</sup></a></li>
		
			<li><a href="/tags/ApplicationPoolIdentify/" title="ApplicationPoolIdentify">ApplicationPoolIdentify<sup>1</sup></a></li>
		
			<li><a href="/tags/CSharp/" title="CSharp">CSharp<sup>101</sup></a></li>
		
			<li><a href="/tags/CSharp基础/" title="CSharp基础">CSharp基础<sup>45</sup></a></li>
		
			<li><a href="/tags/CentOS7/" title="CentOS7">CentOS7<sup>55</sup></a></li>
		
			<li><a href="/tags/Chrome/" title="Chrome">Chrome<sup>1</sup></a></li>
		
			<li><a href="/tags/CodeDOM/" title="CodeDOM">CodeDOM<sup>3</sup></a></li>
		
			<li><a href="/tags/Consul/" title="Consul">Consul<sup>4</sup></a></li>
		
			<li><a href="/tags/Crontab/" title="Crontab">Crontab<sup>1</sup></a></li>
		
			<li><a href="/tags/Docker/" title="Docker">Docker<sup>23</sup></a></li>
		
			<li><a href="/tags/Docker-Compose/" title="Docker Compose">Docker Compose<sup>5</sup></a></li>
		
			<li><a href="/tags/DotNet/" title="DotNet">DotNet<sup>106</sup></a></li>
		
			<li><a href="/tags/DotNetCore/" title="DotNetCore">DotNetCore<sup>16</sup></a></li>
		
			<li><a href="/tags/DotNet面试题解析/" title="DotNet面试题解析">DotNet面试题解析<sup>10</sup></a></li>
		
			<li><a href="/tags/Elasticsearch/" title="Elasticsearch">Elasticsearch<sup>2</sup></a></li>
		
			<li><a href="/tags/Emit-反射发出/" title="Emit(反射发出)">Emit(反射发出)<sup>8</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
<div style="display: none;" id="rocket-to-top">
  <div style="opacity: 0; display: block;" class="level-2"></div>
  <div class="level-3"></div>
</div>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font clearfix">
		
		
		
		<a href="https://github.com/syxdevcode" target="_blank" title="github"></a>
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/syxdevcode/pacman" target="_blank" title="Pacman">Pacman</a> © 2020 
		
		<a href="https://syxdevcode.github.com" target="_blank" title="syxdevcode">syxdevcode</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>

<script type="text/javascript">
  $(document).ready(function () {
    $('.navbar').click(function () {
      $('header nav').toggleClass('shownav');
    });
    var myWidth = 0;
    function getSize() {
      if (typeof (window.innerWidth) == 'number') {
        myWidth = window.innerWidth;
      } else if (document.documentElement && document.documentElement.clientWidth) {
        myWidth = document.documentElement.clientWidth;
      };
    };
    var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
    $(window).resize(function () {
      getSize();
      if (myWidth >= 1024) {
        $('header nav').removeClass('shownav');
      } else {
        m.removeClass('moveMain');
        a.css('display', 'block').removeClass('fadeOut');
        o.css('display', 'none');
      
          $('#toc.toc-aside').css('display', 'none');
        
    }
    });
    c.click(function () {
      a.addClass('fadeOut').css('display', 'none');
      o.css('display', 'block').addClass('fadeIn');
      m.addClass('moveMain');
    });
    o.click(function () {
      o.css('display', 'none').removeClass('beforeFadeIn');
      a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
      m.removeClass('moveMain');
    });
    $(window).scroll(function () {
      o.css("top", Math.max(80, 260 - $(this).scrollTop()));
    });
  });
  //判断访问终端
  var browser = {
    versions: function () {
      var u = navigator.userAgent,
        app = navigator.appVersion;
      return {
        trident: u.indexOf('Trident') > -1, //IE内核
        presto: u.indexOf('Presto') > -1, //opera内核
        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1,//火狐内核
        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
        android: u.indexOf('Android') > -1 || u.indexOf('Adr') > -1, //android终端
        iPhone: u.indexOf('iPhone') > -1, //是否为iPhone或者QQHD浏览器
        iPad: u.indexOf('iPad') > -1, //是否iPad
        webApp: u.indexOf('Safari') == -1, //是否web应该程序，没有头部与底部
        weixin: u.indexOf('MicroMessenger') > -1, //是否微信 （2015-01-22新增）
        qq: u.match(/\sQQ/i) == " qq" //是否QQ
      };
    }(),
    language: (navigator.browserLanguage || navigator.language).toLowerCase()
  }
</script>

<script type="text/javascript">
  $(document).ready(function () {
    var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t = $('#toc'),
      h = $('article h2')
    ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o = $('.openaside'),
      c = $('.closeaside');
    if (ai.length > 0) {
      ai.wrap('<div class="video-container" />');
    };
    if (ae.length > 0) {
      ae.wrap('<div class="video-container" />');
    };
    if (ah.length == 0) {
      t.css('display', 'none');
    } else {
      c.click(function () {
        ta.css('display', 'block').addClass('fadeIn');
      });
      o.click(function () {
        ta.css('display', 'none');
      });
      $(window).scroll(function () {
        ta.css("top", Math.max(140, 320 - $(this).scrollTop()));
      });
    };
  });
</script>


<script type="text/javascript">
  $(document).ready(function () {
    var $this = $('.share'),
      //url = $this.attr('data-url'),
      url = window.location.href,
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
    var html = [
      '<a href="#" class="overlay" id="qrcode"></a>',
      '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://mobile.qq.com/qrcode?url=' + encodedUrl + '"/></div>',
      '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
      '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
      '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
      '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
      '<a href="http://service.weibo.com/share/share.php?title=' + title + '&url=' + encodedUrl + '&ralateUid=' + tsina + '&searchPic=true&style=number' + '" class="article-share-weibo" target="_blank" title="Weibo"></a>',
      '<span title="Share to"></span>'
    ].join('');
    $this.append(html);
    viewqrCode();
    $('.article-share-qrcode').click(viewqrCode()
    );

  });
  function viewqrCode() {
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function () {
      $('.qrcode strong').text(' ');
    });
  }
</script>
<script type="text/javascript">  
  //判断是否移动端 
  if (!browser.versions.mobile) {
    $(function () {
      var c, a = $("#rocket-to-top"), e = ($(document).scrollTop(), !0);
      $(window).scroll(function () {
        var b = $(document).scrollTop(); 0 == b ? "0px 0px" == a.css("background-position") ? a.fadeOut("slow") : e && (e = !1, $(".level-2").css("opacity", 1), a.delay(100).animate({ marginTop: "-1000px" }, "normal", function () { a.css({ "margin-top": "-125px", display: "none" }), e = !0 })) : a.fadeIn("slow")
      }), a.hover(function () { $(".level-2").stop(!0).animate({ opacity: 1 }) }, function () { $(".level-2").stop(!0).animate({ opacity: 0 }) }), $(".level-3").click(function () { function b() { var b = a.css("background-position"); if ("none" == a.css("display") || 0 == e) return clearInterval(c), a.css("background-position", "0px 0px"), void 0; switch (b) { case "0px 0px": a.css("background-position", "-298px 0px"); break; case "-298px 0px": a.css("background-position", "-447px 0px"); break; case "-447px 0px": a.css("background-position", "-596px 0px"); break; case "-596px 0px": a.css("background-position", "-745px 0px"); break; case "-745px 0px": a.css("background-position", "-298px 0px") } } e && (c = setInterval(b, 50), $("html,body").animate({ scrollTop: 0 }, "slow")) })
    });
  }
</script>





  </body>
</html>
