<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"syxdevcode.github.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="syxdevcode博客">
<meta property="og:url" content="https://syxdevcode.github.com/page/18/index.html">
<meta property="og:site_name" content="syxdevcode博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="syxdevcode">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://syxdevcode.github.com/page/18/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>syxdevcode博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">syxdevcode博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/syxdevcode" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/03/17/OAuth-2-0%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/17/OAuth-2-0%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">OAuth 2.0学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-17 17:31:35" itemprop="dateCreated datePublished" datetime="2019-03-17T17:31:35+00:00">2019-03-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 01:07:22" itemprop="dateModified" datetime="2021-04-23T01:07:22+00:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OAuth2-0/" itemprop="url" rel="index"><span itemprop="name">OAuth2.0</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="OAuth-2-0学习笔记"><a href="#OAuth-2-0学习笔记" class="headerlink" title="OAuth 2.0学习笔记"></a>OAuth 2.0学习笔记</h1><p><font color=#ff0000 size=4 face="黑体">OAuth的作用就是让”客户端”安全可控地获取”用户”的授权，与”服务商提供商”进行互动。</font></p>
<p>OAuth在”客户端”与”服务提供商”之间，设置了一个授权层（authorization layer）。”客户端”不能直接登录”服务提供商”，只能登录授权层，以此将用户与客户端区分开来。”客户端”登录授权层所用的令牌（token），与用户的密码不同。用户可以在登录的时候，指定授权层令牌的权限范围和有效期。</p>
<p>“客户端”登录授权层以后，”服务提供商”根据令牌的权限范围和有效期，向”客户端”开放用户储存的资料。</p>
<p>Authentication: 证明；鉴定<br>Authorization: 授权，认可；批准，委任</p>
<h2 id="名词定义"><a href="#名词定义" class="headerlink" title="名词定义"></a>名词定义</h2><p><strong>client 或 Third-party application</strong> ：第三方应用程序，又称”客户端”（client）。</p>
<p><strong>HTTP service</strong>：HTTP服务提供商，简称”服务提供商”。</p>
<p><strong>Resource Owner</strong>：资源所有者，又称”用户”（user）。</p>
<p><strong>User Agent</strong>：用户代理，本文中就是指浏览器。</p>
<p><strong>Authorization server</strong>：认证服务器，即服务提供商专门用来处理认证的服务器。</p>
<p><strong>Resource server</strong>：资源服务器，即服务提供商存放用户生成的资源的服务器。它与认证服务器，可以是同一台服务器，也可以是不同的服务器。</p>
<h2 id="运行流程"><a href="#运行流程" class="headerlink" title="运行流程"></a>运行流程</h2><p><img src="/img/bg2014051203.png" alt="bg2014051203.png"></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">（A）用户打开客户端以后，客户端要求用户给予授权。</span><br><span class="line"></span><br><span class="line">（B）用户同意给予客户端授权。</span><br><span class="line"></span><br><span class="line">（C）客户端使用上一步获得的授权，向认证服务器申请令牌。</span><br><span class="line"></span><br><span class="line">（D）认证服务器对客户端进行认证以后，确认无误，同意发放令牌。</span><br><span class="line"></span><br><span class="line">（E）客户端使用令牌，向资源服务器申请获取资源。</span><br><span class="line"></span><br><span class="line">（F）资源服务器确认令牌无误，同意向客户端开放资源。</span><br></pre></td></tr></table></figure>

<p>其中，B阶段，对客户端授权是关键。有了这个授权以后，客户端就可以获取令牌，进而凭令牌获取资源。</p>
<h2 id="获取授权的四种模式"><a href="#获取授权的四种模式" class="headerlink" title="获取授权的四种模式"></a>获取授权的四种模式</h2><p>客户端必须得到用户的授权（authorization grant），才能获得令牌（access token）。OAuth 2.0定义了四种授权方式。</p>
<ul>
<li>授权码模式（authorization code）</li>
<li>简化模式（implicit）</li>
<li>密码模式（resource owner password credentials）</li>
<li>客户端模式（client credentials）</li>
</ul>
<h3 id="授权码模式（authorization-code）"><a href="#授权码模式（authorization-code）" class="headerlink" title="授权码模式（authorization code）"></a>授权码模式（authorization code）</h3><p>授权码模式（authorization code）是功能最完整、流程最严密的授权模式。它的特点就是通过客户端的后台服务器，与”服务提供商”的认证服务器进行互动。例如，微信登录。</p>
<p>注：相关参数使用JSON格式发送（Content-Type: application/json）。此外，HTTP头信息中明确指定不得缓存。</p>
<p><img src="/img/bg2014051204.png" alt="bg2014051204.png"></p>
<p>具体步骤：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">（A）用户访问客户端，后者将前者导向认证服务器。</span><br><span class="line"></span><br><span class="line">（B）用户选择是否给予客户端授权。</span><br><span class="line"></span><br><span class="line">（C）假设用户给予授权，认证服务器将用户导向客户端事先指定的&quot;重定向URI&quot;（redirection URI），</span><br><span class="line">同时附上一个授权码。</span><br><span class="line"></span><br><span class="line">（D）客户端收到授权码，附上早先的&quot;重定向URI&quot;，向认证服务器申请令牌。这一步是在客户端的后台</span><br><span class="line">的服务器上完成的，对用户不可见。</span><br><span class="line"></span><br><span class="line">（E）认证服务器核对了授权码和重定向URI，确认无误后，向客户端发送访问令牌（access token）</span><br><span class="line">和更新令牌（refresh token）。</span><br></pre></td></tr></table></figure>

<p>A步骤中，客户端申请认证的URI，包含以下参数：</p>
<ul>
<li>response_type：表示授权类型，必选项，此处的值固定为”code”</li>
<li>client_id：表示客户端的ID，必选项</li>
<li>redirect_uri：表示重定向URI，可选项</li>
<li>scope：表示申请的权限范围，可选项</li>
<li>state：表示客户端的当前状态，可以指定任意值，认证服务器会原封不动地返回这个值。</li>
</ul>
<p>例子：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /authorize?response_type=code&amp;client_id=s6BhdRkqt3&amp;state=xyz</span><br><span class="line">        &amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1</span><br><span class="line">Host: server.example.com</span><br></pre></td></tr></table></figure>

<p>B步骤中，用户动作选择是否给客户端授权，例如微信扫码之后确认登录动作等。</p>
<p>C步骤中，服务器回应客户端的URI，包含以下参数：</p>
<ul>
<li>code：表示授权码，必选项。该码的有效期应该很短，通常设为10分钟，客户端只能使用该码一次，否则会被授权服务器拒绝。该码与客户端ID和重定向URI，是一一对应关系。</li>
<li>state：如果客户端的请求中包含这个参数，认证服务器的回应也必须一模一样包含这个参数。</li>
</ul>
<p>例子：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 302 Found</span><br><span class="line">Location: https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA</span><br><span class="line">          &amp;state=xyz</span><br></pre></td></tr></table></figure>

<p>D步骤中，客户端向认证服务器申请令牌的HTTP请求，包含以下参数：</p>
<ul>
<li>grant_type：表示使用的授权模式，必选项，此处的值固定为”authorization_code”。</li>
<li>code：表示上一步获得的授权码，必选项。</li>
<li>redirect_uri：表示重定向URI，必选项，且必须与A步骤中的该参数值保持一致。</li>
<li>client_id：表示客户端ID，必选项。</li>
</ul>
<p>例子：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /token HTTP/1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">grant_type=authorization_code&amp;code=SplxlOBeZQQYbYS6WxSbIA</span><br><span class="line">&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb</span><br></pre></td></tr></table></figure>

<p>E步骤中，认证服务器发送的HTTP回复，包含以下参数：</p>
<ul>
<li>access_token：表示访问令牌，必选项。</li>
<li>token_type：表示令牌类型，该值大小写不敏感，必选项，可以是bearer类型或mac类型。</li>
<li>expires_in：表示过期时间，单位为秒。如果省略该参数，必须其他方式设置过期时间。</li>
<li>refresh_token：表示更新令牌，用来获取下一次的访问令牌，可选项。</li>
<li>scope：表示权限范围，如果与客户端申请的范围一致，此项可省略。</li>
</ul>
<p>例子：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json;charset=UTF-8</span><br><span class="line">Cache-Control: no-store</span><br><span class="line">Pragma: no-cache</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;,</span><br><span class="line">  &quot;token_type&quot;:&quot;example&quot;,</span><br><span class="line">  &quot;expires_in&quot;:3600,</span><br><span class="line">  &quot;refresh_token&quot;:&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;,</span><br><span class="line">  &quot;example_parameter&quot;:&quot;example_value&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="简化模式"><a href="#简化模式" class="headerlink" title="简化模式"></a>简化模式</h3><p>简化模式（implicit grant type）不通过第三方应用程序的服务器，直接在浏览器中向认证服务器申请令牌，跳过了”授权码”这个步骤，因此得名。所有步骤在浏览器中完成，令牌对访问者是可见的，且客户端不需要认证。</p>
<p><img src="/img/bg2014051205.png" alt="bg2014051205.png"></p>
<p>运行流程如下：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">（A）客户端将用户导向认证服务器。</span><br><span class="line"></span><br><span class="line">（B）用户决定是否给于客户端授权。</span><br><span class="line"></span><br><span class="line">（C）假设用户给予授权，认证服务器将用户导向客户端指定的&quot;重定向URI&quot;，</span><br><span class="line">     并在URI的Hash部分包含了访问令牌。</span><br><span class="line"></span><br><span class="line">（D）浏览器向资源服务器发出请求，其中不包括上一步收到的Hash值。</span><br><span class="line"></span><br><span class="line">（E）资源服务器返回一个网页，其中包含的代码可以获取Hash值中的令牌。</span><br><span class="line"></span><br><span class="line">（F）浏览器执行上一步获得的脚本，提取出令牌。</span><br><span class="line"></span><br><span class="line">（G）浏览器将令牌发给客户端。</span><br></pre></td></tr></table></figure>

<p>A步骤中，客户端发出的HTTP请求，包含以下参数：</p>
<ul>
<li>response_type：表示授权类型，此处的值固定为”token”，必选项。</li>
<li>client_id：表示客户端的ID，必选项。</li>
<li>redirect_uri：表示重定向的URI，可选项。</li>
<li>scope：表示权限范围，可选项。</li>
<li>state：表示客户端的当前状态，可以指定任意值，认证服务器会原封不动地返回这个值。</li>
</ul>
<p>例子：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /authorize?response_type=token&amp;client_id=s6BhdRkqt3&amp;state=xyz</span><br><span class="line">    &amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1</span><br><span class="line">Host: server.example.com</span><br></pre></td></tr></table></figure>

<p>C步骤中，认证服务器回应客户端的URI，包含以下参数：</p>
<ul>
<li>access_token：表示访问令牌，必选项。</li>
<li>token_type：表示令牌类型，该值大小写不敏感，必选项。</li>
<li>expires_in：表示过期时间，单位为秒。如果省略该参数，必须其他方式设置过期时间。</li>
<li>scope：表示权限范围，如果与客户端申请的范围一致，此项可省略。</li>
<li>state：如果客户端的请求中包含这个参数，认证服务器的回应也必须一模一样包含这个参数。</li>
</ul>
<p>例子：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 302 Found</span><br><span class="line">Location: http://example.com/cb#access_token=2YotnFZFEjr1zCsicMWpAA</span><br><span class="line">          &amp;state=xyz&amp;token_type=example&amp;expires_in=3600</span><br></pre></td></tr></table></figure>

<p>在上面的例子中，认证服务器用HTTP头信息的Location栏，指定浏览器重定向的网址。注意，在这个网址的Hash部分包含了令牌。</p>
<p>根据上面的D步骤，下一步浏览器会访问Location指定的网址，但是Hash部分不会发送。接下来的E步骤，服务提供商的资源服务器发送过来的代码，会提取出Hash中的令牌。</p>
<h3 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h3><p>密码模式（Resource Owner Password Credentials Grant）中，用户向客户端提供自己的用户名和密码。客户端使用这些信息，向”服务商提供商”索要授权。</p>
<p>在这种模式中，用户必须把自己的密码给客户端，但是客户端不得储存密码。这通常用在用户对客户端高度信任的情况下，比如客户端是操作系统的一部分，或者由一个著名公司出品。而认证服务器只有在其他授权模式无法执行的情况下，才能考虑使用这种模式。</p>
<p><img src="/img/bg2014051206.png" alt="bg2014051206.png"></p>
<p>具体步骤：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（A）用户向客户端提供用户名和密码。</span><br><span class="line"></span><br><span class="line">（B）客户端将用户名和密码发给认证服务器，向后者请求令牌。</span><br><span class="line"></span><br><span class="line">（C）认证服务器确认无误后，向客户端提供访问令牌。</span><br></pre></td></tr></table></figure>

<p>B步骤中，客户端发出的HTTP请求，包含以下参数：</p>
<ul>
<li>grant_type：表示授权类型，此处的值固定为”password”，必选项。</li>
<li>username：表示用户名，必选项。</li>
<li>password：表示用户的密码，必选项。</li>
<li>scope：表示权限范围，可选项。</li>
</ul>
<p>例子：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /token HTTP/1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">grant_type=password&amp;username=johndoe&amp;password=A3ddj3w</span><br></pre></td></tr></table></figure>

<p>C步骤中，认证服务器向客户端发送访问令牌。如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json;charset=UTF-8</span><br><span class="line">Cache-Control: no-store</span><br><span class="line">Pragma: no-cache</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;,</span><br><span class="line">  &quot;token_type&quot;:&quot;example&quot;,</span><br><span class="line">  &quot;expires_in&quot;:3600,</span><br><span class="line">  &quot;refresh_token&quot;:&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;,</span><br><span class="line">  &quot;example_parameter&quot;:&quot;example_value&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个过程中，客户端不得保存用户的密码。</p>
<h3 id="客户端模式"><a href="#客户端模式" class="headerlink" title="客户端模式"></a>客户端模式</h3><p>客户端模式（Client Credentials Grant）指客户端以自己的名义，而不是以用户的名义，向”服务提供商”进行认证。严格地说，客户端模式并不属于OAuth框架所要解决的问题。在这种模式中，用户直接向客户端注册，客户端以自己的名义要求”服务提供商”提供服务，其实不存在授权问题。</p>
<p><img src="/img/bg2014051207.png" alt="bg2014051207.png"></p>
<p>具体步骤：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">（A）客户端向认证服务器进行身份认证，并要求一个访问令牌。</span><br><span class="line"></span><br><span class="line">（B）认证服务器确认无误后，向客户端提供访问令牌。</span><br></pre></td></tr></table></figure>

<p>A步骤中，客户端发出的HTTP请求，包含以下参数：</p>
<p>granttype：表示授权类型，此处的值固定为”clientcredentials”，必选项。<br>scope：表示权限范围，可选项。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /token HTTP/1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">grant_type=client_credentials</span><br></pre></td></tr></table></figure>

<p>认证服务器必须以某种方式，验证客户端身份。</p>
<p>B步骤中，认证服务器向客户端发送访问令牌，下面是一个例子。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json;charset=UTF-8</span><br><span class="line">Cache-Control: no-store</span><br><span class="line">Pragma: no-cache</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;,</span><br><span class="line">  &quot;token_type&quot;:&quot;example&quot;,</span><br><span class="line">  &quot;expires_in&quot;:3600,</span><br><span class="line">  &quot;example_parameter&quot;:&quot;example_value&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="更新令牌"><a href="#更新令牌" class="headerlink" title="更新令牌"></a>更新令牌</h2><p>如果用户访问的时候，客户端的”访问令牌”已经过期，则需要使用”更新令牌”申请一个新的访问令牌。</p>
<p>客户端发出更新令牌的HTTP请求，包含以下参数：</p>
<ul>
<li>granttype：表示使用的授权模式，此处的值固定为”refreshtoken”，必选项。</li>
<li>refresh_token：表示早前收到的更新令牌，必选项。</li>
<li>scope：表示申请的授权范围，不可以超出上一次申请的范围，如果省略该参数，则表示与上一次一致。</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /token HTTP/1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">grant_type=refresh_token&amp;refresh_token=tGzv3JOkF0XG5Qx2TlKWIA</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html">理解OAuth 2.0</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/xishuai/p/identityserver4-implement-openid-connect-and-oauth2.html">IdentityServer4 实现 OpenID Connect 和 OAuth 2.0</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/03/16/Sql-Server%E5%9F%BA%E7%A1%80%E4%B9%8BGrouping%E7%94%A8%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/16/Sql-Server%E5%9F%BA%E7%A1%80%E4%B9%8BGrouping%E7%94%A8%E6%B3%95/" class="post-title-link" itemprop="url">Sql-Server基础之Grouping用法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-16 14:51:00" itemprop="dateCreated datePublished" datetime="2019-03-16T14:51:00+00:00">2019-03-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 01:07:22" itemprop="dateModified" datetime="2021-04-23T01:07:22+00:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Sql/" itemprop="url" rel="index"><span itemprop="name">Sql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Sql-Server基础之Grouping用法"><a href="#Sql-Server基础之Grouping用法" class="headerlink" title="Sql-Server基础之Grouping用法"></a>Sql-Server基础之Grouping用法</h1><p><code>GROUPING</code> 是一个聚合函数，用在含有 <code>CUBE</code> 或 <code>ROLLUP</code> 语句的SQL语句中，当结果集中的数据行是由 <code>CUBE</code> 或 <code>ROLLUP</code> 运算产生的（添加的）则该函数返回1，否则返回0。</p>
<p>语法： <code>GROUPING(column_name)</code></p>
<p>其中 <code>column_name</code> 是用在 <code>CUBE</code> 或 <code>ROLLUP</code> 运算的列 或 <code>group by</code> 后的列。</p>
<p>注意：</p>
<ul>
<li>（1）只有使用了 <code>CUBE</code> 或 <code>ROLLUP</code> 运算符的SQL中才能使用 <code>GROUPING</code></li>
<li>（2）<code>GROUPING</code> 后面的列 名可以是 <code>CUBE</code> 或 <code>ROLLUP</code> 运算符中使用的列名，也可以是 <code>group by</code> 中的列名</li>
</ul>
<p>CUBE 生成的结果集显示了所选列中值的所有组合的聚合。<br>ROLLUP 生成的结果集显示了所选列中值的某一层次结构的聚合。</p>
<p>** CUBE**</p>
<p><code>CUBE</code> 生成的结果集显示了所选列中值的所有组合的聚合。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CourseID,StudentID,<span class="built_in">SUM</span>(Score) <span class="keyword">FROM</span> [dbo].[Score] </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> CourseID,StudentID <span class="keyword">WITH</span> <span class="keyword">CUBE</span></span><br></pre></td></tr></table></figure>

<p>结果：<br><img src="/img/QQ%E6%88%AA%E5%9B%BE20190316155035.png" alt="QQ截图20190316155035.png"></p>
<p>** ROLLUP**</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> StudentID,CourseID,<span class="built_in">SUM</span>(Score)  <span class="keyword">FROM</span> [dbo].[Score] </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> StudentID,CourseID <span class="keyword">WITH</span> <span class="keyword">ROLLUP</span></span><br></pre></td></tr></table></figure>

<p>结果：<br><img src="/img/QQ%E6%88%AA%E5%9B%BE20190316160822.png" alt="QQ截图20190316160822.png"></p>
<p>** GROUPING**</p>
<p>获取每个学生成绩的总和。以下示例结果相同</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> StudentID,CourseID,<span class="built_in">SUM</span>(Score),<span class="keyword">grouping</span>(CourseID) <span class="keyword">FROM</span> [dbo].[Score] </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> StudentID,CourseID <span class="keyword">WITH</span> <span class="keyword">CUBE</span> <span class="keyword">HAVING</span> <span class="keyword">grouping</span>(CourseID)<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>结果：<br><img src="/img/QQ%E6%88%AA%E5%9B%BE20190316161849.png" alt="QQ截图20190316161849.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> StudentID,CourseID,<span class="built_in">SUM</span>(Score),<span class="keyword">grouping</span>(CourseID)  <span class="keyword">FROM</span> [dbo].[Score] </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> StudentID,CourseID <span class="keyword">WITH</span> <span class="keyword">ROLLUP</span> <span class="keyword">HAVING</span> <span class="keyword">grouping</span>(CourseID)<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>结果：<br><img src="/img/QQ%E6%88%AA%E5%9B%BE20190316162226.png" alt="QQ截图20190316162226.png"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/shuangnet/archive/2013/03/26/2982144.html">Sql学习第四天——SQL 关于with cube ，with rollup 和 grouping</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dyufei/archive/2009/11/12/2573973.html">GROUPING 用法</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/03/15/SQL-Server%E8%BF%9E%E6%8E%A5%EF%BC%88%E5%86%85%E8%BF%9E%E6%8E%A5%E3%80%81%E5%A4%96%E8%BF%9E%E6%8E%A5%E3%80%81%E4%BA%A4%E5%8F%89%E8%BF%9E%E6%8E%A5%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/15/SQL-Server%E8%BF%9E%E6%8E%A5%EF%BC%88%E5%86%85%E8%BF%9E%E6%8E%A5%E3%80%81%E5%A4%96%E8%BF%9E%E6%8E%A5%E3%80%81%E4%BA%A4%E5%8F%89%E8%BF%9E%E6%8E%A5%EF%BC%89/" class="post-title-link" itemprop="url">SQL Server连接（内连接、外连接、交叉连接）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-15 08:25:19" itemprop="dateCreated datePublished" datetime="2019-03-15T08:25:19+00:00">2019-03-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 01:07:22" itemprop="dateModified" datetime="2021-04-23T01:07:22+00:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Sql/" itemprop="url" rel="index"><span itemprop="name">Sql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>SQL Server连接（内连接、外连接、交叉连接）</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/03/15/SQL-Server%E8%BF%9E%E6%8E%A5%EF%BC%88%E5%86%85%E8%BF%9E%E6%8E%A5%E3%80%81%E5%A4%96%E8%BF%9E%E6%8E%A5%E3%80%81%E4%BA%A4%E5%8F%89%E8%BF%9E%E6%8E%A5%EF%BC%89/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/03/14/Sql-Server%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%B8%B8%E7%94%A8sql%E5%AE%9E%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/14/Sql-Server%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%B8%B8%E7%94%A8sql%E5%AE%9E%E4%BE%8B/" class="post-title-link" itemprop="url">Sql-Server基础之常用sql实例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-14 16:03:28" itemprop="dateCreated datePublished" datetime="2019-03-14T16:03:28+00:00">2019-03-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 01:07:22" itemprop="dateModified" datetime="2021-04-23T01:07:22+00:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Sql/" itemprop="url" rel="index"><span itemprop="name">Sql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Sql-Server常用sql实例总结</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/03/14/Sql-Server%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%B8%B8%E7%94%A8sql%E5%AE%9E%E4%BE%8B/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/03/14/Sql-Server%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%88%86%E9%A1%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/14/Sql-Server%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%88%86%E9%A1%B5/" class="post-title-link" itemprop="url">Sql-Server基础之分页</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-14 10:41:55" itemprop="dateCreated datePublished" datetime="2019-03-14T10:41:55+00:00">2019-03-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 01:07:22" itemprop="dateModified" datetime="2021-04-23T01:07:22+00:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Sql/" itemprop="url" rel="index"><span itemprop="name">Sql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Sql-Server分页方法总结</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/03/14/Sql-Server%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%88%86%E9%A1%B5/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/03/14/Sql-Server%E5%9F%BA%E7%A1%80%E4%B9%8BSql%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/14/Sql-Server%E5%9F%BA%E7%A1%80%E4%B9%8BSql%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/" class="post-title-link" itemprop="url">Sql Server基础之Sql基础语法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-14 08:45:54" itemprop="dateCreated datePublished" datetime="2019-03-14T08:45:54+00:00">2019-03-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 01:07:22" itemprop="dateModified" datetime="2021-04-23T01:07:22+00:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Sql/" itemprop="url" rel="index"><span itemprop="name">Sql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Sql-Server基础之Sql基础语法"><a href="#Sql-Server基础之Sql基础语法" class="headerlink" title="Sql Server基础之Sql基础语法"></a>Sql Server基础之Sql基础语法</h1><p><font color=#ff0000 size=4 face="黑体">Sql： Structured Query Language</font></p>
<p>** Sql server的组成**</p>
<ul>
<li>主要数据库文件：.mdf 特点：有且只有一个</li>
<li>次要数据库文件：.ndf 特点：任意个</li>
<li>日志数据库文件：.ldf 特点：至少一个</li>
</ul>
<p>** 操作数据库**</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">创建数据库：<span class="keyword">create</span> databse 库名</span><br><span class="line">查看所有数据库：<span class="keyword">exec</span> sp_helpdb</span><br><span class="line">查看当前数据库：<span class="keyword">exec</span> sp_helpdb 库名</span><br><span class="line">使用数据库：use 库名</span><br><span class="line">删除数据库：<span class="keyword">drop</span> database 库名 ps:正在使用的数据库无法删除</span><br></pre></td></tr></table></figure>

<h2 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h2><h3 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [Student] (</span><br><span class="line">  [ID] <span class="type">INTEGER</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY AUTOINCREMENT,</span><br><span class="line">  [Name] NVARCHAR(<span class="number">20</span>),</span><br><span class="line">  [Age] <span class="type">INT</span>,</span><br><span class="line">  [Sex] <span class="type">INT</span>);</span><br></pre></td></tr></table></figure>

<h3 id="查看所有表"><a href="#查看所有表" class="headerlink" title="查看所有表"></a>查看所有表</h3><p><code>exec sp_help</code></p>
<h3 id="查看当前表"><a href="#查看当前表" class="headerlink" title="查看当前表"></a>查看当前表</h3><p><code>exec sp_help 表名</code></p>
<h3 id="修改表结构"><a href="#修改表结构" class="headerlink" title="修改表结构"></a>修改表结构</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1,增加一列语法</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">add</span> 字段名 数据类型</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2,修改一列语法</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">alter</span> <span class="keyword">column</span> 字段名 数据类型</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3,删除一列语法</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">drop</span> <span class="keyword">column</span> 字段名</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4,删除表语法</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> 表名</span><br></pre></td></tr></table></figure>

<h3 id="操作表数据"><a href="#操作表数据" class="headerlink" title="操作表数据"></a>操作表数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1,完全插入数据</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名 (字段名<span class="number">1</span>,字段名<span class="number">2.</span>..) <span class="keyword">values</span>(值<span class="number">1</span>,值<span class="number">2.</span>..)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2,省略插入数据</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名 <span class="keyword">values</span>(值<span class="number">1</span>,值<span class="number">2.</span>..)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3，多行插入</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名 <span class="keyword">values</span>(值<span class="number">1</span>,值<span class="number">2.</span>..),(值<span class="number">1</span>,值<span class="number">2.</span>..)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4，查看所有记录</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 表名</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 5，修改记录</span></span><br><span class="line">update 表名 <span class="keyword">set</span> 字段名<span class="operator">=</span>值 [<span class="keyword">where</span>条件]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 6，删除一条记录</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> 表名 <span class="keyword">where</span> 条件</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 7，清空表所有记录</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> 表名</span><br></pre></td></tr></table></figure>

<h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><p>and , or ,not</p>
<h2 id="sql-查询"><a href="#sql-查询" class="headerlink" title="sql 查询"></a>sql 查询</h2><ul>
<li><p>1，符合条件语法</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> 字段名 <span class="keyword">from</span> 表名 [<span class="keyword">where</span> 条件]</span><br></pre></td></tr></table></figure>
</li>
<li><p>2，…到…之间</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> ... <span class="keyword">or</span></span><br><span class="line"><span class="keyword">between</span> ... <span class="keyword">and</span></span><br><span class="line"><span class="comment">--例句：查询23岁到25岁之间的学生</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> age<span class="operator">&gt;=</span><span class="number">23</span> <span class="keyword">and</span> age<span class="operator">&lt;=</span><span class="number">25</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> age <span class="keyword">between</span> <span class="number">23</span> <span class="keyword">and</span> <span class="number">25</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>3，去重</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> 字段名 <span class="keyword">from</span> 表名</span><br></pre></td></tr></table></figure>
</li>
<li><p>4,排序</p>
<p>  语法： order by + 字段名 asc升序（默认） desc降序</p>
</li>
<li><p>5，列别名 as</p>
</li>
<li><p>6，模糊查询 like</p>
</li>
<li><p>7, 联合查询 join</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1,交叉查询</span></span><br><span class="line"><span class="keyword">select</span> 字段名 <span class="keyword">from</span> 表<span class="number">1</span> <span class="keyword">cross</span> <span class="keyword">join</span> 表<span class="number">2</span> [<span class="keyword">where</span> 条件]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2,内连接查询</span></span><br><span class="line"><span class="keyword">select</span> 字段名 <span class="keyword">from</span> 表<span class="number">1</span> <span class="keyword">inner</span> <span class="keyword">join</span> 表<span class="number">2</span> <span class="keyword">on</span> 联合条件 [<span class="keyword">where</span> 条件]</span><br><span class="line"></span><br><span class="line"><span class="comment">--外连接</span></span><br><span class="line"><span class="comment">-- 3,左外连接</span></span><br><span class="line"><span class="keyword">select</span> 字段名 <span class="keyword">from</span> 表<span class="number">1</span> <span class="keyword">left</span> <span class="keyword">join</span> 表<span class="number">2</span> <span class="keyword">on</span> 联合条件 [<span class="keyword">where</span> 条件]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4，右外连接</span></span><br><span class="line"><span class="keyword">select</span> 字段名 <span class="keyword">from</span> 表<span class="number">1</span> <span class="keyword">right</span> <span class="keyword">join</span> 表<span class="number">2</span> <span class="keyword">on</span> 联合条件 [<span class="keyword">where</span> 条件]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 5，全外连接</span></span><br><span class="line"><span class="keyword">select</span> 字段名 <span class="keyword">from</span> 表<span class="number">1</span> <span class="keyword">full</span> <span class="keyword">join</span> 表<span class="number">2</span> <span class="keyword">on</span> 联合条件 [<span class="keyword">where</span> 条件]</span><br></pre></td></tr></table></figure>
</li>
<li><p>8,嵌套查询</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">in</span>() 在...范围之内的</span><br><span class="line"><span class="keyword">not</span> <span class="keyword">in</span>() 不在...范围之内的</span><br><span class="line"><span class="keyword">exists</span> 存在</span><br><span class="line"><span class="keyword">not</span> <span class="keyword">exists</span> 不存在</span><br></pre></td></tr></table></figure>
</li>
<li><p>9,分组 group by</p>
</li>
</ul>
<h2 id="系统函数"><a href="#系统函数" class="headerlink" title="系统函数"></a>系统函数</h2><h3 id="1，统计-聚合-函数"><a href="#1，统计-聚合-函数" class="headerlink" title="1，统计(聚合)函数"></a>1，统计(聚合)函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1,AVG 返回指定组中的平均值，空值被忽略。</span></span><br><span class="line"><span class="keyword">select</span> prd_no,<span class="built_in">avg</span>(qty) <span class="keyword">from</span> sales <span class="keyword">group</span> <span class="keyword">by</span> prd_no</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2,COUNT 返回指定组中项目的数量</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(prd_no) <span class="keyword">from</span> sales</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3, MAX 返回指定数据的最大值。</span></span><br><span class="line"><span class="keyword">select</span> prd_no,<span class="built_in">max</span>(qty) <span class="keyword">from</span> sales <span class="keyword">group</span> <span class="keyword">by</span> prd_no</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4,MIN 返回指定数据的最小值。</span></span><br><span class="line"><span class="keyword">select</span> prd_no,<span class="built_in">min</span>(qty) <span class="keyword">from</span> sales <span class="keyword">group</span> <span class="keyword">by</span> prd_no</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 5,SUM 返回指定数据的和，只能用于数字列，空值被忽略。</span></span><br><span class="line"><span class="keyword">select</span> prd_no,<span class="built_in">sum</span>(qty) <span class="keyword">from</span> sales <span class="keyword">group</span> <span class="keyword">by</span> prd_no</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 6,COUNT_BIG 返回指定组中的项目数量，</span></span><br><span class="line"><span class="comment">-- 与COUNT函数不同的是COUNT_BIG返回bigint值，而COUNT返回的是int值。</span></span><br><span class="line"><span class="keyword">select</span> count_big(prd_no) <span class="keyword">from</span> sales</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 7,GROUPING 产生一个附加的列，当用CUBE或ROLLUP运算符添加行时，</span></span><br><span class="line"><span class="comment">-- 输出值为1.当所添加的行不是由CUBE或ROLLUP产生时，输出值为0.</span></span><br><span class="line"><span class="keyword">select</span> prd_no,<span class="built_in">sum</span>(qty),<span class="keyword">grouping</span>(prd_no) <span class="keyword">from</span> sales <span class="keyword">group</span> <span class="keyword">by</span> prd_no <span class="keyword">with</span> <span class="keyword">rollup</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 8, BINARY_CHECKSUM 返回对表中的行或表达式列表计算的二进制校验值，用于检测表中行的更改。</span></span><br><span class="line"><span class="keyword">select</span> prd_no,binary_checksum(qty) <span class="keyword">from</span> sales <span class="keyword">group</span> <span class="keyword">by</span> prd_no</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 9,CHECKSUM_AGG 返回指定数据的校验值，空值被忽略。</span></span><br><span class="line"><span class="keyword">select</span> prd_no,checksum_agg(binary_checksum(<span class="operator">*</span>)) <span class="keyword">from</span> sales <span class="keyword">group</span> <span class="keyword">by</span> prd_no</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 10,CHECKSUM 返回在表的行上或在表达式列表上计算的校验值，用于生成哈希索引。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 11,STDEV 返回给定表达式中所有值的统计标准偏差。</span></span><br><span class="line"><span class="keyword">select</span> stdev(prd_no) <span class="keyword">from</span> sales</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 12,STDEVP 返回给定表达式中的所有值的填充统计标准偏差。</span></span><br><span class="line"><span class="keyword">select</span> stdevp(prd_no) <span class="keyword">from</span> sales</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 13, VAR 返回给定表达式中所有值的统计方差。</span></span><br><span class="line"><span class="keyword">select</span> var(prd_no) <span class="keyword">from</span> sales</span><br><span class="line"></span><br><span class="line"><span class="comment">--14,VARP 返回给定表达式中所有值的填充的统计方差。</span></span><br><span class="line"><span class="keyword">select</span> varp(prd_no) <span class="keyword">from</span> sales</span><br></pre></td></tr></table></figure>

<h3 id="2-日期函数"><a href="#2-日期函数" class="headerlink" title="2,日期函数"></a>2,日期函数</h3><ul>
<li><p>1， getDate()：获取当前时间</p>
</li>
<li><p>2，Dateadd()：增加时间</p>
</li>
<li><p>3，datediff(datepart,startdate,enddate)</p>
<p>  参考：<a target="_blank" rel="noopener" href="http://www.w3school.com.cn/sql/func_datediff.asp">SQL Server DATEDIFF() 函数</a></p>
<p>  SELECT DATEDIFF(day,’2008-12-29’,’2008-12-30’) AS DiffDate<br>  输出：1</p>
<p>  startdate 和 enddate 参数是合法的日期表达式。<br>  datepart 参数可以是下列的值：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">date</span> part <span class="operator">|</span>缩写</span><br><span class="line">年:yy, yyyy</span><br><span class="line">季度:qq, q</span><br><span class="line">月:mm, m</span><br><span class="line">年中的日:dy, y</span><br><span class="line">日:dd, d</span><br><span class="line">周:wk, ww</span><br><span class="line">星期:dw, w</span><br><span class="line">小时:hh</span><br><span class="line">分钟:mi, n</span><br><span class="line">秒:ss, s</span><br><span class="line">毫秒:ms</span><br><span class="line">微妙:mcs</span><br><span class="line">纳秒：ns</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="3，数学函数"><a href="#3，数学函数" class="headerlink" title="3，数学函数"></a>3，数学函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">abs</span>()：取绝对值</span><br><span class="line">round()：四舍五入</span><br><span class="line"><span class="built_in">floor</span>()：函数返回小于或等于所给数字表达式的最大整数</span><br><span class="line"><span class="built_in">ceiling</span>()：函数返回大于或等于所给数字表达式的最小整数</span><br><span class="line"><span class="built_in">sqrt</span>()：开平方根</span><br></pre></td></tr></table></figure>

<h3 id="4，字符串函数"><a href="#4，字符串函数" class="headerlink" title="4，字符串函数"></a>4，字符串函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">left</span>()：左截串</span><br><span class="line"><span class="keyword">right</span>()：右截串</span><br><span class="line">ltrim()：去左空格</span><br><span class="line">rtrim()：去右空格</span><br><span class="line">replace：(字符串,旧字符串,新字符串) 替换</span><br><span class="line">substring：(字符串,位置,长度) 截字符串 ps:<span class="keyword">sql</span>中字符串下标从<span class="number">1</span>开始</span><br><span class="line">reverse()：反转</span><br><span class="line">len()：长度</span><br><span class="line"><span class="built_in">upper</span>()：转大写</span><br><span class="line"><span class="built_in">lower</span>()：转小写</span><br></pre></td></tr></table></figure>

<h2 id="T-Sql"><a href="#T-Sql" class="headerlink" title="T-Sql"></a>T-Sql</h2><p>** 声明变量语法： **</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> @变量名 数据类型</span><br><span class="line"><span class="keyword">set</span> @变量名<span class="operator">=</span>值</span><br><span class="line"><span class="keyword">select</span> @变量名<span class="operator">=</span>值</span><br></pre></td></tr></table></figure>

<p>** 编程语句:**</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">begin...end</span><br><span class="line">if...else</span><br></pre></td></tr></table></figure>

<h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><ul>
<li><p>1.创建视图</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> 视图名称</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">sql</span>中查询语句</span><br></pre></td></tr></table></figure>
</li>
<li><p>2.使用视图 select * from 视图名</p>
</li>
<li><p>3.查看视图 exec sp_help</p>
</li>
<li><p>4.查看视图内容 exec sp_helptext 视图名</p>
</li>
<li><p>5.修改视图 alter view 视图名 as select * from 表名 [where条件]</p>
</li>
<li><p>6.删除视图 drop view 视图名</p>
</li>
<li><p>7.修改视图 update 视图名 set 字段名=值 [where条件]</p>
</li>
</ul>
<h2 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> proc <span class="operator">|</span> <span class="keyword">procedure</span> pro_name</span><br><span class="line">    [&#123;@参数数据类型&#125; [=默认值] [output],</span><br><span class="line">     &#123;@参数数据类型&#125; [=默认值] [output],</span><br><span class="line">     ....</span><br><span class="line">    ]</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line">        <span class="keyword">select</span> .....</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/toutou/p/4733670.html">sql server 基础教程[温故而知新三]</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/anding/p/5281558.html">.NET面试题解析(11)-SQL语言基础及数据库基本原理</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/03/06/%E5%B9%B6%E8%A1%8C%E5%BC%80%E5%8F%91%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/06/%E5%B9%B6%E8%A1%8C%E5%BC%80%E5%8F%91%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">并行开发之信号量简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-06 11:28:12" itemprop="dateCreated datePublished" datetime="2019-03-06T11:28:12+00:00">2019-03-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 01:07:22" itemprop="dateModified" datetime="2021-04-23T01:07:22+00:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/net%E5%BC%82%E6%AD%A5%E4%B8%8E%E5%B9%B6%E8%A1%8C/" itemprop="url" rel="index"><span itemprop="name">.net异步与并行</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>轻量级信号量：</p>
<p>CountdownEvent，SemaphoreSlim，ManualResetEventSlim</p>
<h2 id="CountdownEvent"><a href="#CountdownEvent" class="headerlink" title="CountdownEvent"></a>CountdownEvent</h2><p>采用信号计数的方式，即定义了最多能够进入关键代码的线程数。并且可以动态改变“信号计数”的大小。</p>
<p>官方示例请参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.threading.countdownevent?view=netframework-4.7.2">CountdownEvent</a></p>
<p>示例代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp4</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//默认的容纳大小为“硬件线程“数</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> CountdownEvent cde = <span class="keyword">new</span> CountdownEvent(Environment.ProcessorCount);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="built_in">int</span> userTaskCount = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//重置信号</span></span><br><span class="line">            cde.Reset(userTaskCount);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; userTaskCount; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Task.Factory.StartNew(LoadUser, i);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//等待所有任务执行完毕</span></span><br><span class="line">            cde.Wait();</span><br><span class="line">            Console.WriteLine(<span class="string">&quot; InitialCount=&#123;0&#125;, CurrentCount=&#123;1&#125;, IsSet=&#123;2&#125;&quot;</span>,</span><br><span class="line">                cde.InitialCount, cde.CurrentCount, cde.IsSet);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;\nUser表数据全部加载完毕！\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//加载product需要8个任务</span></span><br><span class="line">            <span class="keyword">var</span> productTaskCount = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">            cde.Reset(productTaskCount);</span><br><span class="line">            cde.AddCount(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;After Reset(8), AddCount(2): InitialCount=&#123;0&#125;, CurrentCount=&#123;1&#125;, IsSet=&#123;2&#125;&quot;</span>,</span><br><span class="line">                cde.InitialCount, cde.CurrentCount, cde.IsSet);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; cde.CurrentCount; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Task.Factory.StartNew(LoadProduct, i);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//等待所有任务执行完毕</span></span><br><span class="line">            cde.Wait();</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;\nProduct表数据全部加载完毕！\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Now try waiting with cancellation</span></span><br><span class="line">            CancellationTokenSource cts = <span class="keyword">new</span> CancellationTokenSource();</span><br><span class="line">            cts.Cancel(); <span class="comment">// cancels the CancellationTokenSource</span></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                cde.Wait(cts.Token);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (OperationCanceledException)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;cde.Wait(preCanceledToken) threw OCE, as expected&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                cts.Dispose();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// It&#x27;s good to release a CountdownEvent when you&#x27;re done with it.</span></span><br><span class="line">            cde.Dispose();</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LoadUser</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;当前任务:&#123;0&#125;正在加载User部分数据！&quot;</span>, obj);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                cde.Signal();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LoadProduct</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;当前任务:&#123;0&#125;正在加载Product部分数据！&quot;</span>, obj);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                cde.Signal();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SemaphoreSlim"><a href="#SemaphoreSlim" class="headerlink" title="SemaphoreSlim"></a>SemaphoreSlim</h2><p>对可同时访问资源或资源池的线程数加以限制</p>
<p>官方示例参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.threading.semaphoreslim?view=netframework-4.7.2">SemaphoreSlim</a></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp4</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> SemaphoreSlim semaphore;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// A padding interval to make the output more orderly.</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> padding;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Create the semaphore.</span></span><br><span class="line">            semaphore = <span class="keyword">new</span> SemaphoreSlim(<span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;&#123;0&#125; tasks can enter the semaphore.&quot;</span>,</span><br><span class="line">                semaphore.CurrentCount);</span><br><span class="line">            Task[] tasks = <span class="keyword">new</span> Task[<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create and start five numbered tasks.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">4</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                tasks[i] = Task.Run(() =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// Each task begins by requesting the semaphore.</span></span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;Task &#123;0&#125; begins and waits for the semaphore.&quot;</span>,</span><br><span class="line">                        Task.CurrentId);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 信号量： semaphore.Wait()和semaphore.Release()方法范围</span></span><br><span class="line">                    semaphore.Wait();</span><br><span class="line"></span><br><span class="line">                    Interlocked.Add(<span class="keyword">ref</span> padding, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;DateTime:&#123;0&#125;,Task &#123;1&#125; enters the semaphore.&quot;</span>, DateTime.Now, Task.CurrentId);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// The task just sleeps for 1+ seconds.</span></span><br><span class="line">                    Thread.Sleep(<span class="number">1000</span> + padding);</span><br><span class="line">                    <span class="built_in">int</span> id = semaphore.Release();</span><br><span class="line"></span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;Task &#123;0&#125; releases the semaphore; previous count: &#123;1&#125;&quot;</span>,</span><br><span class="line">                        Task.CurrentId, id);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Wait for half a second, to allow all the tasks to start and block.</span></span><br><span class="line">            Thread.Sleep(<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Restore the semaphore count to its maximum value.</span></span><br><span class="line">            Console.Write(<span class="string">&quot;Main thread calls Release(3) --&gt; &quot;</span>);</span><br><span class="line">            semaphore.Release(<span class="number">3</span>);<span class="comment">// 释放3次</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;&#123;0&#125; tasks can enter the semaphore.&quot;</span>,</span><br><span class="line">                semaphore.CurrentCount);</span><br><span class="line">            <span class="comment">// Main thread waits for the tasks to complete.</span></span><br><span class="line">            Task.WaitAll(tasks);</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Main thread exits.&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190306162258.png" alt="微信截图_20190306162258.png"></p>
<h2 id="ManualResetEventSlim"><a href="#ManualResetEventSlim" class="headerlink" title="ManualResetEventSlim"></a>ManualResetEventSlim</h2><p>ManualResetEventSlim是ManualReset的轻量级版本，采用的是”自旋等待“+”内核等待“，也就是说先采用”自旋等待的方式“等待，直到另一个任务调用set方法来释放它。如果迟迟等不到释放，那么任务就会进入基于内核的等待，所以说如果我们知道等待的时间比较短，采用轻量级的版本会具有更好的性能。</p>
<p>官方示例请参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.threading.manualreseteventslim?view=netframework-4.7.2">ManualResetEventSlim Class</a></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp4</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            MRES_SetWaitReset();</span><br><span class="line">            MRES_SpinCountWaitHandle();</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MRES_SetWaitReset</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            ManualResetEventSlim mres1 = <span class="keyword">new</span> ManualResetEventSlim(<span class="literal">false</span>,<span class="number">2000</span>); <span class="comment">// initialize as unsignaled</span></span><br><span class="line"></span><br><span class="line">            Task[] task=<span class="keyword">new</span> Task[<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                task[i] = Task.Factory.StartNew(() =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 等待mres1.Set();</span></span><br><span class="line">                    mres1.Wait();</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;当前时间:&#123;0&#125;,任务ID：mres1收到信号开始执行！&quot;</span>, DateTime.Now);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;当前时间:&#123;0&#125; 主线程ID:&#123;1&#125; \n&quot;</span>,</span><br><span class="line">                DateTime.Now,</span><br><span class="line">                Thread.CurrentThread.ManagedThreadId);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 等待两秒</span></span><br><span class="line">            Thread.Sleep(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 设置信号，使等待线程开始执行</span></span><br><span class="line">                mres1.Set();</span><br><span class="line">                Task.WaitAll(task);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 释放</span></span><br><span class="line">                mres1.Dispose();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Demonstrates:</span></span><br><span class="line">        <span class="comment">//      ManualResetEventSlim construction w/ SpinCount</span></span><br><span class="line">        <span class="comment">//      ManualResetEventSlim.WaitHandle</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MRES_SpinCountWaitHandle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Construct a ManualResetEventSlim with a SpinCount of 1000</span></span><br><span class="line">            <span class="comment">// Higher spincount =&gt; longer time the MRES will spin-wait before taking lock</span></span><br><span class="line">            ManualResetEventSlim mres1 = <span class="keyword">new</span> ManualResetEventSlim(<span class="literal">false</span>, <span class="number">1000</span>);</span><br><span class="line">            ManualResetEventSlim mres2 = <span class="keyword">new</span> ManualResetEventSlim(<span class="literal">false</span>, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">            Task bgTask = Task.Factory.StartNew(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Just wait a little</span></span><br><span class="line">                Thread.Sleep(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Now signal both MRESes</span></span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Task signalling both MRESes&quot;</span>);</span><br><span class="line">                mres1.Set();</span><br><span class="line">                mres2.Set();</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// A common use of MRES.WaitHandle is to use MRES as a participant in</span></span><br><span class="line">            <span class="comment">// WaitHandle.WaitAll/WaitAny.  Note that accessing MRES.WaitHandle will</span></span><br><span class="line">            <span class="comment">// result in the unconditional inflation of the underlying ManualResetEvent.</span></span><br><span class="line">            WaitHandle.WaitAll(<span class="keyword">new</span> WaitHandle[] &#123; mres1.WaitHandle, mres2.WaitHandle &#125;);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;WaitHandle.WaitAll(mres1.WaitHandle, mres2.WaitHandle) completed.&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Clean up</span></span><br><span class="line">            bgTask.Wait();</span><br><span class="line">            mres1.Dispose();</span><br><span class="line">            mres2.Dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考:</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/huangxincheng/archive/2012/04/08/2437701.html">8天玩转并行开发——第五天 同步机制（下）</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/03/06/%E5%B9%B6%E8%A1%8C%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E6%97%8B%E9%94%81-spinLock/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/06/%E5%B9%B6%E8%A1%8C%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E6%97%8B%E9%94%81-spinLock/" class="post-title-link" itemprop="url">并行开发之自旋锁-spinLock</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-06 10:58:13" itemprop="dateCreated datePublished" datetime="2019-03-06T10:58:13+00:00">2019-03-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 01:07:22" itemprop="dateModified" datetime="2021-04-23T01:07:22+00:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/net%E5%BC%82%E6%AD%A5%E4%B8%8E%E5%B9%B6%E8%A1%8C/" itemprop="url" rel="index"><span itemprop="name">.net异步与并行</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>提供一个相互排斥锁基元，在该基元中，尝试获取锁的线程将在重复检查的循环中等待，直至该锁变为可用为止。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/03/06/%E5%B9%B6%E8%A1%8C%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E6%97%8B%E9%94%81-spinLock/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/03/06/%E5%B9%B6%E8%A1%8C%E5%BC%80%E5%8F%91%E4%B9%8BBarrier/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/06/%E5%B9%B6%E8%A1%8C%E5%BC%80%E5%8F%91%E4%B9%8BBarrier/" class="post-title-link" itemprop="url">并行开发之Barrier</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-06 08:44:48" itemprop="dateCreated datePublished" datetime="2019-03-06T08:44:48+00:00">2019-03-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 01:07:22" itemprop="dateModified" datetime="2021-04-23T01:07:22+00:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/net%E5%BC%82%E6%AD%A5%E4%B8%8E%E5%B9%B6%E8%A1%8C/" itemprop="url" rel="index"><span itemprop="name">.net异步与并行</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="屏障简介"><a href="#屏障简介" class="headerlink" title="屏障简介"></a>屏障简介</h2><p><code>System.Threading.Barrier</code> 是同步基元，可以使多个线程（称为“参与者”）分阶段同时处理算法。<br>屏障表示工作阶段的末尾。 单个参与者到达屏障后将被阻止，直至所有参与者都已达到同一障碍。 所有参与者都已达到屏障后，你可以选择调用阶段后操作。此阶段后操作可由单线程用于执行操作，而所有其他线程仍被阻止。 执行此操作后，所有参与者将不受阻止。</p>
<h2 id="添加和删除参与者"><a href="#添加和删除参与者" class="headerlink" title="添加和删除参与者"></a>添加和删除参与者</h2><p>创建 <code>Barrier</code> 实例时，需指定参与者数量。 还可以随时动态添加或删除参与者。 例如，如果其中一个参与者解决了问题的一部分，可以存储结果，停止执行相应线程，并调用 <code>Barrier.RemoveParticipant</code> 以减少屏障中的参与者数量。 当通过调用 <code>Barrier.AddParticipant</code> 添加参与者时，返回值将指定当前阶段的数量，这在初始化新的参与者的工作时很有用。</p>
<h2 id="断开的屏障"><a href="#断开的屏障" class="headerlink" title="断开的屏障"></a>断开的屏障</h2><p>如果一个参与者无法到达屏障，则可能发生死锁。若要避免这些死锁，请使用 Barrier.SignalAndWait 方法的重载来指定超时期限和取消标记。 这些重载将返回一个布尔值，每个参与者均可在继续到下一阶段前进行检查。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp4</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//四个task执行</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Task[] tasks = <span class="keyword">new</span> Task[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Barrier _barrier = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            CancellationTokenSource cts = <span class="keyword">new</span> CancellationTokenSource();</span><br><span class="line"></span><br><span class="line">            CancellationToken ct = cts.Token;</span><br><span class="line"></span><br><span class="line">            _barrier = <span class="keyword">new</span> Barrier(tasks.Length, (i) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;**********************************************************&quot;</span>);</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;\n屏障中当前阶段编号:&#123;0&#125;\n&quot;</span>, i.CurrentPhaseNumber);</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;**********************************************************&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; tasks.Length; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                tasks[j] = Task.Factory.StartNew((obj) =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> single = Convert.ToInt32(obj);</span><br><span class="line"></span><br><span class="line">                    LoadUser(single);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!_barrier.SignalAndWait(<span class="number">2000</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//抛出异常，取消后面加载的执行</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> OperationCanceledException(<span class="built_in">string</span>.Format(<span class="string">&quot;我是当前任务&#123;0&#125;,我抛出异常了！&quot;</span>, single), ct);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    LoadProduct(single);</span><br><span class="line">                    _barrier.SignalAndWait();</span><br><span class="line"></span><br><span class="line">                    LoadOrder(single);</span><br><span class="line">                    _barrier.SignalAndWait();</span><br><span class="line">                &#125;, j, ct);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//等待所有tasks 4s</span></span><br><span class="line">            Task.WaitAll(tasks, <span class="number">4000</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; tasks.Length; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tasks[i].Status == TaskStatus.Faulted)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//获取task中的异常</span></span><br><span class="line">                        <span class="keyword">foreach</span> (<span class="keyword">var</span> single <span class="keyword">in</span> tasks[i].Exception.InnerExceptions)</span><br><span class="line">                        &#123;</span><br><span class="line">                            Console.WriteLine(single.Message);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                _barrier.Dispose();</span><br><span class="line">            &#125;</span><br><span class="line">            catch (AggregateException e)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;我是总异常:&#123;0&#125;&quot;</span>, e.Message);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Console.Read();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LoadUser</span>(<span class="params"><span class="built_in">int</span> num</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;\n当前任务:&#123;0&#125;正在加载User部分数据！&quot;</span>, num);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (num == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//自旋转5s</span></span><br><span class="line">                <span class="keyword">if</span> (!SpinWait.SpinUntil(() =&gt; _barrier.ParticipantsRemaining == <span class="number">0</span>, <span class="number">5000</span>))</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;当前任务:&#123;0&#125;正在加载User数据完毕！&quot;</span>, num);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LoadProduct</span>(<span class="params"><span class="built_in">int</span> num</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;当前任务:&#123;0&#125;正在加载Product部分数据！&quot;</span>, num);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LoadOrder</span>(<span class="params"><span class="built_in">int</span> num</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;当前任务:&#123;0&#125;正在加载Order部分数据！&quot;</span>, num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="阶段后异常"><a href="#阶段后异常" class="headerlink" title="阶段后异常"></a>阶段后异常</h2><p>如果阶段后委托引发异常，则它将包装在 BarrierPostPhaseException 对象中，然后传播到所有参与者。</p>
<h2 id="屏障与-ContinueWhenAll"><a href="#屏障与-ContinueWhenAll" class="headerlink" title="屏障与 ContinueWhenAll"></a>屏障与 ContinueWhenAll</h2><p><font color=#ff0000 size=4 face="黑体">当线程执行循环中的多个阶段时，屏障特别有用。</font> 如果你的代码仅需一个或多个工作阶段，则应考虑是否配合使用 <code>System.Threading.Tasks.Task</code> 对象与任何类型的隐式联接，其中包括：</p>
<ul>
<li><p>TaskFactory.ContinueWhenAll</p>
</li>
<li><p>Parallel.Invoke</p>
</li>
<li><p>Parallel.ForEach</p>
</li>
<li><p>Parallel.For</p>
</li>
</ul>
<h2 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h2><p>msdn官方实例：<br>统计两个线程使用随机算法重新随机选择字词，分别在同一阶段查找一半解决方案时所需的迭代次数（或阶段数）。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp4</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span>[] words1 = <span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;brown&quot;</span>, <span class="string">&quot;jumps&quot;</span>, <span class="string">&quot;the&quot;</span>, <span class="string">&quot;fox&quot;</span>, <span class="string">&quot;quick&quot;</span> &#125;;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span>[] words2 = <span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;dog&quot;</span>, <span class="string">&quot;lazy&quot;</span>, <span class="string">&quot;the&quot;</span>, <span class="string">&quot;over&quot;</span> &#125;;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> solution = <span class="string">&quot;the quick brown fox jumps over the lazy dog.&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> success = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Barrier barrier = <span class="keyword">new</span> Barrier(<span class="number">2</span>, (b) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; words1.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                sb.Append(words1[i]);</span><br><span class="line">                sb.Append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; words2.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                sb.Append(words2[i]);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (i &lt; words2.Length - <span class="number">1</span>)</span><br><span class="line">                    sb.Append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sb.Append(<span class="string">&quot;.&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Console.CursorLeft = <span class="number">0</span>;</span><br><span class="line">            Console.Write(<span class="string">&quot;Current phase: &#123;0&#125;&quot;</span>, barrier.CurrentPhaseNumber);</span><br><span class="line">            <span class="keyword">if</span> (String.CompareOrdinal(solution, sb.ToString()) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                success = <span class="literal">true</span>;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;\r\nThe solution was found in &#123;0&#125; attempts&quot;</span>, barrier.CurrentPhaseNumber);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Thread t1 = <span class="keyword">new</span> Thread(() =&gt; Solve(words1));</span><br><span class="line">            Thread t2 = <span class="keyword">new</span> Thread(() =&gt; Solve(words2));</span><br><span class="line">            t1.Start();</span><br><span class="line">            t2.Start();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Keep the console window open.</span></span><br><span class="line">            Console.ReadLine();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Solve</span>(<span class="params"><span class="built_in">string</span>[] wordArray</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">while</span> (success == <span class="literal">false</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Random random = <span class="keyword">new</span> Random();</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = wordArray.Length - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">int</span> swapIndex = random.Next(i + <span class="number">1</span>);</span><br><span class="line">                    <span class="built_in">string</span> temp = wordArray[i];</span><br><span class="line">                    wordArray[i] = wordArray[swapIndex];</span><br><span class="line">                    wordArray[swapIndex] = temp;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                barrier.SignalAndWait();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单示例：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp4</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//四个task执行</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Task[] tasks = <span class="keyword">new</span> Task[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Barrier barrier = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            barrier = <span class="keyword">new</span> Barrier(tasks.Length, (i) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;**********************************************************&quot;</span>);</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;\n屏障中当前阶段编号:&#123;0&#125;\n&quot;</span>, i.CurrentPhaseNumber);</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;**********************************************************&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; tasks.Length; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                tasks[j] = Task.Factory.StartNew((obj) =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> single = Convert.ToInt32(obj);</span><br><span class="line"></span><br><span class="line">                    LoadUser(single);</span><br><span class="line">                    barrier.SignalAndWait();</span><br><span class="line"></span><br><span class="line">                    LoadProduct(single);</span><br><span class="line">                    barrier.SignalAndWait();</span><br><span class="line"></span><br><span class="line">                    LoadOrder(single);</span><br><span class="line">                    barrier.SignalAndWait();</span><br><span class="line">                &#125;, j);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Task.WaitAll(tasks);</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;指定数据库中所有数据已经加载完毕！&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Console.Read();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LoadUser</span>(<span class="params"><span class="built_in">int</span> num</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;当前任务:&#123;0&#125;正在加载User部分数据！&quot;</span>, num);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 以下代码会造成死锁</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            if (num == 0)</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                //num=0：表示0号任务</span></span><br><span class="line"><span class="comment">                //barrier.ParticipantsRemaining == 0：表示所有task到达屏障才会退出</span></span><br><span class="line"><span class="comment">                // SpinWait.SpinUntil: 自旋锁，相当于死循环</span></span><br><span class="line"><span class="comment">                SpinWait.SpinUntil(() =&gt; barrier.ParticipantsRemaining == 0);</span></span><br><span class="line"><span class="comment">            &#125;*/</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LoadProduct</span>(<span class="params"><span class="built_in">int</span> num</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;当前任务:&#123;0&#125;正在加载Product部分数据！&quot;</span>, num);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LoadOrder</span>(<span class="params"><span class="built_in">int</span> num</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;当前任务:&#123;0&#125;正在加载Order部分数据！&quot;</span>, num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/standard/threading/barrier">屏障</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/standard/threading/how-to-synchronize-concurrent-operations-with-a-barrier">如何：使用屏障来使并发操作保持同步</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/huangxincheng/archive/2012/04/07/2437110.html">8天玩转并行开发——第四天 同步机制（上）</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/03/03/%E6%B5%8B%E8%AF%95%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-TDD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/03/%E6%B5%8B%E8%AF%95%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-TDD/" class="post-title-link" itemprop="url">测试驱动开发-TDD</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-03 09:32:43" itemprop="dateCreated datePublished" datetime="2019-03-03T09:32:43+00:00">2019-03-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 01:07:22" itemprop="dateModified" datetime="2021-04-23T01:07:22+00:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TDD/" itemprop="url" rel="index"><span itemprop="name">TDD</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>测试驱动开发-TDD,编写易于测试的代码。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/03/03/%E6%B5%8B%E8%AF%95%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-TDD/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/03/01/%E7%BD%91%E9%A1%B5%E6%BB%9A%E5%8A%A8%E5%88%B0%E9%A1%B6%E9%83%A8%E7%89%B9%E6%95%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/01/%E7%BD%91%E9%A1%B5%E6%BB%9A%E5%8A%A8%E5%88%B0%E9%A1%B6%E9%83%A8%E7%89%B9%E6%95%88/" class="post-title-link" itemprop="url">网页滚动到顶部特效</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-01 10:20:42" itemprop="dateCreated datePublished" datetime="2019-03-01T10:20:42+00:00">2019-03-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 01:07:22" itemprop="dateModified" datetime="2021-04-23T01:07:22+00:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript-JQuery/" itemprop="url" rel="index"><span itemprop="name">JavaScript/JQuery</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>点击图标，实现网页滚动到顶部特效</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/03/01/%E7%BD%91%E9%A1%B5%E6%BB%9A%E5%8A%A8%E5%88%B0%E9%A1%B6%E9%83%A8%E7%89%B9%E6%95%88/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/02/19/ASP-NET-MVC-%E9%A1%B5%E9%9D%A2%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/19/ASP-NET-MVC-%E9%A1%B5%E9%9D%A2%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" class="post-title-link" itemprop="url">ASP.NET MVC 页面生命周期</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-19 15:10:11" itemprop="dateCreated datePublished" datetime="2019-02-19T15:10:11+00:00">2019-02-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 01:07:22" itemprop="dateModified" datetime="2021-04-23T01:07:22+00:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MVC-Web-API/" itemprop="url" rel="index"><span itemprop="name">MVC/Web API</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ASP-NET-MVC-页面生命周期"><a href="#ASP-NET-MVC-页面生命周期" class="headerlink" title="ASP.NET MVC 页面生命周期"></a>ASP.NET MVC 页面生命周期</h1><p>整个ASP.NET MVC框架是通过自定义的 <code>HttpModule</code> 和 <code>HttpHandler</code> 对ASP.NET 进行扩展构建起来的。</p>
<ul>
<li>自定义的 <code>HttpModule</code> : <code>UrlRoutingModule</code></li>
<li>自定义的 <code>HttpHandler</code>: <code>MvcHandler</code></li>
</ul>
<p><img src="/img/1458860-5d9e4724f9e32ccb.png" alt="1458860-5d9e4724f9e32ccb.png"></p>
<p><img src="/img/190104561291113.png" alt="190104561291113.png"></p>
<h2 id="HttpApplication与HttpModule"><a href="#HttpApplication与HttpModule" class="headerlink" title="HttpApplication与HttpModule"></a>HttpApplication与HttpModule</h2><p>HTTP请求由ASP.NET运行时接管之后，<code>HttpRuntime</code> 会利用 <code>HttpApplicationFactory</code> 创建或从 <code>HttpApplication</code>对象池中取出一个<code>HttpApplication</code>对象，同时ASP.NET会根据配置文件来初始化注册的<code>HttpModule</code>，<code>HttpModule</code>在初始化时会订阅<code>HttpApplication</code>中的事件来实现对HTTP请求的处理。</p>
<p><img src="/img/190047183794497.png" alt="190047183794497.png"></p>
<p><font color=#ff0000 size=4 face="黑体">ASP.NET MVC的入口在<code>UrlRoutingModule</code>,它订阅了<code>HttpApplication</code>的第7个管道事件<code>PostResolveRequestCahce</code>，并且在<code>HtttpApplication</code>的第7个管道事件处对请求进行了拦截。</font></p>
<h2 id="UrlRoutingModule"><a href="#UrlRoutingModule" class="headerlink" title="UrlRoutingModule"></a>UrlRoutingModule</h2><p>通过在全局Web.Config中注册 <code>System.Web.Routing.UrlRoutingModule</code>，IIS请求处理管道接到请求后，就会加载 <code>UrlRoutingModule</code>类型的Init()方法，第7个管道事件 <code>PostResolveRequestCahce</code> 对请求进行了拦截。</p>
<p>当请求到达 <code>UrlRoutingModule</code> 的时候，<code>UrlRoutingModule</code> 取出请求中的 Controller、Action等RouteData信息，与路由表中的所有规则进行匹配，若匹配，把请求交给 <code>IRouteHandler</code>，即 <code>MVCRouteHandler</code>。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过RouteCollection的静态方法GetRouteData获取到封装路由信息的RouteData实例</span></span><br><span class="line">RouteData routeData = <span class="keyword">this</span>.RouteCollection.GetRouteData(context);</span><br><span class="line"></span><br><span class="line"><span class="comment">//再从RouteData中获取MVCRouteHandler</span></span><br><span class="line">IRouteHandler routeHandler = routeData.RouteHandler;</span><br></pre></td></tr></table></figure>

<h2 id="MVCRouteHadnler"><a href="#MVCRouteHadnler" class="headerlink" title="MVCRouteHadnler"></a>MVCRouteHadnler</h2><p><code>MvcRouteHandler</code> 在HttpApplication的第一个管道事件，使用 <code>MapRoute()</code> 方法注册路由的时候，通过<code>Route</code>类的构造函数把<code>MVCRouteHandler</code>注入到路由中。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Route <span class="title">MapRoute</span>(<span class="params"><span class="keyword">this</span> RouteCollection routes, <span class="built_in">string</span> name, <span class="built_in">string</span> url, <span class="built_in">object</span> defaults, <span class="built_in">object</span> constraints, <span class="built_in">string</span>[] namespaces</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (routes == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">&quot;routes&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (url == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// MvcRouteHandler</span></span><br><span class="line">    Route route = <span class="keyword">new</span> Route(url, <span class="keyword">new</span> MvcRouteHandler()) &#123;</span><br><span class="line">        Defaults = <span class="keyword">new</span> RouteValueDictionary(defaults),</span><br><span class="line">        Constraints = <span class="keyword">new</span> RouteValueDictionary(constraints),</span><br><span class="line">        DataTokens = <span class="keyword">new</span> RouteValueDictionary()</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((namespaces != <span class="literal">null</span>) &amp;&amp; (namespaces.Length &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">        route.DataTokens[<span class="string">&quot;Namespaces&quot;</span>] = namespaces;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    routes.Add(name, route);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> route;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MVCRouteHandler</code>是用来生成实现<code>IHttpHandler</code>接口的<code>MvcHandler</code>。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">System.Web.Routing</span></span><br><span class="line">&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRouteHandler</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">IHttpHandler <span class="title">GetHttpHandler</span>(<span class="params">RequestContext requestContext</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MvcHandler"><a href="#MvcHandler" class="headerlink" title="MvcHandler"></a>MvcHandler</h2><p>第7个事件生成了 <code>MvcHandler</code>。</p>
<p>第11和第12个事件之间调用了<code>MvcHandler</code>的<code>ProcessRequest</code>方法。</p>
<p>通过<code>RouteHandler</code>的 <code>GetHttpHandler()</code>方法获取到实现了<code>IHttpHandler</code>接口的<code>MVCHandler</code>。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IHttpHandler httpHandler = routeHandler.GetHttpHandler(requestContext);</span><br><span class="line">context.RemapHandler(httpHandler);</span><br></pre></td></tr></table></figure>

<p><code>MvcHandler</code> 部分源码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MvcHandler</span> : <span class="title">IHttpAsyncHandler</span>, <span class="title">IHttpHandler</span>, <span class="title">IRequiresSessionState</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">internal</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ProcessRequest</span>(<span class="params">HttpContextBase httpContext</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        SecurityUtil.ProcessInApplicationTrust(() =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            IController controller;</span><br><span class="line">            IControllerFactory factory;</span><br><span class="line">            ProcessRequestInit(httpContext, <span class="keyword">out</span> controller, <span class="keyword">out</span> factory);<span class="comment">//初始化了ControllerFactory</span></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                controller.Execute(RequestContext);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                factory.ReleaseController(controller);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ProcessRequestInit</span>(<span class="params">HttpContextBase httpContext, <span class="keyword">out</span> IController controller, <span class="keyword">out</span> IControllerFactory factory</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">bool</span>? isRequestValidationEnabled = ValidationUtility.IsValidationEnabled(HttpContext.Current);</span><br><span class="line">        <span class="keyword">if</span> (isRequestValidationEnabled == <span class="literal">true</span>) &#123;</span><br><span class="line">            ValidationUtility.EnableDynamicValidation(HttpContext.Current);</span><br><span class="line">        &#125;</span><br><span class="line">        AddVersionHeader(httpContext);</span><br><span class="line">        RemoveOptionalRoutingParameters();</span><br><span class="line">        <span class="built_in">string</span> controllerName = RequestContext.RouteData.GetRequiredString(<span class="string">&quot;controller&quot;</span>);</span><br><span class="line">        factory = ControllerBuilder.GetControllerFactory();</span><br><span class="line">        controller = factory.CreateController(RequestContext, controllerName);</span><br><span class="line">        <span class="keyword">if</span> (controller == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(String.Format(CultureInfo.CurrentCulture,MvcResources.ControllerBuilder_FactoryReturnedNull,factory.GetType(),controllerName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ControllerFactory"><a href="#ControllerFactory" class="headerlink" title="ControllerFactory"></a>ControllerFactory</h2><p>通过<code>ControllerBuilder</code>的静态方法<code>GetControllerFactory</code>获取到实现<code>IControllerFactory</code>接口的<code>ControllerFactory</code>。通过<code>ControllerFactory</code>来创建指定名称的控制器，最后将控制器作为out参数传递出去。</p>
<h2 id="ActionInvoker"><a href="#ActionInvoker" class="headerlink" title="ActionInvoker"></a>ActionInvoker</h2><p>ActionInvoker实现了IActionInvoker接口：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IActionInvoker</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="built_in">bool</span> <span class="title">InvokeAction</span>(<span class="params">ControllerContext controllerContext, <span class="built_in">string</span> actionName</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MVC默认的ActionInvoker是ControllerActionInvoker。</p>
<p>ActionInvoker在执行InvokeAction()方法时会需要有关Controller和Action的相关信息，实际上，Controller信息(比如Controller的名称、类型、包含的Action等)被封装在ControllerDescriptor这个类中，Action信息(比如Action的名称、参数、属性、过滤器等)被封装在ActionDescriptor中。ActionDescriptor还提供了一个FindAction()方法，用来找到需要被执行的Action。</p>
<h2 id="Filters"><a href="#Filters" class="headerlink" title="Filters"></a>Filters</h2><p>Filter-&gt;Action-&gt;Filter-&gt;Result</p>
<p>在ASP.NET MVC5中有常用的过滤器有5个：<code>IAuthenticationFilter</code>、<code>IAuthorizationFilter</code>、<code>IActionFilter</code>、<code>IResultFilter</code>、<code>IExceptionFilter</code>。<br>在ASP.NET MVC中所有的过滤器最终都会被封装为Filter对象，该对象中FilterScope类型的属性Scope和int类型属性Order用于决定过滤器执行的先后顺序，具体规则如下：</p>
<ul>
<li>Order和FilterScope的数值越小，过滤器的执行优先级越高；</li>
<li>Order比FilterScope具有更高的优先级，在Order属性值相同时FilterScope才会被考虑</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//数值越小，执行优先级越高</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> FilterScope</span><br><span class="line">&#123;</span><br><span class="line">    Action= <span class="number">30</span>,</span><br><span class="line">    Controller= <span class="number">20</span>,</span><br><span class="line">    First= <span class="number">0</span>,</span><br><span class="line">    Global= <span class="number">10</span>,</span><br><span class="line">    Last= <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ActionResult"><a href="#ActionResult" class="headerlink" title="ActionResult"></a>ActionResult</h2><p>ActionResult是一个抽象类：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">ActionResult</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">ExecuteResult</span>(<span class="params">ControllerContext context</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果ActionResult是非ViewResult，比如JsonResult, ContentResult，这些内容将直接被输送到Response响应流中，显示给客户端；如果是ViewResult，就会进入下一个渲染视图环节。</p>
<h2 id="ViewEngine"><a href="#ViewEngine" class="headerlink" title="ViewEngine"></a>ViewEngine</h2><p>默认的有<code>Razor View Engine</code>和<code>Web Form View Engine</code>，实现IViewEngine接口。</p>
<p>IViewEngine接口方法：</p>
<ul>
<li>FindPartialView</li>
<li>FindView</li>
<li>ReleaseView</li>
</ul>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Cwj-XFH/p/6752177.html">ASP.NET MVC5请求管道和生命周期</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/edisonchou/p/4226558.html">ASP.Net请求处理机制初步探索之旅 - Part 5 ASP.Net MVC请求处理流程</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/darrenji/p/3795690.html">ASP.NET MVC请求处理管道生命周期的19个关键环节(13-19)</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/artech/archive/2012/04/10/how-mvc-works.html">How ASP.NET MVC Works?</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/artech/archive/2012/08/06/action-filter.html">ASP.NET MVC中的ActionFilter是如何执行的？</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/artech/archive/2012/07/02/AuthorizationFilter.html">认识ASP.NET MVC的5种AuthorizationFilter</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/artech/archive/2012/08/22/view-engine-01.html">ASP.NET MVC的View是如何被呈现出来的？[设计篇]</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/artech/archive/2012/08/23/view-engine-02.html">ASP.NET MVC的View是如何呈现出来的[实例篇]</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/02/19/WebForm%E4%B9%8BViewState%E4%B8%8EUpdatePannel%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/19/WebForm%E4%B9%8BViewState%E4%B8%8EUpdatePannel%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">WebForm之ViewState与UpdatePannel详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-19 14:16:35" itemprop="dateCreated datePublished" datetime="2019-02-19T14:16:35+00:00">2019-02-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 01:07:22" itemprop="dateModified" datetime="2021-04-23T01:07:22+00:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WebForm/" itemprop="url" rel="index"><span itemprop="name">WebForm</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="WebForm之ViewState与UpdatePannel详解"><a href="#WebForm之ViewState与UpdatePannel详解" class="headerlink" title="WebForm之ViewState与UpdatePannel详解"></a>WebForm之ViewState与UpdatePannel详解</h1><h2 id="ViewState"><a href="#ViewState" class="headerlink" title="ViewState"></a>ViewState</h2><h3 id="ViewState简介"><a href="#ViewState简介" class="headerlink" title="ViewState简介"></a>ViewState简介</h3><p>1,类似于Dictionary的一种数据结构</p>
<p>ViewState通过String类型的数据作为索引。ViewState对应项中的值可以存储任何类型的值（参数是Object类型），任何类型的值存储到ViewState中都会被装箱为Object类型。</p>
<p>注：ViewState不能存储所有的数据类型，仅支持以下的这几种：<br>String、Integer、Boolean、Array、ArrayList、Hashtable以及一些自定义类型。</p>
<p>2，ViewState存储在浏览器的页面之中</p>
<p>ViewState的作用域是页面，消耗服务器资源相对较少。</p>
<p>服务器在向浏览器返回html之前，对ViewState中的内容进行了Base64的加密编码。VIEWSTATE适用于同一个页面在不关闭的情况下多次与服务器交互（PostBack）</p>
<p>当用户点击页面中的某个按钮提交表单时，浏览器会将这个_VIEWSTATE的隐藏域也一起提交到服务端；服务器端在解析请求时，会将浏览器提交过来的ViewState进行反序列化后填充到ViewState属性中；再根据业务处理需要，从这个属性中根据索引找到具体的Value值并对其进行操作；操作完成后，再将ViewState进行Base64编码再次返回给浏览器端；</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;__VIEWSTATE&quot;</span> id=<span class="string">&quot;__VIEWSTATE&quot;</span> <span class="keyword">value</span>=<span class="string">&quot;/wEPDwUKLTg4NTU3NzYwOGRkbQwtdx3+TX000hqmVYIcP3+P3zcihvV0deiDjaSgFRQ=&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<h3 id="ViewState存在的问题"><a href="#ViewState存在的问题" class="headerlink" title="ViewState存在的问题"></a>ViewState存在的问题</h3><p>当 <code>Repeater</code>等控件使用时，存储较大的值，用户请求显示页面的速度会减慢。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;__VIEWSTATE&quot;</span> id=<span class="string">&quot;__VIEWSTATE&quot;</span> <span class="keyword">value</span>=<span class="string">&quot;/wEPDwUJLTQ2OTExMTk1D2QWAgIBD2QWBAIBDxAPFgYeDkRhdGFWYWx1ZUZpZWxkBQJJRB4NRGF0YVRleHRGaWVsZAUETmFtZR4LXyFEYXRhQm91vZflubPop4Lpn7PooZfmsp/pgJoxMDDljoUn5LqR5Y2X6L+q5L+h6YCa572X5bmz6LSi5a+M5rKf6YCaMTAw5Y6FKuS6keWNl+i/quS/oUCBTExNDczBTExNDczZAIDDw8WAh8FBQUxMTQ3M2RkAgUPDxYCHwUFCzE4Mzg4MDM4MTY1ZGQCBQ8PFgIeC1JlY29yZGNvdW50AvIDZGRkmmJuzxcRIKhlTny8ibiHOR92G/JYSgGwzO69sFxoLV8=&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<h3 id="禁用ViewState"><a href="#禁用ViewState" class="headerlink" title="禁用ViewState"></a>禁用ViewState</h3><p>1,页面级禁用，在Page指令集中添加EnableViewState=”false”。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ Page Language=<span class="string">&quot;C#&quot;</span> AutoEventWireup=<span class="string">&quot;true&quot;</span> CodeBehind=<span class="string">&quot;RepeaterViewState.aspx.cs&quot;</span></span><br><span class="line">    Inherits=<span class="string">&quot;WebForm1.RepeaterViewState&quot;</span> EnableViewState=<span class="string">&quot;false&quot;</span> %&gt;</span><br></pre></td></tr></table></figure>

<p>注：禁用之后页面依然存在ViewState，但数据量已经减小。</p>
<p>2，控件级禁用ViewState</p>
<p>控件设置一个属性EnableViewState=”false”。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;asp:Repeater ID=<span class="string">&quot;repeaterProducts&quot;</span> runat=<span class="string">&quot;server&quot;</span> EnableViewState=<span class="string">&quot;false&quot;</span>&gt;</span><br><span class="line">&lt;/asp:Repeater&gt;</span><br></pre></td></tr></table></figure>

<p>3,全局级禁用ViewState</p>
<p>Web.config的system.web中增加一句配置</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;pages enableViewState=<span class="string">&quot;false&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<p>4,单独控制禁用与启用</p>
<p>ASP.NET4.0之前，控件的视图只有在 Page 的 ViewState 启用的前提下才可以单独控制。</p>
<p>ASP.NET4.0供了一个叫做 ViewStateMode 的新属性，这个属性可以单独设置控件的视图状态。即使页面的 <code>ViewState</code> 没有启用，控件依然可以启用视图状态。</p>
<p>ViewStateMode 属性有三种取值：</p>
<ul>
<li>Inherit：视图状态从父控件继承；</li>
<li>Enabled：即使父控件的视图状态没有启用，也启用该控件的视图状态；</li>
<li>Disabled：即使父控件的视图状态启用了，也禁用此控件的视图状态。</li>
</ul>
<h2 id="UpdatePanel控件"><a href="#UpdatePanel控件" class="headerlink" title="UpdatePanel控件"></a>UpdatePanel控件</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> &lt;form id=<span class="string">&quot;form1&quot;</span> runat=<span class="string">&quot;server&quot;</span>&gt;</span><br><span class="line">    &lt;div align=<span class="string">&quot;center&quot;</span>&gt;</span><br><span class="line">        &lt;asp:ScriptManager ID=<span class="string">&quot;scriptManager&quot;</span> runat=<span class="string">&quot;server&quot;</span>&gt;</span><br><span class="line">        &lt;/asp:ScriptManager&gt;</span><br><span class="line">        &lt;asp:UpdatePanel ID=<span class="string">&quot;updatePanel&quot;</span> runat=<span class="string">&quot;server&quot;</span>&gt;</span><br><span class="line">            &lt;ContentTemplate&gt;</span><br><span class="line">                &lt;asp:TextBox ID=<span class="string">&quot;txtNumber1&quot;</span> runat=<span class="string">&quot;server&quot;</span>&gt;&lt;/asp:TextBox&gt;</span><br><span class="line">                &lt;asp:DropDownList ID=<span class="string">&quot;ddlFunc&quot;</span> runat=<span class="string">&quot;server&quot;</span>&gt;</span><br><span class="line">                    &lt;asp:ListItem Value=<span class="string">&quot;0&quot;</span>&gt;+&lt;/asp:ListItem&gt;</span><br><span class="line">                    &lt;asp:ListItem Value=<span class="string">&quot;1&quot;</span>&gt;-&lt;/asp:ListItem&gt;</span><br><span class="line">                    &lt;asp:ListItem Value=<span class="string">&quot;2&quot;</span>&gt;*&lt;/asp:ListItem&gt;</span><br><span class="line">                    &lt;asp:ListItem Value=<span class="string">&quot;3&quot;</span>&gt;/&lt;/asp:ListItem&gt;</span><br><span class="line">                &lt;/asp:DropDownList&gt;</span><br><span class="line">                &lt;asp:TextBox ID=<span class="string">&quot;txtNumber2&quot;</span> runat=<span class="string">&quot;server&quot;</span>&gt;&lt;/asp:TextBox&gt;</span><br><span class="line">                &lt;asp:Button ID=<span class="string">&quot;btnGetResult&quot;</span> runat=<span class="string">&quot;server&quot;</span> Text=<span class="string">&quot;=&quot;</span> Width=<span class="string">&quot;50&quot;</span> OnClick=<span class="string">&quot;btnGetResult_Click&quot;</span> /&gt;</span><br><span class="line">                &lt;asp:Label ID=<span class="string">&quot;lblResult&quot;</span> runat=<span class="string">&quot;server&quot;</span> Text=<span class="string">&quot;&quot;</span> Font-Bold=<span class="string">&quot;true&quot;</span>&gt;&lt;/asp:Label&gt;</span><br><span class="line">            &lt;/ContentTemplate&gt;</span><br><span class="line">        &lt;/asp:UpdatePanel&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<p>UpdatePanel本质封装了以XmlHttpRequest为核心的一系列方法帮我们将CodeBehind中的同步事件变为了异步操作，并通过DOM更新指定的HTML内容，使得我们可以方便地实现AJAX效果。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/edisonchou/p/3901559.html">ASP.Net WebForm温故知新学习笔记：二、ViewState与UpdatePanel探秘</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/freeflying/archive/2009/12/28/1634229.html">禁掉VIEWSTATE之后（一）</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/yukaizhao/archive/2010/05/22/asp-net-new-feature-pure-html.html">Asp.Net 4.0 新特性，输出更纯净的Html代码 ClientIDMode，ViewStateMode等</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/02/18/ASP-NET-WebForm%E9%A1%B5%E9%9D%A2%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/18/ASP-NET-WebForm%E9%A1%B5%E9%9D%A2%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" class="post-title-link" itemprop="url">ASP.NET WebForm页面生命周期</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-18 11:32:37" itemprop="dateCreated datePublished" datetime="2019-02-18T11:32:37+00:00">2019-02-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 01:07:22" itemprop="dateModified" datetime="2021-04-23T01:07:22+00:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WebForm/" itemprop="url" rel="index"><span itemprop="name">WebForm</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ASP-NET-WebForm页面生命周期"><a href="#ASP-NET-WebForm页面生命周期" class="headerlink" title="ASP.NET WebForm页面生命周期"></a>ASP.NET WebForm页面生命周期</h1><h2 id="生命周期阶段"><a href="#生命周期阶段" class="headerlink" title="生命周期阶段"></a>生命周期阶段</h2><h3 id="1、请求页面"><a href="#1、请求页面" class="headerlink" title="1、请求页面"></a>1、请求页面</h3><p>页请求发生在页生命周期开始之前。</p>
<h3 id="2、开始阶段"><a href="#2、开始阶段" class="headerlink" title="2、开始阶段"></a>2、开始阶段</h3><p>1，Page类的ProcessRequest方法作为页面生命周期的入口；<br>2，BuildControlTree：构造页面控件树；<br>3，设置IsPostBack属性是否第一次请求该页面；</p>
<h3 id="3、初始化页面"><a href="#3、初始化页面" class="headerlink" title="3、初始化页面"></a>3、初始化页面</h3><p>页面初始化期间，可以使用页中的控件，并将设置每个控件的UniqueID属性。如果当前请求是回发请求，则回发数据尚未加载，并且控件属性值尚未还原为视图状态中的值。</p>
<p>事件：<code>PreInit--&gt;Init--&gt;InitComplete</code></p>
<p>** PreInit**</p>
<p>PreInit 是页面生命周期的第一个事件。它检查 IsPostBack 属性并决定页面是否是回发。它设置主题及主版页，创建动态控件，并且获取和设置值配置文件属性值。此事件可通过重载 OnPreInit 方法或者创建一个 Page_PreInit 处理程序进行处置。</p>
<p>** Init**</p>
<p>Init 事件初始化控件属性，并且建立控件树。此事件可通过重载 OnInit 方法或者创建一个 Page_Init处理程序进行处置。</p>
<p>** InitComplete**</p>
<p>InitComplete 事件允许对视图状态的跟踪。所有的控件开启视图状态下的跟踪。</p>
<h3 id="4、加载页面"><a href="#4、加载页面" class="headerlink" title="4、加载页面"></a>4、加载页面</h3><p>设置控件属性，使用视图状态和控件状态值。</p>
<p>事件：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">（LoadState--&gt;ProcessPostData--&gt;）PreLoad--&gt;Load--&gt;</span><br><span class="line">（ProcessPostData--&gt;RaiseChangedEvents--&gt;RaisePostBackEvent--&gt;）LoadComplete</span><br></pre></td></tr></table></figure>

<p>** LoadViewState**</p>
<p>允许加载视图状态信息到控件中。</p>
<p>** LoadPostData**</p>
<p>对所有由 \ 标签定义的输入字段的内容进行处理。</p>
<p>** PreLoad**</p>
<p>PreLoad 在回发数据加载在控件中之前发生。此事件可以通过重载 OnPreLoad 方法或者创建一个 Pre_Load 处理程序进行处置。</p>
<p>** Load **</p>
<p>Load 事件被页面最先引发，然后递归地引发所有子控件。控件树中的控件就被创建好了。此事件可通过重载 OnLoad 方法或者创建一个 Page_Load 处理程序来进行处置。</p>
<h3 id="5、验证"><a href="#5、验证" class="headerlink" title="5、验证"></a>5、验证</h3><p>在验证期间，将调用所有验证程序控件的Validate方法，此方法将设置各个验证程序控件和页的IsValid属性为 true。</p>
<p>** LoadComplete**</p>
<p>加载进程完成，控件事件处理程序运行，页面验证发生。此事件可通过重载 OnLoad 方法或者创建一个 Page_LoadComplete 处理程序来进行处置。</p>
<h3 id="6、回发事件处理"><a href="#6、回发事件处理" class="headerlink" title="6、回发事件处理"></a>6、回发事件处理</h3><p>如果请求是回发请求，则将调用所有事件处理程序。</p>
<h3 id="7、呈现页面"><a href="#7、呈现页面" class="headerlink" title="7、呈现页面"></a>7、呈现页面</h3><p>页面的视图状态和所有控件被保存。页面为每一个控件调用显示方法，并且呈现的输出被写入页面响应属性中的 OutputStream 类。</p>
<p>** PreRender**</p>
<p>PreRender 事件就在输出显示之前发生。通过处理此事件，页面和控件可以在输出显示之前执行任何更新。</p>
<p>** PreRenderComplete**</p>
<p>当 PreRender 事件为所有子控件被循环引发，此事件确保了显示前阶段的完成</p>
<p>** SaveStateComplete**</p>
<p>页面控件状态被保存。个性化、控件状态以及视图状态信息被保存。</p>
<h3 id="8、卸载页面"><a href="#8、卸载页面" class="headerlink" title="8、卸载页面"></a>8、卸载页面</h3><p>显示过的页面被送达客户端以及页面属性，例如响应和请求，被卸载并全部清除完毕。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/zhaoyang/archive/2011/11/16/2251200.html">用三张图片详解Asp.Net 全生命周期</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/edisonchou/p/4216337.html">ASP.Net请求处理机制初步探索之旅 - Part 4 WebForm页面生命周期</a></p>
<p><a target="_blank" rel="noopener" href="https://www.w3cschool.cn/aspnet/1wiv1j2g.html">ASP.NET 页面生命周期</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/28318813">Asp.Net WebForm生命周期的详解</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/02/17/ASP-NET%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E7%AE%A1%E9%81%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/17/ASP-NET%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E7%AE%A1%E9%81%93/" class="post-title-link" itemprop="url">ASP.NET请求处理管道</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-17 09:49:32" itemprop="dateCreated datePublished" datetime="2019-02-17T09:49:32+00:00">2019-02-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-23 01:07:22" itemprop="dateModified" datetime="2021-04-23T01:07:22+00:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ASP-NET-IIS%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E7%AE%A1%E9%81%93/" itemprop="url" rel="index"><span itemprop="name">ASP.NET/IIS请求处理管道</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/img/2012071209470854.png" alt="2012071209470854.png"></p>
<p>IIS 6.X和IIS7经典模式，采用aspnet_isapi.dll来响应请求；<br>IIS7集成模式则执行单独的管道；</p>
<p>注：<font color=#ff0000 size=4 face="黑体">ASP.NET WebForm和ASP.NET MVC 同用一套请求处理管道。</font></p>
<h2 id="创建HttpApplication"><a href="#创建HttpApplication" class="headerlink" title="创建HttpApplication"></a>创建HttpApplication</h2><p>创建 <code>HttpApplication</code>（即w3wp.exe）对象的时候，先去对象池中查找，没有则创建（编译Global.asax,创建HttpApplication对象），找到则直接返回对象。</p>
<p>HttpApplication的工作包括：</p>
<p>● 初始化的时候加载全部的HttpModule<br>● 接收请求<br>● 在不同阶段引发不同的事件，使得HttpModule通过订阅事件的方式加入到请求的处理过程中<br>● 在一个特定阶段获取一个IHttpHandler实例，最终将请求交给具体的IHttpHandler来实现</p>
<p><code>HttpApplication</code> 创建之后，则是ASP.NET请求处理管道。</p>
<h3 id="HttpModules-amp-HttpHandlers"><a href="#HttpModules-amp-HttpHandlers" class="headerlink" title="HttpModules &amp; HttpHandlers"></a>HttpModules &amp; HttpHandlers</h3><p>** HttpModules**</p>
<p>所有的HttpModules都实现了IHttpModule接口,可以实现 <code>IHttpModule</code> 接口自定义 <code>HttpModule</code>。</p>
<p>** HttpHandlers**</p>
<p>当某个请求与一个规则匹配后，ASP.NET会调用匹配的HttpHandlerFactory的GetHandler方法来获取一个HttpHandler实例， 最后由一个HttpHandler实例来处理当前请求，生成响应内容</p>
<p>所有的 <code>HttpHandlers</code> 都实现了 <code>IHttpHandler</code> 接口,可以实现 <code>IHttpHandler</code> 接口自定义 <code>HttpHandler</code>。</p>
<p>如图：</p>
<p><img src="/img/190047183794497.png" alt="190047183794497.png"></p>
<h2 id="Asp-Net请求处理事件"><a href="#Asp-Net请求处理事件" class="headerlink" title="Asp.Net请求处理事件"></a>Asp.Net请求处理事件</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、BeginRequest：HTTP管道开始处理请求时，会触发BeginRequest事件</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、AuthenticateRequest：安全模块对请求进行身份验证时触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、PostAuthenticateRequest：安全模块对请求进行身份验证后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、AuthorizeRequest：安全模块对请求进程授权时触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、PostAuthorizeRequest：安全模块对请求进程授权后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>、ResolveRequestCache：缓存模块利用缓存直接对请求进程响应时触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">7</span>、PostResolveRequestCache：缓存模块利用缓存直接对请求进程响应后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">8</span>、PostMapRequestHandler：对于访问不同的资源类型，ASP.NET具有不同的HttpHandler对其进程处理。</span><br><span class="line">对于每个请求，ASP.NET会根据扩展名选择匹配相应的HttpHandler类型，成功匹配后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">9</span>、AcquireRequestState：状态管理模块获取基于当前请求相应的状态(比如SessionState)时触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">10</span>、PostAcquireRequestState：状态管理模块获取基于当前请求相应的状态(比如SessionState)后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">11</span>、PreRequestHandlerExecute：在实行HttpHandler前触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">12</span>、PostRequestHandlerExecute：在实行HttpHandler后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">13</span>、ReleaseRequestState：状态管理模块释放基于当前请求相应的状态时触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">14</span>、PostReleaseRequestState：状态管理模块释放基于当前请求相应的状态后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>、UpdateRequestCache：缓存模块将HttpHandler处理请求得到的相应保存到输出缓存时触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">16</span>、PostUpdateRequestCache：缓存模块将HttpHandler处理请求得到的相应保存到输出缓存后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">17</span>、LogRequest：为当前请求进程日志记录时触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">18</span>、PostLogReques：为当前请求进程日志记录后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">19</span>、EndRequest：整个请求处理完成后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">20</span>、PreSendRequestHeaders：.Net4<span class="number">.0</span>新增，可以根据发送的Header设置一些参数，</span><br><span class="line">例如，设置一个特殊的Header通知浏览器启用压缩来提高网络传输速度</span><br><span class="line"></span><br><span class="line"><span class="number">21</span>、PreSendRequestContent：.Net4<span class="number">.0</span>新增，恰好在 ASP.NET 向客户端发送内容之前发生。</span><br><span class="line">例如，在此事件压缩输出到浏览器的流。</span><br></pre></td></tr></table></figure>

<p><font color=##ff0000 size=4 face="黑体">webform 和 mvc 共用一套管道，在第7个事件 <code>PostResolveRequestCache</code> 会根据Url去路由表匹配所有的路由规则，<br>如果匹配到了路由，则证明请求是MVC程序,反之，则是WebForm。</font></p>
<h2 id="WebForm-管道事件摘要"><a href="#WebForm-管道事件摘要" class="headerlink" title="WebForm 管道事件摘要"></a>WebForm 管道事件摘要</h2><p>1，第八个事件 <code>PostMapRequestHandler</code> 创建Page类对象并转换为IHttpHandler接口。</p>
<p>在这个事件中，对于访问不同的资源类型，ASP.NET具有不同的HttpHandler对其进程处理。对于每个请求，ASP.NET会通过扩展名选择匹配相应的HttpHandler类型，成功匹配后，该实现被触发。因此，如果请求的扩展名是.aspx，便会生成Page类对象，而Page类对象是实现了IHttpHandler接口的。</p>
<p>2，在第九个到第十事件之间根据SessionId获取Session</p>
<p>第九到第十个事件是：<code>AcquireRequestState</code>，<code>PostAcquireRequestState</code>。</p>
<p>这期间首先会接收到浏览器发过来的SessionId，然后先会将IHttpHandler接口尝试转换为IRequiresSessionState接口，如果转换成功，ASP.NET会根据这个SessionId到服务器的Session池中去查找所对应的Session对象，并将这个Session对象赋值到HttpContext对象的Session属性。如果尝试转换为IRequiresSessionState接口不成功，则不加载Session。</p>
<p>3，在第十一个事件与第十二个事件之间执行页面生命周期</p>
<p>第十一和第十二个事件是：<code>PreRequestHandlerExecute</code>，<code>PostRequestHandlerExecute</code>。在这两个事件之间，ASP.NET最终通过请求资源类型相对应的HttpHandler实现对请求的处理，其实现方式是调用在第八个事件创建的页面对象的ProcessRequest方法。</p>
<p><img src="/img/051837105625665.jpg" alt="051837105625665.jpg"></p>
<p>在 <code>FrameworkInitialize()</code> 这个方法内部就开始打造WebForm的页面控件树，在其中调用了ProcessRequestMain方法，在这个方法里面就执行了整个ASP.NET WebFom页面生命周期。</p>
<h2 id="MVC-管道事件摘要"><a href="#MVC-管道事件摘要" class="headerlink" title="MVC 管道事件摘要"></a>MVC 管道事件摘要</h2><p>在ASP.NET MVC中，最核心的当属“路由系统”，而路由系统的核心则源于一个强大的 <code>System.Web.Routing.dll</code> 组件。</p>
<p><font color=##ff0000 size=4 face="黑体">在这个System.Web.Routing.dll中，有一个最重要的类叫做UrlRoutingModule , ASP.NET MVC的入口在 <code>UrlRoutingModule</code>，它是一个实现了<code>IHttpModule</code> 接口的类,订阅了 <code>HttpApplication</code> 的第7个管道事件 <code>PostResolveRequestCahce</code> 对请求进行了拦截。</font></p>
<p>1,IIS网站的配置可以分为两个块：全局 Web.config 和本站 Web.config。Asp.Net Routing属于全局性的，所以它配置在全局Web.Config 中，我们可以在如下路径中找到：“$\Windows\Microsoft.NET\Framework\版本号\Config\Web.config“</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line"> &lt;!-- the root web configuration file --&gt;</span><br><span class="line"> &lt;configuration&gt;</span><br><span class="line">     &lt;system.web&gt;</span><br><span class="line">         &lt;httpModules&gt;</span><br><span class="line">             &lt;<span class="keyword">add</span> name=<span class="string">&quot;UrlRoutingModule-4.0&quot;</span> type=<span class="string">&quot;System.Web.Routing.UrlRoutingModule&quot;</span> /&gt;</span><br><span class="line">         &lt;/httpModules&gt;</span><br><span class="line">    &lt;/system.web&gt;</span><br><span class="line"> &lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<p>2,通过在全局Web.Config中注册 <code>System.Web.Routing.UrlRoutingModule</code>，IIS请求处理管道接到请求后，就会加载 UrlRoutingModule类型的Init()方法，第7个管道事件 <code>PostResolveRequestCahce</code> 对请求进行了拦截。</p>
<p>3,在第七个事件中创建实现了IHttpHandler接口的MvcHandler</p>
<p>第七个事件：<code>PostResolveRequestCache</code></p>
<p>当请求到达 <code>UrlRoutingModule</code> 的时候，<code>UrlRoutingModule</code> 取出请求中的 Controller、Action等RouteData信息，与路由表中的所有规则进行匹配，若匹配，把请求交给 <code>IRouteHandler</code>，即 <code>MVCRouteHandler</code>。我们可以看下<code>UrlRoutingModule</code> 的源码来看看，以下是几句核心的代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PostResolveRequestCache</span>(<span class="params">HttpContextBase context</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 通过RouteCollection的静态方法GetRouteData获取到封装路由信息的RouteData实例</span></span><br><span class="line">    RouteData routeData = <span class="keyword">this</span>.RouteCollection.GetRouteData(context);</span><br><span class="line">    <span class="keyword">if</span> (routeData != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 再从RouteData中获取MVCRouteHandler</span></span><br><span class="line">        IRouteHandler routeHandler = routeData.RouteHandler;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (!(routeHandler <span class="keyword">is</span> StopRoutingHandler))</span><br><span class="line">        &#123;</span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">// 调用 IRouteHandler.GetHttpHandler()，获取的IHttpHandler 类型实例，它是由 IRouteHandler.GetHttpHandler获取的</span></span><br><span class="line">            IHttpHandler httpHandler = routeHandler.GetHttpHandler(requestContext);</span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">// 合适条件下，把之前将获取的IHttpHandler 类型实例 映射到IIS HTTP处理管道中</span></span><br><span class="line">            context.RemapHandler(httpHandler);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MVCRouteHandler</code> 的作用是用来生成实现 <code>IHttpHandler</code> 接口的 <code>MvcHandler</code>：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">System.Web.Routing</span></span><br><span class="line">&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRouteHandler</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">IHttpHandler <span class="title">GetHttpHandler</span>(<span class="params">RequestContext requestContext</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取 <code>MvcRouteHadnler</code> :</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 继承HttpApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MvcApplication</span> : <span class="title">System.Web.HttpApplication</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 第一个管道事件</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Application_Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//注册路由</span></span><br><span class="line">        RouteConfig.RegisterRoutes(RouteTable.Routes);</span><br><span class="line">        BundleConfig.RegisterBundles(BundleTable.Bundles);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RouteConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RegisterRoutes</span>(<span class="params">RouteCollection routes</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        routes.IgnoreRoute(<span class="string">&quot;&#123;resource&#125;.axd/&#123;*pathInfo&#125;&quot;</span>);</span><br><span class="line">        <span class="comment">// MapRoute位于System.Web.Mvc.RouteCollectionExtensions</span></span><br><span class="line">        routes.MapRoute(</span><br><span class="line">            name: <span class="string">&quot;Default&quot;</span>,</span><br><span class="line">            url: <span class="string">&quot;&#123;controller&#125;/&#123;action&#125;/&#123;id&#125;&quot;</span>,</span><br><span class="line">            defaults: <span class="keyword">new</span> &#123; controller = <span class="string">&quot;Home&quot;</span>, action = <span class="string">&quot;Index&quot;</span>, id = UrlParameter.Optional &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// System.Web.Mvc.RouteCollectionExtensions 扩展方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Route <span class="title">MapRoute</span>(<span class="params"><span class="keyword">this</span> RouteCollection routes, <span class="built_in">string</span> name, <span class="built_in">string</span> url, <span class="built_in">object</span> defaults, <span class="built_in">object</span> constraints, <span class="built_in">string</span>[] namespaces</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">　　　<span class="comment">// 通过Route类的构造函数把 MvcRouteHandler 注入到路由中</span></span><br><span class="line">    Route route = <span class="keyword">new</span> Route(url, <span class="keyword">new</span> MvcRouteHandler())             &#123;</span><br><span class="line">        Defaults = <span class="keyword">new</span> RouteValueDictionary(defaults),</span><br><span class="line">        Constraints = <span class="keyword">new</span> RouteValueDictionary(constraints),</span><br><span class="line">        DataTokens = <span class="keyword">new</span> RouteValueDictionary()</span><br><span class="line">    &#125;;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> route;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在第11和第12个事件之间调用了 <code>MvcHandler</code> 的 <code>ProcessRequest</code> 方法处理ASP.NET MVC。</p>
<p>第十一和第十二个事件是：<code>PreRequestHandlerExecute</code>，<code>PostRequestHandlerExecute</code>。</p>
<p>获取 <code>MvcHandler</code>:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">IHttpHandler httpHandler = routeHandler.GetHttpHandler(requestContext);</span><br><span class="line">context.RemapHandler(httpHandler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// MvcHandlerd的实现</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> IHttpHandler <span class="title">GetHttpHandler</span>(<span class="params">RequestContext requestContext</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">　　requestContext.HttpContext.SetSessionStateBehavior(GetSessionStateBehavior(requestContext));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MvcHandler(requestContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如图：</p>
<p><img src="/img/190104512548523.png" alt="190104512548523.png"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/artech/archive/2009/06/20/1507165.html">再谈IIS与ASP.NET管道</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhangyihui/p/5082394.html">【深入ASP.NET原理系列】–ASP.NET请求管道、应用程序生命周期、整体运行机制</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/darrenji/p/3795661.html">ASP.NET MVC请求处理管道生命周期的19个关键环节(1-6)</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/darrenji/p/3795676.html">ASP.NET MVC请求处理管道生命周期的19个关键环节(7-12)</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/edisonchou/p/4201855.html">ASP.Net请求处理机制初步探索之旅 - Part 3 管道</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/17/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><span class="page-number current">18</span><a class="page-number" href="/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" href="/page/19/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">syxdevcode</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">394</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">173</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/syxdevcode" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;syxdevcode" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">syxdevcode</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
