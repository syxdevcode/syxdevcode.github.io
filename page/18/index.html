<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"syxdevcode.github.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="syxdevcode博客">
<meta property="og:url" content="https://syxdevcode.github.com/page/18/index.html">
<meta property="og:site_name" content="syxdevcode博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="syxdevcode">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://syxdevcode.github.com/page/18/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>syxdevcode博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">syxdevcode博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/syxdevcode" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/03/03/%E6%B5%8B%E8%AF%95%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-TDD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/03/%E6%B5%8B%E8%AF%95%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-TDD/" class="post-title-link" itemprop="url">测试驱动开发-TDD</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-03 09:32:43" itemprop="dateCreated datePublished" datetime="2019-03-03T09:32:43+00:00">2019-03-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-14 09:41:31" itemprop="dateModified" datetime="2021-04-14T09:41:31+00:00">2021-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TDD/" itemprop="url" rel="index"><span itemprop="name">TDD</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>测试驱动开发-TDD,编写易于测试的代码。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/03/03/%E6%B5%8B%E8%AF%95%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-TDD/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/03/01/%E7%BD%91%E9%A1%B5%E6%BB%9A%E5%8A%A8%E5%88%B0%E9%A1%B6%E9%83%A8%E7%89%B9%E6%95%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/01/%E7%BD%91%E9%A1%B5%E6%BB%9A%E5%8A%A8%E5%88%B0%E9%A1%B6%E9%83%A8%E7%89%B9%E6%95%88/" class="post-title-link" itemprop="url">网页滚动到顶部特效</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-01 10:20:42" itemprop="dateCreated datePublished" datetime="2019-03-01T10:20:42+00:00">2019-03-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-14 09:41:31" itemprop="dateModified" datetime="2021-04-14T09:41:31+00:00">2021-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript-JQuery/" itemprop="url" rel="index"><span itemprop="name">JavaScript/JQuery</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>点击图标，实现网页滚动到顶部特效</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/03/01/%E7%BD%91%E9%A1%B5%E6%BB%9A%E5%8A%A8%E5%88%B0%E9%A1%B6%E9%83%A8%E7%89%B9%E6%95%88/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/02/19/ASP-NET-MVC-%E9%A1%B5%E9%9D%A2%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/19/ASP-NET-MVC-%E9%A1%B5%E9%9D%A2%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" class="post-title-link" itemprop="url">ASP.NET MVC 页面生命周期</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-19 15:10:11" itemprop="dateCreated datePublished" datetime="2019-02-19T15:10:11+00:00">2019-02-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-14 09:41:31" itemprop="dateModified" datetime="2021-04-14T09:41:31+00:00">2021-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MVC-Web-API/" itemprop="url" rel="index"><span itemprop="name">MVC/Web API</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ASP-NET-MVC-页面生命周期"><a href="#ASP-NET-MVC-页面生命周期" class="headerlink" title="ASP.NET MVC 页面生命周期"></a>ASP.NET MVC 页面生命周期</h1><p>整个ASP.NET MVC框架是通过自定义的 <code>HttpModule</code> 和 <code>HttpHandler</code> 对ASP.NET 进行扩展构建起来的。</p>
<ul>
<li>自定义的 <code>HttpModule</code> : <code>UrlRoutingModule</code></li>
<li>自定义的 <code>HttpHandler</code>: <code>MvcHandler</code></li>
</ul>
<p><img src="/img/1458860-5d9e4724f9e32ccb.png" alt="1458860-5d9e4724f9e32ccb.png"></p>
<p><img src="/img/190104561291113.png" alt="190104561291113.png"></p>
<h2 id="HttpApplication与HttpModule"><a href="#HttpApplication与HttpModule" class="headerlink" title="HttpApplication与HttpModule"></a>HttpApplication与HttpModule</h2><p>HTTP请求由ASP.NET运行时接管之后，<code>HttpRuntime</code> 会利用 <code>HttpApplicationFactory</code> 创建或从 <code>HttpApplication</code>对象池中取出一个<code>HttpApplication</code>对象，同时ASP.NET会根据配置文件来初始化注册的<code>HttpModule</code>，<code>HttpModule</code>在初始化时会订阅<code>HttpApplication</code>中的事件来实现对HTTP请求的处理。</p>
<p><img src="/img/190047183794497.png" alt="190047183794497.png"></p>
<p><font color=#ff0000 size=4 face="黑体">ASP.NET MVC的入口在<code>UrlRoutingModule</code>,它订阅了<code>HttpApplication</code>的第7个管道事件<code>PostResolveRequestCahce</code>，并且在<code>HtttpApplication</code>的第7个管道事件处对请求进行了拦截。</font></p>
<h2 id="UrlRoutingModule"><a href="#UrlRoutingModule" class="headerlink" title="UrlRoutingModule"></a>UrlRoutingModule</h2><p>通过在全局Web.Config中注册 <code>System.Web.Routing.UrlRoutingModule</code>，IIS请求处理管道接到请求后，就会加载 <code>UrlRoutingModule</code>类型的Init()方法，第7个管道事件 <code>PostResolveRequestCahce</code> 对请求进行了拦截。</p>
<p>当请求到达 <code>UrlRoutingModule</code> 的时候，<code>UrlRoutingModule</code> 取出请求中的 Controller、Action等RouteData信息，与路由表中的所有规则进行匹配，若匹配，把请求交给 <code>IRouteHandler</code>，即 <code>MVCRouteHandler</code>。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过RouteCollection的静态方法GetRouteData获取到封装路由信息的RouteData实例</span></span><br><span class="line">RouteData routeData = <span class="keyword">this</span>.RouteCollection.GetRouteData(context);</span><br><span class="line"></span><br><span class="line"><span class="comment">//再从RouteData中获取MVCRouteHandler</span></span><br><span class="line">IRouteHandler routeHandler = routeData.RouteHandler;</span><br></pre></td></tr></table></figure>

<h2 id="MVCRouteHadnler"><a href="#MVCRouteHadnler" class="headerlink" title="MVCRouteHadnler"></a>MVCRouteHadnler</h2><p><code>MvcRouteHandler</code> 在HttpApplication的第一个管道事件，使用 <code>MapRoute()</code> 方法注册路由的时候，通过<code>Route</code>类的构造函数把<code>MVCRouteHandler</code>注入到路由中。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Route <span class="title">MapRoute</span>(<span class="params"><span class="keyword">this</span> RouteCollection routes, <span class="built_in">string</span> name, <span class="built_in">string</span> url, <span class="built_in">object</span> defaults, <span class="built_in">object</span> constraints, <span class="built_in">string</span>[] namespaces</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (routes == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">&quot;routes&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (url == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// MvcRouteHandler</span></span><br><span class="line">    Route route = <span class="keyword">new</span> Route(url, <span class="keyword">new</span> MvcRouteHandler()) &#123;</span><br><span class="line">        Defaults = <span class="keyword">new</span> RouteValueDictionary(defaults),</span><br><span class="line">        Constraints = <span class="keyword">new</span> RouteValueDictionary(constraints),</span><br><span class="line">        DataTokens = <span class="keyword">new</span> RouteValueDictionary()</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((namespaces != <span class="literal">null</span>) &amp;&amp; (namespaces.Length &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">        route.DataTokens[<span class="string">&quot;Namespaces&quot;</span>] = namespaces;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    routes.Add(name, route);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> route;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MVCRouteHandler</code>是用来生成实现<code>IHttpHandler</code>接口的<code>MvcHandler</code>。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">System.Web.Routing</span></span><br><span class="line">&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRouteHandler</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">IHttpHandler <span class="title">GetHttpHandler</span>(<span class="params">RequestContext requestContext</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MvcHandler"><a href="#MvcHandler" class="headerlink" title="MvcHandler"></a>MvcHandler</h2><p>第7个事件生成了 <code>MvcHandler</code>。</p>
<p>第11和第12个事件之间调用了<code>MvcHandler</code>的<code>ProcessRequest</code>方法。</p>
<p>通过<code>RouteHandler</code>的 <code>GetHttpHandler()</code>方法获取到实现了<code>IHttpHandler</code>接口的<code>MVCHandler</code>。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IHttpHandler httpHandler = routeHandler.GetHttpHandler(requestContext);</span><br><span class="line">context.RemapHandler(httpHandler);</span><br></pre></td></tr></table></figure>

<p><code>MvcHandler</code> 部分源码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MvcHandler</span> : <span class="title">IHttpAsyncHandler</span>, <span class="title">IHttpHandler</span>, <span class="title">IRequiresSessionState</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">internal</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ProcessRequest</span>(<span class="params">HttpContextBase httpContext</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        SecurityUtil.ProcessInApplicationTrust(() =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            IController controller;</span><br><span class="line">            IControllerFactory factory;</span><br><span class="line">            ProcessRequestInit(httpContext, <span class="keyword">out</span> controller, <span class="keyword">out</span> factory);<span class="comment">//初始化了ControllerFactory</span></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                controller.Execute(RequestContext);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                factory.ReleaseController(controller);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ProcessRequestInit</span>(<span class="params">HttpContextBase httpContext, <span class="keyword">out</span> IController controller, <span class="keyword">out</span> IControllerFactory factory</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">bool</span>? isRequestValidationEnabled = ValidationUtility.IsValidationEnabled(HttpContext.Current);</span><br><span class="line">        <span class="keyword">if</span> (isRequestValidationEnabled == <span class="literal">true</span>) &#123;</span><br><span class="line">            ValidationUtility.EnableDynamicValidation(HttpContext.Current);</span><br><span class="line">        &#125;</span><br><span class="line">        AddVersionHeader(httpContext);</span><br><span class="line">        RemoveOptionalRoutingParameters();</span><br><span class="line">        <span class="built_in">string</span> controllerName = RequestContext.RouteData.GetRequiredString(<span class="string">&quot;controller&quot;</span>);</span><br><span class="line">        factory = ControllerBuilder.GetControllerFactory();</span><br><span class="line">        controller = factory.CreateController(RequestContext, controllerName);</span><br><span class="line">        <span class="keyword">if</span> (controller == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(String.Format(CultureInfo.CurrentCulture,MvcResources.ControllerBuilder_FactoryReturnedNull,factory.GetType(),controllerName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ControllerFactory"><a href="#ControllerFactory" class="headerlink" title="ControllerFactory"></a>ControllerFactory</h2><p>通过<code>ControllerBuilder</code>的静态方法<code>GetControllerFactory</code>获取到实现<code>IControllerFactory</code>接口的<code>ControllerFactory</code>。通过<code>ControllerFactory</code>来创建指定名称的控制器，最后将控制器作为out参数传递出去。</p>
<h2 id="ActionInvoker"><a href="#ActionInvoker" class="headerlink" title="ActionInvoker"></a>ActionInvoker</h2><p>ActionInvoker实现了IActionInvoker接口：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IActionInvoker</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="built_in">bool</span> <span class="title">InvokeAction</span>(<span class="params">ControllerContext controllerContext, <span class="built_in">string</span> actionName</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MVC默认的ActionInvoker是ControllerActionInvoker。</p>
<p>ActionInvoker在执行InvokeAction()方法时会需要有关Controller和Action的相关信息，实际上，Controller信息(比如Controller的名称、类型、包含的Action等)被封装在ControllerDescriptor这个类中，Action信息(比如Action的名称、参数、属性、过滤器等)被封装在ActionDescriptor中。ActionDescriptor还提供了一个FindAction()方法，用来找到需要被执行的Action。</p>
<h2 id="Filters"><a href="#Filters" class="headerlink" title="Filters"></a>Filters</h2><p>Filter-&gt;Action-&gt;Filter-&gt;Result</p>
<p>在ASP.NET MVC5中有常用的过滤器有5个：<code>IAuthenticationFilter</code>、<code>IAuthorizationFilter</code>、<code>IActionFilter</code>、<code>IResultFilter</code>、<code>IExceptionFilter</code>。<br>在ASP.NET MVC中所有的过滤器最终都会被封装为Filter对象，该对象中FilterScope类型的属性Scope和int类型属性Order用于决定过滤器执行的先后顺序，具体规则如下：</p>
<ul>
<li>Order和FilterScope的数值越小，过滤器的执行优先级越高；</li>
<li>Order比FilterScope具有更高的优先级，在Order属性值相同时FilterScope才会被考虑</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//数值越小，执行优先级越高</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> FilterScope</span><br><span class="line">&#123;</span><br><span class="line">    Action= <span class="number">30</span>,</span><br><span class="line">    Controller= <span class="number">20</span>,</span><br><span class="line">    First= <span class="number">0</span>,</span><br><span class="line">    Global= <span class="number">10</span>,</span><br><span class="line">    Last= <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ActionResult"><a href="#ActionResult" class="headerlink" title="ActionResult"></a>ActionResult</h2><p>ActionResult是一个抽象类：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">ActionResult</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">ExecuteResult</span>(<span class="params">ControllerContext context</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果ActionResult是非ViewResult，比如JsonResult, ContentResult，这些内容将直接被输送到Response响应流中，显示给客户端；如果是ViewResult，就会进入下一个渲染视图环节。</p>
<h2 id="ViewEngine"><a href="#ViewEngine" class="headerlink" title="ViewEngine"></a>ViewEngine</h2><p>默认的有<code>Razor View Engine</code>和<code>Web Form View Engine</code>，实现IViewEngine接口。</p>
<p>IViewEngine接口方法：</p>
<ul>
<li>FindPartialView</li>
<li>FindView</li>
<li>ReleaseView</li>
</ul>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Cwj-XFH/p/6752177.html">ASP.NET MVC5请求管道和生命周期</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/edisonchou/p/4226558.html">ASP.Net请求处理机制初步探索之旅 - Part 5 ASP.Net MVC请求处理流程</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/darrenji/p/3795690.html">ASP.NET MVC请求处理管道生命周期的19个关键环节(13-19)</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/artech/archive/2012/04/10/how-mvc-works.html">How ASP.NET MVC Works?</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/artech/archive/2012/08/06/action-filter.html">ASP.NET MVC中的ActionFilter是如何执行的？</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/artech/archive/2012/07/02/AuthorizationFilter.html">认识ASP.NET MVC的5种AuthorizationFilter</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/artech/archive/2012/08/22/view-engine-01.html">ASP.NET MVC的View是如何被呈现出来的？[设计篇]</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/artech/archive/2012/08/23/view-engine-02.html">ASP.NET MVC的View是如何呈现出来的[实例篇]</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/02/19/WebForm%E4%B9%8BViewState%E4%B8%8EUpdatePannel%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/19/WebForm%E4%B9%8BViewState%E4%B8%8EUpdatePannel%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">WebForm之ViewState与UpdatePannel详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-19 14:16:35" itemprop="dateCreated datePublished" datetime="2019-02-19T14:16:35+00:00">2019-02-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-14 09:41:31" itemprop="dateModified" datetime="2021-04-14T09:41:31+00:00">2021-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WebForm/" itemprop="url" rel="index"><span itemprop="name">WebForm</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="WebForm之ViewState与UpdatePannel详解"><a href="#WebForm之ViewState与UpdatePannel详解" class="headerlink" title="WebForm之ViewState与UpdatePannel详解"></a>WebForm之ViewState与UpdatePannel详解</h1><h2 id="ViewState"><a href="#ViewState" class="headerlink" title="ViewState"></a>ViewState</h2><h3 id="ViewState简介"><a href="#ViewState简介" class="headerlink" title="ViewState简介"></a>ViewState简介</h3><p>1,类似于Dictionary的一种数据结构</p>
<p>ViewState通过String类型的数据作为索引。ViewState对应项中的值可以存储任何类型的值（参数是Object类型），任何类型的值存储到ViewState中都会被装箱为Object类型。</p>
<p>注：ViewState不能存储所有的数据类型，仅支持以下的这几种：<br>String、Integer、Boolean、Array、ArrayList、Hashtable以及一些自定义类型。</p>
<p>2，ViewState存储在浏览器的页面之中</p>
<p>ViewState的作用域是页面，消耗服务器资源相对较少。</p>
<p>服务器在向浏览器返回html之前，对ViewState中的内容进行了Base64的加密编码。VIEWSTATE适用于同一个页面在不关闭的情况下多次与服务器交互（PostBack）</p>
<p>当用户点击页面中的某个按钮提交表单时，浏览器会将这个_VIEWSTATE的隐藏域也一起提交到服务端；服务器端在解析请求时，会将浏览器提交过来的ViewState进行反序列化后填充到ViewState属性中；再根据业务处理需要，从这个属性中根据索引找到具体的Value值并对其进行操作；操作完成后，再将ViewState进行Base64编码再次返回给浏览器端；</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;__VIEWSTATE&quot;</span> id=<span class="string">&quot;__VIEWSTATE&quot;</span> <span class="keyword">value</span>=<span class="string">&quot;/wEPDwUKLTg4NTU3NzYwOGRkbQwtdx3+TX000hqmVYIcP3+P3zcihvV0deiDjaSgFRQ=&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<h3 id="ViewState存在的问题"><a href="#ViewState存在的问题" class="headerlink" title="ViewState存在的问题"></a>ViewState存在的问题</h3><p>当 <code>Repeater</code>等控件使用时，存储较大的值，用户请求显示页面的速度会减慢。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;__VIEWSTATE&quot;</span> id=<span class="string">&quot;__VIEWSTATE&quot;</span> <span class="keyword">value</span>=<span class="string">&quot;/wEPDwUJLTQ2OTExMTk1D2QWAgIBD2QWBAIBDxAPFgYeDkRhdGFWYWx1ZUZpZWxkBQJJRB4NRGF0YVRleHRGaWVsZAUETmFtZR4LXyFEYXRhQm91vZflubPop4Lpn7PooZfmsp/pgJoxMDDljoUn5LqR5Y2X6L+q5L+h6YCa572X5bmz6LSi5a+M5rKf6YCaMTAw5Y6FKuS6keWNl+i/quS/oUCBTExNDczBTExNDczZAIDDw8WAh8FBQUxMTQ3M2RkAgUPDxYCHwUFCzE4Mzg4MDM4MTY1ZGQCBQ8PFgIeC1JlY29yZGNvdW50AvIDZGRkmmJuzxcRIKhlTny8ibiHOR92G/JYSgGwzO69sFxoLV8=&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<h3 id="禁用ViewState"><a href="#禁用ViewState" class="headerlink" title="禁用ViewState"></a>禁用ViewState</h3><p>1,页面级禁用，在Page指令集中添加EnableViewState=”false”。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ Page Language=<span class="string">&quot;C#&quot;</span> AutoEventWireup=<span class="string">&quot;true&quot;</span> CodeBehind=<span class="string">&quot;RepeaterViewState.aspx.cs&quot;</span></span><br><span class="line">    Inherits=<span class="string">&quot;WebForm1.RepeaterViewState&quot;</span> EnableViewState=<span class="string">&quot;false&quot;</span> %&gt;</span><br></pre></td></tr></table></figure>

<p>注：禁用之后页面依然存在ViewState，但数据量已经减小。</p>
<p>2，控件级禁用ViewState</p>
<p>控件设置一个属性EnableViewState=”false”。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;asp:Repeater ID=<span class="string">&quot;repeaterProducts&quot;</span> runat=<span class="string">&quot;server&quot;</span> EnableViewState=<span class="string">&quot;false&quot;</span>&gt;</span><br><span class="line">&lt;/asp:Repeater&gt;</span><br></pre></td></tr></table></figure>

<p>3,全局级禁用ViewState</p>
<p>Web.config的system.web中增加一句配置</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;pages enableViewState=<span class="string">&quot;false&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<p>4,单独控制禁用与启用</p>
<p>ASP.NET4.0之前，控件的视图只有在 Page 的 ViewState 启用的前提下才可以单独控制。</p>
<p>ASP.NET4.0供了一个叫做 ViewStateMode 的新属性，这个属性可以单独设置控件的视图状态。即使页面的 <code>ViewState</code> 没有启用，控件依然可以启用视图状态。</p>
<p>ViewStateMode 属性有三种取值：</p>
<ul>
<li>Inherit：视图状态从父控件继承；</li>
<li>Enabled：即使父控件的视图状态没有启用，也启用该控件的视图状态；</li>
<li>Disabled：即使父控件的视图状态启用了，也禁用此控件的视图状态。</li>
</ul>
<h2 id="UpdatePanel控件"><a href="#UpdatePanel控件" class="headerlink" title="UpdatePanel控件"></a>UpdatePanel控件</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> &lt;form id=<span class="string">&quot;form1&quot;</span> runat=<span class="string">&quot;server&quot;</span>&gt;</span><br><span class="line">    &lt;div align=<span class="string">&quot;center&quot;</span>&gt;</span><br><span class="line">        &lt;asp:ScriptManager ID=<span class="string">&quot;scriptManager&quot;</span> runat=<span class="string">&quot;server&quot;</span>&gt;</span><br><span class="line">        &lt;/asp:ScriptManager&gt;</span><br><span class="line">        &lt;asp:UpdatePanel ID=<span class="string">&quot;updatePanel&quot;</span> runat=<span class="string">&quot;server&quot;</span>&gt;</span><br><span class="line">            &lt;ContentTemplate&gt;</span><br><span class="line">                &lt;asp:TextBox ID=<span class="string">&quot;txtNumber1&quot;</span> runat=<span class="string">&quot;server&quot;</span>&gt;&lt;/asp:TextBox&gt;</span><br><span class="line">                &lt;asp:DropDownList ID=<span class="string">&quot;ddlFunc&quot;</span> runat=<span class="string">&quot;server&quot;</span>&gt;</span><br><span class="line">                    &lt;asp:ListItem Value=<span class="string">&quot;0&quot;</span>&gt;+&lt;/asp:ListItem&gt;</span><br><span class="line">                    &lt;asp:ListItem Value=<span class="string">&quot;1&quot;</span>&gt;-&lt;/asp:ListItem&gt;</span><br><span class="line">                    &lt;asp:ListItem Value=<span class="string">&quot;2&quot;</span>&gt;*&lt;/asp:ListItem&gt;</span><br><span class="line">                    &lt;asp:ListItem Value=<span class="string">&quot;3&quot;</span>&gt;/&lt;/asp:ListItem&gt;</span><br><span class="line">                &lt;/asp:DropDownList&gt;</span><br><span class="line">                &lt;asp:TextBox ID=<span class="string">&quot;txtNumber2&quot;</span> runat=<span class="string">&quot;server&quot;</span>&gt;&lt;/asp:TextBox&gt;</span><br><span class="line">                &lt;asp:Button ID=<span class="string">&quot;btnGetResult&quot;</span> runat=<span class="string">&quot;server&quot;</span> Text=<span class="string">&quot;=&quot;</span> Width=<span class="string">&quot;50&quot;</span> OnClick=<span class="string">&quot;btnGetResult_Click&quot;</span> /&gt;</span><br><span class="line">                &lt;asp:Label ID=<span class="string">&quot;lblResult&quot;</span> runat=<span class="string">&quot;server&quot;</span> Text=<span class="string">&quot;&quot;</span> Font-Bold=<span class="string">&quot;true&quot;</span>&gt;&lt;/asp:Label&gt;</span><br><span class="line">            &lt;/ContentTemplate&gt;</span><br><span class="line">        &lt;/asp:UpdatePanel&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<p>UpdatePanel本质封装了以XmlHttpRequest为核心的一系列方法帮我们将CodeBehind中的同步事件变为了异步操作，并通过DOM更新指定的HTML内容，使得我们可以方便地实现AJAX效果。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/edisonchou/p/3901559.html">ASP.Net WebForm温故知新学习笔记：二、ViewState与UpdatePanel探秘</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/freeflying/archive/2009/12/28/1634229.html">禁掉VIEWSTATE之后（一）</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/yukaizhao/archive/2010/05/22/asp-net-new-feature-pure-html.html">Asp.Net 4.0 新特性，输出更纯净的Html代码 ClientIDMode，ViewStateMode等</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/02/18/ASP-NET-WebForm%E9%A1%B5%E9%9D%A2%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/18/ASP-NET-WebForm%E9%A1%B5%E9%9D%A2%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" class="post-title-link" itemprop="url">ASP.NET WebForm页面生命周期</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-18 11:32:37" itemprop="dateCreated datePublished" datetime="2019-02-18T11:32:37+00:00">2019-02-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-14 09:41:31" itemprop="dateModified" datetime="2021-04-14T09:41:31+00:00">2021-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WebForm/" itemprop="url" rel="index"><span itemprop="name">WebForm</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ASP-NET-WebForm页面生命周期"><a href="#ASP-NET-WebForm页面生命周期" class="headerlink" title="ASP.NET WebForm页面生命周期"></a>ASP.NET WebForm页面生命周期</h1><h2 id="生命周期阶段"><a href="#生命周期阶段" class="headerlink" title="生命周期阶段"></a>生命周期阶段</h2><h3 id="1、请求页面"><a href="#1、请求页面" class="headerlink" title="1、请求页面"></a>1、请求页面</h3><p>页请求发生在页生命周期开始之前。</p>
<h3 id="2、开始阶段"><a href="#2、开始阶段" class="headerlink" title="2、开始阶段"></a>2、开始阶段</h3><p>1，Page类的ProcessRequest方法作为页面生命周期的入口；<br>2，BuildControlTree：构造页面控件树；<br>3，设置IsPostBack属性是否第一次请求该页面；</p>
<h3 id="3、初始化页面"><a href="#3、初始化页面" class="headerlink" title="3、初始化页面"></a>3、初始化页面</h3><p>页面初始化期间，可以使用页中的控件，并将设置每个控件的UniqueID属性。如果当前请求是回发请求，则回发数据尚未加载，并且控件属性值尚未还原为视图状态中的值。</p>
<p>事件：<code>PreInit--&gt;Init--&gt;InitComplete</code></p>
<p>** PreInit**</p>
<p>PreInit 是页面生命周期的第一个事件。它检查 IsPostBack 属性并决定页面是否是回发。它设置主题及主版页，创建动态控件，并且获取和设置值配置文件属性值。此事件可通过重载 OnPreInit 方法或者创建一个 Page_PreInit 处理程序进行处置。</p>
<p>** Init**</p>
<p>Init 事件初始化控件属性，并且建立控件树。此事件可通过重载 OnInit 方法或者创建一个 Page_Init处理程序进行处置。</p>
<p>** InitComplete**</p>
<p>InitComplete 事件允许对视图状态的跟踪。所有的控件开启视图状态下的跟踪。</p>
<h3 id="4、加载页面"><a href="#4、加载页面" class="headerlink" title="4、加载页面"></a>4、加载页面</h3><p>设置控件属性，使用视图状态和控件状态值。</p>
<p>事件：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">（LoadState--&gt;ProcessPostData--&gt;）PreLoad--&gt;Load--&gt;</span><br><span class="line">（ProcessPostData--&gt;RaiseChangedEvents--&gt;RaisePostBackEvent--&gt;）LoadComplete</span><br></pre></td></tr></table></figure>

<p>** LoadViewState**</p>
<p>允许加载视图状态信息到控件中。</p>
<p>** LoadPostData**</p>
<p>对所有由 \ 标签定义的输入字段的内容进行处理。</p>
<p>** PreLoad**</p>
<p>PreLoad 在回发数据加载在控件中之前发生。此事件可以通过重载 OnPreLoad 方法或者创建一个 Pre_Load 处理程序进行处置。</p>
<p>** Load **</p>
<p>Load 事件被页面最先引发，然后递归地引发所有子控件。控件树中的控件就被创建好了。此事件可通过重载 OnLoad 方法或者创建一个 Page_Load 处理程序来进行处置。</p>
<h3 id="5、验证"><a href="#5、验证" class="headerlink" title="5、验证"></a>5、验证</h3><p>在验证期间，将调用所有验证程序控件的Validate方法，此方法将设置各个验证程序控件和页的IsValid属性为 true。</p>
<p>** LoadComplete**</p>
<p>加载进程完成，控件事件处理程序运行，页面验证发生。此事件可通过重载 OnLoad 方法或者创建一个 Page_LoadComplete 处理程序来进行处置。</p>
<h3 id="6、回发事件处理"><a href="#6、回发事件处理" class="headerlink" title="6、回发事件处理"></a>6、回发事件处理</h3><p>如果请求是回发请求，则将调用所有事件处理程序。</p>
<h3 id="7、呈现页面"><a href="#7、呈现页面" class="headerlink" title="7、呈现页面"></a>7、呈现页面</h3><p>页面的视图状态和所有控件被保存。页面为每一个控件调用显示方法，并且呈现的输出被写入页面响应属性中的 OutputStream 类。</p>
<p>** PreRender**</p>
<p>PreRender 事件就在输出显示之前发生。通过处理此事件，页面和控件可以在输出显示之前执行任何更新。</p>
<p>** PreRenderComplete**</p>
<p>当 PreRender 事件为所有子控件被循环引发，此事件确保了显示前阶段的完成</p>
<p>** SaveStateComplete**</p>
<p>页面控件状态被保存。个性化、控件状态以及视图状态信息被保存。</p>
<h3 id="8、卸载页面"><a href="#8、卸载页面" class="headerlink" title="8、卸载页面"></a>8、卸载页面</h3><p>显示过的页面被送达客户端以及页面属性，例如响应和请求，被卸载并全部清除完毕。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/zhaoyang/archive/2011/11/16/2251200.html">用三张图片详解Asp.Net 全生命周期</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/edisonchou/p/4216337.html">ASP.Net请求处理机制初步探索之旅 - Part 4 WebForm页面生命周期</a></p>
<p><a target="_blank" rel="noopener" href="https://www.w3cschool.cn/aspnet/1wiv1j2g.html">ASP.NET 页面生命周期</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/28318813">Asp.Net WebForm生命周期的详解</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/02/17/ASP-NET%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E7%AE%A1%E9%81%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/17/ASP-NET%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E7%AE%A1%E9%81%93/" class="post-title-link" itemprop="url">ASP.NET请求处理管道</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-17 09:49:32" itemprop="dateCreated datePublished" datetime="2019-02-17T09:49:32+00:00">2019-02-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-14 09:41:31" itemprop="dateModified" datetime="2021-04-14T09:41:31+00:00">2021-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ASP-NET-IIS%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E7%AE%A1%E9%81%93/" itemprop="url" rel="index"><span itemprop="name">ASP.NET/IIS请求处理管道</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/img/2012071209470854.png" alt="2012071209470854.png"></p>
<p>IIS 6.X和IIS7经典模式，采用aspnet_isapi.dll来响应请求；<br>IIS7集成模式则执行单独的管道；</p>
<p>注：<font color=#ff0000 size=4 face="黑体">ASP.NET WebForm和ASP.NET MVC 同用一套请求处理管道。</font></p>
<h2 id="创建HttpApplication"><a href="#创建HttpApplication" class="headerlink" title="创建HttpApplication"></a>创建HttpApplication</h2><p>创建 <code>HttpApplication</code>（即w3wp.exe）对象的时候，先去对象池中查找，没有则创建（编译Global.asax,创建HttpApplication对象），找到则直接返回对象。</p>
<p>HttpApplication的工作包括：</p>
<p>● 初始化的时候加载全部的HttpModule<br>● 接收请求<br>● 在不同阶段引发不同的事件，使得HttpModule通过订阅事件的方式加入到请求的处理过程中<br>● 在一个特定阶段获取一个IHttpHandler实例，最终将请求交给具体的IHttpHandler来实现</p>
<p><code>HttpApplication</code> 创建之后，则是ASP.NET请求处理管道。</p>
<h3 id="HttpModules-amp-HttpHandlers"><a href="#HttpModules-amp-HttpHandlers" class="headerlink" title="HttpModules &amp; HttpHandlers"></a>HttpModules &amp; HttpHandlers</h3><p>** HttpModules**</p>
<p>所有的HttpModules都实现了IHttpModule接口,可以实现 <code>IHttpModule</code> 接口自定义 <code>HttpModule</code>。</p>
<p>** HttpHandlers**</p>
<p>当某个请求与一个规则匹配后，ASP.NET会调用匹配的HttpHandlerFactory的GetHandler方法来获取一个HttpHandler实例， 最后由一个HttpHandler实例来处理当前请求，生成响应内容</p>
<p>所有的 <code>HttpHandlers</code> 都实现了 <code>IHttpHandler</code> 接口,可以实现 <code>IHttpHandler</code> 接口自定义 <code>HttpHandler</code>。</p>
<p>如图：</p>
<p><img src="/img/190047183794497.png" alt="190047183794497.png"></p>
<h2 id="Asp-Net请求处理事件"><a href="#Asp-Net请求处理事件" class="headerlink" title="Asp.Net请求处理事件"></a>Asp.Net请求处理事件</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、BeginRequest：HTTP管道开始处理请求时，会触发BeginRequest事件</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、AuthenticateRequest：安全模块对请求进行身份验证时触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、PostAuthenticateRequest：安全模块对请求进行身份验证后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、AuthorizeRequest：安全模块对请求进程授权时触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、PostAuthorizeRequest：安全模块对请求进程授权后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>、ResolveRequestCache：缓存模块利用缓存直接对请求进程响应时触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">7</span>、PostResolveRequestCache：缓存模块利用缓存直接对请求进程响应后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">8</span>、PostMapRequestHandler：对于访问不同的资源类型，ASP.NET具有不同的HttpHandler对其进程处理。</span><br><span class="line">对于每个请求，ASP.NET会根据扩展名选择匹配相应的HttpHandler类型，成功匹配后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">9</span>、AcquireRequestState：状态管理模块获取基于当前请求相应的状态(比如SessionState)时触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">10</span>、PostAcquireRequestState：状态管理模块获取基于当前请求相应的状态(比如SessionState)后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">11</span>、PreRequestHandlerExecute：在实行HttpHandler前触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">12</span>、PostRequestHandlerExecute：在实行HttpHandler后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">13</span>、ReleaseRequestState：状态管理模块释放基于当前请求相应的状态时触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">14</span>、PostReleaseRequestState：状态管理模块释放基于当前请求相应的状态后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>、UpdateRequestCache：缓存模块将HttpHandler处理请求得到的相应保存到输出缓存时触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">16</span>、PostUpdateRequestCache：缓存模块将HttpHandler处理请求得到的相应保存到输出缓存后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">17</span>、LogRequest：为当前请求进程日志记录时触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">18</span>、PostLogReques：为当前请求进程日志记录后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">19</span>、EndRequest：整个请求处理完成后触发该事件</span><br><span class="line"></span><br><span class="line"><span class="number">20</span>、PreSendRequestHeaders：.Net4<span class="number">.0</span>新增，可以根据发送的Header设置一些参数，</span><br><span class="line">例如，设置一个特殊的Header通知浏览器启用压缩来提高网络传输速度</span><br><span class="line"></span><br><span class="line"><span class="number">21</span>、PreSendRequestContent：.Net4<span class="number">.0</span>新增，恰好在 ASP.NET 向客户端发送内容之前发生。</span><br><span class="line">例如，在此事件压缩输出到浏览器的流。</span><br></pre></td></tr></table></figure>

<p><font color=##ff0000 size=4 face="黑体">webform 和 mvc 共用一套管道，在第7个事件 <code>PostResolveRequestCache</code> 会根据Url去路由表匹配所有的路由规则，<br>如果匹配到了路由，则证明请求是MVC程序,反之，则是WebForm。</font></p>
<h2 id="WebForm-管道事件摘要"><a href="#WebForm-管道事件摘要" class="headerlink" title="WebForm 管道事件摘要"></a>WebForm 管道事件摘要</h2><p>1，第八个事件 <code>PostMapRequestHandler</code> 创建Page类对象并转换为IHttpHandler接口。</p>
<p>在这个事件中，对于访问不同的资源类型，ASP.NET具有不同的HttpHandler对其进程处理。对于每个请求，ASP.NET会通过扩展名选择匹配相应的HttpHandler类型，成功匹配后，该实现被触发。因此，如果请求的扩展名是.aspx，便会生成Page类对象，而Page类对象是实现了IHttpHandler接口的。</p>
<p>2，在第九个到第十事件之间根据SessionId获取Session</p>
<p>第九到第十个事件是：<code>AcquireRequestState</code>，<code>PostAcquireRequestState</code>。</p>
<p>这期间首先会接收到浏览器发过来的SessionId，然后先会将IHttpHandler接口尝试转换为IRequiresSessionState接口，如果转换成功，ASP.NET会根据这个SessionId到服务器的Session池中去查找所对应的Session对象，并将这个Session对象赋值到HttpContext对象的Session属性。如果尝试转换为IRequiresSessionState接口不成功，则不加载Session。</p>
<p>3，在第十一个事件与第十二个事件之间执行页面生命周期</p>
<p>第十一和第十二个事件是：<code>PreRequestHandlerExecute</code>，<code>PostRequestHandlerExecute</code>。在这两个事件之间，ASP.NET最终通过请求资源类型相对应的HttpHandler实现对请求的处理，其实现方式是调用在第八个事件创建的页面对象的ProcessRequest方法。</p>
<p><img src="/img/051837105625665.jpg" alt="051837105625665.jpg"></p>
<p>在 <code>FrameworkInitialize()</code> 这个方法内部就开始打造WebForm的页面控件树，在其中调用了ProcessRequestMain方法，在这个方法里面就执行了整个ASP.NET WebFom页面生命周期。</p>
<h2 id="MVC-管道事件摘要"><a href="#MVC-管道事件摘要" class="headerlink" title="MVC 管道事件摘要"></a>MVC 管道事件摘要</h2><p>在ASP.NET MVC中，最核心的当属“路由系统”，而路由系统的核心则源于一个强大的 <code>System.Web.Routing.dll</code> 组件。</p>
<p><font color=##ff0000 size=4 face="黑体">在这个System.Web.Routing.dll中，有一个最重要的类叫做UrlRoutingModule , ASP.NET MVC的入口在 <code>UrlRoutingModule</code>，它是一个实现了<code>IHttpModule</code> 接口的类,订阅了 <code>HttpApplication</code> 的第7个管道事件 <code>PostResolveRequestCahce</code> 对请求进行了拦截。</font></p>
<p>1,IIS网站的配置可以分为两个块：全局 Web.config 和本站 Web.config。Asp.Net Routing属于全局性的，所以它配置在全局Web.Config 中，我们可以在如下路径中找到：“$\Windows\Microsoft.NET\Framework\版本号\Config\Web.config“</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line"> &lt;!-- the root web configuration file --&gt;</span><br><span class="line"> &lt;configuration&gt;</span><br><span class="line">     &lt;system.web&gt;</span><br><span class="line">         &lt;httpModules&gt;</span><br><span class="line">             &lt;<span class="keyword">add</span> name=<span class="string">&quot;UrlRoutingModule-4.0&quot;</span> type=<span class="string">&quot;System.Web.Routing.UrlRoutingModule&quot;</span> /&gt;</span><br><span class="line">         &lt;/httpModules&gt;</span><br><span class="line">    &lt;/system.web&gt;</span><br><span class="line"> &lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<p>2,通过在全局Web.Config中注册 <code>System.Web.Routing.UrlRoutingModule</code>，IIS请求处理管道接到请求后，就会加载 UrlRoutingModule类型的Init()方法，第7个管道事件 <code>PostResolveRequestCahce</code> 对请求进行了拦截。</p>
<p>3,在第七个事件中创建实现了IHttpHandler接口的MvcHandler</p>
<p>第七个事件：<code>PostResolveRequestCache</code></p>
<p>当请求到达 <code>UrlRoutingModule</code> 的时候，<code>UrlRoutingModule</code> 取出请求中的 Controller、Action等RouteData信息，与路由表中的所有规则进行匹配，若匹配，把请求交给 <code>IRouteHandler</code>，即 <code>MVCRouteHandler</code>。我们可以看下<code>UrlRoutingModule</code> 的源码来看看，以下是几句核心的代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PostResolveRequestCache</span>(<span class="params">HttpContextBase context</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 通过RouteCollection的静态方法GetRouteData获取到封装路由信息的RouteData实例</span></span><br><span class="line">    RouteData routeData = <span class="keyword">this</span>.RouteCollection.GetRouteData(context);</span><br><span class="line">    <span class="keyword">if</span> (routeData != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 再从RouteData中获取MVCRouteHandler</span></span><br><span class="line">        IRouteHandler routeHandler = routeData.RouteHandler;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (!(routeHandler <span class="keyword">is</span> StopRoutingHandler))</span><br><span class="line">        &#123;</span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">// 调用 IRouteHandler.GetHttpHandler()，获取的IHttpHandler 类型实例，它是由 IRouteHandler.GetHttpHandler获取的</span></span><br><span class="line">            IHttpHandler httpHandler = routeHandler.GetHttpHandler(requestContext);</span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">// 合适条件下，把之前将获取的IHttpHandler 类型实例 映射到IIS HTTP处理管道中</span></span><br><span class="line">            context.RemapHandler(httpHandler);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MVCRouteHandler</code> 的作用是用来生成实现 <code>IHttpHandler</code> 接口的 <code>MvcHandler</code>：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">System.Web.Routing</span></span><br><span class="line">&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRouteHandler</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">IHttpHandler <span class="title">GetHttpHandler</span>(<span class="params">RequestContext requestContext</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取 <code>MvcRouteHadnler</code> :</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 继承HttpApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MvcApplication</span> : <span class="title">System.Web.HttpApplication</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 第一个管道事件</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Application_Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//注册路由</span></span><br><span class="line">        RouteConfig.RegisterRoutes(RouteTable.Routes);</span><br><span class="line">        BundleConfig.RegisterBundles(BundleTable.Bundles);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RouteConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RegisterRoutes</span>(<span class="params">RouteCollection routes</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        routes.IgnoreRoute(<span class="string">&quot;&#123;resource&#125;.axd/&#123;*pathInfo&#125;&quot;</span>);</span><br><span class="line">        <span class="comment">// MapRoute位于System.Web.Mvc.RouteCollectionExtensions</span></span><br><span class="line">        routes.MapRoute(</span><br><span class="line">            name: <span class="string">&quot;Default&quot;</span>,</span><br><span class="line">            url: <span class="string">&quot;&#123;controller&#125;/&#123;action&#125;/&#123;id&#125;&quot;</span>,</span><br><span class="line">            defaults: <span class="keyword">new</span> &#123; controller = <span class="string">&quot;Home&quot;</span>, action = <span class="string">&quot;Index&quot;</span>, id = UrlParameter.Optional &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// System.Web.Mvc.RouteCollectionExtensions 扩展方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Route <span class="title">MapRoute</span>(<span class="params"><span class="keyword">this</span> RouteCollection routes, <span class="built_in">string</span> name, <span class="built_in">string</span> url, <span class="built_in">object</span> defaults, <span class="built_in">object</span> constraints, <span class="built_in">string</span>[] namespaces</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">　　　<span class="comment">// 通过Route类的构造函数把 MvcRouteHandler 注入到路由中</span></span><br><span class="line">    Route route = <span class="keyword">new</span> Route(url, <span class="keyword">new</span> MvcRouteHandler())             &#123;</span><br><span class="line">        Defaults = <span class="keyword">new</span> RouteValueDictionary(defaults),</span><br><span class="line">        Constraints = <span class="keyword">new</span> RouteValueDictionary(constraints),</span><br><span class="line">        DataTokens = <span class="keyword">new</span> RouteValueDictionary()</span><br><span class="line">    &#125;;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> route;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在第11和第12个事件之间调用了 <code>MvcHandler</code> 的 <code>ProcessRequest</code> 方法处理ASP.NET MVC。</p>
<p>第十一和第十二个事件是：<code>PreRequestHandlerExecute</code>，<code>PostRequestHandlerExecute</code>。</p>
<p>获取 <code>MvcHandler</code>:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">IHttpHandler httpHandler = routeHandler.GetHttpHandler(requestContext);</span><br><span class="line">context.RemapHandler(httpHandler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// MvcHandlerd的实现</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> IHttpHandler <span class="title">GetHttpHandler</span>(<span class="params">RequestContext requestContext</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">　　requestContext.HttpContext.SetSessionStateBehavior(GetSessionStateBehavior(requestContext));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MvcHandler(requestContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如图：</p>
<p><img src="/img/190104512548523.png" alt="190104512548523.png"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/artech/archive/2009/06/20/1507165.html">再谈IIS与ASP.NET管道</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhangyihui/p/5082394.html">【深入ASP.NET原理系列】–ASP.NET请求管道、应用程序生命周期、整体运行机制</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/darrenji/p/3795661.html">ASP.NET MVC请求处理管道生命周期的19个关键环节(1-6)</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/darrenji/p/3795676.html">ASP.NET MVC请求处理管道生命周期的19个关键环节(7-12)</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/edisonchou/p/4201855.html">ASP.Net请求处理机制初步探索之旅 - Part 3 管道</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/02/15/ASP-NET%E5%9C%A8IIS%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/15/ASP-NET%E5%9C%A8IIS%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">ASP.NET在IIS运行模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-15 08:55:33" itemprop="dateCreated datePublished" datetime="2019-02-15T08:55:33+00:00">2019-02-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-14 09:41:31" itemprop="dateModified" datetime="2021-04-14T09:41:31+00:00">2021-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ASP-NET-IIS%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E7%AE%A1%E9%81%93/" itemprop="url" rel="index"><span itemprop="name">ASP.NET/IIS请求处理管道</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ASP-NET在IIS运行模式"><a href="#ASP-NET在IIS运行模式" class="headerlink" title="ASP.NET在IIS运行模式"></a>ASP.NET在IIS运行模式</h1><h2 id="IIS6-处理模式"><a href="#IIS6-处理模式" class="headerlink" title="IIS6 处理模式"></a>IIS6 处理模式</h2><p>&emsp;&emsp;IIS 6引入了Application Pool。Application Pool就是一个application的容器，在IIS 6中，我们可以创建若干Application Pool，在创建Web Application的时候，我们为它指定一个既定的application pool。在运行的时候，一个Application对应一个Worker Process：w3wp.exe。也就是说，和前一个版本的IIS不同的是，对于IIS 6来说，同一台机器上可以同时运行多个Worker Process，每个Worker Process中的每个Application domain对应一个Application。这样，Application之间不但能提供Application Domain级别的隔离，你也可以将不同的Application置于不同的Application Pool中，从而基于Process级别的隔离。对于Host 一些重要的Application来说，这样的方式可以提供很好的Reliability。</p>
<p>注：<font color=##ff0000 size=4 face="黑体">为了避免用户应用程序访问或者修改关键的操作系统数据，windows提供了两种处理器访问模式：用户模式（User Mode）和内核模式（Kernel Mode）。一般地，用户程序运行在User mode下，而操作系统代码运行在Kernel Mode下。Kernel Mode的代码允许访问所有系统内存和所有CPU指令。</font></p>
<p>&emsp;&emsp;在User Mode下，http.sys接收到一个基于aspx的http request，然后它会根据IIS中的Metabase查看该基于该Request的Application属于哪个Application Pool，如果该Application Pool不存在，则创建之。否则直接将request发到对应Application Pool的Queue中。每个Application Pool对应着一个Worker Process：w3wp.exe，是运行在User Mode下的。在IIS Metabase中维护着Application Pool和worker process的Mapping。WAS（Web Administrative service）根据这样一个mapping，将存在于某个Application Pool Queue的request 传递到对应的worker process(如果没有，就创建这样一个进程)。在worker process初始化的时候，加载ASP.NET ISAPI，ASP.NET ISAPI进而加载CLR。最后的流程就和IIS 5.x一样了：通过AppManagerAppDomainFactory的Create方法为Application创建一个Application Domain；通过ISAPIRuntime的ProcessRequest处理Request，进而将流程进入到ASP.NET Http Runtime Pipeline。</p>
<p><img src="/img/IIS6-1.jpg" alt="IIS6-1.jpg"></p>
<ul>
<li>HTTP.SYS:（Kernel）的一个组件，它负责侦听（Listen）来自于外部的HTTP请求,根据请求的URL将其转发给相应的应用程序池 (Application Pool)。当此HTTP请求处理完成时，它又负责将处理结果发送出去.为了提供更好的性能，HTTP.SYS内部建立了一个缓冲区，将最近的HTTP请求处理结果保存起来。</li>
<li>Application Pool:IIS总会保持一个单独的工作进程：应用程序池。所有的处理都发生在这个进程里，包括ISAPI dll的执行。对于IIS6而言，应用程序池是一个重大的改进，因为它们允许以更小的粒度控制一个指定进程的执行。你可以为每一个虚拟目录或者整个Web 站点配置应用程序池，这可以使你很容易的把每一个应用程序隔离到各自的进程里，这样就可以把它与运行在同一台机器上其他程序完全隔离。从Web处理的角度看，如果一个进程死掉，至少它不会影响到其它的进程。当应用程序池接收到HTTP请求后，交由在此应用程序池中运行的工作者进程Worker Process: w3wp.exe来处理此HTTP请求。 </li>
<li>Worker Process: 当工作者进程接收到请求后，首先根据后缀找到并加载对应的ISAPI扩展 (如:aspx 对应的映射是aspnet_isapi.dll)，工作者进程加载完aspnet_isapi.dll后，由aspnet_isapi.dll负责加载 ASP.NET应用程序的运行环境即CLR (.NET Runtime)。 Worker Process运行在非托管环境，而.NET中的对象则运行在托管环境之上(CLR)，它们之间的桥梁就是ISAPI扩展。</li>
<li>WAS（Web Admin Service）：这是一个监控程序，它一方面可以存取放在InetInfo元数据库（Metabase）中的各种信息，另一方面也负责监控应用程序池（Application Pool）中的工作者进程的工作状态况，必要时它会关闭一个老的工作者进程并创建一个新的取而代之。</li>
</ul>
<h3 id="IIS6-X-运行时"><a href="#IIS6-X-运行时" class="headerlink" title="IIS6.X 运行时"></a>IIS6.X 运行时</h3><p>在worker process(w3wp.ext)初始化的时候，加载ASP.NET ISAPI，ASP.NET ISAPI进而加载CLR。<br><font color=##ff0000 size=4 face="黑体">ASP.NET ISAPI运行在一个非托管环境之中,ASP.NET ISAPI通过调用System.Web.Hosting.ISAPIRuntime Instance的ProcessRequest方法，进而从非托管的环境进入了托管的环境。</font></p>
<p><img src="/img/iis_aspnet_process_mode_02_01.JPG" alt="iis_aspnet_process_mode_02_01.JPG"></p>
<p>具体请参考：<a target="_blank" rel="noopener" href="http://www.cnblogs.com/artech/archive/2007/09/13/891262.html">ASP.NET Process Model之二：ASP.NET Http Runtime Pipeline[上篇]</a></p>
<p>最后，通过 <code>AppManagerAppDomainFactory</code> 的Create方法为 <code>Application</code> 创建一个 <code>Application Domain</code>；通过<code>ISAPIRuntime</code> 的 <code>ProcessRequest</code> 处理 <code>Request</code>，进而将流程进入到 <code>ASP.NET Http Runtime Pipeline</code>。</p>
<p>如下图：</p>
<p><img src="/img/2012071209470854.png" alt="2012071209470854.png"></p>
<p><font color=##ff0000 size=4 face="黑体">HttpContext(Request,Response)→ HttpRuntime→HttpApplicationFactory→HttpApplication→ HttpModule→HttpHandler→EndRequest</font></p>
<p><img src="/img/iis_aspnet_process_mode_02_02.JPG" alt="iis_aspnet_process_mode_02_02.JPG"></p>
<h2 id="IIS7-处理模式"><a href="#IIS7-处理模式" class="headerlink" title="IIS7 处理模式"></a>IIS7 处理模式</h2><p>IIS 7.0支持经典模式和集成模式。IIS6及IIS7的经典模式需要aspnet_isapi.dll来处理，而IIS7集成模式不需要aspnet_isapi.dll来处理，而可以直接根据文件扩展名找到相应的处理程序接口。例如aspx的处理程序是System.Web.UI.PageHandlerFactory类型。</p>
<p>IIS 7.0对请求的监听和分发机制上又进行了革新性的改进，主要体现在对于Windows进程激活服务（Windows Process Activation Service，WAS）的引入，将原来（IIS 6.0）W3SVC承载的部分功能分流给了WAS。具体来说，通过上面的介绍，我们知道对于IIS 6.0来说，W3SVC主要承载着三大功能：</p>
<ul>
<li>HTTP请求接收：接收HTTP.SYS监听到的HTTP请求；</li>
<li>配置管理：从元数据库（Metabase）中加载配置信息对相关组件进行配置；</li>
<li>进程管理：创建、回收、监控工作进程。</li>
</ul>
<p>在IIS 7.0，后两组功能被移入WAS中，接收HTTP请求的任务依然落在W3SVC头上。</p>
<h3 id="经典模式"><a href="#经典模式" class="headerlink" title="经典模式"></a>经典模式</h3><p>经典模式与IIS 6或者之前版本保持兼容的一种模式。</p>
<p>利用文件扩展名，可以判断使用哪个ISAPI处理程序。例如，可以将扩展名为.aspx 和.ascx的文件映射到aspnet_isapi.dll；并且将扩展名为.asp的文件映射到asp.dll，这样就可以处理传统的ASP页面。</p>
<p><img src="/img/04103814-376a25a1abe84619a45a90e3882ac641.jpg" alt="04103814-376a25a1abe84619a45a90e3882ac641.jpg"></p>
<h3 id="集成模式"><a href="#集成模式" class="headerlink" title="集成模式"></a>集成模式</h3><p><img src="/img/04103815-d7ef2284320f485d9f048b507062cc4d.png" alt="04103815-d7ef2284320f485d9f048b507062cc4d.png"></p>
<p>1、当客户端浏览器开始 HTTP 请求一个WEB 服务器的资源时，HTTP.sys 拦截到这个请求。</p>
<p>2、HTTP.sys 联系 WAS 获取配置信息。</p>
<p>3、WAS 向配置存储中心(applicationHost.config)请求配置信息。</p>
<p>4、WWW 服务接收到配置信息，配置信息指类似应用程序池配置信息，站点配置信息等等。</p>
<p>5、WWW 服务使用配置信息去配置 HTTP.sys 处理策略。</p>
<p>6、WAS为请求创建一个进程(如果不存在的话)</p>
<p>7、工作者进程处理请求并对HTTP.sys做出响应.</p>
<p>8、客户端接受到处理结果信息。</p>
<p>&emsp;&emsp;集成模式中，asp.net不再像IIS6一样只限定于aspnet_isapi.dll中，而是被解放出来，从IIS接收到HTTP请求开始，即进入asp.net的控制范围，asp.net可以存在于一个请求在IIS中各个处理阶段。允许我们将ASP.NET更好地与IIS集成，甚至允许我们在ASP.NET中编写一些功能（例如Module）来改变IIS的行为（扩 展）。集成的好处是，不再通过ISAPI的方式，提高了速度和稳定性。至于扩展，则可以使得我们对于IIS，以及其他类型的请求有更多的控制。（例如，我们希望静态网页也具备一些特殊的行为）。</p>
<p>IIS 7.0集成模式下的优点：</p>
<ul>
<li>允许我们通过本地代码（Native Code）和托管代码（Managed Code）两种方式定义IIS Module，这些IIS Module注册到IIS中形成一个通用的请求处理管道。由这些IIS Module组成的这个管道能够处理所有的请求，不论请求基于怎样的资源类型。比如，可以将FormsAuthenticationModule提供的Forms认证应用到基于.aspx，CGI和静态文件的请求。</li>
<li>将ASP.NET提供的一些强大的功能应用到原来难以企及的地方，比如将ASP.NET的URL重写功能置于身份验证之前；</li>
<li>采用相同的方式去实现、配置、检测和支持一些服务器特性（Feature），比如Module、Handler映射、错误定制配置（Custom Error Configuration）等。</li>
</ul>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/artech/archive/2007/09/09/887528.html">ASP.NET Process Model之一：IIS 和 ASP.NET ISAPI</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/zhaoyang/archive/2011/11/16/2251200.html">用三张图片详解Asp.Net 全生命周期</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/tenghoo/archive/2009/11/04/IIS_And_ASPNET_Http_Runtime_Pipeline.html">IIS与ASP.NET Http Runtime Pipeline</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/wenthink/archive/2013/05/06/HTTP_IIS_ASPNET_Pipeline.html">瀚海拾贝（一）HTTP协议/IIS 原理及ASP.NET运行机制浅析【图解】</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/fengzheng/p/3668283.html">ASP.NET是如何在IIS下工作的</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/24/CSharp-%E4%BD%BF%E7%94%A8%E7%A8%8B%E5%BA%8F%E9%9B%86%E7%BC%96%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/24/CSharp-%E4%BD%BF%E7%94%A8%E7%A8%8B%E5%BA%8F%E9%9B%86%E7%BC%96%E7%A8%8B/" class="post-title-link" itemprop="url">CSharp-使用程序集编程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-24 16:15:02" itemprop="dateCreated datePublished" datetime="2019-01-24T16:15:02+00:00">2019-01-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-14 09:41:31" itemprop="dateModified" datetime="2021-04-14T09:41:31+00:00">2021-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BA%8F%E9%9B%86/" itemprop="url" rel="index"><span itemprop="name">程序集</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="使用程序集编程"><a href="#使用程序集编程" class="headerlink" title="使用程序集编程"></a>使用程序集编程</h1><p>程序集是 .NET Framework 的构造块；它们构成了部署、版本控制、重复使用、激活范围和安全权限的基本单元。 程序集向公共语言运行时提供了解类型实现所需要的信息。 程序集是为协同工作而生成的类型和资源的集合，这些类型和资源构成了一个逻辑功能单元。 对于运行时，类型不存在于程序集上下文之外。</p>
<h2 id="程序集名称"><a href="#程序集名称" class="headerlink" title="程序集名称"></a>程序集名称</h2><p>程序集的名称存储在元数据中，它对程序集的范围及应用程序对程序集的使用有重要影响。 <font color=#ff0000 size=4 face="黑体">强名称程序集有一个完全限定的名称，由程序集的名称、区域性、公钥及版本号组成。 该名称通常称为显示名称，对于加载的程序集，可通过使用 FullName 属性来获取它。</font></p>
<p>在 .NET Framework 2.0 版中，向程序集标识添加了处理器体系结构，从而允许使用特定于处理器的程序集版本。</p>
<p>例如：</p>
<p>完全限定名表明 myTypes 程序集的强名称具有公钥标记、区域性值为美国英语、版本号为 1.0.1234.0。 它的处理器体系结构为“msil”，表示程序集将以实时 (JIT) 方式编译为 32 位代码或 64 位代码（具体取决于操作系统和处理器）。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myTypes, Version=<span class="number">1.0</span><span class="number">.1234</span><span class="number">.0</span>, Culture=en-US, PublicKeyToken=b77a5c561934e089c, ProcessorArchitecture=msil  </span><br></pre></td></tr></table></figure>

<p><font color=#ff0000 size=4 face="黑体">请求程序集中的类型的代码必须使用完全限定的程序集名称。 这称为完全限定绑定。</font> 在 .NET Framework 中引用程序集时不允许使用部分绑定，因为它只指定一个程序集名称。</p>
<p>对组成 .NET Framework 的程序集的所有程序集引用也必须包含程序集的完全限定名。对于 .NET Framework 程序集，区域性值始终不是特定的。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.data, version=<span class="number">1.0</span><span class="number">.3300</span><span class="number">.0</span>, Culture=neutral, PublicKeyToken=b77a5c561934e089  </span><br></pre></td></tr></table></figure>

<p>绑定到程序集时，运行时不区分程序集名称的大小写，但会保留程序集名称中使用的大小写。</p>
<p><font color=#ff0000 size=4 face="黑体">如果将强名称程序集置于全局程序集缓存中，则程序集的文件名必须与程序集名称相匹配（不包括文件扩展名，如 .exe 或 .dll）。</font> 例如，如果程序集的文件名为 myAssembly.dll，则程序集名称必须为 myAssembly。 <font color=#ff0000 size=4 face="黑体">只有在根应用程序目录中部署的专用程序集的程序集名称可以不同于文件名。</font></p>
<h2 id="确定程序集完全限定的名称"><a href="#确定程序集完全限定的名称" class="headerlink" title="确定程序集完全限定的名称"></a>确定程序集完全限定的名称</h2><p>1,在全局程序集缓存中查找一个程序集的完全限定名，请使用全局程序集缓存工具 (<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/tools/gacutil-exe-gac-tool">Gacutil.exe</a>)。</p>
<p>2,不在全局程序集缓存中的程序集，可以通过多种方式获取完全限定的程序集名称：可使用代码将信息输出到控制台或变量，也可使用 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/tools/ildasm-exe-il-disassembler">Ildasm.exe（IL 反汇编程序）</a>检查包含完全限定名的程序集元数据。</p>
<p>如果应用程序已加载程序集，则可检索 Assembly.FullName 属性的值在以获取完全限定名。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Type t = <span class="keyword">typeof</span>(System.Data.DataSet);</span><br><span class="line"><span class="built_in">string</span> s = t.Assembly.FullName.ToString();</span><br></pre></td></tr></table></figure>

<p>如果知道程序集的文件系统路径，则可调用静态AssemblyName.GetAssemblyName 方法获取完全限定的程序集名称。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Console.WriteLine(AssemblyName.GetAssemblyName(<span class="string">@&quot;.\UtilityLibrary.dll&quot;</span>));</span><br></pre></td></tr></table></figure>

<h2 id="设置程序集特性"><a href="#设置程序集特性" class="headerlink" title="设置程序集特性"></a>设置程序集特性</h2><p>程序集特性是提供程序集相关信息的值。 特性分为以下几组信息：</p>
<ul>
<li>程序集标识特性。</li>
<li>信息性特性。</li>
<li>程序集清单特性。</li>
<li>强名称特性。</li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/app-domains/set-assembly-attributes">设置程序集特性</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/daxnet/p/8525249.html">重温.NET下Assembly的加载过程</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/24/CSharp-%E7%A8%8B%E5%BA%8F%E9%9B%86%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/24/CSharp-%E7%A8%8B%E5%BA%8F%E9%9B%86%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">CSharp-程序集简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-24 13:58:35" itemprop="dateCreated datePublished" datetime="2019-01-24T13:58:35+00:00">2019-01-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-14 09:41:31" itemprop="dateModified" datetime="2021-04-14T09:41:31+00:00">2021-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BA%8F%E9%9B%86/" itemprop="url" rel="index"><span itemprop="name">程序集</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="程序集"><a href="#程序集" class="headerlink" title="程序集"></a>程序集</h1><h2 id="程序集内容"><a href="#程序集内容" class="headerlink" title="程序集内容"></a>程序集内容</h2><p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/app-domains/assembly-contents">程序集内容</a></p>
<p>通常，静态程序集可能由以下四个元素组成：</p>
<ul>
<li>1，程序集清单，包含程序集元数据。</li>
<li>2，类型元数据。</li>
<li>3，实现这些类型的 Microsoft 中间语言 (MSIL) 代码。</li>
<li>4，资源集。</li>
</ul>
<p>只有程序集清单是必需的，但也需要类型或资源来向程序集提供任何有意义的功能。</p>
<p>** 单文件程序集**</p>
<p><img src="/img/assemblyover1.gif" alt="assemblyover1.gif"></p>
<p>** 多文件程序集**</p>
<p>注意：Visual Studio IDE 只能用于创建单文件程序集。</p>
<p>将一个程序集的元素包含在几个文件中。 这些文件可以是应用程序所需的编译代码 (.netmodule)、资源（例如，.bmp 或 .jpg 文件）或其他文件的模块。</p>
<p>.NET Framework 只在文件被引用时下载该文件；通过将很少引用的代码保留在独立于应用程序的文件中来优化代码下载。</p>
<p>构成多文件程序集的那些文件实际上并非由文件系统来链接。 它们而是通过程序集清单进行链接，公共语言运行时将这些文件作为一个单元来管理。</p>
<p><img src="/img/assemblyover2.gif" alt="assemblyover2.gif"></p>
<p>在此插图中，所有三个文件均属于一个程序集，如 MyAssembly.dll 所包含的程序集清单文件中所述。 对于该文件系统，这三个文件是三个独立的文件。 请注意，文件 Util.netmodule 被编译为一个模块，因为它不包含任何程序集信息。 创建程序集之后，已将该程序集清单添加到指示程序集与 Util.netmodule 和 Graphic.bmp 之间关系的 MyAssembly.dll 中。</p>
<h2 id="程序集清单"><a href="#程序集清单" class="headerlink" title="程序集清单"></a>程序集清单</h2><p>参考:<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/app-domains/assembly-manifest">程序集清单</a></p>
<p><font color=#ff0000 size=4 face="黑体">每一程序集，无论是静态的还是动态的，均包含描述该程序集中各元素彼此如何关联的数据集合。 程序集清单就包含这些程序集元数据。 程序集清单包含指定该程序集的版本要求和安全标识所需的所有元数据，以及定义该程序集的范围和解析对资源和类的引用所需的全部元数据。</font> 程序集清单可以存储在具有 Microsoft 中间语言 (MSIL) 代码的 PE 文件（.exe 或 .dll）中，也可存储在只包含程序集清单信息的独立 PE 文件中。</p>
<p>对于有一个关联文件的程序集，该清单将被合并到 PE 文件中以构成单文件程序集。</p>
<p>每一程序集的清单均执行以下功能：</p>
<ul>
<li>枚举构成该程序集的文件。</li>
<li>控制对该程序集的类型和资源的引用,如何映射到包含其声明和实现的文件。</li>
<li>枚举该程序集所依赖的其他程序集。</li>
<li>在程序集使用者和程序集实现详细信息的使用者之间提供一定程度的间接性。</li>
<li>呈现程序集自述。</li>
</ul>
<h3 id="程序集清单内容"><a href="#程序集清单内容" class="headerlink" title="程序集清单内容"></a>程序集清单内容</h3><table>
<thead>
<tr>
<th>信息</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>程序集名称</td>
<td>指定程序集名称的文本字符串。</td>
</tr>
<tr>
<td>版本号</td>
<td>主版本号和次版本号，以及修订号和生成号。 公共语言运行时使用这些编号来强制实施版本策略。</td>
</tr>
<tr>
<td>culture</td>
<td>有关该程序集支持的区域性或语言的信息。此信息只应用于将一个程序集指定为包含特定区域性或特定语言信息的附属程序集。</td>
</tr>
<tr>
<td>强名称信息</td>
<td>如果已经为程序集提供了一个强名称，则为来自发行者的公钥。</td>
</tr>
<tr>
<td>程序集中所有文件的列表</td>
<td>在程序集中包含的每一文件的散列及文件名。 请注意，构成程序集的所有文件所在的目录</br>必须是包含该程序集清单的文件所在的目录。</td>
</tr>
<tr>
<td>类型引用信息</td>
<td>运行时用来将类型引用映射到包含其声明和实现的文件的信息。 该信息用于从程序集导出的类型。</td>
</tr>
<tr>
<td>有关被引用程序集的信息</td>
<td>该程序集静态引用的其他程序集的列表。 如果依赖的程序集具有强名称，</br>则每一引用均包括该依赖程序集的名称、程序集元数据（版本、区域性、操作系统等）和公钥。</td>
</tr>
</tbody></table>
<h2 id="全局程序集缓存"><a href="#全局程序集缓存" class="headerlink" title="全局程序集缓存"></a>全局程序集缓存</h2><p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/app-domains/gac">全局程序集缓存</a></p>
<p><font color=#ff0000 size=4 face="黑体">安装了公共语言运行时的每台计算机均具有计算机范围的代码缓存，称为全局程序集缓存。 全局程序集缓存中存储专门指定给由计算机中若干应用程序共享的程序集。</font></p>
<p>只能在需要时才通过将程序集安装到全局程序集缓存中来共享程序集。 一般原则是：程序集依赖项保持专用，并将程序集放在应用程序目录中，除非明确要求共享该程序集。 另外，无需为了使 COM 互操作或非托管代码可以访问程序集而将程序集安装到全局程序集缓存。</p>
<p><font color=#ff0000 size=4 face="黑体">将组成应用程序的某个程序集置于全局程序集缓存中之后，无法再通过使用 xcopy 命令复制应用程序目录来复制或安装应用程序。 必须同时移动全局程序集缓存中的程序集。</font></p>
<p>可以通过两种方法将程序集部署到全局程序集缓存：</p>
<ul>
<li>使用专用于全局程序集缓存的安装程序。首选项</li>
<li>使用 Windows 软件开发包 (SDK) 提供的名为<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/tools/gacutil-exe-gac-tool">全局程序集缓存工具 (Gacutil.exe)</a> 的开发人员工具。</li>
</ul>
<p>从 .NET Framework 4 开始，全局程序集缓存的默认位置为 %windir%\Microsoft.NET\assembly。 在 .NET Framework 的早期版本中，默认位置为 %windir%\assembly。</p>
<p>建议只允许具有“管理员”权限的用户从全局程序集缓存中删除文件。</p>
<p>部署在全局程序集缓存中的程序集必须使用强名称。 将程序集添加到全局程序集缓存时，可对组成该程序集的所有文件执行完整性检查。 缓存通过执行这些完整性检查来确保该程序集未被篡改，例如，文件已更改，但清单没有反映出此更改。</p>
<h2 id="具有强名称的程序集"><a href="#具有强名称的程序集" class="headerlink" title="具有强名称的程序集"></a>具有强名称的程序集</h2><p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/app-domains/strong-named-assemblies">具有强名称的程序集</a></p>
<p>强命名一个程序集可为程序集创建唯一的标识，并且可以防止程序集冲突。</p>
<p>强名称程序集通过使用私钥以及程序集本身生成，此私钥对应于与该程序集一起分发的公钥。 程序集包括程序集清单，此清单包含所有组成该程序集的文件的名称和哈希。 具有相同强名称的程序集应该完全相同。</p>
<p>在创建强名称程序集时，它包含程序集的简单文本名称、版本号、可选区域性信息、数字签名，以及对应于用于签名的私钥的公钥。</p>
<p>不要依赖于通过强名称实现安全性。 它们仅提供唯一的标识。</p>
<p>强命名程序集作用：</p>
<ul>
<li>你希望启用强名称程序集将引用的程序集，或希望允许其他强名称程序集 friend 访问你的程序集。</li>
<li>应用程序需要访问同一程序集的各种版本。 这意味着你需要在同一应用程序域中并排加载某程序集的不同版本，且各版本互不冲突。 例如，如果在具有相同简单名称的程序集中存在 API 的不同扩展，强命名将为该程序集的每个版本提供唯一标识。</li>
<li>你不希望程序集的使用对应用程序性能产生负面影响，所以你想要非特定于域的程序集。 这就要求进行强命名，因为非特定于域的程序集必须安装在全局程序集缓存中。</li>
<li>如果你希望通过应用发布服务器策略来集中应用程序的服务，则意味着程序集必须安装在全局程序集缓存中。</li>
</ul>
<h2 id="程序集版本控制"><a href="#程序集版本控制" class="headerlink" title="程序集版本控制"></a>程序集版本控制</h2><p>使用公共语言运行时的程序集的所有版本控制都在程序集级别上进行。 一个程序集的特定版本和依赖程序集的版本在该程序集的清单中记录下来。 除非被配置文件（应用程序配置文件、发行者策略文件和计算机的管理员配置文件）中的显式版本策略重写，否则运行时的默认版本策略是，应用程序只与它们生成和测试时所用的程序集版本一起运行。</p>
<p>仅对具有强名称的程序集进行版本控制。</p>
<p>每一程序集都用两种截然不同的方法来表示版本信息：</p>
<ul>
<li>程序集的版本号，该版本号与程序集名称及区域性信息都是程序集标识的组成部分。 该号码将由运行时用来强制实施版本策略，它在运行时的类型解析进程中起着重要的作用。</li>
<li>信息性版本，这是一个字符串，表示仅为提醒的目的而包括的附加版本信息。</li>
</ul>
<p>** 程序集版本号**</p>
<p>每一程序集都有一个版本号作为其标识的一部分。 因此，如果两个程序集具有不同的版本号，运行时就会将它们视作完全不同的程序集。</p>
<p>&lt;主版本&gt;.&lt;次版本&gt;.&lt;生成号&gt;.&lt;修订版本&gt;<br>例如，版本 1.5.1254.0 中的 1 表示主版本，5 表示次版本，1254 表示生成号，而 0 则表示修订号。</p>
<p>版本号与其他标识信息（包括程序集名称和公钥，以及与该应用程序所连接的其他程序集的关系和标识有关的信息）一起存储在程序集清单中。</p>
<p>在生成程序集时，开发工具将把每一个被引用程序集的依赖项信息记录在程序集清单中。 运行时将这些版本号与管理员、应用程序或发行者设置的配置信息结合使用，以加载被引用程序集的正确版本。</p>
<p>为进行版本控制，运行时会区分常规程序集和具有强名称的程序集。 只对具有强名称的程序集执行版本检查。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/22/CSharp-CodeDom%E5%88%9B%E5%BB%BAXML%E6%96%87%E6%A1%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/22/CSharp-CodeDom%E5%88%9B%E5%BB%BAXML%E6%96%87%E6%A1%A3/" class="post-title-link" itemprop="url">CSharp-CodeDom创建XML文档</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-22 09:44:26" itemprop="dateCreated datePublished" datetime="2019-01-22T09:44:26+00:00">2019-01-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-14 09:41:31" itemprop="dateModified" datetime="2021-04-14T09:41:31+00:00">2021-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CodeDOM/" itemprop="url" rel="index"><span itemprop="name">CodeDOM</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CSharp-CodeDom创建XML文档"><a href="#CSharp-CodeDom创建XML文档" class="headerlink" title="CSharp-CodeDom创建XML文档"></a>CSharp-CodeDom创建XML文档</h1><p>可使用 CodeDOM 创建生成 XML 文档的代码。 该进程包括创建包含 XML 文档注释的 CodeDOM 图、生成代码和通过创建 XML 文档输出的编译器选项编译生成的代码。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/how-to-create-an-xml-documentation-file-using-codedom">如何：使用 CodeDOM 创建 XML 文档文件</a></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> System;</span><br><span class="line">    <span class="keyword">using</span> System.CodeDom;</span><br><span class="line">    <span class="keyword">using</span> System.CodeDom.Compiler;</span><br><span class="line">    <span class="keyword">using</span> System.IO;</span><br><span class="line">    <span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="built_in">string</span> providerName = <span class="string">&quot;cs&quot;</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="built_in">string</span> sourceFileName = <span class="string">&quot;test.cs&quot;</span>;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            CodeDomProvider provider =</span><br><span class="line">                CodeDomProvider.CreateProvider(providerName);</span><br><span class="line"></span><br><span class="line">            LogMessage(<span class="string">&quot;Building CodeDOM graph...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            CodeCompileUnit cu = <span class="keyword">new</span> CodeCompileUnit();</span><br><span class="line"></span><br><span class="line">            cu = BuildHelloWorldGraph();</span><br><span class="line"></span><br><span class="line">            StreamWriter sourceFile = <span class="keyword">new</span> StreamWriter(sourceFileName);</span><br><span class="line">            provider.GenerateCodeFromCompileUnit(cu, sourceFile, <span class="literal">null</span>);</span><br><span class="line">            sourceFile.Close();</span><br><span class="line"></span><br><span class="line">            CompilerParameters opt = <span class="keyword">new</span> CompilerParameters(<span class="keyword">new</span> <span class="built_in">string</span>[]&#123;</span><br><span class="line">                                      <span class="string">&quot;System.dll&quot;</span> &#125;);</span><br><span class="line">            opt.GenerateExecutable = <span class="literal">true</span>;</span><br><span class="line">            opt.OutputAssembly = <span class="string">&quot;HelloWorld.exe&quot;</span>;</span><br><span class="line">            opt.TreatWarningsAsErrors = <span class="literal">true</span>;</span><br><span class="line">            opt.IncludeDebugInformation = <span class="literal">true</span>;</span><br><span class="line">            opt.GenerateInMemory = <span class="literal">true</span>;</span><br><span class="line">            opt.CompilerOptions = <span class="string">&quot;/doc:HelloWorldDoc.xml&quot;</span>;</span><br><span class="line"></span><br><span class="line">            CompilerResults results;</span><br><span class="line"></span><br><span class="line">            LogMessage(<span class="string">&quot;Compiling with &quot;</span> + providerName);</span><br><span class="line">            results = provider.CompileAssemblyFromFile(opt, sourceFileName);</span><br><span class="line"></span><br><span class="line">            OutputResults(results);</span><br><span class="line">            <span class="keyword">if</span> (results.NativeCompilerReturnValue != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                LogMessage(<span class="string">&quot;&quot;</span>);</span><br><span class="line">                LogMessage(<span class="string">&quot;Compilation failed.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                LogMessage(<span class="string">&quot;&quot;</span>);</span><br><span class="line">                LogMessage(<span class="string">&quot;Demo completed successfully.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//File.Delete(sourceFileName);</span></span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Build a Hello World program graph using </span></span><br><span class="line">        <span class="comment">// System.CodeDom types.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CodeCompileUnit <span class="title">BuildHelloWorldGraph</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Create a new CodeCompileUnit to contain </span></span><br><span class="line">            <span class="comment">// the program graph.</span></span><br><span class="line">            CodeCompileUnit compileUnit = <span class="keyword">new</span> CodeCompileUnit();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Declare a new namespace called Samples.</span></span><br><span class="line">            CodeNamespace samples = <span class="keyword">new</span> CodeNamespace(<span class="string">&quot;Samples&quot;</span>);</span><br><span class="line">            <span class="comment">// Add the new namespace to the compile unit.</span></span><br><span class="line">            compileUnit.Namespaces.Add(samples);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the new namespace import for the System namespace.</span></span><br><span class="line">            samples.Imports.Add(<span class="keyword">new</span> CodeNamespaceImport(<span class="string">&quot;System&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Declare a new type called Class1.</span></span><br><span class="line">            CodeTypeDeclaration class1 = <span class="keyword">new</span> CodeTypeDeclaration(<span class="string">&quot;Class1&quot;</span>);</span><br><span class="line"></span><br><span class="line">            class1.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(<span class="string">&quot;&lt;summary&gt;&quot;</span>, <span class="literal">true</span>));</span><br><span class="line">            class1.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(</span><br><span class="line">                <span class="string">&quot;Create a Hello World application.&quot;</span>, <span class="literal">true</span>));</span><br><span class="line">            class1.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(</span><br><span class="line">                <span class="string">@&quot;&lt;seealso cref=&quot;</span> + <span class="string">&#x27;&quot;&#x27;</span> + <span class="string">&quot;Class1.Main&quot;</span> + <span class="string">&#x27;&quot;&#x27;</span> + <span class="string">&quot;/&gt;&quot;</span>, <span class="literal">true</span>));</span><br><span class="line">            class1.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(<span class="string">&quot;&lt;/summary&gt;&quot;</span>, <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the new type to the namespace type collection.</span></span><br><span class="line">            samples.Types.Add(class1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Declare a new code entry point method.</span></span><br><span class="line">            CodeEntryPointMethod start = <span class="keyword">new</span> CodeEntryPointMethod();</span><br><span class="line">            start.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(<span class="string">&quot;&lt;summary&gt;&quot;</span>, <span class="literal">true</span>));</span><br><span class="line">            start.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(</span><br><span class="line">                <span class="string">&quot;Main method for HelloWorld application.&quot;</span>, <span class="literal">true</span>));</span><br><span class="line">            start.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(</span><br><span class="line">                <span class="string">@&quot;&lt;para&gt;Add a new paragraph to the description.&lt;/para&gt;&quot;</span>, <span class="literal">true</span>));</span><br><span class="line">            start.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(<span class="string">&quot;&lt;/summary&gt;&quot;</span>, <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create a type reference for the System.Console class.</span></span><br><span class="line">            CodeTypeReferenceExpression csSystemConsoleType =</span><br><span class="line">                <span class="keyword">new</span> CodeTypeReferenceExpression(<span class="string">&quot;System.Console&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Build a Console.WriteLine statement.</span></span><br><span class="line">            CodeMethodInvokeExpression cs1 = <span class="keyword">new</span> CodeMethodInvokeExpression(</span><br><span class="line">                csSystemConsoleType, <span class="string">&quot;WriteLine&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> CodePrimitiveExpression(<span class="string">&quot;Hello World!&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the WriteLine call to the statement collection.</span></span><br><span class="line">            start.Statements.Add(cs1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Build another Console.WriteLine statement.</span></span><br><span class="line">            CodeMethodInvokeExpression cs2 = <span class="keyword">new</span> CodeMethodInvokeExpression(</span><br><span class="line">                csSystemConsoleType, <span class="string">&quot;WriteLine&quot;</span>, <span class="keyword">new</span> CodePrimitiveExpression(</span><br><span class="line">                <span class="string">&quot;Press the ENTER key to continue.&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the WriteLine call to the statement collection.</span></span><br><span class="line">            start.Statements.Add(cs2);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Build a call to System.Console.ReadLine.</span></span><br><span class="line">            CodeMethodInvokeExpression csReadLine =</span><br><span class="line">                <span class="keyword">new</span> CodeMethodInvokeExpression(csSystemConsoleType, <span class="string">&quot;ReadLine&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the ReadLine statement.</span></span><br><span class="line">            start.Statements.Add(csReadLine);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the code entry point method to</span></span><br><span class="line">            <span class="comment">// the Members collection of the type.</span></span><br><span class="line">            class1.Members.Add(start);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> compileUnit;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LogMessage</span>(<span class="params"><span class="built_in">string</span> text</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(text);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OutputResults</span>(<span class="params">CompilerResults results</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            LogMessage(<span class="string">&quot;NativeCompilerReturnValue=&quot;</span> +</span><br><span class="line">                results.NativeCompilerReturnValue.ToString());</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="built_in">string</span> s <span class="keyword">in</span> results.Output)</span><br><span class="line">            &#123;</span><br><span class="line">                LogMessage(s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/22/CSharp-CodeDom%E7%94%9F%E6%88%90%E5%92%8C%E7%BC%96%E8%AF%91%E6%BA%90%E4%BB%A3%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/22/CSharp-CodeDom%E7%94%9F%E6%88%90%E5%92%8C%E7%BC%96%E8%AF%91%E6%BA%90%E4%BB%A3%E7%A0%81/" class="post-title-link" itemprop="url">CSharp-CodeDom生成和编译源代码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-22 09:34:57" itemprop="dateCreated datePublished" datetime="2019-01-22T09:34:57+00:00">2019-01-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-14 09:41:31" itemprop="dateModified" datetime="2021-04-14T09:41:31+00:00">2021-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CodeDOM/" itemprop="url" rel="index"><span itemprop="name">CodeDOM</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CSharp-CodeDom生成和编译源代码"><a href="#CSharp-CodeDom生成和编译源代码" class="headerlink" title="CSharp-CodeDom生成和编译源代码"></a>CSharp-CodeDom生成和编译源代码</h1><p><code>System.CodeDom.Compiler</code> 命名空间提供了从 CodeDOM 对象图生成源代码和用受支持的编译器管理编译的接口。 代码提供程序可根据 CodeDOM 图，用某种编程语言生成源代码。 从 <code>CodeDomProvider</code> 派生的类通常可以提供一些方法，用于生成和编译提供程序支持的语言代码。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/generating-and-compiling-source-code-from-a-codedom-graph">在 CodeDOM 图中生成和编译源代码</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.codedom.compiler.codedomprovider?view=netframework-4.7.2">CodeDomProvider Class</a></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.CodeDom;</span><br><span class="line"><span class="keyword">using</span> System.CodeDom.Compiler;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.Drawing;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Forms;</span><br><span class="line"><span class="keyword">using</span> Microsoft.CSharp;</span><br><span class="line"><span class="keyword">using</span> Microsoft.VisualBasic;</span><br><span class="line"><span class="keyword">using</span> Microsoft.JScript;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This example demonstrates building a Hello World program graph </span></span><br><span class="line"><span class="comment">// using System.CodeDom elements. It calls code generator and</span></span><br><span class="line"><span class="comment">// code compiler methods to build the program using CSharp, VB, or</span></span><br><span class="line"><span class="comment">// JScript.  A Windows Forms interface is included. Note: Code</span></span><br><span class="line"><span class="comment">// must be compiled and linked with the Microsoft.JScript assembly.</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WindowsFormsApp1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">CodeDomExample</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Build a Hello World program graph using </span></span><br><span class="line">        <span class="comment">// System.CodeDom types.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CodeCompileUnit <span class="title">BuildHelloWorldGraph</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Create a new CodeCompileUnit to contain </span></span><br><span class="line">            <span class="comment">// the program graph.</span></span><br><span class="line">            CodeCompileUnit compileUnit = <span class="keyword">new</span> CodeCompileUnit();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Declare a new namespace called Samples.</span></span><br><span class="line">            CodeNamespace samples = <span class="keyword">new</span> CodeNamespace(<span class="string">&quot;Samples&quot;</span>);</span><br><span class="line">            <span class="comment">// Add the new namespace to the compile unit.</span></span><br><span class="line">            compileUnit.Namespaces.Add(samples);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the new namespace import for the System namespace.</span></span><br><span class="line">            samples.Imports.Add(<span class="keyword">new</span> CodeNamespaceImport(<span class="string">&quot;System&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Declare a new type called Class1.</span></span><br><span class="line">            CodeTypeDeclaration class1 = <span class="keyword">new</span> CodeTypeDeclaration(<span class="string">&quot;Class1&quot;</span>);</span><br><span class="line">            <span class="comment">// Add the new type to the namespace type collection.</span></span><br><span class="line">            samples.Types.Add(class1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Declare a new code entry point method.</span></span><br><span class="line">            CodeEntryPointMethod start = <span class="keyword">new</span> CodeEntryPointMethod();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create a type reference for the System.Console class.</span></span><br><span class="line">            CodeTypeReferenceExpression csSystemConsoleType = <span class="keyword">new</span> CodeTypeReferenceExpression(<span class="string">&quot;System.Console&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Build a Console.WriteLine statement.</span></span><br><span class="line">            CodeMethodInvokeExpression cs1 = <span class="keyword">new</span> CodeMethodInvokeExpression(</span><br><span class="line">                csSystemConsoleType, <span class="string">&quot;WriteLine&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> CodePrimitiveExpression(<span class="string">&quot;Hello World!&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the WriteLine call to the statement collection.</span></span><br><span class="line">            start.Statements.Add(cs1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Build another Console.WriteLine statement.</span></span><br><span class="line">            CodeMethodInvokeExpression cs2 = <span class="keyword">new</span> CodeMethodInvokeExpression(</span><br><span class="line">                csSystemConsoleType, <span class="string">&quot;WriteLine&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> CodePrimitiveExpression(<span class="string">&quot;Press the Enter key to continue.&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the WriteLine call to the statement collection.</span></span><br><span class="line">            start.Statements.Add(cs2);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Build a call to System.Console.ReadLine.</span></span><br><span class="line">            CodeMethodInvokeExpression csReadLine = <span class="keyword">new</span> CodeMethodInvokeExpression(</span><br><span class="line">                csSystemConsoleType, <span class="string">&quot;ReadLine&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the ReadLine statement.</span></span><br><span class="line">            start.Statements.Add(csReadLine);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the code entry point method to</span></span><br><span class="line">            <span class="comment">// the Members collection of the type.</span></span><br><span class="line">            class1.Members.Add(start);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> compileUnit;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GenerateCode</span>(<span class="params">CodeDomProvider provider,</span></span></span><br><span class="line"><span class="function"><span class="params">            CodeCompileUnit compileunit</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Build the source file name with the appropriate</span></span><br><span class="line">            <span class="comment">// language extension.</span></span><br><span class="line">            String sourceFile;</span><br><span class="line">            <span class="keyword">if</span> (provider.FileExtension[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                sourceFile = <span class="string">&quot;TestGraph&quot;</span> + provider.FileExtension;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                sourceFile = <span class="string">&quot;TestGraph.&quot;</span> + provider.FileExtension;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create an IndentedTextWriter, constructed with</span></span><br><span class="line">            <span class="comment">// a StreamWriter to the source file.</span></span><br><span class="line">            IndentedTextWriter tw = <span class="keyword">new</span> IndentedTextWriter(<span class="keyword">new</span> StreamWriter(sourceFile, <span class="literal">false</span>), <span class="string">&quot;    &quot;</span>);</span><br><span class="line">            <span class="comment">// Generate source code using the code generator.</span></span><br><span class="line">            provider.GenerateCodeFromCompileUnit(compileunit, tw, <span class="keyword">new</span> CodeGeneratorOptions());</span><br><span class="line">            <span class="comment">// Close the output file.</span></span><br><span class="line">            tw.Close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CompilerResults <span class="title">CompileCode</span>(<span class="params">CodeDomProvider provider,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String sourceFile,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String exeFile</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Configure a CompilerParameters that links System.dll</span></span><br><span class="line">            <span class="comment">// and produces the specified executable file.</span></span><br><span class="line">            String[] referenceAssemblies = &#123; <span class="string">&quot;System.dll&quot;</span> &#125;;</span><br><span class="line">            CompilerParameters cp = <span class="keyword">new</span> CompilerParameters(referenceAssemblies,</span><br><span class="line">                                                           exeFile, <span class="literal">false</span>);</span><br><span class="line">            <span class="comment">// Generate an executable rather than a DLL file.</span></span><br><span class="line">            cp.GenerateExecutable = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Invoke compilation.</span></span><br><span class="line">            CompilerResults cr = provider.CompileAssemblyFromFile(cp, sourceFile);</span><br><span class="line">            <span class="comment">// Return the results of compilation.</span></span><br><span class="line">            <span class="keyword">return</span> cr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CodeDomExampleForm</span> : <span class="title">System.Windows.Forms.Form</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> System.Windows.Forms.Button run_button = <span class="keyword">new</span> System.Windows.Forms.Button();</span><br><span class="line">        <span class="keyword">private</span> System.Windows.Forms.Button compile_button = <span class="keyword">new</span> System.Windows.Forms.Button();</span><br><span class="line">        <span class="keyword">private</span> System.Windows.Forms.Button generate_button = <span class="keyword">new</span> System.Windows.Forms.Button();</span><br><span class="line">        <span class="keyword">private</span> System.Windows.Forms.TextBox textBox1 = <span class="keyword">new</span> System.Windows.Forms.TextBox();</span><br><span class="line">        <span class="keyword">private</span> System.Windows.Forms.ComboBox comboBox1 = <span class="keyword">new</span> System.Windows.Forms.ComboBox();</span><br><span class="line">        <span class="keyword">private</span> System.Windows.Forms.Label label1 = <span class="keyword">new</span> System.Windows.Forms.Label();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">generate_button_Click</span>(<span class="params"><span class="built_in">object</span> sender, System.EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            CodeDomProvider provider = GetCurrentProvider();</span><br><span class="line">            CodeDomExample.GenerateCode(provider, CodeDomExample.BuildHelloWorldGraph());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Build the source file name with the appropriate</span></span><br><span class="line">            <span class="comment">// language extension.</span></span><br><span class="line">            String sourceFile;</span><br><span class="line">            <span class="keyword">if</span> (provider.FileExtension[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                sourceFile = <span class="string">&quot;TestGraph&quot;</span> + provider.FileExtension;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                sourceFile = <span class="string">&quot;TestGraph.&quot;</span> + provider.FileExtension;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Read in the generated source file and</span></span><br><span class="line">            <span class="comment">// display the source text.</span></span><br><span class="line">            StreamReader sr = <span class="keyword">new</span> StreamReader(sourceFile);</span><br><span class="line">            textBox1.Text = sr.ReadToEnd();</span><br><span class="line">            sr.Close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">compile_button_Click</span>(<span class="params"><span class="built_in">object</span> sender, System.EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            CodeDomProvider provider = GetCurrentProvider();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Build the source file name with the appropriate</span></span><br><span class="line">            <span class="comment">// language extension.</span></span><br><span class="line">            String sourceFile;</span><br><span class="line">            <span class="keyword">if</span> (provider.FileExtension[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                sourceFile = <span class="string">&quot;TestGraph&quot;</span> + provider.FileExtension;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                sourceFile = <span class="string">&quot;TestGraph.&quot;</span> + provider.FileExtension;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Compile the source file into an executable output file.</span></span><br><span class="line">            CompilerResults cr = CodeDomExample.CompileCode(provider,</span><br><span class="line">                                                            sourceFile,</span><br><span class="line">                                                            <span class="string">&quot;TestGraph.exe&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cr.Errors.Count &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Display compilation errors.</span></span><br><span class="line">                textBox1.Text = <span class="string">&quot;Errors encountered while building &quot;</span> +</span><br><span class="line">                                sourceFile + <span class="string">&quot; into &quot;</span> + cr.PathToAssembly + <span class="string">&quot;: \r\n\n&quot;</span>;</span><br><span class="line">                <span class="keyword">foreach</span> (CompilerError ce <span class="keyword">in</span> cr.Errors)</span><br><span class="line">                    textBox1.AppendText(ce.ToString() + <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">                run_button.Enabled = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                textBox1.Text = <span class="string">&quot;Source &quot;</span> + sourceFile + <span class="string">&quot; built into &quot;</span> +</span><br><span class="line">                                cr.PathToAssembly + <span class="string">&quot; with no errors.&quot;</span>;</span><br><span class="line">                run_button.Enabled = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run_button_Click</span>(<span class="params"><span class="built_in">object</span> sender,</span></span></span><br><span class="line"><span class="function"><span class="params">            System.EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Process.Start(<span class="string">&quot;TestGraph.exe&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> CodeDomProvider <span class="title">GetCurrentProvider</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            CodeDomProvider provider;</span><br><span class="line">            <span class="keyword">switch</span> ((<span class="built_in">string</span>)<span class="keyword">this</span>.comboBox1.SelectedItem)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;CSharp&quot;</span>:</span><br><span class="line">                    provider = CodeDomProvider.CreateProvider(<span class="string">&quot;CSharp&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;Visual Basic&quot;</span>:</span><br><span class="line">                    provider = CodeDomProvider.CreateProvider(<span class="string">&quot;VisualBasic&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;JScript&quot;</span>:</span><br><span class="line">                    provider = CodeDomProvider.CreateProvider(<span class="string">&quot;JScript&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="literal">default</span>:</span><br><span class="line">                    provider = CodeDomProvider.CreateProvider(<span class="string">&quot;CSharp&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> provider;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CodeDomExampleForm</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.SuspendLayout();</span><br><span class="line">            <span class="comment">// Set properties for label1</span></span><br><span class="line">            <span class="keyword">this</span>.label1.Location = <span class="keyword">new</span> System.Drawing.Point(<span class="number">395</span>, <span class="number">20</span>);</span><br><span class="line">            <span class="keyword">this</span>.label1.Size = <span class="keyword">new</span> Size(<span class="number">180</span>, <span class="number">22</span>);</span><br><span class="line">            <span class="keyword">this</span>.label1.Text = <span class="string">&quot;Select a programming language:&quot;</span>;</span><br><span class="line">            <span class="comment">// Set properties for comboBox1</span></span><br><span class="line">            <span class="keyword">this</span>.comboBox1.Location = <span class="keyword">new</span> System.Drawing.Point(<span class="number">560</span>, <span class="number">16</span>);</span><br><span class="line">            <span class="keyword">this</span>.comboBox1.Size = <span class="keyword">new</span> Size(<span class="number">190</span>, <span class="number">23</span>);</span><br><span class="line">            <span class="keyword">this</span>.comboBox1.Name = <span class="string">&quot;comboBox1&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>.comboBox1.Items.AddRange(<span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;CSharp&quot;</span>, <span class="string">&quot;Visual Basic&quot;</span>, <span class="string">&quot;JScript&quot;</span> &#125;);</span><br><span class="line">            <span class="keyword">this</span>.comboBox1.Anchor = System.Windows.Forms.AnchorStyles.Left</span><br><span class="line">                                    | System.Windows.Forms.AnchorStyles.Right</span><br><span class="line">                                    | System.Windows.Forms.AnchorStyles.Top;</span><br><span class="line">            <span class="keyword">this</span>.comboBox1.SelectedIndex = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// Set properties for generate_button. </span></span><br><span class="line">            <span class="keyword">this</span>.generate_button.Location = <span class="keyword">new</span> System.Drawing.Point(<span class="number">8</span>, <span class="number">16</span>);</span><br><span class="line">            <span class="keyword">this</span>.generate_button.Name = <span class="string">&quot;generate_button&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>.generate_button.Size = <span class="keyword">new</span> System.Drawing.Size(<span class="number">120</span>, <span class="number">23</span>);</span><br><span class="line">            <span class="keyword">this</span>.generate_button.Text = <span class="string">&quot;Generate Code&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>.generate_button.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.generate_button_Click);</span><br><span class="line">            <span class="comment">// Set properties for compile_button.</span></span><br><span class="line">            <span class="keyword">this</span>.compile_button.Location = <span class="keyword">new</span> System.Drawing.Point(<span class="number">136</span>, <span class="number">16</span>);</span><br><span class="line">            <span class="keyword">this</span>.compile_button.Name = <span class="string">&quot;compile_button&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>.compile_button.Size = <span class="keyword">new</span> System.Drawing.Size(<span class="number">120</span>, <span class="number">23</span>);</span><br><span class="line">            <span class="keyword">this</span>.compile_button.Text = <span class="string">&quot;Compile&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>.compile_button.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.compile_button_Click);</span><br><span class="line">            <span class="comment">// Set properties for run_button.</span></span><br><span class="line">            <span class="keyword">this</span>.run_button.Enabled = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.run_button.Location = <span class="keyword">new</span> System.Drawing.Point(<span class="number">264</span>, <span class="number">16</span>);</span><br><span class="line">            <span class="keyword">this</span>.run_button.Name = <span class="string">&quot;run_button&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>.run_button.Size = <span class="keyword">new</span> System.Drawing.Size(<span class="number">120</span>, <span class="number">23</span>);</span><br><span class="line">            <span class="keyword">this</span>.run_button.Text = <span class="string">&quot;Run&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>.run_button.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.run_button_Click);</span><br><span class="line">            <span class="comment">// Set properties for textBox1.        </span></span><br><span class="line">            <span class="keyword">this</span>.textBox1.Anchor = (System.Windows.Forms.AnchorStyles.Top</span><br><span class="line">                                     | System.Windows.Forms.AnchorStyles.Bottom</span><br><span class="line">                                     | System.Windows.Forms.AnchorStyles.Left</span><br><span class="line">                                     | System.Windows.Forms.AnchorStyles.Right);</span><br><span class="line">            <span class="keyword">this</span>.textBox1.Location = <span class="keyword">new</span> System.Drawing.Point(<span class="number">8</span>, <span class="number">48</span>);</span><br><span class="line">            <span class="keyword">this</span>.textBox1.Multiline = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">this</span>.textBox1.ScrollBars = System.Windows.Forms.ScrollBars.Vertical;</span><br><span class="line">            <span class="keyword">this</span>.textBox1.Name = <span class="string">&quot;textBox1&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>.textBox1.Size = <span class="keyword">new</span> System.Drawing.Size(<span class="number">744</span>, <span class="number">280</span>);</span><br><span class="line">            <span class="keyword">this</span>.textBox1.Text = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="comment">// Set properties for the CodeDomExampleForm.</span></span><br><span class="line">            <span class="keyword">this</span>.AutoScaleBaseSize = <span class="keyword">new</span> System.Drawing.Size(<span class="number">5</span>, <span class="number">13</span>);</span><br><span class="line">            <span class="keyword">this</span>.ClientSize = <span class="keyword">new</span> System.Drawing.Size(<span class="number">768</span>, <span class="number">340</span>);</span><br><span class="line">            <span class="keyword">this</span>.MinimumSize = <span class="keyword">new</span> System.Drawing.Size(<span class="number">750</span>, <span class="number">340</span>);</span><br><span class="line">            <span class="keyword">this</span>.Controls.AddRange(<span class="keyword">new</span> System.Windows.Forms.Control[] &#123;<span class="keyword">this</span>.textBox1,</span><br><span class="line">                <span class="keyword">this</span>.run_button, <span class="keyword">this</span>.compile_button, <span class="keyword">this</span>.generate_button,</span><br><span class="line">                <span class="keyword">this</span>.comboBox1, <span class="keyword">this</span>.label1 &#125;);</span><br><span class="line">            <span class="keyword">this</span>.Name = <span class="string">&quot;CodeDomExampleForm&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>.Text = <span class="string">&quot;CodeDom Hello World Example&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>.ResumeLayout(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"><span class="built_in">bool</span> disposing</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">base</span>.Dispose(disposing);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">STAThread</span>]</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Application.Run(<span class="keyword">new</span> CodeDomExampleForm());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/21/CSharp-CodeDOM%E7%94%9F%E6%88%90%E7%B1%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/21/CSharp-CodeDOM%E7%94%9F%E6%88%90%E7%B1%BB/" class="post-title-link" itemprop="url">CSharp-CodeDOM生成类</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-21 09:24:11" itemprop="dateCreated datePublished" datetime="2019-01-21T09:24:11+00:00">2019-01-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-14 09:41:31" itemprop="dateModified" datetime="2021-04-14T09:41:31+00:00">2021-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CodeDOM/" itemprop="url" rel="index"><span itemprop="name">CodeDOM</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CSharp-CodeDOM生成类"><a href="#CSharp-CodeDOM生成类" class="headerlink" title="CSharp-CodeDOM生成类"></a>CSharp-CodeDOM生成类</h1><p>CodeDOM:代码文档对象模型。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/dynamic-source-code-generation-and-compilation">动态源代码生成和编译</a></p>
<p>.NET Framework 包括一个名为代码文档对象模型 (CodeDOM) 的机制。通过该机制，发出源代码的程序开发者可基于一种表示要呈现的代码的单一模型，在运行时以多种编程语言生成源代码。<br>为表示源代码，CodeDOM 元素相互链接，构成一个名为 CodeDOM 图的数据结构。该数据结构对某些源代码的结构建模。</p>
<p><code>System.CodeDom</code> 命名空间定义某些类型，这些类型可以表示源代码的逻辑结构，且不依赖特定编程语言。 <code>System.CodeDom.Compiler</code> 命名空间定义某些类型，用于从 CodeDOM 图中生成源代码，并管理使用支持语言的源代码的编译工作。 编译器供应商或开发人员可以扩展支持语言。</p>
<p>.NET Framework 包括适用于 <code>CSharpCodeProvider</code>、<code>JScriptCodeProvider</code> 和 <code>VBCodeProvider</code> 的代码生成器和代码编译器。</p>
<h2 id="使用CodeDOM创建类"><a href="#使用CodeDOM创建类" class="headerlink" title="使用CodeDOM创建类"></a>使用CodeDOM创建类</h2><p>CodeDOM 提供表示多种常见源代码元素的类型。 可以设计一个程序，它使用 CodeDOM 元素生成源代码模型来组合对象图。 对于支持的编程语言，可使用 CodeDOM 代码生成器将此对象图呈现为源代码。 还可使用 CodeDOM 将源代码编译为二进制程序集。</p>
<p>CodeDOM 的常见用途包括：</p>
<ul>
<li>模板化代码生成：生成适用于 ASP.NET、XML Web 服务客户端代理、代码向导、设计器或其他代码发出机制的代码。</li>
<li>动态编译：支持一种或多种语言的代码编译。</li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/using-the-codedom">使用 CodeDom</a></p>
<p><code>System.CodeDom</code> 命名空间提供用于表示源代码逻辑结构的类，独立于语言语法。</p>
<p>CodeDOM 图的结构类似于一个容器树。 每个可编译 CodeDOM 图的顶端容器或根部容器是 <code>CodeCompileUnit</code>。 源代码模型中的每个元素都必须通过图中 <code>CodeObject</code> 的属性链接至该图。</p>
<p>CodeDOM 定义名为 <code>CodeCompileUnit</code> 的对象，可引用 CodeDOM 对象图，该对象图塑造要编译的源代码的模型。 <code>CodeCompileUnit</code> 具有属性可用于存储对特性、命名空间和程序集的引用。</p>
<p>派生自 <code>CodeDomProvider</code> 类的 CodeDom 提供程序包含处理 CodeCompileUnit 所引用的对象图的方法。</p>
<p>详细请参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/how-to-create-a-class-using-codedom">如何：使用 CodeDOM 创建类</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.codedom.codestatement?view=netframework-4.7.2">CodeStatement Class</a></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> System;</span><br><span class="line">    <span class="keyword">using</span> System.CodeDom;</span><br><span class="line">    <span class="keyword">using</span> System.CodeDom.Compiler;</span><br><span class="line">    <span class="keyword">using</span> System.IO;</span><br><span class="line">    <span class="keyword">using</span> System.Reflection;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> This code example creates a graph using a CodeCompileUnit and</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> generates source code for the graph using the CSharpCodeProvider.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">Sample</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Define the compile unit to use for code generation.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> CodeCompileUnit targetUnit;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> The only class in the compile unit. This class contains 2 fields,</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 3 properties, a constructor, an entry point, and 1 simple method.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> CodeTypeDeclaration targetClass;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> The name of the file to contain the source code.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> outputFileName = <span class="string">&quot;SampleCode.cs&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Define the class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Sample</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// 创建编译单元</span></span><br><span class="line">            targetUnit = <span class="keyword">new</span> CodeCompileUnit();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 定义命名空间</span></span><br><span class="line">            CodeNamespace samples = <span class="keyword">new</span> CodeNamespace(<span class="string">&quot;CodeDOMSample&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 导入命名空间</span></span><br><span class="line">            samples.Imports.Add(<span class="keyword">new</span> CodeNamespaceImport(<span class="string">&quot;System&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 定义类型</span></span><br><span class="line">            targetClass = <span class="keyword">new</span> CodeTypeDeclaration(<span class="string">&quot;CodeDOMCreatedClass&quot;</span>);</span><br><span class="line">            targetClass.IsClass = <span class="literal">true</span>;</span><br><span class="line">            targetClass.TypeAttributes =</span><br><span class="line">                TypeAttributes.Public | TypeAttributes.Sealed;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 向命名空间添加类型</span></span><br><span class="line">            samples.Types.Add(targetClass);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将代码元素链接至对象图</span></span><br><span class="line">            targetUnit.Namespaces.Add(samples);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Adds two fields to the class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddFields</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Declare the widthValue field.</span></span><br><span class="line">            CodeMemberField widthValueField = <span class="keyword">new</span> CodeMemberField();</span><br><span class="line">            widthValueField.Attributes = MemberAttributes.Private;</span><br><span class="line">            widthValueField.Name = <span class="string">&quot;widthValue&quot;</span>;</span><br><span class="line">            widthValueField.Type = <span class="keyword">new</span> CodeTypeReference(<span class="keyword">typeof</span>(System.Double));</span><br><span class="line">            widthValueField.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(</span><br><span class="line">                <span class="string">&quot;The width of the object.&quot;</span>));</span><br><span class="line">            targetClass.Members.Add(widthValueField);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Declare the heightValue field</span></span><br><span class="line">            CodeMemberField heightValueField = <span class="keyword">new</span> CodeMemberField();</span><br><span class="line">            heightValueField.Attributes = MemberAttributes.Private;</span><br><span class="line">            heightValueField.Name = <span class="string">&quot;heightValue&quot;</span>;</span><br><span class="line">            heightValueField.Type =</span><br><span class="line">                <span class="keyword">new</span> CodeTypeReference(<span class="keyword">typeof</span>(System.Double));</span><br><span class="line">            heightValueField.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(</span><br><span class="line">                <span class="string">&quot;The height of the object.&quot;</span>));</span><br><span class="line">            targetClass.Members.Add(heightValueField);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Add three properties to the class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddProperties</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Declare the read-only Width property.</span></span><br><span class="line">            CodeMemberProperty widthProperty = <span class="keyword">new</span> CodeMemberProperty();</span><br><span class="line">            widthProperty.Attributes =</span><br><span class="line">                MemberAttributes.Public | MemberAttributes.Final;</span><br><span class="line">            widthProperty.Name = <span class="string">&quot;Width&quot;</span>;</span><br><span class="line">            widthProperty.HasGet = <span class="literal">true</span>;</span><br><span class="line">            widthProperty.Type = <span class="keyword">new</span> CodeTypeReference(<span class="keyword">typeof</span>(System.Double));</span><br><span class="line">            widthProperty.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(</span><br><span class="line">                <span class="string">&quot;The Width property for the object.&quot;</span>));</span><br><span class="line">            widthProperty.GetStatements.Add(<span class="keyword">new</span> CodeMethodReturnStatement(</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;widthValue&quot;</span>)));</span><br><span class="line">            targetClass.Members.Add(widthProperty);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Declare the read-only Height property.</span></span><br><span class="line">            CodeMemberProperty heightProperty = <span class="keyword">new</span> CodeMemberProperty();</span><br><span class="line">            heightProperty.Attributes =</span><br><span class="line">                MemberAttributes.Public | MemberAttributes.Final;</span><br><span class="line">            heightProperty.Name = <span class="string">&quot;Height&quot;</span>;</span><br><span class="line">            heightProperty.HasGet = <span class="literal">true</span>;</span><br><span class="line">            heightProperty.Type = <span class="keyword">new</span> CodeTypeReference(<span class="keyword">typeof</span>(System.Double));</span><br><span class="line">            heightProperty.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(</span><br><span class="line">                <span class="string">&quot;The Height property for the object.&quot;</span>));</span><br><span class="line">            heightProperty.GetStatements.Add(<span class="keyword">new</span> CodeMethodReturnStatement(</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;heightValue&quot;</span>)));</span><br><span class="line">            targetClass.Members.Add(heightProperty);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Declare the read only Area property.</span></span><br><span class="line">            CodeMemberProperty areaProperty = <span class="keyword">new</span> CodeMemberProperty();</span><br><span class="line">            areaProperty.Attributes =</span><br><span class="line">                MemberAttributes.Public | MemberAttributes.Final;</span><br><span class="line">            areaProperty.Name = <span class="string">&quot;Area&quot;</span>;</span><br><span class="line">            areaProperty.HasGet = <span class="literal">true</span>;</span><br><span class="line">            areaProperty.Type = <span class="keyword">new</span> CodeTypeReference(<span class="keyword">typeof</span>(System.Double));</span><br><span class="line">            areaProperty.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(</span><br><span class="line">                <span class="string">&quot;The Area property for the object.&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create an expression to calculate the area for the get accessor</span></span><br><span class="line">            <span class="comment">// of the Area property.</span></span><br><span class="line">            CodeBinaryOperatorExpression areaExpression =</span><br><span class="line">                <span class="keyword">new</span> CodeBinaryOperatorExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;widthValue&quot;</span>),</span><br><span class="line">                CodeBinaryOperatorType.Multiply,</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;heightValue&quot;</span>));</span><br><span class="line">            areaProperty.GetStatements.Add(</span><br><span class="line">                <span class="keyword">new</span> CodeMethodReturnStatement(areaExpression));</span><br><span class="line">            targetClass.Members.Add(areaProperty);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Adds a method to the class. This method multiplies values stored</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> in both fields.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Declaring a ToString method</span></span><br><span class="line">            CodeMemberMethod toStringMethod = <span class="keyword">new</span> CodeMemberMethod();</span><br><span class="line">            toStringMethod.Attributes =</span><br><span class="line">                MemberAttributes.Public | MemberAttributes.Override;</span><br><span class="line">            toStringMethod.Name = <span class="string">&quot;ToString&quot;</span>;</span><br><span class="line">            toStringMethod.ReturnType =</span><br><span class="line">                <span class="keyword">new</span> CodeTypeReference(<span class="keyword">typeof</span>(System.String));</span><br><span class="line"></span><br><span class="line">            CodeFieldReferenceExpression widthReference =</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;Width&quot;</span>);</span><br><span class="line">            CodeFieldReferenceExpression heightReference =</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;Height&quot;</span>);</span><br><span class="line">            CodeFieldReferenceExpression areaReference =</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;Area&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Declaring a return statement for method ToString.</span></span><br><span class="line">            CodeMethodReturnStatement returnStatement =</span><br><span class="line">                <span class="keyword">new</span> CodeMethodReturnStatement();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This statement returns a string representation of the width,</span></span><br><span class="line">            <span class="comment">// height, and area.</span></span><br><span class="line">            <span class="built_in">string</span> formattedOutput = <span class="string">&quot;The object:&quot;</span> + Environment.NewLine +</span><br><span class="line">                <span class="string">&quot; width = &#123;0&#125;,&quot;</span> + Environment.NewLine +</span><br><span class="line">                <span class="string">&quot; height = &#123;1&#125;,&quot;</span> + Environment.NewLine +</span><br><span class="line">                <span class="string">&quot; area = &#123;2&#125;&quot;</span>;</span><br><span class="line">            returnStatement.Expression =</span><br><span class="line">                <span class="keyword">new</span> CodeMethodInvokeExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeTypeReferenceExpression(<span class="string">&quot;System.String&quot;</span>), <span class="string">&quot;Format&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> CodePrimitiveExpression(formattedOutput),</span><br><span class="line">                widthReference, heightReference, areaReference);</span><br><span class="line">            toStringMethod.Statements.Add(returnStatement);</span><br><span class="line">            targetClass.Members.Add(toStringMethod);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Add a constructor to the class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddConstructor</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Declare the constructor</span></span><br><span class="line">            CodeConstructor constructor = <span class="keyword">new</span> CodeConstructor();</span><br><span class="line">            constructor.Attributes =</span><br><span class="line">                MemberAttributes.Public | MemberAttributes.Final;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add parameters.</span></span><br><span class="line">            constructor.Parameters.Add(<span class="keyword">new</span> CodeParameterDeclarationExpression(</span><br><span class="line">                <span class="keyword">typeof</span>(System.Double), <span class="string">&quot;width&quot;</span>));</span><br><span class="line">            constructor.Parameters.Add(<span class="keyword">new</span> CodeParameterDeclarationExpression(</span><br><span class="line">                <span class="keyword">typeof</span>(System.Double), <span class="string">&quot;height&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add field initialization logic</span></span><br><span class="line">            CodeFieldReferenceExpression widthReference =</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;widthValue&quot;</span>);</span><br><span class="line">            constructor.Statements.Add(<span class="keyword">new</span> CodeAssignStatement(widthReference,</span><br><span class="line">                <span class="keyword">new</span> CodeArgumentReferenceExpression(<span class="string">&quot;width&quot;</span>)));</span><br><span class="line">            CodeFieldReferenceExpression heightReference =</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;heightValue&quot;</span>);</span><br><span class="line">            constructor.Statements.Add(<span class="keyword">new</span> CodeAssignStatement(heightReference,</span><br><span class="line">                <span class="keyword">new</span> CodeArgumentReferenceExpression(<span class="string">&quot;height&quot;</span>)));</span><br><span class="line">            targetClass.Members.Add(constructor);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Add an entry point to the class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddEntryPoint</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// 为可执行程序定义代码入口点方法</span></span><br><span class="line">            CodeEntryPointMethod start = <span class="keyword">new</span> CodeEntryPointMethod();</span><br><span class="line">            CodeObjectCreateExpression objectCreate =</span><br><span class="line">                <span class="keyword">new</span> CodeObjectCreateExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeTypeReference(<span class="string">&quot;CodeDOMCreatedClass&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> CodePrimitiveExpression(<span class="number">5.3</span>),</span><br><span class="line">                <span class="keyword">new</span> CodePrimitiveExpression(<span class="number">6.9</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the statement:</span></span><br><span class="line">            <span class="comment">// &quot;CodeDOMCreatedClass testClass =</span></span><br><span class="line">            <span class="comment">//     new CodeDOMCreatedClass(5.3, 6.9);&quot;</span></span><br><span class="line">            start.Statements.Add(<span class="keyword">new</span> CodeVariableDeclarationStatement(</span><br><span class="line">                <span class="keyword">new</span> CodeTypeReference(<span class="string">&quot;CodeDOMCreatedClass&quot;</span>), <span class="string">&quot;testClass&quot;</span>,</span><br><span class="line">                objectCreate));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Creat the expression:</span></span><br><span class="line">            <span class="comment">// &quot;testClass.ToString()&quot;</span></span><br><span class="line">            CodeMethodInvokeExpression toStringInvoke =</span><br><span class="line">                <span class="keyword">new</span> CodeMethodInvokeExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeVariableReferenceExpression(<span class="string">&quot;testClass&quot;</span>), <span class="string">&quot;ToString&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add a System.Console.WriteLine statement with the previous</span></span><br><span class="line">            <span class="comment">// expression as a parameter.</span></span><br><span class="line">            start.Statements.Add(<span class="keyword">new</span> CodeMethodInvokeExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeTypeReferenceExpression(<span class="string">&quot;System.Console&quot;</span>),</span><br><span class="line">                <span class="string">&quot;WriteLine&quot;</span>, toStringInvoke));</span><br><span class="line">            targetClass.Members.Add(start);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Generate CSharp source code from the compile unit.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filename&quot;&gt;</span>Output file name<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GenerateCSharpCode</span>(<span class="params"><span class="built_in">string</span> fileName</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            CodeDomProvider provider = CodeDomProvider.CreateProvider(<span class="string">&quot;CSharp&quot;</span>);</span><br><span class="line">            CodeGeneratorOptions options = <span class="keyword">new</span> CodeGeneratorOptions();</span><br><span class="line">            options.BracingStyle = <span class="string">&quot;C&quot;</span>;</span><br><span class="line">            <span class="keyword">using</span> (StreamWriter sourceWriter = <span class="keyword">new</span> StreamWriter(fileName))</span><br><span class="line">            &#123;</span><br><span class="line">                provider.GenerateCodeFromCompileUnit(</span><br><span class="line">                    targetUnit, sourceWriter, options);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Create the CodeDOM graph and generate the code.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Sample sample = <span class="keyword">new</span> Sample();</span><br><span class="line">            sample.AddFields();</span><br><span class="line">            sample.AddProperties();</span><br><span class="line">            sample.AddMethod();</span><br><span class="line">            sample.AddConstructor();</span><br><span class="line">            sample.AddEntryPoint();</span><br><span class="line">            sample.GenerateCSharpCode(outputFileName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成类的代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// &lt;auto-generated&gt;</span></span><br><span class="line"><span class="comment">//     此代码由工具生成。</span></span><br><span class="line"><span class="comment">//     运行时版本:4.0.30319.42000</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     对此文件的更改可能会导致不正确的行为，并且如果</span></span><br><span class="line"><span class="comment">//     重新生成代码，这些更改将会丢失。</span></span><br><span class="line"><span class="comment">// &lt;/auto-generated&gt;</span></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CodeDOMSample</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">CodeDOMCreatedClass</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The width of the object.</span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">double</span> widthValue;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The height of the object.</span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">double</span> heightValue;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CodeDOMCreatedClass</span>(<span class="params"><span class="built_in">double</span> width, <span class="built_in">double</span> height</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.widthValue = width;</span><br><span class="line">            <span class="keyword">this</span>.heightValue = height;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The Width property for the object.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> Width</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.widthValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The Height property for the object.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> Height</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.heightValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The Area property for the object.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> Area</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> (<span class="keyword">this</span>.widthValue * <span class="keyword">this</span>.heightValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">string</span>.Format(<span class="string">&quot;The object:\r\n width = &#123;0&#125;,\r\n height = &#123;1&#125;,\r\n area = &#123;2&#125;&quot;</span>, <span class="keyword">this</span>.Width, <span class="keyword">this</span>.Height, <span class="keyword">this</span>.Area);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            CodeDOMCreatedClass testClass = <span class="keyword">new</span> CodeDOMCreatedClass(<span class="number">5.3</span>D, <span class="number">6.9</span>D);</span><br><span class="line">            System.Console.WriteLine(testClass.ToString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
































































































      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/17/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E6%B3%9B%E5%9E%8B%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/17/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E6%B3%9B%E5%9E%8B%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">CSharp反射发出-定义泛型方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-17 15:29:32" itemprop="dateCreated datePublished" datetime="2019-01-17T15:29:32+00:00">2019-01-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-14 09:41:31" itemprop="dateModified" datetime="2021-04-14T09:41:31+00:00">2021-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Emit-%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA/" itemprop="url" rel="index"><span itemprop="name">Emit(反射发出)</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><font color=#ff0000 size=4 face="黑体">某方法只要属于泛型类型，且使用该类型的类型参数，就不是泛型方法。 只有当方法有属于自己的类型参数列表时才是泛型方法。</font></p>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/how-to-define-a-generic-method-with-reflection-emit">用反射发出定义泛型方法</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/collectible-assemblies">动态类型生成的可回收程序集</a></p>
<p><font color=#ff0000 size=4 face="黑体">如果发出对泛型类型方法的调用，并且这些类型的类型参数是泛型方法的类型参数，则必须使用 TypeBuilder 类的 staticGetConstructor(Type, ConstructorInfo)、GetMethod(Type, MethodInfo) 和 GetField(Type, FieldInfo) 方法重载来获取方法的构造窗体。</font></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> System;</span><br><span class="line">    <span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line">    <span class="keyword">using</span> System.Reflection;</span><br><span class="line">    <span class="keyword">using</span> System.Reflection.Emit;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Declare a generic delegate that can be used to execute the </span></span><br><span class="line">    <span class="comment">// finished method.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> TOut <span class="title">D</span>&lt;<span class="title">TIn</span>, <span class="title">TOut</span>&gt;(<span class="params">TIn[] input</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">GenericMethodBuilder</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// This method shows how to declare, in Visual Basic, the generic</span></span><br><span class="line">        <span class="comment">// method this program emits. The method has two type parameters,</span></span><br><span class="line">        <span class="comment">// TInput and TOutput, the second of which must be a reference type</span></span><br><span class="line">        <span class="comment">// (class), must have a parameterless constructor (new()), and must</span></span><br><span class="line">        <span class="comment">// implement ICollection&lt;TInput&gt;. This interface constraint</span></span><br><span class="line">        <span class="comment">// ensures that ICollection&lt;TInput&gt;.Add can be used to add</span></span><br><span class="line">        <span class="comment">// elements to the TOutput object the method creates. The method </span></span><br><span class="line">        <span class="comment">// has one formal parameter, input, which is an array of TInput. </span></span><br><span class="line">        <span class="comment">// The elements of this array are copied to the new TOutput.</span></span><br><span class="line">        <span class="comment">// 1,该方法具有两个类型参数：TInput 和 TOutput。</span></span><br><span class="line">        <span class="comment">// 其中第二个参数必须具备以下条件：是引用类型 (class)；具有无参数构造函数 (new)；</span></span><br><span class="line">        <span class="comment">// 实现 ICollection(Of TInput)（在 C# 中为 ICollection&lt;TInput&gt;）。</span></span><br><span class="line">        <span class="comment">// 此接口约束确保可使用 ICollection&lt;T&gt;.Add 方法将元素添加到该方法</span></span><br><span class="line">        <span class="comment">// 创建的 TOutput 集合。 该方法具有一个形参 input，它是 TInput 的数组。</span></span><br><span class="line">        <span class="comment">// 该方法将创建一个 TOutput 类型的集合，并将 input 的元素复制到该集合。</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TOutput <span class="title">Factory</span>&lt;<span class="title">TInput</span>, <span class="title">TOutput</span>&gt;(<span class="params">TInput[] tarray</span>)</span></span><br><span class="line"><span class="function">            <span class="keyword">where</span> TOutput : <span class="keyword">class</span>, ICollection&lt;TInput&gt;, <span class="keyword">new</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            TOutput ret = <span class="keyword">new</span> TOutput();</span><br><span class="line">            ICollection&lt;TInput&gt; ic = ret;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (TInput t <span class="keyword">in</span> tarray)</span><br><span class="line">            &#123;</span><br><span class="line">                ic.Add(t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// The following shows the usage syntax of the C#</span></span><br><span class="line">            <span class="comment">// version of the generic method emitted by this program.</span></span><br><span class="line">            <span class="comment">// Note that the generic parameters must be specified </span></span><br><span class="line">            <span class="comment">// explicitly, because the compiler does not have enough </span></span><br><span class="line">            <span class="comment">// context to infer the type of TOutput. In this case, TOutput</span></span><br><span class="line">            <span class="comment">// is a generic List containing strings.</span></span><br><span class="line">            <span class="comment">// </span></span><br><span class="line">            <span class="built_in">string</span>[] arr = &#123; <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="string">&quot;e&quot;</span> &#125;;</span><br><span class="line">            List&lt;<span class="built_in">string</span>&gt; list1 =</span><br><span class="line">                GenericMethodBuilder.Factory&lt;<span class="built_in">string</span>, List&lt;<span class="built_in">string</span>&gt;&gt;(arr);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;The first element is: &#123;0&#125;&quot;</span>, list1[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Creating a dynamic assembly requires an AssemblyName</span></span><br><span class="line">            <span class="comment">// object, and the current application domain.</span></span><br><span class="line">            <span class="comment">// 2,定义动态程序集和动态模块，以包含泛型方法所属类型。</span></span><br><span class="line">            AssemblyName asmName = <span class="keyword">new</span> AssemblyName(<span class="string">&quot;DemoMethodBuilder1&quot;</span>);</span><br><span class="line">            AppDomain domain = AppDomain.CurrentDomain;</span><br><span class="line">            AssemblyBuilder demoAssembly =</span><br><span class="line">                domain.DefineDynamicAssembly(asmName,</span><br><span class="line">                    AssemblyBuilderAccess.RunAndSave);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Define the module that contains the code. For an </span></span><br><span class="line">            <span class="comment">// assembly with one module, the module name is the </span></span><br><span class="line">            <span class="comment">// assembly name plus a file extension.</span></span><br><span class="line">            ModuleBuilder demoModule =</span><br><span class="line">                demoAssembly.DefineDynamicModule(asmName.Name,</span><br><span class="line">                    asmName.Name + <span class="string">&quot;.dll&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Define a type to contain the method.</span></span><br><span class="line">            <span class="comment">// 3,定义泛型方法所属类型。 该类型不一定是泛型类型。</span></span><br><span class="line">            <span class="comment">// 泛型方法可以属于泛型或非泛型类型。</span></span><br><span class="line">            TypeBuilder demoType =</span><br><span class="line">                demoModule.DefineType(<span class="string">&quot;DemoType&quot;</span>, TypeAttributes.Public);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Define a public static method with standard calling</span></span><br><span class="line">            <span class="comment">// conventions. Do not specify the parameter types or the</span></span><br><span class="line">            <span class="comment">// return type, because type parameters will be used for </span></span><br><span class="line">            <span class="comment">// those types, and the type parameters have not been</span></span><br><span class="line">            <span class="comment">// defined yet.</span></span><br><span class="line">            <span class="comment">// 4,定义泛型方法。 </span></span><br><span class="line">            MethodBuilder factory =</span><br><span class="line">                demoType.DefineMethod(<span class="string">&quot;Factory&quot;</span>,</span><br><span class="line">                    MethodAttributes.Public | MethodAttributes.Static);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Defining generic type parameters for the method makes it a</span></span><br><span class="line">            <span class="comment">// generic method. To make the code easier to read, each</span></span><br><span class="line">            <span class="comment">// type parameter is copied to a variable of the same name.</span></span><br><span class="line">            <span class="comment">// 4,通过将包含参数名称的字符串数组传递给 MethodBuilder.DefineGenericParameters</span></span><br><span class="line">            <span class="comment">// 方法来定义 DemoMethod 的泛型类型参数。 这使该方法成为泛型方法。</span></span><br><span class="line">            <span class="built_in">string</span>[] typeParameterNames = &#123; <span class="string">&quot;TInput&quot;</span>, <span class="string">&quot;TOutput&quot;</span> &#125;;</span><br><span class="line">            GenericTypeParameterBuilder[] typeParameters =</span><br><span class="line">                factory.DefineGenericParameters(typeParameterNames);</span><br><span class="line"></span><br><span class="line">            GenericTypeParameterBuilder TInput = typeParameters[<span class="number">0</span>];</span><br><span class="line">            GenericTypeParameterBuilder TOutput = typeParameters[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add special constraints.</span></span><br><span class="line">            <span class="comment">// The type parameter TOutput is constrained to be a reference</span></span><br><span class="line">            <span class="comment">// type, and to have a parameterless constructor. This ensures</span></span><br><span class="line">            <span class="comment">// that the Factory method can create the collection type.</span></span><br><span class="line">            <span class="comment">// 6,可以选择向类型参数添加特殊约束。</span></span><br><span class="line">            <span class="comment">// 使用 SetGenericParameterAttributes 方法添加特殊约束。</span></span><br><span class="line">            <span class="comment">// 约束 TOutput 作为引用类型并且具有无参数构造函数。</span></span><br><span class="line">            TOutput.SetGenericParameterAttributes(</span><br><span class="line">                GenericParameterAttributes.ReferenceTypeConstraint |</span><br><span class="line">                GenericParameterAttributes.DefaultConstructorConstraint);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add interface and base type constraints.</span></span><br><span class="line">            <span class="comment">// The type parameter TOutput is constrained to types that</span></span><br><span class="line">            <span class="comment">// implement the ICollection&lt;T&gt; interface, to ensure that</span></span><br><span class="line">            <span class="comment">// they have an Add method that can be used to add elements.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// To create the constraint, first use MakeGenericType to bind </span></span><br><span class="line">            <span class="comment">// the type parameter TInput to the ICollection&lt;T&gt; interface,</span></span><br><span class="line">            <span class="comment">// returning the type ICollection&lt;TInput&gt;, then pass</span></span><br><span class="line">            <span class="comment">// the newly created type to the SetInterfaceConstraints</span></span><br><span class="line">            <span class="comment">// method. The constraints must be passed as an array, even if</span></span><br><span class="line">            <span class="comment">// there is only one interface.</span></span><br><span class="line">            <span class="comment">// 7,可以选择向类型参数添加类约束和接口约束。</span></span><br><span class="line">            <span class="comment">// 约束类型参数 TOutput 为实现 ICollection&lt;TInput&gt;）接口的类型。</span></span><br><span class="line">            Type icoll = <span class="keyword">typeof</span>(ICollection&lt;&gt;);</span><br><span class="line">            Type icollOfTInput = icoll.MakeGenericType(TInput);</span><br><span class="line">            Type[] constraints = &#123; icollOfTInput &#125;;</span><br><span class="line">            TOutput.SetInterfaceConstraints(constraints);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set parameter types for the method. The method takes</span></span><br><span class="line">            <span class="comment">// one parameter, an array of type TInput.</span></span><br><span class="line">            <span class="comment">// 8,使用 SetParameters 方法定义方法的形参。</span></span><br><span class="line">            Type[] parms = &#123; TInput.MakeArrayType() &#125;;</span><br><span class="line">            factory.SetParameters(parms);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set the return type for the method. The return type is</span></span><br><span class="line">            <span class="comment">// the generic type parameter TOutput.</span></span><br><span class="line">            <span class="comment">// 9,使用 SetReturnType 方法定义该方法的返回类型。</span></span><br><span class="line">            factory.SetReturnType(TOutput);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Generate a code body for the method. </span></span><br><span class="line">            <span class="comment">// -----------------------------------</span></span><br><span class="line">            <span class="comment">// Get a code generator and declare local variables and</span></span><br><span class="line">            <span class="comment">// labels. Save the input array to a local variable.</span></span><br><span class="line">            <span class="comment">// 10，使用 ILGenerator 发出方法主体。</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// (1),获取代码生成器，并声明局部变量和标签。</span></span><br><span class="line">            ILGenerator ilgen = factory.GetILGenerator();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//用于保留该方法返回的新 TOutput</span></span><br><span class="line">            LocalBuilder retVal = ilgen.DeclareLocal(TOutput);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//用于在 TOutput 强制转换成 ICollection&lt;TInput&gt; 时进行保留；</span></span><br><span class="line">            LocalBuilder ic = ilgen.DeclareLocal(icollOfTInput);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 用于保留 TInput 对象的输入数组；</span></span><br><span class="line">            LocalBuilder input = ilgen.DeclareLocal(TInput.MakeArrayType());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//用于循环访问数组</span></span><br><span class="line">            LocalBuilder index = ilgen.DeclareLocal(<span class="keyword">typeof</span>(<span class="built_in">int</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 用于进入循环 (enterLoop)</span></span><br><span class="line">            Label enterLoop = ilgen.DefineLabel();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//用于循环的顶部 (loopAgain)</span></span><br><span class="line">            Label loopAgain = ilgen.DefineLabel();</span><br><span class="line"></span><br><span class="line">            ilgen.Emit(OpCodes.Ldarg_0);</span><br><span class="line">            ilgen.Emit(OpCodes.Stloc_S, input);<span class="comment">//将参数存储到局部变量 input</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create an instance of TOutput, using the generic method </span></span><br><span class="line">            <span class="comment">// overload of the Activator.CreateInstance method. </span></span><br><span class="line">            <span class="comment">// Using this overload requires the specified type to have</span></span><br><span class="line">            <span class="comment">// a parameterless constructor, which is the reason for adding </span></span><br><span class="line">            <span class="comment">// that constraint to TOutput. Create the constructed generic</span></span><br><span class="line">            <span class="comment">// method by passing TOutput to MakeGenericMethod. After</span></span><br><span class="line">            <span class="comment">// emitting code to call the method, emit code to store the</span></span><br><span class="line">            <span class="comment">// new TOutput in a local variable. </span></span><br><span class="line">            <span class="comment">// (2),使用 Activator.CreateInstance 方法的泛型方法重载，</span></span><br><span class="line">            <span class="comment">// 发出代码，创建 TOutput 的实例。</span></span><br><span class="line">            <span class="comment">// TOutput ret = new TOutput();</span></span><br><span class="line">            MethodInfo createInst =</span><br><span class="line">                <span class="keyword">typeof</span>(Activator).GetMethod(<span class="string">&quot;CreateInstance&quot;</span>, Type.EmptyTypes);</span><br><span class="line">            MethodInfo createInstOfTOutput =</span><br><span class="line">                createInst.MakeGenericMethod(TOutput);<span class="comment">// 创建构造泛型方法</span></span><br><span class="line"></span><br><span class="line">            ilgen.Emit(OpCodes.Call, createInstOfTOutput);</span><br><span class="line">            <span class="comment">//发出代码调用方法后,将其存储在局部变量 retVal</span></span><br><span class="line">            ilgen.Emit(OpCodes.Stloc_S, retVal);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Load the reference to the TOutput object, cast it to</span></span><br><span class="line">            <span class="comment">// ICollection&lt;TInput&gt;, and save it.</span></span><br><span class="line">            <span class="comment">// (3),发出代码，将新的 TOutput 对象强制转换为 ICollection&lt;TInput&gt;，</span></span><br><span class="line">            <span class="comment">// 并将其存储在局部变量 ic。</span></span><br><span class="line">            <span class="comment">// ICollection&lt;TInput&gt; ic = ret;</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, retVal);</span><br><span class="line">            ilgen.Emit(OpCodes.Box, TOutput);</span><br><span class="line">            ilgen.Emit(OpCodes.Castclass, icollOfTInput);</span><br><span class="line">            ilgen.Emit(OpCodes.Stloc_S, ic);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Loop through the array, adding each element to the new</span></span><br><span class="line">            <span class="comment">// instance of TOutput. Note that in order to get a MethodInfo</span></span><br><span class="line">            <span class="comment">// for ICollection&lt;TInput&gt;.Add, it is necessary to first </span></span><br><span class="line">            <span class="comment">// get the Add method for the generic type defintion,</span></span><br><span class="line">            <span class="comment">// ICollection&lt;T&gt;.Add. This is because it is not possible</span></span><br><span class="line">            <span class="comment">// to call GetMethod on icollOfTInput. The static overload of</span></span><br><span class="line">            <span class="comment">// TypeBuilder.GetMethod produces the correct MethodInfo for</span></span><br><span class="line">            <span class="comment">// the constructed type.</span></span><br><span class="line">            <span class="comment">// (4),获取表示 ICollection&lt;T&gt;.Add 方法的 MethodInfo。 </span></span><br><span class="line">            MethodInfo mAddPrep = icoll.GetMethod(<span class="string">&quot;Add&quot;</span>);</span><br><span class="line">            MethodInfo mAdd = TypeBuilder.GetMethod(icollOfTInput, mAddPrep);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize the count and enter the loop.</span></span><br><span class="line">            <span class="comment">// (5),通过加载 32 位整数 0 并将其存储在变量中，发出代码，初始化 index 变量。</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldc_I4_0);</span><br><span class="line">            ilgen.Emit(OpCodes.Stloc_S, index); <span class="comment">// index=0</span></span><br><span class="line">            ilgen.Emit(OpCodes.Br_S, enterLoop); <span class="comment">//发出代码，分支到标签 enterLoop</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Mark the beginning of the loop. Push the ICollection</span></span><br><span class="line">            <span class="comment">// reference on the stack, so it will be in position for the</span></span><br><span class="line">            <span class="comment">// call to Add. Then push the array and the index on the </span></span><br><span class="line">            <span class="comment">// stack, get the array element, and call Add (represented</span></span><br><span class="line">            <span class="comment">// by the MethodInfo mAdd) to add it to the collection.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// The other ten instructions just increment the index</span></span><br><span class="line">            <span class="comment">// and test for the end of the loop. Note the MarkLabel</span></span><br><span class="line">            <span class="comment">// method, which sets the point in the code where the </span></span><br><span class="line">            <span class="comment">// loop is entered. (See the earlier Br_S to enterLoop.)</span></span><br><span class="line">            <span class="comment">// (6),发出该循环的代码。</span></span><br><span class="line">            ilgen.MarkLabel(loopAgain);</span><br><span class="line"></span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, ic);</span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, input); <span class="comment">// 数组</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, index); <span class="comment">// 索引</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Ldelem 操作码从堆栈中弹出该索引和数组，</span></span><br><span class="line">            <span class="comment">// 然后将索引数组元素推入堆栈。</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldelem, TInput);</span><br><span class="line">            <span class="comment">// 堆栈现已准备好调用 ICollection&lt;T&gt;.Add 方法，</span></span><br><span class="line">            <span class="comment">// 该方法从堆栈中弹出集合和新元素，并将该元素添加到该集合中。</span></span><br><span class="line">            ilgen.Emit(OpCodes.Callvirt, mAdd);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// index+=1;</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, index);</span><br><span class="line">            ilgen.Emit(OpCodes.Ldc_I4_1);</span><br><span class="line">            ilgen.Emit(OpCodes.Add);</span><br><span class="line">            ilgen.Emit(OpCodes.Stloc_S, index);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用 MarkLabel，将该点设置为循环的入口点。</span></span><br><span class="line">            ilgen.MarkLabel(enterLoop);</span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, index);<span class="comment">// 加载该索引</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, input);<span class="comment">// 将输入数组推入堆栈</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldlen); <span class="comment">// 获取其长度</span></span><br><span class="line">            ilgen.Emit(OpCodes.Conv_I4);</span><br><span class="line">            ilgen.Emit(OpCodes.Clt); <span class="comment">// 二者进行比较</span></span><br><span class="line">            ilgen.Emit(OpCodes.Brtrue_S, loopAgain);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// (7),发出代码，将 TOutput 对象推入堆栈，并从该方法返回。</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, retVal);</span><br><span class="line">            ilgen.Emit(OpCodes.Ret);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Complete the type.</span></span><br><span class="line">            <span class="comment">// 11,完成包含该方法的类型，并保存程序集。</span></span><br><span class="line">            Type dt = demoType.CreateType();</span><br><span class="line">            <span class="comment">// Save the assembly, so it can be examined with Ildasm.exe.</span></span><br><span class="line">            demoAssembly.Save(asmName.Name + <span class="string">&quot;.dll&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*调用泛型方法*/</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// To create a constructed generic method that can be</span></span><br><span class="line">            <span class="comment">// executed, first call the GetMethod method on the completed </span></span><br><span class="line">            <span class="comment">// type to get the generic method definition. Call MakeGenericType</span></span><br><span class="line">            <span class="comment">// on the generic method definition to obtain the constructed</span></span><br><span class="line">            <span class="comment">// method, passing in the type arguments. In this case, the</span></span><br><span class="line">            <span class="comment">// constructed method has string for TInput and List&lt;string&gt;</span></span><br><span class="line">            <span class="comment">// for TOutput. </span></span><br><span class="line">            <span class="comment">// 1，分配泛型类型参数</span></span><br><span class="line">            MethodInfo m = dt.GetMethod(<span class="string">&quot;Factory&quot;</span>);</span><br><span class="line">            MethodInfo bound =</span><br><span class="line">                m.MakeGenericMethod(<span class="keyword">typeof</span>(<span class="built_in">string</span>), <span class="keyword">typeof</span>(List&lt;<span class="built_in">string</span>&gt;));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Display a string representing the bound method.</span></span><br><span class="line">            Console.WriteLine(bound);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Once the generic method is constructed, </span></span><br><span class="line">            <span class="comment">// you can invoke it and pass in an array of objects </span></span><br><span class="line">            <span class="comment">// representing the arguments. In this case, there is only</span></span><br><span class="line">            <span class="comment">// one element in that array, the argument &#x27;arr&#x27;.</span></span><br><span class="line">            <span class="comment">// 2，若要以后期绑定的形式调用该方法，请使用 Invoke 方法。</span></span><br><span class="line">            <span class="comment">// Factory为静态方法</span></span><br><span class="line">            <span class="built_in">object</span> o = bound.Invoke(<span class="literal">null</span>, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; arr &#125;);</span><br><span class="line">            List&lt;<span class="built_in">string</span>&gt; list2 = (List&lt;<span class="built_in">string</span>&gt;)o;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;The first element is: &#123;0&#125;&quot;</span>, list2[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// You can get better performance from multiple calls if</span></span><br><span class="line">            <span class="comment">// you bind the constructed method to a delegate. The </span></span><br><span class="line">            <span class="comment">// following code uses the generic delegate D defined </span></span><br><span class="line">            <span class="comment">// earlier.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            Type dType = <span class="keyword">typeof</span>(D&lt;<span class="built_in">string</span>, List&lt;<span class="built_in">string</span>&gt;&gt;);</span><br><span class="line">            D&lt;<span class="built_in">string</span>, List&lt;<span class="built_in">string</span>&gt;&gt; test;</span><br><span class="line">            test = (D&lt;<span class="built_in">string</span>, List&lt;<span class="built_in">string</span>&gt;&gt;)</span><br><span class="line">                Delegate.CreateDelegate(dType, bound);</span><br><span class="line"></span><br><span class="line">            List&lt;<span class="built_in">string</span>&gt; list3 = test(arr);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;The first element is: &#123;0&#125;&quot;</span>, list3[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/15/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E6%B3%9B%E5%9E%8B%E7%B1%BB%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/15/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E6%B3%9B%E5%9E%8B%E7%B1%BB%E5%9E%8B/" class="post-title-link" itemprop="url">CSharp反射发出-定义泛型类型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-15 09:52:32" itemprop="dateCreated datePublished" datetime="2019-01-15T09:52:32+00:00">2019-01-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-14 09:41:31" itemprop="dateModified" datetime="2021-04-14T09:41:31+00:00">2021-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Emit-%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA/" itemprop="url" rel="index"><span itemprop="name">Emit(反射发出)</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>某方法只要属于泛型类型，且使用该类型的类型参数，就不是泛型方法。 只有当方法有属于自己的类型参数列表时才是泛型方法。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/01/15/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E6%B3%9B%E5%9E%8B%E7%B1%BB%E5%9E%8B/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/15/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E5%92%8C%E6%89%A7%E8%A1%8C%E5%8A%A8%E6%80%81%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/15/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E5%92%8C%E6%89%A7%E8%A1%8C%E5%8A%A8%E6%80%81%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">CSharp反射发出-定义和执行动态方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-15 09:12:26" itemprop="dateCreated datePublished" datetime="2019-01-15T09:12:26+00:00">2019-01-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-14 09:41:31" itemprop="dateModified" datetime="2021-04-14T09:41:31+00:00">2021-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Emit-%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA/" itemprop="url" rel="index"><span itemprop="name">Emit(反射发出)</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>详细信息，请参考https://docs.microsoft.com/zh-cn/dotnet/api/system.reflection.emit.dynamicmethod?view=netframework-4.7.2</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/01/15/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E5%92%8C%E6%89%A7%E8%A1%8C%E5%8A%A8%E6%80%81%E6%96%B9%E6%B3%95/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/17/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><span class="page-number current">18</span><a class="page-number" href="/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/19/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">syxdevcode</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">385</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">173</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/syxdevcode" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;syxdevcode" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">syxdevcode</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
