<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"syxdevcode.github.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="syxdevcode博客">
<meta property="og:url" content="https://syxdevcode.github.com/page/10/index.html">
<meta property="og:site_name" content="syxdevcode博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="syxdevcode">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://syxdevcode.github.com/page/10/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>syxdevcode博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">syxdevcode博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/syxdevcode" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/07/24/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8814%EF%BC%89-%20Auditing%E7%9A%84%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/24/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8814%EF%BC%89-%20Auditing%E7%9A%84%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">ABP框架学习记录（14）- Auditing的实现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-24 09:23:27" itemprop="dateCreated datePublished" datetime="2019-07-24T09:23:27+00:00">2019-07-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-28 07:13:38" itemprop="dateModified" datetime="2020-09-28T07:13:38+00:00">2020-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ABP/" itemprop="url" rel="index"><span itemprop="name">ABP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ABP框架学习记录（14）-Auditing的实现"><a href="#ABP框架学习记录（14）-Auditing的实现" class="headerlink" title="ABP框架学习记录（14）- Auditing的实现"></a>ABP框架学习记录（14）- Auditing的实现</h1><p><strong>Auditing</strong>：<font color=#ff0000 size=4 face="黑体">审计跟踪（也叫审计日志）是与安全相关的信息按照时间顺序的记录，它们提供了活动序列的文档证据，这些活动序列可以在任何时间影响一个特定的操作。</font></p>
<p>Auditing 在 ABP 项目中的位置：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190727141502.png" alt="QQ截图20190727141502.png"></p>
<h2 id="基础定义"><a href="#基础定义" class="headerlink" title="基础定义"></a>基础定义</h2><p><code>AuditInfo</code>：定义需要被审计信息实体类；</p>
<p><code>AuditedAttribute</code>：用于标识一个方法或一个类的所有方法都需要启用Auditing功能。</p>
<p><code>DisableAuditingAttribute</code>：用于标识一个方法或一个类的所有方法都需要关闭Auditing功能。</p>
<p><code>IAuditSerializer</code>：提供审计序列化接口；</p>
<p><code>JsonNetAuditSerializer</code>：<code>IAuditSerializer</code> 接口的默认实现，提供序列化方法；</p>
<p><code>IAuditInfoProvider</code>：提供 <code>Fill</code> 方法，完善 <code>AuditInfo</code> 信息。</p>
<p><code>DefaultAuditInfoProvider</code>：<code>IAuditInfoProvider</code> 的默认实现；</p>
<p><code>IClientInfoProvider</code>：提供客户端信息的接口；</p>
<p><code>NullClientInfoProvider</code>：<code>IClientInfoProvider</code> 接口的默认实现；</p>
<p><code>IAuditingStore</code>：审计信息持久化接口，应由上层提供商实现；</p>
<p><code>SimpleLogAuditingStore</code>：<code>IAuditingStore</code> 接口的默认实现；</p>
<h2 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h2><p><code>AbpBootstrapper</code> 提供统一的拦截器注入入口：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190727150235.png" alt="QQ截图20190727150235.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190727150303.png" alt="QQ截图20190727150303.png"></p>
<p><code>AuditingInterceptorRegistrar</code>：审计拦截器注册类，如下图：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190727150506.png" alt="QQ截图20190727150506.png"></p>
<p><code>AuditingInterceptor</code>：审计拦截器,提供对同步方法和异步方法的拦截操作，如下图：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190727152548.png" alt="QQ截图20190727152548.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190727153054.png" alt="QQ截图20190727153054.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190727153419.png" alt="QQ截图20190727153419.png"></p>
<p><code>IAuditingHelper</code>：记录审计信息帮助类；</p>
<p><code>AuditingHelper</code>：<code>IAuditingHelper</code> 接口的实现，提供 <code>ShouldSaveAudit</code>，<code>CreateAuditInfo</code>，<code>Save</code>等方法，如下图：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190727152907.png" alt="QQ截图20190727152907.png"></p>
<p><code>IAuditingConfiguration</code>：定义用于配置审计的接口；</p>
<p><code>AuditingConfiguration</code>：<code>IAuditingConfiguration</code> 的默认实现，如下图：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190727151604.png" alt="QQ截图20190727151604.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190727153811.png" alt="QQ截图20190727153811.png"></p>
<p><code>AbpKernelModule</code> 的预初始化方法 <code>PreInitialize</code> 中调用，如下图：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190727151740.png" alt="QQ截图20190727151740.png"></p>
<p><code>IAuditingSelectorList</code>：用于选择要审计的类/接口的选择器函数列表。</p>
<p><code>AuditingSelectorList</code>：<code>IAuditingSelectorList</code>接口的默认实现；</p>
<p><code>NamedTypeSelector</code>：类型选择器，这个对象的核心属性是一个以Type为输入参数，返回Bool类型的委托 Predicate；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190727153936.png" alt="QQ截图20190727153936.png"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/1zhk/p/5342947.html">ABP源码分析十九：Auditing</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/07/22/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8813%EF%BC%89-%20Entity%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/22/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8813%EF%BC%89-%20Entity%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">ABP框架学习记录（13）- Entity解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-22 11:19:17" itemprop="dateCreated datePublished" datetime="2019-07-22T11:19:17+00:00">2019-07-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-28 07:13:38" itemprop="dateModified" datetime="2020-09-28T07:13:38+00:00">2020-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ABP/" itemprop="url" rel="index"><span itemprop="name">ABP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ABP框架学习记录（13）-Entity解析"><a href="#ABP框架学习记录（13）-Entity解析" class="headerlink" title="ABP框架学习记录（13）- Entity解析"></a>ABP框架学习记录（13）- Entity解析</h1><p><code>Entity</code> 在ABP项目中的目录位置：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190722112057.png" alt="QQ截图20190722112057.png"></p>
<h2 id="Entity"><a href="#Entity" class="headerlink" title="Entity"></a>Entity</h2><p><code>IEntity&lt;TPrimaryKey&gt;</code>：封装了PrimaryKey：Id,这是一个泛型类型，所有的实体都必须实现此接口；</p>
<p><code>IEntity</code>: 继承 <code>IEntity&lt;int&gt;</code> 泛型接口；</p>
<p><code>Entity&lt;TPrimaryKey&gt;</code>：继承 <code>IEntity&lt;TPrimaryKey&gt;</code> 接口的基础实现，支持主键是泛型的实体，该类重写了<code>Equals</code>,<code>GetHashCode</code>,<code>ToString</code> 方法和<code>==</code>,<code>!=</code> 运算符。</p>
<p><code>Entity</code>：主键是int类型的Entity;</p>
<p><code>IEntityTranslation</code>:实体语言转化；</p>
<p><code>IEntityTranslation&lt;TEntity, TPrimaryKeyOfMultiLingualEntity&gt;</code>: 实体语言转换泛型类，<code>TPrimaryKeyOfMultiLingualEntity</code> 为主键类型；</p>
<p><code>IEntityTranslation&lt;TEntity&gt;</code>：实体语言转换泛型类，继承 <code>IEntityTranslation&lt;TEntity, int&gt;</code> 接口；</p>
<p><code>IMultiLingualEntity&lt;TTranslation&gt;</code>：多语言实体，其中 <code>TTranslation</code> 类型约束为 <code>IEntityTranslation</code>；</p>
<p><code>IEntityTranslation&lt;&gt;</code> 接口的实现，表明当前实体可以被翻译：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190722150243.png" alt="QQ截图20190722150243.png"></p>
<p><code>IMultiLingualEntity&lt;&gt;</code> 接口的实现，表示有多语言的实现：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190722150428.png" alt="QQ截图20190722150428.png"></p>
<p>使用：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190722150703.png" alt="QQ截图20190722150703.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190722150813.png" alt="QQ截图20190722150813.png"></p>
<p><code>IExtendableObject</code>：使用 Json 格式的字符串属性，以扩展对象/实体。</p>
<p><code>ExtendableObjectExtensions</code>：针对扩展字段属性的扩展类；</p>
<p><code>IAggregateRoot</code>：聚合根接口</p>
<p><code>AggregateRoot</code>：聚合根实现</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190722153654.png" alt="QQ截图20190722153654.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190722153720.png" alt="QQ截图20190722153720.png"></p>
<p><code>IMayHaveTenant</code>：为可能选择具有TenantId的实体实现此接口。</p>
<p><code>IMustHaveTenant</code>：为必须具有TenantId的实体实现此接口。</p>
<p><code>IPassivable</code>：此接口用于使实体主动/被动。</p>
<p><code>ISoftDelete</code>：用于标准化软删除实体。</p>
<h2 id="EntityCache"><a href="#EntityCache" class="headerlink" title="EntityCache"></a>EntityCache</h2><p><code>IEntityCache&lt;TCacheItem, TPrimaryKey&gt;</code>：定义实体缓存接口，此接口为泛型类型；</p>
<p><code>IEntityCache&lt;TCacheItem&gt;</code>：继承 <code>IEntityCache&lt;TCacheItem, int&gt;</code> 接口；</p>
<p><code>EntityCache&lt;TEntity, TCacheItem, TPrimaryKey&gt;</code>：实体缓存类；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190722171203.png" alt="QQ截图20190722171203.png"></p>
<h2 id="Auditing"><a href="#Auditing" class="headerlink" title="Auditing"></a>Auditing</h2><p><code>IAudited</code>：定义实体的审计接口，保存/更新时自动设置相关属性</p>
<p><code>IAudited&lt;TUser&gt;</code>：审计接口。</p>
<p><code>ICreationAudited</code>： 审计创建者接口，保存到数据库时，会自动设置创建时间和创建者用户。</p>
<p><code>IDeletionAudited</code>: 删除时审计信息</p>
<p><code>IFullAudited</code>：完全审核信息。</p>
<p><code>IHasCreationTime</code>：如果必须存储实体，则可以实现此接口，自动设置；</p>
<p><code>IHasDeletionTime</code>：如果必须删除实体，则可以实现此接口，自动设置；</p>
<p><code>IHasModificationTime</code>：更新实体时间；</p>
<p><code>IModificationAudited</code>：实体更新人信息；</p>
<p><code>AuditedEntity</code>：审计实体；</p>
<p><code>CreationAuditedEntity</code>：创建者审计实体；</p>
<p><code>FullAuditedEntity</code>：全部审计信息实体；</p>
<p><code>AuditedAggregateRoot</code>：审计聚合根</p>
<p><code>CreationAuditedAggregateRoot</code>：创建者审计 聚合根；</p>
<p><code>FullAuditedAggregateRoot</code>：全部审计信息 聚合根；</p>
<p><code>EntityAuditingHelper</code>：实体审计帮助类；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190722174813.png" alt="QQ截图20190722174813.png"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/1zhk/p/5329393.html">ABP源码分析十四：Entity的设计</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/07/02/CSharp%20-%20%E5%9F%BA%E5%85%83%E7%B1%BB%E5%9E%8B(primitive)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/02/CSharp%20-%20%E5%9F%BA%E5%85%83%E7%B1%BB%E5%9E%8B(primitive)/" class="post-title-link" itemprop="url">CSharp - 基元类型(primitive)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-02 18:15:01" itemprop="dateCreated datePublished" datetime="2019-07-02T18:15:01+00:00">2019-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-28 07:13:38" itemprop="dateModified" datetime="2020-09-28T07:13:38+00:00">2020-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSharp%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">CSharp基础</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CSharp-基元类型-primitive"><a href="#CSharp-基元类型-primitive" class="headerlink" title="CSharp - 基元类型(primitive)"></a>CSharp - 基元类型(primitive)</h1><h2 id="基元类型"><a href="#基元类型" class="headerlink" title="基元类型"></a>基元类型</h2><p>CLR 定义的基元（原始）类型：</p>
<p><code>Boolean</code>, <code>Byte</code>, <code>SByte</code>, <code>Int16</code>, <code>UInt16</code>, <code>Int32</code>, <code>UInt32</code>, <code>Int64</code>, <code>UInt64</code>, <code>Char</code>, <code>Double</code>, <code>Single</code>。</p>
<p><font color=#ff0000 size=4 face="黑体">注意：string不是基元（原始）类型。</font></p>
<p>即：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">System.Boolean</span><br><span class="line">System.Byte</span><br><span class="line">System.SByte</span><br><span class="line">System.Int16</span><br><span class="line">System.UInt16</span><br><span class="line">System.Int32</span><br><span class="line">System.UInt32</span><br><span class="line">System.Int64</span><br><span class="line">System.UInt64</span><br><span class="line">System.IntPtr</span><br><span class="line">System.UIntPtr</span><br><span class="line">System.Char</span><br><span class="line">System.Double</span><br><span class="line">System.Single</span><br></pre></td></tr></table></figure>

<p>通过 <code>System.Type</code> 提供 <code>IsPrimitive</code> 属性，指示当前类型是否为基元类型；</p>
<h2 id="内置类型"><a href="#内置类型" class="headerlink" title="内置类型"></a>内置类型</h2><p><font color=#ff0000 size=4 face="黑体">C#内置类型和.NET框架中的类型有直接的映射关系。C#内置类型直接映射到Framework(FCL)中存在的类型。</font>如: 在用内置类型int初始化一个整数时，int会直接映射到FCL中 <code>System.Int32</code> 类型，这个过程,编译器自动完成。C#中的string是内置类型，直接映射到.NET框架中的String，所以没有任何不同。 </p>
<p>下图显示，C#中的所有内置类型和FCL类型：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190705175059.png" alt="QQ截图20190705175059.png"></p>
<p>隐式转化：如果转化过程时安全的，也就是说在转化过程中数据不会丢失，那么久进行隐式转换。<br>显示转换：转换过程不安全，意味着可能会丢失精度或者数量级，那就要求显示转换。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/kone0611/article/details/84856702">C# 基元类型（primitive）</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014677855/article/details/82111358">C#中基元类型、引用类型与值类型</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/keywords/built-in-types-table">内置类型表（C# 参考）</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3965752/is-string-a-primitive-type">Is String a primitive type?</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.type.isprimitiveimpl?redirectedfrom=MSDN&view=netframework-4.8#System_Type_IsPrimitiveImpl">Type.IsPrimitiveImpl Method</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/07/02/CSharp%E4%B9%8BCLI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/02/CSharp%E4%B9%8BCLI/" class="post-title-link" itemprop="url">CSharp之CLI</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-02 17:34:09" itemprop="dateCreated datePublished" datetime="2019-07-02T17:34:09+00:00">2019-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-28 07:13:38" itemprop="dateModified" datetime="2020-09-28T07:13:38+00:00">2020-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Net-Standard/" itemprop="url" rel="index"><span itemprop="name">.Net Standard</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>简介：CLI是一个开放的技术规范。它是由微软联合惠普以及英特尔于2000年向ECMA倡议的。通用语言基础架构定义了构成.NET Framework基础结构的可执行码以及代码的运行时环境的规范，它定义了一个语言无关的跨体系结构的运行环境，这使得开发者可以用规范内定义的各种高级语言来开发软件，并且无需修正即可将软件运行在不同的计算机体系结构上。CLI有时候会和CLR混用。但严格意义上说，这是错误的。因为CLI是一种规范，而CLR则是对这种规范的一个实现。</p>
<p>首先，引入一张图片:</p>
<p><img src="/img/2010012620512419.png" alt="2010012620512419.png"><br>图片引用自：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/eshizhan/archive/2010/01/26/1657041.html">https://www.cnblogs.com/eshizhan/archive/2010/01/26/1657041.html</a></p>
<p>流程图：</p>
<p><img src="/img/CLI-00001.png" alt="CLI-00001.png"></p>
<h2 id="CLI"><a href="#CLI" class="headerlink" title="CLI"></a>CLI</h2><p><font color=#ff0000 size=4 face="黑体">CLI：通用语言基础架构(Common Language Infrastructure，CLI)；</font></p>
<p>CLI是一个开放的技术规范。它是由微软联合惠普以及英特尔于2000年向ECMA倡议的。通用语言基础架构定义了构成.NET Framework基础结构的可执行码以及代码的运行时环境的规范，它定义了一个语言无关的跨体系结构的运行环境，这使得开发者可以用规范内定义的各种高级语言来开发软件，并且无需修正即可将软件运行在不同的计算机体系结构上。CLI有时候会和CLR混用。但严格意义上说，这是错误的。因为CLI是一种规范，而CLR则是对这种规范的一个实现。</p>
<p>欧洲计算机制造商协会（ECMA）已经于2001年10月13日批准C#语言规范（ECMA-334）成为一种新诞生的计算机产业标准。同时国际标准组织ISO也同意该标准进入该组织的审批阶段。并且，作为.NET与CLR的核心部分，CLI与C#也同时获得了ECMA的批准（ECMA-335）。拥有了C#与CLI这两项标准，你可以自己写出能够运行于任何操作系统上的.NET平台（只要你愿意）。如前所述，著名的MONO项目就是这么干的，MONO项目包括三个核心的部分：一个C#语言的编译器，一个CLI和一个类库。</p>
<h2 id="CLR"><a href="#CLR" class="headerlink" title="CLR"></a>CLR</h2><p><font color=#ff0000 size=4 face="黑体">CLR：通用语言运行平台(Common Language Runtime，CLR)；</font></p>
<p>无论通过任何语言构建产品，都必须寄宿到一个平台中运行，这正如我们的软件运行在操作系统环境一样，操作系统为CLR提供了运行环境，使用.NET构建的程序又运行在CLR之上，CRL为.NET程序的运行提供了温床，CLR提供基本的类库和运行引擎，基本类库封装操作系统函数供开发者方便调用，运行引擎用于编译并运行我们开发的程序。CLR包含.NET运行引擎和符合CLI的类库。通过.NET平台构建的程序都基于CLR基础类库来实现，并且运行在CLR提供的运行引擎之上。</p>
<p>编译为托管代码时，编译器将源代码翻译为 Microsoft 中间语言 (MSIL)，这是一组可以有效地转换为本机代码且独立于 CPU 的指令。MSIL 包括用于加载、存储和初始化对象以及对对象调用方法的指令，还包括用于算术和逻辑运算、控制流、直接内存访问、异常处理和其他操作的指令。要使代码可运行，必须先将 MSIL 转换为特定于 CPU 的代码，这通常是通过实时 (JIT) 编译器来完成的。由于公共语言运行库为它支持的每种计算机结构都提供了一种或多种 JIT 编译器，因此同一组 MSIL 可以在所支持的任何结构上 JIT 编译和运行。</p>
<h2 id="CIL"><a href="#CIL" class="headerlink" title="CIL"></a>CIL</h2><p><font color=#ff0000 size=4 face="黑体">CIL：公共中间语言（Common Intermediate Language，CIL)；</font></p>
<p>CLI，简称<strong>微软中间语言（MSIL）或者中间语言（IL）</strong>。CIL是编译器将.NET代码编译成公共语言运行时（CLR）能够识别的中间代码。它是一种介于高级语言（例如C#）和CPU指令之间的一种语言。当用户编译一个.NET程序时，编译器（例如VisualStudio）将C#源代码编译转换成中间语言 (MSIL)，它是一种能够被CLR转换成CPU指令的中间语言，当执行这些中间语言时，CLR提供的实时（JIT）编译器将它们转化为CPU特定的代码。由于公共语言运行库支持多种实时编译器，因此同一段中间语言代码可以被不同的编译器实时编译并运行在不同的CPU结构上。从理论上来说，MSIL将消除多年以来业界中不同语言之间的纷争。在.NET的世界中可能出现下面的情况一部分代码可以用C++实现，另一部分代码使用C#或VB.NET完成的，但是最后这些代码都将被转换为中间语言。这给程序员提供了极大的灵活性，程序员可以选择自己熟悉的语言，并且再也不用为学习不断推出的新语言而烦恼了。</p>
<h2 id="FCL"><a href="#FCL" class="headerlink" title="FCL"></a>FCL</h2><p><font color=#ff0000 size=4 face="黑体">FCL：框架类库(Framework Class Library,FCL)；</font></p>
<p>FCL提供了大粒度的编程框架，它是针对不同应用设计的框架 ，FCL大部分实现都引用了BCL，例如我们常说的开发框架：ASP.NET、MVC、WCF和WPF等等，提供了针对不同层面的编程框架 。</p>
<p>FCL框架类库可以划分为三层：</p>
<p>** 最内一层<strong>：由BCL的大部分组成，主要作用是对.NET框架，.NET运行时以及CIL语言本身进行支持，例如基元类型，集合类型，线程处理，应用程序域，运行时，安全性，互操作等。<br>** 中间一层</strong>：包含了对操作系统功能的封装，例如文件系统，网络连接，图形图像，XML操作等。<br>** 最外一层**：包含各种类型的应用程序，例如 Window Forms，Asp.NET，WPF，WCF，WF等。</p>
<h2 id="BCL"><a href="#BCL" class="headerlink" title="BCL"></a>BCL</h2><p><font color=#ff0000 size=4 face="黑体">BCL：基类库(Base Class Library，BCL)；</font></p>
<p>BCL是一个公共编程框架，称为基类库，所有语言的开发者都能利用它。是CLI（Common Language Infrastructure，公共语言基础结构）的规范之一，主要包括：执行网络操作，执行I/O操作，安全管理，文本操作，数据库操作，XML操作，与事件日志交互，跟踪和一些诊断操作，使用非托管代码，创建与调用动态代码等，粒度相对较小，为所有框架提供基础支持。</p>
<h2 id="CLS"><a href="#CLS" class="headerlink" title="CLS"></a>CLS</h2><p><font color=#ff0000 size=4 face="黑体">CLS：公共语言规范(Common Language Specification，CLS);</font></p>
<p>CLS是CTS的一个子集，所有.NET语言都应该遵循此规则才能创建与其他语言可互操作的应用程序，但要注意的是为了使各语言可以互操作，只能使用CLS所列出的功能对象，这些功能统称为与CLS兼容的功能，它是在.NET平台上运行语言的最小规范，正因为.NET上不同语言能够轻松交互一样，例如C#编写程序时可以直接引用并使用VB.NET编写的类库。为了达到这样的交互，才制定出CLS规范，在.NET框架本身提供的所有类库（并非所有）都是与CLS兼容的，在查看MSDN文档时，不兼容的类和方法都被特别标记为不兼容，例如C#中的System.UInt32就标记为”此API不兼容CLS。兼容 CLS的替代API为 Int64。“，这说明并不是所有的语言(例如VB.NET或J#)都支持无符号的数据类型，但这种数据类型与CLS不兼容的。</p>
<h2 id="CTS"><a href="#CTS" class="headerlink" title="CTS"></a>CTS</h2><p><font color=#ff0000 size=4 face="黑体">CTS：公共类型系统(Common Type System，CTS);</font></p>
<p>CTS是一种类型系统和语言规范，它能够确保CLR能够识别和处理的类型，所有.NET开发语言中的类型，无论时VS.NET类型还是C#.NET类型最终都会被编译成CLR能够识别的CTS类型，因此CTS是.NET平台类型的抽象。例如VB.NET中的integer类型和C#中的int类型都编译成CTS的System.Int32类型。如果某种语言编写的程序能够在CLR上运行，并不能说明这种语言完全符合CTS的规范。例如使用C++编写的代码，部分代码并不符合CTS规范，在编译时把这部分不符合CTS的代码会被编译成原始代码本地CPU指令而非中间代码。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/dotnet/articles/aa302340(v=msdn.10)">Microsoft Win32 to Microsoft .NET Framework API Map</a></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Common_Language_Infrastructure">Common Language Infrastructure</a></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/File:Overview_of_the_Common_Language_Infrastructure.svg">Overview of the Common Language Infrastructure.svg</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/shanyongxu/article/details/50879598">BCL和FCL</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Eiceblue/article/details/46602343">关于CLR、CIL、CTS、CLS、CLI、BCL和FCL 的区分与总结</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/07/01/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8812%EF%BC%89-%20Redis%E7%BC%93%E5%AD%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/01/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8812%EF%BC%89-%20Redis%E7%BC%93%E5%AD%98/" class="post-title-link" itemprop="url">ABP框架学习记录（12）- Redis缓存</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-01 14:34:59" itemprop="dateCreated datePublished" datetime="2019-07-01T14:34:59+00:00">2019-07-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-28 07:13:38" itemprop="dateModified" datetime="2020-09-28T07:13:38+00:00">2020-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ABP/" itemprop="url" rel="index"><span itemprop="name">ABP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ABP框架学习记录（12）-Redis缓存"><a href="#ABP框架学习记录（12）-Redis缓存" class="headerlink" title="ABP框架学习记录（12）- Redis缓存"></a>ABP框架学习记录（12）- Redis缓存</h1><p>在 ABP 框架中，单独新建了一个项目来实现 Redis 缓存，具体项目/目录如下图：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701143752.png" alt="QQ截图20190701143752.png"></p>
<p>首先，<code>AbpRedisCacheModule</code> 模块用于使用Redis服务器取代ABP的缓存系统，<code>AbpRedisCacheModule</code> 依赖于 <code>AbpKernelModule</code>；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701175116.png" alt="QQ截图20190701175116.png"></p>
<p><code>AbpRedisCacheOptions</code> : 提供 <code>AbpStartupConfiguration</code> 属性，为 <code>RedisCacheConfigurationExtensions</code> 扩展类提供 <code>IIocManager</code> 的实例：<br><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701175312.png" alt="QQ截图20190701175312.png"></p>
<p>提供 <code>IIocManager</code> 实例，并注册 <code>AbpRedisCacheManager</code> 类做为 <code>ICacheManager</code> 的默认实现：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701180120.png" alt="QQ截图20190701180120.png"></p>
<p><code>AbpRedisCacheManager</code> : 用户管理 <code>AbpRedisCache</code>;</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701180537.png" alt="QQ截图20190701180537.png"></p>
<p><code>IAbpRedisCacheDatabaseProvider/AbpRedisCacheDatabaseProvider</code> ：用户获取 <code>IDatabase</code> 实例；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701181130.png" alt="QQ截图20190701181130.png"></p>
<p><code>IRedisCacheSerializer/DefaultRedisCacheSerializer</code>：持久化和检索时使用的所有自定义（反）序列化方法；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701181427.png" alt="QQ截图20190701181427.png"></p>
<p><code>RedisDatabaseExtensions</code>：扩展类；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701181522.png" alt="QQ截图20190701181522.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/06/24/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8811%EF%BC%89-%20%E7%BC%93%E5%AD%98%E7%9A%84%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/24/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8811%EF%BC%89-%20%E7%BC%93%E5%AD%98%E7%9A%84%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">ABP框架学习记录（11）- 缓存的实现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-06-24 14:17:55" itemprop="dateCreated datePublished" datetime="2019-06-24T14:17:55+00:00">2019-06-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-28 07:13:38" itemprop="dateModified" datetime="2020-09-28T07:13:38+00:00">2020-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ABP/" itemprop="url" rel="index"><span itemprop="name">ABP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ABP框架学习记录（11）-缓存的实现"><a href="#ABP框架学习记录（11）-缓存的实现" class="headerlink" title="ABP框架学习记录（11）- 缓存的实现"></a>ABP框架学习记录（11）- 缓存的实现</h1><p>缓存在 ABP 项目中的路径 <code>ABP/Runtime</code>：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190628105843.png" alt="QQ截图20190628105843.png"></p>
<p>ABP中实现两种 <code>Cache</code> ：<code>MemroyCache</code> 和 <code>RedisCache</code>。两者都继承至 <code>ICache</code> 接口（准确说是 <code>CacheBase</code> 抽象类）。ABP核心模块封装了 <code>MemroyCache</code> 来实现ABP中的默认缓存功能。 <code>Abp.RedisCache</code> 这个模块封装 <code>RedisCache</code> 来实现缓存（通过 <code>StackExchange.Redis</code> 这个类库访问redis）</p>
<p><code>ICache</code> 接口：定义可以按键存储和获取项目的缓存。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190628151914.png" alt="QQ截图20190628151914.png"></p>
<p><code>ICache</code> 接口中的方法 <code>Get/GetAsync</code> 有两个参数：<br>key：缓存关键字,字符串类型；<br>工厂：没有找到指定key的缓存条目时调用传入的action来创建cache。工厂方法应该创建并返回实际的条目。如果给定的key在缓存中找到了，那么不会调用该action。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190628152326.png" alt="QQ截图20190628152326.png"></p>
<p><code>CacheBase</code>：提供继承 <code>ICache</code> 接口的抽象类；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701132308.png" alt="QQ截图20190701132308.png"></p>
<p><code>CacheExtensions</code>：提供 <code>ICache</code>的扩展类：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701132333.png" alt="QQ截图20190701132333.png"></p>
<p><code>ICacheManager/CacheManagerBase</code>：提供缓存管理器；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190628162728.png" alt="QQ截图20190628162728.png"></p>
<p><code>ICacheManager.GetCache</code> 方法返回一个ICache。第一次请求时会创建缓存，并通过 <code>CachingConfiguration</code> 中的<code>CacheConfigurator</code> 完成对该Cache的配置，以后都是返回相同的缓存对象。因此，我们可以在不同的类（客户端）中共享具有相同名字的相同缓存。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190628162758.png" alt="QQ截图20190628162758.png"></p>
<p><code>ICachingConfiguration/CachingConfiguration</code>：用于配置 缓存系统，首先通过在 <code>AbpKernelModule</code> 类，<code>PreInitialize</code> 方法配置缓存：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701142545.png" alt="QQ截图20190701142545.png"></p>
<p>定义：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701141638.png" alt="QQ截图20190701141638.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701141747.png" alt="QQ截图20190701141747.png"></p>
<p><code>ICacheConfigurator/CacheConfigurator</code>：表示已注册的缓存配置器,定义两个构造函数，其中的参数 <code>Action&lt;ICache&gt; initAction</code> 表示创建的回调函数；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701142143.png" alt="QQ截图20190701142143.png"></p>
<p>在 <code>AbpKernelModule</code> 类，<code>PreInitialize</code> 方法调用：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701142545.png" alt="QQ截图20190701142545.png"></p>
<p><code>CacheManagerExtensions</code>：提供对 <code>CacheManager</code> 扩展类，提供 <code>GetCache&lt;TKey, TValue&gt;</code> 方法，具体实现调用 <code>CacheExtensions</code> 的 <code>AsTyped&lt;TKey, TValue&gt;</code> 扩展方法；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701132812.png" alt="QQ截图20190701132812.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701133029.png" alt="QQ截图20190701133029.png"></p>
<p><code>AsTyped&lt;TKey, TValue&gt;</code> 扩展方法，实例化了一个 <code>TypedCacheWrapper&lt;TKey, TValue&gt;(cache)</code> 类型的对象，并将 <code>CacheManagerExtensions</code> 中扩展方法 <code>GetCache&lt;TKey, TValue&gt;</code> 的 <code>TKey, TValue</code>，然后继续传递给  <code>CacheExtensions</code> 中的扩展方法 <code>AsTyped&lt;TKey, TValue&gt;</code> 的 <code>TKey, TValue</code>，最终，在 <code>TypedCacheWrapper</code> 的泛型类中接收，并为其自身的方法提供 <code>TKey, TValue</code>。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701133134.png" alt="QQ截图20190701133134.png"></p>
<p><code>ITypedCache/TypedCacheWrapper/TypedCacheExtensions</code>：支持泛型key和value的缓存接口与实现，其内部通过封装ICache实例和<code>CacheExtension</code>定义的对ICache的扩展方法来是实现泛型版本的 <code>Icache</code>。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190628153126.png" alt="QQ截图20190628153126.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190628153232.png" alt="QQ截图20190628153232.png"></p>
<p><code>AbpMemoryCacheManager</code> ：重写了 <code>CacheManagerBase</code> 的 <code>CreateCacheImplementation</code> 方法，该方法用于创建真实的 <code>Icache</code> 对象。 具体到 <code>AbpMemoryCacheManager</code> 就是创建 <code>AbpMemoryCache</code>。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701143053.png" alt="QQ截图20190701143053.png"></p>
<p><code>AbpMemoryCache</code>：通过CLR的 <code>MemoryCache</code> 来实现 <code>Icache</code> 。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701143151.png" alt="QQ截图20190701143151.png"></p>
<p><strong>使用</strong></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190701172446.png" alt="QQ截图20190701172446.png"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/1zhk/p/5328547.html">ABP源码分析十三：缓存Cache实现</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/06/11/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8810%EF%BC%89-%20%E6%9C%AC%E5%9C%B0%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/11/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8810%EF%BC%89-%20%E6%9C%AC%E5%9C%B0%E5%8C%96/" class="post-title-link" itemprop="url">ABP框架学习记录（10）- 本地化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-06-11 17:26:12" itemprop="dateCreated datePublished" datetime="2019-06-11T17:26:12+00:00">2019-06-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-28 07:13:38" itemprop="dateModified" datetime="2020-09-28T07:13:38+00:00">2020-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ABP/" itemprop="url" rel="index"><span itemprop="name">ABP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ABP框架学习记录（10）-本地化"><a href="#ABP框架学习记录（10）-本地化" class="headerlink" title="ABP框架学习记录（10）- 本地化"></a>ABP框架学习记录（10）- 本地化</h1><p>ABP中的本地化主要涉及两个方面：一个是语言（Language）的管理（相对简单），另一个是语言对应得本地化资源（Localization）的管理（稍显复杂）。</p>
<p>目录结构：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190618095421.png" alt="QQ截图20190618095421.png"></p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>在 <code>AbpKernelModule</code> 完成对本地化资源的引用，设置的初始化： </p>
<p><code>PreInitialize</code> 方法调用 <code>AddLocalizationSources</code> 方法，添加资源：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190618131540.png" alt="QQ截图20190618131540.png"></p>
<p><code>PreInitialize</code> 方法调用 <code>AddSettingProviders</code> 方法，添加设置：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190618111856.png" alt="QQ截图20190618111856.png"></p>
<p><code>PostInitialize</code> 方法初始化：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190618111740.png" alt="QQ截图20190618111740.png"></p>
<h2 id="LocalizationManager-ILocalizationManager"><a href="#LocalizationManager-ILocalizationManager" class="headerlink" title="LocalizationManager/ILocalizationManager"></a>LocalizationManager/ILocalizationManager</h2><p>遍历 <code>LocalizationConfiguration</code> 中的 <code>ILocalizationSourceList</code> 实例，通过 <code>ILocalizationSource</code> 的<code>ILocalizationDictionaryProvider</code> 实例完成本地化资源的初始化。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190618135216.png" alt="QQ截图20190618135216.png"></p>
<p><code>ILocalizationSource</code> 接口：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190618140712.png" alt="QQ截图20190618140712.png"></p>
<p><code>ILocalizationConfiguration/LocalizationConfiguration</code>: 用于配置支持本地化的语言的一个 <code>LanguageInfo</code> 集合，以及这些语言所对应的本地化资源。这两者分别对应 <code>ILocalizationConfiguration</code> 中的 <code>Lanugages</code> 和 <code>Sources</code> 属性。注意这个Sources是一个 <code>ILocalizationSourceList</code> 实例。</p>
<h2 id="DictionaryBasedLocalizationSource"><a href="#DictionaryBasedLocalizationSource" class="headerlink" title="DictionaryBasedLocalizationSource"></a>DictionaryBasedLocalizationSource</h2><p><code>IDictionaryBasedLocalizationSource</code> : 继承 <code>ILocalizationSource</code> 接口，<code>DictionaryBasedLocalizationSource</code> 实现 <code>IDictionaryBasedLocalizationSource</code> 接口，用于构建本地化源，适用于基于内存的词典以查找字符串。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190618140440.png" alt="QQ截图20190618140440.png"></p>
<p>子类的实现：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190618142054.png" alt="QQ截图20190618142054.png"></p>
<p>应用：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190618142251.png" alt="QQ截图20190618142251.png"></p>
<p><code>LocalizationSourceExtensionInfo</code>：用于扩展本地化资源。ABP在 <code>LocalizationManager</code> 初始化的过程中将<code>LocalizationSourceExtensionInfo</code> 所对应的本地化资源扩充到 <code>ILocalizationSource</code> 对象的相应本地化资源字典中。</p>
<h2 id="LocalizationDictionaryProviderBase"><a href="#LocalizationDictionaryProviderBase" class="headerlink" title="LocalizationDictionaryProviderBase"></a>LocalizationDictionaryProviderBase</h2><p><code>LocalizationDictionaryProviderBase</code> 实现 <code>ILocalizationDictionaryProvider</code> 接口，它封装了一个<code>IDictionary&lt;string, ILocalizationDictionary&gt;</code> 实例(这是ABP在runtime时候，唯一持有本地化资源的对象)，其中key就是sourceName。并且提供了一个方法Initialize来初始化本地化这个Dictionary。可以通过实现这个接口来提供其他类型的本地化资源。比如 Abp.Zero 就实现了数据库的本地化资源。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190618143125.png" alt="QQ截图20190618143125.png"></p>
<p><code>Initialize</code> 方法：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190618143206.png" alt="QQ截图20190618143206.png"></p>
<p><code>LocalizationDictionaryProviderBase</code>：实现了 <code>ILocalizationDictionaryProvider</code> 的抽象类，实现了extend本地化Dictionary的方法，这个方法主要用于初始化完成以后，用于扩展相应的ILocalizationDictionary对象。</p>
<p><code>XmlFileLocalizationDictionaryProvider</code>，<code>JsonFileLocalizationDictionaryProvider</code>，<code>JsonEmbeddedFileLocalizationDictionaryProvider</code>，<code>XmlEmbeddedFileLocalizationDictionaryProvider</code> 类，继承 <code>LocalizationDictionaryProviderBase</code>;</p>
<h2 id="LocalizationDictionary"><a href="#LocalizationDictionary" class="headerlink" title="LocalizationDictionary"></a>LocalizationDictionary</h2><p><code>ILocalizationDictionary</code>：提供了索引器this[]方法的接口，该方法接受一个string返回的是本地化的string。当<code>LocalizationManager</code> 初始化动作结束后，每一种本地化语言的都对应有且仅有的一个 <code>ILocalizationDictionary</code> 对象，这个对象用于保存该语言的所有本地化信息。</p>
<p><code>LocalizationDictionary</code>：实现了 <code>ILocalizationDictionary</code> 和 <code>IEnumerable</code> 两个接口，他本身就是一个具有集合操作的类。其内部封装了一个Dictionary的实例，用于提供真正的集合操作。这个基类只提供了从其内部的Dictionary中根据原string查找返回本地化的string。 其本身并没有将本地化资源文件中的数据加载到其内部的Dictionary的功能，这部分是在其子类中实现的。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190618143919.png" alt="QQ截图20190618143919.png"></p>
<p><code>XmlLocalizationDictionary</code>：实现 <code>BuildFomFile</code> 和 <code>BuildFomXmlString</code> 方法用于从XML文件读取本地化数据。</p>
<p><code>JsonLocalizationDictionary</code>：实现 <code>BuildFromFile</code> 和 <code>BuildFromJsonString</code> 方法用于从Json文件读取本地化数据。</p>
<p><code>JsonLocalizationFile</code>: 反序列化Json字符串到 <code>JsonLocalizationFile</code> 对象。</p>
<h2 id="LanguageManager"><a href="#LanguageManager" class="headerlink" title="LanguageManager"></a>LanguageManager</h2><p><code>ILanguageManager/LanguageManager</code>：通过调用 <code>ILanguageProvider</code> 接口返回 <code>LanguageInfo</code> 的一个集合。以及返回服务器的当前语言设置，如果服务器的当前语言不在 <code>LocalizationConfiguration</code> 的本地化语言集合中，则返回<code>LocalizationConfiguration</code> 的本地化语言集合中的第一项。</p>
<p><code>ILanguageProvider</code>：接口定义一个返回本地化语言集合的方法。这里使用接口做隔离是有必要的，因为ABP底层框架的<code>DefaultLanguageProvider</code> 只是返回通过代码 <code>hardcode</code> (硬编码) 到系统中的 <code>LanguageInfo</code> 信息。如果需要从其他source(比如数据库)中获取配置的 <code>LanguageInfo</code> 信息，那么我们就必须实现自定义的 <code>LanguageProvider</code>。</p>
<p><code>DefaultLanguageProvider</code>：从 <code>LocalizationConfiguration</code> 读取 <code>LanguageInfo</code> 的集合。</p>
<p><code>LanguageInfo</code>：用于封装language的基本信息。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/1zhk/p/5320751.html">ABP源码分析十二：本地化</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/05/31/%E4%BD%BF%E7%94%A8Json-Net%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%96%87%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/31/%E4%BD%BF%E7%94%A8Json-Net%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%96%87%E4%BB%B6/" class="post-title-link" itemprop="url">使用Json.Net序列化上传的文件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-31 13:47:09" itemprop="dateCreated datePublished" datetime="2019-05-31T13:47:09+00:00">2019-05-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-28 07:13:38" itemprop="dateModified" datetime="2020-09-28T07:13:38+00:00">2020-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Json-Net/" itemprop="url" rel="index"><span itemprop="name">Json.Net</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="使用Json-Net序列化上传的文件"><a href="#使用Json-Net序列化上传的文件" class="headerlink" title="使用Json.Net序列化上传的文件"></a>使用Json.Net序列化上传的文件</h1><p>基本知识：</p>
<p>序列化： 将数据结构或对象转换成二进制串的过程。<br>反序列化：将在序列化过程中所生成的二进制串转换成数据结构或者对象的过程。</p>
<p>本文提供一种针对目标文件，重写文件序列化，从而实现上传。</p>
<p>客户端调用：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Send</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> inFile1 =</span><br><span class="line">        <span class="string">@&quot;C:\Users\User1\source\repos\ConsoleApp1\Test.mp3&quot;</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] data = File.ReadAllBytes(inFile1);</span><br><span class="line"></span><br><span class="line">    FileUpLoadDTO gdto = <span class="keyword">new</span> FileUpLoadDTO();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 其它参数</span></span><br><span class="line">    gdto.DeviceId = <span class="string">&quot;1234321&quot;</span>;</span><br><span class="line">    gdto.DeviceMac = <span class="string">&quot;1343212&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> filedto = <span class="keyword">new</span> FileDTO();</span><br><span class="line">    filedto.FileData = data;</span><br><span class="line">    filedto.FileName = GetFileName();</span><br><span class="line">    filedto.FileSize = data.Length;</span><br><span class="line">    gdto.FileDto = filedto;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 序列化文件</span></span><br><span class="line">    <span class="keyword">var</span> jsonData = JsonHelper.Serialize(<span class="keyword">new</span> &#123; dto = gdto &#125;);</span><br><span class="line">    <span class="keyword">var</span> url = <span class="string">&quot;http://temp.uri/UpLoadFile&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> response = HttpHelper.SendRequest(url, <span class="string">&quot;POST&quot;</span>, jsonData);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">GetFileName</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Random rd = <span class="keyword">new</span> Random();</span><br><span class="line">    StringBuilder serial = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    serial.Append(DateTime.Now.ToString(<span class="string">&quot;yyyyMMddHHmmssff&quot;</span>));</span><br><span class="line">    serial.Append(rd.Next(<span class="number">0</span>, <span class="number">999999</span>).ToString());</span><br><span class="line">    <span class="keyword">return</span> serial.ToString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端实现：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ReturnInfoDTO <span class="title">ReceiveFile</span>(<span class="params">FileUpLoadDTO dto</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ReturnInfoDTO rdto = <span class="keyword">new</span> ReturnInfoDTO() &#123; StatusCode = <span class="string">&quot;200&quot;</span>, IsSuccess = <span class="literal">true</span>, Message = <span class="string">&quot;调用成功&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> outputFolder = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, <span class="string">&quot;NAudio&quot;</span>);</span><br><span class="line">    Directory.CreateDirectory(outputFolder);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> filename = dto.FileDto.FileName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> (FileStream stream = File.Open(filename, FileMode.OpenOrCreate))</span><br><span class="line">        &#123;</span><br><span class="line">            stream.Seek(<span class="number">0</span>, SeekOrigin.End);</span><br><span class="line">            stream.Write(dto.FileDto.FileData, <span class="number">0</span>, dto.FileDto.FileData.Length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e)</span><br><span class="line">    &#123;</span><br><span class="line">        rdto.IsSuccess = <span class="literal">false</span>;</span><br><span class="line">        rdto.StatusCode = <span class="string">&quot;500&quot;</span>;</span><br><span class="line">        rdto.Message = <span class="string">&quot;调用失败&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rdto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">button9_Click</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> inFile1 =</span><br><span class="line">        <span class="string">@&quot;C:\Users\User1\Desktop\Test.mp3&quot;</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] data = File.ReadAllBytes(inFile1);</span><br><span class="line"></span><br><span class="line">    FileUpLoadDTO gdto = <span class="keyword">new</span> FileUpLoadDTO();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其它参数</span></span><br><span class="line">    gdto.DeviceId = <span class="string">&quot;1234321&quot;</span>;</span><br><span class="line">    gdto.DeviceMac = <span class="string">&quot;1343212&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> filedto = <span class="keyword">new</span> FileDto();</span><br><span class="line">    filedto.FileData = data;</span><br><span class="line">    filedto.FileName = GetFileName() + System.IO.Path.GetExtension(inFile1);</span><br><span class="line">    filedto.FileSize = data.Length;</span><br><span class="line">    gdto.FileDto = filedto;</span><br><span class="line"></span><br><span class="line">    ReceiveFile(gdto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JsonHelper帮助类：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JsonHelper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">Deserialize</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">string</span> json</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> JsonConvert.DeserializeObject&lt;T&gt;(json, <span class="keyword">new</span> JsonSerializerSettings()</span><br><span class="line">        &#123;</span><br><span class="line">            ReferenceLoopHandling = ReferenceLoopHandling.Ignore</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">Serialize</span>&lt;<span class="title">T</span>&gt;(<span class="params">T data</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        JsonSerializerSettings settings = <span class="keyword">new</span> JsonSerializerSettings();</span><br><span class="line">        ByteJsonConverter byteJsonConverter = <span class="keyword">new</span> ByteJsonConverter();</span><br><span class="line">        settings.ReferenceLoopHandling = ReferenceLoopHandling.Ignore;</span><br><span class="line">        DateTimeConverter dateTimeConverter = <span class="keyword">new</span> DateTimeConverter();</span><br><span class="line">        settings.Converters.Add(dateTimeConverter);</span><br><span class="line">        settings.Converters.Add(byteJsonConverter);</span><br><span class="line">        <span class="keyword">return</span> JsonConvert.SerializeObject((<span class="keyword">object</span>)data, settings);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">ObjectToJson</span>&lt;<span class="title">T</span>&gt;(<span class="params">T obj</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">using</span> (MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">new</span> DataContractJsonSerializer(<span class="keyword">typeof</span>(T)).WriteObject(memoryStream, obj);</span><br><span class="line">            memoryStream.Position = <span class="number">0L</span>;</span><br><span class="line">            <span class="keyword">using</span> (StreamReader streamReader = <span class="keyword">new</span> StreamReader(memoryStream, Encoding.UTF8))</span><br><span class="line">                <span class="keyword">return</span> streamReader.ReadToEnd();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">DateTimeConverter</span> : <span class="title">JsonConverter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> CanRead</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> CanWrite</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">CanConvert</span>(<span class="params">Type objectType</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">typeof</span>(DateTime) == objectType || <span class="keyword">typeof</span>(DateTime?) == objectType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">object</span> <span class="title">ReadJson</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        JsonReader reader,</span></span></span><br><span class="line"><span class="function"><span class="params">        Type objectType,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">object</span> existingValue,</span></span></span><br><span class="line"><span class="function"><span class="params">        JsonSerializer serializer</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">WriteJson</span>(<span class="params">JsonWriter writer, <span class="keyword">object</span> <span class="keyword">value</span>, JsonSerializer serializer</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">string</span> json = JsonHelper.ObjectToJson&lt;DateTime&gt;(Convert.ToDateTime(<span class="keyword">value</span>));</span><br><span class="line">        writer.WriteRawValue(json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">ByteJsonConverter</span> : <span class="title">JsonConverter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> CanRead</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> CanWrite</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">CanConvert</span>(<span class="params">Type objectType</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">typeof</span>(<span class="keyword">byte</span>[]) == objectType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">object</span> <span class="title">ReadJson</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        JsonReader reader,</span></span></span><br><span class="line"><span class="function"><span class="params">        Type objectType,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">object</span> existingValue,</span></span></span><br><span class="line"><span class="function"><span class="params">        JsonSerializer serializer</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">WriteJson</span>(<span class="params">JsonWriter writer, <span class="keyword">object</span> <span class="keyword">value</span>, JsonSerializer serializer</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">string</span> json = JsonHelper.ObjectToJson&lt;<span class="keyword">byte</span>[]&gt;(<span class="keyword">value</span> <span class="keyword">as</span> <span class="keyword">byte</span>[]);</span><br><span class="line">        writer.WriteRawValue(json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.io.filestream?view=netframework-4.8">system.io.filestream</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/JamesNK/Newtonsoft.Json">Newtonsoft.Json</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/05/30/%E4%BD%BF%E7%94%A8NAudio%E5%B0%86MP3%E7%BC%96%E7%A0%81%E8%BD%ACG711/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/30/%E4%BD%BF%E7%94%A8NAudio%E5%B0%86MP3%E7%BC%96%E7%A0%81%E8%BD%ACG711/" class="post-title-link" itemprop="url">使用NAudio将MP3编码转G711</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-30 17:19:45" itemprop="dateCreated datePublished" datetime="2019-05-30T17:19:45+00:00">2019-05-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-28 07:13:38" itemprop="dateModified" datetime="2020-09-28T07:13:38+00:00">2020-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Naudio/" itemprop="url" rel="index"><span itemprop="name">Naudio</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="使用NAudio将MP3编码转G711"><a href="#使用NAudio将MP3编码转G711" class="headerlink" title="使用NAudio将MP3编码转G711"></a>使用NAudio将MP3编码转G711</h1><p>将MP3编码转成G711编码，以支持终端播放需求。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> inFile1 =</span><br><span class="line">    <span class="string">@&quot;C:\Users\test\source\repos\ConsoleApp1\7794FDBE-34E9-4218-B5EC-2272ED750201.mp3&quot;</span>;</span><br><span class="line"><span class="keyword">byte</span>[] data = File.ReadAllBytes(inFile1);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> outputFolder = Path.Combine(System.Environment.CurrentDirectory, <span class="string">&quot;NAudio&quot;</span>);</span><br><span class="line">Directory.CreateDirectory(outputFolder);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> filename = GetFileName();</span><br><span class="line"><span class="keyword">string</span> g711FileName = filename + <span class="string">&quot;-g711.wav&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> inFile = Path.Combine(outputFolder, filename + <span class="string">&quot;.wav&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> outfile = Path.Combine(outputFolder, g711FileName);</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> (MemoryStream ms = <span class="keyword">new</span> MemoryStream(data))</span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> reader = <span class="keyword">new</span> Mp3FileReader(ms))</span><br><span class="line">&#123;</span><br><span class="line">    WaveFileWriter.CreateWaveFile(inFile, reader);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NAudioHelper.EnCodeG711(inFile, outfile);</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Naudio 转码</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NAudioHelper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MuLawChatCodec _codec = <span class="keyword">new</span> MuLawChatCodec();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">EnCodeG711</span>(<span class="params"><span class="keyword">string</span> inFile, <span class="keyword">string</span> outfile</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> format = <span class="keyword">new</span> WaveFormat(<span class="number">8000</span>, <span class="number">16</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> reader = <span class="keyword">new</span> WaveFileReader(inFile))</span><br><span class="line">        <span class="keyword">using</span> (WaveFileWriter waveFileWriter = <span class="keyword">new</span> WaveFileWriter(outfile, format))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[reader.WaveFormat.AverageBytesPerSecond * <span class="number">4</span>];</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> count = reader.Read(buffer, <span class="number">0</span>, buffer.Length);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">byte</span>[] encoded = _codec.Encode(buffer, <span class="number">0</span>, count);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (count != <span class="number">0</span>)</span><br><span class="line">                    waveFileWriter.Write(encoded, <span class="number">0</span>, encoded.Length);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetFileName</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Random rd = <span class="keyword">new</span> Random();</span><br><span class="line">        StringBuilder serial = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        serial.Append(DateTime.Now.ToString(<span class="string">&quot;yyyyMMddHHmmssff&quot;</span>));</span><br><span class="line">        serial.Append(rd.Next(<span class="number">0</span>, <span class="number">999999</span>).ToString());</span><br><span class="line">        <span class="keyword">return</span> serial.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">MuLawChatCodec</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Name =&gt; <span class="string">&quot;G.711 mu-law&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> BitsPerSecond =&gt; RecordFormat.SampleRate * <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> WaveFormat RecordFormat =&gt; <span class="keyword">new</span> WaveFormat(<span class="number">8000</span>, <span class="number">16</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">byte</span>[] <span class="title">Encode</span>(<span class="params"><span class="keyword">byte</span>[] data, <span class="keyword">int</span> offset, <span class="keyword">int</span> length</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> encoded = <span class="keyword">new</span> <span class="keyword">byte</span>[length / <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">int</span> outIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> n = <span class="number">0</span>; n &lt; length; n += <span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            encoded[outIndex++] = MuLawEncoder.LinearToMuLawSample(BitConverter.ToInt16(data, offset + n));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> encoded;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">byte</span>[] <span class="title">Decode</span>(<span class="params"><span class="keyword">byte</span>[] data, <span class="keyword">int</span> offset, <span class="keyword">int</span> length</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> decoded = <span class="keyword">new</span> <span class="keyword">byte</span>[length * <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">int</span> outIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> n = <span class="number">0</span>; n &lt; length; n++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">short</span> decodedSample = MuLawDecoder.MuLawToLinearSample(data[n + offset]);</span><br><span class="line">            decoded[outIndex++] = (<span class="keyword">byte</span>)(decodedSample &amp; <span class="number">0xFF</span>);</span><br><span class="line">            decoded[outIndex++] = (<span class="keyword">byte</span>)(decodedSample &gt;&gt; <span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> decoded;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// nothing to do</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsAvailable</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/05/29/%E4%BD%BF%E7%94%A8Naudio%E5%B0%86Pcm%E8%BD%ACG711/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/29/%E4%BD%BF%E7%94%A8Naudio%E5%B0%86Pcm%E8%BD%ACG711/" class="post-title-link" itemprop="url">使用Naudio将Pcm转G711</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-29 11:43:21" itemprop="dateCreated datePublished" datetime="2019-05-29T11:43:21+00:00">2019-05-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-28 07:13:38" itemprop="dateModified" datetime="2020-09-28T07:13:38+00:00">2020-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Naudio/" itemprop="url" rel="index"><span itemprop="name">Naudio</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="使用Naudio将Pcm转G711"><a href="#使用Naudio将Pcm转G711" class="headerlink" title="使用Naudio将Pcm转G711"></a>使用Naudio将Pcm转G711</h1><p>我们在音频处理的时候经常会接触到PCM数据：它是模拟音频信号经模数转换（A/D变换）直接形成的二进制序列，该文件没有附加的文件头和文件结束标志。</p>
<p>声音本身是模拟信号，而计算机只能识别数字信号，要在计算机中处理声音，就需要将声音数字化，这个过程叫经模数转换（A/D变换）。最常见的方式是通过<font color=#ff0000 size=4 face="黑体">脉冲编码调制PCM(Pulse Code Modulation)</font> 。</p>
<p>下面是从github上<a target="_blank" rel="noopener" href="https://github.com/naudio/NAudio/blob/master/Docs/RecordWavFileWinFormsWaveIn.md">Naudio库</a>拷贝的 <code>WinForm</code> 录音代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> outputFolder = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.Desktop), <span class="string">&quot;NAudio&quot;</span>);</span><br><span class="line">Directory.CreateDirectory(outputFolder);</span><br><span class="line"><span class="keyword">var</span> outputFilePath = Path.Combine(outputFolder,<span class="string">&quot;recorded.wav&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> waveIn = <span class="keyword">new</span> WaveInEvent();</span><br><span class="line"></span><br><span class="line">WaveFileWriter writer = <span class="literal">null</span>;</span><br><span class="line">MuLawChatCodec _codec = <span class="keyword">new</span> MuLawChatCodec();</span><br><span class="line"><span class="keyword">bool</span> closing = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">var</span> f = <span class="keyword">new</span> Form();</span><br><span class="line"><span class="keyword">var</span> buttonRecord = <span class="keyword">new</span> Button() &#123; Text = <span class="string">&quot;Record&quot;</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> buttonStop = <span class="keyword">new</span> Button() &#123; Text = <span class="string">&quot;Stop&quot;</span>, Left = buttonRecord.Right, Enabled = <span class="literal">false</span> &#125;;</span><br><span class="line">f.Controls.AddRange(<span class="keyword">new</span> Control[] &#123; buttonRecord, buttonStop &#125;);</span><br><span class="line"></span><br><span class="line">buttonRecord.Click += (s, a) =&gt; </span><br><span class="line">&#123; </span><br><span class="line">    writer = <span class="keyword">new</span> WaveFileWriter(outputFilePath, waveIn.WaveFormat); </span><br><span class="line">    waveIn.StartRecording(); </span><br><span class="line">    buttonRecord.Enabled = <span class="literal">false</span>; </span><br><span class="line">    buttonStop.Enabled = <span class="literal">true</span>; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">buttonStop.Click += (s, a) =&gt; waveIn.StopRecording();</span><br><span class="line"></span><br><span class="line">waveIn.DataAvailable += (s, a) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Pcm</span></span><br><span class="line">    <span class="comment">// writer.Write(a.Buffer, 0, a.BytesRecorded);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Pcm to G.711</span></span><br><span class="line">    <span class="keyword">byte</span>[] encoded = _codec.Encode(a.Buffer, <span class="number">0</span>, a.BytesRecorded);</span><br><span class="line">    writer.Write(encoded, <span class="number">0</span>, encoded.Length);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (writer.Position &gt; waveIn.WaveFormat.AverageBytesPerSecond * <span class="number">30</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        waveIn.StopRecording();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">waveIn.RecordingStopped += (s, a) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    writer?.Dispose(); </span><br><span class="line">    writer = <span class="literal">null</span>; </span><br><span class="line">    buttonRecord.Enabled = <span class="literal">true</span>;</span><br><span class="line">    buttonStop.Enabled = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (closing) </span><br><span class="line">    &#123; </span><br><span class="line">        waveIn.Dispose();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">f.FormClosing += (s, a) =&gt; &#123; closing=<span class="literal">true</span>; waveIn.StopRecording(); &#125;;</span><br><span class="line">f.ShowDialog();</span><br></pre></td></tr></table></figure>

<p>转G.711 mu-law 编码代码：</p>
<p>引用：<a target="_blank" rel="noopener" href="https://github.com/naudio/NAudio/blob/master/NAudioDemo/NetworkChatDemo/MuLawChatCodec.cs">MuLawChatCodec.cs</a></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">MuLawChatCodec</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Name =&gt; <span class="string">&quot;G.711 mu-law&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> BitsPerSecond =&gt; RecordFormat.SampleRate * <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> WaveFormat RecordFormat =&gt; <span class="keyword">new</span> WaveFormat(<span class="number">8000</span>, <span class="number">16</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">byte</span>[] <span class="title">Encode</span>(<span class="params"><span class="keyword">byte</span>[] data, <span class="keyword">int</span> offset, <span class="keyword">int</span> length</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> encoded = <span class="keyword">new</span> <span class="keyword">byte</span>[length / <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">int</span> outIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> n = <span class="number">0</span>; n &lt; length; n += <span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            encoded[outIndex++] = MuLawEncoder.LinearToMuLawSample(BitConverter.ToInt16(data, offset + n));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> encoded;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">byte</span>[] <span class="title">Decode</span>(<span class="params"><span class="keyword">byte</span>[] data, <span class="keyword">int</span> offset, <span class="keyword">int</span> length</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> decoded = <span class="keyword">new</span> <span class="keyword">byte</span>[length * <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">int</span> outIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> n = <span class="number">0</span>; n &lt; length; n++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">short</span> decodedSample = MuLawDecoder.MuLawToLinearSample(data[n + offset]);</span><br><span class="line">            decoded[outIndex++] = (<span class="keyword">byte</span>)(decodedSample &amp; <span class="number">0xFF</span>);</span><br><span class="line">            decoded[outIndex++] = (<span class="keyword">byte</span>)(decodedSample &gt;&gt; <span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> decoded;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// nothing to do</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsAvailable &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/05/28/%E9%9F%B3%E8%A7%86%E9%A2%91%E7%A0%81%E7%8E%87-%E9%87%87%E6%A0%B7%E7%8E%87%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/28/%E9%9F%B3%E8%A7%86%E9%A2%91%E7%A0%81%E7%8E%87-%E9%87%87%E6%A0%B7%E7%8E%87%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">音视频码率,采样率基础知识</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-28 17:59:21" itemprop="dateCreated datePublished" datetime="2019-05-28T17:59:21+00:00">2019-05-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-28 07:13:38" itemprop="dateModified" datetime="2020-09-28T07:13:38+00:00">2020-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9F%B3%E9%A2%91-%E8%A7%86%E9%A2%91/" itemprop="url" rel="index"><span itemprop="name">音频/视频</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="音视频码率-采样率基础知识"><a href="#音视频码率-采样率基础知识" class="headerlink" title="音视频码率,采样率基础知识"></a>音视频码率,采样率基础知识</h1><p><code>采样率</code> 和 <code>比特率</code> 就像是坐标轴上的横纵坐标。</p>
<p>横坐标的 <code>采样率</code> 表示了每秒钟的采样次数。 </p>
<p>纵坐标的 <code>比特率</code> 表示了用数字量来量化模拟量的时候的精度。</p>
<p>可以使用 <a target="_blank" rel="noopener" href="https://mediaarea.net/en/MediaInfo">MediaInfo</a>来查看媒体文件的信息;</p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p>对于人类的语音信号而言，实际处理一般经过以下步骤：</p>
<p>人说话——&gt;声电转换——&gt;抽样（模数转换）——&gt;量化（将数字信号用适当的数值表示）——&gt;编码（数据压缩）——&gt;</p>
<p>传输（网络或者其他方式）——&gt;解码（数据还原）——&gt;反抽样（数模转换）——&gt;电声转换——&gt;人耳听声。</p>
<h2 id="采样率（sampleRate）"><a href="#采样率（sampleRate）" class="headerlink" title="采样率（sampleRate）"></a>采样率（sampleRate）</h2><p>** 采样**：采样即采集样本，是模拟信息数字化的一个环节。即对模拟信号进行离散采样，使之成为数字信号。</p>
<p>** 采样率**：<font color=#ff0000 size=4 face="黑体">采样速度或者采样频率，定义了每秒从连续信号中提取并组成离散信号的采样个数，它用赫兹（Hz）来表示。采样率是指将模拟信号转换成数字信号时的采样频率，也就是单位时间内采样多少点。一个采样点数据有多少个比特。</font></p>
<p>声音信号为模拟信号，想要在实际中处理必须为数字信号，即采用抽样、量化、编码的处理方案。<br>处理的第一步为抽样，即模数转换。简单地说就是通过波形采样的方法记录1秒钟长度的声音，需要多少个数据。</p>
<p>根据<font color=#ff0000 size=4 face="黑体">奈魁斯特（NYQUIST）采样定理，用两倍于一个正弦波的频繁率进行采样就能完全真实地还原该波形</font>。所以，对于声音信号而言，要想对离散信号进行还原，必须将抽样频率定为40KHz以上。</p>
<p>实际中，一般定为44.1KHz。44.1KHz采样率的声音就是要花费44000个数据来描述1秒钟的声音波形。原则上采样率越高，声音的质量越好，采样频率一般共分为22.05KHz、44.1KHz、48KHz三个等级。22.05 KHz只能达到FM广播的声音品质，44.1KHz则是理论上的CD音质界限，48KHz则已达到DVD音质了。</p>
<h2 id="采样位深（bitsPerSample）"><a href="#采样位深（bitsPerSample）" class="headerlink" title="采样位深（bitsPerSample）"></a>采样位深（bitsPerSample）</h2><p>采样时模数转换的分辨率，也就是每个样本用几位来表示，一般是 8bits 或是 16bits。</p>
<p>我们常见的16Bit（16比特），可以记录大概96分贝的动态范围。那么，您可以大概知道，每一个比特大约可以记录6分贝的声音。同理，20Bit可记录的动态范围大概就是120dB；24Bit就大概是144dB。假如，我们定义0dB为峰值，那么声音振幅以向下延伸计算，那么，CD音频可的动态范围就是“-96dB～0dB。”，依次类推，24Bit的HD-Audio高清音频的的动态范围就是“-144dB~0dB。”。由此可见，位深度较高时，有更大的动态范围可利用，可以记录更低电平的细节。</p>
<h2 id="声道数（NumChannels）"><a href="#声道数（NumChannels）" class="headerlink" title="声道数（NumChannels）"></a>声道数（NumChannels）</h2><p>1 =&gt; 单声道  |  2 =&gt; 双声道</p>
<h2 id="比特率（Bit-Per-Second）"><a href="#比特率（Bit-Per-Second）" class="headerlink" title="比特率（Bit Per Second）"></a>比特率（Bit Per Second）</h2><p>俗称<font color=#ff0000 size=4 face="黑体">码率，表示经过编码（压缩）后的音频数据每秒传送的比特(bit)数。</font> 单位为 bps(Bit Per Second)或kbps即千位每秒，比特率越高，传送的数据越大，音质越好。与体积成正比：码率越大，体积越大；码率越小，体积越小。</p>
<p>PCM编码的公式：<br><font color=#ff0000 size=4 face="黑体">比特率 =采样率 x 采用位数 x声道数</font></p>
<p>关于比特率的计算，比如，采样率为44.1KHz，采样大小为16bit，声道数为2，那么它的音频比特率的计算为：44.1kHz<em>16</em>2 = 1411.2 kbps，然后我们在除以8，将bit转化为Byte，所以1秒钟的数据量就是：1411.2Kbps/8 = 176.4KB/s。这表示存储一秒钟采样率为44.1KHz，采样大小为16bit，双声道的PCM编码的音频信号，需要176.4KB的空间，1分钟则约为10.34M。这对大部分用户是不可接受的，尤其是喜欢在电脑上听音乐的朋友，要降低磁盘占用，只有2种方法，降低采样指标或者压缩。降低指标是不可取的，因此专家们研发了各种压缩方案。最原始的有DPCM、ADPCM，其中最出名的为MP3。所以，采用了数据压缩以后的码率远小于原始码率。</p>
<p>对于音频信号而言，实际上必须进行编码。在这里，编码指信源编码，即数据压缩。如果，未经过数据压缩，直接量化进行传输则被称为PCM（脉冲编码调制）。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wghhdzwzqbx02/article/details/7392059">关于音频采样率与码率</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/longbei9029/article/details/80763568">音视频基本概念：分辨率、帧速率、码流、采样位深、采样率、比特率</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/super119/archive/2011/01/03/1924448.html">什么是音频视频比特率，采样率，讲的很不错</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/27460676">视频音频比特率（码率）与采样率有什么联系？</a></p>
<p><a target="_blank" rel="noopener" href="https://mediaarea.net/en/MediaInfo">MediaInfo</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/05/09/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%889%EF%BC%89-%20Timing%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/09/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%889%EF%BC%89-%20Timing%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">ABP框架学习记录（9）- Timing解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-09 15:06:04" itemprop="dateCreated datePublished" datetime="2019-05-09T15:06:04+00:00">2019-05-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-28 07:13:38" itemprop="dateModified" datetime="2020-09-28T07:13:38+00:00">2020-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ABP/" itemprop="url" rel="index"><span itemprop="name">ABP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ABP框架学习记录（9）-Timing解析"><a href="#ABP框架学习记录（9）-Timing解析" class="headerlink" title="ABP框架学习记录（9）- Timing解析"></a>ABP框架学习记录（9）- Timing解析</h1><p>Timing这个功能主要用于以统一的方式表示时间。因为ABP中有大量的module,还支持自定义module，所以将时间统一表示为local时间（默认）或utc时间是必要的。</p>
<h2 id="Clock（时钟）"><a href="#Clock（时钟）" class="headerlink" title="Clock（时钟）"></a>Clock（时钟）</h2><p><code>TimingSettingProvider</code>：继承 <code>SettingProvider</code> 以设置统一的时间格式。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509150917.png" alt="QQ截图20190509150917.png"></p>
<p>在 <code>AbpKernelModule</code> 的 <code>PreInitialize</code> 方法中引用：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509151217.png" alt="QQ截图20190509151217.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509151246.png" alt="QQ截图20190509151246.png"></p>
<p>ABP 提供 <code>IClockProvider</code> 获取当前时间和标准化时间的接口，三个实现 <code>IClockProvider</code>接口的类： <code>UtcClockProvider</code>，<code>UnspecifiedClockProvider</code>，<code>LocalClockProvider</code>。</p>
<p><code>IClockProvider</code>：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509151848.png" alt="QQ截图20190509151848.png"></p>
<p><code>LocalClockProvider</code>：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509152004.png" alt="QQ截图20190509152004.png"></p>
<p><code>UtcClockProvider</code>：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509152201.png" alt="QQ截图20190509152201.png"></p>
<p><code>UnspecifiedClockProvider</code>：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509152238.png" alt="QQ截图20190509152238.png"></p>
<p><code>ClockProviders</code>：提供三种 <code>Providers</code>。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509152730.png" alt="QQ截图20190509152730.png"></p>
<p><code>Clock</code>：封装了 <code>IClockProvider</code>，对外提供当前时间和标准化时间的方法。默认使用 <code>UnspecifiedClockProvider</code>。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509152858.png" alt="QQ截图20190509152858.png"></p>
<p>也可以指定 <code>Provider</code>：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Clock.Provider = ClockProviders.Utc;</span><br></pre></td></tr></table></figure>

<h2 id="DateTimeRange（时间区间）"><a href="#DateTimeRange（时间区间）" class="headerlink" title="DateTimeRange（时间区间）"></a>DateTimeRange（时间区间）</h2><p><code>IDateTimeRange/DateTimeRange</code>：表示一个时间区间的实体。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509155915.png" alt="QQ截图20190509155915.png"></p>
<p>使用：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509160338.png" alt="QQ截图20190509160338.png"></p>
<p><code>IZonedDateTimeRange/ZonedDateTimeRange</code>：使用时区定义 <code>DateTime</code> 的范围。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509155958.png" alt="QQ截图20190509155958.png"></p>
<p><code>TimeZoneConverter/ITimeZoneConverter</code>：时区转换类。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509164413.png" alt="QQ截图20190509164413.png"></p>
<p><code>TimezoneHelper</code>：用于时区操作的帮助程序类。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509164913.png" alt="QQ截图20190509164913.png"></p>
<p><code>IanaTimeZone</code> ：时区信息数据库，又称TZ database、Zoneinfo database，是一个主要应用于计算机程序以及操作系统的，可协作编辑世界时区信息的数据库。由于该数据库由David Olson创立，因而有些地方也将其称作Olson数据库。数据库由Paul Eggert进行编辑和维护</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/1zhk/p/5317003.html">ABP源码分析十一：Timing</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%97%B6%E5%8C%BA%E4%BF%A1%E6%81%AF%E6%95%B0%E6%8D%AE%E5%BA%93">时区信息数据库/IANA time zone</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/05/09/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%888%EF%BC%89-%20Unit%20Of%20Work%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/09/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%888%EF%BC%89-%20Unit%20Of%20Work%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">ABP框架学习记录（8）- Unit Of Work解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-09 13:23:21" itemprop="dateCreated datePublished" datetime="2019-05-09T13:23:21+00:00">2019-05-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-28 07:13:38" itemprop="dateModified" datetime="2020-09-28T07:13:38+00:00">2020-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ABP/" itemprop="url" rel="index"><span itemprop="name">ABP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ABP框架学习记录（8）-Unit-Of-Work解析"><a href="#ABP框架学习记录（8）-Unit-Of-Work解析" class="headerlink" title="ABP框架学习记录（8）- Unit Of Work解析"></a>ABP框架学习记录（8）- Unit Of Work解析</h1><p>目录结构：在ABP项目/Domain/Uow目录下：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509132703.png" alt="QQ截图20190509132703.png"></p>
<p>在 <code>AbpBootstrapper</code> 类，对拦截器的注册方法中，提供对 <code>UnitOfWork</code> 的注册：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190603160354.png" alt="QQ截图20190603160354.png"></p>
<p><code>AbpKernelModule</code> 类 <code>PostInitialize</code> 方法注册默认 <code>IUnitOfWork</code> 接口的实现 <code>NullUnitOfWork</code>：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190604141032.png" alt="QQ截图20190604141032.png"></p>
<p><code>AbpKernelModule</code> 注册过滤器：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190604135212.png" alt="QQ截图20190604135212.png"></p>
<h2 id="UnitOfWorkRegistrar"><a href="#UnitOfWorkRegistrar" class="headerlink" title="UnitOfWorkRegistrar"></a>UnitOfWorkRegistrar</h2><p><code>UnitOfWorkRegistrar</code> ：为Unit Of Work机制注册所需类的拦截器。</p>
<p><code>Initialize</code> 初始化方法：将 <code>UnitOfWorkInterceptor</code> 拦截器添加到标注了 <code>UnitOfWorkAttribute</code> 特性方法的类，以及实现<code>IRepository</code> 或 <code>IApplicationService</code> 的类上。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190603160828.png" alt="QQ截图20190603160828.png"></p>
<p><code>HandleTypesWithUnitOfWorkAttribute</code> 和 <code>HandleConventionalUnitOfWorkTypes</code> 方法：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190603161027.png" alt="QQ截图20190603161027.png"></p>
<p>应用拦截器：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190611151213.png" alt="QQ截图20190611151213.png"></p>
<h2 id="UnitOfWorkDefaultOptions"><a href="#UnitOfWorkDefaultOptions" class="headerlink" title="UnitOfWorkDefaultOptions"></a>UnitOfWorkDefaultOptions</h2><p><code>UnitOfWorkDefaultOptions/IUnitOfWorkDefaultOptions</code>：配置选项，内部类型或成员只能在同一程序集的文件中访问。</p>
<p><code>UnitOfWorkDefaultOptions</code> 提供 <code>RegisterFilter</code> 方法来注册 过滤器：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190611145011.png" alt="QQ截图20190611145011.png"></p>
<p><code>DataFilterConfiguration</code>：数据过滤器配置类：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190611145513.png" alt="QQ截图20190611145513.png"></p>
<p><code>DefaultConnectionStringResolver</code>：实现 <code>IConnectionStringResolver</code> 接口，获取连接数据库字符串；</p>
<h2 id="UnitOfWorkInterceptor"><a href="#UnitOfWorkInterceptor" class="headerlink" title="UnitOfWorkInterceptor"></a>UnitOfWorkInterceptor</h2><p><code>UnitOfWorkInterceptor</code> 继承 <code>Castle.DynamicProxy.IInterceptor</code> 接口，用于管理数据库连接和事务。</p>
<p>通过构造注入 <code>IUnitOfWorkManager</code> 和 <code>IUnitOfWorkDefaultOptions</code>：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190603164632.png" alt="QQ截图20190603164632.png"></p>
<p>实现 <code>IInterceptor</code> 接口 <code>Intercept</code> 方法，通过注入 <code>IUnitOfWorkDefaultOptions</code> 接口，获取到 <code>UnitOfWorkDefaultOptions</code> 类的实例，并通过 <code>UnitOfWorkDefaultOptions</code> 的扩展方法，获取到使用 <code>UnitOfWorkAttribute</code> 特性标注的 类，接口和方法：</p>
<p><code>Intercept</code> 方法：应用拦截器，</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190611151458.png" alt="QQ截图20190611151458.png"></p>
<p>使用 <code>UnitOfWorkDefaultOptionsExtensions</code> 扩展类，查询应用了 <code>UnitOfWorkAttribute</code> 特性的方法/类；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190611151724.png" alt="QQ截图20190611151724.png"></p>
<p><code>UnitOfWorkDefaultOptions</code> 的扩展类 <code>UnitOfWorkDefaultOptionsExtensions</code> ：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190604111433.png" alt="QQ截图20190604111433.png"></p>
<h2 id="UnitOfWorkAttribute"><a href="#UnitOfWorkAttribute" class="headerlink" title="UnitOfWorkAttribute"></a>UnitOfWorkAttribute</h2><p><code>UnitOfWorkAttribute</code>：用于指示声明方法是原子的，应该被视为一个工作单元。拦截具有此属性的方法，打开数据库连接并在调用方法之前启动事务。在方法调用结束时，如果没有异常，则提交事务并将所有更改应用于数据库，否则它会回滚。如果在调用此方法之前已有工作单元，则此属性无效，如果是，则使用相同的事务。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190611152126.png" alt="QQ截图20190611152126.png"></p>
<h2 id="UnitOfWork-事务"><a href="#UnitOfWork-事务" class="headerlink" title="UnitOfWork 事务"></a>UnitOfWork 事务</h2><p>基于接口隔离原则的考量，ABP作者将UnitOfWork的方法分到了三个不同的接口中。</p>
<p><code>IUnitOfWorkCompleteHandle</code>:定义了UOW同步和异步的complete方法。实现UOW完成时候的逻辑。</p>
<p><code>IActiveUnitOfWork</code>：一个UOW除了以上两个接口中定义的方法和属性外，其他的属性和方法都在这个接口定义的。比如Completed，Disposed，Failed事件代理，Filter的enable和disable,以及同步、异步的SaveChanges方法。</p>
<p><code>IUnitOfWork</code>：继承了上面两个接口。定义了外层的IUnitOfWork的引用和UOW的begin方法。 ABP是通过构建一个UnitOfWork的链，将不同的方法纳入到一个事务中。</p>
<h3 id="Unit-Of-Work运行流程"><a href="#Unit-Of-Work运行流程" class="headerlink" title="Unit Of Work运行流程"></a>Unit Of Work运行流程</h3><ul>
<li>1，UOW拦截器被注入到需要UOW的类中。</li>
<li>2，ABP执行标注了UnitOfWork特性的方法时。UOW拦截器以begin()-&gt;realAction()-&gt;complete()-&gt;dispose()顺序执行，其中realAction是被调用的真实业务操作。 UOW拦截器是通过using这种方式调用IUnitOfWork的某个具体实现，这就确保begin 和 dispose也总是会被执行的。 这里需要注意complete却不一定会被执行，比如在complete方法被调用前方法的执行产生了异常。</li>
<li>3，当执行一连串的操作时（A方法-&gt;B方法-&gt;C方法，假设这三个方法都标注了UnitOfWork特性），ABP在执行A方法前会创建整个过程中唯一的IUnitOfWork对象，该对象会启动.NET事务。在执行到B，C方法只会创建InnerUnitOfWorkCompleteHandle。 InnerUnitOfWorkCompleteHandle与IUnitOfWork对象的差异在于它不会创建真实的事务。但ABP会调用其Complete，以告知ABP其对应的方法以成功完成，可以提交事务。</li>
<li>4，事务可以回滚的关键关键在于IUnitOfWork对象在被Dispose时候会检查Complete方法有没有被执行，没有的话就认为这个UOW标注的方法没有顺利完成，从而导致事务的回滚操作。</li>
<li>5，整个事务的提交是通过第一个UOW（也是唯一个）的Complete方法执行时提交的。</li>
</ul>
<h3 id="UnitOfWorkBase"><a href="#UnitOfWorkBase" class="headerlink" title="UnitOfWorkBase"></a>UnitOfWorkBase</h3><p><code>UnitOfWorkBase</code> ： 继承 <code>IUnitOfWork</code> 的抽象类，真正实现事务控制的方法是由这个抽象类的子类实现的（比如，真正创建 <code>TransactionScope</code> 的操作是在 <code>EfUnitOfWork</code> ，<code>NhUnitOfWork</code> 这样的之类中实现的）。UOW中除了事务控制逻辑以外的逻辑都是由 <code>UnitOfWorkBase</code> 抽象类实现的。 </p>
<p>ABP中共有以下4个具体的UOW类型，他们都继承自 <code>UnitOfWorkBase</code>。<code>Entity Framework</code>, <code>Nhibernate</code>。</p>
<p>构造函数：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190604141528.png" alt="QQ截图20190604141528.png"></p>
<p>启用/禁用 filter：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190604143018.png" alt="QQ截图20190604143018.png"></p>
<p>提供 <code>Completed</code>，<code>Disposed</code>，<code>Failed</code> 事件：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190604143152.png" alt="QQ截图20190604143152.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190604143424.png" alt="QQ截图20190604143424.png"></p>
<p><code>Begin</code>，<code>SaveChanges</code>，<code>SaveChangesAsync</code>：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190611161819.png" alt="QQ截图20190611161819.png"></p>
<h3 id="UnitOfWorkManager"><a href="#UnitOfWorkManager" class="headerlink" title="UnitOfWorkManager"></a>UnitOfWorkManager</h3><p>工作单元管理类；对外提供UOW的功能(用于创建UnitOfWork，并开启UnitOfWork流程)，对内调用各种UOW功能的各种组件。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190611162244.png" alt="QQ截图20190611162244.png"></p>
<p>启用工作单元：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IUnitOfWorkCompleteHandle <span class="title">Begin</span>(<span class="params">UnitOfWorkOptions options</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    options.FillDefaultsForNonProvidedOptions(_defaultOptions);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> outerUow = _currentUnitOfWorkProvider.Current;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 如果启用 工作单元事务，且外部 Uow 不为空，则使用 InnerUnitOfWorkCompleteHandle</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 对象。</span></span><br><span class="line">    <span class="keyword">if</span> (options.Scope == TransactionScopeOption.Required &amp;&amp; outerUow != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> InnerUnitOfWorkCompleteHandle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> uow = _iocResolver.Resolve&lt;IUnitOfWork&gt;();</span><br><span class="line"></span><br><span class="line">    uow.Completed += (sender, args) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        _currentUnitOfWorkProvider.Current = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    uow.Failed += (sender, args) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        _currentUnitOfWorkProvider.Current = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    uow.Disposed += (sender, args) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        _iocResolver.Release(uow);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Inherit filters from outer UOW</span></span><br><span class="line">    <span class="keyword">if</span> (outerUow != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        options.FillOuterUowFiltersForNonProvidedOptions(outerUow.Filters.ToList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uow.Begin(options);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Inherit tenant from outer UOW</span></span><br><span class="line">    <span class="keyword">if</span> (outerUow != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        uow.SetTenantId(outerUow.GetTenantId(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _currentUnitOfWorkProvider.Current = uow;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EF Core 启用事务：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190611164826.png" alt="QQ截图20190611164826.png"></p>
<p><code>UnitOfWork</code> 拦截器调用 <code>UnitOfWorkManager</code> 开启UOW流程的代码。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190611162510.png" alt="QQ截图20190611162510.png"></p>
<h3 id="InnerUnitOfWorkCompleteHandle"><a href="#InnerUnitOfWorkCompleteHandle" class="headerlink" title="InnerUnitOfWorkCompleteHandle"></a>InnerUnitOfWorkCompleteHandle</h3><p><code>InnerUnitOfWorkCompleteHandle</code>：实现 <code>IUnitOfWorkCompleteHandle</code>， 用户工作范围的内联单元，内部工作单元实际使用外部工作单元，并且对 <code>IUnitOfWorkCompleteHandle.Complete</code> 调用没有影响。但是如果没有调用它，则会在UOW结束时抛出异常以回滚UOW。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190611163052.png" alt="QQ截图20190611163052.png"></p>
<p>提交事务：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190611165617.png" alt="QQ截图20190611165617.png"></p>
<h3 id="AsyncLocalCurrentUnitOfWorkProvider"><a href="#AsyncLocalCurrentUnitOfWorkProvider" class="headerlink" title="AsyncLocalCurrentUnitOfWorkProvider"></a>AsyncLocalCurrentUnitOfWorkProvider</h3><p><code>AsyncLocalCurrentUnitOfWorkProvider</code>：实现 <code>ICurrentUnitOfWorkProvider</code> 接口，获取或设置当前 <code>IUnitOfWork</code> 实例；</p>
<h3 id="IActiveUnitOfWork"><a href="#IActiveUnitOfWork" class="headerlink" title="IActiveUnitOfWork"></a>IActiveUnitOfWork</h3><p><code>IActiveUnitOfWork</code>：用于处理活动的工作单元，此接口不能被注入，可以使用 IUnitOfWorkManager 替换。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Gets current unit of work.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">protected</span> IActiveUnitOfWork CurrentUnitOfWork &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> UnitOfWorkManager.Current; &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/1zhk/p/5309043.html">ABP源码分析十：Unit Of Work</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/05/08/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%887%EF%BC%89-%20%E5%90%8E%E5%8F%B0%E5%B7%A5%E4%BD%9C%E4%BB%BB%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/08/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%887%EF%BC%89-%20%E5%90%8E%E5%8F%B0%E5%B7%A5%E4%BD%9C%E4%BB%BB%E5%8A%A1/" class="post-title-link" itemprop="url">ABP框架学习记录（7）- 后台工作任务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-08 09:23:29" itemprop="dateCreated datePublished" datetime="2019-05-08T09:23:29+00:00">2019-05-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-28 07:13:38" itemprop="dateModified" datetime="2020-09-28T07:13:38+00:00">2020-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ABP/" itemprop="url" rel="index"><span itemprop="name">ABP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ABP框架学习记录（7）-后台工作任务"><a href="#ABP框架学习记录（7）-后台工作任务" class="headerlink" title="ABP框架学习记录（7）- 后台工作任务"></a>ABP框架学习记录（7）- 后台工作任务</h1><p>文主要说明ABP中后台工作者模块（BackgroundWorker）的实现方式，和后台工作模块（BackgroundJob）。<br>ABP通过 <code>BackgroundWorkerManager</code> 来管理 <code>BackgroundJobManager</code> ，然后通过 <code>BackgroundJobManager</code> 来管理 <code>BackgroundJob</code>。<code>BackgroundJob</code> 就代表一个真正的后台任务。</p>
<p><code>AbpKernelModule</code> 的 <code>PostInitialize</code> 方法完成对 <code>BackgroundWorkerManager</code>，<code>BackgroundJobManager</code>的初始化。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190508151157.png" alt="QQ截图20190508151157.png"></p>
<h2 id="BackgroundWorkerManager-工作者"><a href="#BackgroundWorkerManager-工作者" class="headerlink" title="BackgroundWorkerManager 工作者"></a>BackgroundWorkerManager 工作者</h2><p>目录结构：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190508151546.png" alt="QQ截图20190508151546.png"></p>
<p><code>IRunnable/RunnableBase</code>：定义了启动/终止一个任务的方法的接口和基本实现抽象类。共三个方法：start, stop, waittostop。 </p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190508151806.png" alt="QQ截图20190508151806.png"></p>
<p><code>BackgroundWorkerBase</code>：实现 <code>IBackgroundWorker</code> 的一个抽象类，同时添加了UOW,Setting 和本地化的一些辅助方法。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190508152210.png" alt="QQ截图20190508152210.png"></p>
<p><code>PeriodicBackgroundWorkerBase</code>：继承 <code>BackgroundWorkerBase</code>， 通过封装 <code>AbpTimer</code> 实现定时启动执行任务的功能。这个类型定义个一个抽象方法 <code>DoWork</code>。<code>AbpTimer</code> 最终会定时执行这个方法。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190508161027.png" alt="QQ截图20190508161027.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190508162829.png" alt="QQ截图20190508162829.png"></p>
<p><font color=#ff0000 size=4 face="黑体">AbpTimer是整个ABP框架实现后台工作的核心类，其实现原理就是通过一个CLR中的timer定时启动执行任务。</font></p>
<p>使用Timer需要注意的问题：</p>
<p>第一，用timer有一个弊端，就是当timer间隔时间内，任务如果没执行完，timer就会新建一个线程，从头开始执行这个任务，而上一个线程仍然继续执行，这样就会导致系统中产生的线程过多，一会儿系统的资源就耗尽了。ABP的解决思路是在执行真正的业务方法之前，通过将timer的duetime设为无限大，从而timer就失效了。业务方法执行完以后在恢复timer的设置。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190508173455.png" alt="QQ截图20190508173455.png"></p>
<p><code>Timer</code> 官方文档解释为：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190508173557.png" alt="QQ截图20190508173557.png"></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.threading.timer.change?view=netframework-4.8">System.Threading.Timer</a></p>
<p>第二，如何知道一个Timer真正结束了呢？也就是说如何知道一个Timer要执行的任务已经完成（定义为A效果），同时timer已失效(定义为B效果)？ABP通过stop方法实现B，通过WaitToStop实现A效果。WaitToStop会一直阻塞调用他的线程直到_performingTasks变成false,也就是说Timer要执行的任务已经完成（任务完成时会将_performingTasks设为False，并且释放锁）。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190508174549.png" alt="QQ截图20190508174549.png"></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> _taskTimer的回调方法</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;state&quot;&gt;</span>Not used argument<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">TimerCallBack</span>(<span class="params"><span class="keyword">object</span> state</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">lock</span> (_taskTimer)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!_running || _performingTasks)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _taskTimer.Change(Timeout.Infinite, Timeout.Infinite);</span><br><span class="line">        _performingTasks = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Elapsed != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Elapsed(<span class="keyword">this</span>, <span class="keyword">new</span> EventArgs());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span></span><br><span class="line">    &#123;&#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">lock</span> (_taskTimer)</span><br><span class="line">        &#123;</span><br><span class="line">            _performingTasks = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (_running)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 指示Timer继续执行</span></span><br><span class="line">                _taskTimer.Change(Period, Timeout.Infinite);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 释放锁</span></span><br><span class="line">            Monitor.Pulse(_taskTimer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>IBackgroundWorkerManager/BackgroundWorkerManager</code>：用于管理后台工作任务：<code>IBackgroundWorker</code> 实例（添加 <code>IBackgroundWorker</code> 实例到管理器，启动，终止和注销后台任务）。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190508160425.png" alt="QQ截图20190508160425.png"></p>
<h2 id="BackgroundWorkerManager-工作者-1"><a href="#BackgroundWorkerManager-工作者-1" class="headerlink" title="BackgroundWorkerManager 工作者"></a>BackgroundWorkerManager 工作者</h2><p>在ABP项目的目录结构：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509104729.png" alt="QQ截图20190509104729.png"></p>
<p><code>IBackgroundJob/BackgroundJob</code>：定义一个后台工作任务的接口/和基本实现。具体的后台任务类可从 <code>BackgroundJob</code> 继承，这是定义最终需要被执行的逻辑的地方。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509113529.png" alt="QQ截图20190509113529.png"></p>
<p><code>BackgroundJobInfo</code>：用于持久化job信息的实体类，对应于数据库中的表 <code>AbpBackgroundJobs</code>。一个job对应一个要执行的任务。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509131552.png" alt="QQ截图20190509131552.png"></p>
<p><code>IBackgroundJobConfiguration/BackgroundJobConfiguration</code>：配置是否激活后台工作任务功能。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509114407.png" alt="QQ截图20190509114407.png"></p>
<p><code>BackgroundJobPriority</code>：后台job的优先级。</p>
<p><code>IBackgroundJobStore/InMemoryBackgroundJobStore</code>: 用于持久化后台任务 <code>BackgroundJobInfo</code>。可以实现这个接口将后台任务 <code>BackgroundJobInfo</code> 存储到数据库。</p>
<p><code>IBackgroundJobManager/BackgroundJobManager</code>：<code>IBackgroundJobManager</code> 继承 <code>IBackgroundWorker</code>，<code>BackgroundJobManager</code> 默认实现 <code>IBackgroundJobManager</code> ，并 继承 <code>PeriodicBackgroundWorkerBase</code>。它可以被其他的后台工作提供者替代（Hangfire）。<code>BackgroundJobManager</code>之所以能在后台执行任务，是因为其继承了<code>PeriodicBackgroundWorkerBase</code> 基类，并重写了DoWork方法。从 <code>BackgroundJobStore</code>（可以自定义实现从数据库中读取）取最多1000个 <code>BackgroundJobInfo</code>，然后反射执行 <code>BackgroundJobInfo</code> 中定义的任务。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509131058.png" alt="QQ截图20190509131058.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509131329.png" alt="QQ截图20190509131329.png"></p>
<p>下面是一个ABP中通过 <code>BackgroundJobManager</code> 安排 <code>BackgroundJob</code> 的例子。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190509132129.png" alt="QQ截图20190509132129.png"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/1zhk/p/5304244.html">ABP源码分析九：后台工作任务</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/05/07/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%886%EF%BC%89-%20Logging%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/07/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%886%EF%BC%89-%20Logging%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">ABP框架学习记录（6）- Logging解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-07 09:15:27" itemprop="dateCreated datePublished" datetime="2019-05-07T09:15:27+00:00">2019-05-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-28 07:13:38" itemprop="dateModified" datetime="2020-09-28T07:13:38+00:00">2020-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ABP/" itemprop="url" rel="index"><span itemprop="name">ABP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ABP框架学习记录（6）-Logging解析"><a href="#ABP框架学习记录（6）-Logging解析" class="headerlink" title="ABP框架学习记录（6）- Logging解析"></a>ABP框架学习记录（6）- Logging解析</h1><p>ABP使用Castle日志记录工具，并且可以使用不同的日志类库，比如：Log4Net, NLog, Serilog… 等等。对于所有的日志类库，Castle提供了一个通用的接口来实现，我们可以很方便的处理各种特殊的日志库，而且当业务需要的时候，很容易替换日志组件。</p>
<p><code>LogSeverity</code>：表示日志的严重性，枚举类型，定义了5个日志级别：Info，Debug，Warn，Error， Fatal。</p>
<p><code>IHasLogSeverity</code>：封装了LogSeverity。<code>AbpAuthorizationException</code>，<code>AbpValidationException</code>，<code>UserFriendlyException</code> 实现了这个接口。<code>Loghelper</code> 在对 <code>Exception</code> 做log的时候可以方便的通过实现了<code>IHasLogSeverity</code>的 <code>Exception</code> 的实例获取到 <code>LogSeverity</code>，以确定log 级别。</p>
<p><code>AbpAuthorizationException</code>:</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190507105847.png" alt="QQ截图20190507105847.png"></p>
<p><code>LogHelper</code> 的实现：把继承 <code>IHasLogSeverity</code> 接口的对象，转换成 <code>IHasLogSeverity</code> 对象，并获取log级别。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190507110228.png" alt="QQ截图20190507110228.png"></p>
<p><code>LoggerExtensions</code>： 扩展了Castle的Ilogger接口的方法，封装更便捷的方法供Loghelper调用。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190507110501.png" alt="QQ截图20190507110501.png"></p>
<p>web项目的application_start方法中注入logger实例：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190507110701.png" alt="QQ截图20190507110701.png"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/1zhk/p/5294466.html">ABP源码分析八：Logger集成</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">syxdevcode</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">309</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">100</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">132</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/syxdevcode" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;syxdevcode" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">syxdevcode</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
