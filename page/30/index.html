<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"syxdevcode.github.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="syxdevcode的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="syxdevcode博客">
<meta property="og:url" content="https://syxdevcode.github.com/page/30/index.html">
<meta property="og:site_name" content="syxdevcode博客">
<meta property="og:description" content="syxdevcode的个人博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="syxdevcode">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://syxdevcode.github.com/page/30/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>syxdevcode博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">syxdevcode博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/syxdevcode" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/21/CSharp-CodeDOM%E7%94%9F%E6%88%90%E7%B1%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/21/CSharp-CodeDOM%E7%94%9F%E6%88%90%E7%B1%BB/" class="post-title-link" itemprop="url">CSharp-CodeDOM生成类</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-21 09:24:11" itemprop="dateCreated datePublished" datetime="2019-01-21T09:24:11+00:00">2019-01-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 10:07:23" itemprop="dateModified" datetime="2022-07-10T10:07:23+00:00">2022-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CodeDOM/" itemprop="url" rel="index"><span itemprop="name">CodeDOM</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CSharp-CodeDOM生成类"><a href="#CSharp-CodeDOM生成类" class="headerlink" title="CSharp-CodeDOM生成类"></a>CSharp-CodeDOM生成类</h1><p>CodeDOM:代码文档对象模型。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/dynamic-source-code-generation-and-compilation">动态源代码生成和编译</a></p>
<p>.NET Framework 包括一个名为代码文档对象模型 (CodeDOM) 的机制。通过该机制，发出源代码的程序开发者可基于一种表示要呈现的代码的单一模型，在运行时以多种编程语言生成源代码。<br>为表示源代码，CodeDOM 元素相互链接，构成一个名为 CodeDOM 图的数据结构。该数据结构对某些源代码的结构建模。</p>
<p><code>System.CodeDom</code> 命名空间定义某些类型，这些类型可以表示源代码的逻辑结构，且不依赖特定编程语言。 <code>System.CodeDom.Compiler</code> 命名空间定义某些类型，用于从 CodeDOM 图中生成源代码，并管理使用支持语言的源代码的编译工作。 编译器供应商或开发人员可以扩展支持语言。</p>
<p>.NET Framework 包括适用于 <code>CSharpCodeProvider</code>、<code>JScriptCodeProvider</code> 和 <code>VBCodeProvider</code> 的代码生成器和代码编译器。</p>
<h2 id="使用CodeDOM创建类"><a href="#使用CodeDOM创建类" class="headerlink" title="使用CodeDOM创建类"></a>使用CodeDOM创建类</h2><p>CodeDOM 提供表示多种常见源代码元素的类型。 可以设计一个程序，它使用 CodeDOM 元素生成源代码模型来组合对象图。 对于支持的编程语言，可使用 CodeDOM 代码生成器将此对象图呈现为源代码。 还可使用 CodeDOM 将源代码编译为二进制程序集。</p>
<p>CodeDOM 的常见用途包括：</p>
<ul>
<li>模板化代码生成：生成适用于 ASP.NET、XML Web 服务客户端代理、代码向导、设计器或其他代码发出机制的代码。</li>
<li>动态编译：支持一种或多种语言的代码编译。</li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/using-the-codedom">使用 CodeDom</a></p>
<p><code>System.CodeDom</code> 命名空间提供用于表示源代码逻辑结构的类，独立于语言语法。</p>
<p>CodeDOM 图的结构类似于一个容器树。 每个可编译 CodeDOM 图的顶端容器或根部容器是 <code>CodeCompileUnit</code>。 源代码模型中的每个元素都必须通过图中 <code>CodeObject</code> 的属性链接至该图。</p>
<p>CodeDOM 定义名为 <code>CodeCompileUnit</code> 的对象，可引用 CodeDOM 对象图，该对象图塑造要编译的源代码的模型。 <code>CodeCompileUnit</code> 具有属性可用于存储对特性、命名空间和程序集的引用。</p>
<p>派生自 <code>CodeDomProvider</code> 类的 CodeDom 提供程序包含处理 CodeCompileUnit 所引用的对象图的方法。</p>
<p>详细请参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/how-to-create-a-class-using-codedom">如何：使用 CodeDOM 创建类</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.codedom.codestatement?view=netframework-4.7.2">CodeStatement Class</a></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> System;</span><br><span class="line">    <span class="keyword">using</span> System.CodeDom;</span><br><span class="line">    <span class="keyword">using</span> System.CodeDom.Compiler;</span><br><span class="line">    <span class="keyword">using</span> System.IO;</span><br><span class="line">    <span class="keyword">using</span> System.Reflection;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> This code example creates a graph using a CodeCompileUnit and</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> generates source code for the graph using the CSharpCodeProvider.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">Sample</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Define the compile unit to use for code generation.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> CodeCompileUnit targetUnit;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> The only class in the compile unit. This class contains 2 fields,</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 3 properties, a constructor, an entry point, and 1 simple method.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> CodeTypeDeclaration targetClass;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> The name of the file to contain the source code.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> outputFileName = <span class="string">&quot;SampleCode.cs&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Define the class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Sample</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 创建编译单元</span></span><br><span class="line">            targetUnit = <span class="keyword">new</span> CodeCompileUnit();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 定义命名空间</span></span><br><span class="line">            CodeNamespace samples = <span class="keyword">new</span> CodeNamespace(<span class="string">&quot;CodeDOMSample&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 导入命名空间</span></span><br><span class="line">            samples.Imports.Add(<span class="keyword">new</span> CodeNamespaceImport(<span class="string">&quot;System&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 定义类型</span></span><br><span class="line">            targetClass = <span class="keyword">new</span> CodeTypeDeclaration(<span class="string">&quot;CodeDOMCreatedClass&quot;</span>);</span><br><span class="line">            targetClass.IsClass = <span class="literal">true</span>;</span><br><span class="line">            targetClass.TypeAttributes =</span><br><span class="line">                TypeAttributes.Public | TypeAttributes.Sealed;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 向命名空间添加类型</span></span><br><span class="line">            samples.Types.Add(targetClass);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将代码元素链接至对象图</span></span><br><span class="line">            targetUnit.Namespaces.Add(samples);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Adds two fields to the class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddFields</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Declare the widthValue field.</span></span><br><span class="line">            CodeMemberField widthValueField = <span class="keyword">new</span> CodeMemberField();</span><br><span class="line">            widthValueField.Attributes = MemberAttributes.Private;</span><br><span class="line">            widthValueField.Name = <span class="string">&quot;widthValue&quot;</span>;</span><br><span class="line">            widthValueField.Type = <span class="keyword">new</span> CodeTypeReference(<span class="keyword">typeof</span>(System.Double));</span><br><span class="line">            widthValueField.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(</span><br><span class="line">                <span class="string">&quot;The width of the object.&quot;</span>));</span><br><span class="line">            targetClass.Members.Add(widthValueField);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Declare the heightValue field</span></span><br><span class="line">            CodeMemberField heightValueField = <span class="keyword">new</span> CodeMemberField();</span><br><span class="line">            heightValueField.Attributes = MemberAttributes.Private;</span><br><span class="line">            heightValueField.Name = <span class="string">&quot;heightValue&quot;</span>;</span><br><span class="line">            heightValueField.Type =</span><br><span class="line">                <span class="keyword">new</span> CodeTypeReference(<span class="keyword">typeof</span>(System.Double));</span><br><span class="line">            heightValueField.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(</span><br><span class="line">                <span class="string">&quot;The height of the object.&quot;</span>));</span><br><span class="line">            targetClass.Members.Add(heightValueField);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Add three properties to the class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddProperties</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Declare the read-only Width property.</span></span><br><span class="line">            CodeMemberProperty widthProperty = <span class="keyword">new</span> CodeMemberProperty();</span><br><span class="line">            widthProperty.Attributes =</span><br><span class="line">                MemberAttributes.Public | MemberAttributes.Final;</span><br><span class="line">            widthProperty.Name = <span class="string">&quot;Width&quot;</span>;</span><br><span class="line">            widthProperty.HasGet = <span class="literal">true</span>;</span><br><span class="line">            widthProperty.Type = <span class="keyword">new</span> CodeTypeReference(<span class="keyword">typeof</span>(System.Double));</span><br><span class="line">            widthProperty.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(</span><br><span class="line">                <span class="string">&quot;The Width property for the object.&quot;</span>));</span><br><span class="line">            widthProperty.GetStatements.Add(<span class="keyword">new</span> CodeMethodReturnStatement(</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;widthValue&quot;</span>)));</span><br><span class="line">            targetClass.Members.Add(widthProperty);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Declare the read-only Height property.</span></span><br><span class="line">            CodeMemberProperty heightProperty = <span class="keyword">new</span> CodeMemberProperty();</span><br><span class="line">            heightProperty.Attributes =</span><br><span class="line">                MemberAttributes.Public | MemberAttributes.Final;</span><br><span class="line">            heightProperty.Name = <span class="string">&quot;Height&quot;</span>;</span><br><span class="line">            heightProperty.HasGet = <span class="literal">true</span>;</span><br><span class="line">            heightProperty.Type = <span class="keyword">new</span> CodeTypeReference(<span class="keyword">typeof</span>(System.Double));</span><br><span class="line">            heightProperty.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(</span><br><span class="line">                <span class="string">&quot;The Height property for the object.&quot;</span>));</span><br><span class="line">            heightProperty.GetStatements.Add(<span class="keyword">new</span> CodeMethodReturnStatement(</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;heightValue&quot;</span>)));</span><br><span class="line">            targetClass.Members.Add(heightProperty);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Declare the read only Area property.</span></span><br><span class="line">            CodeMemberProperty areaProperty = <span class="keyword">new</span> CodeMemberProperty();</span><br><span class="line">            areaProperty.Attributes =</span><br><span class="line">                MemberAttributes.Public | MemberAttributes.Final;</span><br><span class="line">            areaProperty.Name = <span class="string">&quot;Area&quot;</span>;</span><br><span class="line">            areaProperty.HasGet = <span class="literal">true</span>;</span><br><span class="line">            areaProperty.Type = <span class="keyword">new</span> CodeTypeReference(<span class="keyword">typeof</span>(System.Double));</span><br><span class="line">            areaProperty.Comments.Add(<span class="keyword">new</span> CodeCommentStatement(</span><br><span class="line">                <span class="string">&quot;The Area property for the object.&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create an expression to calculate the area for the get accessor</span></span><br><span class="line">            <span class="comment">// of the Area property.</span></span><br><span class="line">            CodeBinaryOperatorExpression areaExpression =</span><br><span class="line">                <span class="keyword">new</span> CodeBinaryOperatorExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;widthValue&quot;</span>),</span><br><span class="line">                CodeBinaryOperatorType.Multiply,</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;heightValue&quot;</span>));</span><br><span class="line">            areaProperty.GetStatements.Add(</span><br><span class="line">                <span class="keyword">new</span> CodeMethodReturnStatement(areaExpression));</span><br><span class="line">            targetClass.Members.Add(areaProperty);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Adds a method to the class. This method multiplies values stored</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> in both fields.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddMethod</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Declaring a ToString method</span></span><br><span class="line">            CodeMemberMethod toStringMethod = <span class="keyword">new</span> CodeMemberMethod();</span><br><span class="line">            toStringMethod.Attributes =</span><br><span class="line">                MemberAttributes.Public | MemberAttributes.Override;</span><br><span class="line">            toStringMethod.Name = <span class="string">&quot;ToString&quot;</span>;</span><br><span class="line">            toStringMethod.ReturnType =</span><br><span class="line">                <span class="keyword">new</span> CodeTypeReference(<span class="keyword">typeof</span>(System.String));</span><br><span class="line"></span><br><span class="line">            CodeFieldReferenceExpression widthReference =</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;Width&quot;</span>);</span><br><span class="line">            CodeFieldReferenceExpression heightReference =</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;Height&quot;</span>);</span><br><span class="line">            CodeFieldReferenceExpression areaReference =</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;Area&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Declaring a return statement for method ToString.</span></span><br><span class="line">            CodeMethodReturnStatement returnStatement =</span><br><span class="line">                <span class="keyword">new</span> CodeMethodReturnStatement();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This statement returns a string representation of the width,</span></span><br><span class="line">            <span class="comment">// height, and area.</span></span><br><span class="line">            <span class="built_in">string</span> formattedOutput = <span class="string">&quot;The object:&quot;</span> + Environment.NewLine +</span><br><span class="line">                <span class="string">&quot; width = &#123;0&#125;,&quot;</span> + Environment.NewLine +</span><br><span class="line">                <span class="string">&quot; height = &#123;1&#125;,&quot;</span> + Environment.NewLine +</span><br><span class="line">                <span class="string">&quot; area = &#123;2&#125;&quot;</span>;</span><br><span class="line">            returnStatement.Expression =</span><br><span class="line">                <span class="keyword">new</span> CodeMethodInvokeExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeTypeReferenceExpression(<span class="string">&quot;System.String&quot;</span>), <span class="string">&quot;Format&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> CodePrimitiveExpression(formattedOutput),</span><br><span class="line">                widthReference, heightReference, areaReference);</span><br><span class="line">            toStringMethod.Statements.Add(returnStatement);</span><br><span class="line">            targetClass.Members.Add(toStringMethod);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Add a constructor to the class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddConstructor</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Declare the constructor</span></span><br><span class="line">            CodeConstructor constructor = <span class="keyword">new</span> CodeConstructor();</span><br><span class="line">            constructor.Attributes =</span><br><span class="line">                MemberAttributes.Public | MemberAttributes.Final;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add parameters.</span></span><br><span class="line">            constructor.Parameters.Add(<span class="keyword">new</span> CodeParameterDeclarationExpression(</span><br><span class="line">                <span class="keyword">typeof</span>(System.Double), <span class="string">&quot;width&quot;</span>));</span><br><span class="line">            constructor.Parameters.Add(<span class="keyword">new</span> CodeParameterDeclarationExpression(</span><br><span class="line">                <span class="keyword">typeof</span>(System.Double), <span class="string">&quot;height&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add field initialization logic</span></span><br><span class="line">            CodeFieldReferenceExpression widthReference =</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;widthValue&quot;</span>);</span><br><span class="line">            constructor.Statements.Add(<span class="keyword">new</span> CodeAssignStatement(widthReference,</span><br><span class="line">                <span class="keyword">new</span> CodeArgumentReferenceExpression(<span class="string">&quot;width&quot;</span>)));</span><br><span class="line">            CodeFieldReferenceExpression heightReference =</span><br><span class="line">                <span class="keyword">new</span> CodeFieldReferenceExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeThisReferenceExpression(), <span class="string">&quot;heightValue&quot;</span>);</span><br><span class="line">            constructor.Statements.Add(<span class="keyword">new</span> CodeAssignStatement(heightReference,</span><br><span class="line">                <span class="keyword">new</span> CodeArgumentReferenceExpression(<span class="string">&quot;height&quot;</span>)));</span><br><span class="line">            targetClass.Members.Add(constructor);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Add an entry point to the class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddEntryPoint</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 为可执行程序定义代码入口点方法</span></span><br><span class="line">            CodeEntryPointMethod start = <span class="keyword">new</span> CodeEntryPointMethod();</span><br><span class="line">            CodeObjectCreateExpression objectCreate =</span><br><span class="line">                <span class="keyword">new</span> CodeObjectCreateExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeTypeReference(<span class="string">&quot;CodeDOMCreatedClass&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> CodePrimitiveExpression(<span class="number">5.3</span>),</span><br><span class="line">                <span class="keyword">new</span> CodePrimitiveExpression(<span class="number">6.9</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the statement:</span></span><br><span class="line">            <span class="comment">// &quot;CodeDOMCreatedClass testClass =</span></span><br><span class="line">            <span class="comment">//     new CodeDOMCreatedClass(5.3, 6.9);&quot;</span></span><br><span class="line">            start.Statements.Add(<span class="keyword">new</span> CodeVariableDeclarationStatement(</span><br><span class="line">                <span class="keyword">new</span> CodeTypeReference(<span class="string">&quot;CodeDOMCreatedClass&quot;</span>), <span class="string">&quot;testClass&quot;</span>,</span><br><span class="line">                objectCreate));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Creat the expression:</span></span><br><span class="line">            <span class="comment">// &quot;testClass.ToString()&quot;</span></span><br><span class="line">            CodeMethodInvokeExpression toStringInvoke =</span><br><span class="line">                <span class="keyword">new</span> CodeMethodInvokeExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeVariableReferenceExpression(<span class="string">&quot;testClass&quot;</span>), <span class="string">&quot;ToString&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add a System.Console.WriteLine statement with the previous</span></span><br><span class="line">            <span class="comment">// expression as a parameter.</span></span><br><span class="line">            start.Statements.Add(<span class="keyword">new</span> CodeMethodInvokeExpression(</span><br><span class="line">                <span class="keyword">new</span> CodeTypeReferenceExpression(<span class="string">&quot;System.Console&quot;</span>),</span><br><span class="line">                <span class="string">&quot;WriteLine&quot;</span>, toStringInvoke));</span><br><span class="line">            targetClass.Members.Add(start);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Generate CSharp source code from the compile unit.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filename&quot;&gt;</span>Output file name<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GenerateCSharpCode</span>(<span class="params"><span class="built_in">string</span> fileName</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            CodeDomProvider provider = CodeDomProvider.CreateProvider(<span class="string">&quot;CSharp&quot;</span>);</span><br><span class="line">            CodeGeneratorOptions options = <span class="keyword">new</span> CodeGeneratorOptions();</span><br><span class="line">            options.BracingStyle = <span class="string">&quot;C&quot;</span>;</span><br><span class="line">            <span class="keyword">using</span> (StreamWriter sourceWriter = <span class="keyword">new</span> StreamWriter(fileName))</span><br><span class="line">            &#123;</span><br><span class="line">                provider.GenerateCodeFromCompileUnit(</span><br><span class="line">                    targetUnit, sourceWriter, options);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Create the CodeDOM graph and generate the code.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Sample sample = <span class="keyword">new</span> Sample();</span><br><span class="line">            sample.AddFields();</span><br><span class="line">            sample.AddProperties();</span><br><span class="line">            sample.AddMethod();</span><br><span class="line">            sample.AddConstructor();</span><br><span class="line">            sample.AddEntryPoint();</span><br><span class="line">            sample.GenerateCSharpCode(outputFileName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成类的代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// &lt;auto-generated&gt;</span></span><br><span class="line"><span class="comment">//     此代码由工具生成。</span></span><br><span class="line"><span class="comment">//     运行时版本:4.0.30319.42000</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     对此文件的更改可能会导致不正确的行为，并且如果</span></span><br><span class="line"><span class="comment">//     重新生成代码，这些更改将会丢失。</span></span><br><span class="line"><span class="comment">// &lt;/auto-generated&gt;</span></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CodeDOMSample</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">CodeDOMCreatedClass</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The width of the object.</span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">double</span> widthValue;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The height of the object.</span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">double</span> heightValue;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CodeDOMCreatedClass</span>(<span class="params"><span class="built_in">double</span> width, <span class="built_in">double</span> height</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.widthValue = width;</span><br><span class="line">            <span class="keyword">this</span>.heightValue = height;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The Width property for the object.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> Width</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.widthValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The Height property for the object.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> Height</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.heightValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The Area property for the object.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> Area</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> (<span class="keyword">this</span>.widthValue * <span class="keyword">this</span>.heightValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">string</span>.Format(<span class="string">&quot;The object:\r\n width = &#123;0&#125;,\r\n height = &#123;1&#125;,\r\n area = &#123;2&#125;&quot;</span>, <span class="keyword">this</span>.Width, <span class="keyword">this</span>.Height, <span class="keyword">this</span>.Area);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            CodeDOMCreatedClass testClass = <span class="keyword">new</span> CodeDOMCreatedClass(<span class="number">5.3</span>D, <span class="number">6.9</span>D);</span><br><span class="line">            System.Console.WriteLine(testClass.ToString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
































































































      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/17/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E6%B3%9B%E5%9E%8B%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/17/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E6%B3%9B%E5%9E%8B%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">CSharp反射发出-定义泛型方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-17 15:29:32" itemprop="dateCreated datePublished" datetime="2019-01-17T15:29:32+00:00">2019-01-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 10:07:23" itemprop="dateModified" datetime="2022-07-10T10:07:23+00:00">2022-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Emit-%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA/" itemprop="url" rel="index"><span itemprop="name">Emit(反射发出)</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><font color=#ff0000 size=4 face="黑体">某方法只要属于泛型类型，且使用该类型的类型参数，就不是泛型方法。 只有当方法有属于自己的类型参数列表时才是泛型方法。</font></p>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/how-to-define-a-generic-method-with-reflection-emit">用反射发出定义泛型方法</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/collectible-assemblies">动态类型生成的可回收程序集</a></p>
<p><font color=#ff0000 size=4 face="黑体">如果发出对泛型类型方法的调用，并且这些类型的类型参数是泛型方法的类型参数，则必须使用 TypeBuilder 类的 staticGetConstructor(Type, ConstructorInfo)、GetMethod(Type, MethodInfo) 和 GetField(Type, FieldInfo) 方法重载来获取方法的构造窗体。</font></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> System;</span><br><span class="line">    <span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line">    <span class="keyword">using</span> System.Reflection;</span><br><span class="line">    <span class="keyword">using</span> System.Reflection.Emit;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Declare a generic delegate that can be used to execute the </span></span><br><span class="line">    <span class="comment">// finished method.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> TOut <span class="title">D</span>&lt;<span class="title">TIn</span>, <span class="title">TOut</span>&gt;(<span class="params">TIn[] input</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">GenericMethodBuilder</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// This method shows how to declare, in Visual Basic, the generic</span></span><br><span class="line">        <span class="comment">// method this program emits. The method has two type parameters,</span></span><br><span class="line">        <span class="comment">// TInput and TOutput, the second of which must be a reference type</span></span><br><span class="line">        <span class="comment">// (class), must have a parameterless constructor (new()), and must</span></span><br><span class="line">        <span class="comment">// implement ICollection&lt;TInput&gt;. This interface constraint</span></span><br><span class="line">        <span class="comment">// ensures that ICollection&lt;TInput&gt;.Add can be used to add</span></span><br><span class="line">        <span class="comment">// elements to the TOutput object the method creates. The method </span></span><br><span class="line">        <span class="comment">// has one formal parameter, input, which is an array of TInput. </span></span><br><span class="line">        <span class="comment">// The elements of this array are copied to the new TOutput.</span></span><br><span class="line">        <span class="comment">// 1,该方法具有两个类型参数：TInput 和 TOutput。</span></span><br><span class="line">        <span class="comment">// 其中第二个参数必须具备以下条件：是引用类型 (class)；具有无参数构造函数 (new)；</span></span><br><span class="line">        <span class="comment">// 实现 ICollection(Of TInput)（在 C# 中为 ICollection&lt;TInput&gt;）。</span></span><br><span class="line">        <span class="comment">// 此接口约束确保可使用 ICollection&lt;T&gt;.Add 方法将元素添加到该方法</span></span><br><span class="line">        <span class="comment">// 创建的 TOutput 集合。 该方法具有一个形参 input，它是 TInput 的数组。</span></span><br><span class="line">        <span class="comment">// 该方法将创建一个 TOutput 类型的集合，并将 input 的元素复制到该集合。</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TOutput <span class="title">Factory</span>&lt;<span class="title">TInput</span>, <span class="title">TOutput</span>&gt;(<span class="params">TInput[] tarray</span>)</span></span><br><span class="line"><span class="function">            <span class="keyword">where</span> TOutput : <span class="keyword">class</span>, ICollection&lt;TInput&gt;, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            TOutput ret = <span class="keyword">new</span> TOutput();</span><br><span class="line">            ICollection&lt;TInput&gt; ic = ret;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (TInput t <span class="keyword">in</span> tarray)</span><br><span class="line">            &#123;</span><br><span class="line">                ic.Add(t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// The following shows the usage syntax of the C#</span></span><br><span class="line">            <span class="comment">// version of the generic method emitted by this program.</span></span><br><span class="line">            <span class="comment">// Note that the generic parameters must be specified </span></span><br><span class="line">            <span class="comment">// explicitly, because the compiler does not have enough </span></span><br><span class="line">            <span class="comment">// context to infer the type of TOutput. In this case, TOutput</span></span><br><span class="line">            <span class="comment">// is a generic List containing strings.</span></span><br><span class="line">            <span class="comment">// </span></span><br><span class="line">            <span class="built_in">string</span>[] arr = &#123; <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="string">&quot;e&quot;</span> &#125;;</span><br><span class="line">            List&lt;<span class="built_in">string</span>&gt; list1 =</span><br><span class="line">                GenericMethodBuilder.Factory&lt;<span class="built_in">string</span>, List&lt;<span class="built_in">string</span>&gt;&gt;(arr);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;The first element is: &#123;0&#125;&quot;</span>, list1[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Creating a dynamic assembly requires an AssemblyName</span></span><br><span class="line">            <span class="comment">// object, and the current application domain.</span></span><br><span class="line">            <span class="comment">// 2,定义动态程序集和动态模块，以包含泛型方法所属类型。</span></span><br><span class="line">            AssemblyName asmName = <span class="keyword">new</span> AssemblyName(<span class="string">&quot;DemoMethodBuilder1&quot;</span>);</span><br><span class="line">            AppDomain domain = AppDomain.CurrentDomain;</span><br><span class="line">            AssemblyBuilder demoAssembly =</span><br><span class="line">                domain.DefineDynamicAssembly(asmName,</span><br><span class="line">                    AssemblyBuilderAccess.RunAndSave);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Define the module that contains the code. For an </span></span><br><span class="line">            <span class="comment">// assembly with one module, the module name is the </span></span><br><span class="line">            <span class="comment">// assembly name plus a file extension.</span></span><br><span class="line">            ModuleBuilder demoModule =</span><br><span class="line">                demoAssembly.DefineDynamicModule(asmName.Name,</span><br><span class="line">                    asmName.Name + <span class="string">&quot;.dll&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Define a type to contain the method.</span></span><br><span class="line">            <span class="comment">// 3,定义泛型方法所属类型。 该类型不一定是泛型类型。</span></span><br><span class="line">            <span class="comment">// 泛型方法可以属于泛型或非泛型类型。</span></span><br><span class="line">            TypeBuilder demoType =</span><br><span class="line">                demoModule.DefineType(<span class="string">&quot;DemoType&quot;</span>, TypeAttributes.Public);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Define a public static method with standard calling</span></span><br><span class="line">            <span class="comment">// conventions. Do not specify the parameter types or the</span></span><br><span class="line">            <span class="comment">// return type, because type parameters will be used for </span></span><br><span class="line">            <span class="comment">// those types, and the type parameters have not been</span></span><br><span class="line">            <span class="comment">// defined yet.</span></span><br><span class="line">            <span class="comment">// 4,定义泛型方法。 </span></span><br><span class="line">            MethodBuilder factory =</span><br><span class="line">                demoType.DefineMethod(<span class="string">&quot;Factory&quot;</span>,</span><br><span class="line">                    MethodAttributes.Public | MethodAttributes.Static);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Defining generic type parameters for the method makes it a</span></span><br><span class="line">            <span class="comment">// generic method. To make the code easier to read, each</span></span><br><span class="line">            <span class="comment">// type parameter is copied to a variable of the same name.</span></span><br><span class="line">            <span class="comment">// 4,通过将包含参数名称的字符串数组传递给 MethodBuilder.DefineGenericParameters</span></span><br><span class="line">            <span class="comment">// 方法来定义 DemoMethod 的泛型类型参数。 这使该方法成为泛型方法。</span></span><br><span class="line">            <span class="built_in">string</span>[] typeParameterNames = &#123; <span class="string">&quot;TInput&quot;</span>, <span class="string">&quot;TOutput&quot;</span> &#125;;</span><br><span class="line">            GenericTypeParameterBuilder[] typeParameters =</span><br><span class="line">                factory.DefineGenericParameters(typeParameterNames);</span><br><span class="line"></span><br><span class="line">            GenericTypeParameterBuilder TInput = typeParameters[<span class="number">0</span>];</span><br><span class="line">            GenericTypeParameterBuilder TOutput = typeParameters[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add special constraints.</span></span><br><span class="line">            <span class="comment">// The type parameter TOutput is constrained to be a reference</span></span><br><span class="line">            <span class="comment">// type, and to have a parameterless constructor. This ensures</span></span><br><span class="line">            <span class="comment">// that the Factory method can create the collection type.</span></span><br><span class="line">            <span class="comment">// 6,可以选择向类型参数添加特殊约束。</span></span><br><span class="line">            <span class="comment">// 使用 SetGenericParameterAttributes 方法添加特殊约束。</span></span><br><span class="line">            <span class="comment">// 约束 TOutput 作为引用类型并且具有无参数构造函数。</span></span><br><span class="line">            TOutput.SetGenericParameterAttributes(</span><br><span class="line">                GenericParameterAttributes.ReferenceTypeConstraint |</span><br><span class="line">                GenericParameterAttributes.DefaultConstructorConstraint);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add interface and base type constraints.</span></span><br><span class="line">            <span class="comment">// The type parameter TOutput is constrained to types that</span></span><br><span class="line">            <span class="comment">// implement the ICollection&lt;T&gt; interface, to ensure that</span></span><br><span class="line">            <span class="comment">// they have an Add method that can be used to add elements.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// To create the constraint, first use MakeGenericType to bind </span></span><br><span class="line">            <span class="comment">// the type parameter TInput to the ICollection&lt;T&gt; interface,</span></span><br><span class="line">            <span class="comment">// returning the type ICollection&lt;TInput&gt;, then pass</span></span><br><span class="line">            <span class="comment">// the newly created type to the SetInterfaceConstraints</span></span><br><span class="line">            <span class="comment">// method. The constraints must be passed as an array, even if</span></span><br><span class="line">            <span class="comment">// there is only one interface.</span></span><br><span class="line">            <span class="comment">// 7,可以选择向类型参数添加类约束和接口约束。</span></span><br><span class="line">            <span class="comment">// 约束类型参数 TOutput 为实现 ICollection&lt;TInput&gt;）接口的类型。</span></span><br><span class="line">            Type icoll = <span class="keyword">typeof</span>(ICollection&lt;&gt;);</span><br><span class="line">            Type icollOfTInput = icoll.MakeGenericType(TInput);</span><br><span class="line">            Type[] constraints = &#123; icollOfTInput &#125;;</span><br><span class="line">            TOutput.SetInterfaceConstraints(constraints);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set parameter types for the method. The method takes</span></span><br><span class="line">            <span class="comment">// one parameter, an array of type TInput.</span></span><br><span class="line">            <span class="comment">// 8,使用 SetParameters 方法定义方法的形参。</span></span><br><span class="line">            Type[] parms = &#123; TInput.MakeArrayType() &#125;;</span><br><span class="line">            factory.SetParameters(parms);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set the return type for the method. The return type is</span></span><br><span class="line">            <span class="comment">// the generic type parameter TOutput.</span></span><br><span class="line">            <span class="comment">// 9,使用 SetReturnType 方法定义该方法的返回类型。</span></span><br><span class="line">            factory.SetReturnType(TOutput);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Generate a code body for the method. </span></span><br><span class="line">            <span class="comment">// -----------------------------------</span></span><br><span class="line">            <span class="comment">// Get a code generator and declare local variables and</span></span><br><span class="line">            <span class="comment">// labels. Save the input array to a local variable.</span></span><br><span class="line">            <span class="comment">// 10，使用 ILGenerator 发出方法主体。</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// (1),获取代码生成器，并声明局部变量和标签。</span></span><br><span class="line">            ILGenerator ilgen = factory.GetILGenerator();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//用于保留该方法返回的新 TOutput</span></span><br><span class="line">            LocalBuilder retVal = ilgen.DeclareLocal(TOutput);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//用于在 TOutput 强制转换成 ICollection&lt;TInput&gt; 时进行保留；</span></span><br><span class="line">            LocalBuilder ic = ilgen.DeclareLocal(icollOfTInput);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 用于保留 TInput 对象的输入数组；</span></span><br><span class="line">            LocalBuilder input = ilgen.DeclareLocal(TInput.MakeArrayType());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//用于循环访问数组</span></span><br><span class="line">            LocalBuilder index = ilgen.DeclareLocal(<span class="keyword">typeof</span>(<span class="built_in">int</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 用于进入循环 (enterLoop)</span></span><br><span class="line">            Label enterLoop = ilgen.DefineLabel();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//用于循环的顶部 (loopAgain)</span></span><br><span class="line">            Label loopAgain = ilgen.DefineLabel();</span><br><span class="line"></span><br><span class="line">            ilgen.Emit(OpCodes.Ldarg_0);</span><br><span class="line">            ilgen.Emit(OpCodes.Stloc_S, input);<span class="comment">//将参数存储到局部变量 input</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create an instance of TOutput, using the generic method </span></span><br><span class="line">            <span class="comment">// overload of the Activator.CreateInstance method. </span></span><br><span class="line">            <span class="comment">// Using this overload requires the specified type to have</span></span><br><span class="line">            <span class="comment">// a parameterless constructor, which is the reason for adding </span></span><br><span class="line">            <span class="comment">// that constraint to TOutput. Create the constructed generic</span></span><br><span class="line">            <span class="comment">// method by passing TOutput to MakeGenericMethod. After</span></span><br><span class="line">            <span class="comment">// emitting code to call the method, emit code to store the</span></span><br><span class="line">            <span class="comment">// new TOutput in a local variable. </span></span><br><span class="line">            <span class="comment">// (2),使用 Activator.CreateInstance 方法的泛型方法重载，</span></span><br><span class="line">            <span class="comment">// 发出代码，创建 TOutput 的实例。</span></span><br><span class="line">            <span class="comment">// TOutput ret = new TOutput();</span></span><br><span class="line">            MethodInfo createInst =</span><br><span class="line">                <span class="keyword">typeof</span>(Activator).GetMethod(<span class="string">&quot;CreateInstance&quot;</span>, Type.EmptyTypes);</span><br><span class="line">            MethodInfo createInstOfTOutput =</span><br><span class="line">                createInst.MakeGenericMethod(TOutput);<span class="comment">// 创建构造泛型方法</span></span><br><span class="line"></span><br><span class="line">            ilgen.Emit(OpCodes.Call, createInstOfTOutput);</span><br><span class="line">            <span class="comment">//发出代码调用方法后,将其存储在局部变量 retVal</span></span><br><span class="line">            ilgen.Emit(OpCodes.Stloc_S, retVal);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Load the reference to the TOutput object, cast it to</span></span><br><span class="line">            <span class="comment">// ICollection&lt;TInput&gt;, and save it.</span></span><br><span class="line">            <span class="comment">// (3),发出代码，将新的 TOutput 对象强制转换为 ICollection&lt;TInput&gt;，</span></span><br><span class="line">            <span class="comment">// 并将其存储在局部变量 ic。</span></span><br><span class="line">            <span class="comment">// ICollection&lt;TInput&gt; ic = ret;</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, retVal);</span><br><span class="line">            ilgen.Emit(OpCodes.Box, TOutput);</span><br><span class="line">            ilgen.Emit(OpCodes.Castclass, icollOfTInput);</span><br><span class="line">            ilgen.Emit(OpCodes.Stloc_S, ic);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Loop through the array, adding each element to the new</span></span><br><span class="line">            <span class="comment">// instance of TOutput. Note that in order to get a MethodInfo</span></span><br><span class="line">            <span class="comment">// for ICollection&lt;TInput&gt;.Add, it is necessary to first </span></span><br><span class="line">            <span class="comment">// get the Add method for the generic type defintion,</span></span><br><span class="line">            <span class="comment">// ICollection&lt;T&gt;.Add. This is because it is not possible</span></span><br><span class="line">            <span class="comment">// to call GetMethod on icollOfTInput. The static overload of</span></span><br><span class="line">            <span class="comment">// TypeBuilder.GetMethod produces the correct MethodInfo for</span></span><br><span class="line">            <span class="comment">// the constructed type.</span></span><br><span class="line">            <span class="comment">// (4),获取表示 ICollection&lt;T&gt;.Add 方法的 MethodInfo。 </span></span><br><span class="line">            MethodInfo mAddPrep = icoll.GetMethod(<span class="string">&quot;Add&quot;</span>);</span><br><span class="line">            MethodInfo mAdd = TypeBuilder.GetMethod(icollOfTInput, mAddPrep);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize the count and enter the loop.</span></span><br><span class="line">            <span class="comment">// (5),通过加载 32 位整数 0 并将其存储在变量中，发出代码，初始化 index 变量。</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldc_I4_0);</span><br><span class="line">            ilgen.Emit(OpCodes.Stloc_S, index); <span class="comment">// index=0</span></span><br><span class="line">            ilgen.Emit(OpCodes.Br_S, enterLoop); <span class="comment">//发出代码，分支到标签 enterLoop</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Mark the beginning of the loop. Push the ICollection</span></span><br><span class="line">            <span class="comment">// reference on the stack, so it will be in position for the</span></span><br><span class="line">            <span class="comment">// call to Add. Then push the array and the index on the </span></span><br><span class="line">            <span class="comment">// stack, get the array element, and call Add (represented</span></span><br><span class="line">            <span class="comment">// by the MethodInfo mAdd) to add it to the collection.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// The other ten instructions just increment the index</span></span><br><span class="line">            <span class="comment">// and test for the end of the loop. Note the MarkLabel</span></span><br><span class="line">            <span class="comment">// method, which sets the point in the code where the </span></span><br><span class="line">            <span class="comment">// loop is entered. (See the earlier Br_S to enterLoop.)</span></span><br><span class="line">            <span class="comment">// (6),发出该循环的代码。</span></span><br><span class="line">            ilgen.MarkLabel(loopAgain);</span><br><span class="line"></span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, ic);</span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, input); <span class="comment">// 数组</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, index); <span class="comment">// 索引</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Ldelem 操作码从堆栈中弹出该索引和数组，</span></span><br><span class="line">            <span class="comment">// 然后将索引数组元素推入堆栈。</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldelem, TInput);</span><br><span class="line">            <span class="comment">// 堆栈现已准备好调用 ICollection&lt;T&gt;.Add 方法，</span></span><br><span class="line">            <span class="comment">// 该方法从堆栈中弹出集合和新元素，并将该元素添加到该集合中。</span></span><br><span class="line">            ilgen.Emit(OpCodes.Callvirt, mAdd);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// index+=1;</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, index);</span><br><span class="line">            ilgen.Emit(OpCodes.Ldc_I4_1);</span><br><span class="line">            ilgen.Emit(OpCodes.Add);</span><br><span class="line">            ilgen.Emit(OpCodes.Stloc_S, index);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用 MarkLabel，将该点设置为循环的入口点。</span></span><br><span class="line">            ilgen.MarkLabel(enterLoop);</span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, index);<span class="comment">// 加载该索引</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, input);<span class="comment">// 将输入数组推入堆栈</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldlen); <span class="comment">// 获取其长度</span></span><br><span class="line">            ilgen.Emit(OpCodes.Conv_I4);</span><br><span class="line">            ilgen.Emit(OpCodes.Clt); <span class="comment">// 二者进行比较</span></span><br><span class="line">            ilgen.Emit(OpCodes.Brtrue_S, loopAgain);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// (7),发出代码，将 TOutput 对象推入堆栈，并从该方法返回。</span></span><br><span class="line">            ilgen.Emit(OpCodes.Ldloc_S, retVal);</span><br><span class="line">            ilgen.Emit(OpCodes.Ret);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Complete the type.</span></span><br><span class="line">            <span class="comment">// 11,完成包含该方法的类型，并保存程序集。</span></span><br><span class="line">            Type dt = demoType.CreateType();</span><br><span class="line">            <span class="comment">// Save the assembly, so it can be examined with Ildasm.exe.</span></span><br><span class="line">            demoAssembly.Save(asmName.Name + <span class="string">&quot;.dll&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*调用泛型方法*/</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// To create a constructed generic method that can be</span></span><br><span class="line">            <span class="comment">// executed, first call the GetMethod method on the completed </span></span><br><span class="line">            <span class="comment">// type to get the generic method definition. Call MakeGenericType</span></span><br><span class="line">            <span class="comment">// on the generic method definition to obtain the constructed</span></span><br><span class="line">            <span class="comment">// method, passing in the type arguments. In this case, the</span></span><br><span class="line">            <span class="comment">// constructed method has string for TInput and List&lt;string&gt;</span></span><br><span class="line">            <span class="comment">// for TOutput. </span></span><br><span class="line">            <span class="comment">// 1，分配泛型类型参数</span></span><br><span class="line">            MethodInfo m = dt.GetMethod(<span class="string">&quot;Factory&quot;</span>);</span><br><span class="line">            MethodInfo bound =</span><br><span class="line">                m.MakeGenericMethod(<span class="keyword">typeof</span>(<span class="built_in">string</span>), <span class="keyword">typeof</span>(List&lt;<span class="built_in">string</span>&gt;));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Display a string representing the bound method.</span></span><br><span class="line">            Console.WriteLine(bound);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Once the generic method is constructed, </span></span><br><span class="line">            <span class="comment">// you can invoke it and pass in an array of objects </span></span><br><span class="line">            <span class="comment">// representing the arguments. In this case, there is only</span></span><br><span class="line">            <span class="comment">// one element in that array, the argument &#x27;arr&#x27;.</span></span><br><span class="line">            <span class="comment">// 2，若要以后期绑定的形式调用该方法，请使用 Invoke 方法。</span></span><br><span class="line">            <span class="comment">// Factory为静态方法</span></span><br><span class="line">            <span class="built_in">object</span> o = bound.Invoke(<span class="literal">null</span>, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; arr &#125;);</span><br><span class="line">            List&lt;<span class="built_in">string</span>&gt; list2 = (List&lt;<span class="built_in">string</span>&gt;)o;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;The first element is: &#123;0&#125;&quot;</span>, list2[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// You can get better performance from multiple calls if</span></span><br><span class="line">            <span class="comment">// you bind the constructed method to a delegate. The </span></span><br><span class="line">            <span class="comment">// following code uses the generic delegate D defined </span></span><br><span class="line">            <span class="comment">// earlier.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            Type dType = <span class="keyword">typeof</span>(D&lt;<span class="built_in">string</span>, List&lt;<span class="built_in">string</span>&gt;&gt;);</span><br><span class="line">            D&lt;<span class="built_in">string</span>, List&lt;<span class="built_in">string</span>&gt;&gt; test;</span><br><span class="line">            test = (D&lt;<span class="built_in">string</span>, List&lt;<span class="built_in">string</span>&gt;&gt;)</span><br><span class="line">                Delegate.CreateDelegate(dType, bound);</span><br><span class="line"></span><br><span class="line">            List&lt;<span class="built_in">string</span>&gt; list3 = test(arr);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;The first element is: &#123;0&#125;&quot;</span>, list3[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/15/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E6%B3%9B%E5%9E%8B%E7%B1%BB%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/15/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E6%B3%9B%E5%9E%8B%E7%B1%BB%E5%9E%8B/" class="post-title-link" itemprop="url">CSharp反射发出-定义泛型类型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-15 09:52:32" itemprop="dateCreated datePublished" datetime="2019-01-15T09:52:32+00:00">2019-01-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 10:07:23" itemprop="dateModified" datetime="2022-07-10T10:07:23+00:00">2022-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Emit-%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA/" itemprop="url" rel="index"><span itemprop="name">Emit(反射发出)</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>9 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>某方法只要属于泛型类型，且使用该类型的类型参数，就不是泛型方法。 只有当方法有属于自己的类型参数列表时才是泛型方法。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/01/15/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E6%B3%9B%E5%9E%8B%E7%B1%BB%E5%9E%8B/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/15/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E5%92%8C%E6%89%A7%E8%A1%8C%E5%8A%A8%E6%80%81%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/15/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E5%92%8C%E6%89%A7%E8%A1%8C%E5%8A%A8%E6%80%81%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">CSharp反射发出-定义和执行动态方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-15 09:12:26" itemprop="dateCreated datePublished" datetime="2019-01-15T09:12:26+00:00">2019-01-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 10:07:23" itemprop="dateModified" datetime="2022-07-10T10:07:23+00:00">2022-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Emit-%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA/" itemprop="url" rel="index"><span itemprop="name">Emit(反射发出)</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>详细信息，请参考https://docs.microsoft.com/zh-cn/dotnet/api/system.reflection.emit.dynamicmethod?view=netframework-4.7.2</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/01/15/CSharp%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA-%E5%AE%9A%E4%B9%89%E5%92%8C%E6%89%A7%E8%A1%8C%E5%8A%A8%E6%80%81%E6%96%B9%E6%B3%95/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/15/CSharp-%E8%AE%A4%E8%AF%86%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/15/CSharp-%E8%AE%A4%E8%AF%86%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA/" class="post-title-link" itemprop="url">CSharp-认识反射发出</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-15 08:51:32" itemprop="dateCreated datePublished" datetime="2019-01-15T08:51:32+00:00">2019-01-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 10:07:23" itemprop="dateModified" datetime="2022-07-10T10:07:23+00:00">2022-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Emit-%E5%8F%8D%E5%B0%84%E5%8F%91%E5%87%BA/" itemprop="url" rel="index"><span itemprop="name">Emit(反射发出)</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>402</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/emitting-dynamic-methods-and-assemblies">发出动态方法和程序集</a></p>
<p><code>System.Reflection.Emit</code> 命名空间提供的功能被称为反射发出。 <code>System.Reflection.Emit</code> 命名空间中的一组托管类型，它们允许编译器或工具在运行时发出元数据和 Microsoft 中间语言 (MSIL)，并在磁盘上生成可移植可执行 (PE) 文件（可选）。</p>
<p>反射发出具有以下功能：</p>
<ul>
<li>在运行时定义轻量全局方法（使用 <code>DynamicMethod</code> 类）并通过委托执行这些方法。</li>
<li>在运行时定义程序集，然后运行程序集以及/或者将程序集保存到磁盘。</li>
<li>在运行时定义程序集，运行程序集，然后卸载程序集并允许垃圾回收回收其资源。</li>
<li>在运行时在新的程序集中定义模块，然后运行模块以及/或者将模块保存到磁盘。</li>
<li>在运行时在模块中定义类型，创建这些类型的实例并调用其方法。</li>
<li>为已定义模块定义可供工具（如调试器和代码探查器）使用的符号化信息。</li>
</ul>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.reflection.emit.opcodes?view=netframework-4.7.2">OpCodes</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.reflection.emit?view=netframework-4.7.2">System.Reflection.Emit</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/13/CSharp%E5%8F%8D%E5%B0%84-%E4%BD%BF%E7%94%A8%E5%8F%8D%E5%B0%84%E8%BF%9E%E6%8E%A5%E5%A7%94%E6%89%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/13/CSharp%E5%8F%8D%E5%B0%84-%E4%BD%BF%E7%94%A8%E5%8F%8D%E5%B0%84%E8%BF%9E%E6%8E%A5%E5%A7%94%E6%89%98/" class="post-title-link" itemprop="url">CSharp反射-使用反射连接委托</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-13 16:10:21" itemprop="dateCreated datePublished" datetime="2019-01-13T16:10:21+00:00">2019-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 10:07:23" itemprop="dateModified" datetime="2022-07-10T10:07:23+00:00">2022-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8F%8D%E5%B0%84/" itemprop="url" rel="index"><span itemprop="name">反射</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>使用反射加载和运行程序集时，不能使用 C# += 运算符将事件挂钩。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/01/13/CSharp%E5%8F%8D%E5%B0%84-%E4%BD%BF%E7%94%A8%E5%8F%8D%E5%B0%84%E8%BF%9E%E6%8E%A5%E5%A7%94%E6%89%98/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/13/CSharp%E5%9F%BA%E7%A1%80-%E8%AE%A4%E8%AF%86%E5%8F%8D%E5%B0%84-%E4%B8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/13/CSharp%E5%9F%BA%E7%A1%80-%E8%AE%A4%E8%AF%86%E5%8F%8D%E5%B0%84-%E4%B8%8B/" class="post-title-link" itemprop="url">CSharp基础-认识反射-下</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-13 10:50:33" itemprop="dateCreated datePublished" datetime="2019-01-13T10:50:33+00:00">2019-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 10:07:23" itemprop="dateModified" datetime="2022-07-10T10:07:23+00:00">2022-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8F%8D%E5%B0%84/" itemprop="url" rel="index"><span itemprop="name">反射</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CSharp基础-认识反射-下"><a href="#CSharp基础-认识反射-下" class="headerlink" title="CSharp基础-认识反射-下"></a>CSharp基础-认识反射-下</h1><h2 id="访问自定义特性"><a href="#访问自定义特性" class="headerlink" title="访问自定义特性"></a>访问自定义特性</h2><p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/accessing-custom-attributes">访问自定义特性</a></p>
<h3 id="仅反射上下文"><a href="#仅反射上下文" class="headerlink" title="仅反射上下文"></a>仅反射上下文</h3><p>加载到仅反射上下文中的代码无法执行。在仅反射上下文中加载和检查自定义特性，使用 <code>CustomAttributeData</code> 类。通过使用静态 <code>CustomAttributeData.GetCustomAttributes</code> 方法的相应重载来获取此类的实例。</p>
<h3 id="执行上下文"><a href="#执行上下文" class="headerlink" title="执行上下文"></a>执行上下文</h3><p>用于查询执行上下文中的特性的主要反射方法是 <code>MemberInfo.GetCustomAttributes</code> 和 <code>Attribute.GetCustomAttributes</code>。</p>
<p>自定义特性的可访问性根据附加该特性的程序集来进行检查。</p>
<p><code>Assembly.GetCustomAttributes(Boolean)</code> 等方法检查类型参数的可见性和可访问性。 只有包含用户定义类型的程序集中的代码才能使用 <code>GetCustomAttributes</code> 检索该类型的自定义特性。</p>
<p>自定义特性反射模型可能会在定义类型的程序集外泄漏用户定义类型的实例。 为了防止客户端发现关于用户定义的自定义特性类型的信息，请将该类型的成员定义为非公共成员。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExampleAttribute</span> : <span class="title">Attribute</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> stringVal;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExampleAttribute</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        stringVal = <span class="string">&quot;This is the default string.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> StringValue</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> stringVal; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; stringVal = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Example(StringValue=<span class="string">&quot;This is a string.&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">class</span> <span class="title">Class1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.Reflection.MemberInfo info = <span class="keyword">typeof</span>(Class1);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="built_in">object</span> attrib <span class="keyword">in</span> info.GetCustomAttributes(<span class="literal">true</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(attrib);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="指定完全限定的类型名称"><a href="#指定完全限定的类型名称" class="headerlink" title="指定完全限定的类型名称"></a>指定完全限定的类型名称</h2><p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/specifying-fully-qualified-type-names">指定完全限定的类型名称</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/12/CSharp%E5%9F%BA%E7%A1%80-%E8%AE%A4%E8%AF%86%E5%8F%8D%E5%B0%84-%E4%B8%AD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/12/CSharp%E5%9F%BA%E7%A1%80-%E8%AE%A4%E8%AF%86%E5%8F%8D%E5%B0%84-%E4%B8%AD/" class="post-title-link" itemprop="url">CSharp基础-认识反射-中</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-12 15:52:24" itemprop="dateCreated datePublished" datetime="2019-01-12T15:52:24+00:00">2019-01-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 10:07:23" itemprop="dateModified" datetime="2022-07-10T10:07:23+00:00">2022-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8F%8D%E5%B0%84/" itemprop="url" rel="index"><span itemprop="name">反射</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>13 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CSharp基础-认识反射-中"><a href="#CSharp基础-认识反射-中" class="headerlink" title="CSharp基础-认识反射-中"></a>CSharp基础-认识反射-中</h1><p>本文包括动态加载和使用类型，将程序集加载到仅反射上下文中；</p>
<h2 id="动态加载和使用类型"><a href="#动态加载和使用类型" class="headerlink" title="动态加载和使用类型"></a>动态加载和使用类型</h2><h3 id="自定义绑定"><a href="#自定义绑定" class="headerlink" title="自定义绑定"></a>自定义绑定</h3><p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/dynamically-loading-and-using-types#custom-binding">自定义绑定</a></p>
<p>反射可在代码中显式用于完成后期绑定。在通过反射实现的后期绑定中，必须由自定义绑定来控制该绑定。 <code>Binder</code> 类提供对成员选择和调用的自定义控制。</p>
<p>使用自定义绑定可以在运行时加载程序集、获取该程序集中有关类型的信息、指定所需类型，并在之后调用该类型上的方法或访问该类型上的字段或属性。 如果在编译时不知道对象的类型，则此方法非常有用，例如当对象类型取决于用户输入时。</p>
<p>实例：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">ClassLibrary1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MySimpleClass</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MyMethod</span>(<span class="params"><span class="built_in">string</span> str, <span class="built_in">int</span> i</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;MyMethod parameters: &#123;0&#125;, &#123;1&#125;&quot;</span>, str, i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MyMethod</span>(<span class="params"><span class="built_in">string</span> str, <span class="built_in">int</span> i, <span class="built_in">int</span> j</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;MyMethod parameters: &#123;0&#125;, &#123;1&#125;, &#123;2&#125;&quot;</span>,</span><br><span class="line">                str, i, j);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> ClassLibrary1;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Globalization;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">MyMainClass</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Get the type of MySimpleClass.</span></span><br><span class="line">            Type myType = <span class="keyword">typeof</span>(MySimpleClass);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get an instance of MySimpleClass.</span></span><br><span class="line">            MySimpleClass myInstance = <span class="keyword">new</span> MySimpleClass();</span><br><span class="line">            MyCustomBinder myCustomBinder = <span class="keyword">new</span> MyCustomBinder();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get the method information for the particular overload</span></span><br><span class="line">            <span class="comment">// being sought.</span></span><br><span class="line">            MethodInfo myMethod = myType.GetMethod(<span class="string">&quot;MyMethod&quot;</span>,</span><br><span class="line">                BindingFlags.Public | BindingFlags.Instance,</span><br><span class="line">                myCustomBinder, <span class="keyword">new</span> Type[] &#123;<span class="keyword">typeof</span>(<span class="built_in">string</span>),</span><br><span class="line">                <span class="keyword">typeof</span>(<span class="built_in">int</span>)&#125;, <span class="literal">null</span>);</span><br><span class="line">            Console.WriteLine(myMethod.ToString());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Invoke the overload.</span></span><br><span class="line">            myType.InvokeMember(<span class="string">&quot;MyMethod&quot;</span>, BindingFlags.InvokeMethod,</span><br><span class="line">                myCustomBinder, myInstance,</span><br><span class="line">                <span class="keyword">new</span> Object[] &#123; <span class="string">&quot;Testing...&quot;</span>, (<span class="built_in">int</span>)<span class="number">32</span> &#125;);</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ****************************************************</span></span><br><span class="line">    <span class="comment">//  A simple custom binder that provides no</span></span><br><span class="line">    <span class="comment">//  argument type conversion.</span></span><br><span class="line">    <span class="comment">// ****************************************************</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">MyCustomBinder</span> : <span class="title">Binder</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> MethodBase <span class="title">BindToMethod</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            BindingFlags bindingAttr,</span></span></span><br><span class="line"><span class="params"><span class="function">            MethodBase[] match,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">ref</span> <span class="built_in">object</span>[] args,</span></span></span><br><span class="line"><span class="params"><span class="function">            ParameterModifier[] modifiers,</span></span></span><br><span class="line"><span class="params"><span class="function">            CultureInfo culture,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="built_in">string</span>[] names,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">out</span> <span class="built_in">object</span> state</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (match == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">&quot;match&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Arguments are not being reordered.</span></span><br><span class="line">            state = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// Find a parameter match and return the first method with</span></span><br><span class="line">            <span class="comment">// parameters that match the request.</span></span><br><span class="line">            <span class="keyword">foreach</span> (MethodBase mb <span class="keyword">in</span> match)</span><br><span class="line">            &#123;</span><br><span class="line">                ParameterInfo[] parameters = mb.GetParameters();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ParametersMatch(parameters, args))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> mb;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> FieldInfo <span class="title">BindToField</span>(<span class="params">BindingFlags bindingAttr,</span></span></span><br><span class="line"><span class="params"><span class="function">            FieldInfo[] match, <span class="built_in">object</span> <span class="keyword">value</span>, CultureInfo culture</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (match == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">&quot;match&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">foreach</span> (FieldInfo fi <span class="keyword">in</span> match)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (fi.GetType() == <span class="keyword">value</span>.GetType())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> fi;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> MethodBase <span class="title">SelectMethod</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            BindingFlags bindingAttr,</span></span></span><br><span class="line"><span class="params"><span class="function">            MethodBase[] match,</span></span></span><br><span class="line"><span class="params"><span class="function">            Type[] types,</span></span></span><br><span class="line"><span class="params"><span class="function">            ParameterModifier[] modifiers</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (match == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">&quot;match&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Find a parameter match and return the first method with</span></span><br><span class="line">            <span class="comment">// parameters that match the request.</span></span><br><span class="line">            <span class="keyword">foreach</span> (MethodBase mb <span class="keyword">in</span> match)</span><br><span class="line">            &#123;</span><br><span class="line">                ParameterInfo[] parameters = mb.GetParameters();</span><br><span class="line">                <span class="keyword">if</span> (ParametersMatch(parameters, types))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> mb;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> PropertyInfo <span class="title">SelectProperty</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            BindingFlags bindingAttr,</span></span></span><br><span class="line"><span class="params"><span class="function">            PropertyInfo[] match,</span></span></span><br><span class="line"><span class="params"><span class="function">            Type returnType,</span></span></span><br><span class="line"><span class="params"><span class="function">            Type[] indexes,</span></span></span><br><span class="line"><span class="params"><span class="function">            ParameterModifier[] modifiers</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (match == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">&quot;match&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">foreach</span> (PropertyInfo pi <span class="keyword">in</span> match)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (pi.GetType() == returnType &amp;&amp;</span><br><span class="line">                    ParametersMatch(pi.GetIndexParameters(), indexes))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> pi;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">object</span> <span class="title">ChangeType</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="built_in">object</span> <span class="keyword">value</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            Type myChangeType,</span></span></span><br><span class="line"><span class="params"><span class="function">            CultureInfo culture</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">object</span> newType;</span><br><span class="line">                newType = Convert.ChangeType(<span class="keyword">value</span>, myChangeType);</span><br><span class="line">                <span class="keyword">return</span> newType;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Throw an InvalidCastException if the conversion cannot</span></span><br><span class="line">            <span class="comment">// be done by the Convert.ChangeType method.</span></span><br><span class="line">            <span class="keyword">catch</span> (InvalidCastException)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">ReorderArgumentArray</span>(<span class="params"><span class="keyword">ref</span> <span class="built_in">object</span>[] args,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="built_in">object</span> state</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// No operation is needed here because BindToMethod does not</span></span><br><span class="line">            <span class="comment">// reorder the args array. The most common implementation</span></span><br><span class="line">            <span class="comment">// of this method is shown below.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// ((BinderState)state).args.CopyTo(args, 0);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Returns true only if the type of each object in a matches</span></span><br><span class="line">        <span class="comment">// the type of each corresponding object in b.</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">ParametersMatch</span>(<span class="params">ParameterInfo[] a, <span class="built_in">object</span>[] b</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (a.Length != b.Length)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; a.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (a[i].ParameterType != b[i].GetType())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Returns true only if the type of each object in a matches</span></span><br><span class="line">        <span class="comment">// the type of each corresponding entry in b.</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">ParametersMatch</span>(<span class="params">ParameterInfo[] a, Type[] b</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (a.Length != b.Length)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; a.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (a[i].ParameterType != b[i])</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="InvokeMember-和-CreateInstance"><a href="#InvokeMember-和-CreateInstance" class="headerlink" title="InvokeMember 和 CreateInstance"></a>InvokeMember 和 CreateInstance</h3><p>使用 <code>Type.InvokeMember</code> 调用类型的成员。<code>InvokeMember</code> 可以创建指定类型的新实例，而各种类的 <code>CreateInstance</code> 方法（例如 <code>Activator.CreateInstance</code> 和 <code>Assembly.CreateInstance</code>）是 <code>InvokeMember</code> 的专用形式。 <code>Binder</code> 类可在这些方法中用于重载解析和参数强制转换。</p>
<p>实例：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomBinderDriver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Type t = <span class="keyword">typeof</span>(CustomBinderDriver);</span><br><span class="line">        CustomBinder binder = <span class="keyword">new</span> CustomBinder();</span><br><span class="line">        BindingFlags flags = BindingFlags.InvokeMethod | BindingFlags.Instance |</span><br><span class="line">            BindingFlags.Public | BindingFlags.Static;</span><br><span class="line">        <span class="built_in">object</span>[] args;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Case 1. Neither argument coercion nor member selection is needed.</span></span><br><span class="line">        args = <span class="keyword">new</span> <span class="built_in">object</span>[] &#123;&#125;;</span><br><span class="line">        t.InvokeMember(<span class="string">&quot;PrintBob&quot;</span>, flags, binder, <span class="literal">null</span>, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Case 2. Only member selection is needed.</span></span><br><span class="line">        args = <span class="keyword">new</span> <span class="built_in">object</span>[] &#123;<span class="number">42</span>&#125;;</span><br><span class="line">        t.InvokeMember(<span class="string">&quot;PrintValue&quot;</span>, flags, binder, <span class="literal">null</span>, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Case 3. Only argument coercion is needed.</span></span><br><span class="line">        args = <span class="keyword">new</span> <span class="built_in">object</span>[] &#123;<span class="string">&quot;5.5&quot;</span>&#125;;</span><br><span class="line">        t.InvokeMember(<span class="string">&quot;PrintNumber&quot;</span>, flags, binder, <span class="literal">null</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">PrintBob</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;PrintBob&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">PrintValue</span>(<span class="params"><span class="built_in">long</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;PrintValue(&#123;0&#125;)&quot;</span>, <span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">PrintValue</span>(<span class="params"><span class="built_in">string</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;PrintValue\&quot;&#123;0&#125;\&quot;)&quot;</span>, <span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">PrintNumber</span>(<span class="params"><span class="built_in">double</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;PrintNumber (&#123;0&#125;)&quot;</span>, <span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="将程序集加载到仅反射上下文中"><a href="#将程序集加载到仅反射上下文中" class="headerlink" title="将程序集加载到仅反射上下文中"></a>将程序集加载到仅反射上下文中</h2><p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/how-to-load-assemblies-into-the-reflection-only-context">如何：将程序集加载到仅反射上下文中</a></p>
<p>通过仅反射加载上下文，可检查为其他平台或 .NET Framework 的其他版本编译的程序集。 只能检查，不能执行加载到此上下文中的代码。 这意味着无法创建对象，因为无法执行构造函数。 因为该代码无法执行，所以不会自动加载依赖项。 如果该程序集具有依赖项，<code>ReflectionOnlyLoad</code> 方法不会加载这些依赖项。如果需要对依赖项进行检查，必须自行加载。使用 <code>CustomAttributeData.GetCustomAttributes</code> 方法的适当重载获取表示应用于程序集、成员、模块或参数的特性的 <code>CustomAttributeData</code> 对象。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Collections.ObjectModel;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The example attribute is applied to the assembly.</span></span><br><span class="line">[<span class="meta">assembly:Example(ExampleKind.ThirdKind, Note=<span class="string">&quot;This is a note on the assembly.&quot;</span>)</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// An enumeration used by the ExampleAttribute class.</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> ExampleKind</span><br><span class="line">&#123;</span><br><span class="line">    FirstKind, </span><br><span class="line">    SecondKind, </span><br><span class="line">    ThirdKind, </span><br><span class="line">    FourthKind</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// An example attribute. The attribute can be applied to all</span></span><br><span class="line"><span class="comment">// targets, from assemblies to parameters.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.All)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExampleAttribute</span> : <span class="title">Attribute</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Data for properties.</span></span><br><span class="line">    <span class="keyword">private</span> ExampleKind kindValue;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> noteValue;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span>[] arrayStrings;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span>[] arrayNumbers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Constructors. The parameterless constructor (.ctor) calls</span></span><br><span class="line">    <span class="comment">// the constructor that specifies ExampleKind and an array of </span></span><br><span class="line">    <span class="comment">// strings, and supplies the default values.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExampleAttribute</span>(<span class="params">ExampleKind initKind, <span class="built_in">string</span>[] initStrings</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        kindValue = initKind;</span><br><span class="line">        arrayStrings = initStrings;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExampleAttribute</span>(<span class="params">ExampleKind initKind</span>) : <span class="title">this</span>(<span class="params">initKind, <span class="literal">null</span></span>)</span> &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExampleAttribute</span>() : <span class="title">this</span>(<span class="params">ExampleKind.FirstKind, <span class="literal">null</span></span>)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Properties. The Note and Numbers properties must be read/write, so they</span></span><br><span class="line">    <span class="comment">// can be used as named parameters.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">public</span> ExampleKind Kind &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> kindValue; &#125;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>[] Strings &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> arrayStrings; &#125;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Note</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> noteValue; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; noteValue = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span>[] Numbers</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> arrayNumbers; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; arrayNumbers = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The example attribute is applied to the test class.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">[<span class="meta">Example(ExampleKind.SecondKind, </span></span><br><span class="line"><span class="meta">         new string[</span>] &#123; <span class="string">&quot;String array argument, line 1&quot;</span>, </span><br><span class="line">                        <span class="string">&quot;String array argument, line 2&quot;</span>, </span><br><span class="line">                        <span class="string">&quot;String array argument, line 3&quot;</span> &#125;, </span><br><span class="line">         Note=<span class="string">&quot;This is a note on the class.&quot;</span>,</span><br><span class="line">         Numbers = <span class="keyword">new</span> <span class="built_in">int</span>[] &#123; <span class="number">53</span>, <span class="number">57</span>, <span class="number">59</span> &#125;)] </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Test</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// The example attribute is applied to a method, using the</span></span><br><span class="line">    <span class="comment">// parameterless constructor and supplying a named argument.</span></span><br><span class="line">    <span class="comment">// The attribute is also applied to the method parameter.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    [<span class="meta">Example(Note=<span class="string">&quot;This is a note on a method.&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TestMethod</span>(<span class="params">[Example] <span class="built_in">object</span> arg</span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Main() gets objects representing the assembly, the test</span></span><br><span class="line">    <span class="comment">// type, the test method, and the method parameter. Custom</span></span><br><span class="line">    <span class="comment">// attribute data is displayed for each of these.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Assembly asm = Assembly.ReflectionOnlyLoad(<span class="string">&quot;Source&quot;</span>);</span><br><span class="line">        Type t = asm.GetType(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        MethodInfo m = t.GetMethod(<span class="string">&quot;TestMethod&quot;</span>);</span><br><span class="line">        ParameterInfo[] p = m.GetParameters();</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;\r\nAttributes for assembly: &#x27;&#123;0&#125;&#x27;&quot;</span>, asm);</span><br><span class="line">        ShowAttributeData(CustomAttributeData.GetCustomAttributes(asm));</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;\r\nAttributes for type: &#x27;&#123;0&#125;&#x27;&quot;</span>, t);</span><br><span class="line">        ShowAttributeData(CustomAttributeData.GetCustomAttributes(t));</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;\r\nAttributes for member: &#x27;&#123;0&#125;&#x27;&quot;</span>, m);</span><br><span class="line">        ShowAttributeData(CustomAttributeData.GetCustomAttributes(m));</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;\r\nAttributes for parameter: &#x27;&#123;0&#125;&#x27;&quot;</span>, p);</span><br><span class="line">        ShowAttributeData(CustomAttributeData.GetCustomAttributes(p[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ShowAttributeData</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        IList&lt;CustomAttributeData&gt; attributes</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>( CustomAttributeData cad <span class="keyword">in</span> attributes )</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;   &#123;0&#125;&quot;</span>, cad);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;      Constructor: &#x27;&#123;0&#125;&#x27;&quot;</span>, cad.Constructor);</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;      Constructor arguments:&quot;</span>);</span><br><span class="line">            <span class="keyword">foreach</span>( CustomAttributeTypedArgument cata </span><br><span class="line">                <span class="keyword">in</span> cad.ConstructorArguments )</span><br><span class="line">            &#123;</span><br><span class="line">                ShowValueOrArray(cata);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;      Named arguments:&quot;</span>);</span><br><span class="line">            <span class="keyword">foreach</span>( CustomAttributeNamedArgument cana </span><br><span class="line">                <span class="keyword">in</span> cad.NamedArguments )</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;         MemberInfo: &#x27;&#123;0&#125;&#x27;&quot;</span>, </span><br><span class="line">                    cana.MemberInfo);</span><br><span class="line">                ShowValueOrArray(cana.TypedValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ShowValueOrArray</span>(<span class="params">CustomAttributeTypedArgument cata</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (cata.Value.GetType() == <span class="keyword">typeof</span>(ReadOnlyCollection&lt;CustomAttributeTypedArgument&gt;))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;         Array of &#x27;&#123;0&#125;&#x27;:&quot;</span>, cata.ArgumentType);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="function">CustomAttributeTypedArgument cataElement <span class="title">in</span> </span></span><br><span class="line"><span class="function">                (<span class="params">ReadOnlyCollection&lt;CustomAttributeTypedArgument&gt;</span>) cata.Value)</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;             Type: &#x27;&#123;0&#125;&#x27;  Value: &#x27;&#123;1&#125;&#x27;&quot;</span>,</span><br><span class="line">                    cataElement.ArgumentType, cataElement.Value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;         Type: &#x27;&#123;0&#125;&#x27;  Value: &#x27;&#123;1&#125;&#x27;&quot;</span>, </span><br><span class="line">                cata.ArgumentType, cata.Value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This code example produces output similar to the following:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Attributes for assembly: &#x27;source, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null&#x27;</span></span><br><span class="line"><span class="comment">   [System.Runtime.CompilerServices.CompilationRelaxationsAttribute((Int32)8)]</span></span><br><span class="line"><span class="comment">      Constructor: &#x27;Void .ctor(Int32)&#x27;</span></span><br><span class="line"><span class="comment">      Constructor arguments:</span></span><br><span class="line"><span class="comment">         Type: &#x27;System.Int32&#x27;  Value: &#x27;8&#x27;</span></span><br><span class="line"><span class="comment">      Named arguments:</span></span><br><span class="line"><span class="comment">   [System.Runtime.CompilerServices.RuntimeCompatibilityAttribute(WrapNonExceptionThrows = True)]</span></span><br><span class="line"><span class="comment">      Constructor: &#x27;Void .ctor()&#x27;</span></span><br><span class="line"><span class="comment">      Constructor arguments:</span></span><br><span class="line"><span class="comment">      Named arguments:</span></span><br><span class="line"><span class="comment">         MemberInfo: &#x27;Boolean WrapNonExceptionThrows&#x27;</span></span><br><span class="line"><span class="comment">         Type: &#x27;System.Boolean&#x27;  Value: &#x27;True&#x27;</span></span><br><span class="line"><span class="comment">   [ExampleAttribute((ExampleKind)2, Note = &quot;This is a note on the assembly.&quot;)]</span></span><br><span class="line"><span class="comment">      Constructor: &#x27;Void .ctor(ExampleKind)&#x27;</span></span><br><span class="line"><span class="comment">      Constructor arguments:</span></span><br><span class="line"><span class="comment">         Type: &#x27;ExampleKind&#x27;  Value: &#x27;2&#x27;</span></span><br><span class="line"><span class="comment">      Named arguments:</span></span><br><span class="line"><span class="comment">         MemberInfo: &#x27;System.String Note&#x27;</span></span><br><span class="line"><span class="comment">         Type: &#x27;System.String&#x27;  Value: &#x27;This is a note on the assembly.&#x27;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Attributes for type: &#x27;Test&#x27;</span></span><br><span class="line"><span class="comment">   [ExampleAttribute((ExampleKind)1, new String[3] &#123; &quot;String array argument, line 1&quot;, &quot;String array argument, line 2&quot;, &quot;String array argument, line 3&quot; &#125;, Note = &quot;This is a note on the class.&quot;, Numbers = new Int32[3] &#123; 53, 57, 59 &#125;)]</span></span><br><span class="line"><span class="comment">      Constructor: &#x27;Void .ctor(ExampleKind, System.String[])&#x27;</span></span><br><span class="line"><span class="comment">      Constructor arguments:</span></span><br><span class="line"><span class="comment">         Type: &#x27;ExampleKind&#x27;  Value: &#x27;1&#x27;</span></span><br><span class="line"><span class="comment">         Array of &#x27;System.String[]&#x27;:</span></span><br><span class="line"><span class="comment">             Type: &#x27;System.String&#x27;  Value: &#x27;String array argument, line 1&#x27;</span></span><br><span class="line"><span class="comment">             Type: &#x27;System.String&#x27;  Value: &#x27;String array argument, line 2&#x27;</span></span><br><span class="line"><span class="comment">             Type: &#x27;System.String&#x27;  Value: &#x27;String array argument, line 3&#x27;</span></span><br><span class="line"><span class="comment">      Named arguments:</span></span><br><span class="line"><span class="comment">         MemberInfo: &#x27;System.String Note&#x27;</span></span><br><span class="line"><span class="comment">         Type: &#x27;System.String&#x27;  Value: &#x27;This is a note on the class.&#x27;</span></span><br><span class="line"><span class="comment">         MemberInfo: &#x27;Int32[] Numbers&#x27;</span></span><br><span class="line"><span class="comment">         Array of &#x27;System.Int32[]&#x27;:</span></span><br><span class="line"><span class="comment">             Type: &#x27;System.Int32&#x27;  Value: &#x27;53&#x27;</span></span><br><span class="line"><span class="comment">             Type: &#x27;System.Int32&#x27;  Value: &#x27;57&#x27;</span></span><br><span class="line"><span class="comment">             Type: &#x27;System.Int32&#x27;  Value: &#x27;59&#x27;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Attributes for member: &#x27;Void TestMethod(System.Object)&#x27;</span></span><br><span class="line"><span class="comment">   [ExampleAttribute(Note = &quot;This is a note on a method.&quot;)]</span></span><br><span class="line"><span class="comment">      Constructor: &#x27;Void .ctor()&#x27;</span></span><br><span class="line"><span class="comment">      Constructor arguments:</span></span><br><span class="line"><span class="comment">      Named arguments:</span></span><br><span class="line"><span class="comment">         MemberInfo: &#x27;System.String Note&#x27;</span></span><br><span class="line"><span class="comment">         Type: &#x27;System.String&#x27;  Value: &#x27;This is a note on a method.&#x27;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Attributes for parameter: &#x27;System.Object arg&#x27;</span></span><br><span class="line"><span class="comment">   [ExampleAttribute()]</span></span><br><span class="line"><span class="comment">      Constructor: &#x27;Void .ctor()&#x27;</span></span><br><span class="line"><span class="comment">      Constructor arguments:</span></span><br><span class="line"><span class="comment">      Named arguments:</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/11/CSharp%E5%9F%BA%E7%A1%80-%E8%AE%A4%E8%AF%86%E5%8F%8D%E5%B0%84-%E4%B8%8A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/11/CSharp%E5%9F%BA%E7%A1%80-%E8%AE%A4%E8%AF%86%E5%8F%8D%E5%B0%84-%E4%B8%8A/" class="post-title-link" itemprop="url">CSharp基础-认识反射-上</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-11 08:47:54" itemprop="dateCreated datePublished" datetime="2019-01-11T08:47:54+00:00">2019-01-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 10:07:23" itemprop="dateModified" datetime="2022-07-10T10:07:23+00:00">2022-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8F%8D%E5%B0%84/" itemprop="url" rel="index"><span itemprop="name">反射</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>12 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CSharp基础-认识反射-上"><a href="#CSharp基础-认识反射-上" class="headerlink" title="CSharp基础-认识反射-上"></a>CSharp基础-认识反射-上</h1><p>本章包括查看对象类型信息，反射类型和泛型反射，反射检查和实例化泛型类型。</p>
<h2 id="反射概述"><a href="#反射概述" class="headerlink" title="反射概述"></a>反射概述</h2><p>在程序中，当我们需要动态的去加载程序集的时候(将对程序集的引用由编译时推移到运行时)，反射是一种很好的选择。可以使用反射动态地创建类型的实例，将类型绑定到现有对象，或从现有对象中获取类型，然后调用其方法或访问其字段和属性。反射为.NET类型提供了高度的动态能力，包括：元数据的动态查询、绑定与执行、动态代码生成。常用的反射类型包含在<code>System.Reflection</code> 和 <code>System.Reflection.Emit</code> ,反射包括程序集反射、类型反射、接口反射、类型成员反射。</p>
<p>反射在以下情况下很有用：</p>
<ul>
<li>需要访问程序元数据中的特性时。</li>
<li>检查和实例化程序集中的类型。</li>
<li>在运行时构建新类型。 使用 <code>System.Reflection.Emit</code> 中的类。</li>
<li>执行后期绑定，访问在运行时创建的类型上的方法。 请参阅主题 Dynamically Loading and Using Types（动态加载和使用类型）。</li>
</ul>
<h2 id="运行时类型标识-RTTI"><a href="#运行时类型标识-RTTI" class="headerlink" title="运行时类型标识(RTTI)"></a>运行时类型标识(RTTI)</h2><p>运行时类型信息 (RTTI,Run-Time Type Information) 是一种允许在程序执行过程中确定对象类型的机制。例如使用它能够确切地知道基类引用指向了什么类型对象。运行时类型标识，能预先测试某个强制类型转换操作，能否成功，从而避免无效的强制类型转换异常。</p>
<p>在c#中有三个支持RTTI的关键字：<code>is</code> 、 <code>as</code>  、<code>typeof</code>。</p>
<h3 id="is-运算符"><a href="#is-运算符" class="headerlink" title="is 运算符"></a>is 运算符</h3><p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/keywords/is">is（C# 参考）</a></p>
<p>能够判断对象类型是否为特定类型，如果两种类型是相同类型，或者两者之间存在引用，装箱拆箱转换，则表明两种类型是兼容的。或（从 C# 7.0 开始）针对某个模式测试表达式。</p>
<h4 id="类型兼容性测试"><a href="#类型兼容性测试" class="headerlink" title="类型兼容性测试"></a>类型兼容性测试</h4><p>语法：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">expr <span class="keyword">is</span> type</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">if</span> (<span class="params">obj <span class="keyword">is</span> Person</span>)</span> &#123;</span><br><span class="line">   <span class="comment">// Do something if obj is a Person.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">double</span> number1 = <span class="number">12.63</span>;</span><br><span class="line"><span class="keyword">if</span> (Math.Ceiling(number1) <span class="keyword">is</span> <span class="built_in">double</span>)</span><br><span class="line">Console.WriteLine(<span class="string">&quot;The expression returns a double.&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>expr 是计算结果为某个类型的实例的表达式，而 type 是 expr 结果要转换到的类型的名称。<br>expr 可以是返回值的任何表达式，匿名方法和 Lambda 表达式除外。</p>
<p>如果满足以下条件，则 <code>is</code> 语句为 true：</p>
<ul>
<li>expr 是与 type 具有相同类型的一个实例。</li>
<li>expr 是派生自 type 的类型的一个实例。 换言之，expr 结果可以向上转换为 type 的一个实例。</li>
<li>expr 具有属于 type 的一个基类的编译时类型，expr 还具有属于 type 或派生自 type 的运行时类型。 变量的编译时类型是其声明中定义的变量类型。 变量的运行时类型是分配给该变量的实例类型。</li>
<li>expr 是实现 type 接口的类型的一个实例。</li>
</ul>
<h4 id="利用-is-的模式匹配"><a href="#利用-is-的模式匹配" class="headerlink" title="利用 is 的模式匹配"></a>利用 is 的模式匹配</h4><p>从 C# 7.0 开始，<code>is</code> 和 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/keywords/switch">switch</a> 语句支持模式匹配。</p>
<p>** 类型模式**</p>
<p>用于测试表达式是否可转换为指定类型，如果可以，则将其转换为该类型的一个变量。</p>
<p>语法：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expr <span class="keyword">is</span> type varname</span><br></pre></td></tr></table></figure>

<p>如果 expr 为 true，且 <code>is</code> 与 <code>if</code> 语句一起使用，则会分配 varname，并且其仅在 <code>if</code> 语句中具有局部范围。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (o <span class="keyword">is</span> Employee e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> Name.CompareTo(e.Name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>** 常量模式**</p>
<p>使用常量模式执行模式匹配时，<code>is</code> 会测试表达式结果是否等于指定常量。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expr <span class="keyword">is</span> constant</span><br></pre></td></tr></table></figure>

<p>其中 expr 是要计算的表达式，constant 是要测试的值。 constant 可以是以下任何常数表达式：</p>
<ul>
<li>一个文本值。</li>
<li>已声明 const 变量的名称。</li>
<li>一个枚举常量。</li>
</ul>
<p>常数表达式的计算方式如下：</p>
<ul>
<li>如果 expr 和 constant 均为整型类型，则 C# 相等运算符确定表示式是否返回 true（即，是否为 <code>expr == constant</code>）。</li>
<li>否则，由对静态 <code>Object.Equals(expr, constant)</code> 方法的调用来确定表达式的值。</li>
</ul>
<p><code>is</code> 语句支持 null 关键字。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">expr <span class="keyword">is</span> <span class="literal">null</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">if</span> (<span class="params">o <span class="keyword">is</span> <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>** var 模式**</p>
<p>具有 var 模式的模式匹配始终成功。 语法为</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expr <span class="keyword">is</span> <span class="keyword">var</span> varname</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> items) &#123;</span><br><span class="line">    <span class="keyword">if</span> (item <span class="keyword">is</span> <span class="keyword">var</span> obj)</span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;Type: <span class="subst">&#123;obj.GetType().Name&#125;</span>, Value: <span class="subst">&#123;obj&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请注意，如果 expr 为 null，则 is 表达式仍为 true 并向 varname 分配 null。</p>
<h3 id="as-运算符"><a href="#as-运算符" class="headerlink" title="as 运算符"></a>as 运算符</h3><p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/keywords/as">as（C# 参考）</a></p>
<p>在运行期间执行类型转换，并且能够使得类型转换失败不抛异常，而返回一个null值。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expression <span class="keyword">as</span> type  </span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Base b = d <span class="keyword">as</span> Base;</span><br><span class="line"><span class="keyword">if</span> (b != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(b.ToString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="typeof运算符"><a href="#typeof运算符" class="headerlink" title="typeof运算符"></a>typeof运算符</h3><p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/keywords/typeof">typeof（C# 参考）</a></p>
<p>获取类型的System.Type 对象。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.Type type = <span class="keyword">typeof</span>(<span class="built_in">int</span>);</span><br></pre></td></tr></table></figure>

<p>获取表达式的运行时类型:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> i = <span class="number">0</span>;</span><br><span class="line">System.Type type = i.GetType();</span><br></pre></td></tr></table></figure>

<p>示例显示如何确定方法的返回类型是否为泛型 <code>IEnumerable&lt;T&gt;</code>。 如果返回类型不是 <code>IEnumerable&lt;T&gt;</code> 泛型类型，则 <code>Type.GetInterface</code> 将返回 <code>null</code>。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MethodInfo method = <span class="keyword">typeof</span>(<span class="built_in">string</span>).GetMethod(<span class="string">&quot;Copy&quot;</span>);</span><br><span class="line">Type t = method.ReturnType.GetInterface(<span class="keyword">typeof</span>(IEnumerable&lt;&gt;).Name);</span><br><span class="line"><span class="keyword">if</span> (t != <span class="literal">null</span>)</span><br><span class="line">    Console.WriteLine(t);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;The return type is not IEnumerable&lt;T&gt;.&quot;</span>);</span><br><span class="line"></span><br><span class="line">Console.ReadKey();</span><br></pre></td></tr></table></figure>

<h2 id="查看类型信息"><a href="#查看类型信息" class="headerlink" title="查看类型信息"></a>查看类型信息</h2><p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/viewing-type-information">查看类型信息</a></p>
<h3 id="模块和程序集"><a href="#模块和程序集" class="headerlink" title="模块和程序集"></a>模块和程序集</h3><p>模块是程序集中代码的逻辑集合。您可以在程序集内部拥有多个模块，并且每个模块都可以使用不同的.NET语言编写（VS不支持创建多模块程序集）。</p>
<p><font color=#ff0000 size=4 face="黑体">程序集包含模块。模块包含类。类包含函数。</font></p>
<p><code>System.Type</code> 类是反射的中心。 当反射提出请求时，公共语言运行时为已加载的类型创建 Type。 可使用 Type 对象的方法、字段、属性和嵌套类来查找该类型的任何信息。</p>
<p><code>Type</code> 类派生于 <code>System.Reflection.MemberInfo</code> 抽象类。</p>
<p>获取程序集的 <code>Assembly</code> 对象和模块:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Assembly a = <span class="keyword">typeof</span>(<span class="built_in">object</span>).Module.Assembly;</span><br></pre></td></tr></table></figure>

<h3 id="Type-GetTypes"><a href="#Type-GetTypes" class="headerlink" title="Type.GetTypes()"></a>Type.GetTypes()</h3><p>从已加载的程序集获取 Type 对象:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Loads an assembly using its file name.</span></span><br><span class="line">Assembly a = Assembly.LoadFrom(<span class="string">&quot;MyExe.exe&quot;</span>);</span><br><span class="line"><span class="comment">// Gets the type names from the assembly.</span></span><br><span class="line">Type[] types2 = a.GetTypes();</span><br><span class="line"><span class="keyword">foreach</span> (Type t <span class="keyword">in</span> types2)</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(t.FullName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>Type.Module</code> 属性获取一个封装含该类型的模块的对象。 使用 <code>Module.Assembly</code> 属性查找一个封装含该模块的程序集的对象。 可以获取直接使用 <code>Type.Assembly</code> 属性封装类型的程序集。</p>
<h3 id="Type-GetMembers"><a href="#Type-GetMembers" class="headerlink" title="Type.GetMembers()"></a>Type.GetMembers()</h3><p>至少要有Instance（或Static）与Public（或NonPublic）标记。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Type.GetMembers() <span class="comment">// 获取所有公共成员。不包括 private 和 protected 访问权限</span></span><br><span class="line">Type.GetMembers(BindingFlags.NonPublic | BindingFlags.Instance | BindingFlags.Public | BindingFlags.DeclaredOnly | BindingFlags.Static) <span class="comment">// 包含非公开;包含实例成员;包含公开;只包含本类声明的成员，不考虑继承的成员;包含静态成员。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Type.GetFields() <span class="comment">// 获取字段</span></span><br><span class="line">Type.GetProperties() <span class="comment">// 获取属性</span></span><br><span class="line">Type.GetEvents() <span class="comment">// 获取事件</span></span><br><span class="line">Type.GetMethods() <span class="comment">// 获取方法</span></span><br></pre></td></tr></table></figure>

<h3 id="Type-ConstructorInfo"><a href="#Type-ConstructorInfo" class="headerlink" title="Type.ConstructorInfo()"></a>Type.ConstructorInfo()</h3><p>列出类的构造函数</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Type t = <span class="keyword">typeof</span>(System.String);</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;Listing all the public constructors of the &#123;0&#125; type&quot;</span>, t);</span><br><span class="line">    <span class="comment">// Constructors.</span></span><br><span class="line">    ConstructorInfo[] ci = t.GetConstructors(BindingFlags.Public | BindingFlags.Instance);</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;//Constructors&quot;</span>);</span><br><span class="line">    PrintMembers(ci);</span><br><span class="line"></span><br><span class="line">    Console.ReadKey();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">PrintMembers</span>(<span class="params">MemberInfo[] ms</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (MemberInfo m <span class="keyword">in</span> ms)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;&#123;0&#125;&#123;1&#125;&quot;</span>, <span class="string">&quot;     &quot;</span>, m);</span><br><span class="line">    &#125;</span><br><span class="line">    Console.WriteLine();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="反射类型和泛型类型"><a href="#反射类型和泛型类型" class="headerlink" title="反射类型和泛型类型"></a>反射类型和泛型类型</h2><p>从反射的角度来说，泛型类型和普通类型之间的区别在于泛型类型具有与之关联的一组类型形参（若是泛型类型定义）或类型实参（若是构造类型）。</p>
<h3 id="泛型类型和泛型方法"><a href="#泛型类型和泛型方法" class="headerlink" title="泛型类型和泛型方法"></a>泛型类型和泛型方法</h3><p>检查未知类型（由 Type的实例表示），使用 <code>IsGenericType</code> 属性来确定未知类型是否为泛型。如果类型是泛型，它会返回 true 。<br>检查未知方法（由 MethodInfo 类的实例表示）时，请使用 <code>IsGenericMethod</code> 属性来确定此方法是否为泛型。</p>
<h3 id="泛型类型定义和泛型方法定义"><a href="#泛型类型定义和泛型方法定义" class="headerlink" title="泛型类型定义和泛型方法定义"></a>泛型类型定义和泛型方法定义</h3><p>使用 <code>IsGenericTypeDefinition</code> 属性来确定 <code>Type</code> 对象是否表示泛型类型定义，并使用 <code>IsGenericMethodDefinition</code> 方法来确定 <code>MethodInfo</code> 是否表示泛型方法定义。</p>
<p>详细请参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.type.isgenerictypedefinition?view=netframework-4.7.2">Type.IsGenericTypeDefinition Property</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.type.getgenerictypedefinition?view=netframework-4.7.2">Type.GetGenericTypeDefinition Method</a></p>
<h3 id="类型或方法是开放式还是封闭式"><a href="#类型或方法是开放式还是封闭式" class="headerlink" title="类型或方法是开放式还是封闭式"></a>类型或方法是开放式还是封闭式</h3><ul>
<li>开放类型：具有泛型类型参数的类型</li>
<li>封闭类型：为所有类型参数都传递了实际的数据类型</li>
</ul>
<p>如果类型为开放式， <code>Type.ContainsGenericParameters</code> 属性将返回 true 。 对于方法， <code>MethodBase.ContainsGenericParameters</code> 方法执行相同的功能。</p>
<h3 id="生成封闭式泛型类型"><a href="#生成封闭式泛型类型" class="headerlink" title="生成封闭式泛型类型"></a>生成封闭式泛型类型</h3><p><code>MakeGenericType</code> 方法来创建封闭式泛型类型;<br><code>MakeGenericMethod</code> 方法来为封闭式泛型方法创建 <code>MethodInfo</code>;</p>
<p>开放式泛型类型或方法（非泛型类型或方法定义），不能创建它的实例，也不能提供缺少的类型形参。</p>
<p><code>GetGenericTypeDefinition</code> 方法来获取泛型类型定义;<br><code>GetGenericMethodDefinition</code> 方法来获取泛型方法定义。</p>
<p>例如，如果你有一个表示 <code>Type</code> 的 <code>Dictionary&lt;int, string&gt;</code> 对象且想创建类型 <code>Dictionary&lt;string, MyClass&gt;</code>，则可以使用 <code>GetGenericTypeDefinition</code> 方法来获取表示 <code>Type</code> 的 <code>Dictionary&lt;TKey, TValue&gt;</code> ，然后使用 <code>MakeGenericType</code> 方法来生成表示 <code>Type</code> 的 <code>Dictionary&lt;int, MyClass&gt;</code>。</p>
<h3 id="检查类型实参和类型形参"><a href="#检查类型实参和类型形参" class="headerlink" title="检查类型实参和类型形参"></a>检查类型实参和类型形参</h3><p><code>Type.GetGenericArguments</code> 方法来获取 <code>Type</code> 对象的数组（表示泛型类型的类型形参或类型实参）; <code>MethodInfo.GetGenericArguments</code> 方法为泛型方法获取 <code>MethodInfo</code>（表示泛型类型的类型形参或类型实参）。如果元素是类型形参，则 <code>IsGenericParameter</code> 属性为 <code>true</code> 。</p>
<h2 id="如何使用反射"><a href="#如何使用反射" class="headerlink" title="如何使用反射"></a>如何使用反射</h2><p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/how-to-examine-and-instantiate-generic-types-with-reflection">如何：使用反射检查和实例化泛型类型</a></p>
<p>获取泛型类型信息的方式与获取其他类型信息的方式相同：检查表示泛型类型的 Type 对象。 主要的差异在于，泛型类型具有表示其泛型类型参数的 Type 对象列表。</p>
<h3 id="检查泛型类型和类型参数"><a href="#检查泛型类型和类型参数" class="headerlink" title="检查泛型类型和类型参数"></a>检查泛型类型和类型参数</h3><p>范例：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1,获取表示泛型类型的 Type 实例</span></span><br><span class="line">    Type t = <span class="keyword">typeof</span>(Dictionary&lt;,&gt;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2, 使用 IsGenericType 属性确定类型是否为泛型，</span></span><br><span class="line">    <span class="comment">// 然后使用 IsGenericTypeDefinition 属性确定类型是否为泛型类型定义。</span></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;   Is this a generic type? &#123;0&#125;&quot;</span>,</span><br><span class="line">        t.IsGenericType);</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;   Is this a generic type definition? &#123;0&#125;&quot;</span>,</span><br><span class="line">        t.IsGenericTypeDefinition);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3,使用 GetGenericArguments 方法获取包含泛型类型参数的数组。</span></span><br><span class="line">    Type[] typeParameters = t.GetGenericArguments();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4,使用 IsGenericParameter 属性确定它是类型形参（例如，在泛型类型定义中），</span></span><br><span class="line">    <span class="comment">// 还是为类型形参指定的类型（例如，在构造类型中）</span></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;   List &#123;0&#125; type arguments:&quot;</span>,</span><br><span class="line">        typeParameters.Length);</span><br><span class="line">    <span class="keyword">foreach</span> (Type tParam <span class="keyword">in</span> typeParameters)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (tParam.IsGenericParameter)</span><br><span class="line">        &#123;</span><br><span class="line">            DisplayGenericParameter(tParam);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;      Type argument: &#123;0&#125;&quot;</span>,</span><br><span class="line">                tParam);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Console.ReadKey();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DisplayGenericParameter</span>(<span class="params">Type tp</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 5,表示泛型类型参数的 Type 对象的名称和参数位置。</span></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;      Type parameter: &#123;0&#125; position &#123;1&#125;&quot;</span>,</span><br><span class="line">        tp.Name, tp.GenericParameterPosition);</span><br><span class="line"></span><br><span class="line">    Type classConstraint = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6,GetGenericParameterConstraints 方法获取单个数组中的所有约束，</span></span><br><span class="line">    <span class="comment">// 确定泛型类型参数的基类型约束和接口约束。无序</span></span><br><span class="line">    <span class="keyword">foreach</span> (Type iConstraint <span class="keyword">in</span> tp.GetGenericParameterConstraints())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (iConstraint.IsInterface)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;         Interface constraint: &#123;0&#125;&quot;</span>,</span><br><span class="line">                iConstraint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (classConstraint != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;         Base type constraint: &#123;0&#125;&quot;</span>,</span><br><span class="line">            tp.BaseType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;         Base type constraint: None&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7, GenericParameterAttributes 属性发现类型参数的特殊约束</span></span><br><span class="line">    GenericParameterAttributes sConstraints =</span><br><span class="line">        tp.GenericParameterAttributes &amp;</span><br><span class="line">        GenericParameterAttributes.SpecialConstraintMask;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sConstraints == GenericParameterAttributes.None)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;         No special constraints.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (GenericParameterAttributes.None != (sConstraints &amp;</span><br><span class="line">                                                GenericParameterAttributes.DefaultConstructorConstraint))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;         Must have a parameterless constructor.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (GenericParameterAttributes.None != (sConstraints &amp;</span><br><span class="line">                                                GenericParameterAttributes.ReferenceTypeConstraint))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;         Must be a reference type.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (GenericParameterAttributes.None != (sConstraints &amp;</span><br><span class="line">                                                GenericParameterAttributes.NotNullableValueTypeConstraint))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;         Must be a non-nullable value type.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="构造泛型类型的实例"><a href="#构造泛型类型的实例" class="headerlink" title="构造泛型类型的实例"></a>构造泛型类型的实例</h3><p>需要指定其泛型类型参数的实际类型，否则不能创建泛型类型的实例。使用 <code>MakeGenericType</code>方法。</p>
<p>实例：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Security.Permissions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Define an example interface.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ITestArgument</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define an example base class.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestBase</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define a generic class with one parameter. The parameter</span></span><br><span class="line">    <span class="comment">// has three constraints: It must inherit TestBase, it must</span></span><br><span class="line">    <span class="comment">// implement ITestArgument, and it must have a parameterless</span></span><br><span class="line">    <span class="comment">// constructor.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Test</span>&lt;<span class="title">T</span>&gt; <span class="keyword">where</span> <span class="title">T</span> : <span class="title">TestBase</span>, <span class="title">ITestArgument</span>, <span class="title">new</span>() &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define a class that meets the constraints on the type</span></span><br><span class="line">    <span class="comment">// parameter of class Test.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestArgument</span> : <span class="title">TestBase</span>, <span class="title">ITestArgument</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestArgument</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Example</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// The following method displays information about a generic</span></span><br><span class="line">        <span class="comment">// type.</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DisplayGenericType</span>(<span class="params">Type t</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;\r\n &#123;0&#125;&quot;</span>, t);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;   Is this a generic type? &#123;0&#125;&quot;</span>,</span><br><span class="line">                t.IsGenericType);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;   Is this a generic type definition? &#123;0&#125;&quot;</span>,</span><br><span class="line">                t.IsGenericTypeDefinition);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get the generic type parameters or type arguments.</span></span><br><span class="line">            Type[] typeParameters = t.GetGenericArguments();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;   List &#123;0&#125; type arguments:&quot;</span>,</span><br><span class="line">                typeParameters.Length);</span><br><span class="line">            <span class="keyword">foreach</span> (Type tParam <span class="keyword">in</span> typeParameters)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (tParam.IsGenericParameter)</span><br><span class="line">                &#123;</span><br><span class="line">                    DisplayGenericParameter(tParam);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;      Type argument: &#123;0&#125;&quot;</span>,</span><br><span class="line">                        tParam);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The following method displays information about a generic</span></span><br><span class="line">        <span class="comment">// type parameter. Generic type parameters are represented by</span></span><br><span class="line">        <span class="comment">// instances of System.Type, just like ordinary types.</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DisplayGenericParameter</span>(<span class="params">Type tp</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;      Type parameter: &#123;0&#125; position &#123;1&#125;&quot;</span>,</span><br><span class="line">                tp.Name, tp.GenericParameterPosition);</span><br><span class="line"></span><br><span class="line">            Type classConstraint = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (Type iConstraint <span class="keyword">in</span> tp.GetGenericParameterConstraints())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (iConstraint.IsInterface)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;         Interface constraint: &#123;0&#125;&quot;</span>,</span><br><span class="line">                        iConstraint);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (classConstraint != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;         Base type constraint: &#123;0&#125;&quot;</span>,</span><br><span class="line">                    tp.BaseType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Console.WriteLine(<span class="string">&quot;         Base type constraint: None&quot;</span>);</span><br><span class="line"></span><br><span class="line">            GenericParameterAttributes sConstraints =</span><br><span class="line">                tp.GenericParameterAttributes &amp;</span><br><span class="line">                GenericParameterAttributes.SpecialConstraintMask;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sConstraints == GenericParameterAttributes.None)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;         No special constraints.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (GenericParameterAttributes.None != (sConstraints &amp;</span><br><span class="line">                    GenericParameterAttributes.DefaultConstructorConstraint))</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;         Must have a parameterless constructor.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (GenericParameterAttributes.None != (sConstraints &amp;</span><br><span class="line">                    GenericParameterAttributes.ReferenceTypeConstraint))</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;         Must be a reference type.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (GenericParameterAttributes.None != (sConstraints &amp;</span><br><span class="line">                    GenericParameterAttributes.NotNullableValueTypeConstraint))</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;         Must be a non-nullable value type.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">PermissionSet(SecurityAction.Demand, Name = <span class="string">&quot;FullTrust&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Two ways to get a Type object that represents the generic</span></span><br><span class="line">            <span class="comment">// type definition of the Dictionary class.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Use the typeof operator to create the generic type</span></span><br><span class="line">            <span class="comment">// definition directly. To specify the generic type definition,</span></span><br><span class="line">            <span class="comment">// omit the type arguments but retain the comma that separates</span></span><br><span class="line">            <span class="comment">// them.</span></span><br><span class="line">            Type d1 = <span class="keyword">typeof</span>(Dictionary&lt;,&gt;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// You can also obtain the generic type definition from a</span></span><br><span class="line">            <span class="comment">// constructed class. In this case, the constructed class</span></span><br><span class="line">            <span class="comment">// is a dictionary of Example objects, with String keys.</span></span><br><span class="line">            Dictionary&lt;<span class="built_in">string</span>, Example&gt; d2 = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, Example&gt;();</span><br><span class="line">            <span class="comment">// Get a Type object that represents the constructed type,</span></span><br><span class="line">            <span class="comment">// and from that get the generic type definition. The</span></span><br><span class="line">            <span class="comment">// variables d1 and d4 contain the same type.</span></span><br><span class="line">            Type d3 = d2.GetType();</span><br><span class="line">            Type d4 = d3.GetGenericTypeDefinition();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Display information for the generic type definition, and</span></span><br><span class="line">            <span class="comment">// for the constructed type Dictionary&lt;String, Example&gt;.</span></span><br><span class="line">            DisplayGenericType(d1);</span><br><span class="line">            DisplayGenericType(d2.GetType());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Construct an array of type arguments to substitute for</span></span><br><span class="line">            <span class="comment">// the type parameters of the generic Dictionary class.</span></span><br><span class="line">            <span class="comment">// The array must contain the correct number of types, in</span></span><br><span class="line">            <span class="comment">// the same order that they appear in the type parameter</span></span><br><span class="line">            <span class="comment">// list of Dictionary. The key (first type parameter)</span></span><br><span class="line">            <span class="comment">// is of type string, and the type to be contained in the</span></span><br><span class="line">            <span class="comment">// dictionary is Example.</span></span><br><span class="line">            Type[] typeArgs = &#123; <span class="keyword">typeof</span>(<span class="built_in">string</span>), <span class="keyword">typeof</span>(Example) &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Construct the type Dictionary&lt;String, Example&gt;.</span></span><br><span class="line">            Type constructed = d1.MakeGenericType(typeArgs);</span><br><span class="line"></span><br><span class="line">            DisplayGenericType(constructed);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">object</span> o = Activator.CreateInstance(constructed);</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;\r\nCompare types obtained by different methods:&quot;</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;   Are the constructed types equal? &#123;0&#125;&quot;</span>,</span><br><span class="line">                (d2.GetType() == constructed));</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;   Are the generic definitions equal? &#123;0&#125;&quot;</span>,</span><br><span class="line">                (d1 == constructed.GetGenericTypeDefinition()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Demonstrate the DisplayGenericType and</span></span><br><span class="line">            <span class="comment">// DisplayGenericParameter methods with the Test class</span></span><br><span class="line">            <span class="comment">// defined above. This shows base, interface, and special</span></span><br><span class="line">            <span class="comment">// constraints.</span></span><br><span class="line">            DisplayGenericType(<span class="keyword">typeof</span>(Test&lt;&gt;));</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/reflection">反射 (C#)</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/reflection">.NET Framework 中的反射</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/yaozhenfa/p/CSharp_Reflection_1.html">C#之玩转反射</a></p>
<p><a target="_blank" rel="noopener" href="http://www.codeisbug.com/Ask/11/1041">C#反射用法，入门到精通</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/10/CSharp%E5%9F%BA%E7%A1%80-SOLID%E5%8E%9F%E5%88%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/10/CSharp%E5%9F%BA%E7%A1%80-SOLID%E5%8E%9F%E5%88%99/" class="post-title-link" itemprop="url">CSharp基础-SOLID原则</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-10 12:04:25" itemprop="dateCreated datePublished" datetime="2019-01-10T12:04:25+00:00">2019-01-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 10:07:23" itemprop="dateModified" datetime="2022-07-10T10:07:23+00:00">2022-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>805</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SOLID原则"><a href="#SOLID原则" class="headerlink" title="SOLID原则"></a>SOLID原则</h1><p>设计类和模块时，遵守 SOLID 原则可以让软件更加健壮和稳定。</p>
<table>
<thead>
<tr>
<th>简写</th>
<th>全称</th>
<th>翻译</th>
</tr>
</thead>
<tbody><tr>
<td>SRP</td>
<td>The Single Responsibility Principle</td>
<td>单一责任原则</td>
</tr>
<tr>
<td>OCP</td>
<td>The Open Closed Principle</td>
<td>开放封闭原则</td>
</tr>
<tr>
<td>LSP</td>
<td>The Liskov Substitution Principle</td>
<td>里氏替换原则</td>
</tr>
<tr>
<td>ISP</td>
<td>The Interface Segregation Principle</td>
<td>接口分离原则</td>
</tr>
<tr>
<td>DIP</td>
<td>The Dependency Inversion Principle</td>
<td>依赖倒置原则</td>
</tr>
</tbody></table>
<h2 id="单一职责原则（SRP）"><a href="#单一职责原则（SRP）" class="headerlink" title="单一职责原则（SRP）"></a>单一职责原则（SRP）</h2><p>单一职责原则（SRP）表明一个类有且只有一个职责。</p>
<h2 id="开放封闭原则（OCP）"><a href="#开放封闭原则（OCP）" class="headerlink" title="开放封闭原则（OCP）"></a>开放封闭原则（OCP）</h2><p>开放封闭原则（OCP）指出，一个类应该对扩展开放，对修改关闭。这意味一旦你创建了一个类并且应用程序的其他部分开始使用它，你不应该修改它。即，可扩展(extension)，不可修改(modification)。</p>
<h2 id="里氏替换原则（LSP）"><a href="#里氏替换原则（LSP）" class="headerlink" title="里氏替换原则（LSP）"></a>里氏替换原则（LSP）</h2><p>里氏替换原则指出，派生的子类应该是可替换基类的，也就是说任何基类可以出现的地方，子类一定可以出现。一个对象在其出现的任何地方，都可以用子类实例做替换，并且不会导致程序的错误。换句话说，当子类可以在任意地方替换基类且软件功能不受影响时，这种继承关系的建模才是合理的。当一个子类的实例应该能够替换任何其超类的实例时，它们之间才具有is-A关系。</p>
<h2 id="接口隔离原则（ISP）"><a href="#接口隔离原则（ISP）" class="headerlink" title="接口隔离原则（ISP）"></a>接口隔离原则（ISP）</h2><p>接口隔离原则（ISP）表明类不应该被迫依赖他们不使用的方法，也就是说一个接口应该拥有尽可能少的行为。将接口拆分成更小和更具体的接口，有助于解耦，从而更容易重构、更改。</p>
<h2 id="依赖倒置原则（DIP）"><a href="#依赖倒置原则（DIP）" class="headerlink" title="依赖倒置原则（DIP）"></a>依赖倒置原则（DIP）</h2><p>依赖倒置原则（DIP）表明高层模块不应该依赖低层模块，相反，他们应该依赖抽象类或者接口。这个设计原则的亮点在于任何被DI框架注入的类很容易用mock对象进行测试和维护，因为对象创建代码集中在框架中，客户端代码也不混乱。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/OceanEyes/p/overview-of-solid-principles.html#_label4">浅谈 SOLID 原则的具体使用</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/lanxuezaipiao/archive/2013/06/09/3128665.html">SOLID原则</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/07/DotNet%E5%9F%BA%E7%A1%80-%E8%87%AA%E5%AE%9A%E4%B9%89LINQ-Provider/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/07/DotNet%E5%9F%BA%E7%A1%80-%E8%87%AA%E5%AE%9A%E4%B9%89LINQ-Provider/" class="post-title-link" itemprop="url">DotNet基础-自定义LINQ Provider</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-07 15:12:23" itemprop="dateCreated datePublished" datetime="2019-01-07T15:12:23+00:00">2019-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 10:07:23" itemprop="dateModified" datetime="2022-07-10T10:07:23+00:00">2022-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LINQ/" itemprop="url" rel="index"><span itemprop="name">LINQ</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="IQueryable和IQueryProvider接口"><a href="#IQueryable和IQueryProvider接口" class="headerlink" title="IQueryable和IQueryProvider接口"></a>IQueryable和IQueryProvider接口</h2><p><code>IQueryable&lt;T&gt;</code> 接口是 <code>Linq to Provider</code>的入口。</p>
<h3 id="IQueryable接口"><a href="#IQueryable接口" class="headerlink" title="IQueryable接口"></a>IQueryable接口</h3><p>在.NET中，<code>IQueryable&lt;T&gt;</code> 继承于 <code>IEnumerable&lt;T&gt;</code> , <code>IEnumerable</code> 和 <code>IQueryable</code> 接口</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IQueryable</span>&lt;<span class="keyword">out</span> <span class="title">T</span>&gt; : <span class="title">IEnumerable</span>&lt;<span class="title">T</span>&gt;, <span class="title">IEnumerable</span>, <span class="title">IQueryable</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IQueryable</span> : <span class="title">IEnumerable</span></span><br><span class="line">&#123;</span><br><span class="line">  Expression Expression &#123; [__DynamicallyInvokable] <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">  Type ElementType &#123; [__DynamicallyInvokable] <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">  IQueryProvider Provider &#123; [__DynamicallyInvokable] <span class="keyword">get</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ElementType ：当前Query所对应的类型</li>
<li>Expression ：获取与 <code>IQueryable</code> 的实例关联的表达式树</li>
<li>Provider：获取与此数据源关联的查询提供程序</li>
</ul>
<p>我们所有定义在查询表达式中方法调用或者Lambda表达式都将由该Expression属性表示，最终会由Provider表示的提供程序翻译为它所对应的数据源的查询语言。</p>
<p><code>IQueryable</code> 扩展方法传入的是 <code>Expression</code> 类型</p>
<h3 id="IEnumerable接口"><a href="#IEnumerable接口" class="headerlink" title="IEnumerable接口"></a>IEnumerable接口</h3><p><code>IEnumrable</code> 扩展方法传入的是委托。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEnumerable</span>&lt;<span class="keyword">out</span> <span class="title">T</span>&gt; : <span class="title">IEnumerable</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">IEnumerator&lt;T&gt; <span class="title">GetEnumerator</span>()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEnumerable</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">IEnumerator <span class="title">GetEnumerator</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="IQueryProvider接口"><a href="#IQueryProvider接口" class="headerlink" title="IQueryProvider接口"></a>IQueryProvider接口</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IQueryProvider</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">IQueryable <span class="title">CreateQuery</span>(<span class="params">Expression expression</span>)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">IQueryable</span>&lt;<span class="title">TElement</span>&gt; <span class="title">CreateQuery</span>&lt;<span class="title">TElement</span>&gt;(<span class="params">Expression expression</span>)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="built_in">object</span> <span class="title">Execute</span>(<span class="params">Expression expression</span>)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">TResult <span class="title">Execute</span>&lt;<span class="title">TResult</span>&gt;(<span class="params">Expression expression</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Provider</code> 负责执行表达式目录树并返回结果。如果是 <code>LINQ to SQL</code> 的 <code>Provider</code> ，则它会负责把表达式目录树翻译为T-SQL语句并并传递给数据库服务器，并返回最后的执行的结果；如果是一个 <code>Web Service</code> 的 <code>Provider</code>，则它会负责翻译表达式目录树并调用 <code>Web Service</code>，最终返回结果。</p>
<h2 id="自定义Provider"><a href="#自定义Provider" class="headerlink" title="自定义Provider"></a>自定义Provider</h2><p>首先，实现一个 <code>Query&lt;T&gt;</code> 类，它实现 <code>IQueryable&lt;T&gt;</code> 接口,提供了一个 <code>IQueryProvider</code> 和 <code>Expression</code> 属性。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Query</span>&lt;<span class="title">T</span>&gt; : <span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt;, <span class="title">IQueryable</span>, <span class="title">IEnumerable</span>&lt;<span class="title">T</span>&gt;, <span class="title">IEnumerable</span>, <span class="title">IOrderedQueryable</span>&lt;<span class="title">T</span>&gt;, <span class="title">IOrderedQueryable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> QueryProvider provider;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> Expression expression;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Query</span>(<span class="params">QueryProvider provider</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.provider = provider ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(provider));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.expression = Expression.Constant(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Query</span>(<span class="params">QueryProvider provider, Expression expression</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (expression == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(expression));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">typeof</span>(IQueryable&lt;T&gt;).IsAssignableFrom(expression.Type))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="keyword">nameof</span>(expression));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.provider = provider ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(provider));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.expression = expression;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Expression IQueryable.Expression =&gt; <span class="keyword">this</span>.expression;</span><br><span class="line"></span><br><span class="line">    Type IQueryable.ElementType =&gt; <span class="keyword">typeof</span>(T);</span><br><span class="line"></span><br><span class="line">    IQueryProvider IQueryable.Provider =&gt; <span class="keyword">this</span>.provider;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IEnumerator&lt;T&gt; <span class="title">GetEnumerator</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ((IEnumerable&lt;T&gt;)<span class="keyword">this</span>.provider.Execute(<span class="keyword">this</span>.expression)).GetEnumerator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IEnumerator IEnumerable.GetEnumerator()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ((IEnumerable)<span class="keyword">this</span>.provider.Execute(<span class="keyword">this</span>.expression)).GetEnumerator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.provider.GetQueryText(<span class="keyword">this</span>.expression);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，定义一个抽象类 <code>QueryProvider</code>，它将会实现 <code>IQueryProvider</code> 接口，包括 <code>CreateQuery</code> 和 <code>Execute</code>方法（都包含泛型方法）。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">QueryProvider</span> : <span class="title">IQueryProvider</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">QueryProvider</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IQueryable&lt;S&gt; IQueryProvider.CreateQuery&lt;S&gt;(Expression expression)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Query&lt;S&gt;(<span class="keyword">this</span>, expression);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IQueryable IQueryProvider.CreateQuery(Expression expression)</span><br><span class="line">    &#123;</span><br><span class="line">        Type elementType = TypeSystem.GetElementType(expression.Type);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (IQueryable)Activator.CreateInstance(<span class="keyword">typeof</span>(Query&lt;&gt;).MakeGenericType(elementType), <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; <span class="keyword">this</span>, expression &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (TargetInvocationException tie)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> tie.InnerException;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    S IQueryProvider.Execute&lt;S&gt;(Expression expression)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> (S)<span class="keyword">this</span>.Execute(expression);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">object</span> IQueryProvider.Execute(Expression expression)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.Execute(expression);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="built_in">string</span> <span class="title">GetQueryText</span>(<span class="params">Expression expression</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="built_in">object</span> <span class="title">Execute</span>(<span class="params">Expression expression</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后定义一个具体 <code>Provider</code>，继承自抽象类 <code>QueryProvider</code>；</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CnblogsQueryProvider</span> : <span class="title">QueryProvider</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> String <span class="title">GetQueryText</span>(<span class="params">Expression expression</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        SearchCriteria criteria;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 翻译查询条件</span></span><br><span class="line">        criteria = <span class="keyword">new</span> PostExpressionVisitor().ProcessExpression(expression);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成URL</span></span><br><span class="line">        String url = PostHelper.BuildUrl(criteria);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">object</span> <span class="title">Execute</span>(<span class="params">Expression expression</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        String url = GetQueryText(expression);</span><br><span class="line">        IEnumerable&lt;Post&gt; results = PostHelper.PerformWebQuery(url);</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> provider = <span class="keyword">new</span> CnblogsQueryProvider();</span><br><span class="line">    <span class="keyword">var</span> queryable = <span class="keyword">new</span> Query&lt;Post&gt;(provider);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> query =</span><br><span class="line">        <span class="keyword">from</span> p <span class="keyword">in</span> queryable</span><br><span class="line">        <span class="keyword">where</span> p.Diggs &gt;= <span class="number">10</span> &amp;&amp;</span><br><span class="line">              p.Comments &gt; <span class="number">10</span> &amp;&amp;</span><br><span class="line">              p.Views &gt; <span class="number">10</span> &amp;&amp;</span><br><span class="line">              p.Comments &lt; <span class="number">20</span></span><br><span class="line">        <span class="keyword">select</span> p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> list = query.ToList();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Console.ReadLine();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>源码：<a target="_blank" rel="noopener" href="https://github.com/syxdevcode/LinqToCnBlogs">https://github.com/syxdevcode/LinqToCnBlogs</a></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/Terrylee/archive/2008/08/25/custom-linq-provider-part-2-IQueryable-IQueryProvider.html">打造自己的LINQ Provider（中）：IQueryable和IQueryProvider</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/jesse2013/p/expressiontree-Linq-to-cnblogs.html">由浅入深表达式树（完结篇）重磅打造 Linq To 博客园</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/Terrylee/archive/2008/08/25/custom-linq-provider-part-2-IQueryable-IQueryProvider.html">打造自己的LINQ Provider（中）：IQueryable和IQueryProvider</a></p>
<p><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/mattwar/2007/07/30/linq-building-an-iqueryable-provider-part-i/">LINQ: Building an IQueryable Provider – Part I</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/04/CSharp%E5%9F%BA%E7%A1%80-%E9%81%8D%E5%8E%86-%E4%BF%AE%E6%94%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/04/CSharp%E5%9F%BA%E7%A1%80-%E9%81%8D%E5%8E%86-%E4%BF%AE%E6%94%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A0%91/" class="post-title-link" itemprop="url">CSharp基础-遍历/修改表达式树</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-04 15:44:45" itemprop="dateCreated datePublished" datetime="2019-01-04T15:44:45+00:00">2019-01-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 10:07:23" itemprop="dateModified" datetime="2022-07-10T10:07:23+00:00">2022-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Expression-Tree/" itemprop="url" rel="index"><span itemprop="name">Expression Tree</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>7.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="遍历-修改表达式树"><a href="#遍历-修改表达式树" class="headerlink" title="遍历/修改表达式树"></a>遍历/修改表达式树</h1><p>可以使用 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.linq.expressions.expressionvisitor?view=netframework-4.7.2">ExpressionVisitor</a> 类遍历现有表达式树，以及复制它访问的每个节点。</p>
<h2 id="表达式的遍历"><a href="#表达式的遍历" class="headerlink" title="表达式的遍历"></a>表达式的遍历</h2><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.linq.expressions.expressiontype?view=netframework-4.7.2">ExpressionType</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.linq.expressions.expression?view=netframework-4.7.2">Expression</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.linq.expressions.expressionvisitor?view=netframework-4.7.2">ExpressionVisitor</a></p>
<table>
<thead>
<tr>
<th>表达式类型</th>
<th>表达式操作节点类型</th>
<th>ExpressionVisitor类访问方法</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.linq.expressions.unaryexpression?view=netframework-4.7.2">UnaryExpression</a></td>
<td>ExpressionType.ArrayLength </br>ExpressionType.ArrayLength </br>ExpressionType.Convert </br>ExpressionType.ConvertChecked </br>ExpressionType.Decrement </br>ExpressionType.Increment </br>ExpressionType.Negate </br>ExpressionType.NegateChecked </br>ExpressionType.Not </br>ExpressionType.NotEqual </br>ExpressionType.Quote </br>ExpressionType.TypeAs</td>
<td>VisitUnary(UnaryExpression)</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.linq.expressions.binaryexpression?view=netframework-4.7.2">BinaryExpression</a></td>
<td>ExpressionType.Add</br> ExpressionType.AddAssign</br>ExpressionType.AddAssignChecked</br>ExpressionType.AddChecked</br>ExpressionType.And</br>ExpressionType.AndAlso</br>ExpressionType.AndAssign</br>ExpressionType.ArrayIndex</br>ExpressionType.Assign</br>ExpressionType.Coalesce</br>ExpressionType.Divide</br>ExpressionType.DivideAssign</br>ExpressionType.Equal</br>ExpressionType.GreaterThan</br>ExpressionType.GreaterThanOrEqual</br>ExpressionType.LessThan</br>ExpressionType.LessThanOrEqual</br>ExpressionType.Modulo</br>ExpressionType.ModuloAssign</br>ExpressionType.Multiply</br>ExpressionType.MultiplyAssign</br>ExpressionType.NotEqual</br>ExpressionType.Or</br>ExpressionType.OrElse</br>ExpressionType.Subtract</td>
<td>VisitBinary(BinaryExpression)</td>
</tr>
<tr>
<td>BlockExpression</td>
<td>ExpressionType.Block</td>
<td>VisitBlock(BlockExpression)</td>
</tr>
<tr>
<td>ConditionalExpression</td>
<td>ExpressionType.Conditional</td>
<td>VisitConditional(ConditionalExpression)</td>
</tr>
<tr>
<td>ConstantExpression</td>
<td>ExpressionType.Constant</td>
<td>VisitConstant(ConstantExpression)</td>
</tr>
<tr>
<td>ParameterExpression</td>
<td>ExpressionType.Parameter</td>
<td>VisitParameter(ParameterExpression)</td>
</tr>
<tr>
<td>MemberExpression</td>
<td>ExpressionType.MemberAccess</td>
<td>VisitMember(MemberExpression)</td>
</tr>
<tr>
<td>MemberInitExpression</td>
<td>ExpressionType.MemberInit</td>
<td>VisitMemberInit(MemberInitExpression)</td>
</tr>
<tr>
<td>MethodCallExpression</td>
<td>ExpressionType.Call</td>
<td>VisitMethodCall(MethodCallExpression)</td>
</tr>
<tr>
<td>LambdaExpression</td>
<td>ExpressionType.Lambda</td>
<td>VisitLambda()</td>
</tr>
<tr>
<td>NewExpression</td>
<td>ExpressionType.New</td>
<td>VisitNew(NewExpression)</td>
</tr>
<tr>
<td>NewArrayExpression</td>
<td>ExpressionType.NewArrayBounds</br>ExpressionType.NewArrayInit</td>
<td>VisitNewArray(NewArrayExpression)</td>
</tr>
<tr>
<td>InvocationExpression</td>
<td>ExpressionType.Invoke</td>
<td>VisitInvocation(InvocationExpression)</td>
</tr>
<tr>
<td>ListInitExpression</td>
<td>ExpressionType.ListInit</td>
<td>VisitListInit(ListInitExpression)</td>
</tr>
<tr>
<td>TypeBinaryExpression</td>
<td>ExpressionType.TypeIs</td>
<td>VisitTypeBinary(TypeBinaryExpression)</td>
</tr>
</tbody></table>
<p>扩展IQueryable的Where方法，根据输入的查询条件来构造SQL语句。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;User&gt; myUsers = <span class="keyword">new</span> List&lt;User&gt;();</span><br><span class="line">        <span class="keyword">var</span> userSql = myUsers.AsQueryable().Where(u =&gt; u.Age &gt; <span class="number">2</span>);</span><br><span class="line">        Console.WriteLine(userSql);</span><br><span class="line">        <span class="comment">// SELECT * FROM (SELECT * FROM User) AS T WHERE (Age&gt;2)</span></span><br><span class="line"></span><br><span class="line">        List&lt;User&gt; myUsers2 = <span class="keyword">new</span> List&lt;User&gt;();</span><br><span class="line">        <span class="keyword">var</span> userSql2 = myUsers2.AsQueryable().Where(u =&gt; u.Name == <span class="string">&quot;QueryExtension&quot;</span>);</span><br><span class="line">        Console.WriteLine(userSql2);</span><br><span class="line">        <span class="comment">//SELECT * FROM (SELECT * FROM USER) AS T WHERE (Name=&#x27;QueryExtension&#x27;)</span></span><br><span class="line"></span><br><span class="line">        Console.ReadKey();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">User</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">QueryExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">Where</span>&lt;<span class="title">TSource</span>&gt;(<span class="params"><span class="keyword">this</span> IQueryable&lt;TSource&gt; source,</span></span></span><br><span class="line"><span class="params"><span class="function">        Expression&lt;Func&lt;TSource, <span class="built_in">bool</span>&gt;&gt; predicate</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> expression = Expression.Call(<span class="literal">null</span>, ((MethodInfo)MethodBase.GetCurrentMethod())</span><br><span class="line">            .MakeGenericMethod(<span class="keyword">new</span> Type[] &#123; <span class="keyword">typeof</span>(TSource) &#125;),</span><br><span class="line">            <span class="keyword">new</span> Expression[] &#123; source.Expression, Expression.Quote(predicate) &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> translator = <span class="keyword">new</span> QueryTranslator();</span><br><span class="line">        <span class="keyword">return</span> translator.Translate(expression);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">QueryTranslator</span> : <span class="title">ExpressionVisitor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> StringBuilder sb;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">internal</span> <span class="built_in">string</span> <span class="title">Translate</span>(<span class="params">Expression expression</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">this</span>.Visit(expression);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sb.ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Expression <span class="title">StripQuotes</span>(<span class="params">Expression e</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (e.NodeType == ExpressionType.Quote)</span><br><span class="line">        &#123;</span><br><span class="line">            e = ((UnaryExpression)e).Operand;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Expression <span class="title">VisitMethodCall</span>(<span class="params">MethodCallExpression m</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m.Method.DeclaringType == <span class="keyword">typeof</span>(QueryExtensions) &amp;&amp; m.Method.Name == <span class="string">&quot;Where&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            sb.Append(<span class="string">&quot;SELECT * FROM (&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>.Visit(m.Arguments[<span class="number">0</span>]);</span><br><span class="line">            sb.Append(<span class="string">&quot;) AS T WHERE &quot;</span>);</span><br><span class="line">            LambdaExpression lambda = (LambdaExpression)StripQuotes(m.Arguments[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">this</span>.Visit(lambda.Body);</span><br><span class="line">            <span class="keyword">return</span> m;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotSupportedException(<span class="built_in">string</span>.Format(<span class="string">&quot;方法&#123;0&#125;不支持&quot;</span>, m.Method.Name));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Expression <span class="title">VisitUnary</span>(<span class="params">UnaryExpression u</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (u.NodeType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> ExpressionType.Not:</span><br><span class="line">                sb.Append(<span class="string">&quot; NOT &quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.Visit(u.Operand);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NotSupportedException(<span class="built_in">string</span>.Format(<span class="string">&quot;运算&#123;0&#125;不支持&quot;</span>, u.NodeType));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Expression <span class="title">VisitBinary</span>(<span class="params">BinaryExpression b</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        sb.Append(<span class="string">&quot;(&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.Visit(b.Left);</span><br><span class="line">        <span class="keyword">switch</span> (b.NodeType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> ExpressionType.And:</span><br><span class="line">                sb.Append(<span class="string">&quot; AND &quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ExpressionType.Or:</span><br><span class="line">                sb.Append(<span class="string">&quot; OR&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ExpressionType.Equal:</span><br><span class="line">                sb.Append(<span class="string">&quot; = &quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ExpressionType.NotEqual:</span><br><span class="line">                sb.Append(<span class="string">&quot; &lt;&gt; &quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ExpressionType.LessThan:</span><br><span class="line">                sb.Append(<span class="string">&quot; &lt; &quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ExpressionType.LessThanOrEqual:</span><br><span class="line">                sb.Append(<span class="string">&quot; &lt;= &quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ExpressionType.GreaterThan:</span><br><span class="line">                sb.Append(<span class="string">&quot; &gt; &quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ExpressionType.GreaterThanOrEqual:</span><br><span class="line">                sb.Append(<span class="string">&quot; &gt;= &quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NotSupportedException(<span class="built_in">string</span>.Format(<span class="string">&quot;运算符&#123;0&#125;不支持&quot;</span>, b.NodeType));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.Visit(b.Right);</span><br><span class="line">        sb.Append(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Expression <span class="title">VisitConstant</span>(<span class="params">ConstantExpression c</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        IQueryable q = c.Value <span class="keyword">as</span> IQueryable;</span><br><span class="line">        <span class="keyword">if</span> (q != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 我们假设我们那个Queryable就是对应的表</span></span><br><span class="line">            sb.Append(<span class="string">&quot;SELECT * FROM &quot;</span>);</span><br><span class="line">            sb.Append(q.ElementType.Name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (c.Value == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            sb.Append(<span class="string">&quot;NULL&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">switch</span> (Type.GetTypeCode(c.Value.GetType()))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> TypeCode.Boolean:</span><br><span class="line">                    sb.Append(((<span class="built_in">bool</span>)c.Value) ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> TypeCode.String:</span><br><span class="line">                    sb.Append(<span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                    sb.Append(c.Value);</span><br><span class="line">                    sb.Append(<span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> TypeCode.Object:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> NotSupportedException(<span class="built_in">string</span>.Format(<span class="string">&quot;常量&#123;0&#125;不支持&quot;</span>, c.Value));</span><br><span class="line">                <span class="literal">default</span>:</span><br><span class="line">                    sb.Append(c.Value);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Expression <span class="title">VisitMember</span>(<span class="params">MemberExpression m</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m.Expression != <span class="literal">null</span> &amp;&amp; m.Expression.NodeType == ExpressionType.Parameter)</span><br><span class="line">        &#123;</span><br><span class="line">            sb.Append(m.Member.Name);</span><br><span class="line">            <span class="keyword">return</span> m;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotSupportedException(<span class="built_in">string</span>.Format(<span class="string">&quot;成员&#123;0&#125;不支持&quot;</span>, m.Member.Name));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="修改表达式树"><a href="#修改表达式树" class="headerlink" title="修改表达式树"></a>修改表达式树</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OperationsVisitor</span> : <span class="title">ExpressionVisitor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Expression <span class="title">Modify</span>(<span class="params">Expression expression</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.Visit(expression);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Expression <span class="title">VisitBinary</span>(<span class="params">BinaryExpression b</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (b.NodeType == ExpressionType.Add)</span><br><span class="line">        &#123;</span><br><span class="line">            Expression left = <span class="keyword">this</span>.Visit(b.Left); <span class="comment">// // 或b.Left</span></span><br><span class="line">            Expression right = <span class="keyword">this</span>.Visit(b.Right); <span class="comment">// 或b.Right</span></span><br><span class="line">            <span class="keyword">return</span> Expression.Subtract(left,right);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">base</span>.VisitBinary(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Expression&lt;Func&lt;<span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>&gt;&gt; lambda = (a, b) =&gt; a + b * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> operationsVisitor = <span class="keyword">new</span> OperationsVisitor();</span><br><span class="line">    Expression modifyExpression = operationsVisitor.Modify(lambda);</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(modifyExpression.ToString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/expression-trees">表达式树</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.linq.expressions.expressionvisitor?view=netframework-4.7.2">ExpressionVisitor</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.linq.expressions?view=netframework-4.7.2">System.Linq.Expressions</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jesse2013/p/expressiontree-part2.html">由浅入深表达式树（二）遍历表达式树</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/01/02/CSharp%E5%9F%BA%E7%A1%80-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/02/CSharp%E5%9F%BA%E7%A1%80-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A0%91/" class="post-title-link" itemprop="url">CSharp基础-表达式树</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-02 16:21:12" itemprop="dateCreated datePublished" datetime="2019-01-02T16:21:12+00:00">2019-01-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 10:07:23" itemprop="dateModified" datetime="2022-07-10T10:07:23+00:00">2022-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Expression-Tree/" itemprop="url" rel="index"><span itemprop="name">Expression Tree</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CSharp基础-表达式树"><a href="#CSharp基础-表达式树" class="headerlink" title="CSharp基础-表达式树"></a>CSharp基础-表达式树</h1><p>表达式树(Expression Tree)是.NET 3.5推出的。<br><font color=#ff0000 size=4 face="黑体">表达式树以树形数据结构表示代码，其中每一个节点都是一种表达式，比如方法调用和 x &lt; y 这样的二元运算等。</font></p>
<p>表达式树还能用于动态语言运行时 (DLR) 以提供动态语言和 .NET Framework 之间的互操作性，同时保证编译器编写员能够发射表达式树而非 Microsoft 中间语言 (MSIL)。</p>
<h2 id="Expressions-类"><a href="#Expressions-类" class="headerlink" title="Expressions 类"></a>Expressions 类</h2><p><code>System.Linq.Expressions</code> 命名空间包含一些类、接口和枚举，它们使语言级别的代码表达式能够表示为表达式目录树形式的对象。</p>
<table>
<thead>
<tr>
<th>类</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>BinaryExpression</td>
<td>表示具有二进制运算符的表达式。</td>
</tr>
<tr>
<td>UnaryExpression</td>
<td>表示具有一元运算符的表达式。</td>
</tr>
<tr>
<td>BlockExpression</td>
<td>表示包含一个表达式序列的块，表达式中可定义变量。</td>
</tr>
<tr>
<td>CatchBlock</td>
<td>表示 try 块中的 catch 语句。</td>
</tr>
<tr>
<td>ConditionalExpression</td>
<td>表示包含条件运算符的表达式。</td>
</tr>
<tr>
<td>ConstantExpression</td>
<td>表示具有常量值的表达式。</td>
</tr>
<tr>
<td>GotoExpression</td>
<td>表示无条件跳转。 这包括返回语句，break 和 continue 语句以及其他跳转。</td>
</tr>
<tr>
<td>IndexExpression</td>
<td>表示对一个属性或数组进行索引。</td>
</tr>
<tr>
<td>LabelTarget</td>
<td>用于表示 GotoExpression 的目标。</td>
</tr>
<tr>
<td>LambdaExpression</td>
<td>介绍 lambda 表达式。 它捕获一个类似于 .NET 方法主体的代码块。</td>
</tr>
<tr>
<td>ListInitExpression</td>
<td>表示具有集合初始值设定项的构造函数调用。</td>
</tr>
<tr>
<td>LoopExpression</td>
<td>表示无限循环。 可通过“中断”退出该循环。</td>
</tr>
<tr>
<td>MemberAssignment</td>
<td>表示对象的字段或属性的赋值操作。</td>
</tr>
<tr>
<td>MemberBinding</td>
<td>提供表示绑定的类派生自的基类，这些绑定用于对新创建对象的成员进行初始化。</td>
</tr>
<tr>
<td>MemberExpression</td>
<td>表示访问字段或属性。</td>
</tr>
<tr>
<td>MemberInitExpression</td>
<td>表示调用构造函数并初始化新对象的一个或多个成员。</td>
</tr>
<tr>
<td>MemberListBinding</td>
<td>表示初始化新创建对象的一个集合成员的元素。</td>
</tr>
<tr>
<td>MemberMemberBinding</td>
<td>表示初始化新创建对象的一个成员的成员。</td>
</tr>
<tr>
<td>MethodCallExpression</td>
<td>表示对静态方法或实例方法的调用。</td>
</tr>
<tr>
<td>NewArrayExpression</td>
<td>表示创建一个新数组，并可能初始化该新数组的元素。</td>
</tr>
<tr>
<td>NewExpression</td>
<td>表示一个构造函数调用。</td>
</tr>
<tr>
<td>ParameterExpression</td>
<td>表示一个命名的参数表达式。</td>
</tr>
<tr>
<td>TryExpression</td>
<td>表示一个 try/catch/finally/fault 块。</td>
</tr>
</tbody></table>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.linq.expressions?view=netframework-4.7.2">System.Linq.Expressions</a></p>
<h2 id="创建表达式树"><a href="#创建表达式树" class="headerlink" title="创建表达式树"></a>创建表达式树</h2><h3 id="Lambda-表达式创建表达式树"><a href="#Lambda-表达式创建表达式树" class="headerlink" title="Lambda 表达式创建表达式树"></a>Lambda 表达式创建表达式树</h3><p>若 lambda 表达式被分配给 <code>Expression&lt;TDelegate&gt;</code> 类型的变量，则编译器可以发射代码以创建表示该 lambda 表达式的表达式树。<br>C# 编译器只能从表达式 Lambda（或单行 Lambda）生成表达式树。 它无法解析语句 lambda （或多行 lambda）。</p>
<p>如：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例展示如何通过 C# 编译器创建表示 Lambda 表达式 num =&gt; num &lt; 5 的表达式树</span></span><br><span class="line">Expression&lt;Func&lt;<span class="built_in">int</span>, <span class="built_in">bool</span>&gt;&gt; lambda = num =&gt; num &lt; <span class="number">5</span>;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面的代码编译不通过</span></span><br><span class="line">Expression&lt;Func&lt;<span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>&gt;&gt; expr2 = (x, y) =&gt; &#123; <span class="keyword">return</span> x + y; &#125;;</span><br><span class="line">Expression&lt;Action&lt;<span class="built_in">int</span>&gt;&gt; expr3 = x =&gt; &#123;  &#125;;</span><br></pre></td></tr></table></figure>

<p><code>Expression&lt;TDelegate&gt;</code> 是直接继承自 <code>LambdaExpression</code>。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">Expression</span>&lt;<span class="title">TDelegate</span>&gt; : <span class="title">LambdaExpression</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">internal</span> <span class="title">Expression</span>(<span class="params">Expression body, <span class="built_in">string</span> name, <span class="built_in">bool</span> tailCall, ReadOnlyCollection&lt;ParameterExpression&gt; parameters</span>) :</span></span><br><span class="line"><span class="function">    <span class="title">base</span>(<span class="params"><span class="keyword">typeof</span>(TDelegate</span>), name, body, tailCall, parameters)</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通过-API-创建表达式树"><a href="#通过-API-创建表达式树" class="headerlink" title="通过 API 创建表达式树"></a>通过 API 创建表达式树</h3><p>通过 API 创建表达式树需要使用 <code>Expression</code> 类。类包含创建特定类型表达式树节点的静态工厂方法，比如表示参数变量的<code> ParameterExpression</code>，或者是表示方法调用的 <code>MethodCallExpression</code>。 <code>ParameterExpression</code> 名称空间还解释了 <code>MethodCallExpression</code>、<code>System.Linq.Expressions</code>和另一种具体表达式类型。 这些类型来源于抽象类型 <code>Expression</code>。</p>
<p>使用 API 创建表示 Lambda 表达式 num =&gt; num &lt; 5 的表达式树:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Linq.Expressions;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Manually build the expression tree for</span></span><br><span class="line"><span class="comment">// the lambda expression num =&gt; num &lt; 5.  </span></span><br><span class="line">ParameterExpression numParam = Expression.Parameter(<span class="keyword">typeof</span>(<span class="built_in">int</span>), <span class="string">&quot;num&quot;</span>);  </span><br><span class="line">ConstantExpression five = Expression.Constant(<span class="number">5</span>, <span class="keyword">typeof</span>(<span class="built_in">int</span>));  </span><br><span class="line">BinaryExpression numLessThanFive = Expression.LessThan(numParam, five);  </span><br><span class="line">Expression&lt;Func&lt;<span class="built_in">int</span>, <span class="built_in">bool</span>&gt;&gt; lambda1 =  </span><br><span class="line">    Expression.Lambda&lt;Func&lt;<span class="built_in">int</span>, <span class="built_in">bool</span>&gt;&gt;(  </span><br><span class="line">        numLessThanFive,  </span><br><span class="line">        <span class="keyword">new</span> ParameterExpression[] &#123; numParam &#125;);  </span><br></pre></td></tr></table></figure>

<p>在 .NET Framework 4 或更高版本中，表达式树 API 还支持赋值表达式和控制流表达式，例如循环、条件块和 <code>try-catch</code> 块等。下列示例展示如何创建计算数字阶乘的表达式树。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Creating a parameter expression.  </span></span><br><span class="line">ParameterExpression <span class="keyword">value</span> = Expression.Parameter(<span class="keyword">typeof</span>(<span class="built_in">int</span>), <span class="string">&quot;value&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Creating an expression to hold a local variable.</span></span><br><span class="line">ParameterExpression result = Expression.Parameter(<span class="keyword">typeof</span>(<span class="built_in">int</span>), <span class="string">&quot;result&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Creating a label to jump to from a loop.  </span></span><br><span class="line">LabelTarget label = Expression.Label(<span class="keyword">typeof</span>(<span class="built_in">int</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Creating a method body.  </span></span><br><span class="line">BlockExpression block = Expression.Block(</span><br><span class="line">    <span class="comment">// Adding a local variable.  </span></span><br><span class="line">    <span class="keyword">new</span>[] &#123; result &#125;,</span><br><span class="line">    <span class="comment">// Assigning a constant to a local variable: result = 1  </span></span><br><span class="line">    Expression.Assign(result, Expression.Constant(<span class="number">1</span>)),</span><br><span class="line">        <span class="comment">// Adding a loop.  </span></span><br><span class="line">        Expression.Loop(</span><br><span class="line">           <span class="comment">// Adding a conditional block into the loop.  </span></span><br><span class="line">           Expression.IfThenElse(</span><br><span class="line">               <span class="comment">// Condition: value &gt; 1  </span></span><br><span class="line">               Expression.GreaterThan(<span class="keyword">value</span>, Expression.Constant(<span class="number">1</span>)),</span><br><span class="line">               <span class="comment">// If true: result *= value --  </span></span><br><span class="line">               Expression.MultiplyAssign(result,</span><br><span class="line">                   Expression.PostDecrementAssign(<span class="keyword">value</span>)),</span><br><span class="line">               <span class="comment">// If false, exit the loop and go to the label.  </span></span><br><span class="line">               Expression.Break(label, result)</span><br><span class="line">           ),</span><br><span class="line">       <span class="comment">// Label to jump to.  </span></span><br><span class="line">       label</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Compile and execute an expression tree.  </span></span><br><span class="line"><span class="built_in">int</span> factorial = Expression.Lambda&lt;Func&lt;<span class="built_in">int</span>, <span class="built_in">int</span>&gt;&gt;(block, <span class="keyword">value</span>).Compile()(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">Console.WriteLine(factorial);</span><br><span class="line"><span class="comment">// Prints 120.</span></span><br></pre></td></tr></table></figure>

<h3 id="解析表达式树"><a href="#解析表达式树" class="headerlink" title="解析表达式树"></a>解析表达式树</h3><p>下列代码示例展示如何分解表示 Lambda 表达式 num =&gt; num &lt; 5 的表达式树。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add the following using directive to your code file:  </span></span><br><span class="line"><span class="comment">// using System.Linq.Expressions;  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// Create an expression tree.  </span></span><br><span class="line">Expression&lt;Func&lt;<span class="built_in">int</span>, <span class="built_in">bool</span>&gt;&gt; exprTree = num =&gt; num &lt; <span class="number">5</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// Decompose the expression tree.  </span></span><br><span class="line">ParameterExpression param = (ParameterExpression)exprTree.Parameters[<span class="number">0</span>];  </span><br><span class="line">BinaryExpression operation = (BinaryExpression)exprTree.Body;  </span><br><span class="line">ParameterExpression left = (ParameterExpression)operation.Left;  </span><br><span class="line">ConstantExpression right = (ConstantExpression)operation.Right;  </span><br><span class="line">  </span><br><span class="line">Console.WriteLine(<span class="string">&quot;Decomposed expression: &#123;0&#125; =&gt; &#123;1&#125; &#123;2&#125; &#123;3&#125;&quot;</span>,  </span><br><span class="line">                  param.Name, left.Name, operation.NodeType, right.Value);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// This code produces the following output:  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// Decomposed expression: num =&gt; num LessThan 5</span></span><br></pre></td></tr></table></figure>

<h3 id="编译表达式树"><a href="#编译表达式树" class="headerlink" title="编译表达式树"></a>编译表达式树</h3><p><code>Expression&lt;TDelegate&gt;</code> 类型提供了 Compile 方法以将表达式树表示的代码编译成可执行委托。</p>
<p>下列代码示例展示如何编译表达式树并运行结果代码。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Creating an expression tree.  </span></span><br><span class="line">Expression&lt;Func&lt;<span class="built_in">int</span>, <span class="built_in">bool</span>&gt;&gt; expr = num =&gt; num &lt; <span class="number">5</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// Compiling the expression tree into a delegate.  </span></span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">bool</span>&gt; result = expr.Compile();  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// Invoking the delegate and writing the result to the console.  </span></span><br><span class="line">Console.WriteLine(result(<span class="number">4</span>));  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// Prints True.  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// You can also use simplified syntax  </span></span><br><span class="line"><span class="comment">// to compile and run an expression tree.  </span></span><br><span class="line"><span class="comment">// The following line can replace two previous statements.  </span></span><br><span class="line">Console.WriteLine(expr.Compile()(<span class="number">4</span>));  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// Also prints True.</span></span><br></pre></td></tr></table></figure>

<h2 id="执行表达式树"><a href="#执行表达式树" class="headerlink" title="执行表达式树"></a>执行表达式树</h2><p>Lambda 表达式的表达式树的类型为 <code>LambdaExpression</code> 或 <code>Expression&lt;TDelegate&gt;</code>。 若要执行这些表达式树，调用 Compile 方法来创建一个可执行的委托，然后调用该委托。</p>
<p>备注：</p>
<p>如果委托的类型未知，也就是说 Lambda 表达式的类型为 <code>LambdaExpression</code>，而不是 <code>Expression&lt;TDelegate&gt;</code>，则必须对委托调用 <code>DynamicInvoke</code> 方法，而不是直接调用委托。如 <code>lambdaExpr.Compile().DynamicInvoke(1)</code>;</p>
<p>下面的代码示例演示如何通过创建 lambda 表达式并执行它来执行代表幂运算的表达式树。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The expression tree to execute.  </span></span><br><span class="line">BinaryExpression be = Expression.Power(Expression.Constant(<span class="number">2</span>D), Expression.Constant(<span class="number">3</span>D));  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// Create a lambda expression.  </span></span><br><span class="line">Expression&lt;Func&lt;<span class="built_in">double</span>&gt;&gt; le = Expression.Lambda&lt;Func&lt;<span class="built_in">double</span>&gt;&gt;(be);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// Compile the lambda expression.  </span></span><br><span class="line">Func&lt;<span class="built_in">double</span>&gt; compiledExpression = le.Compile();  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// Execute the lambda expression.  </span></span><br><span class="line"><span class="built_in">double</span> result = compiledExpression();  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// Display the result.  </span></span><br><span class="line">Console.WriteLine(result);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// This code produces the following output:  </span></span><br><span class="line"><span class="comment">// 8</span></span><br></pre></td></tr></table></figure>

<h2 id="修改表达式树-C"><a href="#修改表达式树-C" class="headerlink" title="修改表达式树 (C#)"></a>修改表达式树 (C#)</h2><p>表达式树是不可变的，这意味着不能直接对它们进行修改。 若要更改表达式树，必须创建现有表达式树的副本，创建此副本后，进行必要的更改。 可以使用 <code>ExpressionVisitor</code> 类遍历现有表达式树，以及复制它访问的每个节点。</p>
<p>运算从条件 <code>AND</code> 更改为条件 <code>OR</code>。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Expression&lt;Func&lt;<span class="built_in">string</span>, <span class="built_in">bool</span>&gt;&gt; expr = name =&gt; name.Length &gt; <span class="number">10</span> &amp;&amp; name.StartsWith(<span class="string">&quot;G&quot;</span>);</span><br><span class="line">    Console.WriteLine(expr);</span><br><span class="line"></span><br><span class="line">    AndAlsoModifier treeModifier = <span class="keyword">new</span> AndAlsoModifier();</span><br><span class="line">    Expression modifiedExpr = treeModifier.Modify((Expression)expr);</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(modifiedExpr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  This code produces the following output:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        name =&gt; ((name.Length &gt; 10) &amp;&amp; name.StartsWith(&quot;G&quot;))</span></span><br><span class="line"><span class="comment">        name =&gt; ((name.Length &gt; 10) || name.StartsWith(&quot;G&quot;))</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    Console.Read();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AndAlsoModifier</span> : <span class="title">ExpressionVisitor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Expression <span class="title">Modify</span>(<span class="params">Expression expression</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Visit(expression);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Expression <span class="title">VisitBinary</span>(<span class="params">BinaryExpression b</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (b.NodeType == ExpressionType.AndAlso)</span><br><span class="line">        &#123;</span><br><span class="line">            Expression left = <span class="keyword">this</span>.Visit(b.Left);</span><br><span class="line">            Expression right = <span class="keyword">this</span>.Visit(b.Right);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Make this binary expression an OrElse operation instead of an AndAlso operation.</span></span><br><span class="line">            <span class="keyword">return</span> Expression.MakeBinary(ExpressionType.OrElse, left, right, b.IsLiftedToNull, b.Method);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">base</span>.VisitBinary(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用表达式树来生成动态查询"><a href="#使用表达式树来生成动态查询" class="headerlink" title="使用表达式树来生成动态查询"></a>使用表达式树来生成动态查询</h2><p>在 LINQ 中，表达式树用于表示针对数据源的结构化查询，这些数据源可实现 <code>IQueryable&lt;T&gt;</code>。 例如，LINQ 提供程序可实现 <code>IQueryable&lt;T&gt;</code> 接口，用于查询关系数据存储。 C# 编译器将针对此类数据源的查询编译为代码，该代码在运行时会生成一个表达式树。 然后，查询提供程序可以遍历表达式树数据结构，并将其转换为适合于数据源的查询语言。</p>
<p>表达式树还可以用在 LINQ 中，用于表示分配给类型为 <code>Expression&lt;TDelegate&gt;</code> 的变量的 lambda 表达式。</p>
<p>下面的示例演示如何使用表达式树依据 <code>IQueryable</code> 数据源构造一个查询，然后执行该查询。 代码将生成一个表达式树来表示以下查询：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">companies.Where(company =&gt; (company.ToLower() == <span class="string">&quot;coho winery&quot;</span> || company.Length &gt; <span class="number">16</span>)).OrderBy(company =&gt; company)</span><br></pre></td></tr></table></figure>

<p><code>System.Linq.Expressions</code> 命名空间中的工厂方法用于创建表达式树，这些表达式树表示构成总体查询的表达式。 表示标准查询运算符方法调用的表达式将引用这些方法的 <code>Queryable</code> 实现。 最终的表达式树将传递给 <code>IQueryable</code> 数据源的提供程序的 <code>CreateQuery&lt;TElement&gt;(Expression)</code> 实现，以创建 <code>IQueryable</code> 类型的可执行查询。 通过枚举该查询变量获得结果。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add a using directive for System.Linq.Expressions.</span></span><br><span class="line"><span class="built_in">string</span>[] companies = &#123; <span class="string">&quot;Consolidated Messenger&quot;</span>, <span class="string">&quot;Alpine Ski House&quot;</span>, <span class="string">&quot;Southridge Video&quot;</span>, <span class="string">&quot;City Power &amp; Light&quot;</span>,</span><br><span class="line">       <span class="string">&quot;Coho Winery&quot;</span>, <span class="string">&quot;Wide World Importers&quot;</span>, <span class="string">&quot;Graphic Design Institute&quot;</span>, <span class="string">&quot;Adventure Works&quot;</span>,</span><br><span class="line">       <span class="string">&quot;Humongous Insurance&quot;</span>, <span class="string">&quot;Woodgrove Bank&quot;</span>, <span class="string">&quot;Margie&#x27;s Travel&quot;</span>, <span class="string">&quot;Northwind Traders&quot;</span>,</span><br><span class="line">       <span class="string">&quot;Blue Yonder Airlines&quot;</span>, <span class="string">&quot;Trey Research&quot;</span>, <span class="string">&quot;The Phone Company&quot;</span>,</span><br><span class="line">       <span class="string">&quot;Wingtip Toys&quot;</span>, <span class="string">&quot;Lucerne Publishing&quot;</span>, <span class="string">&quot;Fourth Coffee&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The IQueryable data to query.</span></span><br><span class="line">IQueryable&lt;String&gt; queryableData = companies.AsQueryable&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Compose the expression tree that represents the parameter to the predicate.</span></span><br><span class="line">ParameterExpression pe = Expression.Parameter(<span class="keyword">typeof</span>(<span class="built_in">string</span>), <span class="string">&quot;company&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ***** Where(company =&gt; (company.ToLower() == &quot;coho winery&quot; || company.Length &gt; 16)) *****</span></span><br><span class="line"><span class="comment">// Create an expression tree that represents the expression &#x27;company.ToLower() == &quot;coho winery&quot;&#x27;.</span></span><br><span class="line">Expression left = Expression.Call(pe, <span class="keyword">typeof</span>(<span class="built_in">string</span>).GetMethod(<span class="string">&quot;ToLower&quot;</span>, System.Type.EmptyTypes));</span><br><span class="line">Expression right = Expression.Constant(<span class="string">&quot;coho winery&quot;</span>);</span><br><span class="line">Expression e1 = Expression.Equal(left, right);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an expression tree that represents the expression &#x27;company.Length &gt; 16&#x27;.</span></span><br><span class="line">left = Expression.Property(pe, <span class="keyword">typeof</span>(<span class="built_in">string</span>).GetProperty(<span class="string">&quot;Length&quot;</span>));</span><br><span class="line">right = Expression.Constant(<span class="number">16</span>, <span class="keyword">typeof</span>(<span class="built_in">int</span>));</span><br><span class="line">Expression e2 = Expression.GreaterThan(left, right);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Combine the expression trees to create an expression tree that represents the</span></span><br><span class="line"><span class="comment">// expression &#x27;(company.ToLower() == &quot;coho winery&quot; || company.Length &gt; 16)&#x27;.</span></span><br><span class="line">Expression predicateBody = Expression.OrElse(e1, e2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an expression tree that represents the expression</span></span><br><span class="line"><span class="comment">// &#x27;queryableData.Where(company =&gt; (company.ToLower() == &quot;coho winery&quot; || company.Length &gt; 16))&#x27;</span></span><br><span class="line">MethodCallExpression whereCallExpression = Expression.Call(</span><br><span class="line">    <span class="keyword">typeof</span>(Queryable),</span><br><span class="line">    <span class="string">&quot;Where&quot;</span>,</span><br><span class="line">    <span class="keyword">new</span> Type[] &#123; queryableData.ElementType &#125;,</span><br><span class="line">    queryableData.Expression,</span><br><span class="line">    Expression.Lambda&lt;Func&lt;<span class="built_in">string</span>, <span class="built_in">bool</span>&gt;&gt;(predicateBody, <span class="keyword">new</span> ParameterExpression[] &#123; pe &#125;));</span><br><span class="line"><span class="comment">// ***** End Where *****</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ***** OrderBy(company =&gt; company) *****</span></span><br><span class="line"><span class="comment">// Create an expression tree that represents the expression</span></span><br><span class="line"><span class="comment">// &#x27;whereCallExpression.OrderBy(company =&gt; company)&#x27;</span></span><br><span class="line">MethodCallExpression orderByCallExpression = Expression.Call(</span><br><span class="line">    <span class="keyword">typeof</span>(Queryable),</span><br><span class="line">    <span class="string">&quot;OrderBy&quot;</span>,</span><br><span class="line">    <span class="keyword">new</span> Type[] &#123; queryableData.ElementType, queryableData.ElementType &#125;,</span><br><span class="line">    whereCallExpression,</span><br><span class="line">    Expression.Lambda&lt;Func&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;&gt;(pe, <span class="keyword">new</span> ParameterExpression[] &#123; pe &#125;));</span><br><span class="line"><span class="comment">// ***** End OrderBy *****</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an executable query from the expression tree.</span></span><br><span class="line">IQueryable&lt;<span class="built_in">string</span>&gt; results = queryableData.Provider.CreateQuery&lt;<span class="built_in">string</span>&gt;(orderByCallExpression);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Enumerate the results.</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="built_in">string</span> company <span class="keyword">in</span> results)</span><br><span class="line">    Console.WriteLine(company);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  This code produces the following output:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Blue Yonder Airlines</span></span><br><span class="line"><span class="comment">    City Power &amp; Light</span></span><br><span class="line"><span class="comment">    Coho Winery</span></span><br><span class="line"><span class="comment">    Consolidated Messenger</span></span><br><span class="line"><span class="comment">    Graphic Design Institute</span></span><br><span class="line"><span class="comment">    Humongous Insurance</span></span><br><span class="line"><span class="comment">    Lucerne Publishing</span></span><br><span class="line"><span class="comment">    Northwind Traders</span></span><br><span class="line"><span class="comment">    The Phone Company</span></span><br><span class="line"><span class="comment">    Wide World Importers</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="在-Visual-Studio-中调试表达式树"><a href="#在-Visual-Studio-中调试表达式树" class="headerlink" title="在 Visual Studio 中调试表达式树"></a>在 Visual Studio 中调试表达式树</h2><p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/expression-trees/debugging-expression-trees-in-visual-studio">在 Visual Studio 中调试表达式树</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.linq.expressions?view=netframework-4.7.2">System.Linq.Expressions</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/expression-trees/">表达式树 (C#)</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/jesse2013/p/expressiontree-part1.html">由浅入深表达式树（一）创建表达式树</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/12/29/CSharp%E5%9F%BA%E7%A1%80-LINQ%E6%A0%87%E5%87%86%E6%9F%A5%E8%AF%A2%E8%BF%90%E7%AE%97%E7%AC%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/29/CSharp%E5%9F%BA%E7%A1%80-LINQ%E6%A0%87%E5%87%86%E6%9F%A5%E8%AF%A2%E8%BF%90%E7%AE%97%E7%AC%A6/" class="post-title-link" itemprop="url">CSharp基础-LINQ标准查询运算符</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-29 10:37:02" itemprop="dateCreated datePublished" datetime="2018-12-29T10:37:02+00:00">2018-12-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 10:07:23" itemprop="dateModified" datetime="2022-07-10T10:07:23+00:00">2022-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LINQ/" itemprop="url" rel="index"><span itemprop="name">LINQ</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CSharp基础-LINQ标准查询运算符"><a href="#CSharp基础-LINQ标准查询运算符" class="headerlink" title="CSharp基础-LINQ标准查询运算符"></a>CSharp基础-LINQ标准查询运算符</h1><p>&emsp;&emsp;标准查询运算符是组成 LINQ 模式的方法。 这些方法中的大多数都作用于序列；其中序列指其类型实现 <code>IEnumerable&lt;T&gt;</code> 接口或 <code>IQueryable&lt;T&gt;</code> 接口的对象。 标准查询运算符提供包括筛选、投影、聚合、排序等在内的查询功能。</p>
<h2 id="查询表达式语法"><a href="#查询表达式语法" class="headerlink" title="查询表达式语法"></a>查询表达式语法</h2><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/query-expression-syntax-for-standard-query-operators">标准查询运算符的查询表达式语法</a></p>
<h2 id="按执行方式的分类"><a href="#按执行方式的分类" class="headerlink" title="按执行方式的分类"></a>按执行方式的分类</h2><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/classification-of-standard-query-operators-by-manner-of-execution">标准查询运算符按执行方式的分类</a></p>
<h2 id="对数据排序"><a href="#对数据排序" class="headerlink" title="对数据排序"></a>对数据排序</h2><table>
<thead>
<tr>
<th>方法名</th>
<th>描述</th>
<th>C# 查询表达式语法</th>
</tr>
</thead>
<tbody><tr>
<td>OrderBy</td>
<td>按升序对值排序。</td>
<td><code>orderby</code></td>
</tr>
<tr>
<td>OrderByDescending</td>
<td>按降序对值排序。</td>
<td><code>orderby … descending</code></td>
</tr>
<tr>
<td>ThenBy</td>
<td>按升序执行次要排序。</td>
<td><code>orderby …, …</code></td>
</tr>
<tr>
<td>ThenByDescending</td>
<td>按降序执行次要排序。</td>
<td><code>orderby …, … descending</code></td>
</tr>
<tr>
<td>Reverse</td>
<td>反转集合中元素的顺序。</td>
<td>不适用。</td>
</tr>
</tbody></table>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/sorting-data">对数据排序</a></p>
<h2 id="集运算"><a href="#集运算" class="headerlink" title="集运算"></a>集运算</h2><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/set-operations">集运算</a></p>
<h2 id="筛选数据"><a href="#筛选数据" class="headerlink" title="筛选数据"></a>筛选数据</h2><table>
<thead>
<tr>
<th>方法名</th>
<th>描述</th>
<th>C# 查询表达式语法</th>
</tr>
</thead>
<tbody><tr>
<td>OfType</td>
<td>根据其转换为特定类型的能力选择值。</td>
<td>不适用。</td>
</tr>
<tr>
<td>Where</td>
<td>选择基于谓词函数的值。</td>
<td><code>where</code></td>
</tr>
</tbody></table>
<p>参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/filtering-data">筛选数据</a></p>
<h2 id="限定符运算"><a href="#限定符运算" class="headerlink" title="限定符运算"></a>限定符运算</h2><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/quantifier-operations">限定符运算</a></p>
<h2 id="投影运算"><a href="#投影运算" class="headerlink" title="投影运算"></a>投影运算</h2><table>
<thead>
<tr>
<th>方法名</th>
<th>描述</th>
<th>C# 查询表达式语法</th>
</tr>
</thead>
<tbody><tr>
<td>选择</td>
<td>投影基于转换函数的值。</td>
<td><code>select</code></td>
</tr>
<tr>
<td>SelectMany</td>
<td>投影基于转换函数的值序列，然后将它们展平为一个序列。</td>
<td>使用多个 <code>from</code> 子句</td>
</tr>
</tbody></table>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/projection-operations">投影运算</a></p>
<h2 id="数据分区"><a href="#数据分区" class="headerlink" title="数据分区"></a>数据分区</h2><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/partitioning-data">数据分区</a></p>
<h2 id="联接运算"><a href="#联接运算" class="headerlink" title="联接运算"></a>联接运算</h2><table>
<thead>
<tr>
<th>方法名</th>
<th>描述</th>
<th>C# 查询表达式语法</th>
</tr>
</thead>
<tbody><tr>
<td>联接</td>
<td>根据键选择器函数联接两个序列并提取值对。</td>
<td><code>join … in … on … equals …</code></td>
</tr>
<tr>
<td>GroupJoin</td>
<td>根据键选择器函数联接两个序列，并对每个元素的结果匹配项进行分组。</td>
<td><code>join … in … on … equals … into …</code></td>
</tr>
</tbody></table>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/join-operations">联接运算</a></p>
<h2 id="对数据分组"><a href="#对数据分组" class="headerlink" title="对数据分组"></a>对数据分组</h2><table>
<thead>
<tr>
<th>方法名</th>
<th>描述</th>
<th>C# 查询表达式语法</th>
</tr>
</thead>
<tbody><tr>
<td>GroupBy</td>
<td>对共享通用属性的元素进行分组。 </br>每组由一个 IGrouping&lt;TKey,TElement&gt; 对象表示。</td>
<td>group … by 或 group … by … into …</td>
</tr>
<tr>
<td>ToLookup</td>
<td>将元素插入基于键选择器函数的</br>Lookup&lt;TKey,TElement&gt;（一种一对多字典）。</td>
<td>不适用。</td>
</tr>
</tbody></table>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/grouping-data">对数据分组</a></p>
<h2 id="生成运算"><a href="#生成运算" class="headerlink" title="生成运算"></a>生成运算</h2><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/generation-operations">生成运算</a></p>
<h2 id="相等运算"><a href="#相等运算" class="headerlink" title="相等运算"></a>相等运算</h2><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/generation-operations">相等运算</a></p>
<h2 id="元素运算"><a href="#元素运算" class="headerlink" title="元素运算"></a>元素运算</h2><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/element-operations">元素运算</a></p>
<h2 id="转换数据类型"><a href="#转换数据类型" class="headerlink" title="转换数据类型"></a>转换数据类型</h2><table>
<thead>
<tr>
<th>方法名</th>
<th>描述</th>
<th>C# 查询表达式语法</th>
</tr>
</thead>
<tbody><tr>
<td>AsEnumerable</td>
<td>返回类型化为 IEnumerable<T> 的输入。</td>
<td>不适用。</td>
</tr>
<tr>
<td>AsQueryable</td>
<td>将（泛型）IEnumerable 转换为（泛型）IQueryable。</td>
<td>不适用。</td>
</tr>
<tr>
<td>Cast</td>
<td>将集合中的元素转换为指定类型。</td>
<td>使用显式类型化的范围变量。 </br>例如:from string str in words</td>
</tr>
<tr>
<td>OfType</td>
<td>根据其转换为指定类型的能力筛选值。</td>
<td>不适用。</td>
</tr>
<tr>
<td>ToArray</td>
<td>将集合转换为数组。 此方法强制执行查询。</td>
<td>不适用。</td>
</tr>
<tr>
<td>ToDictionary</td>
<td>根据键选择器函数将元素放入 Dictionary&lt;TKey,TValue&gt;。</br> 此方法强制执行查询。</td>
<td>不适用。</td>
</tr>
<tr>
<td>ToList</td>
<td>将集合转换为 List<T>。 此方法强制执行查询。</td>
<td>不适用。</td>
</tr>
<tr>
<td>ToLookup</td>
<td>根据键选择器函数将元素放入 Lookup&lt;TKey,TElement&gt;（一对多字典）。 此方法强制执行查询。</td>
<td>不适用。</td>
</tr>
</tbody></table>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/converting-data-types">转换数据类型</a></p>
<h2 id="串联运算"><a href="#串联运算" class="headerlink" title="串联运算"></a>串联运算</h2><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/concatenation-operations">串联运算</a></p>
<h2 id="聚合运算"><a href="#聚合运算" class="headerlink" title="聚合运算"></a>聚合运算</h2><table>
<thead>
<tr>
<th>方法名</th>
<th>描述</th>
<th>C# 查询表达式语法</th>
<th>详细信息</th>
</tr>
</thead>
<tbody><tr>
<td>聚合</td>
<td>对集合的值执行自定义聚合运算。</td>
<td>不适用。</td>
<td>Enumerable.Aggregate</br>Queryable.Aggregate</td>
</tr>
<tr>
<td>平均值</td>
<td>计算值集合的平均值。</td>
<td>不适用。</td>
<td>Enumerable.Average</br>Queryable.Average</td>
</tr>
<tr>
<td>计数</td>
<td>对集合中元素计数，可选择仅对满足</br>谓词函数的元素计数。</td>
<td>不适用。</td>
<td>Enumerable.Count</br>Queryable.Count</td>
</tr>
<tr>
<td>LongCount</td>
<td>对大型集合中元素计数，可选择仅对</br>满足谓词函数的元素计数。</td>
<td>不适用。</td>
<td>Enumerable.LongCount</br>Queryable.LongCount</td>
</tr>
<tr>
<td>最大值</td>
<td>确定集合中的最大值。</td>
<td>不适用。</td>
<td>Enumerable.Max</br>Queryable.Max</td>
</tr>
<tr>
<td>最小值</td>
<td>确定集合中的最小值。</td>
<td>不适用。</td>
<td>Enumerable.Min</br>Queryable.Min</td>
</tr>
<tr>
<td>Sum</td>
<td>对集合中的值求和。</td>
<td>不适用。</td>
<td>Enumerable.Sum</br>Queryable.Sum</td>
</tr>
</tbody></table>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/aggregation-operations">聚合运算</a></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/standard-query-operators-overview">标准查询运算符概述 (C#)</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.linq.enumerable.oftype?view=netframework-4.7.2">https://docs.microsoft.com/zh-cn/dotnet/api/system.linq.enumerable.oftype?view=netframework-4.7.2</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/12/28/CSharp%E5%9F%BA%E7%A1%80-LINQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/28/CSharp%E5%9F%BA%E7%A1%80-LINQ/" class="post-title-link" itemprop="url">CSharp基础-LINQ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-28 14:15:20" itemprop="dateCreated datePublished" datetime="2018-12-28T14:15:20+00:00">2018-12-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 10:07:23" itemprop="dateModified" datetime="2022-07-10T10:07:23+00:00">2022-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LINQ/" itemprop="url" rel="index"><span itemprop="name">LINQ</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>9 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="LINQ-简介"><a href="#LINQ-简介" class="headerlink" title="LINQ 简介"></a>LINQ 简介</h2><p>&emsp;&emsp;LINQ（语言集成查询，<code>Language Integrated Query</code>） 是 Visual Studio 2008 和 .NET Framework 3.5 版中引入的一项创新功能。它在对象领域和数据领域之间架起了一座桥梁。语言集成查询 (LINQ) 是一系列直接将查询功能集成到 C# 语言的技术统称。</p>
<p>&emsp;&emsp;<font color=#ff0000 size=4 face="黑体">LINQ 最明显的“语言集成”部分就是查询表达式。 查询表达式采用声明性查询语法编写而成。</font> 使用查询语法，可以用最少的代码对数据源执行筛选、排序和分组操作。 可使用相同的基本查询表达式模式来查询和转换 SQL 数据库、ADO .NET 数据集、XML 文档和流以及 .NET 集合中的数据。</p>
<h3 id="查询表达式概述"><a href="#查询表达式概述" class="headerlink" title="查询表达式概述"></a>查询表达式概述</h3><ul>
<li>查询表达式可用于查询并转换所有启用了 LINQ 的数据源中的数据。</li>
<li>查询表达式中的变量全都是强类型，尽管在许多情况下，无需显式提供类型，因为编译器可以推断出。</li>
<li>只有在循环访问查询变量后，才会执行查询（例如，在 <code>foreach</code> 语句中）</li>
<li>一些查询操作（如 <code>Count</code> 或 <code>Max</code>）没有等效的查询表达式子句，因此必须表示为方法调用。</li>
<li>查询表达式可被编译成表达式树或委托，具体视应用查询的类型而定。 <font color=#ff0000 size=4 face="黑体"><code>IEnumerable&lt;T&gt;</code> 查询编译为委托。 <code>IQueryable</code> 和 <code>IQueryable&lt;T&gt;</code> 查询编译为表达式树。</font></li>
</ul>
<h3 id="LINQ-中的查询语法和方法语法"><a href="#LINQ-中的查询语法和方法语法" class="headerlink" title="LINQ 中的查询语法和方法语法"></a>LINQ 中的查询语法和方法语法</h3><p>&emsp;&emsp;在编译代码时，查询语法必须转换为针对 .NET 公共语言运行时 (CLR) 的方法调用。 这些方法调用会调用标准查询运算符（名称为 Where、Select、GroupBy、Join、Max 和 Average 等）。 可以使用方法语法（而不查询语法）来直接调用它们。</p>
<h4 id="查询语法"><a href="#查询语法" class="headerlink" title="查询语法"></a>查询语法</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Query syntax:</span></span><br><span class="line">IEnumerable&lt;<span class="built_in">int</span>&gt; numQuery1 =</span><br><span class="line">   <span class="keyword">from</span> num <span class="keyword">in</span> numbers</span><br><span class="line">    <span class="keyword">where</span> num % <span class="number">2</span> == <span class="number">0</span></span><br><span class="line">    <span class="keyword">orderby</span> num</span><br><span class="line">    <span class="keyword">select</span> num;</span><br></pre></td></tr></table></figure>

<h4 id="方法语法"><a href="#方法语法" class="headerlink" title="方法语法"></a>方法语法</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Method syntax:</span></span><br><span class="line">IEnumerable&lt;<span class="built_in">int</span>&gt; numQuery2 = numbers.Where(num =&gt; num % <span class="number">2</span> == <span class="number">0</span>).OrderBy(n =&gt; n);</span><br></pre></td></tr></table></figure>

<h3 id="Lambda-表达式"><a href="#Lambda-表达式" class="headerlink" title="Lambda 表达式"></a>Lambda 表达式</h3><p>在 C# 中，<code>=&gt;</code> 是 <code>lambda</code> 运算符（读为“转到”）。</p>
<p><font color=#ff0000 size=4 face="黑体">当我们的Lambda表达式里面用到了外部变量的时候，编译器会为这个Lambda生成一个类，在这个类中包含了我们表达式方法。</font></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Query syntax:</span></span><br><span class="line">IEnumerable&lt;<span class="built_in">int</span>&gt; numQuery1 =</span><br><span class="line">    <span class="keyword">from</span> num <span class="keyword">in</span> numbers</span><br><span class="line">    <span class="keyword">where</span> num % <span class="number">2</span> == <span class="number">0</span></span><br><span class="line">    <span class="keyword">orderby</span> num</span><br><span class="line">    <span class="keyword">select</span> num;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Method syntax:</span></span><br><span class="line">IEnumerable&lt;<span class="built_in">int</span>&gt; numQuery2 = numbers.Where(num =&gt; num % <span class="number">2</span> == <span class="number">0</span>).OrderBy(n =&gt; n);</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;在上面的示例中，请注意，条件表达式 (num % 2 == 0) 作为内联参数传递给 Where 方法：Where(num =&gt; num % 2 == 0). 此内联表达式称为 lambda 表达式。 可采用匿名方法、泛型委托或表达式树的形式编写原本必须以更繁琐的形式编写的代码。</p>
<p>&emsp;&emsp;Lambda 的主体与查询语法中或任何其他 C# 表达式或语句中的表达式完全相同；它可以包含方法调用和其他复杂逻辑。 “返回值”就是表达式结果。</p>
<p>某些查询只能采用方法语法进行表示，而其中一些查询需要 lambda 表达式。</p>
<h3 id="对象和集合初始值设定项"><a href="#对象和集合初始值设定项" class="headerlink" title="对象和集合初始值设定项"></a>对象和集合初始值设定项</h3><p>通过对象和集合初始值设定项，初始化对象时无需为对象显式调用构造函数。 初始值设定项通常用在将源数据投影到新数据类型的查询表达式中。 假定一个类名为 <code>Customer</code>，具有公共 <code>Name</code> 和 <code>Phone</code> 属性，可以按下列代码中所示使用对象初始值设定项：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Customer cust = <span class="keyword">new</span> Customer &#123; Name = <span class="string">&quot;Mike&quot;</span>, Phone = <span class="string">&quot;555-1212&quot;</span> &#125;; </span><br><span class="line"><span class="keyword">var</span> newLargeOrderCustomers = <span class="keyword">from</span> o <span class="keyword">in</span> IncomingOrders</span><br><span class="line">                            <span class="keyword">where</span> o.OrderSize &gt; <span class="number">5</span></span><br><span class="line">                            <span class="keyword">select</span> <span class="keyword">new</span> Customer &#123; Name = o.Name, Phone = o.Phone &#125;;</span><br></pre></td></tr></table></figure>

<p>述代码也可以使用 LINQ 的方法语法编写:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> newLargeOrderCustomers = IncomingOrders.Where(x =&gt; x.OrderSize &gt; <span class="number">5</span>).Select(y =&gt; <span class="keyword">new</span> Customer &#123; Name = y.Name, Phone = y.Phone &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="LINQ-查询"><a href="#LINQ-查询" class="headerlink" title="LINQ 查询"></a>LINQ 查询</h2><p>所有 LINQ 查询操作都由以下三个不同的操作组成：<br>获取数据源。<br>创建查询。<br>执行查询。</p>
<h3 id="数据源"><a href="#数据源" class="headerlink" title="数据源"></a>数据源</h3><p>基本规则很简单：LINQ 数据源是支持泛型 <code>IEnumerable&lt;T&gt;</code> 接口或从中继承的接口的任意对象。</p>
<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><p>在 LINQ 中，查询变量本身不执行任何操作并且不返回任何数据。 它只是存储在以后某个时刻执行查询时为生成结果而必需的信息。</p>
<h3 id="查询执行"><a href="#查询执行" class="headerlink" title="查询执行"></a>查询执行</h3><h4 id="延迟执行"><a href="#延迟执行" class="headerlink" title="延迟执行"></a>延迟执行</h4><p>查询的实际执行将推迟到在 <code>foreach</code> 语句中循环访问查询变量之后进行。 此概念称为延迟执行，下面的示例对此进行了演示：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  Query execution. </span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="built_in">int</span> num <span class="keyword">in</span> numQuery)</span><br><span class="line">&#123;</span><br><span class="line">    Console.Write(<span class="string">&quot;&#123;0,1&#125; &quot;</span>, num);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在应用程序中，可以创建一个检索最新数据的查询，并可以按某一时间间隔反复执行该查询以便每次检索不同的结果。</p>
<h4 id="强制立即执行"><a href="#强制立即执行" class="headerlink" title="强制立即执行"></a>强制立即执行</h4><p>对一系列源元素执行聚合函数的查询必须首先循环访问这些元素。 <code>Count</code>、<code>Max</code>、<code>Average</code> 和 <code>First</code> 就属于此类查询。由于查询本身必须使用 <code>foreach</code> 以便返回结果，因此这些查询在执行时不使用显式 <code>foreach</code> 语句。 另外还要注意，这些类型的查询返回单个值，而不是 <code>IEnumerable</code> 集合。 下面的查询返回源数组中偶数的计数：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> evenNumQuery =</span><br><span class="line">    <span class="function"><span class="keyword">from</span> num <span class="keyword">in</span> numbers</span></span><br><span class="line"><span class="function">    <span class="title">where</span> (<span class="params">num % <span class="number">2</span></span>)</span> == <span class="number">0</span></span><br><span class="line">    <span class="keyword">select</span> num;</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> evenNumCount = evenNumQuery.Count();</span><br></pre></td></tr></table></figure>

<p>要强制立即执行任何查询并缓存其结果，可调用 <code>ToList</code> 或 <code>ToArray</code> 方法。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">List&lt;<span class="built_in">int</span>&gt; numQuery2 =</span><br><span class="line">    (<span class="function"><span class="keyword">from</span> num <span class="keyword">in</span> numbers</span></span><br><span class="line"><span class="function">     <span class="title">where</span> (<span class="params">num % <span class="number">2</span></span>)</span> == <span class="number">0</span></span><br><span class="line">     <span class="keyword">select</span> num).ToList();</span><br><span class="line"></span><br><span class="line"><span class="comment">// or like this:</span></span><br><span class="line"><span class="comment">// numQuery3 is still an int[]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> numQuery3 =</span><br><span class="line">    (<span class="function"><span class="keyword">from</span> num <span class="keyword">in</span> numbers</span></span><br><span class="line"><span class="function">     <span class="title">where</span> (<span class="params">num % <span class="number">2</span></span>)</span> == <span class="number">0</span></span><br><span class="line">     <span class="keyword">select</span> num).ToArray();</span><br></pre></td></tr></table></figure>

<h2 id="基本-LINQ-查询操作"><a href="#基本-LINQ-查询操作" class="headerlink" title="基本 LINQ 查询操作"></a>基本 LINQ 查询操作</h2><h3 id="获取数据源"><a href="#获取数据源" class="headerlink" title="获取数据源"></a>获取数据源</h3><p>使用 from 子句引入数据源:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//queryAllCustomers is an IEnumerable&lt;Customer&gt;</span></span><br><span class="line"><span class="keyword">var</span> queryAllCustomers = <span class="keyword">from</span> cust <span class="keyword">in</span> customers</span><br><span class="line">                        <span class="keyword">select</span> cust;</span><br></pre></td></tr></table></figure>

<p>可通过 <code>let</code> 子句引入其他范围变量。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> earlyBirdQuery =</span><br><span class="line">     <span class="keyword">from</span> sentence <span class="keyword">in</span> strings</span><br><span class="line">     <span class="keyword">let</span> words = sentence.Split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">     <span class="keyword">from</span> word <span class="keyword">in</span> words</span><br><span class="line">     <span class="keyword">let</span> w = word.ToLower()</span><br><span class="line">     <span class="keyword">where</span> w[<span class="number">0</span>] == <span class="string">&#x27;a&#x27;</span> || w[<span class="number">0</span>] == <span class="string">&#x27;e&#x27;</span></span><br><span class="line">         || w[<span class="number">0</span>] == <span class="string">&#x27;i&#x27;</span> || w[<span class="number">0</span>] == <span class="string">&#x27;o&#x27;</span></span><br><span class="line">         || w[<span class="number">0</span>] == <span class="string">&#x27;u&#x27;</span></span><br><span class="line">     <span class="keyword">select</span> word;</span><br></pre></td></tr></table></figure>

<h3 id="筛选"><a href="#筛选" class="headerlink" title="筛选"></a>筛选</h3><p>筛选器使查询仅返回表达式为 true 的元素。 将通过使用 <code>where</code> 子句生成结果。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> queryLondonCustomers = <span class="keyword">from</span> cust <span class="keyword">in</span> customers</span><br><span class="line">                           <span class="keyword">where</span> cust.City == <span class="string">&quot;London&quot;</span></span><br><span class="line">                           <span class="keyword">select</span> cust;</span><br></pre></td></tr></table></figure>

<h3 id="中间件排序"><a href="#中间件排序" class="headerlink" title="中间件排序"></a>中间件排序</h3><p><code>orderby</code> 子句根据要排序类型的默认比较器，对返回序列中的元素排序。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> queryLondonCustomers3 =</span><br><span class="line">    <span class="keyword">from</span> cust <span class="keyword">in</span> customers</span><br><span class="line">    <span class="keyword">where</span> cust.City == <span class="string">&quot;London&quot;</span></span><br><span class="line">    <span class="keyword">orderby</span> cust.Name <span class="keyword">ascending</span></span><br><span class="line">    <span class="keyword">select</span> cust;</span><br></pre></td></tr></table></figure>

<p>要对结果进行从 Z 到 A 的逆序排序，请使用 <code>orderby…descending</code> 子句。</p>
<h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h3><p><code>group</code> 子句用于对根据指定的键所获得的结果进行分组。</p>
<p>使用 <code>group</code> 子句结束查询时，结果将以列表的形式列出。 列表中的每个元素都是具有 <code>Key</code> 成员的对象，列表中的元素根据该键被分组。 在循环访问生成组序列的查询时，必须使用嵌套 <code>foreach</code> 循环。 外层循环循环访问每个组，内层循环循环访问每个组的成员。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// queryCustomersByCity is an IEnumerable&lt;IGrouping&lt;string, Customer&gt;&gt;</span></span><br><span class="line">  <span class="keyword">var</span> queryCustomersByCity =</span><br><span class="line">      <span class="keyword">from</span> cust <span class="keyword">in</span> customers</span><br><span class="line">      <span class="keyword">group</span> cust <span class="keyword">by</span> cust.City;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// customerGroup is an IGrouping&lt;string, Customer&gt;</span></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="keyword">var</span> customerGroup <span class="keyword">in</span> queryCustomersByCity)</span><br><span class="line">  &#123;</span><br><span class="line">      Console.WriteLine(customerGroup.Key);</span><br><span class="line">      <span class="keyword">foreach</span> (Customer customer <span class="keyword">in</span> customerGroup)</span><br><span class="line">      &#123;</span><br><span class="line">          Console.WriteLine(<span class="string">&quot;    &#123;0&#125;&quot;</span>, customer.Name);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>如果必须引用某个组操作的结果，可使用 into 关键字创建能被进一步查询的标识符。 下列查询仅返回包含两个以上客户的组：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// custQuery is an IEnumerable&lt;IGrouping&lt;string, Customer&gt;&gt;</span></span><br><span class="line"><span class="keyword">var</span> custQuery =</span><br><span class="line">    <span class="keyword">from</span> cust <span class="keyword">in</span> customers</span><br><span class="line">    <span class="keyword">group</span> cust <span class="keyword">by</span> cust.City <span class="keyword">into</span> custGroup</span><br><span class="line">    <span class="keyword">where</span> custGroup.Count() &gt; <span class="number">2</span></span><br><span class="line">    <span class="keyword">orderby</span> custGroup.Key</span><br><span class="line">    <span class="keyword">select</span> custGroup;</span><br></pre></td></tr></table></figure>

<h3 id="联接"><a href="#联接" class="headerlink" title="联接"></a>联接</h3><p>在 LINQ 中，join 子句始终作用于对象集合，而非直接作用于数据库表。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> innerJoinQuery =</span><br><span class="line">    <span class="keyword">from</span> cust <span class="keyword">in</span> customers</span><br><span class="line">    <span class="keyword">join</span> dist <span class="keyword">in</span> distributors <span class="keyword">on</span> cust.City <span class="keyword">equals</span> dist.City</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">new</span> &#123; CustomerName = cust.Name, DistributorName = dist.Name &#125;;</span><br></pre></td></tr></table></figure>

<p>在 LINQ 中，不必像在 SQL 中那样频繁使用 join，因为 LINQ 中的外键在对象模型中表示为包含项集合的属性。 例如 Customer 对象包含 Order 对象的集合。 不必执行联接，只需使用点表示法访问订单：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> order <span class="keyword">in</span> Customer.Orders...</span><br></pre></td></tr></table></figure>

<h3 id="选择（投影）"><a href="#选择（投影）" class="headerlink" title="选择（投影）"></a>选择（投影）</h3><p><font color=#0099ff size=4 face="黑体">select 子句生成查询结果并指定每个返回的元素的“形状”或类型。当 select 子句生成除源元素副本以外的内容时，该操作称为投影。</font></p>
<h2 id="使用-LINQ-进行数据转换"><a href="#使用-LINQ-进行数据转换" class="headerlink" title="使用 LINQ 进行数据转换"></a>使用 LINQ 进行数据转换</h2><p>语言集成查询 (LINQ) 不只是检索数据。 它也是用于转换数据的强大工具。 通过使用 LINQ 查询，可以使用源序列作为输入，并通过多种方式对其进行修改，以创建新的输出序列。通过排序和分组，你可以修改序列本身，而无需修改这些元素本身。</p>
<p><code>select</code> 可以执行下列任务</p>
<ul>
<li>将多个输入序列合并为具有新类型的单个输出序列。</li>
<li>创建其元素由源序列中每个元素的一个或多个属性组成的输出序列。</li>
<li>创建其元素由对源数据执行的操作结果组成的输出序列。</li>
<li>创建其他格式的输出序列。 例如，可以将数据从 SQL 行或文本文件转换为 XML。</li>
</ul>
<h3 id="将多个输入联接到一个输出序列中"><a href="#将多个输入联接到一个输出序列中" class="headerlink" title="将多个输入联接到一个输出序列中"></a>将多个输入联接到一个输出序列中</h3><p><font color=#0099ff size=4 face="黑体">可以使用 LINQ 查询创建包含元素的输出序列，这些元素来自多个输入序列。</font></p>
<p>例如：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Student</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> First &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Last &#123;<span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Street &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> City &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="built_in">int</span>&gt; Scores;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Teacher</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> First &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Last &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> City &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title">DataTransformations</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Create the first data source.</span></span><br><span class="line">        List&lt;Student&gt; students = <span class="keyword">new</span> List&lt;Student&gt;()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">new</span> Student &#123; First=<span class="string">&quot;Svetlana&quot;</span>,</span><br><span class="line">                Last=<span class="string">&quot;Omelchenko&quot;</span>,</span><br><span class="line">                ID=<span class="number">111</span>,</span><br><span class="line">                Street=<span class="string">&quot;123 Main Street&quot;</span>,</span><br><span class="line">                City=<span class="string">&quot;Seattle&quot;</span>,</span><br><span class="line">                Scores= <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt; &#123; <span class="number">97</span>, <span class="number">92</span>, <span class="number">81</span>, <span class="number">60</span> &#125; &#125;,</span><br><span class="line">            <span class="keyword">new</span> Student &#123; First=<span class="string">&quot;Claire&quot;</span>,</span><br><span class="line">                Last=<span class="string">&quot;O’Donnell&quot;</span>,</span><br><span class="line">                ID=<span class="number">112</span>,</span><br><span class="line">                Street=<span class="string">&quot;124 Main Street&quot;</span>,</span><br><span class="line">                City=<span class="string">&quot;Redmond&quot;</span>,</span><br><span class="line">                Scores= <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt; &#123; <span class="number">75</span>, <span class="number">84</span>, <span class="number">91</span>, <span class="number">39</span> &#125; &#125;,</span><br><span class="line">            <span class="keyword">new</span> Student &#123; First=<span class="string">&quot;Sven&quot;</span>,</span><br><span class="line">                Last=<span class="string">&quot;Mortensen&quot;</span>,</span><br><span class="line">                ID=<span class="number">113</span>,</span><br><span class="line">                Street=<span class="string">&quot;125 Main Street&quot;</span>,</span><br><span class="line">                City=<span class="string">&quot;Lake City&quot;</span>,</span><br><span class="line">                Scores= <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt; &#123; <span class="number">88</span>, <span class="number">94</span>, <span class="number">65</span>, <span class="number">91</span> &#125; &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create the second data source.</span></span><br><span class="line">        List&lt;Teacher&gt; teachers = <span class="keyword">new</span> List&lt;Teacher&gt;()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">new</span> Teacher &#123; First=<span class="string">&quot;Ann&quot;</span>, Last=<span class="string">&quot;Beebe&quot;</span>, ID=<span class="number">945</span>, City=<span class="string">&quot;Seattle&quot;</span> &#125;,</span><br><span class="line">            <span class="keyword">new</span> Teacher &#123; First=<span class="string">&quot;Alex&quot;</span>, Last=<span class="string">&quot;Robinson&quot;</span>, ID=<span class="number">956</span>, City=<span class="string">&quot;Redmond&quot;</span> &#125;,</span><br><span class="line">            <span class="keyword">new</span> Teacher &#123; First=<span class="string">&quot;Michiyo&quot;</span>, Last=<span class="string">&quot;Sato&quot;</span>, ID=<span class="number">972</span>, City=<span class="string">&quot;Tacoma&quot;</span> &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create the query.</span></span><br><span class="line">        <span class="keyword">var</span> peopleInSeattle = (<span class="keyword">from</span> student <span class="keyword">in</span> students</span><br><span class="line">                    <span class="keyword">where</span> student.City == <span class="string">&quot;Seattle&quot;</span></span><br><span class="line">                    <span class="keyword">select</span> student.Last)</span><br><span class="line">                    .Concat(<span class="keyword">from</span> teacher <span class="keyword">in</span> teachers</span><br><span class="line">                            <span class="keyword">where</span> teacher.City == <span class="string">&quot;Seattle&quot;</span></span><br><span class="line">                            <span class="keyword">select</span> teacher.Last);</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;The following students and teachers live in Seattle:&quot;</span>);</span><br><span class="line">        <span class="comment">// Execute the query.</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> person <span class="keyword">in</span> peopleInSeattle)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(person);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Press any key to exit.&quot;</span>);</span><br><span class="line">        Console.ReadKey();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Output:</span></span><br><span class="line"><span class="comment">    The following students and teachers live in Seattle:</span></span><br><span class="line"><span class="comment">    Omelchenko</span></span><br><span class="line"><span class="comment">    Beebe</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h3 id="选择每个源元素的子集"><a href="#选择每个源元素的子集" class="headerlink" title="选择每个源元素的子集"></a>选择每个源元素的子集</h3><p>有两种主要方法来选择源序列中每个元素的子集：</p>
<p>1，若要仅选择源元素的一个成员，请使用点操作。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> query = <span class="keyword">from</span> cust <span class="keyword">in</span> Customers  </span><br><span class="line">            <span class="keyword">select</span> cust.City; </span><br></pre></td></tr></table></figure>

<p>2，要创建包含多个源元素属性的元素，可以使用带有命名对象或匿名类型的对象初始值设定项。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> query = <span class="keyword">from</span> cust <span class="keyword">in</span> Customer  </span><br><span class="line">            <span class="keyword">select</span> <span class="keyword">new</span> &#123;Name = cust.Name, City = cust.City&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="将内存中对象转换为-XML"><a href="#将内存中对象转换为-XML" class="headerlink" title="将内存中对象转换为 XML"></a>将内存中对象转换为 XML</h3><p>LINQ 查询可以方便地在内存中数据结构、SQL 数据库、ADO.NET 数据集和 XML 流或文档之间转换数据。 </p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Create the data source by using a collection initializer.</span></span><br><span class="line">    <span class="comment">// The Student class was defined previously in this topic.</span></span><br><span class="line">    List&lt;Student&gt; students = <span class="keyword">new</span> List&lt;Student&gt;()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> Student &#123;First=<span class="string">&quot;Svetlana&quot;</span>, Last=<span class="string">&quot;Omelchenko&quot;</span>, ID=<span class="number">111</span>, Scores = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123;<span class="number">97</span>, <span class="number">92</span>, <span class="number">81</span>, <span class="number">60</span>&#125;&#125;,</span><br><span class="line">        <span class="keyword">new</span> Student &#123;First=<span class="string">&quot;Claire&quot;</span>, Last=<span class="string">&quot;O’Donnell&quot;</span>, ID=<span class="number">112</span>, Scores = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123;<span class="number">75</span>, <span class="number">84</span>, <span class="number">91</span>, <span class="number">39</span>&#125;&#125;,</span><br><span class="line">        <span class="keyword">new</span> Student &#123;First=<span class="string">&quot;Sven&quot;</span>, Last=<span class="string">&quot;Mortensen&quot;</span>, ID=<span class="number">113</span>, Scores = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123;<span class="number">88</span>, <span class="number">94</span>, <span class="number">65</span>, <span class="number">91</span>&#125;&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the query.</span></span><br><span class="line">    <span class="keyword">var</span> studentsToXML = <span class="keyword">new</span> XElement(<span class="string">&quot;Root&quot;</span>,</span><br><span class="line">        <span class="keyword">from</span> student <span class="keyword">in</span> students</span><br><span class="line">        <span class="keyword">let</span> scores = <span class="built_in">string</span>.Join(<span class="string">&quot;,&quot;</span>, student.Scores)</span><br><span class="line">        <span class="function"><span class="keyword">select</span> <span class="keyword">new</span> <span class="title">XElement</span>(<span class="params"><span class="string">&quot;student&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="keyword">new</span> XElement(<span class="string">&quot;First&quot;</span>, student.First</span>),</span></span><br><span class="line"><span class="function">                   <span class="keyword">new</span> <span class="title">XElement</span>(<span class="params"><span class="string">&quot;Last&quot;</span>, student.Last</span>),</span></span><br><span class="line"><span class="function">                   <span class="keyword">new</span> <span class="title">XElement</span>(<span class="params"><span class="string">&quot;Scores&quot;</span>, scores</span>)</span></span><br><span class="line"><span class="function">                ) <span class="comment">// end &quot;student&quot;</span></span></span><br><span class="line"><span class="function">            )</span>; <span class="comment">// end &quot;Root&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Execute the query.</span></span><br><span class="line">    Console.WriteLine(studentsToXML);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Keep the console open in debug mode.</span></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;Press any key to exit.&quot;</span>);</span><br><span class="line">    Console.ReadKey();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;Root&gt;  </span><br><span class="line">  &lt;student&gt;  </span><br><span class="line">    &lt;First&gt;Svetlana&lt;/First&gt;  </span><br><span class="line">    &lt;Last&gt;Omelchenko&lt;/Last&gt;  </span><br><span class="line">    &lt;Scores&gt;<span class="number">97</span>,<span class="number">92</span>,<span class="number">81</span>,<span class="number">60</span>&lt;/Scores&gt;  </span><br><span class="line">  &lt;/student&gt;  </span><br><span class="line">  &lt;student&gt;  </span><br><span class="line">    &lt;First&gt;Claire&lt;/First&gt;  </span><br><span class="line">    &lt;Last&gt;O<span class="string">&#x27;Donnell&lt;/Last&gt;  </span></span><br><span class="line"><span class="string">    &lt;Scores&gt;75,84,91,39&lt;/Scores&gt;  </span></span><br><span class="line"><span class="string">  &lt;/student&gt;  </span></span><br><span class="line"><span class="string">  &lt;student&gt;  </span></span><br><span class="line"><span class="string">    &lt;First&gt;Sven&lt;/First&gt;  </span></span><br><span class="line"><span class="string">    &lt;Last&gt;Mortensen&lt;/Last&gt;  </span></span><br><span class="line"><span class="string">    &lt;Scores&gt;88,94,65,91&lt;/Scores&gt;  </span></span><br><span class="line"><span class="string">  &lt;/student&gt;  </span></span><br><span class="line"><span class="string">&lt;/Root&gt;  </span></span><br></pre></td></tr></table></figure>

<h3 id="对源元素执行操作"><a href="#对源元素执行操作" class="headerlink" title="对源元素执行操作"></a>对源元素执行操作</h3><p>&emsp;&emsp;<font color=#0099ff size=4 face="黑体">输出序列可能不包含源序列中的任何元素或元素属性。 输出可能是使用源元素作为输入参数而计算得出的值序列。</font></p>
<p>备注:<br>&emsp;&emsp;如果查询将被转换为另一个域，则不支持在查询表达式中调用方法。 例如，不能在 LINQ to SQL 中调用普通的 C# 方法，因为 SQL Server 没有用于它的上下文。 但是，可以将存储过程映射到方法并调用这些方法。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Data source.</span></span><br><span class="line">    <span class="built_in">double</span>[] radii = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Query.</span></span><br><span class="line">    IEnumerable&lt;<span class="built_in">string</span>&gt; query =</span><br><span class="line">        <span class="keyword">from</span> rad <span class="keyword">in</span> radii</span><br><span class="line">        <span class="keyword">select</span> <span class="string">$&quot;Area = <span class="subst">&#123;rad * rad * Math.PI:F2&#125;</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Query execution. </span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="built_in">string</span> s <span class="keyword">in</span> query)</span><br><span class="line">        Console.WriteLine(s);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Keep the console open in debug mode.</span></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;Press any key to exit.&quot;</span>);</span><br><span class="line">    Console.ReadKey();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Output:</span></span><br><span class="line"><span class="comment">    Area = 3.14</span></span><br><span class="line"><span class="comment">    Area = 12.57</span></span><br><span class="line"><span class="comment">    Area = 28.27</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="LINQ-查询操作中的类型关系"><a href="#LINQ-查询操作中的类型关系" class="headerlink" title="LINQ 查询操作中的类型关系"></a>LINQ 查询操作中的类型关系</h2><p>&emsp;&emsp;LINQ 查询操作在数据源、查询本身及查询执行中是强类型化的。 查询中变量的类型必须与数据源中元素的类型和 foreach 语句中迭代变量的类型兼容。 此强类型保证在编译时捕获类型错误，以便可以在用户遇到这些错误之前更正它们。</p>
<h3 id="不转换源数据的查询"><a href="#不转换源数据的查询" class="headerlink" title="不转换源数据的查询"></a>不转换源数据的查询</h3><p><img src="/img/linq_flow1.png" alt="linq_flow1.png"></p>
<h3 id="转换源数据的查询"><a href="#转换源数据的查询" class="headerlink" title="转换源数据的查询"></a>转换源数据的查询</h3><p><img src="/img/linq_flow2.png" alt="linq_flow2.png"></p>
<p><img src="/img/linq_flow3.png" alt="linq_flow3.png"></p>
<h3 id="让编译器推断类型信息"><a href="#让编译器推断类型信息" class="headerlink" title="让编译器推断类型信息"></a>让编译器推断类型信息</h3><p>关键字 <code>var</code> 可用于查询操作中的任何本地变量。</p>
<p><img src="/img/linq_flow4.png" alt="linq_flow4.png"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/keywords/let-clause">https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/keywords/let-clause</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/">语言集成查询 (LINQ)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/29/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/29/">29</a><span class="page-number current">30</span><a class="page-number" href="/page/31/">31</a><span class="space">&hellip;</span><a class="page-number" href="/page/37/">37</a><a class="extend next" rel="next" href="/page/31/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="syxdevcode"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">syxdevcode</p>
  <div class="site-description" itemprop="description">syxdevcode的个人博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">554</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">140</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">208</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/syxdevcode" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;syxdevcode" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">syxdevcode</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.8m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">26:43</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
