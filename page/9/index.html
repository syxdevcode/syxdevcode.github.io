<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"syxdevcode.github.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="syxdevcode博客">
<meta property="og:url" content="https://syxdevcode.github.com/page/9/index.html">
<meta property="og:site_name" content="syxdevcode博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="syxdevcode">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://syxdevcode.github.com/page/9/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>syxdevcode博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">syxdevcode博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/syxdevcode" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/08/19/Mysql%E6%89%A7%E8%A1%8Cflush%20privileges%E6%8A%A5%E9%94%99%EF%BC%9ATable%20'mysql.servers'%20doesn't%20exist/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/19/Mysql%E6%89%A7%E8%A1%8Cflush%20privileges%E6%8A%A5%E9%94%99%EF%BC%9ATable%20'mysql.servers'%20doesn't%20exist/" class="post-title-link" itemprop="url">Mysql执行flush privileges报错：Table 'mysql.servers' doesn't exist</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-19 17:51:40" itemprop="dateCreated datePublished" datetime="2020-08-19T17:51:40+00:00">2020-08-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-16 08:30:45" itemprop="dateModified" datetime="2021-04-16T08:30:45+00:00">2021-04-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>mysql执行刷新权限报错：<code>Table &#39;mysql.servers&#39; doesn&#39;t exist</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; flush privileges;</span><br><span class="line">ERROR 1146 (42S02): Table <span class="string">&#x27;mysql.servers&#x27;</span> doesn<span class="string">&#x27;t exist</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mysql&gt; show warnings;</span></span><br><span class="line"><span class="string">+---------+------+-------------------------------------+</span></span><br><span class="line"><span class="string">| Level   | Code | Message                             |</span></span><br><span class="line"><span class="string">+---------+------+-------------------------------------+</span></span><br><span class="line"><span class="string">| Warning | 1146 | Table &#x27;</span>mysql.servers<span class="string">&#x27; doesn&#x27;</span>t exist |</span><br><span class="line">+---------+------+-------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; drop table <span class="keyword">if</span> exists servers;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE TABLE `servers` (</span><br><span class="line">    -&gt; `Server_name` char(64) NOT NULL,</span><br><span class="line">    -&gt; `Host` char(64) NOT NULL,`Db` char(64) NOT NULL,</span><br><span class="line">    -&gt; `Username` char(64) NOT NULL,</span><br><span class="line">    -&gt; `Password` char(64) NOT NULL,</span><br><span class="line">    -&gt; `Port` int(4) DEFAULT NULL,</span><br><span class="line">    -&gt; `Socket` char(64) DEFAULT NULL,</span><br><span class="line">    -&gt; `Wrapper` char(64) NOT NULL,</span><br><span class="line">    -&gt; `Owner` char(64) NOT NULL,</span><br><span class="line">    -&gt; PRIMARY KEY (`Server_name`)</span><br><span class="line">    -&gt; ) ENGINE=MyISAM DEFAULT CHARSET=utf8 COMMENT=<span class="string">&#x27;MySQL Foreign Servers table&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>SQL脚本：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `servers` (</span><br><span class="line">`Server_name` <span class="type">char</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`Host` <span class="type">char</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,`Db` <span class="type">char</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`Username` <span class="type">char</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`Password` <span class="type">char</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`Port` <span class="type">int</span>(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`Socket` <span class="type">char</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`Wrapper` <span class="type">char</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`Owner` <span class="type">char</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`Server_name`)</span><br><span class="line">) ENGINE<span class="operator">=</span>MyISAM <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;MySQL Foreign Servers table&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ghjbk/p/13495761.html">ERROR 1146 (42S02): Table ‘mysql.servers’ doesn’t exist</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8af0b92e4fc8">MYSQL ERROR 1146 Table doesnt exist 解析</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/08/19/mysql5-7-X-CentOS7%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/19/mysql5-7-X-CentOS7%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">mysql5.7.X-CentOS7主从复制配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-19 11:12:04" itemprop="dateCreated datePublished" datetime="2020-08-19T11:12:04+00:00">2020-08-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-16 08:30:45" itemprop="dateModified" datetime="2021-04-16T08:30:45+00:00">2021-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySql/" itemprop="url" rel="index"><span itemprop="name">MySql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>主从复制（也称 Replication， AB 复制）允许将来自一个MySQL数据库服务器（主服务器）的数据复制到一个或多个MySQL数据库服务器（从服务器）。</p>
<p>复制是异步的 从站不需要永久连接以接收来自主站的更新，从服务器甚至可以通过拨号断断续续地连接主服务器。</p>
<p>根据配置，可以复制数据库中的所有数据库，所选数据库甚至选定的表。</p>
<p>有以下几种形式：</p>
<ul>
<li>一主一从</li>
<li>主主复制</li>
<li>一主多从—扩展系统读取的性能，因为读是在从库读取的；</li>
<li>多主一从—5.7开始支持</li>
<li>联级复制—</li>
</ul>
<p><strong>MySQL中复制的优点：</strong></p>
<p>1，横向扩展解决方案 - 在多个从站之间分配负载以提高性能。在此环境中，所有写入和更新都必须在主服务器上进行。但是，读取可以在一个或多个从设备上进行。该模型可以提高写入性能（因为主设备专用于更新），同时显着提高了越来越多的从设备的读取速度。<br>2，数据安全性 - 因为数据被复制到从站，并且从站可以暂停复制过程，所以可以在从站上运行备份服务而不会破坏相应的主数据。<br>3，分析 - 可以在主服务器上创建实时数据，而信息分析可以在从服务器上进行，而不会影响主服务器的性能。<br>4，远程数据分发 - 您可以使用复制为远程站点创建数据的本地副本，而无需永久访问主服务器。</p>
<p><strong>主要过程</strong></p>
<p>1、主服务器MySQL服务将所有的写操作记录在 binlog 日志中，并生成 log dump 线程，将 binlog 日志传给从服务器MySQL服务的 I/O 线程。<br>2、从服务器MySQL服务生成两个线程，一个是 I/O 线程，另一个是 SQL 线程。<br>3、从库 I/O 线程去请求主库的 binlog 日志，并将 binlog 日志中的文件写入 relaylog（中继日志）中。<br>4、从库的 SQL 线程会读取 relaylog 中的内容，并解析成具体的操作，来实现主从的操作一致，达到最终两个数据库数据一致的目的。</p>
<p><img src="/img/202051293523201.jpg" alt="202051293523201.jpg"></p>
<p>注意点：</p>
<ul>
<li>主从复制是异步的逻辑的 SQL 语句级的复制；</li>
<li>复制时，主库有一个 I/O 线程，从库有两个线程，及 I/O 和 SQL 线程；</li>
<li>实现主从复制的必要条件是主库要开启记录 binlog 的功能；</li>
<li>作为复制的所有 MySQL 节点的 server-id 都不能相同；</li>
<li>binlog 文件只记录对数据内容有更改的 SQL 语句，不记录任何查询语句。</li>
<li><strong>无法将主服务器配置为仅记录特定事件。</strong></li>
</ul>
<h2 id="二进制日志"><a href="#二进制日志" class="headerlink" title="二进制日志"></a>二进制日志</h2><p>mysqld将数字扩展名附加到二进制日志基本名称以生成二进制日志文件名。每次服务器创建新日志文件时，该数字都会增加，从而创建一系列有序的文件。每次启动或刷新日志时，服务器都会在系列中创建一个新文件。服务器还会在当前日志大小达到 <code>max_binlog_size</code> 参数设置的大小后自动创建新的二进制日志文件 。二进制日志文件可能会比 <code>max_binlog_size</code> 使用大型事务时更大， 因为事务是以一个部分写入文件，而不是在文件之间分割。</p>
<p>为了跟踪已使用的二进制日志文件， mysqld 还创建了一个二进制日志索引文件，其中包含所有使用的二进制日志文件的名称。默认情况下，它具有与二进制日志文件相同的基本名称，并带有扩展名 <code>.index</code>。在 mysqld 运行时，您不应手动编辑此文件。</p>
<p><code>二进制日志文件</code> 通常表示包含数据库事件的单个编号文件。<br><code>二进制日志</code> 表示含编号的二进制日志文件集加上索引文件。</p>
<p>SUPER 权限的用户可以使用 <code>SET sql_log_bin=0</code> 语句禁用其当前环境下自己的语句的二进制日志记录。</p>
<h2 id="配置部署"><a href="#配置部署" class="headerlink" title="配置部署"></a>配置部署</h2><p><strong>主从部署必要条件：</strong></p>
<ul>
<li>主库开启binlog日志（设置log-bin参数）</li>
<li>主从server-id不同</li>
<li>从库服务器能连通主库</li>
</ul>
<p><strong>主服务器：</strong></p>
<p>1、开启二进制日志<br>2、配置唯一的server-id<br>3、获得master二进制日志文件名及位置<br>4、创建一个用于slave和master通信的用户账号</p>
<p><strong>从服务器：</strong></p>
<p>1、配置唯一的server-id<br>2、使用master分配的用户账号读取master二进制日志<br>3、启用slave服务</p>
<h3 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h3><p><strong>主节点修改配置文件</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务器唯一ID，一般取IP最后一段</span></span><br><span class="line">server-id=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 要同步的数据库(可以不指定)</span></span><br><span class="line">binlog-do-db=<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 要生成二进制日志文件 主服务器一定要开启</span></span><br><span class="line">log-bin=/usr/<span class="built_in">local</span>/mysql/binlogs/bin-log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不可以被从服务器复制的库</span></span><br><span class="line">binlog-ignore-db=mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># binlog日志格式，mysql默认采用ROW，建议使用mixed</span></span><br><span class="line">binlog_format=MIXED</span><br><span class="line"></span><br><span class="line"><span class="comment"># binlog日志文件</span></span><br><span class="line">log-bin=/usr/<span class="built_in">local</span>/mysql/binlogs/bin-log</span><br><span class="line"></span><br><span class="line"><span class="comment"># binlog过期清理时间</span></span><br><span class="line">expire_logs_days=7</span><br><span class="line"></span><br><span class="line"><span class="comment"># binlog每个日志文件大小</span></span><br><span class="line">max_binlog_size=100m</span><br><span class="line"></span><br><span class="line"><span class="comment"># binlog缓存大小</span></span><br><span class="line">binlog_cache_size=4m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最大binlog缓存大小</span></span><br><span class="line">max_binlog_cache_size=512m</span><br></pre></td></tr></table></figure>

<p>创建日志目录，并赋予权限：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/<span class="built_in">local</span>/mysql/binlogs</span><br><span class="line">chown mysql.mysql /usr/<span class="built_in">local</span>/mysql/binlogs</span><br></pre></td></tr></table></figure>

<p>重启：</p>
<p>/etc/init.d/mysqld restart</p>
<p>如果省略 <code>server-id</code>（或将其显式设置为默认值0），则主服务器拒绝来自从服务器的任何连接。</p>
<p>为了在使用带事务的 <code>InnoDB</code> 进行复制设置时尽可能提高持久性和一致性，<br>您应该在master <code>my.cnf</code> 文件中使用以下配置项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">innodb_flush_log_at_trx_commit = 1</span><br><span class="line">sync_binlog = 1</span><br></pre></td></tr></table></figure>

<p>确保在主服务器上 <code>skip_networking</code> 选项处于 <code>OFF</code> 关闭状态, 这是默认值。<br>如果是启用的，则从站无法与主站通信，并且复制失败。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">&#x27;%skip_networking%&#x27;</span>;</span><br><span class="line">+-----------------+-------+</span><br><span class="line">| Variable_name   | Value |</span><br><span class="line">+-----------------+-------+</span><br><span class="line">| skip_networking | OFF   |</span><br><span class="line">+-----------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure>

<p><strong>从服务器配置</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my.cnf 文件</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line"></span><br><span class="line"><span class="comment">#要同步的数据库 (可选)</span></span><br><span class="line">binlog-do-db=<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#要生成二进制日志文件（可选）</span></span><br><span class="line">log-bin=mysql-bin</span><br></pre></td></tr></table></figure>

<p><strong>主服务器创建用于复制数据的用户</strong></p>
<p>语法：</p>
<p><code>grant 权限 on 数据库对象 to 用户</code></p>
<p><code>grant 权限1,权限2,…权限n on 数据库名称.表名称 to 用户名@用户地址 identified by ‘连接口令’ WITH GRANT OPTION;</code></p>
<p>示例：</p>
<p><code>GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;%&#39; IDENTIFIED BY &#39;123456&#39; WITH GRANT OPTION;</code></p>
<p>取消权限：<br><code>revoke all on *.* from root@localhost;</code></p>
<p>最后执行：<br><code>flush privileges</code>;</p>
<p><strong>GRANT：赋权命令</strong></p>
<p>ALL PRIVILEGES：当前用户的所有权限<br>ON：介词<br><em>.</em>：当前用户对所有数据库和表的相应操作权限<br>TO：介词<br>‘root’@’%’：权限赋给root用户，所有ip都能连接<br>IDENTIFIED BY ‘123456’：连接时输入密码，密码为123456<br>WITH GRANT OPTION：允许级联赋权，表示该用户可以将自己拥有的权限授权给别人。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 连接到mysql，输入密码</span></span><br><span class="line">mysql -uroot -h 127.0.0.1 -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line">create user <span class="string">&#x27;slave&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">CREATE USER <span class="string">&#x27;slave&#x27;</span>@<span class="string">&#x27;%&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置用户权限</span></span><br><span class="line"><span class="comment"># 授予复制账号 REPLICATION CLIENT 权限，复制用户可以使用 </span></span><br><span class="line"><span class="comment"># SHOW MASTER STATUS, SHOW SLAVE STATUS 和 SHOW BINARY LOGS来确定复制状态。</span></span><br><span class="line"><span class="comment"># 授予复制账号 REPLICATION SLAVE 权限，复制才能真正地工作。</span></span><br><span class="line">grant replication slave,replication client on *.* to <span class="string">&#x27;slave&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">GRANT REPLICATION SLAVE ON *.*  TO  <span class="string">&#x27;slave&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看用户</span></span><br><span class="line">select host,user from user;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新权限</span></span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看用户权限</span></span><br><span class="line">show grants <span class="keyword">for</span> <span class="string">&#x27;slave&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>备份主服务器数据</strong></p>
<p>使用 scp 或 rsync 等工具，把备份出来的数据传输到从服务器中。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入 mysql 安装目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/mysql/bin</span><br><span class="line"><span class="comment"># 如果不使用 --master-data 参数，则需要手动锁定单独会话中的所有表</span></span><br><span class="line">./mysqldump -u用户名 -p密码 --all-databases --master-data=1 &gt; dbdump.db</span><br><span class="line"><span class="comment"># 或 备份指定库</span></span><br><span class="line">./mysqldump -uroot -proot --databases db1 db2 &gt; dbdump.db</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"><span class="comment"># 1，加锁</span></span><br><span class="line">FLUSH TABLES WITH READ LOCK;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 将master中需要同步的db的数据dump出来</span></span><br><span class="line">./mysqldump -uroot -p testdb &gt; testdb.dump</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 将数据导入slave</span></span><br><span class="line">mysql -uroot -h192.123.75.69 -p testdb &lt; testdb.dump</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 解锁master</span></span><br><span class="line">UNLOCK TABLES;</span><br></pre></td></tr></table></figure>

<p><strong>从服务器开始复制</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录 主mysql</span></span><br><span class="line">mysql -uroot -h192.123.75.68 -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主服务器复制状态</span></span><br><span class="line">show master status\G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录从服务器</span></span><br><span class="line"><span class="comment"># 连接主服务器及设置复制的起始节点</span></span><br><span class="line">change master to master_host=<span class="string">&#x27;192.123.75.68&#x27;</span>,</span><br><span class="line">master_port=3306,</span><br><span class="line">master_user=<span class="string">&#x27;slave&#x27;</span>,</span><br><span class="line">master_password=<span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">master_log_file=<span class="string">&#x27;bin-log.000001&#x27;</span>,</span><br><span class="line">master_log_pos=154;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始复制</span></span><br><span class="line">start slave;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 从 复制状态</span></span><br><span class="line"><span class="comment"># 输出结果中应该看到 I/O 线程和 SQL 线程都是 YES, 就表示成功。</span></span><br><span class="line">show slave status \G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 主 复制状态</span></span><br><span class="line">show master status \G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据表数据</span></span><br><span class="line">mysql&gt; show create table user\G</span><br></pre></td></tr></table></figure>

<p><strong>设置从库只读</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前只读的状态</span></span><br><span class="line">SHOW VARIABLES LIKE <span class="string">&#x27;%read_only%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置普通用户只读</span></span><br><span class="line">SET GLOBAL read_only=1;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置超级用户只读</span></span><br><span class="line">SET GLOBAL super_read_only=1;</span><br></pre></td></tr></table></figure>

<p>复制相关命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止slave</span></span><br><span class="line">stop slave;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重置slave</span></span><br><span class="line">reset slave;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启slave</span></span><br><span class="line">start slave;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看主从服务器进程</span></span><br><span class="line">show processlist;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定线程类型单独 暂停I/O或SQL线程</span></span><br><span class="line">STOP SLAVE IO_THREAD;</span><br><span class="line">STOP SLAVE SQL_THREAD;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定线程类型单独 启动I/O或SQL线程</span></span><br><span class="line">START SLAVE IO_THREAD;</span><br><span class="line">START SLAVE SQL_THREAD;</span><br></pre></td></tr></table></figure>

<p><strong>查看 binlog 日志</strong></p>
<p><code>show binlog events\G</code></p>
<ul>
<li>Log_name 是二进制日志文件的名称，一个事件不能横跨两个文件</li>
<li>Pos 这是该事件在文件中的开始位置</li>
<li>Event_type 事件的类型，事件类型是给slave传递信息的基本方法，每个新的binlog都以Format_desc类型开始，以Rotate类型结束</li>
<li>Server_id 创建该事件的服务器id</li>
<li>End_log_pos 该事件的结束位置，也是下一个事件的开始位置，因此事件范围为 <code>Pos~End_log_pos - 1</code></li>
<li>Info 事件信息的可读文本，不同的事件有不同的信息</li>
</ul>
<h2 id="复制原理实现细节"><a href="#复制原理实现细节" class="headerlink" title="复制原理实现细节"></a>复制原理实现细节</h2><p>MySQL复制功能使用三个线程实现，一个在主服务器上，两个在从服务器上：</p>
<ul>
<li><p><strong>Binlog转储线程</strong> 主设备创建一个线程，以便在从设备连接时将二进制日志内容发送到从设备。可以 <code>SHOW PROCESSLIST</code> 在主服务器的输出中将此线程标识为 <code>Binlog Dump</code> 线程。</p>
<p>  二进制日志转储线程获取主机二进制日志上的锁，用于读取要发送到从机的每个事件。一旦读取了事件，即使在事件发送到从站之前，锁也会被释放。</p>
</li>
<li><p><strong>从属 I/O线程</strong> 在从属服务器上发出 <code>START SLAVE</code> 语句时，从属服务器会创建一个 <code>I/O</code> 线程，该线程连接到主服务器并要求主服务器发送其在二进制日志中的更新记录。</p>
<p>  从属 <code>I/O</code> 线程读取主 <code>Binlog Dump</code> 线程发送的更新，并将它们复制到包含从属中继日志的本地文件。</p>
<p>  此线程的状态显示为 <code>Slave_IO_running</code> 输出 <code>SHOW SLAVE STATUS</code> 或 <code>Slave_running</code> 输出中的状态 <code>SHOW STATUS</code> 。</p>
</li>
<li><p><strong>从属SQL线程</strong> 从属设备创建一个SQL线程来读取由从属 <code>I/O</code> 线程写入的中继日志，并执行其中包含的事件。</p>
<p>  当从属服务器从放的事件，追干上主服务器的事件后，从属服务器的 <code>I/O</code> 线程将会处于休眠状态，直到主服务器的事件有更新时，被主服务器发送的信号唤醒。</p>
<p>  每个 主/从 连接有三个线程。具有多个从站的主站为每个当前连接的从站创建一个二进制日志转储线程，每个从站都有自己的 <code>I/O</code>和SQL线程。</p>
</li>
</ul>
<p>从站使用两个线程将读取更新与主站分开并将它们执行到独立任务中。因此，如果语句执行缓慢，则不会减慢读取语句的任务。例如，如果从服务器尚未运行一段时间，则当从服务器启动时，其 <code>I/O</code> 线程可以快速从主服务器获取所有二进制日志内容，即使SQL线程远远落后。如果从服务器在SQL线程执行了所有获取的语句之前停止，则 <code>I/O</code> 线程至少已获取所有内容，以便语句的安全副本本地存储在从属的中继日志中，准备在下次执行时执行 <code>SLAVE</code>开始。</p>
<p>主服务器上，输入 <code>SHOW PROCESSLIST</code> 如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> processlist\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">     Id: <span class="number">69</span></span><br><span class="line">   <span class="keyword">User</span>: slave</span><br><span class="line">   Host: <span class="number">192.123</span><span class="number">.75</span><span class="number">.69</span>:<span class="number">55453</span></span><br><span class="line">     db: <span class="keyword">NULL</span></span><br><span class="line">Command: Binlog Dump</span><br><span class="line">   <span class="type">Time</span>: <span class="number">63184</span></span><br><span class="line">  State: Master has sent <span class="keyword">all</span> binlog <span class="keyword">to</span> slave; waiting <span class="keyword">for</span> more updates</span><br><span class="line">   Info: <span class="keyword">NULL</span></span><br></pre></td></tr></table></figure>

<p>该线程是 <code>Binlog Dump</code> 为连接的从属服务的复制线程。该 <code>State</code> 信息表明所有未完成的更新已发送到从站，并且主站正在等待更多更新发生。如果 <code>Binlog Dump</code> 在主服务器上看不到任何 线程，则表示复制未运行，说明目前没有连接任何从站。</p>
<h2 id="配置多线程复制"><a href="#配置多线程复制" class="headerlink" title="配置多线程复制"></a>配置多线程复制</h2><p>多线程复制在 5.6 中被引入，并且在 5.7 中得到了进一步的完善。5.7 中是基于逻辑时钟的方式进行的多线程复制。</p>
<h3 id="临时配置"><a href="#临时配置" class="headerlink" title="临时配置"></a>临时配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1，从库上查看默认的多线程复制类型</span></span><br><span class="line">mysql&gt; show variables like <span class="string">&quot;slave_parallel_type&quot;</span>;</span><br><span class="line">+---------------------+----------+</span><br><span class="line">| Variable_name       | Value    |</span><br><span class="line">+---------------------+----------+</span><br><span class="line">| slave_parallel_type | DATABASE |</span><br><span class="line">+---------------------+----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#2，停止之前可以查看目前的线程数</span></span><br><span class="line"></span><br><span class="line">show processlist;</span><br><span class="line">stop slave;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3，配置并发线程的方式</span></span><br><span class="line">mysql&gt; <span class="built_in">set</span> global slave_parallel_type = <span class="string">&quot;logical_clock&quot;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4，配置并发数量</span></span><br><span class="line">mysql&gt; <span class="built_in">set</span> global slave_parallel_workers = 4;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like <span class="string">&quot;slave_parallel_workers&quot;</span>;</span><br><span class="line">+------------------------+-------+</span><br><span class="line">| Variable_name          | Value |</span><br><span class="line">+------------------------+-------+</span><br><span class="line">| slave_parallel_workers | 16     |</span><br><span class="line">+------------------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5，启动从服务器的复制链路</span></span><br><span class="line">mysql&gt; start slave;</span><br></pre></td></tr></table></figure>

<h3 id="永久生效"><a href="#永久生效" class="headerlink" title="永久生效"></a>永久生效</h3><p>vim /usr/local/mysql/my.cnf</p>
<p>在 [mysqld] 下添加：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">slave-parallel-type=LOGICAL_CLOCK</span><br><span class="line">slave-parallel-workers=16</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">relay_log_recovery=ON</span><br></pre></td></tr></table></figure>

<p>重启mysql</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysqld restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">service mysqld restart</span><br></pre></td></tr></table></figure>

<p>验证：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show variables like <span class="string">&quot;slave_parallel_type&quot;</span>;</span><br><span class="line">show variables like <span class="string">&quot;slave_parallel_workers&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/faf0127f1cb2">Mysql 主从复制</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jb51.net/article/186349.htm">MySQL 主从复制原理与实践详解</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhoujinyi/p/4717951.html">MySQL5.6 新特性之GTID</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/langdashu/p/6125621.html">[MySQL] 号称永久解决了复制延迟问题的并行复制，MySQL5.7</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/08/17/iptables%E5%91%BD%E4%BB%A4-Linux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/17/iptables%E5%91%BD%E4%BB%A4-Linux/" class="post-title-link" itemprop="url">iptables命令-Linux</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-17 10:34:07" itemprop="dateCreated datePublished" datetime="2020-08-17T10:34:07+00:00">2020-08-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-16 08:30:45" itemprop="dateModified" datetime="2021-04-16T08:30:45+00:00">2021-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/" itemprop="url" rel="index"><span itemprop="name">Linux基础命令</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>iptables命令是Linux上常用的防火墙软件，是netfilter项目的一部分。可以直接配置，也可以通过许多前端和图形界面配置。</p>
<p><strong>语法</strong></p>
<p>iptables (选项) (参数)</p>
<p><strong>选项</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-t&lt;表&gt;：指定要操纵的表；</span><br><span class="line">-A：向规则链中添加条目；</span><br><span class="line">-D：从规则链中删除条目；</span><br><span class="line">-i：向规则链中插入条目；</span><br><span class="line">-R：替换规则链中的条目；</span><br><span class="line">-L：显示规则链中已有的条目；</span><br><span class="line">-F：清楚规则链中已有的条目；</span><br><span class="line">-Z：清空规则链中的数据包计算器和字节计数器；</span><br><span class="line">-N：创建新的用户自定义规则链；</span><br><span class="line">-P：定义规则链中的默认目标；</span><br><span class="line">-h：显示帮助信息；</span><br><span class="line">-p：指定要匹配的数据包协议类型；</span><br><span class="line">-s：指定要匹配的数据包源ip地址；</span><br><span class="line">-j&lt;目标&gt;：指定要跳转的目标；</span><br><span class="line">-i&lt;网络接口&gt;：指定数据包进入本机的网络接口；</span><br><span class="line">-o&lt;网络接口&gt;：指定数据包要离开本机所使用的网络接口。</span><br></pre></td></tr></table></figure>

<p>iptables命令选项输入顺序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t 表名 &lt;-A&#x2F;I&#x2F;D&#x2F;R&gt; 规则链名 [规则号] &lt;-i&#x2F;o 网卡名&gt; -p 协议名 &lt;-s 源IP&#x2F;源子网&gt; --sport 源端口 &lt;-d 目标IP&#x2F;目标子网&gt; --dport 目标端口 -j 动作</span><br></pre></td></tr></table></figure>

<p><strong>表名包括：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">raw：高级功能，如：网址过滤。</span><br><span class="line">mangle：数据包修改（QOS），用于实现服务质量。</span><br><span class="line">net：地址转换，用于网关路由器。</span><br><span class="line">filter：包过滤，用于防火墙规则。</span><br></pre></td></tr></table></figure>

<p><strong>规则链名包括：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INPUT链：处理输入数据包。</span><br><span class="line">OUTPUT链：处理输出数据包。</span><br><span class="line">PORWARD链：处理转发数据包。</span><br><span class="line">PREROUTING链：用于目标地址转换（DNAT）。</span><br><span class="line">POSTOUTING链：用于源地址转换（SNAT）。</span><br></pre></td></tr></table></figure>

<p><strong>动作包括：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">accept：接收数据包。</span><br><span class="line">DROP：丢弃数据包。</span><br><span class="line">REDIRECT：重定向、映射、透明代理。</span><br><span class="line">SNAT：源地址转换。</span><br><span class="line">DNAT：目标地址转换。</span><br><span class="line">MASQUERADE：IP伪装（NAT），用于ADSL。</span><br><span class="line">LOG：日志记录。</span><br></pre></td></tr></table></figure>

<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p><strong>清除已有iptables规则</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br><span class="line">iptables -X</span><br><span class="line">iptables -Z</span><br></pre></td></tr></table></figure>

<p><strong>开放指定的端口</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT               <span class="comment">#允许本地回环接口(即运行本机访问本机)</span></span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT    <span class="comment">#允许已建立的或相关连的通行</span></span><br><span class="line">iptables -A OUTPUT -j ACCEPT         <span class="comment">#允许所有本机向外的访问</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -j ACCEPT    <span class="comment">#允许访问22端口</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 80 -j ACCEPT    <span class="comment">#允许访问80端口</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 21 -j ACCEPT    <span class="comment">#允许ftp服务的21端口</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 20 -j ACCEPT    <span class="comment">#允许FTP服务的20端口</span></span><br><span class="line">iptables -A INPUT -j reject       <span class="comment">#禁止其他未允许的规则访问</span></span><br><span class="line">iptables -A FORWARD -j REJECT     <span class="comment">#禁止其他未允许的规则访问</span></span><br></pre></td></tr></table></figure>

<p><strong>屏蔽IP</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -s 123.45.6.7 -j DROP       <span class="comment">#屏蔽单个IP的命令</span></span><br><span class="line">iptables -I INPUT -s 123.0.0.0/8 -j DROP      <span class="comment">#封整个段即从123.0.0.1到123.255.255.254的命令</span></span><br><span class="line">iptables -I INPUT -s 124.45.0.0/16 -j DROP    <span class="comment">#封IP段即从123.45.0.1到123.45.255.254的命令</span></span><br><span class="line">iptables -I INPUT -s 123.45.6.0/24 -j DROP    <span class="comment">#封IP段即从123.45.6.1到123.45.6.254的命令是</span></span><br></pre></td></tr></table></figure>

<p><strong>查看已添加的iptables规则</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -L -n -v</span><br></pre></td></tr></table></figure>

<p><strong>删除已添加的iptables规则</strong></p>
<p>将所有iptables以序号标记显示，执行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -L -n --line-numbers</span><br></pre></td></tr></table></figure>

<p>比如要删除INPUT里序号为8的规则，执行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -D INPUT 8</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://man.linuxde.net/iptables">iptables命令</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/08/15/MinIo-CentOS7%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/15/MinIo-CentOS7%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">MinIo-CentOS7离线安装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-15 08:49:05" itemprop="dateCreated datePublished" datetime="2020-08-15T08:49:05+00:00">2020-08-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-16 08:30:45" itemprop="dateModified" datetime="2021-04-16T08:30:45+00:00">2021-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MinIo/" itemprop="url" rel="index"><span itemprop="name">MinIo</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>下载离线包：</p>
<p><a target="_blank" rel="noopener" href="https://dl.min.io/server/minio/release/linux-amd64/minio">https://dl.min.io/server/minio/release/linux-amd64/minio</a></p>
<p>或者使用命令下载（需要接入互联网）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.min.io/server/minio/release/linux-amd64/minio</span><br></pre></td></tr></table></figure>

<p><strong>移动到/usr/local/minio文件夹</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /usr/<span class="built_in">local</span>/minio/bin</span><br><span class="line">cp /ldjc/rj/minio /usr/<span class="built_in">local</span>/minio/bin</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/minio/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加执行权限</span></span><br><span class="line">chmod +x minio</span><br></pre></td></tr></table></figure>

<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>命令格式：</p>
<p><code>./minio -C \&quot;$&#123;minio_config&#125;\&quot; server --address=\&quot;$&#123;minio_address&#125;\&quot; $&#123;minio_disks&#125;</code></p>
<p>-C：配置文件</p>
<h3 id="终端方式启动"><a href="#终端方式启动" class="headerlink" title="终端方式启动"></a>终端方式启动</h3><p>进入到软件包所在目录：</p>
<p>终端启动，这种方式关闭终端，服务会停止。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /ldjc/rj</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> MINIO_ACCESS_KEY=admin</span><br><span class="line"><span class="built_in">export</span> MINIO_SECRET_KEY=<span class="built_in">test</span></span><br><span class="line">./minio server -C minio.conf /ldjc/minio/data --address :9010</span><br></pre></td></tr></table></figure>

<p>后台运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /ldjc/rj</span><br><span class="line"><span class="built_in">export</span> MINIO_ACCESS_KEY=admin</span><br><span class="line"><span class="built_in">export</span> MINIO_SECRET_KEY=<span class="built_in">test</span></span><br><span class="line">nohup ./minio server -C minio.conf /ldjc/minio/data --address 192.125.30.71:9010</span><br><span class="line">nohup ./minio server -C minio.conf /ldjc/minio/data --address :9010</span><br></pre></td></tr></table></figure>

<h3 id="配置文件启动"><a href="#配置文件启动" class="headerlink" title="配置文件启动"></a>配置文件启动</h3><p><strong>新建配置文件</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/minio</span><br><span class="line">touch minio.conf</span><br><span class="line">vi minio.conf </span><br></pre></td></tr></table></figure>

<p>配置文件内容：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MINIO_ACCESS_KEY=admin</span><br><span class="line">MINIO_SECRET_KEY=admin</span><br><span class="line">MINIO_VOLUMES=<span class="string">&quot;/test/minio/data&quot;</span></span><br><span class="line">MINIO_OPTS=<span class="string">&quot; --address 192.125.31.71:9010&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>新建服务</strong></p>
<p>在 <code>/etc/systemd/system</code>,新建一个 <code>minio.service</code> :</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch /etc/systemd/system/minio.service</span><br><span class="line">vim /etc/systemd/system/minio.service</span><br></pre></td></tr></table></figure>

<p>参考：<a target="_blank" rel="noopener" href="https://github.com/minio/minio-service/blob/master/linux-systemd/minio.service">linux-systemd/minio.service</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=MinIO</span><br><span class="line">Documentation=https://docs.min.io</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line">AssertFileIsExecutable=/usr/<span class="built_in">local</span>/minio/bin/minio</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/usr/<span class="built_in">local</span>/</span><br><span class="line"></span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line"></span><br><span class="line">EnvironmentFile=/usr/<span class="built_in">local</span>/minio/minio.conf</span><br><span class="line">ExecStartPre=/bin/bash -c <span class="string">&quot;if [ -z \&quot;<span class="variable">$&#123;MINIO_VOLUMES&#125;</span>\&quot; ]; then echo \&quot;Variable MINIO_VOLUMES not set in /etc/default/minio\&quot;; exit 1; fi&quot;</span></span><br><span class="line"></span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/minio/bin/minio server <span class="variable">$MINIO_OPTS</span> <span class="variable">$MINIO_VOLUMES</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Let systemd restart this service always</span></span><br><span class="line">Restart=always</span><br><span class="line"></span><br><span class="line"><span class="comment"># Specifies the maximum file descriptor number that can be opened by this process</span></span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable timeout logic and wait until process is stopped</span></span><br><span class="line">TimeoutStopSec=infinity</span><br><span class="line">SendSIGKILL=no</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># Built for $&#123;project.name&#125;-$&#123;project.version&#125; ($&#123;project.name&#125;)</span></span><br></pre></td></tr></table></figure>

<p><strong>启动服务</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> minio.service</span><br><span class="line">systemctl start minio.service</span><br><span class="line">systemctl stop minio.service</span><br><span class="line">systemctl status minio.service</span><br><span class="line"></span><br><span class="line">systemctl restart minio.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新服务文件后，需要重新加载</span></span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>

<h3 id="查看进程"><a href="#查看进程" class="headerlink" title="查看进程"></a>查看进程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看端口</span></span><br><span class="line">netstat -tunpl | grep 9010</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看进程</span></span><br><span class="line">ps aux | grep minio</span><br></pre></td></tr></table></figure>

<h2 id="TLS"><a href="#TLS" class="headerlink" title="TLS"></a>TLS</h2><p>详细信息请参考官网：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/how-to-secure-access-to-minio-server-with-tls.html">How to secure access to MinIO server with TLS</a></p>
<h3 id="生成域名证书"><a href="#生成域名证书" class="headerlink" title="生成域名证书"></a>生成域名证书</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out private-pkcs8-key.key 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用下面命令给证书加上密码</span></span><br><span class="line">openssl genrsa -aes256 -passout pass:123456 -out private-pkcs8-key.key 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果设置密码 启动minio的时候，需要设置证书密码</span></span><br><span class="line"><span class="built_in">export</span> MINIO_CERT_PASSWD=&lt;123456&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 私有加密密钥的默认 OpenSSL 格式为 PKCS-8，但 MinIO 仅支持 PKCS-1</span></span><br><span class="line"><span class="comment"># pkcs8 转 pkcs1</span></span><br><span class="line">openssl rsa -<span class="keyword">in</span> private-pkcs8-key.key -aes256 -passout pass:123456 -out private.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成自签名证书</span></span><br><span class="line"><span class="comment"># 注：domain.com，需要替换成自己的域名</span></span><br><span class="line">openssl req -new -x509 -days 3650 -key private.key -out public.crt -subj <span class="string">&quot;/C=US/ST=state/L=location/O=organization/CN=&lt;domain.com&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用下面的命令生成自签名通配符证书，该证书该所有子域名都有效。</span></span><br><span class="line">openssl req -new -x509 -days 3650 -key private.key -out public.crt -subj <span class="string">&quot;/C=US/ST=state/L=location/O=organization/CN=&lt;*.domain.com&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="生成IP证书"><a href="#生成IP证书" class="headerlink" title="生成IP证书"></a>生成IP证书</h3><p>生成配置文件 openssl.conf</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[req]</span><br><span class="line">distinguished_name = req_distinguished_name</span><br><span class="line">x509_extensions = v3_req</span><br><span class="line">prompt = no</span><br><span class="line"></span><br><span class="line">[req_distinguished_name]</span><br><span class="line">C = US</span><br><span class="line">ST = VA</span><br><span class="line">L = Somewhere</span><br><span class="line">O = MyOrg</span><br><span class="line">OU = MyOU</span><br><span class="line">CN = MyServerName</span><br><span class="line"></span><br><span class="line">[v3_req]</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[alt_names]</span><br><span class="line">IP.1 = 127.0.0.1</span><br></pre></td></tr></table></figure>

<p>使用配置文件生成证书：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -nodes -days 730 -newkey rsa:2048 -keyout private.key -out public.crt -config openssl.conf</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/3e81b87d5b0b">Minio 文件服务（1）—— Minio部署使用及存储机制分析</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.min.io/docs/minio-server-configuration-guide.html">MinIO Server Config Guide </a></p>
<p><a target="_blank" rel="noopener" href="https://docs.minio.io/docs/how-to-run-minio-in-freenas.html">How to run MinIO in FreeNAS</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/08/11/Mysql5.7.X%E4%BF%AE%E6%94%B9sql_mode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/11/Mysql5.7.X%E4%BF%AE%E6%94%B9sql_mode/" class="post-title-link" itemprop="url">Mysql5.7.X修改sql_mode</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-11 14:40:26" itemprop="dateCreated datePublished" datetime="2020-08-11T14:40:26+00:00">2020-08-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-16 08:30:45" itemprop="dateModified" datetime="2021-04-16T08:30:45+00:00">2021-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySql/" itemprop="url" rel="index"><span itemprop="name">MySql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>5.7 以及之后的版本中会遇到这样的错误:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Expression #2 of SELECT list is not in GROUP BY clause and contains nonaggregated column &#39;name&#39; which is not functionally dependent on columns in GROUP BY clause;</span><br><span class="line">this is incompatible with sql_mode&#x3D;only_full_group_by</span><br><span class="line"></span><br><span class="line">Expression #1 of ORDER BY clause is not in SELECT list, references column &#39;sort&#39; which is not in SELECT list; this is incompatible with DISTINCT</span><br></pre></td></tr></table></figure>

<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>mysql 5.7版本默认的sql配置是:sql_mode=”ONLY_FULL_GROUP_BY”，这个配置严格执行了”SQL92标准”。</p>
<p>查看sql_mode的语句:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> @<span class="variable">@GLOBAL</span>.sql_mode;</span><br><span class="line"></span><br><span class="line">##输出：</span><br><span class="line">ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span><br></pre></td></tr></table></figure>

<p>很多从5.6升级到5.7时，为了语法兼容，大部分都会选择调整sql_mode，使其保持跟5.6一致，为了尽量兼容程序。</p>
<p>原因分析：<br>再输出的结果 <code>target list</code> 中，即select后面跟着的字段，还有一个地方 <code>group by column</code>，就是 group by后面跟着的字段。由于开启了 <code>ONLY_FULL_GROUP_BY</code> 的设置，所以如果一个字段没有在 <code>target list</code><br>和 <code>group by</code> 字段中同时出现，或者是聚合函数的值的话，那么这条sql查询是被mysql认为非法的，会报错误。</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><h3 id="暂时修改sql-mode"><a href="#暂时修改sql-mode" class="headerlink" title="暂时修改sql_mode"></a>暂时修改sql_mode</h3><p>重启mysql数据库服务之后，ONLY_FULL_GROUP_BY还会出现。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> @<span class="variable">@GLOBAL</span>.sql_mode<span class="operator">=</span>STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span><br></pre></td></tr></table></figure>

<h3 id="修改mysql配置文件"><a href="#修改mysql配置文件" class="headerlink" title="修改mysql配置文件"></a>修改mysql配置文件</h3><p>修改 mysql 配置文件，<code>/usr/local/mysql/my.cnf</code>,添加如下代码，之后重启mysql服务。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#主要需要添加到 [mysql] [mysqld] 标签下，加入到其他地方，即使重启后也不生效。</span></span><br><span class="line">sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span><br></pre></td></tr></table></figure>

<p>重启：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysqld restart</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42175986/article/details/82384160">5分钟学会MySQL-this is incompatible with sql_mode=only_full_group_by错误解决方案</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/feinifi/article/details/54135310">mysql5.7.x:this is incompatible with DISTINCT</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/08/11/%E8%B7%A8%E5%9F%9F%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%ABCORS%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/11/%E8%B7%A8%E5%9F%9F%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%ABCORS%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">跨域资源共享CORS笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-11 14:01:20" itemprop="dateCreated datePublished" datetime="2020-08-11T14:01:20+00:00">2020-08-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-16 08:30:45" itemprop="dateModified" datetime="2021-04-16T08:30:45+00:00">2021-04-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>转载：</p>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/04/cors.html">跨域资源共享 CORS 详解</a></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>CORS是一个W3C标准，全称是”跨域资源共享”（Cross-origin resource sharing）。</p>
<p>它允许浏览器向跨源服务器，发出XMLHttpRequest请求，从而克服了AJAX只能同源使用的限制。</p>
<p>CORS需要浏览器和服务器同时支持。目前，所有浏览器都支持该功能，IE浏览器不能低于IE10。</p>
<p>整个CORS通信过程，都是浏览器自动完成，不需要用户参与。对于开发者来说，CORS通信与同源的AJAX通信没有差别，代码完全一样。浏览器一旦发现AJAX请求跨源，就会自动添加一些附加的头信息，有时还会多出一次附加的请求，但用户不会有感觉。</p>
<p>因此，实现CORS通信的关键是服务器。只要服务器实现了CORS接口，就可以跨源通信。</p>
<h2 id="与JSONP的比较"><a href="#与JSONP的比较" class="headerlink" title="与JSONP的比较"></a>与JSONP的比较</h2><p><code>CORS</code> 与 <code>JSONP</code> 的使用目的相同，但是比 <code>JSONP</code> 更强大。</p>
<p><code>JSONP</code> 只支持 <code>GET</code> 请求，<code>CORS</code> 支持所有类型的 <code>HTTP</code> 请求。<code>JSONP</code> 的优势在于支持老式浏览器，以及可以向不支持 <code>CORS</code> 的网站请求数据。</p>
<h2 id="两种请求"><a href="#两种请求" class="headerlink" title="两种请求"></a>两种请求</h2><p>浏览器将 <code>CORS</code> 请求分成两类：</p>
<p>简单请求（simple request）和 非简单请求（not-so-simple request）。</p>
<p>只要同时满足以下两大条件，就属于简单请求。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2.请求方法是以下三种方法之一：</span><br><span class="line">HEAD</span><br><span class="line">GET</span><br><span class="line">POST</span><br><span class="line"></span><br><span class="line">2.HTTP的头信息不超出以下几种字段：</span><br><span class="line">Accept</span><br><span class="line">Accept-Language</span><br><span class="line">Content-Language</span><br><span class="line">Last-Event-ID</span><br><span class="line">Content-Type：只限于三个值application/x-www-form-urlencoded、multipart/form-data、text/plain</span><br></pre></td></tr></table></figure>

<p>这是为了兼容表单（form），因为历史上表单一直可以发出跨域请求。<code>AJAX</code> 的跨域设计就是，只要表单可以发，<code>AJAX</code> 就可以直接发。</p>
<p>凡是不同时满足上面两个条件，就属于非简单请求。</p>
<p>浏览器对这两种请求的处理，是不一样的。</p>
<h3 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h3><p>浏览器直接发出 <code>CORS</code> 请求。具体来说，就是在头信息之中，增加一个 <code>Origin</code> 字段。</p>
<p>下面是一个例子，浏览器发现这次跨源 <code>AJAX</code> 请求是简单请求，就自动在头信息之中，添加一个Origin字段。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /cors HTTP/<span class="number">1.1</span></span><br><span class="line">Origin: http:<span class="comment">//api.bob.com</span></span><br><span class="line">Host: api.alice.com</span><br><span class="line">Accept-Language: en-US</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span>...</span><br></pre></td></tr></table></figure>

<p><code>Origin</code> 字段用来说明，本次请求来自哪个源（协议 + 域名 + 端口）。服务器根据这个值，决定是否同意这次请求。</p>
<p>如果Origin指定的源，不在许可范围内，服务器会返回一个正常的HTTP回应。浏览器发现，这个回应的头信息没有包含 <code>Access-Control-Allow-Origin</code> 字段，就知道出错了，从而抛出一个错误，被 <code>XMLHttpRequest</code> 的onerror回调函数捕获。注意，这种错误无法通过状态码识别，因为HTTP回应的状态码有可能是200。</p>
<p>如果Origin指定的域名在许可范围内，服务器返回的响应，会多出几个头信息字段，都以 <code>Access-Control-</code> 开头。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin: http:<span class="comment">//api.bob.com</span></span><br><span class="line">Access-Control-Allow-Credentials: <span class="literal">true</span></span><br><span class="line">Access-Control-Expose-Headers: FooBar</span><br><span class="line">Content-Type: text/html; charset=utf-<span class="number">8</span></span><br></pre></td></tr></table></figure>

<p><strong>Access-Control-Allow-Origin</strong></p>
<p>该字段是必须的。它的值要么是请求时 <code>Origin</code> 字段的值，要么是一个*，表示接受任意域名的请求。</p>
<p><strong>Access-Control-Allow-Credentials</strong></p>
<p>该字段可选。它的值是一个布尔值，表示是否允许发送Cookie。默认情况下，Cookie不包括在CORS请求之中。设为true，即表示服务器明确许可，Cookie可以包含在请求中，一起发给服务器。这个值也只能设为true，如果服务器不要浏览器发送Cookie，删除该字段即可。</p>
<p><strong>Access-Control-Expose-Headers</strong></p>
<p>该字段可选。CORS请求时，<code>XMLHttpRequest</code> 对象的getResponseHeader()方法只能拿到6个基本字段：<code>Cache-Control</code>、<code>Content-Language</code>、<code>Content-Type</code>、<code>Expires</code>、<code>Last-Modified</code>、<code>Pragma</code>。如果想拿到其他字段，就必须在 <code>Access-Control-Expose-Headers</code> 里面指定。上面的例子指定，getResponseHeader(‘FooBar’)可以返回FooBar字段的值。</p>
<p><strong>withCredentials 属性</strong></p>
<p>CORS请求默认不发送Cookie和HTTP认证信息。如果要把Cookie发到服务器，一方面要服务器同意，指定</p>
<p><code>Access-Control-Allow-Credentials</code> 字段。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Credentials: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>另一方面，开发者必须在AJAX请求中打开 <code>withCredentials</code> 属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.withCredentials = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p>否则，即使服务器同意发送Cookie，浏览器也不会发送。或者，服务器要求设置Cookie，浏览器也不会处理。</p>
<p>但是，如果省略 <code>withCredentials</code> 设置，有的浏览器还是会一起发送Cookie。这时，可以显式关闭 <code>withCredentials</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xhr.withCredentials = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<p>需要注意的是，如果要发送Cookie，<code>Access-Control-Allow-Origin</code> 就不能设为星号，必须指定明确的、与请求网页一致的域名。同时，Cookie依然遵循同源政策，只有用服务器域名设置的Cookie才会上传，其他域名的Cookie并不会上传，且（跨源）原网页代码中的document.cookie也无法读取服务器域名下的Cookie。</p>
<h3 id="非简单请求"><a href="#非简单请求" class="headerlink" title="非简单请求"></a>非简单请求</h3><h4 id="预检请求"><a href="#预检请求" class="headerlink" title="预检请求"></a>预检请求</h4><p>非简单请求是那种对服务器有特殊要求的请求，比如请求方法是 <code>PUT</code> 或 <code>DELETE</code> ，或者 <code>Content-Type</code> 字段的类型是 <code>application/json</code>。</p>
<p>非简单请求的CORS请求，会在正式通信之前，增加一次HTTP查询请求，称为”预检”请求（preflight）。</p>
<p>浏览器先询问服务器，当前网页所在的域名是否在服务器的许可名单之中，以及可以使用哪些HTTP动词和头信息字段。只有得到肯定答复，浏览器才会发出正式的 <code>XMLHttpRequest</code> 请求，否则就报错。</p>
<p>下面是一段浏览器的JavaScript脚本。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url = <span class="string">&#x27;http://api.alice.com/cors&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.open(<span class="string">&#x27;PUT&#x27;</span>, url, <span class="literal">true</span>);</span><br><span class="line">xhr.setRequestHeader(<span class="string">&#x27;X-Custom-Header&#x27;</span>, <span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure>

<p>上面代码中，HTTP请求的方法是PUT，并且发送一个自定义头信息 <code>X-Custom-Header</code>。</p>
<p>浏览器发现，这是一个非简单请求，就自动发出一个”预检”请求，要求服务器确认可以这样请求。下面是这个”预检”请求的HTTP头信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS /cors HTTP/<span class="number">1.1</span></span><br><span class="line">Origin: http:<span class="comment">//api.bob.com</span></span><br><span class="line">Access-Control-Request-Method: PUT</span><br><span class="line">Access-Control-Request-Headers: X-Custom-Header</span><br><span class="line">Host: api.alice.com</span><br><span class="line">Accept-Language: en-US</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span>...</span><br></pre></td></tr></table></figure>

<p>“预检”请求用的请求方法是 <code>OPTIONS</code>，表示这个请求是用来询问的。头信息里面，关键字段是Origin，表示请求来自哪个源。</p>
<p>除了 <code>Origin</code> 字段，”预检”请求的头信息包括两个特殊字段。</p>
<p><strong>Access-Control-Request-Method</strong></p>
<p>该字段是必须的，用来列出浏览器的 <code>CORS</code> 请求会用到哪些HTTP方法，上例是PUT。</p>
<p><strong>Access-Control-Request-Headers</strong></p>
<p>该字段是一个逗号分隔的字符串，指定浏览器CORS请求会额外发送的头信息字段，上例是 <code>X-Custom-Header</code> 。</p>
<h4 id="预检请求的回应"><a href="#预检请求的回应" class="headerlink" title="预检请求的回应"></a>预检请求的回应</h4><p>服务器收到”预检”请求以后，检查了 <code>Origin</code>、<code>Access-Control-Request-Method</code> 和 <code>Access-Control-Request-Headers</code> 字段以后，确认允许跨源请求，就可以做出回应。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="built_in">Date</span>: Mon, <span class="number">01</span> Dec <span class="number">2008</span> <span class="number">01</span>:<span class="number">15</span>:<span class="number">39</span> GMT</span><br><span class="line">Server: Apache/<span class="number">2.0</span><span class="number">.61</span> (Unix)</span><br><span class="line">Access-Control-Allow-Origin: http:<span class="comment">//api.bob.com</span></span><br><span class="line">Access-Control-Allow-Methods: GET, POST, PUT</span><br><span class="line">Access-Control-Allow-Headers: X-Custom-Header</span><br><span class="line">Content-Type: text/html; charset=utf-<span class="number">8</span></span><br><span class="line">Content-Encoding: gzip</span><br><span class="line">Content-Length: <span class="number">0</span></span><br><span class="line">Keep-Alive: timeout=<span class="number">2</span>, max=<span class="number">100</span></span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Content-Type: text/plain</span><br></pre></td></tr></table></figure>

<p>上面的HTTP回应中，关键的是 <code>Access-Control-Allow-Origin</code> 字段，表示 <code>http://api.bob.com</code> 可以请求数据。该字段也可以设为星号，表示同意任意跨源请求。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin: *</span><br></pre></td></tr></table></figure>

<p>如果服务器否定了”预检”请求，会返回一个正常的HTTP回应，但是没有任何 <code>CORS</code> 相关的头信息字段。这时，浏览器就会认定，服务器不同意预检请求，因此触发一个错误，被 <code>XMLHttpRequest</code> 对象的 <code>onerror</code> 回调函数捕获。控制台会打印出如下的报错信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">XMLHttpRequest cannot load http:<span class="comment">//api.alice.com.</span></span><br><span class="line">Origin http:<span class="comment">//api.bob.com is not allowed by Access-Control-Allow-Origin.</span></span><br></pre></td></tr></table></figure>

<p>服务器回应的其他 <code>CORS</code> 相关字段如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Methods: GET, POST, PUT</span><br><span class="line">Access-Control-Allow-Headers: X-Custom-Header</span><br><span class="line">Access-Control-Allow-Credentials: <span class="literal">true</span></span><br><span class="line">Access-Control-Max-Age: <span class="number">1728000</span></span><br></pre></td></tr></table></figure>

<p><strong>Access-Control-Allow-Methods</strong></p>
<p>该字段必需，它的值是逗号分隔的一个字符串，表明服务器支持的所有跨域请求的方法。注意，返回的是所有支持的方法，而不单是浏览器请求的那个方法。这是为了避免多次”预检”请求。</p>
<p><strong>Access-Control-Allow-Headers</strong></p>
<p>如果浏览器请求包括 <code>Access-Control-Request-Headers</code> 字段，则 <code>Access-Control-Allow-Headers</code> 字段是必需的。它也是一个逗号分隔的字符串，表明服务器支持的所有头信息字段，不限于浏览器在”预检”中请求的字段。</p>
<p><strong>Access-Control-Allow-Credentials</strong></p>
<p>该字段与简单请求时的含义相同。</p>
<p><strong>Access-Control-Max-Age</strong></p>
<p>该字段可选，用来指定本次预检请求的有效期，单位为秒。上面结果中，有效期是20天（1728000秒），即允许缓存该条回应1728000秒（即20天），在此期间，不用发出另一条预检请求。</p>
<h4 id="浏览器的正常请求和回应"><a href="#浏览器的正常请求和回应" class="headerlink" title="浏览器的正常请求和回应"></a>浏览器的正常请求和回应</h4><p>一旦服务器通过了”预检”请求，以后每次浏览器正常的CORS请求，就都跟简单请求一样，会有一个 <code>Origin</code> 头信息字段。服务器的回应，也都会有一个 <code>Access-Control-Allow-Origin</code> 头信息字段。</p>
<p>下面是”预检”请求之后，浏览器的正常CORS请求。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /cors HTTP/<span class="number">1.1</span></span><br><span class="line">Origin: http:<span class="comment">//api.bob.com</span></span><br><span class="line">Host: api.alice.com</span><br><span class="line">X-Custom-Header: value</span><br><span class="line">Accept-Language: en-US</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span>...</span><br></pre></td></tr></table></figure>

<p>上面头信息的Origin字段是浏览器自动添加的。</p>
<p>下面是服务器正常的回应。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin: http:<span class="comment">//api.bob.com</span></span><br><span class="line">Content-Type: text/html; charset=utf-<span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>上面头信息中，<code>Access-Control-Allow-Origin</code> 字段是每次回应都必定包含的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/08/06/Linux%20Crontab%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/06/Linux%20Crontab%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">Linux Crontab定时任务详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-06 17:38:28" itemprop="dateCreated datePublished" datetime="2020-08-06T17:38:28+00:00">2020-08-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-16 08:30:45" itemprop="dateModified" datetime="2021-04-16T08:30:45+00:00">2021-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Crontab/" itemprop="url" rel="index"><span itemprop="name">Crontab</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Linux-crontab简介"><a href="#Linux-crontab简介" class="headerlink" title="Linux crontab简介"></a>Linux crontab简介</h2><p>Linux crontab是用来定期执行程序的命令。<br>当安装完成操作系统之后，默认便会启动此任务调度命令。</p>
<p>注意：新创建的 cron 任务，不会马上执行，至少要过 2 分钟后才可以，当然你可以重启 cron 来马上执行。</p>
<p>crontab命令用于设置周期性被执行的指令。该命令从标准输入设备读取指令，并将其存放于 <code>/etc/crontab</code> 文件中，以供之后读取和执行。</p>
<p>cron 系统调度进程。 可以使用它在每天的非高峰负荷时间段运行作业，或在一周或一月中的不同时段运行。cron是系统主要的调度进程，可以在无需人工干预的情况下运行作业。crontab命令允许用户提交、编辑或删除相应的作业。每一个用户都可以有一个crontab文件来保存调度信息。</p>
<p>linux 任务调度的工作主要分为以下两类：</p>
<p>1、系统执行的工作：系统周期性所要执行的工作，如备份系统数据、清理缓存<br>2、个人执行的工作：某个用户定期要做的工作，例如每隔10分钟检查邮件服务器是否有新信，这些工作可由每个用户自行设置</p>
<h2 id="crontab-命令"><a href="#crontab-命令" class="headerlink" title="crontab 命令"></a>crontab 命令</h2><p>crontab命令是 <code>cron table</code> 的简写，它是 cron 的配置文件，也可以叫它作业列表，我们可以在以下文件夹内找到相关配置文件。</p>
<p><code>/var/spool/cron/</code> 目录下存放的是每个用户包括root的crontab任务，每个任务以创建者的名字命名<br><code>/etc/crontab</code> 这个文件负责调度各种管理和维护任务。<br><code>/etc/cron.d/</code> 这个目录用来存放任何要执行的crontab文件或脚本。</p>
<p><strong><code>/etc/crontab</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">more /etc/crontab</span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line"></span><br><span class="line"><span class="comment"># For details see man 4 crontabs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example of job definition:</span></span><br><span class="line"><span class="comment"># .---------------- minute (0 - 59)</span></span><br><span class="line"><span class="comment"># |  .------------- hour (0 - 23)</span></span><br><span class="line"><span class="comment"># |  |  .---------- day of month (1 - 31)</span></span><br><span class="line"><span class="comment"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span></span><br><span class="line"><span class="comment"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span></span><br><span class="line"><span class="comment"># |  |  |  |  |</span></span><br><span class="line"><span class="comment"># *  *  *  *  * user-name  command to be executed</span></span><br></pre></td></tr></table></figure>

<p><strong><code>/var/spool/cron</code></strong></p>
<p>每个用户都会生成一个自动生成一个自己的 <code>crontab</code> 文件，一般位于 <code>/var/spool/cron</code> 目录下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/spool/cron</span><br></pre></td></tr></table></figure>

<p>如果你用命令 <code>crontab -r</code> 就会删除当前用户的crontab文件，例如你切换到oracle账号下，执行了该命令，那么 <code>/var/spool/cron/oracle</code> 文件就会删除，如果要创建该文件只需要用 <code>crontab -e</code> 命令即可。注意，普通用户一般没有权限访问 <code>/var/spool/cron</code></p>
<p>我们还可以把脚本放在 <code>/etc/cron.hourly</code>、<code>/etc/cron.daily</code>、<code>/etc/cron.weekly</code>、<code>/etc/cron.monthly</code> 目录中，让它每小时/天/星期、月执行一次。</p>
<p>系统管理员可以通过 cron.deny 和 cron.allow 这两个文件来禁止或允许用户拥有自己的crontab文件。</p>
<p><code>/etc/cron.deny</code> 表示不能使用 <code>crontab</code> 命令的用户</p>
<p><code>/etc/cron.allow</code> 表示能使用 <code>crontab</code> 的用户。</p>
<p>默认情况下，<code>cron.allow</code> 文件不存在。如果两个文件同时存在，那么 <code>/etc/cron.allow</code> 优先。如果两个文件都不存在，那么只有超级用户可以安排作业。</p>
<p><strong><code>ls -lrt cron*</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ls -lrt cron*</span><br><span class="line">-rw-r--r--. 1 root root 451 6月  10 2014 crontab</span><br><span class="line">-rw-------. 1 root root   0 11月 20 2018 cron.deny</span><br><span class="line"></span><br><span class="line">cron.weekly:</span><br><span class="line">总用量 0</span><br><span class="line"></span><br><span class="line">cron.monthly:</span><br><span class="line">总用量 0</span><br><span class="line"></span><br><span class="line">cron.hourly:</span><br><span class="line">总用量 4</span><br><span class="line">-rwxr-xr-x. 1 root root 392 11月 20 2018 0anacron</span><br><span class="line"></span><br><span class="line">cron.daily:</span><br><span class="line">总用量 8</span><br><span class="line">-rwxr-xr-x. 1 root root 618 10月 30 2018 man-db.cron</span><br><span class="line">-rwx------. 1 root root 219 10月 31 2018 logrotate</span><br><span class="line"></span><br><span class="line">cron.d:</span><br><span class="line">总用量 4</span><br><span class="line">-rw-r--r--. 1 root root 128 11月 20 2018 0hourl</span><br></pre></td></tr></table></figure>

<h2 id="CRONTAB在线手册"><a href="#CRONTAB在线手册" class="headerlink" title="CRONTAB在线手册"></a>CRONTAB在线手册</h2><p>注意：不同版本的Linux系统，可能crontab手册内容有所出入，请以实际版本为准。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man crontab | more</span><br></pre></td></tr></table></figure>

<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>配置定时任务时，需要注意两个问题：</p>
<p>1: 在SHELL中设置了必要的环境变量；例如一个shell脚本手工执行OK，但是配置成后台作业执行时，获取不到ORACLE的环境变量，这是因为crontab环境变量问题，Crontab的环境默认情况下并不包含系统中当前用户的环境。所以，你需要在shell脚本中添加必要的环境变量的设置</p>
<p>2: 尽量所有的文件都采用完全路径方式，避免使用相对路径。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.jb51.net/article/98640.htm">Linux crontab定时任务配置方法(详解)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/w3cnote/linux-crontab-tasks.html">Linux Crontab 定时任务</a></p>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/linux/linux-comm-crontab.html">Linux crontab 命令</a></p>
<p><a target="_blank" rel="noopener" href="https://www.linuxidc.com/Linux/2019-03/157851.htm">CentOS安装配置Crontab定时任务</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/08/06/%E4%BD%BF%E7%94%A8Linux%E8%87%AA%E5%B8%A6%E6%97%A5%E5%BF%97%E6%BB%9A%E5%8A%A8%E5%B7%A5%E5%85%B7logrotate%E6%BB%9A%E5%8A%A8redis%E6%97%A5%E5%BF%97%E7%A4%BA%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/06/%E4%BD%BF%E7%94%A8Linux%E8%87%AA%E5%B8%A6%E6%97%A5%E5%BF%97%E6%BB%9A%E5%8A%A8%E5%B7%A5%E5%85%B7logrotate%E6%BB%9A%E5%8A%A8redis%E6%97%A5%E5%BF%97%E7%A4%BA%E4%BE%8B/" class="post-title-link" itemprop="url">使用Linux自带日志滚动工具logrotate滚动redis日志示例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-06 15:51:36" itemprop="dateCreated datePublished" datetime="2020-08-06T15:51:36+00:00">2020-08-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-16 08:30:45" itemprop="dateModified" datetime="2021-04-16T08:30:45+00:00">2021-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Linux-logrotate简介"><a href="#Linux-logrotate简介" class="headerlink" title="Linux logrotate简介"></a>Linux logrotate简介</h2><p><code>Linux logrotate</code> 命令用于管理记录文件。</p>
<p>使用 <code>logrotate</code> 指令，可让你轻松管理系统所产生的记录文件。它提供自动替换，压缩，删除和邮寄记录文件，每个记录文件都可被设置成每日，每周或每月处理，也能在文件太大时立即处理。例如，你可以设置 <code>logrotate</code>，让 <code>/var/log/foo</code> 日志文件每30天轮循，并删除超过6个月的日志。配置完后，<code>logrotate</code> 的运作完全自动化，不必进行任何进一步的人为干预。</p>
<p><code>logrotate</code> 需要的 <code>cron</code> 任务应该在安装时就自动创建好了，下面代码以centos7.4为例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/cron.daily/logrotate</span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">/usr/sbin/logrotate -s /var/lib/logrotate/logrotate.status /etc/logrotate.conf</span><br><span class="line">EXITVALUE=$?</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$EXITVALUE</span> != 0 ]; <span class="keyword">then</span></span><br><span class="line">    /usr/bin/logger -t logrotate <span class="string">&quot;ALERT exited abnormally with [<span class="variable">$EXITVALUE</span>]&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<p>Linux系统自带的日志滚动工具 <code>logrotate</code> 由两部分组成：</p>
<p>一是命令行工具 <code>logrotate</code>;<br>二是后台服务 <code>rsyslogd</code>。</p>
<p>使用 <code>rsyslogd</code> ，只需简单的配置即可实现日志滚动。<br><code>rsyslogd</code> 的配置文件为 <code>/etc/logrotate.conf</code>，但一般不建议直接修改 <code>logrotate.conf</code> ，而是在目录 <code>/etc/logrotate.d</code> 下新增文件的方式。<br><code>logrotate.conf</code> 会 <code>include</code> 所有 <code>logrotate.d</code> 目录下的文件，<br>语法是一致的，区别是 <code>logrotate.conf</code> 定义了默认的配置，而 <code>logrotate.d</code> 目录下为专有配置。</p>
<h2 id="Redis日志设置"><a href="#Redis日志设置" class="headerlink" title="Redis日志设置"></a>Redis日志设置</h2><p>截至到 <code>redis-5.0</code> 版本，redis 仍然不会自动滚动日志文件，如果不处理则日志文件日积月累越来越大，最终将导致磁盘满告警，</p>
<p>使用命令查看磁盘使用情况：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -lh</span><br></pre></td></tr></table></figure>

<p>下列为redis的配置示例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/logrotate.d/redis</span></span><br><span class="line"><span class="comment"># 以下为 redis 文件的内容：</span></span><br><span class="line">/usr/<span class="built_in">local</span>/redis-cluster/<span class="built_in">log</span>/redis-6379.log</span><br><span class="line">/usr/<span class="built_in">local</span>/redis-cluster/<span class="built_in">log</span>/redis-6380.log</span><br><span class="line">/usr/<span class="built_in">local</span>/redis-cluster/<span class="built_in">log</span>/redis-6381.log</span><br><span class="line">&#123;</span><br><span class="line">    monthly</span><br><span class="line">    rotate 5</span><br><span class="line">    minsize 100M</span><br><span class="line">    nocompress</span><br><span class="line">    dateext</span><br><span class="line">    missingok</span><br><span class="line">    notifempty</span><br><span class="line">    create 0664 root root</span><br><span class="line">    postrotate</span><br><span class="line">        /usr/bin/killall -HUP rsyslogd</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注：<code>postrotate/endscript</code> 可以去掉，即：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/logrotate.d/redis</span></span><br><span class="line"><span class="comment"># 以下为 redis 文件的内容：</span></span><br><span class="line">/usr/<span class="built_in">local</span>/redis-cluster/<span class="built_in">log</span>/redis-6379.log</span><br><span class="line">/usr/<span class="built_in">local</span>/redis-cluster/<span class="built_in">log</span>/redis-6380.log</span><br><span class="line">/usr/<span class="built_in">local</span>/redis-cluster/<span class="built_in">log</span>/redis-6381.log</span><br><span class="line">&#123;</span><br><span class="line">    monthly</span><br><span class="line">    rotate 5</span><br><span class="line">    minsize 100M</span><br><span class="line">    nocompress</span><br><span class="line">    dateext</span><br><span class="line">    missingok</span><br><span class="line">    notifempty</span><br><span class="line">    create 0664 root root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置项说明：</p>
<p>可以使用 <code>man logrotate</code> 命令查看详情。</p>
<ul>
<li><code>monthly</code>: 日志文件将按月轮循。其它可用值为 <code>daily</code>，<code>weekly</code> 或者 <code>yearly</code>。</li>
<li><code>rotate</code> 指定日志文件备份数，一次将存储5个归档日志。对于第六个归档，时间最久的归档将被删除，如果值为0表示不备份</li>
<li><code>minsize</code> 表示日志文件达到多大才滚动</li>
<li><code>nocompress</code> 表示是否压缩备份的日志文件，取值：<code>compress</code>，<code>nocompress</code></li>
<li><code>delaycompress</code>: 总是与 <code>compress</code> 选项一起用，<code>delaycompress</code> 选项指示 <code>logrotate</code> 不要将最近的归档压缩，压缩将在下一次轮循周期进行。这在你或任何软件仍然需要读取最新归档时很有用。</li>
<li><code>missingok</code> 在日志轮循期间，任何错误将被忽略</li>
<li><code>notifempty</code> 日志文件为空时，不进行轮转，默认值为 <code>ifempty</code></li>
<li><code>create</code> 以指定的权限创建全新的日志文件，同时logrotate也会重命名原始日志文件。<code>logrotate</code> 是以 root 运行的，如果目标日志文件非root运行，则这个一定要指定好。</li>
<li><code>postrotate/endscript</code>: 在所有其它指令完成后，<code>postrotate</code> 和 <code>endscript</code> 里面指定的命令将被执行。在这种情况下，<code>rsyslogd</code> 进程将立即再次读取其配置并继续运行。</li>
<li><code>dateext</code>：就是切割后的日志文件以当前日期为格式结尾，如 xxx.log-20201016 这样,如果注释掉,切割出来是按数字递增,即前面说的 xxx.log-1这种格式。</li>
</ul>
<p>注意，修改后需要重启下 <code>rsyslogd</code>。如果是 <code>CentOS</code> 可使用下列任意一种方式重启<br>（实际上 <code>systemctl</code> 新方式，而 <code>service</code> 实际也是使用 <code>systemctl</code> ）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service rsyslog restart </span><br><span class="line">systemctl restart rsyslog.service</span><br></pre></td></tr></table></figure>

<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p><strong>创建测试日志文件</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建文件</span></span><br><span class="line">touch /var/<span class="built_in">log</span>/log-file</span><br><span class="line">head -c 50M &lt; /dev/urandom &gt; /var/<span class="built_in">log</span>/log-file</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置</span></span><br><span class="line">vim /etc/logrotate.d/log-file</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为内容</span></span><br><span class="line">/var/<span class="built_in">log</span>/log-file &#123;</span><br><span class="line">    minsize 50M</span><br><span class="line">    rotate 5</span><br><span class="line">    create 644 root root</span><br><span class="line">    postrotate</span><br><span class="line">        /usr/bin/killall -HUP rsyslogd</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="手动运行"><a href="#手动运行" class="headerlink" title="手动运行"></a>手动运行</h2><p>logrotate 可以在任何时候从命令行手动调用。</p>
<p>要调用为 <code>/etc/lograte.d/</code> 下配置的所有日志调用 <code>logrotate</code> ：</p>
<p><code>logrotate /etc/logrotate.conf</code> </p>
<p>要为某个特定的配置调用 <code>logrotate</code> ：</p>
<p><code>logrotate /etc/logrotate.d/log-file</code> </p>
<p><strong>logrotate参数说明</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -d 选项以预演方式运行logrotate</span></span><br><span class="line">logrotate -d /etc/logrotate.d/log-file </span><br><span class="line"></span><br><span class="line"><span class="comment"># -f 强制logrotate轮循日志文件</span></span><br><span class="line"><span class="comment"># -v 参数提供了详细的输出。</span></span><br><span class="line">logrotate -vf /etc/logrotate.d/log-file</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出到指定的文件</span></span><br><span class="line"><span class="comment"># 注：logrotate自身的日志通常存放于/var/lib/logrotate/status目录。</span></span><br><span class="line">logrotate -vf –s /var/<span class="built_in">log</span>/logrotate-status /etc/logrotate.d/log-file</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://blog.chinaunix.net/uid-20682147-id-5818053.html">使用Linux自带日志滚动工具logrotate滚动redis日志示例</a></p>
<p><a target="_blank" rel="noopener" href="https://linux.cn/article-4126-1.html">Linux日志文件总管——logrotate</a></p>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/linux/linux-comm-logrotate.html">Linux logrotate命令</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/08/06/CentOS7%E6%89%A7%E8%A1%8CShell%E8%84%9A%E6%9C%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/06/CentOS7%E6%89%A7%E8%A1%8CShell%E8%84%9A%E6%9C%AC/" class="post-title-link" itemprop="url">CentOS7执行Shell脚本</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-06 14:00:15" itemprop="dateCreated datePublished" datetime="2020-08-06T14:00:15+00:00">2020-08-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-16 08:30:45" itemprop="dateModified" datetime="2021-04-16T08:30:45+00:00">2021-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Shell%E8%84%9A%E6%9C%AC/" itemprop="url" rel="index"><span itemprop="name">Shell脚本</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>先用 <code>chmod</code> 让Shell脚本有可执行权限，Linux下面用命令如何运行Shell脚本的方法，有两种方法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1， ./ 加上文件名 .sh</span></span><br><span class="line">./test.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2，sh 加上 文件名.sh</span></span><br><span class="line">sh test.sh</span><br></pre></td></tr></table></figure>

<p>如果没有权限，需要先设置权限，命令如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加执行权限</span></span><br><span class="line">chmod + x testsh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转到指定文件的目录下</span></span><br><span class="line"><span class="built_in">cd</span> <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#执行文件</span></span><br><span class="line">./test.sh  </span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/xiaopu99/article/details/82978743">centos执行.sh文件</a></p>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/linux/linux-shell.html">Shell 教程</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/08/05/Linux%20Transparent%20HugePages(%E9%80%8F%E6%98%8E%E5%A4%A7%E9%A1%B5)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/05/Linux%20Transparent%20HugePages(%E9%80%8F%E6%98%8E%E5%A4%A7%E9%A1%B5)/" class="post-title-link" itemprop="url">Linux Transparent HugePages(透明大页)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-05 14:40:31" itemprop="dateCreated datePublished" datetime="2020-08-05T14:40:31+00:00">2020-08-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-16 08:30:45" itemprop="dateModified" datetime="2021-04-16T08:30:45+00:00">2021-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>什么是 Transparent Huge Pages？为提升性能，通过大内存页来替代传统的4K页，使用得管理虚拟地址数变少，加快从虚拟地址到物理地址的映射，以及摒弃内存页面的换入换出以提高内存的整体性能。内核 Kernel 将程序缓存内存中，每页内存以2M为单位。相应的系统进程为 khugepaged。</p>
<p>在Linux中，有两种方式使用 Huge Pages，一种是2.6内核引入的 HugeTLBFS，另一种是2.6.36内核引入的THP。HugeTLBFS 主要用于数据库，THP广泛应用于应用程序。</p>
<p>一般可以在 rc.local 或 /etc/default/grub 中对 Huge Pages 进行设置。</p>
<p>Linux下的大页分为两种类型：标准大页（Huge Pages）和透明大页（Transparent Huge Pages）。Huge Pages有时候也翻译成大页/标准大页/传统大页，它们都是Huge Pages的不同中文翻译名而已。目的是使用更大的内存页面（memory page size） 以适应越来越大的系统内存，让操作系统可以支持现代硬件架构的大页面容量功能。透明大页（Transparent Huge Pages）缩写为THP，这个是RHEL 6（其它分支版本SUSE Linux Enterprise Server 11, and Oracle Linux 6 with earlier releases of Oracle Linux Unbreakable Enterprise Kernel 2 (UEK2)）开始引入的一个功能。具体可以参考官方文档。这两者的区别在于大页的分配机制，标准大页管理是预分配的方式，而透明大页管理则是动态分配的方式。</p>
<h2 id="CentOS7-禁用Transparent-Huge-Pages"><a href="#CentOS7-禁用Transparent-Huge-Pages" class="headerlink" title="CentOS7 禁用Transparent Huge Pages"></a>CentOS7 禁用Transparent Huge Pages</h2><p>自CentOS6版本开始引入了Transparent Huge Pages(THP)，从 CentOS7 版本开始，该特性默认就会启用。尽管THP的本意是为提升内存的性能，不过某些数据库厂商还是建议直接关闭THP(比如说 ORACLE、MariaDB、MongoDB 等)，否则可能会导致性能出现下降。</p>
<p>首先检查THP的启用状态：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cat /sys/kernel/mm/transparent_hugepage/defrag</span></span><br><span class="line">[always] madvise never</span><br><span class="line">[root@localhost ~]<span class="comment"># cat /sys/kernel/mm/transparent_hugepage/enabled</span></span><br><span class="line">[always] madvise never</span><br></pre></td></tr></table></figure>
<p>这个状态就说明都是启用的。</p>
<p>我们这个时候当然可以逐个修改上述两文件，来禁用THP，但要想一劳永逸的令其永久生效，还是参考下列的步骤。</p>
<p>编辑 rc.local 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim &#x2F;etc&#x2F;rc.local</span><br></pre></td></tr></table></figure>

<p>增加下列内容：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -f /sys/kernel/mm/transparent_hugepage/enabled; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -f /sys/kernel/mm/transparent_hugepage/defrag; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>保存退出，然后赋予 rc.local 文件执行权限：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># chmod +x /etc/rc.local</span></span><br></pre></td></tr></table></figure>

<p>最后重启系统，以后再检查THP应该就是被禁用了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cat /sys/kernel/mm/transparent_hugepage/enabled</span></span><br><span class="line">always madvise [never]</span><br><span class="line">[root@localhost ~]<span class="comment"># cat /sys/kernel/mm/transparent_hugepage/defrag </span></span><br><span class="line">always madvise [never]</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kerrycode/p/7760026.html">Linux传统Huge Pages与Transparent Huge Pages再次学习总结</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.itpub.net/26736162/viewspace-2214374/">Huge pages (标准大页)和 Transparent Huge pages(透明大页)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jb51.net/article/98191.htm">CentOS7 禁用Transparent Huge Pages的实现方法</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/08/05/Linux%20OOM%E6%9C%BA%E5%88%B6%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/05/Linux%20OOM%E6%9C%BA%E5%88%B6%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">Linux OOM机制简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-05 09:40:25" itemprop="dateCreated datePublished" datetime="2020-08-05T09:40:25+00:00">2020-08-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-16 08:30:45" itemprop="dateModified" datetime="2021-04-16T08:30:45+00:00">2021-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="OOM简介"><a href="#OOM简介" class="headerlink" title="OOM简介"></a>OOM简介</h2><p>OOM，全称 Out-Of-Memory，是一种内存分配策略。</p>
<p>所谓overcommit就是操作系统分配给进程的总内存大小超过了实际可用的内存，对进程而言实为虚拟内存，一个进程占用的虚拟内存空间通常比物理空间要大，甚至可能大许多，这样做的原因是进程实际上使用的内存往往比申请的内存要少。比如有个进程申请了1G的内存，但实际上它只在一小段时间里加载了大量数据，需要使用较大的内存，而在运行过程的其他大部分时间里只用了100M的内存。这样其实有900多M的内存在大部分时间里是闲置的，完全可以分给其他进程，overcommit的机制就能充分利用这些闲置的内存。</p>
<p>内核参数 overcommit_memory，</p>
<p>可选值：0、1、2。<br>0， 表示内核将检查是否有足够的可用内存供应用进程使用；如果有足够的可用内存，内存申请允许；否则，内存申请失败，并把错误返回给应用进程。<br>1， 表示内核允许分配所有的物理内存，而不管当前的内存状态如何。<br>2， 表示内核允许分配超过所有物理内存和交换空间总和的内存</p>
<p>有三种方式修改内核参数，但要有root权限：</p>
<p>（1）编辑 <code>/etc/sysctl.conf</code> ，改 <code>vm.overcommit_memory=1</code> ，然后 <code>sysctl -p</code> 使配置文件生效<br>（2）<code>sysctl vm.overcommit_memory=1</code><br>（3）<code>echo 1 &gt; /proc/sys/vm/overcommit_memory</code></p>
<p>系统是否行使OOM，由 <code>/proc/sys/vm/panic_on_oom</code> 的值决定，当 <code>/proc/sys/vm/panic_on_oom</code> 取值为1时表示关闭OOM，取值0时表示启用OOM。</p>
<p>Linux对大部分申请内存的请求都回复”yes”，以便能跑更多更大的程序。因为申请内存后，并不会马上使用内存。<br>Linux内核为了提高内存的使用效率采用过度分配内存(over-commit memory)的办法，造成物理内存过度紧张进而触发OOM killer机制来杀死一些进程(用户态进程，不是内核线程)回收内存。</p>
<p>该机制会监控那些占用内存过大，尤其是瞬间很快消耗大量内存的进程，为了防止内存耗尽会把该进程杀掉。</p>
<p>Linux在内存分配路径上会对内存余量做检查:<br>（1）如果检查到内存不足，则触发OOM机制。<br>（2）OOM首先会对系统所有进程(出init和内核线程等特殊进程)进行打分，并选出最bad的进程；然后杀死该进程。<br>（3）同时会触发内核oom_reaper进行内存收割。<br>（4）同时内核还提供了sysfs接口系统OOM行为，以及进程OOM行为。</p>
<p>Linux下每个进程都有自己的OOM权重，在 <code>/proc/&lt;pid&gt;/oom_adj</code> 里面，范围是-17到+15，取值越高，越容易被杀掉。</p>
<p>如果将 <code>/proc/sys/vm/oom_kill_allocating_task</code> 的值设置为1，则OOM时直接KILL当前正在申请内存的进程，否则OOM根据进程的oom_adj和oom_score来决定。</p>
<p><code>/proc/xxx/oom_adj</code>：表示进程被 OOM KILLER 杀死的权重，可读写，范围是-17~15。值越大被KILL的概率越高，当进程的oom_adj值为-17时，表示永远不会被OOM KILLER选中。</p>
<p><code>/proc/xxx/oom_score_adj</code>，可读写，范围是-1000~1000。</p>
<p>什么是Overcommit？当已申请的内存（Committed_AS）大小超出CommitLimit值时即为Overcommit，执行命令 <code>cat /proc/meminfo |grep CommitLimit</code> 可查看CommitLimit的当前大小。</p>
<p>CommitLimit为系统当前可以申请的内存总大小，即内存分配上限，当 <code>overcommit_memory</code> 值为2时，其值等于：<code>SwapTotal + MemTotal * overcommit_ratio</code>。</p>
<p>而Committed_AS，表示所有进程已申请的内存总和。命令 <code>sar -r</code> 输出中的 <code>kbcommit</code> 对应 <code>/proc/meminfo</code> 中的 <code>Committed_AS</code> ，而 <code>%commit</code> 值等于 <code>Committed_AS/(MemTotal+SwapTotal)</code> 。</p>
<p>如果是大内存机器，可以考虑适当调大 <code>/proc/sys/vm/min_free_kbytes</code> 的值，但不能太大了，不然容易频繁触发内存回收，<code>min_free_kbytes</code> 是内核保留空闲内存最小值，作用是保障必要时有足够内存使用。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://linuxperf.com/?p=102">理解LINUX的MEMORY OVERCOMMIT</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/arnoldlu/p/8567559.html">Linux内存管理 (21)OOM</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.chinaunix.net/uid-30401178-id-5159439.html">linux的vm.overcommit_memory的内存分配参数详解</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/aquester/p/11460372.html">Linux OOM一二三</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/21972130">如何理解Linux中的OOM(Out Of Memory Killer)机制？</a></p>
<p><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/vm/overcommit-accounting">overcommit-accounting</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/08/04/Linux%E8%AE%BE%E7%BD%AETCP%E7%9B%91%E5%90%AC%E9%98%9F%E5%88%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/04/Linux%E8%AE%BE%E7%BD%AETCP%E7%9B%91%E5%90%AC%E9%98%9F%E5%88%97/" class="post-title-link" itemprop="url">Linux设置TCP监听队列</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-04 17:42:10" itemprop="dateCreated datePublished" datetime="2020-08-04T17:42:10+00:00">2020-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-16 08:30:45" itemprop="dateModified" datetime="2021-04-16T08:30:45+00:00">2021-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TCP%E5%8D%8F%E8%AE%AE/" itemprop="url" rel="index"><span itemprop="name">TCP协议</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>tcp的三次握手:</p>
<p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200804174353.png" alt="微信截图_20200804174353.png"></p>
<p>1、client发送SYN到server，将状态修改为SYN_SEND，如果server收到请求，则将状态修改为SYN_RCVD，并把该请求放到syns queue队列中。<br>2、server回复SYN+ACK给client，如果client收到请求，则将状态修改为ESTABLISHED，并发送ACK给server。<br>3、server收到ACK，将状态修改为ESTABLISHED，并把该请求从 <code>syns queue</code> 中放到 <code>accept queue</code>。</p>
<h2 id="backlog参数"><a href="#backlog参数" class="headerlink" title="backlog参数"></a>backlog参数</h2><p>backlog其实是一个连接队列，在Linux内核2.2之前，backlog大小包括半连接状态和全连接状态两种队列大小。</p>
<ul>
<li>半连接状态为：服务器处于Listen状态时收到客户端SYN报文时放入半连接队列中，即 <code>SYN queue</code>（服务器端口状态为：SYN_RCVD）。</li>
<li>全连接状态为：TCP的连接状态从服务器（SYN+ACK）响应客户端后，到客户端的ACK报文到达服务器之前，则一直保留在半连接状态中；当服务器接收到客户端的ACK报文后，该条目将从半连接队列搬到全连接队列尾部，即 <code>accept queue</code> （服务器端口状态为：ESTABLISHED）。</li>
</ul>
<p>在Linux内核2.2之后，分离为两个backlog来分别限制半连接（SYN_RCVD状态）队列大小和全连接（ESTABLISHED状态）队列大小。</p>
<p><img src="/img/927655-20161215133843776-605308204.png" alt="927655-20161215133843776-605308204.png"></p>
<p><strong>syns queue</strong></p>
<p>SYN queue 用于保存半连接状态的请求，队列长度由 <code>/proc/sys/net/ipv4/tcp_max_syn_backlog</code> 指定，默认为1024。</p>
<p>需要在文件 <code>/etc/sysctl.conf</code> 中增加一行：</p>
<p><code>net.ipv4.tcp_max_syn_backlog = 262144</code></p>
<p>互联网常见的 <code>TCP SYN FLOOD</code>(拒绝服务攻击) 恶意DOS攻击方式就是建立大量的半连接状态的请求，然后丢弃，导致 <code>syns queue</code> 不能保存其它正常的请求。</p>
<p><strong>accept queue</strong></p>
<p>Accept queue 用于保存全连接状态的请求，队列长度由 <code>/proc/sys/net/core/somaxconn</code> 和使用 <code>listen</code> 函数时传入的参数，二者取最小值。默认为128。在Linux内核2.4.25之前，是写死在代码常量 <code>SOMAXCONN</code> ，在Linux内核2.4.25之后，在配置文件 <code>/proc/sys/net/core/somaxconn</code> 中直接修改，或者在 <code>/etc/sysctl.conf</code> 中配置 <code>net.core.somaxconn = 32768</code> 。</p>
<p>如果 <code>accpet queue</code> 队列满了，<code>server</code> 将发送一个 <code>ECONNREFUSED</code> 错误信息 <code>Connection refuse</code>到 <code>client</code> 。</p>
<p>立即生效还可以使用命令：<code>sysctl -w net.core.somaxconn=32768</code>。</p>
<p>要想永久生效，需要在文件 <code>/etc/sysctl.conf</code> 中增加一行：</p>
<p><code>net.core.somaxconn = 32768</code>，</p>
<p>或者使用命令：</p>
<p><code>echo &quot;net.core.somaxconn = 32768&quot; &gt;&gt; /etc/sysctl.conf</code>,</p>
<p>然后执行命令 <code>sysctl -p</code> 以生效。</p>
<p>注：Redis配置项 <code>tcp-backlog</code> 的值不能超过somaxconn的大小。</p>
<p>ss命令来显示:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ss -l</span></span><br><span class="line">State       Recv-Q Send-Q                                     Local Address:Port                                         Peer Address:Port     </span><br><span class="line">LISTEN      0      128                                                    *:http                                                    *:*       </span><br><span class="line">LISTEN      0      128                                                   :::ssh                                                    :::*       </span><br><span class="line">LISTEN      0      128                                                    *:ssh                                                     *:*       </span><br><span class="line">LISTEN      0      100                                                  ::1:smtp                                                   :::*       </span><br><span class="line">LISTEN      0      100                                            127.0.0.1:smtp                                                    *:*  </span><br></pre></td></tr></table></figure>

<p>在LISTEN状态，其中 Send-Q 即为Accept queue的最大值，Recv-Q 则表示Accept queue中等待被服务器accept()。</p>
<p>客户端connect()返回不代表TCP连接建立成功，有可能此时 <code>accept queue</code> 已满，系统会直接丢弃后续ACK请求；客户端误以为连接已建立，开始调用等待至超时；服务器则等待ACK超时，会重传 <code>SYN+ACK</code> 给客户端，重传次数受限 <code>net.ipv4.tcp_synack_retries</code> ，默认为5，表示重发5次，每次等待30~40秒，即半连接默认时间大约为180秒，该参数可以在tcp被洪水攻击是临时启用这个参数。</p>
<p><strong>查看SYN queue 溢出</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># netstat -s | grep LISTEN</span></span><br><span class="line">102324 SYNs to LISTEN sockets dropped</span><br></pre></td></tr></table></figure>
<p>　　<br><strong>查看Accept queue 溢出</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># netstat -s | grep TCPBacklogDrop</span></span><br><span class="line">TCPBacklogDrop: 2334</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Orgliny/p/5780796.html">TCP/IP协议中backlog参数</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e6f2036621f4">浅谈tcp socket的backlog参数</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/4252">Linux TCP队列相关参数的总结</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/08/04/Linux%20sysctl%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/04/Linux%20sysctl%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">Linux sysctl命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-04 16:43:11" itemprop="dateCreated datePublished" datetime="2020-08-04T16:43:11+00:00">2020-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-16 08:30:45" itemprop="dateModified" datetime="2021-04-16T08:30:45+00:00">2021-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/" itemprop="url" rel="index"><span itemprop="name">Linux基础命令</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>sysctl命令被用于在内核运行时动态地修改内核的运行参数，可用的内核参数在目录/proc/sys中。它包含一些TCP/ip堆栈和虚拟内存系统的高级选项， 这可以让有经验的管理员提高引人注目的系统性能。用sysctl可以读取设置超过五百个系统变量。</p>
<p>参数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-n：打印值时不打印关键字；</span><br><span class="line">-e：忽略未知关键字错误；</span><br><span class="line">-N：仅打印名称；</span><br><span class="line">-w：当改变sysctl设置时使用此项；</span><br><span class="line">-p：从配置文件“/etc/sysctl.conf”加载内核参数设置；</span><br><span class="line">-a：打印当前所有可用的内核参数变量和值；</span><br><span class="line">-A：以表格方式打印当前所有可用的内核参数变量和值。</span><br></pre></td></tr></table></figure>

<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>查看所有可读变量：</p>
<p><code>sysctl -a</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@host-192-125-30-59 ~]<span class="comment"># sysctl -a | grep file-max</span></span><br><span class="line">fs.file-max = 6523120</span><br><span class="line">sysctl: reading key <span class="string">&quot;net.ipv6.conf.all.stable_secret&quot;</span></span><br><span class="line">sysctl: reading key <span class="string">&quot;net.ipv6.conf.default.stable_secret&quot;</span></span><br><span class="line">sysctl: reading key <span class="string">&quot;net.ipv6.conf.eth0.stable_secret&quot;</span></span><br><span class="line">sysctl: reading key <span class="string">&quot;net.ipv6.conf.lo.stable_secret&quot;</span></span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://man.linuxde.net/sysctl">sysctl命令</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/08/04/Linux%E4%B8%ADPAM%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/04/Linux%E4%B8%ADPAM%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">Linux中PAM模块</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-04 14:37:39" itemprop="dateCreated datePublished" datetime="2020-08-04T14:37:39+00:00">2020-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-16 08:30:45" itemprop="dateModified" datetime="2021-04-16T08:30:45+00:00">2021-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PAM/" itemprop="url" rel="index"><span itemprop="name">PAM</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="pam简介"><a href="#pam简介" class="headerlink" title="pam简介"></a>pam简介</h2><p><strong>PAM：全称 Pluggable Authentication Modules，中文名 插入式认证模块。</strong></p>
<p><strong>Linux-PAM (Linux可插入认证模块)</strong>：是一套适用于Linux的身份验证共享库系统，它为系统中的应用程序或服务提供动态身份验证模块支持。在Linux中，PAM是可动态配置的，本地系统管理员可以自由选择应用程序如何对用户进行身份验证。PAM应用在许多程序与服务上，比如登录程序(login、su)的PAM身份验证（口令认证、限制登录），passwd强制密码，用户进程实时管理，向用户分配系统资源等。</p>
<p>PAM的主要特征是认证的性质是可动态配置的。PAM的核心部分是库（libpam）和PAM模块的集合，它们是位于文件夹 <code>/lib/security/</code> 中的动态链接库(.so)文件，以及位于 <code>/etc/pam.d/</code> 目录中（或者是 <code>/etc/pam.conf</code> 配置文件，centos6之后，没有这个文件了）的各个PAM模块配置文件。</p>
<p>使用如下命令判断程序是否使用了PAM：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@host-192-125-30-59 ~]<span class="comment"># ldd /usr/bin/passwd | grep libpam</span></span><br><span class="line">	libpam.so.0 =&gt; /lib64/libpam.so.0 (0x00007fb53bd17000)</span><br><span class="line">	libpam_misc.so.0 =&gt; /lib64/libpam_misc.so.0 (0x00007fb53bb13000)</span><br></pre></td></tr></table></figure>

<p>如看到有类似的输出，说明该程序使用了PAM，没有输出，则没有使用。</p>
<h2 id="PAM的配置文件介绍"><a href="#PAM的配置文件介绍" class="headerlink" title="PAM的配置文件介绍"></a>PAM的配置文件介绍</h2><p><code>/etc/pam.d/</code> 目录包含应用程序的PAM配置文件。例如，login程序将其程序/服务名称定义为login，与之对应的PAM配置文件为 <code>/etc/pam.d/login</code> 。</p>
<h3 id="PAM配置文件语法格式"><a href="#PAM配置文件语法格式" class="headerlink" title="PAM配置文件语法格式"></a>PAM配置文件语法格式</h3><p>每个PAM配置文件都包含一组指令，用于定义模块以及控制标志和参数。每条指令都有一个简单的语法，用于标识模块的目的（接口）和模块的配置设置，语法格式如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">module_interface      control_flag      module_name  module_arguments</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@host-192-125-30-59 ~]<span class="comment"># vim /etc/pam.d/system-auth-ac</span></span><br><span class="line"><span class="comment">#%PAM-1.0</span></span><br><span class="line"><span class="comment"># This file is auto-generated.</span></span><br><span class="line"><span class="comment"># User changes will be destroyed the next time authconfig is run.</span></span><br><span class="line">auth        required      pam_env.so</span><br><span class="line">auth        required      pam_faildelay.so delay=2000000</span><br><span class="line">auth        sufficient    pam_unix.so nullok try_first_pass</span><br><span class="line">auth        requisite     pam_succeed_if.so uid &gt;= 1000 quiet_success</span><br><span class="line">auth        required      pam_deny.so</span><br><span class="line"></span><br><span class="line">account     required      pam_unix.so</span><br><span class="line">account     sufficient    pam_localuser.so</span><br><span class="line">account     sufficient    pam_succeed_if.so uid &lt; 1000 quiet</span><br><span class="line">account     required      pam_permit.so</span><br><span class="line"></span><br><span class="line">password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=</span><br><span class="line">password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok</span><br><span class="line">password    required      pam_deny.so</span><br><span class="line"></span><br><span class="line">session     optional      pam_keyinit.so revoke</span><br><span class="line">session     required      pam_limits.so</span><br><span class="line">-session     optional      pam_systemd.so</span><br><span class="line">session     [success=1 default=ignore] pam_succeed_if.so service <span class="keyword">in</span> crond quiet use_uid</span><br></pre></td></tr></table></figure>

<p>如在/etc/pam.d/password-auth-ac配置文件中(CentOS)，其中一行PAM模块接口定义如下<br><img src="/img/password-auth-ac.png" alt="password-auth-ac.png"></p>
<h3 id="PAM的模块类型"><a href="#PAM的模块类型" class="headerlink" title="PAM的模块类型"></a>PAM的模块类型</h3><p>PAM为认证任务提供四种类型可用的模块接口，它们分别提供不同的认证服务：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">auth	- 认证模块接口，如验证用户身份、检查密码是否可以通过，并设置用户凭据</span><br><span class="line">account	- 账户模块接口，检查指定账户是否满足当前验证条件，如用户是否有权访问所请求的服务，检查账户是否到期</span><br><span class="line">password  - 密码模块接口，用于更改用户密码，以及强制使用强密码配置</span><br><span class="line">session	- 会话模块接口，用于管理和配置用户会话。会话在用户成功认证之后启动生效</span><br></pre></td></tr></table></figure>

<p>单个PAM库模块可以提供给任何或所有模块接口使用。例如，pam_unix.so提供给四个模块接口使用。</p>
<h3 id="PAM控制标志"><a href="#PAM控制标志" class="headerlink" title="PAM控制标志"></a>PAM控制标志</h3><p>所有的PAM模块被调用时都会返回成功或者失败的结果，每个PAM模块中由多个对应的控制标志决定结果是否通过或失败。每一个控制标志对应一个处理结果，PAM库将这些通过/失败的结果整合为一个整体的通过/失败结果，然后将结果返回给应用程序。模块可以按特定的顺序堆叠。控制标志是实现用户在对某一个特定的应用程序或服务身份验证的具体实现细节。该控制标志是PAM配置文件中的第二个字段，PAM控制标志如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">required  - 模块结果必须成功才能继续认证，如果在此处测试失败，则继续测试引用在该模块接口的下一个模块，直到所有的模块测试完成，才将结果通知给用户。</span><br><span class="line">requisite  - 模块结果必须成功才能继续认证，如果在此处测试失败，则会立即将失败结果通知给用户。</span><br><span class="line">sufficient  - 模块结果如果测试失败，将被忽略。如果sufficient模块测试成功，并且之前的required模块没有发生故障，PAM会向应用程序返回通过的结果，不会再调用堆栈中其他模块。</span><br><span class="line">optional  - 该模块返回的通过/失败结果被忽略。当没有其他模块被引用时，标记为optional模块并且成功验证时该模块才是必须的。该模块被调用来执行一些操作，并不影响模块堆栈的结果。</span><br><span class="line">include	 - 与其他控制标志不同，include与模块结果的处理方式无关。该标志用于直接引用其他PAM模块的配置参数</span><br></pre></td></tr></table></figure>

<h3 id="PAM配置方法"><a href="#PAM配置方法" class="headerlink" title="PAM配置方法"></a>PAM配置方法</h3><p>可以使用 <code>man</code> 命令查看配置，比如要查找某个程序支持PAM模块的配置，可以使用 <code>man</code> 加模块名(去掉.so)查找说明。</p>
<p>如 <code>man pam_unix</code>。(模块名可以在目录/lib/security/或/lib64/security/中找到。)</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/klb561/p/9236360.html">Linux安全策略配置-pam_tally2身份验证模块</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ilinuxer/p/5087447.html">linux中pam模块</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/linux/l-cn-pam/index.html">深入 Linux PAM 体系结构</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/08/04/Linux%E6%9C%80%E5%A4%A7%E6%96%87%E4%BB%B6%E6%89%93%E5%BC%80%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/04/Linux%E6%9C%80%E5%A4%A7%E6%96%87%E4%BB%B6%E6%89%93%E5%BC%80%E6%95%B0/" class="post-title-link" itemprop="url">Linux最大文件打开数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-04 13:57:52" itemprop="dateCreated datePublished" datetime="2020-08-04T13:57:52+00:00">2020-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-16 08:30:45" itemprop="dateModified" datetime="2021-04-16T08:30:45+00:00">2021-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>linux最大打开文件句柄数，即打开文件数最大限制，就是规定的单个进程能够打开的最大文件句柄数量（Socket连接也算在里面，默认大小1024）</p>
<p>为了防止失控的进程破坏系统的性能，<code>Unix</code> 和 <code>Linux</code> 跟踪进程使用的大部分资源，允许用户和系统管理员使用对进程的资源限制,<br>设置的限制有两种：<code>硬限制</code> 和 <code>软限制</code>:</p>
<ul>
<li><strong>hard</strong>：硬限制是可以在任何时候任何进程中设置 但硬限制只能由超级用户修改。</li>
<li><strong>soft</strong>：软限制是内核实际执行的限制，任何进程都可以将软限制设置为任意小于等于对进程限制的硬限制的值。</li>
</ul>
<p>(noproc)最大线程数和(nofile)文件数。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nr_open是单个进程可分配的最大文件数</span></span><br><span class="line"><span class="comment"># 一般默认为：1024*1024=1048576</span></span><br><span class="line">cat /proc/sys/fs/nr_open</span><br><span class="line"></span><br><span class="line"><span class="comment"># file-max是内核可分配的最大文件数</span></span><br><span class="line">cat /proc/sys/fs/file-max</span><br></pre></td></tr></table></figure>

<p>在Linux下有时会遇到 <code>Socket/File : Can&#39;t open so many files</code> 的问题。其实Linux是有文件句柄限制的，而且Linux默认一般都是1024（阿里云主机默认是65535）。在生产环境中很容易到达这个值，因此这里就会成为系统的瓶颈。</p>
<h2 id="Linux资源的限制"><a href="#Linux资源的限制" class="headerlink" title="Linux资源的限制"></a>Linux资源的限制</h2><h3 id="登陆时限制"><a href="#登陆时限制" class="headerlink" title="登陆时限制"></a>登陆时限制</h3><p>Linux对用户使用资源的限制通过 PAM 对登陆用户进行身份验证并设置相应的限制。</p>
<p>具体顺序如下。从用户登陆开始，操作系统会依次执行如下三部</p>
<ul>
<li><ol>
<li>/etc/pam.d/login</li>
</ol>
</li>
<li><ol start="2">
<li>/etc/pam.d/system-auth</li>
</ol>
</li>
<li><ol start="3">
<li>/lib64/security/pam_limits.so</li>
</ol>
</li>
</ul>
<p><strong>1，/etc/pam.d/login 中调用system-auth</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/pam.d/login</span><br></pre></td></tr></table></figure>

<p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20201224172412.png" alt="微信截图_20201224172412.png"></p>
<p><strong>2，在/etc/pam.d/system-auth 调用 pam_limits.so</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/pam.d/system-auth</span><br></pre></td></tr></table></figure>

<p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20201224172513.png" alt="微信截图_20201224172513.png"></p>
<p><strong>3，通过grep查看 /lib64/security/pam_limits.so 可以看到 limits.conf和limits.d/*.conf</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -a <span class="string">&quot;/etc/security/limits.&quot;</span> /lib64/security/pam_limits.so</span><br></pre></td></tr></table></figure>

<p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20201224172633.png" alt="微信截图_20201224172633.png"></p>
<h2 id="Centos7系统修改"><a href="#Centos7系统修改" class="headerlink" title="Centos7系统修改"></a>Centos7系统修改</h2><p>在Centos7系统中，使用 <code>Systemd</code> 替代了之前的 SysV。<code>/etc/security/limits.conf</code> 文件的配置作用域缩小了。<code>/etc/security/limits.conf</code> 的配置，只适用于通过PAM认证登录用户的资源限制，它对 <code>systemd</code> 的 <code>service</code> 的资源限制不生效。因此登录用户的限制，通过 <code>/etc/security/limits.conf</code> 与 <code>/etc/security/limits.d</code> 下的文件设置即可。</p>
<p>对于 <code>systemd service</code> 的资源设置，则需修改全局配置，全局配置文件放在 <code>/etc/systemd/system.conf</code> 和 <code>/etc/systemd/user.conf</code>。<code>system.conf</code> 是系统实例使用的，<code>user.conf</code> 是用户实例使用的。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/systemd/system.conf</span></span><br><span class="line">[Manager]</span><br><span class="line">DefaultLimitNOFILE=1048576</span><br><span class="line">DefaultLimitNPROC=1048576</span><br></pre></td></tr></table></figure>

<p><code>reboot</code> 重启后生效。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@host-192-175-32-22 bin]<span class="comment"># cat /proc/2789/limits</span></span><br><span class="line">Limit                     Soft Limit           Hard Limit           Units     </span><br><span class="line">Max cpu time              unlimited            unlimited            seconds   </span><br><span class="line">Max file size             unlimited            unlimited            bytes     </span><br><span class="line">Max data size             unlimited            unlimited            bytes     </span><br><span class="line">Max stack size            8388608              unlimited            bytes     </span><br><span class="line">Max core file size        0                    unlimited            bytes     </span><br><span class="line">Max resident <span class="built_in">set</span>          unlimited            unlimited            bytes     </span><br><span class="line">Max processes             1048576              1048576              processes </span><br><span class="line">Max open files            1048576              1048576              files     </span><br><span class="line">Max locked memory         65536                65536                bytes     </span><br><span class="line">Max address space         unlimited            unlimited            bytes     </span><br><span class="line">Max file locks            unlimited            unlimited            locks     </span><br><span class="line">Max pending signals       127951               127951               signals   </span><br><span class="line">Max msgqueue size         819200               819200               bytes     </span><br><span class="line">Max nice priority         0                    0                    </span><br><span class="line">Max realtime priority     0                    0                    </span><br><span class="line">Max realtime timeout      unlimited            unlimited            us        </span><br><span class="line">[root@host-192-175-32-22 bin]<span class="comment"># ulimit -n</span></span><br><span class="line">1048576</span><br></pre></td></tr></table></figure>

<h2 id="Red-Hat系统修改"><a href="#Red-Hat系统修改" class="headerlink" title="Red Hat系统修改"></a>Red Hat系统修改</h2><p>查看 <code>/etc/sysctl.conf</code> 和 <code>/etc/sysctl.d/*.conf</code> 的设置，修改 <code>sysctl.conf</code>，修改后须执行 <code>sysctl -p</code> 使修改生效。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fs.file-max=6523120</span><br></pre></td></tr></table></figure>

<p>查看 <code>/etc/security/limits.conf</code> 以及 <code>/etc/security/limits.d/*.conf</code> 。操作系统默认先加载 limits.conf 后加载 limits.d/*.conf，所以相同配置后面会覆盖前面，如：<code>/etc/security/limits.d/90-nproc.conf</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*          -       nofile    1048576</span><br><span class="line">*          -       nproc     1048576</span><br></pre></td></tr></table></figure>

<p><strong>免密登陆</strong></p>
<p>用户不会进行登陆验证过程，所以不会加载 limits.conf 文件，建议通过 <code>/etc/profile</code> 添加 <code>ulimit -n 1048576</code> 命令设置，重新登陆或者执行 <code>source /etc/profile</code> 命令，然后启动服务程序；</p>
<h2 id="查看用户级的最大限制"><a href="#查看用户级的最大限制" class="headerlink" title="查看用户级的最大限制"></a>查看用户级的最大限制</h2><p><code>ulimit -a</code> 或者 <code>ulimit -n</code></p>
<p><code>ulimit -n</code>，默认是1024，向阿里云华为云这种云主机一般是 65535。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@host-192-125-30-59 ~]<span class="comment"># ulimit -a</span></span><br><span class="line">core file size          (blocks, -c) 0</span><br><span class="line">data seg size           (kbytes, -d) unlimited</span><br><span class="line">scheduling priority             (-e) 0</span><br><span class="line">file size               (blocks, -f) unlimited</span><br><span class="line">pending signals                 (-i) 256967</span><br><span class="line">max locked memory       (kbytes, -l) 64</span><br><span class="line">max memory size         (kbytes, -m) unlimited</span><br><span class="line">open files                      (-n) 1024</span><br><span class="line">pipe size            (512 bytes, -p) 8</span><br><span class="line">POSIX message queues     (bytes, -q) 819200</span><br><span class="line">real-time priority              (-r) 0</span><br><span class="line">stack size              (kbytes, -s) 8192</span><br><span class="line">cpu time               (seconds, -t) unlimited</span><br><span class="line">max user processes              (-u) 256967</span><br><span class="line">virtual memory          (kbytes, -v) unlimited</span><br><span class="line">file locks                      (-x) unlimited</span><br><span class="line">[root@host-192-125-30-59 ~]<span class="comment"># ulimit -n</span></span><br><span class="line">1024</span><br></pre></td></tr></table></figure>

<p>open files （-n）1024 是linux操作系统对一个进程打开的文件句柄数量的限制（也包含打开的套接字数量）</p>
<table>
<thead>
<tr>
<th>选项 [options]</th>
<th>含义</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td>-H</td>
<td>设置硬资源限制，一旦设置不能增加。</td>
<td>ulimit – Hs 64；限制硬资源，线程栈大小为 64K。</td>
</tr>
<tr>
<td>-S</td>
<td>设置软资源限制，设置后可以增加，但是不能超过硬资源设置。</td>
<td>ulimit – Sn 32；限制软资源，32 个文件描述符。</td>
</tr>
<tr>
<td>-a</td>
<td>显示当前所有的 limit 信息。</td>
<td>ulimit – a；显示当前所有的 limit 信息。</td>
</tr>
<tr>
<td>-c</td>
<td>最大的 core 文件的大小， 以 blocks 为单位。</td>
<td>ulimit – c unlimited； 对生成的 core 文件的大小不进行限制。</td>
</tr>
<tr>
<td>-d</td>
<td>进程最大的数据段的大小，以 Kbytes 为单位。</td>
<td>ulimit -d unlimited；对进程的数据段大小不进行限制。</td>
</tr>
<tr>
<td>-f</td>
<td>进程可以创建文件的最大值，以 blocks 为单位。</td>
<td>ulimit – f 2048；限制进程可以创建的最大文件大小为 2048 blocks。</td>
</tr>
<tr>
<td>-l</td>
<td>最大可加锁内存大小，以 Kbytes 为单位。</td>
<td>ulimit – l 32；限制最大可加锁内存大小为 32 Kbytes。</td>
</tr>
<tr>
<td>-m</td>
<td>最大内存大小，以 Kbytes 为单位。</td>
<td>ulimit – m unlimited；对最大内存不进行限制。</td>
</tr>
<tr>
<td>-n</td>
<td>可以打开最大文件描述符的数量。</td>
<td>ulimit – n 128；限制最大可以使用 128 个文件描述符。</td>
</tr>
<tr>
<td>-p</td>
<td>管道缓冲区的大小，以 Kbytes 为单位。</td>
<td>ulimit – p 512；限制管道缓冲区的大小为 512 Kbytes。</td>
</tr>
<tr>
<td>-s</td>
<td>线程栈大小，以 Kbytes 为单位。</td>
<td>ulimit – s 512；限制线程栈的大小为 512 Kbytes。</td>
</tr>
<tr>
<td>-t</td>
<td>最大的 CPU 占用时间，以秒为单位。</td>
<td>ulimit – t unlimited；对最大的 CPU 占用时间不进行限制。</td>
</tr>
<tr>
<td>-u</td>
<td>用户最大可用的进程数。</td>
<td>ulimit – u 64；限制用户最多可以使用 64 个进程。</td>
</tr>
<tr>
<td>-v</td>
<td>进程最大可用的虚拟内存，以 Kbytes 为单位。</td>
<td>ulimit – v 200000；限制最大可用的虚拟内存为 200000 Kbytes。</td>
</tr>
</tbody></table>
<h2 id="查看某个进程的最大打开文件数和当前打开文件数"><a href="#查看某个进程的最大打开文件数和当前打开文件数" class="headerlink" title="查看某个进程的最大打开文件数和当前打开文件数"></a>查看某个进程的最大打开文件数和当前打开文件数</h2><p>先找到该进程的进程号，然后查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 找到pid</span></span><br><span class="line">ps -aux</span><br><span class="line"></span><br><span class="line"><span class="comment"># /proc/[pid]/limits和fd</span></span><br><span class="line"></span><br><span class="line">cat /proc/[pid]/limits 显示当前进程的资源限制</span><br><span class="line"></span><br><span class="line">ls /proc/[pid]/fd 是一个目录，包含进程打开文件的情况</span><br></pre></td></tr></table></figure>

<p>实例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host-192-125-30-59 ~]<span class="comment"># cat /proc/3289/limits| grep files</span></span><br><span class="line">Max open files            1024                 4096                 files</span><br><span class="line">[root@host-192-125-30-59 ~]<span class="comment"># ll /proc/3289/fd | wc -l</span></span><br><span class="line">7</span><br></pre></td></tr></table></figure>

<p>ps：如果要查看某个进程的线程的详细信息，<code>/proc/[pid]/task</code></p>
<h2 id="修改用户级最大限制"><a href="#修改用户级最大限制" class="headerlink" title="修改用户级最大限制"></a>修改用户级最大限制</h2><h3 id="临时生效方法：（重启后失效）"><a href="#临时生效方法：（重启后失效）" class="headerlink" title="临时生效方法：（重启后失效）"></a>临时生效方法：（重启后失效）</h3><p>这个设置是暂时的保留。当退出Shell会话后，该值恢复原值。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -SHn 1048576</span><br></pre></td></tr></table></figure>

<p><code>ulimit</code> 命令分软限制和硬限制，加 <code>-H</code> 就是硬限制，加 <code>-S</code> 就是软限制。默认显示的是软限制，如果运行 <code>ulimit</code> 命令修改时没有加上 <code>-H</code> 或 <code>-S</code> ，就是两个参数一起改变。</p>
<p>硬限制就是实际的限制，而软限制是警告限制，它只会给出警告。</p>
<h3 id="用户级修改永久有效方式"><a href="#用户级修改永久有效方式" class="headerlink" title="用户级修改永久有效方式"></a>用户级修改永久有效方式</h3><p>修改配置文件 <code>vim /etc/security/limits.conf</code>，加入：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br><span class="line">* soft nproc 65535</span><br><span class="line">* hard nproc 65535</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以使用下面一行来替代上面</span></span><br><span class="line">* - nofile 65535</span><br><span class="line">* - nproc 65535</span><br></pre></td></tr></table></figure>

<p>或者使用命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;* soft nofile 65535&quot;</span> &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;* hard nofile 65535&quot;</span> &gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure>

<p><code>*</code> 表示所用的用户，但有的系统不认, 需要具体的用户名, 比如:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root soft nofile 65535</span><br><span class="line">root hard nofile 65535</span><br></pre></td></tr></table></figure>

<p>有些环境修改后，root用户需要重启机器才生效，而普通用户重新登录后即生效。</p>
<p>需要小心注意的是，有些环境上面这样做，可能导致无法ssh登录，所以在修改时最好打开两个窗口，万一登录不了还可自救。</p>
<h2 id="修改系统级最大限制"><a href="#修改系统级最大限制" class="headerlink" title="修改系统级最大限制"></a>修改系统级最大限制</h2><p>其实上面的修改都是对一个进程打开的文件句柄数量的限制，我们还需要设置系统的总限制才可以。</p>
<p>假如，我们设置进程打开的文件句柄数是 1024 ，但是系统总限制才500，所以所有进程最多能打开文件句柄数量500。从这里我们可以看出只设置进程的打开文件句柄的数量是不行的。所以需要修改系统的总限制才可以。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 系统级修改临时生效方式：</span></span><br><span class="line"><span class="built_in">echo</span> 6523120 &gt; /proc/sys/fs/file-max</span><br><span class="line"></span><br><span class="line"><span class="comment"># 系统级修改永久生效方式：</span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 加入</span></span><br><span class="line">fs.file-max=6523120</span><br></pre></td></tr></table></figure>

<p>查看系统级文件句柄修改，是否生效</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/pangguoping/p/5791432.html">Linux最大文件打开数</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xulan0922/p/11937472.html">linux最大打开文件句柄数</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ibyte/p/9762248.html">修改RedHat 7.2 进程最大句柄数限制</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">syxdevcode</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">389</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">173</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/syxdevcode" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;syxdevcode" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">syxdevcode</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
