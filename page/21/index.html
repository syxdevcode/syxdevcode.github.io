<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"syxdevcode.github.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="syxdevcode博客">
<meta property="og:url" content="https://syxdevcode.github.com/page/21/index.html">
<meta property="og:site_name" content="syxdevcode博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="syxdevcode">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://syxdevcode.github.com/page/21/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>syxdevcode博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">syxdevcode博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/syxdevcode" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/12/06/DotNet%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A7%A3%E6%9E%9004-%E7%B1%BB%E5%9E%8B%E3%80%81%E6%96%B9%E6%B3%95%E4%B8%8E%E7%BB%A7%E6%89%BF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/06/DotNet%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A7%A3%E6%9E%9004-%E7%B1%BB%E5%9E%8B%E3%80%81%E6%96%B9%E6%B3%95%E4%B8%8E%E7%BB%A7%E6%89%BF/" class="post-title-link" itemprop="url">DotNet面试题解析04-类型、方法与继承</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-06 16:00:53" itemprop="dateCreated datePublished" datetime="2018-12-06T16:00:53+00:00">2018-12-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 07:00:06" itemprop="dateModified" datetime="2021-04-07T07:00:06+00:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DotNet%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A7%A3%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">DotNet面试题解析</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="类型基础"><a href="#类型基础" class="headerlink" title="类型基础"></a>类型基础</h2><h3 id="类型Type简述"><a href="#类型Type简述" class="headerlink" title="类型Type简述"></a>类型Type简述</h3><p>.NET 中主要的类型就是值类型和引用类型，所有类型的基类就是 System.Object ，也就是说我们使用 FCL 提供的各种类型的、自定义的所有类型都最终派生自 System.Object ，因此他们也都继承了 System.Object 提供的基本方法。</p>
<p><img src="/img/typesystem.gif" alt="typesystem.gif"></p>
<p>在 .NET 代码中，我们可以很方便的创建各种类型，一个简单的数据模型、复杂的聚合对象类型、或是对客观世界实体的抽象。类 (class) 是最基础的 C# 类型，支持继承与多态。<br>一个 c# 类 Class 主要包含两种基本成员：</p>
<ul>
<li>状态（字段、常量、属性等）</li>
<li>操作（方法、事件、索引器、构造函数等）</li>
</ul>
<p>利用创建的类型（或者系统提供的），可以很容易的创建对象的实例。使用 new 运算符创建，该运算符为新的实例分配内存，调用构造函数初始化该实例，并返回对该实例的引用，如下面的语法形式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;类名&gt;  &lt;实例名&gt; &#x3D; new &lt;类名&gt;([构造函数的参数])</span><br></pre></td></tr></table></figure>

<p>创建后的实例对象，是一个存储在内存上（在线程栈或托管堆上）的一个对象，那可以创造实例的类型在内存中又是一个什么样的存在呢？她就是 <strong>类型对象（Type Object）</strong>。</p>
<h3 id="类型对象（Type-Object）"><a href="#类型对象（Type-Object）" class="headerlink" title="类型对象（Type Object）"></a>类型对象（Type Object）</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> a = <span class="number">123</span>;                                                           <span class="comment">// 创建int类型实例a</span></span><br><span class="line"><span class="built_in">int</span> b = <span class="number">20</span>;                                                            <span class="comment">// 创建int类型实例b</span></span><br><span class="line"><span class="keyword">var</span> atype = a.GetType();                                               <span class="comment">// 获取对象实例a的类型Type</span></span><br><span class="line"><span class="keyword">var</span> btype = b.GetType();                                               <span class="comment">// 获取对象实例b的类型Type</span></span><br><span class="line">Console.WriteLine(System.Object.Equals(atype,btype));                  <span class="comment">//输出：True</span></span><br><span class="line">Console.WriteLine(System.Object.ReferenceEquals(atype, btype));        <span class="comment">//输出：True</span></span><br></pre></td></tr></table></figure>

<p>任何对象都有一个 GetType() 方法（基类 System.Object 提供的），该方法返回一个对象的类型，类型上面包含了对象内部的详细信息，如字段、属性、方法、基类、事件等等（通过反射可以获取）。在上面的代码中两个不同的 int 变量的类型（ int.GetType() ）是同一个 Type ，说明 int 在内存中有唯一一个（类似静态的） Systen.Int32 类型。</p>
<p>上面获取到的 Type 对象（ Systen.Int32 ）就是一个类型对象，她同其他引用类型一样，也是一个引用对象，这个对象中存储了 int32 类型的所有信息（类型的所有元数据信息）。</p>
<p><strong>关于类型对象（Object Type）：</strong></p>
<ul>
<li>每一个类型（如 System.Int32 ）在内存中都会有一个唯一的类型对象，通过（int）a.GetType() 可以获取该对象；</li>
<li>类型对象（ Object Type ）存储在内存中一个独立的区域，叫 加载堆（Load Heap），加载堆是在进程创建的时候创建的，不受 GC 垃圾回收管制，因此类型对象一经创建就不会被释放的，他的生命周期从 AppDomain 创建到结束；</li>
<li>每个引用对象都包含两个附加成员：TypeHandle 和 同步块索引，其中 TypeHandle 就指向该对象对应的类型对象；</li>
<li>类型对象的加载由 class loader 负责，在第一次使用前加载；</li>
<li>类型中的静态字段就是存储在这里的（加载堆上的类型对象），所以说静态字段是全局的，而且不会释放；</li>
</ul>
<p>可以参考下面的图，第一幅图描述了对象在内存中的一个关系， 第二幅图更复杂，更准确、全面的描述了内存的结构分布。</p>
<p><img src="/img/Anytao_15_3.jpg" alt="Anytao_15_3.jpg"></p>
<p><img src="/img/image_thumb_1.png" alt="image_thumb_1.png"></p>
<h3 id="方法表"><a href="#方法表" class="headerlink" title="方法表"></a>方法表</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    B1 b1 = <span class="keyword">new</span> B1(); B2 b2 = <span class="keyword">new</span> B2();</span><br><span class="line">    b1.Print(); b2.Print();      <span class="comment">//按预期应该输出 B1、B2</span></span><br><span class="line"></span><br><span class="line">    A ab1 = <span class="keyword">new</span> B1(); A ab2 = <span class="keyword">new</span> B2();</span><br><span class="line">    ab1.Print(); ab2.Print();   <span class="comment">//这里应该B1,A</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">A</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Print</span>(<span class="params"></span>)</span> &#123; Console.WriteLine(<span class="string">&quot;A&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">B1</span> : <span class="title">A</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Print</span>(<span class="params"></span>)</span> &#123; Console.WriteLine(<span class="string">&quot;B1&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">B2</span> : <span class="title">A</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">new</span> <span class="keyword">void</span> <span class="title">Print</span>(<span class="params"></span>)</span> &#123; Console.WriteLine(<span class="string">&quot;B2&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>方法表的加载：</strong></p>
<ul>
<li>方法表的加载时 父类在前，子类在后，首先加载的是固定的4个来自 System.Object 的虚方法：ToString, Equals, GetHashCode, Finalize；</li>
<li>然后加载父类 A 的虚方法；</li>
<li>加载自己的方法；</li>
<li>最后是构造方法：静态构造函数 .cctor() ，对象构造函数 .ctor() ；</li>
</ul>
<p><strong>方法的调用：</strong><br>当执行代码 b1.Print() 时（此处只关注方法调用，忽略方法的继承等因素），通过 b1 的 TypeHandel 找到对应类型对象，然后找到 方法表槽，然后是对应的 IL 代码，第一次执行的时候，JIT 编译器需要把 IL 代码编译为本地机器码，第一次执行完成后机器码会保留，下一次执行就不需要 JIT 编译了。这也是为什么说 .NET 程序启动需要预热的原因。</p>
<h3 id="NET中的继承本质"><a href="#NET中的继承本质" class="headerlink" title=".NET中的继承本质"></a>.NET中的继承本质</h3><p>方法表的创建过程是从父类到子类自上而下的，这是 .NET 中继承的很好体现，当发现有覆写父类虚方法会覆盖同名的父方法，所有类型的加载都会递归到 System.Object 类。</p>
<ul>
<li>继承是可传递的，子类是对父类的扩展，必须继承父类方法，同时可以添加新方法。</li>
<li>子类可以调用父类方法和字段，而父类不能调用子类方法和字段。</li>
<li>子类不光继承父类的公有成员，也继承了私有成员，只是不可直接访问。</li>
<li>new 关键字在虚方法继承中的阻断作用，中断某一虚方法的继承传递。</li>
</ul>
<p><strong>用基类（A）和用本身B1声明到底有什么区别呢？</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">B1 b1 = <span class="keyword">new</span> B1();</span><br><span class="line">A ab1 = <span class="keyword">new</span> B1();</span><br></pre></td></tr></table></figure>

<p>无论用什么做引用声明，哪怕是 object，等号右边的[ = new 类型()]都是没有区别的，也就说说对象的创建不受影响的，b1 和 ab1 对象在内存结构上是一致的；<br>他们的的差别就在引用指针的类型不同，这种不同在编码中智能提示就直观的反应出来了，在实际方法调用上也与引用指针类型有直接关系；<br>综合来说，不同引用指针类型对于对象的创建（new操作）不影响；但对于对象的使用（如方法调用）有影响，这一点在上面代码的执行结果中体现出来了！</p>
<p>上面调用的IL代码：</p>
<p><img src="/img/151257-20160306225941018-923782671.png" alt="151257-20160306225941018-923782671.png"></p>
<p>对于虚方法的调用，在 IL 中都是使用指令 <code>callvirt</code>，该指令主要意思就是具体的方法在运行时动态确定的：</p>
<blockquote>
<p><code>callvirt</code> 使用虚拟调度，也就是根据引用类型的动态类型来调度方法，<br><code>callvirt</code> 指令根据引用变量指向的对象类型来调用方法，在运行时动态绑定，主要用于调用虚方法。</p>
</blockquote>
<p>不同的类型指针在虚拟方法表中有不同的附加信息作为标志，来区别其访问的地址区域，称为 <strong>offset</strong>。不同类型的指针只能在其特定地址区域内执行。</p>
<p>编译器在方法调用时还有一个原则：</p>
<blockquote>
<p>执行就近原则：对于同名字段或者方法，编译器是按照其顺序查找来引用的，也就是首先访问离它创建最近的字段或者方法。</p>
</blockquote>
<p><img src="/img/151257-20160306225942315-1520940493.png" alt="151257-20160306225942315-1520940493.png"></p>
<p>在 C# 中，new 关键字可用作运算符、修饰符或约束。</p>
<ul>
<li>1，new 运算符：用于创建对象和调用构造函数。</li>
<li>2，new 修饰符：在用作修饰符时，new 关键字可以显式隐藏从基类继承的成员。</li>
<li>3，new 约束：用于在泛型声明中约束可能用作类型参数的参数的类型。</li>
</ul>
<h2 id="NET中的继承"><a href="#NET中的继承" class="headerlink" title=".NET中的继承"></a>.NET中的继承</h2><h3 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h3><p>抽象类提供多个派生类共享基类的公共定义，它既可以提供抽象方法，也可以提供非抽象方法。抽象类不能实例化，必须通过继承由派生类实现其抽象方法，因此对抽象类不能使用 <code>new</code> 关键字，也不能被密封。</p>
<p>基本特点：</p>
<ul>
<li>抽象类使用 Abstract 声明，抽象方法也是用 Abstract 标示；</li>
<li>抽象类不能被实例化；</li>
<li>抽象方法必须定义在抽象类中；</li>
<li>抽象类可以继承一个抽象类；</li>
<li>抽象类不能被密封（不能使用 sealed）；</li>
<li>同类 Class 一样，只支持单继承；</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">AbstractUser</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">SetName</span>(<span class="params"><span class="built_in">string</span> name</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/151257-20160306225944377-748332278.png" alt="151257-20160306225944377-748332278.png"></p>
<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><p>接口简单理解就是一种规范、契约，使得实现接口的类或结构在形式上保持一致。实现接口的类或结构必须实现接口定义中所有接口成员，以及该接口从其他接口中继承的所有接口成员。</p>
<p>基本特点：</p>
<ul>
<li>接口使用 interface 声明；</li>
<li>接口类似于抽象基类，不能直接实例化接口；</li>
<li>接口中的方法都是抽象方法，不能有实现代码，实现接口的任何非抽象类型都必须实现接口的所有成员：</li>
<li>接口成员是自动公开的，且不能包含任何访问修饰符。</li>
<li>接口自身可从多个接口继承，类和结构可继承多个接口，但接口不能继承类。</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUser</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">SetName</span>(<span class="params"><span class="built_in">string</span> name</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是 IUser 接口定义的 IL 代码，看上去是不是和上面的抽象类 AbstractUser 的 IL 代码差不多！接口也是使用.Class ~ abstract 标记，方法定义同抽象类中的方法一样使用 abstract virtual 标记。<font color=#0099ff size=4 face="黑体">因此可以把接口看做是一种特殊的抽象类，该类只提供定义，没有实现。</font></p>
<p><img src="/img/151257-20160306225945627-434523504.png" alt="151257-20160306225945627-434523504.png"></p>
<p>另外一个小细节，上面说到接口是一个特殊的类型，不继承 System.Object，通过 IL 代码其实可以证实这一点。无论是自定义的任何类型还是抽象类，都会隐式继承 System.Object，AbstractUser 的 IL 代码中就有 “extends [mscorlib]System.Object”，而接口的 IL 代码并没有这一段代码。</p>
<h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>在.NET中继承的主要两种方式就是类继承和接口继承，两者的主要思想是不一样的：</p>
<ul>
<li>类继承强调父子关系，是一个“IS A”的关系，因此只能单继承（就像一个人只能有一个Father）；</li>
<li>接口继承强调的是一种规范、约束，是一个“CAN DO”的关系，支持多继承，是实现多态一种重要方式。</li>
</ul>
<h2 id="题目答案解析"><a href="#题目答案解析" class="headerlink" title="题目答案解析"></a>题目答案解析</h2><h3 id="1-所有类型都继承System-Object吗？"><a href="#1-所有类型都继承System-Object吗？" class="headerlink" title="1. 所有类型都继承System.Object吗？"></a>1. 所有类型都继承System.Object吗？</h3><p>基本上是的，所有值类型和引用类型都继承自 System.Object，接口是一个特殊的类型，不继承自 System.Object。</p>
<h3 id="2-解释virtual、sealed、override和abstract的区别"><a href="#2-解释virtual、sealed、override和abstract的区别" class="headerlink" title="2. 解释virtual、sealed、override和abstract的区别"></a>2. 解释virtual、sealed、override和abstract的区别</h3><ul>
<li>virtual 申明虚方法的关键字，说明该方法可以被重写</li>
<li>sealed 说明该类不可被继承</li>
<li>override 重写基类的方法</li>
<li>abstract 申明抽象类和抽象方法的关键字，抽象方法不提供实现，由子类实现，抽象类不可实例化。</li>
</ul>
<h3 id="3-接口和类有什么异同？"><a href="#3-接口和类有什么异同？" class="headerlink" title="3. 接口和类有什么异同？"></a>3. 接口和类有什么异同？</h3><p><strong>不同点：</strong></p>
<p>1、接口不能直接实例化。</p>
<p>2、接口只包含方法或属性的<strong>声明</strong>，不包含方法的实现。</p>
<p>3、接口可以<strong>多继承</strong>，类只能单继承。</p>
<p>4、表达的含义不同，接口主要定义一种<strong>规范</strong>，统一调用方法，也就是规范类，约束类，类是方法功能的实现和集合</p>
<p><strong>相同点：</strong></p>
<p>1、接口、类和结构都可以从多个接口继承。</p>
<p>2、接口类似于抽象基类：继承接口的任何非抽象类型都必须实现接口的所有成员。</p>
<p>3、接口和类都可以包含事件、索引器、方法和属性。</p>
<h3 id="4-抽象类和接口有什么区别？"><a href="#4-抽象类和接口有什么区别？" class="headerlink" title="4. 抽象类和接口有什么区别？"></a>4. 抽象类和接口有什么区别？</h3><p>1、继承：接口支持多继承；抽象类不能实现多继承。</p>
<p>2、表达的概念：接口用于规范，更强调契约，抽象类用于共性，强调父子。抽象类是一类事物的高度聚合，那么对于继承抽象类的子类来说，对于抽象类来说，属于”Is A”的关系；而接口是定义行为规范，强调“Can Do”的关系，因此对于实现接口的子类来说，相对于接口来说，是”行为需要按照接口来完成”。</p>
<p>3、方法实现：对抽象类中的方法，即可以给出实现部分，也可以不给出；而接口的方法（抽象规则）都不能给出实现部分，接口中方法不能加修饰符。</p>
<p>4、子类重写：继承类对于两者所涉及方法的实现是不同的。继承类对于抽象类所定义的抽象方法，可以不用重写，也就是说，可以延用抽象类的方法；而对于接口类所定义的方法或者属性来说，在继承类中必须重写，给出相应的方法和属性实现。</p>
<p>5、新增方法的影响：在抽象类中，新增一个方法的话，继承类中可以不用作任何处理；而对于接口来说，则需要修改继承类，提供新定义的方法。</p>
<p>6、接口可以作用于值类型（枚举可以实现接口）和引用类型；抽象类只能作用于引用类型。</p>
<p>7、接口不能包含字段和已实现的方法，接口只包含方法、属性、索引器、事件的签名；抽象类可以定义字段、属性、包含有实现的方法。</p>
<h3 id="5-重载与覆盖的区别？"><a href="#5-重载与覆盖的区别？" class="headerlink" title="5. 重载与覆盖的区别？"></a>5. 重载与覆盖的区别？</h3><p>重载：当类包含两个名称相同但签名不同(方法名相同,参数列表不相同)的方法时发生方法重载。用方法重载来提供在语义上完成相同而功能不同的方法。</p>
<p>覆写：在类的继承中使用，通过覆写子类方法可以改变父类虚方法的实现。</p>
<p><strong>主要区别</strong>：</p>
<p>1、方法的覆盖是子类和父类之间的关系，是垂直关系；方法的重载是同一个类中方法之间的关系，是水平关系。<br>2、覆盖只能由一个方法，或只能由一对方法产生关系；方法的重载是多个方法之间的关系。<br>3、覆盖要求参数列表相同；重载要求参数列表不同。<br>4、覆盖关系中，调用那个方法体，是根据对象的类型来决定；重载关系，是根据调用时的实参表与形参表来选择方法体的。</p>
<h3 id="6-在继承中new和override相同点和区别？看下面的代码，有一个基类A，B1和B2都继承自A，并且使用不同的方式改变了父类方法Print（）的行为。测试代码输出什么？为什么？"><a href="#6-在继承中new和override相同点和区别？看下面的代码，有一个基类A，B1和B2都继承自A，并且使用不同的方式改变了父类方法Print（）的行为。测试代码输出什么？为什么？" class="headerlink" title="6. 在继承中new和override相同点和区别？看下面的代码，有一个基类A，B1和B2都继承自A，并且使用不同的方式改变了父类方法Print（）的行为。测试代码输出什么？为什么？"></a>6. 在继承中new和override相同点和区别？看下面的代码，有一个基类A，B1和B2都继承自A，并且使用不同的方式改变了父类方法Print（）的行为。测试代码输出什么？为什么？</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    B1 b1 = <span class="keyword">new</span> B1(); B2 b2 = <span class="keyword">new</span> B2();</span><br><span class="line">    b1.Print(); b2.Print();      <span class="comment">//按预期应该输出 B1、B2</span></span><br><span class="line"></span><br><span class="line">    A ab1 = <span class="keyword">new</span> B1(); A ab2 = <span class="keyword">new</span> B2();</span><br><span class="line">    ab1.Print(); ab2.Print();   <span class="comment">//这里应该输出什么呢？输出B1、A</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">A</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Print</span>(<span class="params"></span>)</span> &#123; Console.WriteLine(<span class="string">&quot;A&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">B1</span> : <span class="title">A</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Print</span>(<span class="params"></span>)</span> &#123; Console.WriteLine(<span class="string">&quot;B1&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">B2</span> : <span class="title">A</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 显式隐藏从基类继承的成员,也就是说此方法被隐藏，被调用ab2.Print()时，输出基类中的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">new</span> <span class="keyword">void</span> <span class="title">Print</span>(<span class="params"></span>)</span> &#123; Console.WriteLine(<span class="string">&quot;B2&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-下面代码中，变量a、b都是int类型，代码输出结果是什么？"><a href="#7-下面代码中，变量a、b都是int类型，代码输出结果是什么？" class="headerlink" title="7. 下面代码中，变量a、b都是int类型，代码输出结果是什么？"></a>7. 下面代码中，变量a、b都是int类型，代码输出结果是什么？</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> a = <span class="number">123</span>;</span><br><span class="line"><span class="built_in">int</span> b = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">var</span> atype = a.GetType();</span><br><span class="line"><span class="keyword">var</span> btype = b.GetType();</span><br><span class="line">Console.WriteLine(System.Object.Equals(atype,btype));          <span class="comment">//输出True</span></span><br><span class="line">Console.WriteLine(System.Object.ReferenceEquals(atype,btype)); <span class="comment">//输出True</span></span><br></pre></td></tr></table></figure>

<h3 id="8-class中定义的静态字段是存储在内存中的哪个地方？为什么会说她不会被GC回收？"><a href="#8-class中定义的静态字段是存储在内存中的哪个地方？为什么会说她不会被GC回收？" class="headerlink" title="8.class中定义的静态字段是存储在内存中的哪个地方？为什么会说她不会被GC回收？"></a>8.class中定义的静态字段是存储在内存中的哪个地方？为什么会说她不会被GC回收？</h3><p>随类型对象存储在内存的加载堆上，因为加载堆不受GC管理，其生命周期随 AppDomain，不会被 GC 回收。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/anding/p/5248973.html">.NET面试题解析(04)-类型、方法与继承</a></p>
<p><a target="_blank" rel="noopener" href="https://phodal.github.io/2md/">2md</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/12/06/DotNet%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A7%A3%E6%9E%9003-string%E4%B8%8E%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%93%8D%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/06/DotNet%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A7%A3%E6%9E%9003-string%E4%B8%8E%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%93%8D%E4%BD%9C/" class="post-title-link" itemprop="url">DotNet面试题解析03-string与字符串操作</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-06 14:20:09" itemprop="dateCreated datePublished" datetime="2018-12-06T14:20:09+00:00">2018-12-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 07:00:06" itemprop="dateModified" datetime="2021-04-07T07:00:06+00:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DotNet%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A7%A3%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">DotNet面试题解析</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="字符串操作"><a href="#字符串操作" class="headerlink" title="字符串操作"></a>字符串操作</h2><h3 id="认识string"><a href="#认识string" class="headerlink" title="认识string"></a>认识string</h3><p>string 是一个特殊的引用类型,其对象值存储在托管堆中。string 的内部是一个 char 集合，他的长度 Length 就是字符char 数组的字符个数，一个字符两个字节。string 不允许使用 new string() 的方式创建实例，而是另一种更简单的语法，直接赋值（string aa= “000” 这一点也类似值类型）。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoStringTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> aa = <span class="string">&quot;000&quot;</span>;</span><br><span class="line">    SetStringValue(aa);</span><br><span class="line">    Console.WriteLine(aa);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetStringValue</span>(<span class="params"><span class="built_in">string</span> aa</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    aa += <span class="string">&quot;111&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=#0099ff size=4 face="黑体">上面的输出结果为“000”。</font></p>
<p>通过前面的值类型与引用类型的文章，我们知道 string 是一个引用类型，既然是一个引用类型，参数传递的是引用地址，那为什么不是输出“000111”呢？是不是很有值类型的特点呢！这一切的原因源于 string 类型的两个重要的特性：恒定性 与 驻留性。</p>
<h3 id="String的恒定性（不变性）"><a href="#String的恒定性（不变性）" class="headerlink" title="String的恒定性（不变性）"></a>String的恒定性（不变性）</h3><p><font color=#0099ff size=4 face="黑体">字符串是不可变的，字符串一经创建，就不会改变，任何改变都会产生新的字符串。</font></p>
<p><img src="/img/151257-20160303222417112-1147871973.png" alt="151257-20160303222417112-1147871973.png"></p>
<p>上文中的 任何改变都会产生新的字符串 ，包括字符串的一些操作函数，如 str1.ToLower，Trim()，Remove(int startIndex, int count)，ToUpper() 等，都会产生新的字符串，因此在很多编程实践中，对于字符串忽略大小的比较：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>（str1.ToLower()==str2.ToLower()） <span class="comment">//这种方式会产生新的字符串，不推荐</span></span><br><span class="line"><span class="keyword">if</span>（<span class="built_in">string</span>. Compare(str1,str2,<span class="literal">true</span>)） <span class="comment">//这种方式性能更好</span></span><br></pre></td></tr></table></figure>

<h3 id="String的驻留性"><a href="#String的驻留性" class="headerlink" title="String的驻留性"></a>String的驻留性</h3><p>由于字符串的不变性，在大量使用字符串操作时，会导致创建大量的字符串对象，带来极大的性能损失。因此 CLR 又给 string 提供另外一个法宝，就是字符串驻留，先看看下面的代码，字符串 s1、s2 竟然是同一个对象！</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 = <span class="string">&quot;123&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> s2 = <span class="string">&quot;123&quot;</span>;</span><br><span class="line">Console.WriteLine(System.Object.Equals(s1, s2));  <span class="comment">//输出 True</span></span><br><span class="line">Console.WriteLine(System.Object.ReferenceEquals(s1, s2));  <span class="comment">//输出 True</span></span><br></pre></td></tr></table></figure>

<p><font color=#0099ff size=4 face="黑体">相同的字符串在内存（堆）中只分配一次，第二次申请字符串时，发现已经有该字符串是，直接返回已有字符串的地址，这就是驻留的基本过程。</font></p>
<p>字符串驻留的基本原理：</p>
<ul>
<li>CLR 初始化时会在内存中创建一个驻留池，内部其实是一个哈希表，存储被驻留的字符串和其内存地址。</li>
<li>驻留池是进程级别的，多个 AppDomain 共享。同时她不受 GC 控制，生命周期随进程，意思就是不会被 GC 回收</li>
<li>当分配字符串时，首先会到驻留池中查找，如找到，则返回已有相同字符串的地址，不会创建新字符串对象。如果没有找到，则创建新的字符串，并把字符串添加到驻留池中。</li>
</ul>
<p>如果大量的字符串都驻留到内存里，而得不到释放，不是很容易造成内存爆炸吗，当然不会了? 因为不是任何字符串都会驻留，只有通过 IL 指令 ldstr 创建的字符串才会留用。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 = <span class="string">&quot;123&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> s2 = s1 + <span class="string">&quot;abc&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> s3 = <span class="built_in">string</span>.Concat(s1, s2);</span><br><span class="line"><span class="keyword">var</span> s4 = <span class="number">123.</span>ToString();</span><br><span class="line"><span class="keyword">var</span> s5 = s2.ToUpper();</span><br></pre></td></tr></table></figure>

<p>IL代码如下：<br><img src="/img/151257-20160303221217190-205612505.png" alt="151257-20160303221217190-205612505.png"></p>
<p>在上面的代码中，出现两个字符串常量，“123” 和 “abc”，这个两个常量字符串在 IL 代码中都是通过 IL 指令 ldstr 创建的，只有该指令创建的字符串才会被驻留，其他方式产生新的字符串都不会被驻留，也就不会共享字符串了，会被 GC 正常回收。</p>
<p>那该如何来验证字符串是否驻留呢，string 类提供两个静态方法：</p>
<ul>
<li>string.Intern(string str)  可以主动驻留一个字符串；</li>
<li>string.IsInterned(string str)  检测指定字符串是否驻留，如果驻留则返回字符串，否则返回NULL</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 = <span class="string">&quot;123&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> s2 = s1 + <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">Console.WriteLine(s2);   <span class="comment">//输出：123abc</span></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.IsInterned(s2) ?? <span class="string">&quot;NULL&quot;</span>);   <span class="comment">//输出：NULL。因为“123abc”没有驻留</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span>.Intern(s2);   <span class="comment">//主动驻留字符串</span></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.IsInterned(s2) ?? <span class="string">&quot;NULL&quot;</span>);   <span class="comment">//输出：123abc</span></span><br></pre></td></tr></table></figure>

<h3 id="认识StringBuilder"><a href="#认识StringBuilder" class="headerlink" title="认识StringBuilder"></a>认识StringBuilder</h3><p>大量的编程实践和意见中，都说大量字符串连接操作，应该使用 StringBuilder。相对于 string 的不可变，StringBuilder 代表可变字符串，不会像字符串，在托管堆上频繁分配新对象。</p>
<p>首先 StringBuilder 内部同 string 一样，有一个 char[] 字符数组，负责维护字符串内容。因此，与 char 数组相关，就有两个很重要的属性：</p>
<ul>
<li>public int Capacity：StringBuilder 的容量，其实就是字符数组的长度。</li>
<li>public int Length：StringBuilder 中实际字符的长度，&gt;=0，&lt;= 容量 Capacity。</li>
</ul>
<p>StringBuilder 之所以比 string 效率高，主要原因就是不会创建大量的新对象，StringBuilder 在以下两种情况下会分配新对象：</p>
<ul>
<li>追加字符串时，当字符总长度超过了当前设置的容量 Capacity，这个时候，会重新创建一个更大的字符数组，此时会涉及到分配新对象。</li>
<li>调用 StringBuilder.ToString()，创建新的字符串。</li>
</ul>
<p><strong>追加字符串的过程</strong>：</p>
<ul>
<li>StringBuilder 的默认初始容量为16；</li>
<li>使用 stringBuilder.Append() 追加一个字符串时，当字符数大于16，StringBuilder 会自动申请一个更大的字符数组，一般是倍增；</li>
<li>在新的字符数组分配完成后，将原字符数组中的字符复制到新字符数组中，原字符数组就被GC回收；</li>
<li>最后把需要追加的字符串追加到新字符数组中；</li>
</ul>
<p>简单来说，当 StringBuilder 的容量 Capacity 发生变化时，就会引起托管对象申请、内存复制等操作，带来不好的性能影响，因此设置合适的初始容量是非常必要的，尽量减少内存申请和对象创建。</p>
<p>验证代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">StringBuilder sb1 = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">Console.WriteLine(<span class="string">&quot;Capacity=&#123;0&#125;; Length=&#123;1&#125;;&quot;</span>, sb1.Capacity, sb1.Length); <span class="comment">//输出：Capacity=16; Length=0;   //初始容量为16 </span></span><br><span class="line">sb1.Append(<span class="string">&#x27;a&#x27;</span>, <span class="number">12</span>);    <span class="comment">//追加12个字符</span></span><br><span class="line">Console.WriteLine(<span class="string">&quot;Capacity=&#123;0&#125;; Length=&#123;1&#125;;&quot;</span>, sb1.Capacity, sb1.Length); <span class="comment">//输出：Capacity=16; Length=12;  </span></span><br><span class="line">sb1.Append(<span class="string">&#x27;a&#x27;</span>, <span class="number">20</span>);    <span class="comment">//继续追加20个字符，容量倍增了</span></span><br><span class="line">Console.WriteLine(<span class="string">&quot;Capacity=&#123;0&#125;; Length=&#123;1&#125;;&quot;</span>, sb1.Capacity, sb1.Length); <span class="comment">//输出：Capacity=32; Length=32;  </span></span><br><span class="line">sb1.Append(<span class="string">&#x27;a&#x27;</span>, <span class="number">41</span>);    <span class="comment">//追加41个字符，新容量=32+41=73</span></span><br><span class="line">Console.WriteLine(<span class="string">&quot;Capacity=&#123;0&#125;; Length=&#123;1&#125;;&quot;</span>, sb1.Capacity, sb1.Length); <span class="comment">//输出：Capacity=73; Length=73;  </span></span><br><span class="line"></span><br><span class="line">StringBuilder sb2 = <span class="keyword">new</span> StringBuilder(<span class="number">80</span>); <span class="comment">//设置一个合适的初始容量</span></span><br><span class="line">Console.WriteLine(<span class="string">&quot;Capacity=&#123;0&#125;; Length=&#123;1&#125;;&quot;</span>, sb2.Capacity, sb2.Length); <span class="comment">//输出：Capacity=80; Length=0;</span></span><br><span class="line">sb2.Append(<span class="string">&#x27;a&#x27;</span>, <span class="number">12</span>);</span><br><span class="line">Console.WriteLine(<span class="string">&quot;Capacity=&#123;0&#125;; Length=&#123;1&#125;;&quot;</span>, sb2.Capacity, sb2.Length); <span class="comment">//输出：Capacity=80; Length=12;</span></span><br><span class="line">sb2.Append(<span class="string">&#x27;a&#x27;</span>, <span class="number">20</span>);</span><br><span class="line">Console.WriteLine(<span class="string">&quot;Capacity=&#123;0&#125;; Length=&#123;1&#125;;&quot;</span>, sb2.Capacity, sb2.Length); <span class="comment">//输出：Capacity=80; Length=32;</span></span><br><span class="line">sb2.Append(<span class="string">&#x27;a&#x27;</span>, <span class="number">41</span>);</span><br><span class="line">Console.WriteLine(<span class="string">&quot;Capacity=&#123;0&#125;; Length=&#123;1&#125;;&quot;</span>, sb2.Capacity, sb2.Length); <span class="comment">//输出：Capacity=80; Length=73;</span></span><br></pre></td></tr></table></figure>

<p>为什么少量字符串不推荐使用 StringBuilder 呢？因为 StringBuilder 本身是有一定的开销的，少量字符串就不推荐使用了，使用 String.Concat 和 String.Join 更合适。</p>
<h3 id="高效的使用字符串"><a href="#高效的使用字符串" class="headerlink" title="高效的使用字符串"></a>高效的使用字符串</h3><ul>
<li>在使用线程锁的时候，不要锁定一个字符串对象，因为字符串的驻留性，可能会引发不可以预料的问题；</li>
<li>理解字符串的不变性，尽量避免产生额外字符串，如：</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>（str1.ToLower()==str2.ToLower()） <span class="comment">//这种方式会产生新的字符串，不推荐</span></span><br><span class="line"><span class="keyword">if</span>（<span class="built_in">string</span>. Compare(str1,str2,<span class="literal">true</span>)） <span class="comment">//这种方式性能更好</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在处理大量字符串连接的时候，尽量使用 StringBuilder，在使用 StringBuilder 时，尽量设置一个合适的长度初始值；</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">StringBuilder myStringBuilder = <span class="keyword">new</span> StringBuilder(<span class="string">&quot;Hello World!&quot;</span>, <span class="number">25</span>);</span><br><span class="line">或</span><br><span class="line">myStringBuilder.Capacity = <span class="number">25</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>少量字符串连接建议使用 String.Concat 和 String.Join 代替。</li>
</ul>
<h2 id="题目答案解析"><a href="#题目答案解析" class="headerlink" title="题目答案解析"></a>题目答案解析</h2><h3 id="1-字符串是引用类型类型还是值类型？"><a href="#1-字符串是引用类型类型还是值类型？" class="headerlink" title="1.字符串是引用类型类型还是值类型？"></a>1.字符串是引用类型类型还是值类型？</h3><p>引用类型。</p>
<h3 id="2-在字符串连加处理中，最好采用什么方式，理由是什么？"><a href="#2-在字符串连加处理中，最好采用什么方式，理由是什么？" class="headerlink" title="2.在字符串连加处理中，最好采用什么方式，理由是什么？"></a>2.在字符串连加处理中，最好采用什么方式，理由是什么？</h3><p>少量字符串连接，使用 String.Concat，大量字符串使用 StringBuilder，因为 StringBuilder 的性能更好，如果 string 的话会创建大量字符串对象。</p>
<h3 id="3-使用-StringBuilder时，需要注意些什么问题？"><a href="#3-使用-StringBuilder时，需要注意些什么问题？" class="headerlink" title="3.使用 StringBuilder时，需要注意些什么问题？"></a>3.使用 StringBuilder时，需要注意些什么问题？</h3><ul>
<li>少量字符串时，尽量不要用，StringBuilder 本身是有一定性能开销的；</li>
<li>大量字符串连接使用 StringBuilder 时，应该设置一个合适的容量。</li>
</ul>
<h3 id="4-以下代码执行后内存中会存在多少个字符串？分别是什么？输出结果是什么？为什么呢？"><a href="#4-以下代码执行后内存中会存在多少个字符串？分别是什么？输出结果是什么？为什么呢？" class="headerlink" title="4.以下代码执行后内存中会存在多少个字符串？分别是什么？输出结果是什么？为什么呢？"></a>4.以下代码执行后内存中会存在多少个字符串？分别是什么？输出结果是什么？为什么呢？</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> st1 = <span class="string">&quot;123&quot;</span> + <span class="string">&quot;abc&quot;</span>;</span><br><span class="line"><span class="built_in">string</span> st2 = <span class="string">&quot;123abc&quot;</span>;</span><br><span class="line">Console.WriteLine(st1 == st2);</span><br><span class="line">Console.WriteLine(System.Object.ReferenceEquals(st1, st2));</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">True</span><br><span class="line">True</span><br></pre></td></tr></table></figure>

<p>内存中的字符串只有一个“123abc”,第一行代码（string st1 = “123” + “abc”; ）常量字符串相加会被编译器优化。由于字符串驻留机制，两个变量st1、st2都指向同一个对象。IL代码如下：</p>
<p><img src="/img/151257-20160303221219330-60155453.png" alt="151257-20160303221219330-60155453.png"></p>
<h3 id="5-以下代码执行后内存中会存在多少个字符串？分别是什么？输出结果是什么？为什么呢？"><a href="#5-以下代码执行后内存中会存在多少个字符串？分别是什么？输出结果是什么？为什么呢？" class="headerlink" title="5.以下代码执行后内存中会存在多少个字符串？分别是什么？输出结果是什么？为什么呢？"></a>5.以下代码执行后内存中会存在多少个字符串？分别是什么？输出结果是什么？为什么呢？</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> s1 = <span class="string">&quot;123&quot;</span>;</span><br><span class="line"><span class="built_in">string</span> s2 = s1 + <span class="string">&quot;abc&quot;</span>;</span><br><span class="line"><span class="built_in">string</span> s3 = <span class="string">&quot;123abc&quot;</span>;</span><br><span class="line">Console.WriteLine(s2 == s3);</span><br><span class="line">Console.WriteLine(System.Object.ReferenceEquals(s2, s3));</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">True</span><br><span class="line">False</span><br></pre></td></tr></table></figure>

<p>4个字符串。<br>分别是123，abc，123abc，123abc。</p>
<p>理由：<br>s1+abc时产生的不是可驻留的的字符串，而下句则是个驻留字符串。<br>字符串是不可变的，字符串一经创建，就不会改变，任何改变都会产生新的字符串。</p>
<h3 id="6-使用C-实现字符串反转算法，例如：输入”12345”-输出”54321”"><a href="#6-使用C-实现字符串反转算法，例如：输入”12345”-输出”54321”" class="headerlink" title="6.使用C#实现字符串反转算法，例如：输入”12345”, 输出”54321”"></a>6.使用C#实现字符串反转算法，例如：输入”12345”, 输出”54321”</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">Reverse</span>(<span class="params"><span class="built_in">string</span> str</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(str))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;参数不合法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder(str.Length);  <span class="comment">//注意：设置合适的初始长度，可以显著提高效率（避免了多次内存申请）</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> index = str.Length - <span class="number">1</span>; index &gt;= <span class="number">0</span>; index--)</span><br><span class="line">    &#123;</span><br><span class="line">        sb.Append(str[index]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.ToString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">Reverse</span>(<span class="params"><span class="built_in">string</span> str</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(str))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;参数不合法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">char</span>[] chars = str.ToCharArray();</span><br><span class="line">    <span class="built_in">int</span> begin = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">int</span> end = chars.Length - <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">char</span> tempChar;</span><br><span class="line">    <span class="keyword">while</span> (begin &lt; end)</span><br><span class="line">    &#123;</span><br><span class="line">        tempChar = chars[begin];</span><br><span class="line">        chars[begin] = chars[end];</span><br><span class="line">        chars[end] = tempChar;</span><br><span class="line">        begin++;</span><br><span class="line">        end--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">string</span> strResult = <span class="keyword">new</span> <span class="built_in">string</span>(chars);</span><br><span class="line">    <span class="keyword">return</span> strResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">Reverse</span>(<span class="params"><span class="built_in">string</span> str</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">char</span>[] arr = str.ToCharArray();</span><br><span class="line">    Array.Reverse(arr);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">string</span>(arr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-下面的代码输出结果？为什么？"><a href="#7-下面的代码输出结果？为什么？" class="headerlink" title="7.下面的代码输出结果？为什么？"></a>7.下面的代码输出结果？为什么？</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">object</span> a = <span class="string">&quot;123&quot;</span>;</span><br><span class="line"><span class="built_in">object</span> b = <span class="string">&quot;123&quot;</span>;</span><br><span class="line">Console.WriteLine(System.Object.Equals(a,b));</span><br><span class="line">Console.WriteLine(System.Object.ReferenceEquals(a,b));</span><br><span class="line"><span class="built_in">string</span> sa = <span class="string">&quot;123&quot;</span>;</span><br><span class="line">Console.WriteLine(System.Object.Equals(a, sa));</span><br><span class="line">Console.WriteLine(System.Object.ReferenceEquals(a, sa));</span><br></pre></td></tr></table></figure>

<p>输出结果全是 True，因为他们都指向同一个字符串实例，使用 object 声明和 string 声明在这里并没有区别（string是引用类型）。</p>
<h3 id="8-C-中string-Empty、””和null-之间的区别"><a href="#8-C-中string-Empty、””和null-之间的区别" class="headerlink" title="8.C#中string.Empty、””和null 之间的区别"></a>8.C#中string.Empty、””和null 之间的区别</h3><p>实际上 Empty 是 string 类中的一个静态的只读字段，他的定义是这样的：</p>
<p>public static readonly String Empty = “”;</p>
<p>也就是说 string.Empty 的内部实现是等于””的。</p>
<p>引用类型是将对象是实际数据保存在堆上, 将对象在堆上的地址保存在栈上。因此 string.Empty 与 “” 都会在栈上保存一个地址这个地址占4字节，指向内存堆中的某个长度为0的空间，这个空间保存的是 string.Empty 的实际值</p>
<p>“” 是通过 CLR 进行优化的,CLR 会维护一个字符串池,以防在堆中创建重复的字符串。<br>而 string.Empty 是一种 c# 语法级别的优化，是在 C# 编译器将代码编译为 IL (即 MSIL )时进行了优化，即所有对 string 类的静态字段 Empty 的访问都会被指向同一引用，以节省内存空间。也就是说，”” 与 string.Empty 在用法与性能上基本没区别。string.Empty 是在语法级别对 “” 的优化。</p>
<p>那就是 string.Empty 会在堆上占用一个长度为0的空间，而null不会。具体内容如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> str1=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="built_in">string</span> str2=<span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>如刚才所说 str1 会在栈上保存一个地址,这个地址占4字节，指向内存堆中的某个长度为0的空间，这个空间保存的是 str1 的实际值。</p>
<p>str2 同样会在栈上保存一个地址,这个地址也占4字节，但是这个地址是没有明确指向的，它哪也不指，其内容为 0x00000000。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/anding/p/5240313.html">.NET面试题解析(03)-string与字符串操作</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/solan/archive/2012/08/06/CSharp09.html">C#基础知识梳理系列九：StringBuilder</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/artech/archive/2007/05/06/737130.html">深入理解string和如何高效地使用string</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/henulwj/article/details/7830615">C#中string.Empty、””和null 之间的区别</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/12/05/DotNet%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A7%A3%E6%9E%9002-%E6%8B%86%E7%AE%B1%E4%B8%8E%E8%A3%85%E7%AE%B1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/05/DotNet%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A7%A3%E6%9E%9002-%E6%8B%86%E7%AE%B1%E4%B8%8E%E8%A3%85%E7%AE%B1/" class="post-title-link" itemprop="url">DotNet面试题解析02-拆箱与装箱</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-05 14:53:30" itemprop="dateCreated datePublished" datetime="2018-12-05T14:53:30+00:00">2018-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 07:00:06" itemprop="dateModified" datetime="2021-04-07T07:00:06+00:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DotNet%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A7%A3%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">DotNet面试题解析</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="装箱与拆箱"><a href="#装箱与拆箱" class="headerlink" title="装箱与拆箱"></a>装箱与拆箱</h2><font color=#0099ff size=4 face="黑体">
所有值类型都是继承自 System.ValueType ，而 System.ValueType 继承自 System.Object 。因此 Object 是 .NET 中的万物之源，几乎所有类型都来自她，这是装箱与拆箱的基础。</font>

<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>拆箱与装箱就是值类型与引用类型的转换，她是值类型和引用类型之间的桥梁，他们可以相互转换的一个基本前提就是上面所说的：Object 是 .NET 中的万物之源</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> x = <span class="number">1023</span>;</span><br><span class="line"><span class="built_in">object</span> o = x; <span class="comment">//装箱</span></span><br><span class="line"><span class="built_in">int</span> y = (<span class="built_in">int</span>) o; <span class="comment">//拆箱</span></span><br></pre></td></tr></table></figure>

<p><strong>装箱</strong>：值类型转换为引用对象，一般是转换为 System.Object 类型或值类型实现的接口引用类型；<br><strong>拆箱</strong>：引用类型转换为值类型，注意，这里的引用类型只能是被装箱的引用类型对象；</p>
<font color=#0099ff size=4 face="黑体">
装箱是非常“昂贵”的操作，它需要 内存分配 和 内存复制，并且由于需要回收临时创建的装箱对象，因此会对垃圾回收器产生压力。</font>

<h3 id="装箱的过程"><a href="#装箱的过程" class="headerlink" title="装箱的过程"></a>装箱的过程</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> x = <span class="number">1023</span>;</span><br><span class="line"><span class="built_in">object</span> o = x; <span class="comment">//装箱</span></span><br></pre></td></tr></table></figure>

<font color=#0099ff size=4 face="黑体">
当编译器检测到需要将值类型实例当作引用类型时，就会生成IL指令box。然后，JIT编译器解释该指令，调用某个方法分派堆内存，将值类型实例的内容复制到堆上，并用对象头（对象头字节和方法表指针（类型对象指针））包装起来。每当需要对象引用的时候，就使用这种“箱子”。</font>

<h3 id="拆箱的过程"><a href="#拆箱的过程" class="headerlink" title="拆箱的过程"></a>拆箱的过程</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> x = <span class="number">1023</span>;</span><br><span class="line"><span class="built_in">object</span> o = x; <span class="comment">//装箱</span></span><br><span class="line"><span class="built_in">int</span> y = (<span class="built_in">int</span>) o; <span class="comment">//拆箱</span></span><br></pre></td></tr></table></figure>

<p>具体过程：</p>
<ul>
<li>1.检查实例对象（ object o ）是否有效，如是否为 null，其装箱的类型与拆箱的类型（int）是否一致，如检测不合法，抛出异常；</li>
<li>2.指针返回，就是获取装箱对象（object o）中值类型字段值的地址；</li>
<li>3.字段拷贝，把装箱对象（object o）中值类型字段值拷贝到栈上，意思就是创建一个新的值类型变量来存储拆箱后的值；</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>只有值类型才有装箱、拆箱两个状态，而引用类型一直都在箱子里。</p>
<p>一般来说，装箱的性能开销更大，因为引用对象的分配更加复杂，成本也更高，值类型分配在栈上，分配和释放的效率都很高。装箱过程是需要创建一个新的引用类型对象实例，拆箱过程需要创建一个值类型字段，开销更低。</p>
<p>为了尽量避免这种性能损失，尽量使用泛型，在代码编写中也尽量避免隐式装箱。</p>
<p>在值类型中重写 Equals ,重载 Equals ,实现 IEquatable<T> ,以及重载操作符==和!=（通过 constrained IL  前缀）。</p>
<p>注：constrained：强迫;强使;限制;约束</p>
<h2 id="题目答案解析"><a href="#题目答案解析" class="headerlink" title="题目答案解析"></a>题目答案解析</h2><h3 id="1-什么是拆箱和装箱？"><a href="#1-什么是拆箱和装箱？" class="headerlink" title="1.什么是拆箱和装箱？"></a>1.什么是拆箱和装箱？</h3><p>装箱就是值类型转换为引用类型，拆箱就是引用类型（被装箱的对象）转换为值类型。</p>
<h3 id="2-什么是箱子？"><a href="#2-什么是箱子？" class="headerlink" title="2.什么是箱子？"></a>2.什么是箱子？</h3><p>值类型转换为引用类型的对象。</p>
<h3 id="3-箱子放在哪里？"><a href="#3-箱子放在哪里？" class="headerlink" title="3.箱子放在哪里？"></a>3.箱子放在哪里？</h3><p>托管堆上。</p>
<h3 id="4-装箱和拆箱有什么性能影响？"><a href="#4-装箱和拆箱有什么性能影响？" class="headerlink" title="4.装箱和拆箱有什么性能影响？"></a>4.装箱和拆箱有什么性能影响？</h3><p>装箱和拆箱都涉及到内存的分配和对象的创建，有较大的性能影响。</p>
<h3 id="5-如何避免隐身装箱？"><a href="#5-如何避免隐身装箱？" class="headerlink" title="5.如何避免隐身装箱？"></a>5.如何避免隐身装箱？</h3><p>编码中，多使用泛型、显示装箱。</p>
<h3 id="6-箱子的基本结构？"><a href="#6-箱子的基本结构？" class="headerlink" title="6.箱子的基本结构？"></a>6.箱子的基本结构？</h3><p>上面说了，箱子就是一个引用类型对象，因此它的结构，主要包含两部分：</p>
<ul>
<li>值类型字段值；</li>
<li>引用类型的标准配置，引用对象的额外空间：对象头字节（包括同步块索引）和 TypeHandle（或方法表指针，类型对象指针）</li>
</ul>
<h3 id="7-装箱的过程？"><a href="#7-装箱的过程？" class="headerlink" title="7.装箱的过程？"></a>7.装箱的过程？</h3><ul>
<li>1.在堆中申请内存，内存大小为值类型的大小，再加上额外固定空间（引用类型的标配：对象头字节（包括同步块索引）和 TypeHandle（或方法表指针，类型对象指针））；</li>
<li>2.将值类型的字段值（x=1023）拷贝新分配的内存中；</li>
<li>3.返回新引用对象的地址（给引用变量object o）</li>
</ul>
<h3 id="8-拆箱的过程？"><a href="#8-拆箱的过程？" class="headerlink" title="8.拆箱的过程？"></a>8.拆箱的过程？</h3><ul>
<li>1.检查实例对象（object o）是否有效，如是否为null，其装箱的类型与拆箱的类型（int）是否一致，如检测不合法，抛出异常；</li>
<li>2.指针返回，就是获取装箱对象（object o）中值类型字段值的地址；</li>
<li>3.字段拷贝，把装箱对象（object o）中值类型字段值拷贝到栈上，意思就是创建一个新的值类型变量来存储拆箱后的值；</li>
</ul>
<h3 id="9-下面这段代码输出什么？共发生多少次装箱？多少次拆箱？"><a href="#9-下面这段代码输出什么？共发生多少次装箱？多少次拆箱？" class="headerlink" title="9.下面这段代码输出什么？共发生多少次装箱？多少次拆箱？"></a>9.下面这段代码输出什么？共发生多少次装箱？多少次拆箱？</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> i = <span class="number">5</span>;</span><br><span class="line"><span class="built_in">object</span> obj = i;</span><br><span class="line">IFormattable ftt = i;</span><br><span class="line">Console.WriteLine(System.Object.ReferenceEquals(i, obj));</span><br><span class="line">Console.WriteLine(System.Object.ReferenceEquals(i, ftt));</span><br><span class="line">Console.WriteLine(System.Object.ReferenceEquals(ftt, obj));</span><br><span class="line">Console.WriteLine(System.Object.ReferenceEquals(i, (<span class="built_in">int</span>)obj));</span><br><span class="line">Console.WriteLine(System.Object.ReferenceEquals(i, (<span class="built_in">int</span>)ftt));</span><br></pre></td></tr></table></figure>

<p>上面代码输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">False</span><br><span class="line">False</span><br><span class="line">False</span><br><span class="line">False</span><br><span class="line">False</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/anding/p/5236739.html">.NET面试题解析(02)-拆箱与装箱</a></p>
<p><a target="_blank" rel="noopener" href="https://phodal.github.io/2md/">2md</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/12/04/DotNet%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A7%A3%E6%9E%9001-%E5%80%BC%E7%B1%BB%E5%9E%8B%E4%B8%8E%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/04/DotNet%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A7%A3%E6%9E%9001-%E5%80%BC%E7%B1%BB%E5%9E%8B%E4%B8%8E%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/" class="post-title-link" itemprop="url">DotNet面试题解析01-值类型与引用类型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-04 10:17:55" itemprop="dateCreated datePublished" datetime="2018-12-04T10:17:55+00:00">2018-12-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 07:00:06" itemprop="dateModified" datetime="2021-04-07T07:00:06+00:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DotNet%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A7%A3%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">DotNet面试题解析</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p><code>CLR</code> 支持两种类型：<strong>引用类型</strong>和<strong>值类型</strong>。这是 <code>.NET</code> 语言的基础和关键，他们从类型定义、实例创建、参数传递，到内存分配都有所不同。</p>
<p><img src="/img/typesystem.gif" alt="typesystem.gif"></p>
<p>下图清晰了展示了 <code>.NET</code> 中类型分类，值类型主要是一些简单的、基础的数据类型，引用类型主要用于更丰富的、复杂的、复合的数据类型。</p>
<p><img src="/img/2009020510331710.jpg" alt="2009020510331710.jpg"></p>
<h3 id="使用值类型最佳实践"><a href="#使用值类型最佳实践" class="headerlink" title="使用值类型最佳实践"></a>使用值类型最佳实践</h3><ul>
<li>对象很小，并且打算创建很多这样的对象</li>
<li>需要高密度的内存集合</li>
<li>在值类型中重写 <code>Equals</code> ,重载 <code>Equals</code> ,实现 <code>IEquatable&lt;T&gt;</code> ,以及重载操作符==和!=。</li>
<li>在值类型中重写 <code>GetHashCode</code>。</li>
<li>考虑将值类型实现为不可变的。</li>
</ul>
<h3 id="为什么要为值类型重定义相等性"><a href="#为什么要为值类型重定义相等性" class="headerlink" title="为什么要为值类型重定义相等性"></a>为什么要为值类型重定义相等性</h3><p>原因主要有以下几点：</p>
<ul>
<li>值类型默认无法使用 == 操作符，除非对它进行重写 ( <code>System.ValueType</code> 里面对 <code>object.Equals()</code> 方法的重写)</li>
<li>性能原因，因为值类型默认的相等性比较会使用装箱和反射，所以性能很差</li>
<li>根据业务需求，其实际相等性的意义和默认的比较结果可能会不同，但是这种情况可能不较少</li>
</ul>
<p><img src="/img/986268-20190413072415659-1667812156.png" alt="986268-20190413072415659-1667812156.png"></p>
<p>值类型和 <code>string</code> 类型除外，因为所有值类型继承于 <code>System.ValueType()</code> ( <code>System.ValueType()</code> 同样继承于<code>Object</code>，但是 <code>System.ValueType()</code> 本身却是引用类型)，而 <code>System.ValueType()</code> 对 <code>Equals()</code> 和==操作符进行了重写，是逐字节比较的。而 <code>string</code> 类型是比较特殊的引用类型，所以 <code>string</code> 在很多地方都是特殊处理的。</p>
<p>在值类型使用 <code>Equals()</code> 时，因为 <code>Equals()</code> 使用了反射，在比较时会影响效率。</p>
<p>注意：</p>
<p>如果要把引用类型做为 <code>Dictionary</code> 或 <code>HashTable</code> 的 <code>key</code> 使用时，必须重写这两个方法。</p>
<p>原因：当我们把引用类型( <code>string</code> 除外)做为 <code>Dictionary</code> 或 <code>HashTable</code> 的key时，有可能永远无法根据 <code>Key</code> 获得 <code>value</code> 的值，或者说两个类型的 <code>HashCode</code> 永远不会相等。</p>
<p>拿 <code>Dictionary</code> 来说，虽然我们存储的时候是键值对，但是 <code>CLR</code> 会先把 <code>key</code> 转成 <code>HashCode</code> 并且验证 <code>Equals</code> 后再做存储，根据 <code>key</code> 取值的时候也是把 <code>key</code> 转换成 <code>HashCode</code> 并且验证 <code>Equals</code> 后再取值。</p>
<p>注意验证时 <code>HashCode</code> 和 <code>Equals</code> 的关系是并且( <code>&amp;&amp;</code> )的关系。也就是说，只要 <code>GetHashCode</code> 和 <code>Equlas</code> 中有一个方法没有重写，在验证时没有重写的那个方法会调用基类的默认实现，而这两个方法的默认实现都是根据内存地址判断的，也就是说，只重写一个方法的返回值永远会是 <code>false</code> 。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaochen-vip8/p/5506478.html">聊一聊C#的Equals()和GetHashCode()方法</a></p>
<h3 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h3><ul>
<li>重写 <code>object.Equals()</code> 方法</li>
<li>实现 <code>IEquatable&lt;T&gt;.Equals()</code> 接口方法</li>
<li>重写 == 和 != 操作符</li>
<li>重写 <code>object.GetHashCode()</code></li>
</ul>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/cgzl/p/10699667.html">C# 为值类型重定义相等性</a></p>
<h3 id="如何重写GetHashCode方法"><a href="#如何重写GetHashCode方法" class="headerlink" title="如何重写GetHashCode方法"></a>如何重写GetHashCode方法</h3><p><code>Object</code> 中 <code>GetHasCode</code> 的算法保证了同一对象返回同一 <code>HashCode</code>，而不同的对象返回不同的 <code>HashCode</code>，但对于值类型等，视内容相等的对象为相等对象的类型时，默认的 <code>GetHashCode</code> 算法并不正确。重写后的 <code>GetHashCode</code> 必须要保证同一对象无论何时都返回同一 <code>HashCode</code> 值，而相等的对象也必须返回相同的值。并且在此基础上，保证 <code>HashCode</code> 尽量随机地散列分布。</p>
<h3 id="引用类型"><a href="#引用类型" class="headerlink" title="引用类型"></a>引用类型</h3><p>标准配置，引用对象的额外空间：<code>对象头字节（包括同步块索引）</code>和 <code>TypeHandle（或方法表指针，类型对象指针）</code></p>
<p>方法表指针指向一个 <code>CLR</code> 内部数据结构–方法表（ <code>MT</code> ）。方法表指向另一个内部数据结构—<code>EEClass</code> (EE代表<code>Execution Engine</code>,执行引擎)。方法表和 <code>EEClass</code> 包含一些信息，可用来分发虚方法和接口方法调用，访问静态变量，确定对象的运行时类型，高效访问基类型方法等。</p>
<h2 id="内存结构"><a href="#内存结构" class="headerlink" title="内存结构"></a>内存结构</h2><p><code>值类型</code> 和 <code>引用类型</code> 最根源的区别就是其内存分配的差异，在这之前首先要理解 <code>CLR</code> 的内存中两个重要的概念：</p>
<p><strong>Stack 栈</strong>：线程栈，由操作系统管理，<strong>存放值类型、引用类型变量（就是引用对象在托管堆上的地址）</strong>。栈是基于线程的，也就是说一个线程会包含一个线程栈，线程栈中的值类型在对象作用域结束后会被清理，效率很高。</p>
<p><strong>GC Heap托管堆</strong>：进程初始化后在进程地址空间上划分的内存空间，存储 <code>.NET</code> 运行过程中的对象，<strong>所有的引用类型都分配在托管堆上</strong>，托管堆上分配的对象是由 <code>GC</code> 来管理和释放的。托管堆是基于进程的，当然托管堆内部还有其他更为复杂的结构。</p>
<p>结合下图理解，变量a及其值3都是存储在栈上面。变量b在栈上存储，其值指向字符串“123”的托管堆对象地址(字符串是引用类型，字符串对象是存储在托管堆上面。字符串是一个特殊的引用类型)</p>
<p><img src="/img/151257-20160301092426314-1061559039.png" alt="151257-20160301092426314-1061559039.png"></p>
<p><strong>值类型一直都存储在栈上面吗？所有的引用类型都存储在托管堆上面吗？</strong></p>
<ul>
<li>1.单独的值类型变量，如局部值类型变量都是存储在栈上面的；</li>
<li>2.当值类型是自定义 <code>class</code> 的一个字段、属性时，它随引用类型存储在托管堆上，此时她是引用类型的一部分；</li>
<li>4.所有的引用类型肯定都是存放在托管堆上的。</li>
<li>5.结构体（值类型）中定义引用类型字段，结构体是存储在栈上，其引用变量字段只存储内存地址，指向堆中的引用实例。</li>
</ul>
<h2 id="对象的传递"><a href="#对象的传递" class="headerlink" title="对象的传递"></a>对象的传递</h2><p><font color=#0099ff size=4 face="黑体">将值类型的变量赋值给另一个变量（或者作为参数传递），会执行一次值复制。<br>将引用类型的变量赋值给另一个引用类型的变量，它复制的值是引用对象的内存地址，因此赋值后就会多个变量指向同一个引用对象实例。</font></p>
<p>理解这一点非常重要，下面代码测试验证一下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> v1 = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> v2 = v1;</span><br><span class="line">v2 = <span class="number">100</span>;</span><br><span class="line">Console.WriteLine(<span class="string">&quot;v1=&quot;</span> + v1); <span class="comment">//输出：v1=0</span></span><br><span class="line">Console.WriteLine(<span class="string">&quot;v2=&quot;</span> + v2); <span class="comment">//输出：v2=100</span></span><br><span class="line"></span><br><span class="line">User u1=<span class="keyword">new</span> User();</span><br><span class="line">u1.Age = <span class="number">0</span>;</span><br><span class="line">User u2 = u1;</span><br><span class="line">u2.Age = <span class="number">100</span>;</span><br><span class="line">Console.WriteLine(<span class="string">&quot;u1.Age=&quot;</span> + u1.Age); <span class="comment">//输出：u1.Age=100</span></span><br><span class="line">Console.WriteLine(<span class="string">&quot;u2.Age=&quot;</span> + u2.Age); <span class="comment">//输出：u2.Age=100，因为u1/u2指向同一个对象</span></span><br></pre></td></tr></table></figure>

<p>当把对象作为参数传递的时候，效果同上面一样，他们都称为按值传递，但因为值类型和引用类型的区别，导致其产生的效果也不同。</p>
<h3 id="参数-按值传递："><a href="#参数-按值传递：" class="headerlink" title="参数-按值传递："></a>参数-按值传递：</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DoTest</span>(<span class="params"><span class="built_in">int</span> a</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    a *= <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DoUserTest</span>(<span class="params">User user</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    user.Age *= <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">NUnit.Framework.Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoParaTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">int</span> a = <span class="number">10</span>;</span><br><span class="line">    DoTest(a);</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;a=&quot;</span> + a); <span class="comment">//输出：a=10</span></span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.Age = <span class="number">10</span>;</span><br><span class="line">    DoUserTest(user);</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;user.Age=&quot;</span> + user.Age); <span class="comment">//输出：user.Age=20</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码示例，两个方法的参数，都是按值传递</p>
<ul>
<li>对于值类型( <code>int a</code>) ：传递的是变量a的值拷贝副本，因此原本的a值并没有改变。</li>
<li>对于引用类型( <code>User user</code>) ：传递的是变量 <code>user</code> 的引用地址（ <code>User</code> 对象实例的内存地址）拷贝副本，因此他们操作都是同一个 <code>User</code> 对象实例。</li>
</ul>
<h3 id="参数-按引用传递："><a href="#参数-按引用传递：" class="headerlink" title="参数-按引用传递："></a>参数-按引用传递：</h3><font color=#0099ff size=4 face="黑体">
按引用传递的两个主要关键字：out 和 ref不管值类型还是引用类型，按引用传递的效果是一样的，都不传递值副本，而是引用的引用（类似c++的指针的指针）。out 和 ref告诉编译器方法传递额是参数地址，而不是参数本身，理解这一点很重要。
</font>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DoTest</span>(<span class="params"><span class="keyword">ref</span> <span class="built_in">int</span> a</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    a *= <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DoUserTest</span>(<span class="params"><span class="keyword">ref</span> User user</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    user.Age *= <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoParaTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">int</span> a = <span class="number">10</span>;</span><br><span class="line">    DoTest(<span class="keyword">ref</span> a);</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;a=&quot;</span> + a); <span class="comment">//输出：a=20 ,a的值改变了</span></span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.Age = <span class="number">10</span>;</span><br><span class="line">    DoUserTest(<span class="keyword">ref</span> user);</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;user.Age=&quot;</span> + user.Age); <span class="comment">//输出：user.Age=20</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> m = <span class="number">0</span>;</span><br><span class="line">Console.WriteLine(RefValue(<span class="number">1</span>, <span class="keyword">ref</span> m)); <span class="comment">//输出 1</span></span><br><span class="line">Console.WriteLine(m);  <span class="comment">//输出 222</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> n;</span><br><span class="line">Console.WriteLine(OutValue(<span class="number">1</span>, <span class="keyword">out</span> n));  <span class="comment">//输出 223</span></span><br><span class="line">Console.WriteLine(n);  <span class="comment">//输出 222</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="built_in">int</span> <span class="title">RefValue</span>(<span class="params"><span class="built_in">int</span> i, <span class="keyword">ref</span> <span class="built_in">int</span> j</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">int</span> k = j;</span><br><span class="line">    j = <span class="number">222</span>;</span><br><span class="line">    <span class="keyword">return</span> i + k;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="built_in">int</span> <span class="title">OutValue</span>(<span class="params"><span class="built_in">int</span> i, <span class="keyword">out</span> <span class="built_in">int</span> j</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    j = <span class="number">222</span>;</span><br><span class="line">    <span class="keyword">return</span> i + j;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>out</code> 和 <code>ref</code>的主要异同:</p>
<ul>
<li><code>out</code> 和 <code>ref</code> 都指示编译器传递参数地址，在行为上是相同的；</li>
<li>他们的使用机制稍有不同，ref 必须要求参数在使用之前要显式初始化，out 必须要在方法内部初始化；</li>
<li>使用 ref 和 out 时，在方法的参数和执行方法时，都要加Ref或Out关键字，以满足匹配；</li>
<li>out 适合用在需要 retrun 多个返回值的地方，而 ref 则用在需要被调用的方法修改调用者的引用的时候。</li>
<li>out 和 ref 不可以重载，就是不能定义 <code>Method(ref int a)</code> 和 <code>Method(out int a)</code> 这样的重载，从编译角度看，二者的实质是相同的，只是使用时有区别；</li>
<li>ref 是有进有出，而 out 是只出不进。</li>
</ul>
<font color=#ff0000 size=4 face="黑体">
注：在C#中，方法的参数传递有四种类型：传值（by value），传址（by reference），输出参数（by output），数组参数（by array）。传值参数无需额外的修饰符，传址参数需要修饰符ref，输出参数需要修饰符out，数组参数需要修饰符params。</font>

<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><p><img src="/img/%E5%80%BC%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E5%8C%BA%E5%88%AB.jpg" alt="值类型和引用类型区别.jpg"></p>
<h2 id="题目答案解析"><a href="#题目答案解析" class="headerlink" title="题目答案解析"></a>题目答案解析</h2><h3 id="1-值类型和引用类型的区别？"><a href="#1-值类型和引用类型的区别？" class="headerlink" title="1. 值类型和引用类型的区别？"></a>1. 值类型和引用类型的区别？</h3><p>值类型包括简单类型、结构体类型和枚举类型，引用类型包括自定义类、数组、接口、委托等。</p>
<ul>
<li>1、赋值方式：将一个值类型变量赋给另一个值类型变量时，将复制包含的值。这与引用类型变量的赋值不同，引用类型变量的赋值只复制对象的引用（即内存地址，类似 <code>C++</code> 中的指针），而不复制对象本身。</li>
<li>2、继承：值类型不可能派生出新的类型，所有的值类型均隐式派生自 <code>System.ValueType</code>。但与引用类型相同的是，结构也可以实现接口。</li>
<li>3、null：与引用类型不同，值类型不可能包含 null 值。然而，可空类型允许将 null 赋给值类型（他其实只是一种语法形式，在 <code>clr</code> 底层做了特殊处理）。</li>
<li>4、每种值类型均有一个隐式的默认构造函数来初始化该类型的默认值，值类型初始会默认为0，引用类型默认为null。</li>
<li>5、值类型存储在栈中，引用类型存储在托管堆中。</li>
</ul>
<h3 id="2-结构和类的区别？"><a href="#2-结构和类的区别？" class="headerlink" title="2. 结构和类的区别？"></a>2. 结构和类的区别？</h3><p>结构体是值类型，类是引用类型，主要区别如题1。其他的区别：</p>
<ul>
<li>结构不支持无惨构造函数，不支持析构函数，并且不能有 protected 修饰；</li>
<li>结构常用于数据存储，类 class 多用于行为；</li>
<li>class 需要用 new 关键字实例化对象，struct 可以不适用 new 关键字；</li>
<li>class 可以为抽象类，struct 不支持抽象；</li>
</ul>
<h3 id="3-delegate是引用类型还是值类型？enum、int-和string呢？"><a href="#3-delegate是引用类型还是值类型？enum、int-和string呢？" class="headerlink" title="3. delegate是引用类型还是值类型？enum、int[]和string呢？"></a>3. delegate是引用类型还是值类型？enum、int[]和string呢？</h3><p>enum 枚举是值类型，其他都是引用类型。</p>
<h3 id="4-堆和栈的区别？"><a href="#4-堆和栈的区别？" class="headerlink" title="4. 堆和栈的区别？"></a>4. 堆和栈的区别？</h3><p>线程堆栈：简称栈 Stack<br>托管堆： 简称堆 Heap</p>
<ul>
<li>值类型大多分配在栈上，引用类型都分配在堆上；</li>
<li>栈由操作系统管理，栈上的变量在其作用域完成后就被释放，效率较高，但空间有限。堆受 CLR 的 GC 控制；</li>
<li>栈是基于线程的，每个线程都有自己的线程栈，初始大小为1M。堆是基于进程的，一个进程分配一个堆，堆的大小由 GC 根据运行情况动态控制；</li>
</ul>
<h3 id="5-“结构”对象可能分配在堆上吗？什么情况下会发生，有什么需要注意的吗？"><a href="#5-“结构”对象可能分配在堆上吗？什么情况下会发生，有什么需要注意的吗？" class="headerlink" title="5.“结构”对象可能分配在堆上吗？什么情况下会发生，有什么需要注意的吗？"></a>5.“结构”对象可能分配在堆上吗？什么情况下会发生，有什么需要注意的吗？</h3><p>结构是值类型，有两种情况会分配在对上面：</p>
<ul>
<li>结构作为class的一个字段或属性，会随class一起分配在堆上面；</li>
<li>装箱后会在堆中存储，尽量避免值类型的装箱，值类型的拆箱和装箱都有性能损失；</li>
</ul>
<h3 id="6-理解参数按值传递？以及按引用传递？"><a href="#6-理解参数按值传递？以及按引用传递？" class="headerlink" title="6. 理解参数按值传递？以及按引用传递？"></a>6. 理解参数按值传递？以及按引用传递？</h3><ul>
<li>按值传递：对于值类型传递的它的值拷贝副本，而引用类型传递的是引用变量的内存地址，他们还是指向的同一个对象。</li>
<li>按引用传递：通过关键字 out 和 ref 传递参数的内存地址，值类型和引用类型的效果是相同的。</li>
</ul>
<h3 id="7-out-和-ref的区别与相同点？"><a href="#7-out-和-ref的区别与相同点？" class="headerlink" title="7. out 和 ref的区别与相同点？"></a>7. <code>out</code> 和 <code>ref</code>的区别与相同点？</h3><ul>
<li><code>out</code> 和 <code>ref</code> 都指示编译器传递参数地址，在行为上是相同的；</li>
<li>他们的使用机制稍有不同，ref 要求参数在使用之前要显式初始化，out 要在方法内部初始化；</li>
<li><code>out</code> 和 <code>ref</code> 不可以重载，就是不能定义 Method(ref int a) 和 Method(out int a) 这样的重载，从编译角度看，二者的实质是相同的，只是使用时有区别；</li>
</ul>
<h3 id="8-C-支持哪几个预定义的值类型？C-支持哪些预定义的引用类型？"><a href="#8-C-支持哪几个预定义的值类型？C-支持哪些预定义的引用类型？" class="headerlink" title="8. C#支持哪几个预定义的值类型？C#支持哪些预定义的引用类型？"></a>8. C#支持哪几个预定义的值类型？C#支持哪些预定义的引用类型？</h3><p>值类型：整数、浮点数、字符、bool 和 decimal</p>
<p>引用类型：Object，String</p>
<h3 id="9-有几种方法可以判定值类型和引用类型？"><a href="#9-有几种方法可以判定值类型和引用类型？" class="headerlink" title="9. 有几种方法可以判定值类型和引用类型？"></a>9. 有几种方法可以判定值类型和引用类型？</h3><p>简单来说，继承自 System.ValueType 的是值类型，反之是引用类型。</p>
<h3 id="10-说说值类型和引用类型的生命周期？"><a href="#10-说说值类型和引用类型的生命周期？" class="headerlink" title="10. 说说值类型和引用类型的生命周期？"></a>10. 说说值类型和引用类型的生命周期？</h3><p>值类型在作用域结束后释放。</p>
<p>引用类型由 GC 垃圾回收期回收。</p>
<h3 id="11-如果结构体中定义引用类型，对象在内存中是如何存储的？例如下面结构体中的class类-User对象是存储在栈上，还是堆上？"><a href="#11-如果结构体中定义引用类型，对象在内存中是如何存储的？例如下面结构体中的class类-User对象是存储在栈上，还是堆上？" class="headerlink" title="11. 如果结构体中定义引用类型，对象在内存中是如何存储的？例如下面结构体中的class类 User对象是存储在栈上，还是堆上？"></a>11. 如果结构体中定义引用类型，对象在内存中是如何存储的？例如下面结构体中的class类 User对象是存储在栈上，还是堆上？</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> MyStruct</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Index;</span><br><span class="line">    <span class="keyword">public</span> User User;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MyStruct 存储在栈中，其字段 User 的实例存储在堆中，MyStruct.User 字段存储指向 User 对象的内存地址。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/anding/p/5229756.html">.NET面试题解析(01)-值类型与引用类型</a></p>
<p><a target="_blank" rel="noopener" href="https://phodal.github.io/2md/">2md</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gjahead/archive/2008/02/28/1084871.html">C#基础：ref和out的区别</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/11/14/CSharp%E4%B8%AD%E8%BF%AD%E4%BB%A3%E5%99%A8-yield-return%E7%94%A8%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/14/CSharp%E4%B8%AD%E8%BF%AD%E4%BB%A3%E5%99%A8-yield-return%E7%94%A8%E6%B3%95/" class="post-title-link" itemprop="url">CSharp中迭代器-yield-return用法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-11-14 10:59:41" itemprop="dateCreated datePublished" datetime="2018-11-14T10:59:41+00:00">2018-11-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 07:00:06" itemprop="dateModified" datetime="2021-04-07T07:00:06+00:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSharp%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">CSharp基础</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CSharp中迭代器yield-return用法"><a href="#CSharp中迭代器yield-return用法" class="headerlink" title="CSharp中迭代器yield-return用法"></a>CSharp中迭代器yield-return用法</h1><h2 id="迭代器方法"><a href="#迭代器方法" class="headerlink" title="迭代器方法"></a>迭代器方法</h2><p>迭代器方法有一个重要限制：在同一方法中不能同时使用 return 语句和 yield return 语句。</p>
<p>此限制通常不是问题。 可以选择在整个方法中使用 yield return，或选择将原始方法分成多个方法，一些使用 return，另一些使用 yield return。</p>
<p>使用 yield return 上下文关键字定义迭代器方法。</p>
<p>yield关键字用于遍历循环中，<code>yield return</code>用于返回<code>IEnumerable&lt;T&gt;</code>；<br><code>yield break</code>用于终止循环遍历。</p>
<h2 id="简单理解"><a href="#简单理解" class="headerlink" title="简单理解"></a>简单理解</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> onOff = <span class="literal">false</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable <span class="title">ForExample</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;  <span class="comment">// 第一次调用时执行  </span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">return</span> <span class="string">&quot;2&quot;</span>;  <span class="comment">// 第二次调用时执行  </span></span><br><span class="line">    <span class="keyword">if</span> (onOff)         <span class="comment">// 第三次调用时执行  </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 执行 yield break 之后不再执行下面语句  </span></span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 否则,onOff为 false  </span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">return</span> <span class="string">&quot;3&quot;</span>;  <span class="comment">// 第四次调用时执行  </span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">return</span> <span class="string">&quot;4&quot;</span>;  <span class="comment">// 第五次调用时执行  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>以下int类型的集合，需要打印出所有值大于2的元素。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> List&lt;<span class="built_in">int</span>&gt; <span class="title">GetInitialData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;()&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不使用yield-return的实现"><a href="#不使用yield-return的实现" class="headerlink" title="不使用yield return的实现"></a>不使用yield return的实现</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> IEnumerable&lt;<span class="built_in">int</span>&gt; <span class="title">FilterWithoutYield</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    List&lt;<span class="built_in">int</span>&gt; result = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="function"><span class="built_in">int</span> i <span class="keyword">in</span> <span class="title">GetInitialData</span>(<span class="params"></span>))</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            result.Add(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端调用：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="function"><span class="keyword">var</span> item <span class="keyword">in</span> <span class="title">FilterWithoutYield</span>(<span class="params"></span>))</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Console.WriteLine(item);</span><br><span class="line">&#125;</span><br><span class="line">Console.ReadKey();</span><br></pre></td></tr></table></figure>

<p>结果：3，4</p>
<h3 id="使用yeild-return实现"><a href="#使用yeild-return实现" class="headerlink" title="使用yeild return实现"></a>使用yeild return实现</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> IEnumerable&lt;<span class="built_in">int</span>&gt; <span class="title">FilterWithYield</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="function"><span class="built_in">int</span> i <span class="keyword">in</span> <span class="title">GetInitialData</span>(<span class="params"></span>))</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">break</span>; <span class="comment">// 执行 yield break 之后不再执行下面语句</span></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;这里的代码不执行&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="function"><span class="keyword">var</span> item <span class="keyword">in</span> <span class="title">FilterWithYield</span>(<span class="params"></span>))</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Console.WriteLine(item);</span><br><span class="line">&#125;</span><br><span class="line">Console.ReadKey();</span><br></pre></td></tr></table></figure>

<p>结果：3，4</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>第一种方法（不使用yield），是把结果集全部加载到内存中再遍历；</p>
<p>第二种方法（使用yield），客户端每调用一次，yield return就返回一个值给客户端，是”按需供给”。</p>
<p>使用yield return为什么能保证每次循环遍历的时候从前一次停止的地方开始执行呢？</p>
<p>–因为，编译器会生成一个状态机来维护迭代器的状态。</p>
<p>简单地说，当希望获取一个<code>IEnumerable&lt;T&gt;</code>类型的集合，而不想把数据一次性加载到内存，就可以考虑使用yield return实现”按需供给”。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/iterators">https://docs.microsoft.com/zh-cn/dotnet/csharp/iterators</a></p>
<p><a target="_blank" rel="noopener" href="http://phpstudy.php.cn/b.php/97674.html">C#中yield return用法分析</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Golden_Shadow/article/details/7204226">C#中 yield return 与 yield break</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/08/24/MongoDB-%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/24/MongoDB-%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81/" class="post-title-link" itemprop="url">MongoDB 安全认证</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-24 11:37:04" itemprop="dateCreated datePublished" datetime="2018-08-24T11:37:04+00:00">2018-08-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 07:00:06" itemprop="dateModified" datetime="2021-04-07T07:00:06+00:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="MongoDB权限介绍"><a href="#MongoDB权限介绍" class="headerlink" title="MongoDB权限介绍"></a>MongoDB权限介绍</h2><ul>
<li><p>1.MongoDB安装时不添加任何参数,默认是没有权限验证的,登录的用户可以对数据库任意操作而且可以远程访问数据库，需以 <code>--auth</code> 参数启动。</p>
</li>
<li><p>2.在刚安装完毕的时候 <code>MongoDB</code> 都默认有一个 <code>admin</code> 数据库,此时admin数据库是空的,没有记录权限相关的信息。当 <code>admin.system.users</code> 一个用户都没有时，即使 <code>mongod</code> 启动时添加了 <code>--auth</code> 参数,如果没有在 <code>admin</code> 数据库中添加用户,此时不进行任何认证还是可以做任何操作(不管是否是以 <code>--auth</code> 参数启动),直到在 <code>admin.system.users</code> 中添加了一个用户。</p>
</li>
<li><p>3.MongoDB的访问分为连接和权限验证，即使以 <code>--auth</code> 参数启动还是可以不使用用户名连接数据库，但是不会有任何的权限进行任何操作</p>
</li>
<li><p>4.<code>admin</code> 数据库中的用户名可以管理所有数据库，其他数据库中的用户只能管理其所在的数据库。</p>
</li>
</ul>
<h2 id="MongoDB中用户的角色说明"><a href="#MongoDB中用户的角色说明" class="headerlink" title="MongoDB中用户的角色说明"></a>MongoDB中用户的角色说明</h2><ul>
<li>read角色：数据库的只读权限</li>
<li>readWrite角色：数据库的读写权限</li>
<li>dbAdmin角色：数据库的管理权限，不具备读写权限</li>
<li>userAdmin角色：数据库的用户管理权限</li>
<li>clusterAdmin角色：集群管理权限(副本集、分片、主从等相关管理)</li>
<li>readAnyDatabase角色：任何数据库的只读权限(和read相似)</li>
<li>readWriteAnyDatabase角色：任何数据库的读写权限(和readWrite相似)</li>
<li>userAdminAnyDatabase角色：任何数据库用户的管理权限(和userAdmin相似)</li>
<li>dbAdminAnyDatabase角色：任何数据库的管理权限(dbAdmin相似)</li>
</ul>
<h2 id="启用访问控制和强制认证"><a href="#启用访问控制和强制认证" class="headerlink" title="启用访问控制和强制认证"></a>启用访问控制和强制认证</h2><h3 id="在admin数据库中，创建一个admin-用户"><a href="#在admin数据库中，创建一个admin-用户" class="headerlink" title="在admin数据库中，创建一个admin 用户"></a>在admin数据库中，创建一个admin 用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line">db.createUser(&#123;</span><br><span class="line">    user:<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    <span class="built_in">pwd</span>:<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    roles:[&#123;</span><br><span class="line">        role:<span class="string">&quot;root&quot;</span>,</span><br><span class="line">        db:<span class="string">&quot;admin&quot;</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;)</span><br><span class="line">db.auth(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;admin&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="对具体的库进行授权"><a href="#对具体的库进行授权" class="headerlink" title="对具体的库进行授权"></a>对具体的库进行授权</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">use mydb</span><br><span class="line">db.createUser(&#123;</span><br><span class="line">    user:<span class="string">&quot;mydbuser1&quot;</span>,</span><br><span class="line">    <span class="built_in">pwd</span>:<span class="string">&quot;123456&quot;</span>,</span><br><span class="line">    roles:[&#123;</span><br><span class="line">        role:<span class="string">&quot;dbAdmin&quot;</span>,</span><br><span class="line">        db:<span class="string">&quot;mydb&quot;</span></span><br><span class="line">    &#125;,&#123;</span><br><span class="line">        role:<span class="string">&quot;readWrite&quot;</span>,</span><br><span class="line">        db:<span class="string">&quot;mydb&quot;</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;)</span><br><span class="line">db.auth(<span class="string">&quot;mydbuser1&quot;</span>, <span class="string">&quot;123456&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 添加用户</span><br><span class="line">use admin</span><br><span class="line">db.addUser(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;test&quot;</span>)</span><br><span class="line"></span><br><span class="line">// 显示所有数据库</span><br><span class="line">show dbs</span><br><span class="line"></span><br><span class="line">// 使用某个数据库</span><br><span class="line">use mydb</span><br><span class="line"></span><br><span class="line">// 连接数据库</span><br><span class="line">mongo <span class="built_in">test</span> -uroot -p123456</span><br><span class="line"></span><br><span class="line">// 添加用户认证</span><br><span class="line">db.auth(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;password&quot;</span>)</span><br><span class="line"></span><br><span class="line">// 查看用户</span><br><span class="line">db.system.users.find()</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://wps2015.org/drops/drops/MongoDB%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE.html">MongoDB安全配置</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zZ_life/article/details/78664794">MongoDB 3.4.2 添加用户、设置权限</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/tutorial/enable-authentication/">https://docs.mongodb.com/manual/tutorial/enable-authentication/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/08/21/Docker%E5%AE%89%E8%A3%85MongoDB4-1%E7%BE%A4%E9%9B%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/21/Docker%E5%AE%89%E8%A3%85MongoDB4-1%E7%BE%A4%E9%9B%86/" class="post-title-link" itemprop="url">Docker安装MongoDB4.1群集</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-21 10:37:53" itemprop="dateCreated datePublished" datetime="2018-08-21T10:37:53+00:00">2018-08-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 07:00:06" itemprop="dateModified" datetime="2021-04-07T07:00:06+00:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="docker安装mongodb4-1群集"><a href="#docker安装mongodb4-1群集" class="headerlink" title="docker安装mongodb4.1群集"></a>docker安装mongodb4.1群集</h1><p>官网：<a target="_blank" rel="noopener" href="https://www.mongodb.com">https://www.mongodb.com</a></p>
<p>镜像：<a target="_blank" rel="noopener" href="https://hub.docker.com/_/mongo/">https://hub.docker.com/_/mongo/</a></p>
<p>github: <a target="_blank" rel="noopener" href="https://github.com/docker-library/mongo/blob/4958ee0a8a6b1ac1c3734b161db67371720b31b5/4.1/Dockerfile">Dockerfile</a></p>
<h2 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h2><p><img src="/img/sharded-cluster-production-architecture.bakedsvg.svg" alt="sharded-cluster-production-architecture.bakedsvg.svg"></p>
<p>路由，分片、副本集、配置服务器</p>
<p>四个组件：<code>mongos</code>、<code>config server</code>、<code>shard</code>、<code>replica set</code>。</p>
<ul>
<li><p><code>mongos</code>，数据库集群请求的入口，所有的请求都通过 <code>mongos</code> 进行协调，不需要在应用程序添加一个路由选择器，<code>mongos</code> 自己就是一个请求分发中心，它负责把对应的数据请求请求转发到对应的 <code>shard</code> 服务器上。在生产环境通常有多 <code>mongos</code> 作为请求的入口，防止其中一个挂掉所有的 <code>mongodb</code> 请求都没有办法操作。</p>
</li>
<li><p><code>config server</code>，顾名思义为配置服务器，存储所有数据库元信息（路由、分片）的配置。<code>mongos</code> 本身没有物理存储分片服务器和数据路由信息，只是缓存在内存里，配置服务器则实际存储这些数据。<code>mongos</code> 第一次启动或者关掉重启就会从 <code>config server</code> 加载配置信息，以后如果配置服务器信息变化会通知到所有的 <code>mongos</code> 更新自己的状态，这样 <code>mongos</code> 就能继续准确路由。在生产环境通常有多个 <code>config server</code> 配置服务器，因为它存储了分片路由的元数据，防止数据丢失！</p>
</li>
<li><p><code>shard</code>，分片（<code>sharding</code>）是指将数据库拆分，将其分散在不同的机器上的过程。将数据分散到不同的机器上，不需要功能强大的服务器就可以存储更多的数据和处理更大的负载。基本思想就是将集合切成小块，这些块分散到若干片里，每个片只负责总数据的一部分，最后通过一个均衡器来对各个分片进行均衡（数据迁移）。</p>
</li>
<li><p><code>replica set</code>，中文翻译 <code>副本集</code>，其实就是 <code>shard</code> 的备份，防止 <code>shard</code> 挂掉之后数据丢失。复制提供了数据的冗余备份，并在多个服务器上存储数据副本，提高了数据的可用性， 并可以保证数据的安全性。</p>
</li>
</ul>
<p><code>仲裁者（Arbiter）</code>，是复制集中的一个 <code>MongoDB</code> 实例，它并不保存数据。仲裁节点使用最小的资源并且不要求硬件设备，不能将 <code>Arbiter</code> 部署在同一个数据集节点中，可以部署在其他应用服务器或者监视服务器中，也可部署在单独的虚拟机中。为了确保复制集中有奇数的投票成员（包括 <code>primary</code> ），需要添加仲裁节点做为投票，否则 <code>primary</code> 不能运行时不会自动切换 <code>primary</code>。</p>
<p>注：<code>mongodb3.4</code> 以后要求配置服务器也创建副本集，不然集群搭建不成功。</p>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>目录结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongodb</span><br><span class="line"> |--docker-compose.yml</span><br><span class="line"> |- mongodbtest</span><br></pre></td></tr></table></figure>

<p>创建2个路由服务（<code>mongos</code>） 命令：<code>configdb</code></p>
<p>创建3个配置服务（<code>configsvr</code> ）</p>
<p>创建2个分片服务（<code>shardsvr</code>），每个 <code>shardsvr</code> 包含3个副本，其中1个主节点，1个从节点，1个仲裁节点。</p>
<h3 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h3><p>在 <code>mongodb</code> 目录运行以下命令生成目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/toor/Documents/mongodb/mongodbtest/mongos1 <span class="comment"># mongos1</span></span><br><span class="line">mkdir -p /home/toor/Documents/mongodb/mongodbtest/mongos2 <span class="comment"># mongos2</span></span><br><span class="line">mkdir -p /home/toor/Documents/mongodb/mongodbtest/cs/rs1 /home/toor/Documents/mongodb/mongodbtest/cs/rs2 /home/toor/Documents/mongodb/mongodbtest/cs/rs3 <span class="comment"># config server replset</span></span><br><span class="line">mkdir -p /home/toor/Documents/mongodb/mongodbtest/sh1/rs1 /home/toor/Documents/mongodb/mongodbtest/sh1/rs2 /home/toor/Documents/mongodb/mongodbtest/sh1/rs3 <span class="comment"># sharding</span></span><br><span class="line">mkdir -p /home/toor/Documents/mongodb/mongodbtest/sh2/rs1 /home/toor/Documents/mongodb/mongodbtest/sh2/rs2 /home/toor/Documents/mongodb/mongodbtest/sh2/rs3 <span class="comment"># sharding</span></span><br></pre></td></tr></table></figure>

<h3 id="创建docker-compose"><a href="#创建docker-compose" class="headerlink" title="创建docker-compose"></a>创建docker-compose</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch docker-compose.yml</span><br><span class="line">vim docker-compose.yml</span><br></pre></td></tr></table></figure>

<p>docker-compose.yml内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  csrs1:</span><br><span class="line">    image: mongo:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="variable">$PWD</span>/mongodbtest/cs/rs1:/data/db</span><br><span class="line">    <span class="built_in">command</span>: mongod --noauth --configsvr --replSet csrs --dbpath /data/db</span><br><span class="line">  csrs2:</span><br><span class="line">    image: mongo:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="variable">$PWD</span>/mongodbtest/cs/rs2:/data/db</span><br><span class="line">    <span class="built_in">command</span>: mongod --noauth --configsvr --replSet csrs --dbpath /data/db</span><br><span class="line">  csrs3:</span><br><span class="line">    image: mongo:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="variable">$PWD</span>/mongodbtest/cs/rs3:/data/db</span><br><span class="line">    <span class="built_in">command</span>: mongod --noauth --configsvr --replSet csrs --dbpath /data/db</span><br><span class="line">  mongos1:</span><br><span class="line">    image: mongo:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="variable">$PWD</span>/mongodbtest/mongos1:/data/db</span><br><span class="line">    <span class="built_in">command</span>: mongos --noauth --configdb csrs/csrs1:27019,csrs2:27019,csrs3:27019</span><br><span class="line">  mongos2:</span><br><span class="line">    image: mongo:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="variable">$PWD</span>/mongodbtest/mongos2:/data/db</span><br><span class="line">    <span class="built_in">command</span>: mongos --noauth --configdb csrs/csrs1:27019,csrs2:27019,csrs3:27019</span><br><span class="line">  sh1rs1:</span><br><span class="line">    image: mongo:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="variable">$PWD</span>/mongodbtest/sh1/rs1:/data/db</span><br><span class="line">    <span class="built_in">command</span>: mongod --noauth --dbpath /data/db --shardsvr --replSet shrs1</span><br><span class="line">  sh1rs2:</span><br><span class="line">    image: mongo:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="variable">$PWD</span>/mongodbtest/sh1/rs2:/data/db</span><br><span class="line">    <span class="built_in">command</span>: mongod --noauth --dbpath /data/db --shardsvr --replSet shrs1</span><br><span class="line">  sh1rs3:</span><br><span class="line">    image: mongo:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="variable">$PWD</span>/mongodbtest/sh1/rs3:/data/db</span><br><span class="line">    <span class="built_in">command</span>: mongod --noauth --dbpath /data/db --shardsvr --replSet shrs1</span><br><span class="line">  sh2rs1:</span><br><span class="line">    image: mongo:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="variable">$PWD</span>/mongodbtest/sh2/rs1:/data/db</span><br><span class="line">    <span class="built_in">command</span>: mongod --noauth --dbpath /data/db --shardsvr --replSet shrs2</span><br><span class="line">  sh2rs2:</span><br><span class="line">    image: mongo:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="variable">$PWD</span>/mongodbtest/sh2/rs2:/data/db</span><br><span class="line">    <span class="built_in">command</span>: mongod --noauth --dbpath /data/db --shardsvr --replSet shrs2</span><br><span class="line">  sh2rs3:</span><br><span class="line">    image: mongo:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="variable">$PWD</span>/mongodbtest/sh2/rs3:/data/db</span><br><span class="line">    <span class="built_in">command</span>: mongod --noauth --dbpath /data/db --shardsvr --replSet shrs2</span><br></pre></td></tr></table></figure>

<p>注：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">--noauth 不进行身份认证</span><br><span class="line">--auth 进行身份认证</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不加会有一个28017的端口监听，可以通过网页管理mongodb，不需要请去掉</span></span><br><span class="line">--nohttpinterface</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这两个参数的作用就是改变启动端口</span></span><br><span class="line">--shardsvr</span><br><span class="line">--configsvr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 副本集设置</span></span><br><span class="line">--replSet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这一项是用来指定chunk的大小的，单位是MB，默认大小为200MB</span></span><br><span class="line">--chunkSize</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以限制访问的ip</span></span><br><span class="line">--bind_ip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以重新制定端口，默认为27017</span></span><br><span class="line">--port</span><br></pre></td></tr></table></figure>

<h3 id="初始化-配置服务-副本集-Config-Server"><a href="#初始化-配置服务-副本集-Config-Server" class="headerlink" title="初始化[配置服务]副本集(Config Server)"></a>初始化[配置服务]副本集(Config Server)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="built_in">exec</span> csrs1 mongo --port 27019</span><br><span class="line">rs.initiate()</span><br><span class="line">rs.add(<span class="string">&#x27;csrs2:27019&#x27;</span>)</span><br><span class="line">rs.add(<span class="string">&#x27;csrs3:27019&#x27;</span>)</span><br><span class="line">rs.status() //查看状态</span><br><span class="line">quit() // 退出 或 <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<p>注：<code>config server</code> 默认端口为 27019</p>
<h3 id="初始化分片"><a href="#初始化分片" class="headerlink" title="初始化分片"></a>初始化分片</h3><p>注：<code>shard server</code> 默认端口号为 27018</p>
<h4 id="shrs1副本集"><a href="#shrs1副本集" class="headerlink" title="shrs1副本集"></a>shrs1副本集</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="built_in">exec</span> sh1rs1 mongo --port 27018</span><br><span class="line">rs.initiate()</span><br><span class="line">var cfg = rs.conf()</span><br><span class="line">cfg.members[0].host = <span class="string">&#x27;sh1rs1:27018&#x27;</span></span><br><span class="line">rs.reconfig(cfg)</span><br><span class="line">rs.add(<span class="string">&#x27;sh1rs2:27018&#x27;</span>)</span><br><span class="line">rs.add(&#123;host:<span class="string">&quot;sh1rs3:27018&quot;</span>, arbiterOnly:<span class="literal">true</span>&#125;) // 仲裁</span><br><span class="line">quit()</span><br></pre></td></tr></table></figure>

<h4 id="shrs2副本集"><a href="#shrs2副本集" class="headerlink" title="shrs2副本集"></a>shrs2副本集</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="built_in">exec</span> sh2rs1 mongo --port 27018</span><br><span class="line">rs.initiate()</span><br><span class="line">var cfg = rs.conf()</span><br><span class="line">cfg.members[0].host = <span class="string">&#x27;sh2rs1:27018&#x27;</span></span><br><span class="line">rs.reconfig(cfg)</span><br><span class="line">rs.add(<span class="string">&#x27;sh2rs2:27018&#x27;</span>)</span><br><span class="line">rs.add(&#123;host:<span class="string">&quot;sh2rs3:27018&quot;</span>, arbiterOnly:<span class="literal">true</span>&#125;)</span><br><span class="line">quit()</span><br></pre></td></tr></table></figure>

<h3 id="通过mongos添加分片关系到configsvr"><a href="#通过mongos添加分片关系到configsvr" class="headerlink" title="通过mongos添加分片关系到configsvr"></a>通过mongos添加分片关系到configsvr</h3><p>mongos1:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="built_in">exec</span> mongos1 mongo</span><br><span class="line">sh.addShard(<span class="string">&#x27;shrs1/sh1rs1:27018,sh1rs2:27018,sh1rs3:27018&#x27;</span>)</span><br><span class="line">sh.addShard(<span class="string">&#x27;shrs2/sh2rs1:27018,sh2rs2:27018,sh2rs3:27018&#x27;</span>)</span><br><span class="line">sh.status() //查看状态</span><br></pre></td></tr></table></figure>

<p>mongos2:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="built_in">exec</span> mongos2 mongo</span><br><span class="line">sh.addShard(<span class="string">&#x27;shrs1/sh1rs1:27018,sh1rs2:27018,sh1rs3:27018&#x27;</span>)</span><br><span class="line">sh.addShard(<span class="string">&#x27;shrs2/sh2rs1:27018,sh2rs2:27018,sh2rs3:27018&#x27;</span>)</span><br><span class="line">sh.status() //查看状态</span><br></pre></td></tr></table></figure>

<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20180824094655.png" alt="QQ截图20180824094655.png"></p>
<h2 id="启用分片"><a href="#启用分片" class="headerlink" title="启用分片"></a>启用分片</h2><h3 id="设置分片chunk大小"><a href="#设置分片chunk大小" class="headerlink" title="设置分片chunk大小"></a>设置分片chunk大小</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use config</span><br><span class="line">db.settings.save(&#123;<span class="string">&quot;_id&quot;</span>:<span class="string">&quot;chunksize&quot;</span>,<span class="string">&quot;value&quot;</span>:1&#125;) // //设置块大小为1M是方便实验，不然就需要插入海量数据</span><br></pre></td></tr></table></figure>

<h3 id="启用数据库分片"><a href="#启用数据库分片" class="headerlink" title="启用数据库分片"></a>启用数据库分片</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  数据库分片就有针对性，可以自定义需要分片的库或者表，毕竟也不是所有数据都是需要分片操作的</span></span><br><span class="line">sh.enableSharding(<span class="string">&quot;python&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#  为表创建的索引,以”id“为索引</span></span><br><span class="line">db.user.createIndex(&#123;<span class="string">&quot;id&quot;</span>:1&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用表分片</span></span><br><span class="line">sh.shardCollection(<span class="string">&quot;python.user&quot;</span>,&#123;<span class="string">&quot;id&quot;</span>:1&#125;)</span><br><span class="line">sh.status()</span><br></pre></td></tr></table></figure>

<h3 id="模拟写入数据"><a href="#模拟写入数据" class="headerlink" title="模拟写入数据"></a>模拟写入数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use python</span><br><span class="line"><span class="keyword">for</span>(i=1;i&lt;=50000;i++)&#123;db.user.insert(&#123;<span class="string">&quot;id&quot;</span>:i,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;jack&quot;</span>+i&#125;)&#125;</span><br><span class="line">sh.status()</span><br><span class="line">db.user.stats()</span><br><span class="line">db.user.count()</span><br><span class="line">show dbs</span><br></pre></td></tr></table></figure>

<h2 id="后期运维"><a href="#后期运维" class="headerlink" title="后期运维"></a>后期运维</h2><p>mongodb 的启动顺序是，先启动配置服务器，在启动分片，最后启动 mongos.</p>
<p>关闭时，直接 <code>killall</code> 杀掉所有进程</p>
<p>例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">killall mongod</span><br><span class="line">killall mongos</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.ityouknow.com/mongodb/2017/08/05/mongodb-cluster-setup.html">mongodb 3.4 集群搭建：分片+副本集</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.51cto.com/13643643/2148825">MongoDB(4.0)分片——大数据的处理之道</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ityouknow/p/7566682.html">mongodb 3.4 集群搭建升级版 五台集群</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4d86e9c33e0d">docker 搭建 mongo 集群</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hehexiaoxia/p/6192796.html">[原创]在Docker上部署mongodb分片副本集群</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/08/14/CentOS7%E5%AE%89%E8%A3%85MariaDB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/14/CentOS7%E5%AE%89%E8%A3%85MariaDB/" class="post-title-link" itemprop="url">CentOS7安装MariaDB</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-14 15:08:05" itemprop="dateCreated datePublished" datetime="2018-08-14T15:08:05+00:00">2018-08-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 07:00:06" itemprop="dateModified" datetime="2021-04-07T07:00:06+00:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MariaDB/" itemprop="url" rel="index"><span itemprop="name">MariaDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CentOS7安装MariaDB"><a href="#CentOS7安装MariaDB" class="headerlink" title="CentOS7安装MariaDB"></a>CentOS7安装MariaDB</h1><h2 id="MariaDB简介"><a href="#MariaDB简介" class="headerlink" title="MariaDB简介"></a>MariaDB简介</h2><p>官网：<a target="_blank" rel="noopener" href="https://mariadb.org/">https://mariadb.org/</a></p>
<p>MariaDB Github地址：<a target="_blank" rel="noopener" href="https://github.com/MariaDB/server">https://github.com/MariaDB/server</a></p>
<h2 id="安装MariaDB"><a href="#安装MariaDB" class="headerlink" title="安装MariaDB"></a>安装MariaDB</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">su root <span class="comment">## 切换root用户</span></span><br><span class="line">yum -y install mariadb-server mariadb <span class="comment">## 下载MariaDB</span></span><br><span class="line">yum -y install mariadb-server mariadb <span class="comment">## 启动MariaDB服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb <span class="comment">## 设置默认开机启动 可选</span></span><br></pre></td></tr></table></figure>

<h2 id="测试是否成功"><a href="#测试是否成功" class="headerlink" title="测试是否成功"></a>测试是否成功</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost toor]<span class="comment"># mysql</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 2</span><br><span class="line">Server version: 5.5.56-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br></pre></td></tr></table></figure>

<h2 id="运行一次mysql-secure-installation安全配置向导"><a href="#运行一次mysql-secure-installation安全配置向导" class="headerlink" title="运行一次mysql_secure_installation安全配置向导"></a>运行一次mysql_secure_installation安全配置向导</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#由于一开始安装MariaDB数据库后, root用户默认密码为空, 所以只需要按Enter键</span></span><br><span class="line">Enter current password <span class="keyword">for</span> root (enter <span class="keyword">for</span> none):</span><br><span class="line">OK, successfully used password, moving on...</span><br><span class="line"></span><br><span class="line"><span class="comment">#是否设置root用户的新密码</span></span><br><span class="line">Set root password? [Y/n] y</span><br><span class="line"></span><br><span class="line"><span class="comment">#录入新密码</span></span><br><span class="line">New password:</span><br><span class="line"></span><br><span class="line"><span class="comment">#确认新密码</span></span><br><span class="line">Re-enter new password:</span><br><span class="line"></span><br><span class="line"><span class="comment">#是否删除匿名用户,生产环境建议删除</span></span><br><span class="line">Remove anonymous users? [Y/n] y</span><br><span class="line">... Success!</span><br><span class="line"></span><br><span class="line"><span class="comment">#是否禁止root远程登录,根据自己的需求选择</span></span><br><span class="line">Disallow root login remotely? [Y/n] n</span><br><span class="line">... skipping.</span><br><span class="line"></span><br><span class="line"><span class="comment">#是否删除test数据库</span></span><br><span class="line">Remove <span class="built_in">test</span> database and access to it? [Y/n] y</span><br><span class="line"></span><br><span class="line"><span class="comment">#是否重新加载权限表</span></span><br><span class="line">Reload privilege tables now? [Y/n] y</span><br><span class="line"> ... Success!</span><br></pre></td></tr></table></figure>

<h2 id="开放端口"><a href="#开放端口" class="headerlink" title="开放端口"></a>开放端口</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=3306/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h2 id="开放远程连接"><a href="#开放远程连接" class="headerlink" title="开放远程连接"></a>开放远程连接</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p <span class="comment">## 登录mysql xing123123</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#任何远程主机都可以访问数据库</span></span><br><span class="line">mysql&gt; grant all privileges on *.* to <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#使修改生效</span></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">mysql&gt; <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h2 id="修改编码为UTF-8"><a href="#修改编码为UTF-8" class="headerlink" title="修改编码为UTF-8"></a>修改编码为UTF-8</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br></pre></td></tr></table></figure>

<p>添加以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">character-set-server=utf8</span><br></pre></td></tr></table></figure>

<p>需要重启数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 查看数据库编码</span></span><br><span class="line"></span><br><span class="line"> mysql -uroot -p</span><br><span class="line">show variables like <span class="string">&#x27;character%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; show variables like <span class="string">&#x27;character%&#x27;</span>;</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | utf8                       |</span><br><span class="line">| character_set_database   | utf8                       |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | utf8                       |</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h2 id="使用mysql-workbench连接"><a href="#使用mysql-workbench连接" class="headerlink" title="使用mysql workbench连接"></a>使用mysql workbench连接</h2><p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180905104709.png" alt="微信截图_20180905104709.png"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/toubennuhai/article/details/70808610">Centos7 安装配置MariaDB</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/08/07/SSH%E5%AF%86%E9%92%A5%E5%AF%B9%E9%AA%8C%E8%AF%81%E7%99%BB%E5%BD%95-CentOS7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/07/SSH%E5%AF%86%E9%92%A5%E5%AF%B9%E9%AA%8C%E8%AF%81%E7%99%BB%E5%BD%95-CentOS7/" class="post-title-link" itemprop="url">SSH密钥对验证登录-CentOS7</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-07 09:15:05" itemprop="dateCreated datePublished" datetime="2018-08-07T09:15:05+00:00">2018-08-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 07:00:06" itemprop="dateModified" datetime="2021-04-07T07:00:06+00:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SSH/" itemprop="url" rel="index"><span itemprop="name">SSH</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SSH密钥对验证登录"><a href="#SSH密钥对验证登录" class="headerlink" title="SSH密钥对验证登录"></a>SSH密钥对验证登录</h1><p>SSH为<code>Secure Shell</code>的缩写，SSH是目前较可靠，专为远程登录会话和其他网络服务提供安全性的协议。Linux一般自带的是OpenSSH，可以用 <code>ssh -V</code> 查看当前版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[toor@localhost .ssh]$ ssh -V</span><br><span class="line">OpenSSH_6.6.1p1, OpenSSL 1.0.1e-fips 11 Feb 2013</span><br></pre></td></tr></table></figure>

<h2 id="生成密钥对"><a href="#生成密钥对" class="headerlink" title="生成密钥对"></a>生成密钥对</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>

<p>回车会在~/.ssh目录（用户所在家目录下的.ssh目录，如果没有请自行创建.ssh目录）生成id_rsa, id_rsa.pub文件<br>第一个是私有密钥 第二个是公共密钥。</p>
<p>将用户.ssh目录内的两个密钥下载到本地.</p>
<h2 id="配置ssh使用密钥"><a href="#配置ssh使用密钥" class="headerlink" title="配置ssh使用密钥"></a>配置ssh使用密钥</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp id_rsa.pub authorized_keys</span><br></pre></td></tr></table></figure>

<p>修改authorized_keys权限为700（必须修改为700，不能为其他）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 700 authorized_keys</span><br></pre></td></tr></table></figure>

<p>修改配置文件：</p>
<p><code>vim /etc/ssh/sshd_config</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">StrictModes no  </span><br><span class="line">RSAAuthentication yes</span><br><span class="line">PubkeyAuthentication yes</span><br></pre></td></tr></table></figure>

<p>重启ssh服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart sshd.service</span><br></pre></td></tr></table></figure>

<h2 id="win下使用puttygen生成-ppk文件"><a href="#win下使用puttygen生成-ppk文件" class="headerlink" title="win下使用puttygen生成.ppk文件"></a>win下使用puttygen生成.ppk文件</h2><p><img src="/img/QQ%E6%88%AA%E5%9B%BE20180807163438.png" alt="QQ截图20180807163438.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20180807163528.png" alt="QQ截图20180807163528.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20180807163703.png" alt="QQ截图20180807163703.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20180807163742.png" alt="QQ截图20180807163742.png"></p>
<h2 id="测试连接centos主机"><a href="#测试连接centos主机" class="headerlink" title="测试连接centos主机"></a>测试连接centos主机</h2><p>使用pageant Key List管理.ppk文件，如下：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20180807164027.png" alt="QQ截图20180807164027.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20180807164414.png" alt="QQ截图20180807164414.png"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b1eeb3f1a2c1">linux使用密钥+密码登录ssh（centos7）</a></p>
<p><a target="_blank" rel="noopener" href="http://pcvc.net/blog/2015/08/10/centos-7-configuring-ssh-key-based-authentication-login/">CentOS 7配置SSH基于密钥对验证登录</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/08/03/Ocelot%E4%B8%8EConsul%E9%9B%86%E6%88%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/03/Ocelot%E4%B8%8EConsul%E9%9B%86%E6%88%90/" class="post-title-link" itemprop="url">Ocelot与Consul集成</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-03 08:42:09" itemprop="dateCreated datePublished" datetime="2018-08-03T08:42:09+00:00">2018-08-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 07:00:06" itemprop="dateModified" datetime="2021-04-07T07:00:06+00:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ocelot/" itemprop="url" rel="index"><span itemprop="name">Ocelot</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="API网关"><a href="#API网关" class="headerlink" title="API网关"></a>API网关</h1><p>API网关是一个服务器，是系统的唯一入口。从面向对象设计的角度看，它与外观模式类似。API网关封装了系统内部架构，为每个客户端提供一个定制的API。它可能还具有其它职责，如身份验证、监控、负载均衡、缓存、请求分片与管理、静态响应处理。<br>API网关方式的核心要点是，所有的客户端和消费端都通过统一的网关接入微服务，在网关层处理所有的非业务功能。通常，网关也是提供REST/HTTP的访问API。服务端通过API-GW注册和管理服务。</p>
<h2 id="Ocelot简介"><a href="#Ocelot简介" class="headerlink" title="Ocelot简介"></a>Ocelot简介</h2><p>Ocelot是一个使用.NET Core平台上的一个API Gateway，这个项目的目标是在.NET上面运行微服务架构。Ocelot框架内部集成了IdentityServer（身份验证）和Consul（服务注册发现），还引入了Polly（上一篇博文中提到过）来处理进行故障处理。<br>Ocelot的实现原理就是把客户端对网关的请求(Request)，按照configuration.json的映射配置，转发给对应的后端http service，然后从后端http service获取响应(Response)后，再返回给客户端。当然有了网关后，我们可以在网关这层去做统一验证，也可以在网关处统一作监控。</p>
<h2 id="集成Ocelot网关"><a href="#集成Ocelot网关" class="headerlink" title="集成Ocelot网关"></a>集成Ocelot网关</h2><h3 id="新建项目"><a href="#新建项目" class="headerlink" title="新建项目"></a>新建项目</h3><p>新建三个项目，ProductService,ClientService,APIGateWay；</p>
<p>APIGateWay项目新建配置文件。</p>
<p>注意新建的json文件需要更改属性，选择【如果较新则复制】或【始终复制】</p>
<p>参考代码：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/syxdevcode/GateWayDemo.git">https://github.com/syxdevcode/GateWayDemo.git</a></p>
<h3 id="部署项目"><a href="#部署项目" class="headerlink" title="部署项目"></a>部署项目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/syxdevcode/GateWayDemo.git <span class="comment">## 下载项目</span></span><br><span class="line">git pull origin master <span class="comment">## 更新代码</span></span><br><span class="line">docker-compose up -d --build <span class="comment">## 执行docker-compose命令</span></span><br></pre></td></tr></table></figure>

<p>项目成功启动之后，查看运行后的IP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker inspect -f <span class="string">&#x27;&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;</span> gatewaydemo_demo.productservice_1</span><br><span class="line"></span><br><span class="line">docker inspect -f <span class="string">&#x27;&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;</span> gatewaydemo_demo.clientservice_1</span><br></pre></td></tr></table></figure>

<p>记录ClientService和ProductService容器的IP。</p>
<h4 id="开放主机端口"><a href="#开放主机端口" class="headerlink" title="开放主机端口"></a>开放主机端口</h4><p>主要供consul可以访问到网关项目地址。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --add-port=5000/tcp --permanent</span><br><span class="line">sudo firewall-cmd --zone=public --add-port=5001/tcp --permanent</span><br><span class="line">sudo firewall-cmd --zone=public --add-port=5002/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h3 id="重新运行Consul客户端容器"><a href="#重新运行Consul客户端容器" class="headerlink" title="重新运行Consul客户端容器"></a>重新运行Consul客户端容器</h3><p>在consul运行目录-&gt;config目录，新建ocelot_apigateway.json文件，填入已下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;services&quot;</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;gatewaydemo_demo.clientservice_1&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;Demo.ClientService&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;urlprefix-/clientservice&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;172.18.0.4&quot;</span>, <span class="comment">// 对应clientservice容器IP</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span>: <span class="number">5001</span>,</span><br><span class="line">            <span class="attr">&quot;checks&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;clientservice_check&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;http&quot;</span>: <span class="string">&quot;http://172.18.0.4:5001/api/health&quot;</span>,<span class="comment">// 对应clientservice项目连接</span></span><br><span class="line">                    <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;timeout&quot;</span>: <span class="string">&quot;5s&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;gatewaydemo_demo.productservice_1&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;Demo.ProductService&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;urlprefix-/productservice&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;172.18.0.3&quot;</span>, <span class="comment">// 对应productserver容器IP</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span>: <span class="number">5002</span>,</span><br><span class="line">            <span class="attr">&quot;checks&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;productservice_check&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;http&quot;</span>: <span class="string">&quot;http://172.18.0.3:5002/api/health&quot;</span>, <span class="comment">// 对应productservice项目连接</span></span><br><span class="line">                    <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;timeout&quot;</span>: <span class="string">&quot;5s&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">     ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新运行client1容器,如果容器存在，应当先删除容器</p>
<p>需要在consul目录的上一级运行docker run命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rm -f client1</span><br><span class="line">sudo docker run --name=client1 -it -d -p 8500:8500 -v <span class="variable">$PWD</span>/consul:/consul consul agent -config-dir=/consul/config -config-file=/consul/client1.json</span><br></pre></td></tr></table></figure>

<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20180803095300.png" alt="QQ截图20180803095300.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20180803095334.png" alt="QQ截图20180803095334.png"></p>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>新建项目:clientservice1,并且修改如下方法，<br>clientservice项目同样需要修改：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET api/values/5</span></span><br><span class="line">[<span class="meta">HttpGet(<span class="meta-string">&quot;&#123;id&#125;&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span>[] <span class="title">Get</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">$&quot;ClinetService: <span class="subst">&#123;DateTime.Now.ToString()&#125;</span> <span class="subst">&#123;Environment.MachineName&#125;</span> &quot;</span> +</span><br><span class="line">        <span class="string">$&quot;OS: <span class="subst">&#123;Environment.OSVersion.VersionString&#125;</span>&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>部署项目，并获取到容器IP；</p>
<p>ocelot配置文件中负载均衡的设置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;ReRoutes&quot;: [</span><br><span class="line">  &#123;</span><br><span class="line">    .....</span><br><span class="line">    &quot;LoadBalancerOptions&quot;: &#123;</span><br><span class="line">      &quot;Type&quot;: &quot;RoundRobin&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    .....</span><br><span class="line">  &#125;]</span><br></pre></td></tr></table></figure>

<p>负载均衡LoadBalance可选值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RoundRobin - 轮询</span><br><span class="line">LeastConnection - 最小连接数，谁的任务最少谁来</span><br><span class="line">NoLoadBalance - 不要负载均衡</span><br></pre></td></tr></table></figure>

<p>通过consul测试，需要新建一个consul client端：</p>
<p>在consul文件夹下，新建config1文件夹，client2.json文件：</p>
<p>client2.json配置如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;data_dir&quot;</span>: <span class="string">&quot;/data&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;datacenter&quot;</span>: <span class="string">&quot;consul-test&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;log_level&quot;</span>: <span class="string">&quot;INFO&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;node_name&quot;</span>: <span class="string">&quot;client2&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;server&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;ui&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;http_config&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;response_headers&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;Access-Control-Allow-Origin&quot;</span>: <span class="string">&quot;*&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;addresses&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;http&quot;</span>: <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;start_join&quot;</span>: [<span class="string">&quot;172.17.0.2&quot;</span>, <span class="string">&quot;172.17.0.3&quot;</span>, <span class="string">&quot;172.17.0.4&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在config1文件夹下，新建config.json:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    &quot;services&quot;:[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;gatewaydemo_demo.clientservice_1&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;Demo.ClientService&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;urlprefix-/clientservice&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;172.18.0.5&quot;</span>,<span class="comment">// 容器IP</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span>: <span class="number">5003</span>,</span><br><span class="line">            <span class="attr">&quot;checks&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;clientservice_check&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;http&quot;</span>: <span class="string">&quot;http://172.18.0.5:5003/api/health&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;timeout&quot;</span>: <span class="string">&quot;5s&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">     ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>显示结果：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20180803154641.png" alt="QQ截图20180803154641.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20180803154718.png" alt="QQ截图20180803154718.png"></p>
<h2 id="动态路由（Dynamic-Routing）"><a href="#动态路由（Dynamic-Routing）" class="headerlink" title="动态路由（Dynamic Routing）"></a>动态路由（Dynamic Routing）</h2><p>参考代码：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/syxdevcode/GateWayDemo.git">https://github.com/syxdevcode/GateWayDemo.git</a></p>
<p>效果：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20180803173238.png" alt="QQ截图20180803173238.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20180803173307.png" alt="QQ截图20180803173307.png"></p>
<h2 id="集成Swagger统一API文档入口"><a href="#集成Swagger统一API文档入口" class="headerlink" title="集成Swagger统一API文档入口"></a>集成Swagger统一API文档入口</h2><p><img src="/img/QQ%E6%88%AA%E5%9B%BE20180806113303.png" alt="QQ截图20180806113303.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20180806113358.png" alt="QQ截图20180806113358.png"></p>
<p>注：docker部署项目，需要在项目.csproj文件中添加如下属性：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;PropertyGroup&gt;</span><br><span class="line">  &lt;GenerateDocumentationFile&gt;<span class="literal">true</span>&lt;/GenerateDocumentationFile&gt;</span><br><span class="line">  &lt;NoWarn&gt;$(NoWarn);<span class="number">1591</span>&lt;/NoWarn&gt;</span><br><span class="line">&lt;/PropertyGroup&gt;</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edisonchou/p/api_gateway_ocelot_foundation_01.html">.NET Core微服务之基于Ocelot实现API网关服务</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/axzxs2001/p/8487521.html">Ocelot + Consul实践</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/edisonchou/p/api_gateway_ocelot_foundation_02.html">.NET Core微服务之基于Ocelot实现API网关服务（续）</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/savorboard/p/api-gateway.html">谈谈微服务中的 API 网关（API Gateway）</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/08/02/%E7%94%A8%E6%88%B7%E5%90%8D-%E4%B8%8D%E5%9C%A8-sudoers%E6%96%87%E4%BB%B6%E4%B8%AD%EF%BC%8C%E6%AD%A4%E4%BA%8B%E5%B0%86%E8%A2%AB%E6%8A%A5%E5%91%8A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/02/%E7%94%A8%E6%88%B7%E5%90%8D-%E4%B8%8D%E5%9C%A8-sudoers%E6%96%87%E4%BB%B6%E4%B8%AD%EF%BC%8C%E6%AD%A4%E4%BA%8B%E5%B0%86%E8%A2%AB%E6%8A%A5%E5%91%8A/" class="post-title-link" itemprop="url">用户名 不在 sudoers文件中，此事将被报告</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-02 11:22:49" itemprop="dateCreated datePublished" datetime="2018-08-02T11:22:49+00:00">2018-08-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 07:00:06" itemprop="dateModified" datetime="2021-04-07T07:00:06+00:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CentOS7/" itemprop="url" rel="index"><span itemprop="name">CentOS7</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>root账户执行以下命令，或者使用<code>sudo</code>,否则提示权限不足。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sudoers</span><br></pre></td></tr></table></figure>

<p>找到root用户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Allow root to run any commands anywhere</span></span><br><span class="line">root    ALL=(ALL)       ALL</span><br><span class="line">toor    ALL=(ALL)       ALL</span><br></pre></td></tr></table></figure>

<p>:!wq<br>退出保存</p>
<p>sudoers的权限是0440，即只有root才能读。在你用root或sudo后强行保存（wq!）即可。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/08/02/Centos7%E5%AE%89%E8%A3%85Docker-Compose/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/02/Centos7%E5%AE%89%E8%A3%85Docker-Compose/" class="post-title-link" itemprop="url">Centos7安装Docker-Compose</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-02 10:32:55" itemprop="dateCreated datePublished" datetime="2018-08-02T10:32:55+00:00">2018-08-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 07:00:06" itemprop="dateModified" datetime="2021-04-07T07:00:06+00:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker-Compose/" itemprop="url" rel="index"><span itemprop="name">Docker Compose</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="下载包"><a href="#下载包" class="headerlink" title="下载包"></a>下载包</h1><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L https://github.com/docker/compose/releases/download/<span class="number">1.22</span>.<span class="number">0</span>/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<p>注意出现：<code>curl: (35) Peer reports incompatible or unsupported protocol version.</code></p>
<p>需要更新nss,curl</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum update nss curl</span><br></pre></td></tr></table></figure>

<h1 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure>

<h1 id="查看版本"><a href="#查看版本" class="headerlink" title="查看版本"></a>查看版本</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/compose/install/#install-compose">https://docs.docker.com/compose/install/#install-compose</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/07/26/Polly%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E8%8C%83%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/26/Polly%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E8%8C%83%E4%BE%8B/" class="post-title-link" itemprop="url">Polly基本使用范例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-26 16:11:28" itemprop="dateCreated datePublished" datetime="2018-07-26T16:11:28+00:00">2018-07-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 07:00:06" itemprop="dateModified" datetime="2021-04-07T07:00:06+00:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Polly/" itemprop="url" rel="index"><span itemprop="name">Polly</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>Polly是一个被.NET基金会认可的弹性和瞬态故障处理库，允许我们以非常顺畅和线程安全的方式来执诸如行重试</p>
<p>官网：<a target="_blank" rel="noopener" href="http://www.thepollyproject.org/">http://www.thepollyproject.org/</a></p>
<p>源码：<a target="_blank" rel="noopener" href="https://github.com/App-vNext/Polly">https://github.com/App-vNext/Polly</a></p>
<p>其主要功能如下：</p>
<ul>
<li>重试（Retry）</li>
<li>断路器（Circuit-Breaker）</li>
<li>超时检测（Timeout）</li>
<li>隔板隔离 (Bulkhead Isolation)</li>
<li>缓存（Cache）</li>
<li>降级（Fallback）</li>
</ul>
<p>在Polly中，对这些服务容错模式分为两类：</p>
<ul>
<li>错误处理(fault handling)：重试、熔断、回退（降级）</li>
<li>弹性应变(resilience)：超时、舱壁、缓存</li>
</ul>
<p>可以说错误处理是当错误已经发生时，防止由于该错误对整个系统造成更坏的影响而设置。而弹性应变，则在是错误发生前，针对有可能发生错误的地方进行预先处理，从而达到保护整个系统的目地。</p>
<h1 id="错误处理-fault-handling"><a href="#错误处理-fault-handling" class="headerlink" title="错误处理(fault handling)"></a>错误处理(fault handling)</h1><h2 id="重试"><a href="#重试" class="headerlink" title="重试"></a>重试</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Test1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        ISyncPolicy policy = Policy.Handle&lt;ArgumentException&gt;()</span><br><span class="line">        .Retry(<span class="number">2</span>, (ex, retryCount, context) =&gt;</span><br><span class="line">         &#123;</span><br><span class="line">             Console.WriteLine(<span class="string">$&quot;Error occured,runing fallback,exception :<span class="subst">&#123;ex.Message&#125;</span>,retryCount:<span class="subst">&#123;retryCount&#125;</span>&quot;</span>);</span><br><span class="line">         &#125;);</span><br><span class="line"></span><br><span class="line">        policy.Execute(() =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Job Start&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;Hello Polly!&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;There&#x27;s one unhandled exception : &quot;</span> + ex.Message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>.Retry(3) ：按次数重试</li>
<li>.RetryForever() ：不断重试(直到成功)</li>
<li>.WaitAndRetry() ：等待之后重试</li>
<li>.WaitAndRetryForever ：等待并永远重试（直到成功</li>
</ul>
<h2 id="熔断-Circuit-Breaker"><a href="#熔断-Circuit-Breaker" class="headerlink" title="熔断 Circuit Breaker"></a>熔断 Circuit Breaker</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CircuitBreaker</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Action&lt;Exception, TimeSpan, Context&gt; onBreak = (exception, timespan, context) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;onBreak Running : &quot;</span> + exception.Message);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    Action&lt;Context&gt; onReset = context =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Job Back to normal&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    CircuitBreakerPolicy breaker = Policy</span><br><span class="line">        .Handle&lt;AggregateException&gt;()</span><br><span class="line">        .CircuitBreaker(<span class="number">3</span>, TimeSpan.FromSeconds(<span class="number">10</span>), onBreak, onReset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Monitor the circuit state, for example for health reporting.</span></span><br><span class="line">    CircuitState state = breaker.CircuitState;</span><br><span class="line"></span><br><span class="line">    ISyncPolicy policy = Policy.Handle&lt;ArgumentException&gt;()</span><br><span class="line">        .Retry(<span class="number">3</span>, (ex, retryCount, context) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;Runing fallback,Exception :<span class="subst">&#123;ex.Message&#125;</span>,RetryCount:<span class="subst">&#123;retryCount&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> policyWrap = Policy.Wrap(policy, breaker);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// (wraps the policies around any executed delegate: fallback outermost ... bulkhead innermost)</span></span><br><span class="line">            policyWrap.Execute(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Job Start&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (DateTime.Now.Second % <span class="number">3</span> == <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;Hello Polly!&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 手动打开熔断器，阻止执行</span></span><br><span class="line">            breaker.Isolate();</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.Sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 恢复操作，启动执行</span></span><br><span class="line">        breaker.Reset();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="降级-Fallback"><a href="#降级-Fallback" class="headerlink" title="降级 Fallback"></a>降级 Fallback</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FallbackTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ISyncPolicy policy = Policy.Handle&lt;ArgumentException&gt;()</span><br><span class="line">    .Fallback(() =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Error occured,runing fallback&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    policy.Execute(() =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Job Start&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;Hello Polly!&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="弹性应变处理-Resilience"><a href="#弹性应变处理-Resilience" class="headerlink" title="弹性应变处理 (Resilience)"></a>弹性应变处理 (Resilience)</h1><h2 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h2><p>Timeout则是指超时处理，但是超时策略一般不能直接使用，而是其其他策略封装到一起使用。<br>常用悲观超时。</p>
<h3 id="乐观超时-Optimistic-timeout"><a href="#乐观超时-Optimistic-timeout" class="headerlink" title="乐观超时 (Optimistic timeout)"></a>乐观超时 (Optimistic timeout)</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Should_be_able_to_cancel_with_user_cancellation_token_before_timeout__optimistic</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">int</span> timeout = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">var</span> policy = Policy.TimeoutAsync(timeout, TimeoutStrategy.Optimistic);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> (CancellationTokenSource userTokenSource = <span class="keyword">new</span> CancellationTokenSource())</span><br><span class="line">    &#123;</span><br><span class="line">        policy.Awaiting(<span class="keyword">async</span> p =&gt; <span class="keyword">await</span> p.ExecuteAsync(</span><br><span class="line">            ct =&gt; &#123;</span><br><span class="line">                userTokenSource.Cancel(); ct.ThrowIfCancellationRequested();   <span class="comment">// Simulate cancel in the middle of execution</span></span><br><span class="line">                <span class="keyword">return</span> TaskHelper.EmptyTask;</span><br><span class="line">            &#125;, userTokenSource.Token) <span class="comment">// ... with user token.</span></span><br><span class="line">           ).ShouldThrow&lt;OperationCanceledException&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="悲观超时"><a href="#悲观超时" class="headerlink" title="悲观超时"></a>悲观超时</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">PessimisticTimeOutTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CancellationTokenSource userCancellationSource = <span class="keyword">new</span> CancellationTokenSource();</span><br><span class="line"></span><br><span class="line">    ISyncPolicy fallback = Policy.Handle&lt;Polly.Timeout.TimeoutRejectedException&gt;()</span><br><span class="line">         .Or&lt;ArgumentException&gt;()</span><br><span class="line">         .Fallback(() =&gt;</span><br><span class="line">         &#123;</span><br><span class="line">             Console.WriteLine(<span class="string">&quot;Error occured,runing fallback&quot;</span>);</span><br><span class="line">         &#125;,</span><br><span class="line">         (ex) =&gt; &#123; Console.WriteLine(<span class="string">$&quot;Fallback exception:<span class="subst">&#123;ex.GetType().ToString()&#125;</span>,Message:<span class="subst">&#123;ex.Message&#125;</span>&quot;</span>); &#125;);</span><br><span class="line"></span><br><span class="line">    ISyncPolicy policyTimeout = Policy.Timeout(<span class="number">3</span>, Polly.Timeout.TimeoutStrategy.Pessimistic);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> policyWrap = Policy.Wrap(fallback, policyTimeout);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (wraps the policies around any executed delegate: fallback outermost ... bulkhead innermost)</span></span><br><span class="line">        policyWrap.Execute(() =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Job Start&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DateTime.Now.Second % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Thread.Sleep(<span class="number">3000</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;Hello Polly!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread.Sleep(<span class="number">300</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="舱壁-Bulkhead"><a href="#舱壁-Bulkhead" class="headerlink" title="舱壁 Bulkhead"></a>舱壁 Bulkhead</h2><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/App-vNext/Polly">https://github.com/App-vNext/Polly</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/07/25/%E5%AE%B9%E9%94%99%E5%A4%84%E7%90%86%E5%BA%93Polly%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/25/%E5%AE%B9%E9%94%99%E5%A4%84%E7%90%86%E5%BA%93Polly%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3/" class="post-title-link" itemprop="url">容错处理库Polly使用文档</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-25 09:23:20" itemprop="dateCreated datePublished" datetime="2018-07-25T09:23:20+00:00">2018-07-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 07:00:06" itemprop="dateModified" datetime="2021-04-07T07:00:06+00:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Polly/" itemprop="url" rel="index"><span itemprop="name">Polly</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>Polly是一个被.NET基金会认可的弹性和瞬态故障处理库，允许我们以非常顺畅和线程安全的方式来执诸如行重试</p>
<p>官网：<a target="_blank" rel="noopener" href="http://www.thepollyproject.org/">http://www.thepollyproject.org/</a></p>
<p>源码：<a target="_blank" rel="noopener" href="https://github.com/App-vNext/Polly">https://github.com/App-vNext/Polly</a></p>
<p>其主要功能如下：</p>
<ul>
<li>重试（Retry）</li>
<li>断路器（Circuit-Breaker）</li>
<li>超时检测（Timeout）</li>
<li>隔板隔离 (Bulkhead Isolation)</li>
<li>缓存（Cache）</li>
<li>降级（Fallback）</li>
</ul>
<p>在Polly中，对这些服务容错模式分为两类：</p>
<ul>
<li>错误处理(fault handling)：重试、熔断、回退(降级)</li>
<li>弹性应变(resilience)：超时、舱壁、缓存</li>
</ul>
<p>可以说错误处理是当错误已经发生时，防止由于该错误对整个系统造成更坏的影响而设置。而弹性应变，则在是错误发生前，<br>针对有可能发生错误的地方进行预先处理，从而达到保护整个系统的目地。</p>
<h1 id="Polly-错误处理使用三步曲"><a href="#Polly-错误处理使用三步曲" class="headerlink" title="Polly 错误处理使用三步曲"></a>Polly 错误处理使用三步曲</h1><ul>
<li>定义条件： 定义你要处理的 错误异常/返回结果</li>
<li>定义处理方式 ： 重试，熔断，回退</li>
<li>执行</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> policy = Policy</span><br><span class="line">              .Handle&lt;SomeExceptionType&gt;()   <span class="comment">// 定义条件</span></span><br><span class="line">              .Retry(); <span class="comment">// 定义处理方式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行</span></span><br><span class="line">policy.Execute(() =&gt; DoSomething());</span><br></pre></td></tr></table></figure>

<h1 id="错误处理-fault-handling"><a href="#错误处理-fault-handling" class="headerlink" title="错误处理(fault handling)"></a>错误处理(fault handling)</h1><h2 id="定义条件"><a href="#定义条件" class="headerlink" title="定义条件"></a>定义条件</h2><h3 id="定义异常策略"><a href="#定义异常策略" class="headerlink" title="定义异常策略"></a>定义异常策略</h3><p>针对两种情况：错误异常和返回结果</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Single exception type</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;HttpRequestException&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Single exception type with condition</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SqlException&gt;(ex =&gt; ex.Number == <span class="number">1205</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Multiple exception types</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;HttpRequestException&gt;()</span><br><span class="line">  .Or&lt;OperationCanceledException&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Multiple exception types with condition</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SqlException&gt;(ex =&gt; ex.Number == <span class="number">1205</span>)</span><br><span class="line">  .Or&lt;ArgumentException&gt;(ex =&gt; ex.ParamName == <span class="string">&quot;example&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Inner exceptions of ordinary exceptions or AggregateException, with or without conditions</span></span><br><span class="line">Policy</span><br><span class="line">  .HandleInner&lt;HttpRequestException&gt;()</span><br><span class="line">  .OrInner&lt;OperationCanceledException&gt;(ex =&gt; ex.CancellationToken != myToken)</span><br></pre></td></tr></table></figure>

<h3 id="定义返回结果策略"><a href="#定义返回结果策略" class="headerlink" title="定义返回结果策略"></a>定义返回结果策略</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Handle return value with condition </span></span><br><span class="line">Policy</span><br><span class="line">  .HandleResult&lt;HttpResponseMessage&gt;(r =&gt; r.StatusCode == HttpStatusCode.NotFound)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handle multiple return values </span></span><br><span class="line">Policy</span><br><span class="line">  .HandleResult&lt;HttpResponseMessage&gt;(r =&gt; r.StatusCode == HttpStatusCode.InternalServerError)</span><br><span class="line">  .OrResult&lt;HttpResponseMessage&gt;(r =&gt; r.StatusCode == HttpStatusCode.BadGateway)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handle primitive return values (implied use of .Equals())</span></span><br><span class="line">Policy</span><br><span class="line">  .HandleResult&lt;HttpStatusCode&gt;(HttpStatusCode.InternalServerError)</span><br><span class="line">  .OrResult&lt;HttpStatusCode&gt;(HttpStatusCode.BadGateway)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handle both exceptions and return values in one policy</span></span><br><span class="line">HttpStatusCode[] httpStatusCodesWorthRetrying = &#123;</span><br><span class="line">   HttpStatusCode.RequestTimeout, <span class="comment">// 408</span></span><br><span class="line">   HttpStatusCode.InternalServerError, <span class="comment">// 500</span></span><br><span class="line">   HttpStatusCode.BadGateway, <span class="comment">// 502</span></span><br><span class="line">   HttpStatusCode.ServiceUnavailable, <span class="comment">// 503</span></span><br><span class="line">   HttpStatusCode.GatewayTimeout <span class="comment">// 504</span></span><br><span class="line">&#125;;</span><br><span class="line">HttpResponseMessage result = Policy</span><br><span class="line">  .Handle&lt;HttpRequestException&gt;()</span><br><span class="line">  .OrResult&lt;HttpResponseMessage&gt;(r =&gt; httpStatusCodesWorthRetrying.Contains(r.StatusCode))</span><br><span class="line">  .RetryAsync(...)</span><br><span class="line">  .ExecuteAsync( <span class="comment">/* some Func&lt;Task&lt;HttpResponseMessage&gt;&gt; */</span> )</span><br></pre></td></tr></table></figure>

<h2 id="定义处理方式"><a href="#定义处理方式" class="headerlink" title="定义处理方式"></a>定义处理方式</h2><h3 id="重试-Retry"><a href="#重试-Retry" class="headerlink" title="重试 Retry"></a>重试 Retry</h3><p>当发生某种错误或者返回某种结果的时候进行重试。<br>Polly里面提供了以下几种重试机制</p>
<ul>
<li>按次数重试</li>
<li>不断重试（直到成功）</li>
<li>等待之后按次数重试</li>
<li>等待之后不断重试（直到成功）</li>
</ul>
<h4 id="按次数重试"><a href="#按次数重试" class="headerlink" title="按次数重试"></a>按次数重试</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Retry once</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .Retry()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retry multiple times</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .Retry(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retry multiple times, calling an action on each retry</span></span><br><span class="line"><span class="comment">// with the current exception and retry count</span></span><br><span class="line">Policy</span><br><span class="line">    .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">    .Retry(<span class="number">3</span>, (exception, retryCount) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retry multiple times, calling an action on each retry</span></span><br><span class="line"><span class="comment">// with the current exception, retry count and context</span></span><br><span class="line"><span class="comment">// provided to Execute()</span></span><br><span class="line">Policy</span><br><span class="line">    .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">    .Retry(<span class="number">3</span>, (exception, retryCount, context) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h4 id="不断重试-直到成功"><a href="#不断重试-直到成功" class="headerlink" title="不断重试(直到成功)"></a>不断重试(直到成功)</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Retry forever</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .RetryForever()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retry forever, calling an action on each retry with the</span></span><br><span class="line"><span class="comment">// current exception</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .RetryForever(exception =&gt;</span><br><span class="line">  &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retry forever, calling an action on each retry with the</span></span><br><span class="line"><span class="comment">// current exception and context provided to Execute()</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .RetryForever((exception, context) =&gt;</span><br><span class="line">  &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<h4 id="等待之后重试"><a href="#等待之后重试" class="headerlink" title="等待之后重试"></a>等待之后重试</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Retry, waiting a specified duration between each retry</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetry(<span class="keyword">new</span>[]</span><br><span class="line">  &#123;</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">1</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">2</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">3</span>)</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retry, waiting a specified duration between each retry,</span></span><br><span class="line"><span class="comment">// calling an action on each retry with the current exception</span></span><br><span class="line"><span class="comment">// and duration</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetry(<span class="keyword">new</span>[]</span><br><span class="line">  &#123;</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">1</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">2</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">3</span>)</span><br><span class="line">  &#125;, (exception, timeSpan) =&gt; &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retry, waiting a specified duration between each retry,</span></span><br><span class="line"><span class="comment">// calling an action on each retry with the current exception,</span></span><br><span class="line"><span class="comment">// duration and context provided to Execute()</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetry(<span class="keyword">new</span>[]</span><br><span class="line">  &#123;</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">1</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">2</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">3</span>)</span><br><span class="line">  &#125;, (exception, timeSpan, context) =&gt; &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retry, waiting a specified duration between each retry,</span></span><br><span class="line"><span class="comment">// calling an action on each retry with the current exception,</span></span><br><span class="line"><span class="comment">// duration, retry count, and context provided to Execute()</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetry(<span class="keyword">new</span>[]</span><br><span class="line">  &#123;</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">1</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">2</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">3</span>)</span><br><span class="line">  &#125;, (exception, timeSpan, retryCount, context) =&gt; &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retry a specified number of times, using a function to </span></span><br><span class="line"><span class="comment">// calculate the duration to wait between retries based on </span></span><br><span class="line"><span class="comment">// the current retry attempt (allows for exponential backoff)</span></span><br><span class="line"><span class="comment">// In this case will wait for</span></span><br><span class="line"><span class="comment">//  2 ^ 1 = 2 seconds then</span></span><br><span class="line"><span class="comment">//  2 ^ 2 = 4 seconds then</span></span><br><span class="line"><span class="comment">//  2 ^ 3 = 8 seconds then</span></span><br><span class="line"><span class="comment">//  2 ^ 4 = 16 seconds then</span></span><br><span class="line"><span class="comment">//  2 ^ 5 = 32 seconds</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetry(<span class="number">5</span>, retryAttempt =&gt;</span><br><span class="line">    TimeSpan.FromSeconds(Math.Pow(<span class="number">2</span>, retryAttempt))</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retry a specified number of times, using a function to</span></span><br><span class="line"><span class="comment">// calculate the duration to wait between retries based on</span></span><br><span class="line"><span class="comment">// the current retry attempt, calling an action on each retry</span></span><br><span class="line"><span class="comment">// with the current exception, duration and context provided</span></span><br><span class="line"><span class="comment">// to Execute()</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetry(</span><br><span class="line">    <span class="number">5</span>,</span><br><span class="line">    retryAttempt =&gt; TimeSpan.FromSeconds(Math.Pow(<span class="number">2</span>, retryAttempt)),</span><br><span class="line">    (exception, timeSpan, context) =&gt; &#123;</span><br><span class="line">      <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retry a specified number of times, using a function to</span></span><br><span class="line"><span class="comment">// calculate the duration to wait between retries based on</span></span><br><span class="line"><span class="comment">// the current retry attempt, calling an action on each retry</span></span><br><span class="line"><span class="comment">// with the current exception, duration, retry count, and context</span></span><br><span class="line"><span class="comment">// provided to Execute()</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetry(</span><br><span class="line">    <span class="number">5</span>,</span><br><span class="line">    retryAttempt =&gt; TimeSpan.FromSeconds(Math.Pow(<span class="number">2</span>, retryAttempt)),</span><br><span class="line">    (exception, timeSpan, retryCount, context) =&gt; &#123;</span><br><span class="line">      <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<h4 id="等待并永远重试（直到成功）"><a href="#等待并永远重试（直到成功）" class="headerlink" title="等待并永远重试（直到成功）"></a>等待并永远重试（直到成功）</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Wait and retry forever</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetryForever(retryAttempt =&gt;</span><br><span class="line">    TimeSpan.FromSeconds(Math.Pow(<span class="number">2</span>, retryAttempt))</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="comment">// Wait and retry forever, calling an action on each retry with the</span></span><br><span class="line"><span class="comment">// current exception and the time to wait</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetryForever(</span><br><span class="line">    retryAttempt =&gt; TimeSpan.FromSeconds(Math.Pow(<span class="number">2</span>, retryAttempt)),</span><br><span class="line">    (exception, timespan) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Wait and retry forever, calling an action on each retry with the</span></span><br><span class="line"><span class="comment">// current exception, time to wait, and context provided to Execute()</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetryForever(</span><br><span class="line">    retryAttempt =&gt; TimeSpan.FromSeconds(Math.Pow(<span class="number">2</span>, retryAttempt)),</span><br><span class="line">    (exception, timespan, context) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>如果所有重试都失败，则重试策略会将最终异常重新返回到调用代码。</p>
<h3 id="熔断-Circuit-Breaker"><a href="#熔断-Circuit-Breaker" class="headerlink" title="熔断 Circuit Breaker"></a>熔断 Circuit Breaker</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当发生2次SomeExceptionType的异常的时候则会熔断1分钟，</span></span><br><span class="line"><span class="comment">// 该操作后续如果继续尝试执行则会直接返回错误 。</span></span><br><span class="line">Policy</span><br><span class="line">    .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">    .CircuitBreaker(<span class="number">2</span>, TimeSpan.FromMinutes(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以在熔断和恢复的时候定义委托来做一些额外的处理。</span></span><br><span class="line"><span class="comment">// onBreak会在被熔断时执行，而onReset则会在恢复时执行。</span></span><br><span class="line">Action&lt;Exception, TimeSpan&gt; onBreak = (exception, timespan) =&gt; &#123; ... &#125;;</span><br><span class="line">Action onReset = () =&gt; &#123; ... &#125;;</span><br><span class="line">CircuitBreakerPolicy breaker = Policy</span><br><span class="line">    .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">    .CircuitBreaker(<span class="number">2</span>, TimeSpan.FromMinutes(<span class="number">1</span>), onBreak, onReset);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Break the circuit after the specified number of consecutive exceptions</span></span><br><span class="line"><span class="comment">// and keep circuit broken for the specified duration,</span></span><br><span class="line"><span class="comment">// calling an action on change of circuit state,</span></span><br><span class="line"><span class="comment">// passing a context provided to Execute().</span></span><br><span class="line">Action&lt;Exception, TimeSpan, Context&gt; onBreak = (exception, timespan, context) =&gt; &#123; ... &#125;;</span><br><span class="line">Action&lt;Context&gt; onReset = context =&gt; &#123; ... &#125;;</span><br><span class="line">CircuitBreakerPolicy breaker = Policy</span><br><span class="line">    .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">    .CircuitBreaker(<span class="number">2</span>, TimeSpan.FromMinutes(<span class="number">1</span>), onBreak, onReset);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Monitor the circuit state, for example for health reporting.</span></span><br><span class="line">CircuitState state = breaker.CircuitState;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Closed 关闭状态，允许执行</span></span><br><span class="line"><span class="comment">Open 自动打开，执行会被阻断</span></span><br><span class="line"><span class="comment">Isolate 手动打开，执行会被阻断</span></span><br><span class="line"><span class="comment">HalfOpen  从自动打开状态恢复中，在熔断时间到了之后从Open状态切换到Closed</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 手动打开熔断器，阻止执行</span></span><br><span class="line">breaker.Isolate();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 恢复操作，启动执行</span></span><br><span class="line">breaker.Reset();</span><br></pre></td></tr></table></figure>

<p>请注意，断路器策略会重新抛出所有异常，甚至是已处理的异常。断路器用于测量故障并在发生太多故障时断开电路，<br>但不会重新编排重试。根据需要将断路器与重试策略相结合。</p>
<h3 id="回退（Fallback"><a href="#回退（Fallback" class="headerlink" title="回退（Fallback)"></a>回退（Fallback)</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果执行失败则返回UserAvatar.Blank</span></span><br><span class="line">Policy</span><br><span class="line">   .Handle&lt;Whatever&gt;()</span><br><span class="line">   .Fallback&lt;UserAvatar&gt;(UserAvatar.Blank)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发起另外一个请求去获取值</span></span><br><span class="line">Policy</span><br><span class="line">   .Handle&lt;Whatever&gt;()</span><br><span class="line">   .Fallback&lt;UserAvatar&gt;(() =&gt; UserAvatar.GetRandomAvatar())</span><br><span class="line">   <span class="comment">// where: public UserAvatar GetRandomAvatar() &#123; ... &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回一个指定的值，添加额外的处理操作。onFallback</span></span><br><span class="line">Policy</span><br><span class="line">   .Handle&lt;Whatever&gt;()</span><br><span class="line">   .Fallback&lt;UserAvatar&gt;(UserAvatar.Blank, onFallback: (exception, context) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="执行-Execute-the-policy"><a href="#执行-Execute-the-policy" class="headerlink" title="执行(Execute the policy)"></a>执行(Execute the policy)</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Execute an action</span></span><br><span class="line"><span class="keyword">var</span> policy = Policy</span><br><span class="line">              .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">              .Retry();</span><br><span class="line"></span><br><span class="line">policy.Execute(() =&gt; DoSomething());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Execute an action passing arbitrary context data</span></span><br><span class="line"><span class="keyword">var</span> policy = Policy</span><br><span class="line">    .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">    .Retry(<span class="number">3</span>, (exception, retryCount, context) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> methodThatRaisedException = context[<span class="string">&quot;methodName&quot;</span>];</span><br><span class="line">        Log(exception, methodThatRaisedException);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">policy.Execute(</span><br><span class="line">    (o) =&gt; DoSomething(),</span><br><span class="line">    <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;() &#123;&#123; <span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;some method&quot;</span> &#125;&#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Execute a function returning a result</span></span><br><span class="line"><span class="keyword">var</span> policy = Policy</span><br><span class="line">              .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">              .Retry();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result = policy.Execute(() =&gt; DoSomething());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Execute a function returning a result passing arbitrary context data</span></span><br><span class="line"><span class="keyword">var</span> policy = Policy</span><br><span class="line">    .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">    .Retry(<span class="number">3</span>, (exception, retryCount, context) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">object</span> methodThatRaisedException = context[<span class="string">&quot;methodName&quot;</span>];</span><br><span class="line">        Log(exception, methodThatRaisedException)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result = policy.Execute(</span><br><span class="line">    () =&gt; DoSomething(),</span><br><span class="line">    <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;() &#123;&#123; <span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;some method&quot;</span> &#125;&#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们也可以将Handle，Retry, Execute 这三个阶段都串起来写。</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SqlException&gt;(ex =&gt; ex.Number == <span class="number">1205</span>)</span><br><span class="line">  .Or&lt;ArgumentException&gt;(ex =&gt; ex.ParamName == <span class="string">&quot;example&quot;</span>)</span><br><span class="line">  .Retry()</span><br><span class="line">  .Execute(() =&gt; DoSomething());</span><br></pre></td></tr></table></figure>

<h1 id="Polly-弹性应变处理-Resilience"><a href="#Polly-弹性应变处理-Resilience" class="headerlink" title="Polly 弹性应变处理 (Resilience)"></a>Polly 弹性应变处理 (Resilience)</h1><p>一般弹性策略添加了弹性策略，这些策略没有明确地以处理委托可能抛出或返回的故障为中心。</p>
<h2 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h2><h3 id="乐观超时-Optimistic-timeout"><a href="#乐观超时-Optimistic-timeout" class="headerlink" title="乐观超时 (Optimistic timeout)"></a>乐观超时 (Optimistic timeout)</h3><p>超时分为乐观超时与悲观超时，乐观超时依赖于CancellationToken ，它假设我们的具体执行的任务都支持CancellationToken。<br>那么在进行timeout的时候，它会通知执行线程取消并终止执行线程，避免额外的开销。下面的乐观超时的具体用法 。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Timeout and return to the caller after 30 seconds, if the executed delegate has not completed.  </span></span><br><span class="line"><span class="comment">// Optimistic timeout: Delegates should take and honour a CancellationToken.</span></span><br><span class="line">Policy</span><br><span class="line">  .Timeout(<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Configure timeout as timespan.</span></span><br><span class="line">Policy</span><br><span class="line">  .Timeout(TimeSpan.FromMilliseconds(<span class="number">2500</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// Configure variable timeout via a func provider.</span></span><br><span class="line">Policy</span><br><span class="line">  .Timeout(() =&gt; myTimeoutProvider)) <span class="comment">// Func&lt;TimeSpan&gt; myTimeoutProvider</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Timeout, calling an action if the action times out</span></span><br><span class="line">Policy</span><br><span class="line">  .Timeout(<span class="number">30</span>, onTimeout: (context, timespan, task) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Eg timeout, logging that the execution timed out:</span></span><br><span class="line">Policy</span><br><span class="line">  .Timeout(<span class="number">30</span>, onTimeout: (context, timespan, task) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        logger.Warn(<span class="string">$&quot;<span class="subst">&#123;context.PolicyKey&#125;</span> at <span class="subst">&#123;context.ExecutionKey&#125;</span>: execution timed out after <span class="subst">&#123;timespan.TotalSeconds&#125;</span> seconds.&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Eg timeout, capturing any exception from the timed-out task when it completes:</span></span><br><span class="line">Policy</span><br><span class="line">  .Timeout(<span class="number">30</span>, onTimeout: (context, timespan, task) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        task.ContinueWith(t =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (t.IsFaulted)</span><br><span class="line">               logger.Error(<span class="string">$&quot;<span class="subst">&#123;context.PolicyKey&#125;</span> at <span class="subst">&#123;context.ExecutionKey&#125;</span>: execution timed out after <span class="subst">&#123;timespan.TotalSeconds&#125;</span> seconds, with: <span class="subst">&#123;t.Exception&#125;</span>.&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">Policy timeoutPolicy = Policy.TimeoutAsync(<span class="number">30</span>);</span><br><span class="line">HttpResponseMessage httpResponse = <span class="keyword">await</span> timeoutPolicy</span><br><span class="line">    .ExecuteAsync(</span><br><span class="line">      <span class="keyword">async</span> ct =&gt; <span class="keyword">await</span> httpClient.GetAsync(endpoint, ct), <span class="comment">// Execute a delegate which responds to a CancellationToken input parameter.</span></span><br><span class="line">      CancellationToken.None</span><br><span class="line">       <span class="comment">// In this case, CancellationToken.None is passed into the execution, indicating you have no independent cancellation</span></span><br><span class="line">       <span class="comment">// control you wish to add to the cancellation provided by TimeoutPolicy.  Your own indepdent CancellationToken can also</span></span><br><span class="line">       <span class="comment">// be passed - see wiki for examples.</span></span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CancellationTokenSource userCancellationSource = <span class="keyword">new</span> CancellationTokenSource();</span><br><span class="line"><span class="comment">// userCancellationSource perhaps hooked up to the user clicking a &#x27;cancel&#x27; button, or other independent cancellation</span></span><br><span class="line"></span><br><span class="line">Policy timeoutPolicy = Policy.TimeoutAsync(<span class="number">30</span>, TimeoutStrategy.Optimistic);</span><br><span class="line"></span><br><span class="line">HttpResponseMessage httpResponse = <span class="keyword">await</span> _timeoutPolicy</span><br><span class="line">    .ExecuteAsync(</span><br><span class="line">        <span class="keyword">async</span> ct =&gt; <span class="keyword">await</span> httpClient.GetAsync(requestEndpoint, ct),</span><br><span class="line">        userCancellationSource.Token</span><br><span class="line">        ); <span class="comment">// GetAsync(...) will be cancelled when either the timeout occurs, or userCancellationSource is signalled.</span></span><br></pre></td></tr></table></figure>

<h3 id="悲观超时"><a href="#悲观超时" class="headerlink" title="悲观超时"></a>悲观超时</h3><p>悲观超时与乐观超时的区别在于，如果执行的代码不支持取消CancellationToken，它还会继续执行，这会是一个比较大的开销。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Policy timeoutPolicy = Policy.TimeoutAsync(<span class="number">30</span>, TimeoutStrategy.Pessimistic);</span><br><span class="line"><span class="keyword">var</span> response = <span class="keyword">await</span> timeoutPolicy</span><br><span class="line">    .ExecuteAsync(</span><br><span class="line">      <span class="keyword">async</span> () =&gt; <span class="keyword">await</span> FooNotHonoringCancellationAsync(),</span><br><span class="line">      );<span class="comment">// 在这里我们没有 任何与CancllationToken相关的处理</span></span><br></pre></td></tr></table></figure>

<h2 id="舱壁-Bulkhead"><a href="#舱壁-Bulkhead" class="headerlink" title="舱壁 Bulkhead"></a>舱壁 Bulkhead</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 它用来限制某一个操作的最大并发执行数量 。比如限制为12</span></span><br><span class="line">Policy</span><br><span class="line">  .Bulkhead(<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制一个等待处理的队列长度</span></span><br><span class="line">Policy</span><br><span class="line">  .Bulkhead(<span class="number">12</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当请求执行操作被拒绝的时候，执行回调</span></span><br><span class="line">Policy</span><br><span class="line">  .Bulkhead(<span class="number">12</span>, context =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Monitor the bulkhead available capacity, for example for health/load reporting.</span></span><br><span class="line"><span class="keyword">var</span> bulkhead = Policy.Bulkhead(<span class="number">12</span>, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="built_in">int</span> freeExecutionSlots = bulkhead.BulkheadAvailableCount;</span><br><span class="line"><span class="built_in">int</span> freeQueueSlots     = bulkhead.QueueAvailableCount;</span><br></pre></td></tr></table></figure>

<h2 id="缓存-Cache"><a href="#缓存-Cache" class="headerlink" title="缓存 Cache"></a>缓存 Cache</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Microsoft.Extensions.Caching.Memory.IMemoryCache memoryCache</span><br><span class="line">   = <span class="keyword">new</span> Microsoft.Extensions.Caching.Memory.MemoryCache(<span class="keyword">new</span> Microsoft.Extensions.Caching.Memory.MemoryCacheOptions());</span><br><span class="line">Polly.Caching.Memory.MemoryCacheProvider memoryCacheProvider</span><br><span class="line">   = <span class="keyword">new</span> Polly.Caching.Memory.MemoryCacheProvider(memoryCache);</span><br><span class="line"></span><br><span class="line"><span class="comment">// (2) Create a Polly cache policy using that Polly.Caching.Memory.MemoryCacheProvider instance.</span></span><br><span class="line"><span class="keyword">var</span> cachePolicy = Policy.Cache(memoryCacheProvider, TimeSpan.FromMinutes(<span class="number">5</span>));</span><br></pre></td></tr></table></figure>

<p>参考代码：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/App-vNext/Polly.Caching.MemoryCache">https://github.com/App-vNext/Polly.Caching.MemoryCache</a><br><a target="_blank" rel="noopener" href="https://github.com/App-vNext/Polly.Caching.IDistributedCache">https://github.com/App-vNext/Polly.Caching.IDistributedCache</a></p>
<h2 id="组合Policy"><a href="#组合Policy" class="headerlink" title="组合Policy"></a>组合Policy</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define a combined policy strategy, built of previously-defined policies.</span></span><br><span class="line"><span class="keyword">var</span> policyWrap = Policy</span><br><span class="line">  .Wrap(fallback, cache, retry, breaker, timeout, bulkhead);</span><br><span class="line"><span class="comment">// (wraps the policies around any executed delegate: fallback outermost ... bulkhead innermost)</span></span><br><span class="line">policyWrap.Execute(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Define a standard resilience strategy ...</span></span><br><span class="line">PolicyWrap commonResilience = Policy.Wrap(retry, breaker, timeout);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... then wrap in extra policies specific to a call site, at that call site:</span></span><br><span class="line">Avatar avatar = Policy</span><br><span class="line">   .Handle&lt;Whatever&gt;()</span><br><span class="line">   .Fallback&lt;Avatar&gt;(Avatar.Blank)</span><br><span class="line">   .Wrap(commonResilience)</span><br><span class="line">   .Execute(() =&gt; &#123; <span class="comment">/* get avatar */</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Share commonResilience, but wrap different policies in at another call site:</span></span><br><span class="line">Reputation reps = Policy</span><br><span class="line">   .Handle&lt;Whatever&gt;()</span><br><span class="line">   .Fallback&lt;Reputation&gt;(Reputation.NotAvailable)</span><br><span class="line">   .Wrap(commonResilience)</span><br><span class="line">   .Execute(() =&gt; &#123; <span class="comment">/* get reputation */</span> &#125;);  </span><br></pre></td></tr></table></figure>

<p>参考代码：<a target="_blank" rel="noopener" href="https://github.com/App-vNext/Polly/wiki/PolicyWrap">https://github.com/App-vNext/Polly/wiki/PolicyWrap</a></p>
<h1 id="执行后：捕获结果或任何最终异常"><a href="#执行后：捕获结果或任何最终异常" class="headerlink" title="执行后：捕获结果或任何最终异常"></a>执行后：捕获结果或任何最终异常</h1><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> policyResult = Policy</span><br><span class="line">              .Handle&lt;HttpRequestException&gt;()</span><br><span class="line">              .RetryAsync()</span><br><span class="line">              .ExecuteAndCaptureAsync(() =&gt; DoSomethingAsync());</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">policyResult.Outcome - whether the call succeeded or failed</span></span><br><span class="line"><span class="comment">policyResult.FinalException - the final exception captured, will be null if the call succeeded</span></span><br><span class="line"><span class="comment">policyResult.ExceptionType - was the final exception an exception the policy was defined to handle</span></span><br><span class="line"><span class="comment"> (like HttpRequestException above) or an unhandled one (say Exception). Will be null if the call succeeded.</span></span><br><span class="line"><span class="comment">policyResult.Result - if executing a func, the result if the call succeeded or the type&#x27;s default value</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/App-vNext/Polly">https://github.com/App-vNext/Polly</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jesse2013/p/polly-docs.html">ASP VNext 开源服务容错处理库Polly使用文档</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/CreateMyself/p/7589397.html">已被.NET基金会认可的弹性和瞬态故障处理库Polly介绍</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edisonchou/p/9159644.html">.NET Core微服务之基于Polly+AspectCore实现熔断与降级机制</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2018/07/24/DotNet%E5%BC%82%E6%AD%A5APM%E6%A8%A1%E5%BC%8F%E4%B9%8BIAsyncResult%E5%92%8CAsyncCallback/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/24/DotNet%E5%BC%82%E6%AD%A5APM%E6%A8%A1%E5%BC%8F%E4%B9%8BIAsyncResult%E5%92%8CAsyncCallback/" class="post-title-link" itemprop="url">DotNet异步APM模式之IAsyncResult和AsyncCallback</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-24 14:21:17" itemprop="dateCreated datePublished" datetime="2018-07-24T14:21:17+00:00">2018-07-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 07:00:06" itemprop="dateModified" datetime="2021-04-07T07:00:06+00:00">2021-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/net%E5%BC%82%E6%AD%A5%E4%B8%8E%E5%B9%B6%E8%A1%8C/" itemprop="url" rel="index"><span itemprop="name">.net异步与并行</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>IAsyncResult 异步设计模式通过名为 BeginOperationName 和 EndOperationName 的两个方法来实现原同步方法的异步调用，如 FileStream 类提供了 BeginRead 和 EndRead 方法来从文件异步读取字节，它们是 Read 方法的异步版本。</p>
<p>** Begin方法包含同步方法签名中的任何参数<strong>，此外还包含另外</strong> 两个参数<strong>：<br>** 一个AsyncCallback 委托 **<br>** 一个用户定义的状态对象</strong>。<br>委托用来调用回调方法，状态对象是用来向回调方法传递状态信息。该方法返回一个实现 IAsyncResult 接口的对象。</p>
<p>End 方法用于结束异步操作并返回结果，因此包含同步方法签名中的 ref 和 out 参数，** 返回值类型也与同步方法相同<strong>。该方法还包括一个</strong> IAsyncResult** 参数，用于获取异步操作是否完成的信息，当然在使用时就必须传入对应的 Begin 方法返回的对象实例。</p>
<p>开始异步操作后如果要阻止应用程序，可以直接调用 End 方法，这会阻止应用程序直到异步操作完成后再继续执行。也可以使用 IAsyncResult 的 AsyncWaitHandle 属性，调用其中的WaitOne等方法来阻塞线程。这两种方法的区别不大，只是前者必须一直等待而后者可以设置等待超时</p>
<p>如果不阻止应用程序，则可以通过轮循 IAsyncResult 的 IsCompleted 状态来判断操作是否完成，或使用 AsyncCallback 委托来结束异步操作。<br>AsyncCallback 委托包含一个 IAsyncResult 的签名，回调方法内部再调用 End 方法来获取操作执行结果。</p>
<p>代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApplication1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">static</span> AsyncDemo demo = <span class="keyword">new</span> AsyncDemo();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//bool state = false;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//IAsyncResult ar = demo.BeginRun(&quot;zhangshan&quot;, new AsyncCallback(outPut), state);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//ar.AsyncWaitHandle.WaitOne(1000, false);</span></span><br><span class="line"></span><br><span class="line">            IAsyncResult ar = demo.BeginRun(<span class="string">&quot;zhangshan&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ar.IsCompleted)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> demoName = demo.EndRun(ar);</span><br><span class="line">                Console.WriteLine(demoName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Sorry,can&#x27;t get demoName, the time is over&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.Threading.Thread.Sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">outPut</span>(<span class="params">IAsyncResult ar</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="built_in">bool</span> state = (<span class="built_in">bool</span>)ar.AsyncState;</span><br><span class="line">            <span class="built_in">string</span> demoName = demo.EndRun(ar);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (state)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(demoName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(demoName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AsyncDemo</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">delegate</span> <span class="built_in">string</span> <span class="title">runDelegate</span>(<span class="params"><span class="built_in">string</span> name</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> runDelegate m_Delegate;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AsyncDemo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_Delegate = <span class="keyword">new</span> runDelegate(Run);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> ﹤summary﹥  </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Synchronous method  </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> ﹤/summary﹥  </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> ﹤returns﹥﹤/returns﹥  </span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Run</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;My name is &quot;</span> + name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IAsyncResult <span class="title">BeginRun</span>(<span class="params"><span class="built_in">string</span> name, AsyncCallback callBack, Object stateObject</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> m_Delegate.BeginInvoke(name, callBack, stateObject);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">EndRun</span>(<span class="params">IAsyncResult ar</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (ar == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullReferenceException(<span class="string">&quot;Arggument ar can&#x27;t be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> m_Delegate.EndInvoke(ar);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://developer.51cto.com/art/200908/145362.htm">C#异步编程模式IAsyncResult浅析</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/powertoolsteam/article/details/6284035">使用 IAsyncResult 进行 .NET 异步编程</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/panjun-Donet/archive/2009/03/03/1284700.html">异步编程(AsyncCallback委托,IAsyncResult接口,BeginInvoke方法,EndInvoke方法的使用小总结)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/20/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><span class="page-number current">21</span><a class="page-number" href="/page/22/">22</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/22/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">syxdevcode</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">383</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">173</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/syxdevcode" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;syxdevcode" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">syxdevcode</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
