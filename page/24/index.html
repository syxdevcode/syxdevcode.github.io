<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"syxdevcode.github.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="syxdevcode的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="syxdevcode博客">
<meta property="og:url" content="https://syxdevcode.github.com/page/24/index.html">
<meta property="og:site_name" content="syxdevcode博客">
<meta property="og:description" content="syxdevcode的个人博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="syxdevcode">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://syxdevcode.github.com/page/24/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>syxdevcode博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">syxdevcode博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/syxdevcode" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/12/20/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%95%B4%E7%90%86%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/20/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%95%B4%E7%90%86%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">分布式事务整理笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-20 13:41:22" itemprop="dateCreated datePublished" datetime="2019-12-20T13:41:22+00:00">2019-12-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-07 08:51:18" itemprop="dateModified" datetime="2022-09-07T08:51:18+00:00">2022-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">分布式事务</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="事务定义"><a href="#事务定义" class="headerlink" title="事务定义"></a>事务定义</h2><p>事务提供一种机制将一个活动涉及的所有操作纳入到一个不可分割的执行单元，组成事务的所有操作只有在所有操作均能正常执行的情况下方能提交，只要其中任一操作执行失败，都将导致整个事务的回滚。简单地说，事务提供一种 “要么什么都不做，要么做全套（All or Nothing）” 机制。</p>
<h2 id="数据库事务"><a href="#数据库事务" class="headerlink" title="数据库事务"></a>数据库事务</h2><p>一个数据库事务通常包含了一个序列的对数据库的读/写操作。它的存在包含有以下两个目的：</p>
<p>1，为数据库操作序列提供了一个从失败中恢复到正常状态的方法，同时提供了数据库即使在异常状态下仍能保持一致性的方法。<br>2，当多个应用程序在并发访问数据库时，可以在这些应用程序之间提供一个隔离方法，以防止彼此的操作互相干扰。</p>
<p>数据库事务拥有以下四个特性，ACID 特性。</p>
<ul>
<li><p>A 原子性（Atomicity）：事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。</p>
</li>
<li><p>C 一致性（Consistency）：事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态的含义是数据库中的数据应满足完整性约束。如果事务成功地完成，那么系统中所有变化将正确地应用，系统处于有效状态。如果在事务中出现错误，那么系统中的所有变化将自动地回滚，系统返回到原始状态。</p>
</li>
<li><p>I 隔离性（Isolation）或独立性：多个事务并发执行时，一个事务的执行不应影响其他事务的执行。</p>
</li>
<li><p>D 持久性（Durability）：已被提交的事务对数据库的修改应该永久保存在数据库中。即使发生系统崩溃，重新启动数据库系统后，数据库还能恢复到事务成功结束时的状态。</p>
</li>
</ul>
<h2 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h2><p>分布式事务是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的 分布式系统 的不同节点之上。</p>
<p>在应用程序只部署在一台计算机，数据库只部署在一台计算机的情况下，事务的ACID四个特性很容易全部满足。</p>
<p>但是单机的处理能力很容易达到上限，此时必须使用分布式系统。在分布式环境下，应用程序可能部署在多台计算机，并且可能有多个不同的应用程序参与到同一个事务中；数据库也可能部署在多台计算机，并且多个不同的数据库可能会参与到同一个事务中。一次大的操作由不同的小操作组成，这些小的操作分布在不同的服务器上，且属于不同的应用，分布式事务需要保证这些小操作要么全部成功，要么全部失败。本质上来说，分布式事务就是为了保证不同数据库的数据一致性。</p>
<h2 id="分布式事务的基础"><a href="#分布式事务的基础" class="headerlink" title="分布式事务的基础"></a>分布式事务的基础</h2><h3 id="CAP"><a href="#CAP" class="headerlink" title="CAP"></a>CAP</h3><p>CAP定理，又被叫作布鲁尔定理。</p>
<ul>
<li><p>C (一致性):对某个指定的客户端来说，读操作能返回最新的写操作。对于数据分布在不同节点上的数据上来说，如果在某个节点更新了数据，那么在其他节点如果都能读取到这个最新的数据，那么就称为强一致，如果有某个节点没有读取到，那就是分布式不一致。</p>
</li>
<li><p>A (可用性)：非故障的节点在合理的时间内返回合理的响应(不是错误和超时的响应)。可用性的两个关键一个是合理的时间，一个是合理的响应。合理的时间指的是请求不能无限被阻塞，应该在合理的时间给出返回。合理的响应指的是系统应该明确返回结果并且结果是正确的，这里的正确指的是比如应该返回50，而不是返回40。</p>
</li>
<li><p>P (分区容错性):当出现网络分区后，系统能够继续工作。打个比方，这里个集群有多台机器，有台机器网络出现了问题，但是这个集群仍然可以正常工作。</p>
</li>
</ul>
<p>分布式系统中，网络无法100%可靠，分区其实是一个必然现象，如果我们选择了CA而放弃了P，那么当发生分区现象时，为了保证一致性，这个时候必须拒绝请求，但是A又不允许，所以分布式系统理论上不可能选择CA架构，只能选择CP或者AP架构。</p>
<p>对于CP来说，放弃可用性，追求一致性和分区容错性，我们的zookeeper其实就是追求的强一致。</p>
<p>对于AP来说，放弃一致性(这里说的一致性是强一致性)，追求分区容错性和可用性，这是很多分布式系统设计时的选择，后面的BASE也是根据AP来扩展。</p>
<p>CAP理论中是忽略网络延迟，也就是当事务提交时，从节点A复制到节点B，但是在现实中这个是明显不可能的，所以总会有一定的时间是不一致。同时CAP中选择两个，比如你选择了CP，并不是叫你放弃A。因为P出现的概率实在是太小了，大部分的时间你仍然需要保证CA。就算分区出现了你也要为后来的A做准备，比如通过一些日志的手段，是其他机器回复至可用。</p>
<h3 id="BASE"><a href="#BASE" class="headerlink" title="BASE"></a>BASE</h3><p>BASE 是 Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写，是对CAP中AP的一个扩展。</p>
<ul>
<li>基本可用:分布式系统在出现故障时，允许损失部分可用功能，保证核心功能可用。</li>
<li>软状态:允许系统中存在中间状态，这个状态不影响系统可用性，这里指的是CAP中的不一致。</li>
<li>最终一致:最终一致是指经过一段时间后，所有节点数据都将会达到一致。</li>
</ul>
<p>BASE解决了CAP中理论没有网络延迟，在BASE中用软状态和最终一致，保证了延迟后的一致性。BASE和 ACID 是相反的，它完全不同于ACID的强一致性模型，而是通过牺牲强一致性来获得可用性，并允许数据在一段时间内是不一致的，但最终达到一致状态。</p>
<h2 id="分布式事务方案"><a href="#分布式事务方案" class="headerlink" title="分布式事务方案"></a>分布式事务方案</h2><h3 id="基于XA协议的2PC-2阶段提交"><a href="#基于XA协议的2PC-2阶段提交" class="headerlink" title="基于XA协议的2PC(2阶段提交)"></a>基于XA协议的2PC(2阶段提交)</h3><p>XA是一个分布式事务协议，由Tuxedo提出。XA中大致分为两部分：事务管理器和本地资源管理器。其中本地资源管理器往往由数据库实现，比如Oracle、DB2这些商业数据库都实现了XA接口，而事务管理器作为全局的调度者，负责各个本地资源的提交和回滚。XA实现分布式事务的原理如下：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191221173353.png" alt="QQ截图20191221173353.png"></p>
<p>两阶段提交，是实现分布式事务的成熟方案。</p>
<ul>
<li>第一阶段是表决阶段，事务管理器要求每个涉及到事务的数据库预提交(precommit)此操作，并反映是否可以提交.</li>
<li>第二阶段是执行阶段，事务协调器要求每个数据库提交数据，或者回滚数据。</li>
</ul>
<p>优点： 尽量保证了数据的强一致，实现成本较低，XA目前在商业数据库支持的比较理想，在MySQL（MySQL5.5开始支持）数据库中支持的不太理想，mysql的XA实现，没有记录prepare阶段日志，主备切换回导致主库与备库数据不一致。许多nosql也没有支持XA，这让XA的应用场景变得非常狭隘。</p>
<p>缺点:</p>
<ul>
<li>单点问题:事务管理器在整个流程中扮演的角色很关键，如果其宕机，比如在第一阶段已经完成，在第二阶段正准备提交的时候事务管理器宕机，资源管理器就会一直阻塞，导致数据库无法使用。</li>
<li>同步阻塞:在准备就绪之后，资源管理器中的资源一直处于阻塞，直到提交完成，释放资源。</li>
<li>数据不一致:两阶段提交协议虽然为分布式数据强一致性所设计，但仍然存在数据不一致性的可能，比如在第二阶段中，假设协调者发出了事务commit的通知，但是因为网络问题该通知仅被一部分参与者所收到并执行了commit操作，其余的参与者则因为没有收到通知一直处于阻塞状态，这时候就产生了数据的不一致性。</li>
</ul>
<p>总的来说，XA协议比较简单，但是其单点问题，以及不能支持高并发(由于同步阻塞)依然是其最大的弱点。XA协议已在业界成熟运行数十年，但目前它在互联网海量流量的应用场景中，吞吐量这个瓶颈变得十分致命，因此很少被用到。</p>
<p>两阶段提交可以满足ACID，但代价是吞吐量。例如，数据库需要频繁地对资源上锁等等。而且更致命的是，资源被锁住的时间相对较长—-在第一阶段即需要上锁，第二阶段才能解锁，依赖于所有分支的最慢者—-这期间没有任何人可以对该资源进行修改。</p>
<h3 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h3><p>TCC（Try、Confirm、Cancel）是两阶段提交的一个变种。TCC提供了一个框架，需要应用程序按照该框架编程，将业务逻辑的每个分支都分为Try、Confirm、Cancel三个操作集。TCC让应用程序自己定义数据库操作的粒度，使得降低锁冲突、提高吞吐量成为可能。</p>
<p>TCC事务机制相比于上面介绍的XA，解决了其几个缺点:</p>
<ul>
<li>1.解决了协调者单点，由主业务方发起并完成这个业务活动。业务活动管理器也变成多点，引入集群。</li>
<li>2.同步阻塞:引入超时，超时后进行补偿，并且不会锁定整个资源，将资源转换为业务逻辑形式，粒度变小。</li>
<li>3.数据一致性，有了补偿机制之后，由业务活动管理器控制一致性</li>
</ul>
<p>流程图：</p>
<p><img src="/img/1010726-20191031060901955-1099206419.png" alt="1010726-20191031060901955-1099206419.png"></p>
<ul>
<li><p>Try阶段：尝试执行,完成所有业务检查（一致性）,预留必须业务资源（准隔离性）</p>
</li>
<li><p>Confirm阶段：确认执行真正执行业务，不作任何业务检查，只使用Try阶段预留的业务资源，Confirm操作满足幂等性。要求具备幂等设计，Confirm失败后需要进行重试。</p>
</li>
<li><p>Cancel阶段：取消执行，释放Try阶段预留的业务资源</p>
</li>
</ul>
<p>Cancel操作满足幂等性Cancel阶段的异常和Confirm阶段异常处理方案基本上一致。</p>
<p>以一个典型的淘宝订单为例，按照TCC框架，应用需要在Try阶段将商品的库存减去，将买家支付宝账户中的相应金额扣掉，在临时表中记录下商品的数量，订单的金额等信息；另外再编写Confirm的逻辑，即在临时表中删除相关记录，生成订单，告知CRM、物流等系统，等等；以及Cancel逻辑，即恢复库存和买家账户金额，删除临时表相关记录。</p>
<p>很明显，最终一致性部分牺牲了ACID中的C和I，但它带来了可观的收益：资源不再需要长时间上锁，极大地提高了吞吐量。</p>
<p>最终一致性在互联网应用场景中被广泛用做吞吐量和ACID的妥协点。</p>
<p>在前面TCC的例子。在这个流程中，商品库存和买家余额都没有被锁住，因此可以得到很高的吞吐量。但在交易进行中，商品库存和买家余额的变化就已经被外界感知到，而物流系统却可能还没有相应的记录，此时数据是不一致的，但最终（无论是Confirm阶段结束后，还是Cancel阶段结束后）它们会一致。</p>
<h3 id="TXC"><a href="#TXC" class="headerlink" title="TXC"></a>TXC</h3><p>TXC(Taobao Transaction Constructor)是阿里巴巴的一个分布式事务中间件，它可以通过极少的代码侵入，实现分布式事务。</p>
<p>在大部分情况下，应用只需要引入TXC Client的jar包，进行几项简单配置，以及以行计的代码改造，即可轻松保证分布式数据一致性。</p>
<p>TXC同时提供了丰富的编程和配置策略，以适应各种长尾的应用需求。</p>
<p>实现原理是在执行SQL之前，先查询SQL的影响数据，然后保存执行的SQL快走信息和创建锁。当需要回滚的时候就采用这些记录数据回滚数据库，目前锁实现依赖redis分布式锁控制。</p>
<p>TXC的目标应用场景是：解决在分布式应用中，多条数据库记录被修改而可能带来的一致性问题；该分布式应用可以接受最终一致性；该应用的事务改造对工作量有较严格的限制。</p>
<h3 id="LCN"><a href="#LCN" class="headerlink" title="LCN"></a>LCN</h3><p>原理：LCN模式是通过代理Connection的方式实现对本地事务的操作，然后在由TxManager统一协调控制事务。当本地事务提交回滚或者关闭连接时将会执行假操作，该代理的连接将由LCN连接池管理。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.txlcn.org/zh-cn/index.html">TX-LCN</a></p>
<h3 id="本地消息表-异步确保"><a href="#本地消息表-异步确保" class="headerlink" title="本地消息表 (异步确保)"></a>本地消息表 (异步确保)</h3><p>本地消息表是国外的 ebay 搞出来的一套方案，如图所示：</p>
<p><img src="/img/1010726-20191031061916148-594757786.png" alt="1010726-20191031061916148-594757786.png"></p>
<p>此方案的核心是将需要分布式处理的任务通过消息日志的方式来异步执行。消息日志可以存储到本地文本、数据库或消息队列，再通过业务规则自动或人工发起重试。人工重试更多的是应用于支付场景，通过对账系统对事后问题的处理。</p>
<p>我们首先需要在本地数据新建一张本地消息表，然后我们必须还要一个MQ（不一定是mq，但必须是类似的中间件）。</p>
<p>这个表应该包括这些字段： id, biz_id, biz_type, msg, msg_result, msg_desc,atime,try_count。分别表示uuid，业务id，业务类型，消息内容，消息结果（成功或失败），消息描述，创建时间，重试次数， 其中biz_id，msg_desc字段是可选的。</p>
<p>实现思路为：</p>
<ul>
<li>A 系统在自己本地一个事务里操作同时，插入一条数据到消息表；</li>
<li>接着 A 系统将这个消息发送到 MQ 中去；</li>
<li>B 系统接收到消息之后，在一个事务里，往自己本地消息表里插入一条数据，同时执行其他的业务操作，如果这个消息已经被处理过了，那么此时这个事务会回滚，这样保证不会重复处理消息；</li>
<li>B 系统执行成功之后，就会更新自己本地消息表的状态以及 A 系统消息表的状态；</li>
<li>如果 B 系统处理失败了，那么就不会更新消息表状态，那么此时 A 系统会定时扫描自己的消息表，如果有未处理的消息，会再次发送到 MQ 中去，让 B 再次处理；</li>
<li>这个方案保证了最终一致性，哪怕 B 事务失败了，但是 A 会不断重发消息，直到 B 那边成功为止。</li>
</ul>
<p>　　<br>这个方案严重依赖于数据库的消息表来管理事务，这样在高并发的情况下难以扩展，同时要在数据库中额外添加一个与实际业务无关的消息表来实现分布式事务，繁琐。</p>
<p>本地消息表核心是把大事务转变为小事务。</p>
<p>例如，用100元去买一瓶水的例子。</p>
<ul>
<li>1.当你扣钱的时候，你需要在你扣钱的服务器上新增加一个本地消息表，你需要把你扣钱和写入减去水的库存到本地消息表放入同一个事务(依靠数据库本地事务保证一致性。</li>
<li>2.这个时候有个定时任务去轮询这个本地事务表，把没有发送的消息，扔给商品库存服务器，叫他减去水的库存，到达商品服务器之后这个时候得先写入这个服务器的事务表，然后进行扣减，扣减成功后，更新事务表中的状态。</li>
<li>3.商品服务器通过定时任务扫描消息表或者直接通知扣钱服务器，扣钱服务器本地消息表进行状态更新。</li>
<li>4.针对一些异常情况，定时扫描未成功处理的消息，进行重新发送，在商品服务器接到消息之后，首先判断是否是重复的，如果已经接收，在判断是否执行，如果执行在马上又进行通知事务，如果未执行，需要重新执行需要由业务保证幂等，也就是不会多扣一瓶水。</li>
</ul>
<p>本地消息队列是BASE理论，是最终一致模型，适用于对一致性要求不高的。实现这个模型时需要注意重试的幂等。</p>
<h3 id="MQ事务"><a href="#MQ事务" class="headerlink" title="MQ事务"></a>MQ事务</h3><p>直接基于 MQ 来实现事务，不再用本地的消息表。所谓的消息事务就是基于消息中间件的两阶段提交，本质上是对消息中间件的一种特殊利用，它是将本地事务和发消息放在了一个分布式事务里，保证要么本地操作成功成功并且对外发消息成功，要么两者都失败，开源的RocketMQ就支持这一特性，但是市面上一些主流的MQ都是不支持事务消息的，比如 RabbitMQ 和 Kafka 都不支持。</p>
<p>在RocketMQ中实现了分布式事务，实际上其实是对本地消息表的一个封装，将本地消息表移动到了MQ内部。</p>
<p><img src="/img/20170320083222287.png" alt="20170320083222287.png"></p>
<p>基本流程如下:</p>
<ul>
<li>1、A系统向消息中间件发送一条预备消息</li>
<li>2、消息中间件保存预备消息并返回成功</li>
<li>3、A执行本地事务</li>
<li>4、A发送提交消息给消息中间件</li>
</ul>
<p>通过以上4步完成了一个消息事务。对于以上的4个步骤，每个步骤都可能产生错误，下面一一分析：</p>
<ul>
<li>步骤一出错，则整个事务失败，不会执行A的本地操作</li>
<li>步骤二出错，则整个事务失败，不会执行A的本地操作</li>
<li>步骤三出错，这时候需要回滚预备消息，怎么回滚？答案是A系统实现一个消息中间件的回调接口，消息中间件会去不断执行回调接口，检查A事务执行是否执行成功，如果失败则回滚预备消息</li>
<li>步骤四出错，这时候A的本地事务是成功的，那么消息中间件要回滚A吗？答案是不需要，其实通过回调接口，消息中间件能够检查到A执行成功了，这时候其实不需要A发提交消息了，消息中间件可以自己对消息进行提交，从而完成整个消息事务</li>
</ul>
<p>基于消息中间件的两阶段提交往往用在高并发场景下，将一个分布式事务拆成一个消息事务（A系统的本地操作+发消息）+B系统的本地操作，其中B系统的操作由消息驱动，只要消息事务成功，那么A操作一定成功，消息也一定发出来了，这时候B会收到消息去执行本地操作，如果本地操作失败，消息会重投，直到B操作成功，这样就变相地实现了A与B的分布式事务。</p>
<p><img src="/img/20170320083228100.png" alt="20170320083228100.png"></p>
<p>上面的方案能够完成A和B的操作，但是A和B并不是严格一致的，而是最终一致的，我们在这里牺牲了一致性，换来了性能的大幅度提升。如果消费超时，则需要一直重试，消息接收端需要保证幂等。如果消息消费失败，这个就需要人工进行处理，因为这个概率较低，如果为了这种小概率时间而设计这个复杂的流程反而得不偿失。</p>
<p><img src="/img/164d77389afdfd6b.png" alt="164d77389afdfd6b.png"></p>
<h3 id="Saga事务"><a href="#Saga事务" class="headerlink" title="Saga事务"></a>Saga事务</h3><p>SAGA可以看做一个异步的、利用队列实现的补偿事务。</p>
<p>其适用于无需马上返回业务发起方最终状态的场景，例如：你的请求已提交，请稍后查询或留意通知 之类。</p>
<p>Saga是30年前一篇数据库伦理提到的一个概念。其核心思想是将长事务拆分为多个本地短事务，由Saga事务协调器协调，如果正常结束那就正常完成，如果某个步骤失败，则根据相反顺序一次调用补偿操作。</p>
<p>saga的提出，最早是为了解决可能会长时间运行的分布式事务（long-running process）的问题。所谓long-running的分布式事务，是指那些企业业务流程，需要跨应用、跨企业来完成某个事务，甚至在事务流程中还需要有手工操作的参与，这类事务的完成时间可能以分计，以小时计，甚至可能以天计。这类事务如果按照事务的ACID的要求去设计，势必造成系统的可用性大大的降低。试想一个由两台服务器一起参与的事务，服务器A发起事务，服务器B参与事务，B的事务需要人工参与，所以处理时间可能很长。如果按照ACID的原则，要保持事务的隔离性、一致性，服务器A中发起的事务中使用到的事务资源将会被锁定，不允许其他应用访问到事务过程中的中间结果，直到整个事务被提交或者回滚。这就造成事务A中的资源被长时间锁定，系统的可用性将不可接受。</p>
<p>而saga，则是一种基于补偿的消息驱动的用于解决long-running process的一种解决方案。目标是为了在确保系统高可用的前提下尽量确保数据的一致性。还是上面的例子，如果用saga来实现，那就是这样的流程：服务器A的事务先执行，如果执行顺利，那么事务A就先行提交；如果提交成功，那么就开始执行事务B，如果事务B也执行顺利，则事务B也提交，整个事务就算完成。但是如果事务B执行失败，那事务B本身需要回滚，这时因为事务A已经提交，所以需要执行一个补偿操作，将已经提交的事务A执行的操作作反操作，恢复到未执行前事务A的状态。这样的基于消息驱动的实现思路，就是saga。我们可以看出，saga是牺牲了数据的强一致性，仅仅实现了最终一致性，但是提高了系统整体的可用性。</p>
<p>Saga的组成：</p>
<p>每个Saga由一系列sub-transaction Ti 组成<br>每个Ti 都有对应的补偿动作Ci，补偿动作用于撤销Ti造成的结果,这里的每个T，都是一个本地事务。<br>可以看到，和TCC相比，Saga没有“预留 try”动作，它的Ti就是直接提交到库。</p>
<p>Saga的执行顺序有两种：</p>
<ul>
<li>T1, T2, T3, …, Tn</li>
<li>T1, T2, …, Tj, Cj,…, C2, C1，其中0 &lt; j &lt; n</li>
</ul>
<p>Saga定义了两种恢复策略：</p>
<ul>
<li>向后恢复，即上面提到的第二种执行顺序，其中j是发生错误的sub-transaction，这种做法的效果是撤销掉之前所有成功的sub-transation，使得整个Saga的执行结果撤销。</li>
<li>向前恢复，适用于必须要成功的场景，执行顺序是类似于这样的：T1, T2, …, Tj(失败), Tj(重试),…, Tn，其中j是发生错误的sub-transaction。该情况下不需要Ci。</li>
</ul>
<p>这里要注意的是，在saga模式中不能保证隔离性，因为没有锁住资源，其他事务依然可以覆盖或者影响当前事务。</p>
<p>拿100元买一瓶水的例子来说，这里定义:</p>
<p>T1=扣100元 T2=给用户加一瓶水 T3=减库存一瓶水<br>C1=加100元 C2=给用户减一瓶水 C3=给库存加一瓶水</p>
<p>我们一次进行T1,T2，T3如果发生问题，就执行发生问题的C操作的反向。</p>
<p>上面说到的隔离性的问题会出现在，如果执行到T3这个时候需要执行回滚，但是这个用户已经把水喝了(另外一个事务)，回滚的时候就会发现，无法给用户减一瓶水了。这就是事务之间没有隔离性的问题</p>
<p>可以看见saga模式没有隔离性的影响还是较大，可以参照华为的解决方案:从业务层面入手加入一 Session 以及锁的机制来保证能够串行化操作资源。也可以在业务层面通过预先冻结资金的方式隔离这部分资源， 最后在业务操作的过程中可以通过及时读取当前状态的方式获取到最新的更新。</p>
<p>具体实例:可以参考华为的 servicecomb 。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/balavatasky/p/6101345.html">saga中的saga（A Saga on Sagas）</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/skyesx/p/9697817.html">如何选择分布式事务形态（TCC，SAGA，2PC，补偿，基于消息最终一致性等等）</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5b5a0bf9f265da0f6523913b">再有人问你分布式事务，把这篇扔给他</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sky-chen/p/10342207.html">TX-LCN分布式事务Demo实战</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_38110132/article/details/77043580">TXC分布式事务简介</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_38110132/article/details/76994165">分布式事务的解决方案</a></p>
<p><a target="_blank" rel="noopener" href="https://yq.aliyun.com/articles/72011">GTS让分布式事务简单高效</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jiangyu666/p/8522547.html">微服务架构下分布式事务解决方案——阿里GTS</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/netfocus/p/3149156.html">ENode 1.0 - Saga的思想与实现</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/11/25/CSharp-ValueTask%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/25/CSharp-ValueTask%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">CSharp-ValueTask解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-25 14:28:13" itemprop="dateCreated datePublished" datetime="2019-11-25T14:28:13+00:00">2019-11-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-07 08:51:18" itemprop="dateModified" datetime="2022-09-07T08:51:18+00:00">2022-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/net%E5%BC%82%E6%AD%A5%E4%B8%8E%E5%B9%B6%E8%A1%8C/" itemprop="url" rel="index"><span itemprop="name">.net异步与并行</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="结构vs类，栈vs堆"><a href="#结构vs类，栈vs堆" class="headerlink" title="结构vs类，栈vs堆"></a>结构vs类，栈vs堆</h2><p>&emsp;&emsp;在托管.NET世界中，您应该关注两个内存区域：栈和堆。堆是在其中分配所有对象的托管内存（无论何时调用 <code>new YourClass</code>）。重要的方面是它与任何线程都不相关或没有连接。一个线程可以分配一个对象并将其传递给另一线程。只要垃圾收集器没有收集该对象，该对象就会在堆上。</p>
<p>&emsp;&emsp;栈以不同的方式工作。它被分配给特定的线程（每个线程的堆栈大小有限）。栈具有框架，可用于分配一些内存，例如用于在调用过程中创建并分配给变量的结构值，例如，通过调用<code>Guid.NewGuid()</code>。</p>
<p>&emsp;&emsp;堆分配的内存可用于在线程之间传输某些数据。由于栈是分配给特定线程的，因此不能用于传输某些数据。另一方面，如果您要分配少量内存，则堆栈将更快一些，因为它是线程本地的，并且不会陷入启动垃圾收集器等缓慢的路径中。</p>
<h2 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h2><p><code>Task</code> 在 .NET Framework 4 中 <code>System.Threading.Tasks</code> 命名空间被引入，在 C#5 以及 .NET Framwrok 4.5 中的异步编程模式引入了 <code>async/await</code>。</p>
<p><code>Task</code> 的核心就是 <code>promise</code>，它表示最终完成的一些操作。当初始化一个操作时，返回一个 <code>Task</code>，当操作完成时，<code>Task</code> 会完成。</p>
<p>特点：</p>
<p><code>Task</code> 很灵活，并且有很多好处。例如你可以通过多个消费者并行等待多次。你可以存储一个到字典中，以便后面的任意数量的消费者等待，它允许为异步结果像缓存一样使用。如果场景需要，你可以阻塞一个等待完成。并且你可以在这些任务上编写和使用各种操作（就像组合器），例如 WhenAny 操作，它可以异步等待第一个操作完成。</p>
<p>然而，这种灵活性对于大多数情况下是不需要的：仅仅只是调用异步操作并且等待结果：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TResult result = <span class="keyword">await</span> SomeOperationAsync();</span><br><span class="line">UseResult(result);</span><br></pre></td></tr></table></figure>

<p>副作用:</p>
<p>Task 是一个类。作为一个类，就是说任意操作创建一个 Task 都会分配一个对象，越来越多的对象都会被分配，所以 GC 操作也会越来越频繁，也就会消耗越来越多的资源，本来它应该是去做其他事的。</p>
<h2 id="ValueTask"><a href="#ValueTask" class="headerlink" title="ValueTask"></a>ValueTask</h2><p>.NET CORE 2.0 引入了一个新类型 <code>ValueTask&lt;TResult&gt;</code>，在 <code>System.Threading.Tasks.Extensions</code> 命名空间中。<code>ValueTask&lt;TResult&gt;</code> 作为结构体引入的，它是 <code>TResult</code> 或 <code>Task&lt;TResult&gt;</code> 包装器。</p>
<p>实例可以等待或 <code>Task&lt;TResult&gt;</code> 使用 <code>AsTask</code> 转换为。 <code>ValueTask&lt;TResult&gt;</code> 实例仅可等待一次, 并且在实例完成之前, 使用者可能不会调用 <code>GetAwaiter()</code>。</p>
<p>永远不应对 <code>ValueTask&lt;TResult&gt;</code>实例执行以下操作:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">等待实例多次。</span><br><span class="line">多次AsTask调用。</span><br><span class="line">使用/操作未完成/使用多次 .Result.GetAwaiter().GetResult()</span><br><span class="line">使用多种方法来使用此实例。</span><br></pre></td></tr></table></figure>

<p>如果执行上述任一操作, 则结果是不确定的。</p>
<h3 id="同步完成-synchronous-completion"><a href="#同步完成-synchronous-completion" class="headerlink" title="同步完成 (synchronous completion)"></a>同步完成 (synchronous completion)</h3><p>它能从异步方法返回并且如果这个方法同步成功完成，不需要分配任何内存：只简单的初始化这个 <code>ValueTask&lt;TResult&gt;</code> 结构体，它返回 <code>TResult</code>。</p>
<p>只有当该方法异步完成时，<code>Task&lt;TResult&gt;</code> 才需要进行分配， 创建包装该 <code>ValueTask &lt;TResult&gt;</code> 的实例（以最小化 <code>ValueTask &lt;TResult&gt;</code>的大小，并用于优化成功路径，异步方法未处理的异常故障也将分配一个 <code>Task&lt;TResult&gt;</code>，所以 <code>ValueTask&lt;TResult&gt;</code> 可以简单地包裹该 <code>Task&lt;TResult&gt;</code>, 而并不是 随身携带附加字段以存储异常）。</p>
<h3 id="异步完成-asynchronous-completion"><a href="#异步完成-asynchronous-completion" class="headerlink" title="异步完成 (asynchronous completion)"></a>异步完成 (asynchronous completion)</h3><p>在.NET Core 2.1，引入 <code>IValueTaskSource&lt;TResult&gt;</code> 支持池化和重用。</p>
<p>.NET Core 2.1为 <code>ValueTask</code> 添加了另一个构造函数：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">struct</span> ValueTask&lt;TResult&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ValueTask</span>(<span class="params">IValueTaskSource&lt;TResult&gt; source, <span class="built_in">short</span> token</span>)</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<p>token：令牌参数，该值确保将 <code>IValueTaskSource</code> 返回到池后不会使用 <code>ValueTask</code>。有效地，此令牌值将传递到 <code>IValueTaskSource</code> 实现的每个方法，该方法能够检查调用者是否滥用 <code>ValueTask</code>。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IValueTaskSource</span>&lt;<span class="keyword">out</span> <span class="title">TResult</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">ValueTaskSourceStatus <span class="title">GetStatus</span>(<span class="params"><span class="built_in">short</span> token</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnCompleted</span>(<span class="params">Action&lt;<span class="built_in">object</span>&gt; continuation, <span class="built_in">object</span> state, <span class="built_in">short</span> token, ValueTaskSourceOnCompletedFlags flags</span>)</span>;</span><br><span class="line">    <span class="function">TResult <span class="title">GetResult</span>(<span class="params"><span class="built_in">short</span> token</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参与：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.threading.tasks.valuetask-1?view=netcore-3.0">ValueTask<TResult> 结构</a></p>
<p><a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/dotnet/understanding-the-whys-whats-and-whens-of-valuetask/">Understanding the Whys, Whats, and Whens of ValueTask</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.scooletz.com/2018/05/14/task-async-await-valuetask-ivaluetasksource-and-how-to-keep-your-sanity-in-modern-net-world/">Task, Async Await, ValueTask, IValueTaskSource and how to keep your sanity in modern .NET world</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/11/22/Actor%E6%A8%A1%E5%9E%8B%E5%92%8CCSP%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/22/Actor%E6%A8%A1%E5%9E%8B%E5%92%8CCSP%E6%A8%A1%E5%9E%8B/" class="post-title-link" itemprop="url">Actor模型和CSP模型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-22 14:23:02" itemprop="dateCreated datePublished" datetime="2019-11-22T14:23:02+00:00">2019-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-07 08:51:18" itemprop="dateModified" datetime="2022-09-07T08:51:18+00:00">2022-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/" itemprop="url" rel="index"><span itemprop="name">并发模型</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="传统三层无状态架构的缺陷"><a href="#传统三层无状态架构的缺陷" class="headerlink" title="传统三层无状态架构的缺陷"></a>传统三层无状态架构的缺陷</h2><p>三层架构包括表示层、业务逻辑层(中间层)、数据访问层（存储层）</p>
<p>　　传统的三层体系结构具有无状态前端、无状态的中间层和存储层，由于存储层的延迟和吞吐量限制，其可扩展性有限（存储层常常会成为系统的瓶颈），因此必须针对每个请求进行咨询。这就意味着整套系统也会因为存储层的限制而变得低效。通常的做法是在中间层与存储层中间加一层缓存逻辑出来，以提升系统性能，但是很快就会遇到存储层与缓存层的数据一致性问题，为了防止缓存项的并发更新导致不一致，应用程序或缓存管理器必须实现并发控制协议。这无疑为开发人员和运维人员增加了额外的工作量。</p>
<p>Actor模型和CSP模型的出现，解决了传统三层架构的缺陷。</p>
<h2 id="Actor模型"><a href="#Actor模型" class="headerlink" title="Actor模型"></a>Actor模型</h2><h3 id="Actor模型简介"><a href="#Actor模型简介" class="headerlink" title="Actor模型简介"></a>Actor模型简介</h3><p>　　actor模型最早被1973年的“A Universal Modular ACTOR Formalism for Artificial Intelligence”引入，作为人工智能研究中的一种计算方法。它的最初目标是用一种能安全地跨工作站并发分布的通信方式来建模并行计算。这篇文章几乎没有假设实现细节，而是定义了一种高级消息传递通信模型。actor模型的四个主要变体：经典actor模型、基于进程的actor模型、通信事件循环模型、以及活动对象模型。</p>
<p>　　有些健壮的工业级actor系统正被用于赋能大规模可伸缩分布式系统，主要案例：例如Akka被用于服务PayPal的十亿级的事务，Erlang被用于为WhatsApp的上亿用户发送消息，而Orleans被用于服务Halo4的数百万玩家。</p>
<p>　　Actor模型作为一种用于处理并发计算的数学概念模型，它定义了系统组件该如何表现，以及如何与其他组件交互的一些通用规则。它将Actor对象用作并发计算的基本单元，它也是一种重要的软件设计思想，它在架构、设计、实现以及组件之间的消息传递方面有着非常好的应用，也更好的发挥了多核计算机的潜力。该思想与我们经常用到的面向对象语言的思想很类似：一个对象接受消息（方法调用）然后依据消息数据进行计算。主要的不同点在于，actor之间完全独立，没有共享内存。值得注意的是，一个actor维持的私有状态从来不会被其他actor改变，而只会通过接受消息，自己改变自己。通过创建新的Actor对象，可以在计算操作的生命周期中以抽象方式提高系统的分布性。</p>
<p>　　Actor模型允许建立一个有状态的中间层，其内存级的读写性能和特定于相关领域的业务实体行为，确保了系统的高性能以及数据的一致性。Actor模型天然的拥有着面向对象的程序设计功能，在实践中我们应该把主要精力放到组件之间的消息传递，而不是对象的属性和内部行为。</p>
<p>一个actor并不能成为actor模型。actor是系统的组件，actor模型认为系统所有的组件都是actor，都有地址，actor通过这些地址进行异步通信。</p>
<p><img src="/img/260879-325a351b6a349d3c.png" alt="260879-325a351b6a349d3c.png"></p>
<h3 id="经典actor模型"><a href="#经典actor模型" class="headerlink" title="经典actor模型"></a>经典actor模型</h3><p>经典actor模型，保持了在隔离的计算单元和状态单元之间通过消息来做异步通信的思想，主要特点如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">异步通信：使消息就像从一个Actor对象传输到了另一个Actor对象</span><br><span class="line">状态机：Actor模型支持有限状态机</span><br><span class="line">独立性：多个Actor对象之间不会共享状态</span><br><span class="line">无锁的并发处理：由于Actor不会共享状态，且在同一时刻只处理一条消息，因而无需使用锁策略，这极大的提高了Actor系统的性能</span><br><span class="line">并行性：当顶级Actor将任务分拆后发送给多个下级Actor后，可以使用Actor模型的并行处理方式</span><br><span class="line">位置透明：可以使用抽象引用表示Actor对象的地址</span><br><span class="line">Future/Promise对象：这是对异步操作的发送与接收方式，以表示异步操作的完成结果</span><br></pre></td></tr></table></figure>

<p>当一个actor接收消息时，通常做以下三件事情：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create：用一种行为的描述和一组参数（包括其它actor）来创建一个actor。</span><br><span class="line">send：向其它actor发送消息。</span><br><span class="line">become：将一个actor的当前行为替换为另一种行为。（设置对下一条消息做出的回应方式）</span><br></pre></td></tr></table></figure>

<p>　　在经典actor模型中，状态变化均由become操作来聚合完成。每当actor处理一条消息时，它会计算出一个行为，来响应它期望处理的下一种消息类型。become操作的参数是一个有名字的continuation b，表示actor应该被更新为的行为，以及它应该传递给 b 的状态。(continuation：延续)</p>
<p>可以简单理解成，在一个actor维持私有状态之前，第三条基本上意味着定义了接收下条信息之前actor的状态。或者说，actor是如何改变自身状态的。</p>
<p>假设一个actor是一个计算器，初始状态为0。当这个actor接收到“+1”的消息后，它将指定接收下一个消息时，actor的状态为1，而不是改变原始的状态。</p>
<h3 id="Orleans对Actor的应用"><a href="#Orleans对Actor的应用" class="headerlink" title="Orleans对Actor的应用"></a>Orleans对Actor的应用</h3><p>　　Actor平台（例如Erlang和Akka）在简化分布式系统编程方面向前迈了一步。但是，由于提供的抽象和系统服务的水平相对较低，它们仍然使开发人员承担着许多分布式系统的复杂性。主要包括开发用于管理Actor的生命周期，处理分布式簇，处理Actor的失败和恢复，放置Actor以及由此产生的管理分布式资源的应用程序代码。要为应用程序中的这些问题构建正确的解决方案，这就开发人员的要求就非常高了，必须是分布式系统专家级别的。</p>
<p>　　为了减少这些问题的发生，Orleans框架引入了虚拟Actor的新型抽象，它解决了许多复杂的分布式系统问题，例如可靠性和分布式资源管理，从而使开发人员摆脱了那些麻烦。同时，Orleans运行时使应用程序能够获得高性能，可靠性和可伸缩性。</p>
<p>Orleans对Actor的实现特点：</p>
<ul>
<li>1，Orleans Actor无处不在：无法明确创建或销毁它。它的生命周期超越了其任何内存对象的生命周期，因此也超越了任何特定服务器的生命周期。</li>
<li>2，Orleans Actor会自动实例化：如果没有Actor的内存实例，则发送给Actor的消息会促使在可用服务器上创建一个新实例。作为运行时资源管理的一部分，将自动回收未使用的Actor实例。</li>
<li>3，Actor永远不会失败：如果服务器崩溃了，下一条发送给运行在故障服务器上的Actor的消息将会促使Orleans自动在另一台服务器上重新实例化该Actor ，从而无需应用程序来监督和显式重新创建已经挂掉的Actor。</li>
<li>4，Actor实例的位置对于应用程序代码是透明的，从而大大简化了编程。</li>
<li>5，Orleans可以自动创建同一个无状态Actor的多个实例，从而无缝扩展热门Actor。</li>
</ul>
<p>　　虚拟Actor的引入，相当于为开发者提供了一个虚拟的内存空间，使开发人员可以调用系统中的任何角色，无论它是否存在于内存中。虚拟化依赖于从虚拟角色映射到当前运行的物理实例的间接寻址。运行时通过一个分布式目录支持间接寻址，该目录将Actor标识映射到其当前物理位置。Orleans通过使用该映射的本地缓存来最小化间接寻址的运行时开销。这个策略被证明是非常有效的。在微软的生产服务中，缓存命中率通常远远超过90%。</p>
<p><img src="/img/533598-20190922155518083-577463983.jpg" alt="533598-20190922155518083-577463983.jpg"></p>
<h2 id="CSP模型"><a href="#CSP模型" class="headerlink" title="CSP模型"></a>CSP模型</h2><p>　　CSP是 Communicating Sequential Processes(通信顺序进程) 的简称。在CSP中，多了一个角色Channel，过程（比如goroutine，Worker1）与过程（Worker2）之间不直接通信，而是通过Channle进行通信。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Worker1 --&gt; Channel --&gt; Worker2</span><br></pre></td></tr></table></figure>

<p>CSP模型特点：</p>
<ul>
<li>Channel是过程的中间媒介，Worker1想要跟Worker2发信息时，直接把信息放到Channel里（在程序中其实就是一块内存），然后Worker2在方便的时候到Channel里获取。</li>
<li>Worker1和Worker2之间可以存在很多个Channel；在Golang中每个Channel定义不同的数据类型，即发送不同类型的消息的时候会用到多个不同的Channel。</li>
</ul>
<p>Go语言的CSP模型是由协程Goroutine与通道Channel实现：</p>
<ul>
<li>Go协程goroutine: 是一种轻量线程，它不是操作系统的线程，而是将一个操作系统线程分段使用，通过调度器实现协作式调度。是一种绿色线程，微线程，它与Coroutine协程也有区别，能够在发现堵塞后启动新的微线程。</li>
<li>通道channel: 类似Unix的Pipe，用于协程之间通讯和同步。协程之间虽然解耦，但是它们和Channel有着耦合。</li>
</ul>
<p><img src="/img/channel.png" alt="channel.png"></p>
<h2 id="Actor模型和CSP模型比较"><a href="#Actor模型和CSP模型比较" class="headerlink" title="Actor模型和CSP模型比较"></a>Actor模型和CSP模型比较</h2><p>Actor之间直接通讯，而CSP是通过Channel通讯，在耦合度上两者是有区别的，后者更加松耦合。</p>
<p>　　同时，它们都是描述独立的流程通过消息传递进行通信。主要的区别在于：在CSP消息交换是同步的(即两个流程的执行”接触点”的，在此他们交换消息)，而Actor模型是完全解耦的，可以在任意的时间将消息发送给任何未经证实的接受者。由于Actor享有更大的相互独立,因为他可以根据自己的状态选择处理哪个传入消息。自主性更大些。</p>
<p>　　在Go语言中为了不堵塞流程，程序员必须检查不同的传入消息，以便预见确保正确的顺序。CSP好处是Channel不需要缓冲消息，而Actor理论上需要一个无限大小的邮箱作为消息缓冲。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://fuzhe1989.github.io/2018/05/17/message-passing-and-the-actor-model/#orleans">[翻译]消息传递与actor模型</a></p>
<p><a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/research/project/orleans-virtual-actors/">Orleans – Virtual Actors</a></p>
<p><a target="_blank" rel="noopener" href="https://jingwei.link/2018/07/08/actor-and-csp-model.html">并发模型：Actors与CSP</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edison0621/p/11567800.html">.NET分布式大规模计算利器-Orleans(一)</a></p>
<p><a target="_blank" rel="noopener" href="https://my.oschina.net/wanborj/blog/852410">十分钟了解Actor模型</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jdon.com/concurrent/actor-csp.html">Actor模型和CSP模型的区别</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/11/16/C-Sharp%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%8E%E5%AD%97%E8%8A%82%E4%BA%92%E8%BD%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/16/C-Sharp%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%8E%E5%AD%97%E8%8A%82%E4%BA%92%E8%BD%AC/" class="post-title-link" itemprop="url">C-Sharp字符串与字节互转</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-16 16:37:24" itemprop="dateCreated datePublished" datetime="2019-11-16T16:37:24+00:00">2019-11-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-07 08:51:18" itemprop="dateModified" datetime="2022-09-07T08:51:18+00:00">2022-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSharp%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">CSharp基础</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="十六进制"><a href="#十六进制" class="headerlink" title="十六进制"></a>十六进制</h2><p>十六进制的表示:<br>C语言、Shell、Python语言及其他相近的语言使用字首“0x”，例如“0x5A3”。开头的“0”令解析器更易辨认数，而“x”则代表十六进制。在“0x”中的“x”可以大写或小写。</p>
<p>16进制就有16个数，0<del>15，用二进制表示15的方法就是1111，从而可以推断出，16进制用2进制可以表现成0000</del>1111，顾名思义，也就是每四个为一位。最高位不够可用零代替。</p>
<p>一个字节包含8个二进制位，一个十六进制可表示4个二进制位，所以，一个字节可以由2个十六进制表示。即，一个byte 对应两位十六进制位。</p>
<h2 id="十六进制转换"><a href="#十六进制转换" class="headerlink" title="十六进制转换"></a>十六进制转换</h2><h3 id="字符串转为16进制字符"><a href="#字符串转为16进制字符" class="headerlink" title="字符串转为16进制字符"></a>字符串转为16进制字符</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">StringToHexString</span>(<span class="params"><span class="built_in">string</span> s, Encoding encode</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">byte</span>[] b = encode.GetBytes(s);<span class="comment">//按照指定编码将string编程字节数组</span></span><br><span class="line">    <span class="built_in">string</span> result = <span class="built_in">string</span>.Empty;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; b.Length; i++)<span class="comment">//逐字节变为16进制字符</span></span><br><span class="line">    &#123;</span><br><span class="line">        result += Convert.ToString(b[i], <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">System.Console.WriteLine(StringToHexString(<span class="string">&quot;严&quot;</span>, System.Text.Encoding.UTF8));</span><br><span class="line">System.Console.WriteLine(BitConverter.ToString(Encoding.UTF8.GetBytes(<span class="string">&quot;严&quot;</span>)));</span><br></pre></td></tr></table></figure>

<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191116174552.png" alt="QQ截图20191116174552.png"></p>
<h3 id="16进制字符串转为字符串"><a href="#16进制字符串转为字符串" class="headerlink" title="16进制字符串转为字符串"></a>16进制字符串转为字符串</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">HexStringToString</span>(<span class="params"><span class="built_in">string</span> hs, Encoding encode</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">string</span> strTemp = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="built_in">byte</span>[] b = <span class="keyword">new</span> <span class="built_in">byte</span>[hs.Length / <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; hs.Length / <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        strTemp = hs.Substring(i * <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">        b[i] = Convert.ToByte(strTemp, <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//按照指定编码将字节数组变为字符串</span></span><br><span class="line">    <span class="keyword">return</span> encode.GetString(b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="built_in">string</span> hexstring = StringToHexString(<span class="string">&quot;严&quot;</span>, System.Text.Encoding.UTF8);</span><br><span class="line"><span class="built_in">string</span> content = HexStringToString(hexstring, System.Text.Encoding.UTF8);</span><br></pre></td></tr></table></figure>

<h3 id="byte-转为16进制字符串"><a href="#byte-转为16进制字符串" class="headerlink" title="byte[]转为16进制字符串"></a>byte[]转为16进制字符串</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ByteToHexStr</span>(<span class="params"><span class="built_in">byte</span>[] bytes</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">string</span> returnStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (bytes != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; bytes.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            returnStr += bytes[i].ToString(<span class="string">&quot;X2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> returnStr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> byteStr = StringToHexString(<span class="string">&quot;严&quot;</span>, Encoding.UTF8);</span><br><span class="line">Console.WriteLine(byteStr);<span class="comment">// 输出 e4b8a5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bytes = Encoding.UTF8.GetBytes(<span class="string">&quot;严&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> str = Encoding.UTF8.GetString(bytes);<span class="comment">// 输出 严</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> str1 = ByteToHexStr(bytes); <span class="comment">//  输出 E4B8A5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bytes1 = StrToToHexByte(str1);</span><br><span class="line"><span class="keyword">var</span> bytes2 = StrToToHexByte(byteStr);</span><br></pre></td></tr></table></figure>

<h3 id="16进制的字符串转为byte"><a href="#16进制的字符串转为byte" class="headerlink" title="16进制的字符串转为byte[]"></a>16进制的字符串转为byte[]</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">StrToToHexByte</span>(<span class="params"><span class="built_in">string</span> hexString</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    hexString = hexString.Replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((hexString.Length % <span class="number">2</span>) != <span class="number">0</span>)</span><br><span class="line">        hexString += <span class="string">&quot; &quot;</span>;</span><br><span class="line">    <span class="built_in">byte</span>[] returnBytes = <span class="keyword">new</span> <span class="built_in">byte</span>[hexString.Length / <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; returnBytes.Length; i++)</span><br><span class="line">        returnBytes[i] = Convert.ToByte(hexString.Substring(i * <span class="number">2</span>, <span class="number">2</span>), <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">return</span> returnBytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/WuLex/article/details/75452472">C#数字、16进制字符串和字节之间互转</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/11/16/%E5%B7%A5%E5%85%B7%E9%9B%86%E5%90%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/16/%E5%B7%A5%E5%85%B7%E9%9B%86%E5%90%88/" class="post-title-link" itemprop="url">工具集合</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-16 16:16:05" itemprop="dateCreated datePublished" datetime="2019-11-16T16:16:05+00:00">2019-11-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-07 08:51:18" itemprop="dateModified" datetime="2022-09-07T08:51:18+00:00">2022-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>388</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="UltraEdit"><a href="#UltraEdit" class="headerlink" title="UltraEdit"></a>UltraEdit</h2><p>文本编辑器，可以查看16进制字节；</p>
<h2 id="ef-core-power-tool"><a href="#ef-core-power-tool" class="headerlink" title="ef core power tool"></a>ef core power tool</h2><p>生成DbContext；反向生成 POCO 类等；</p>
<h2 id="emeditor"><a href="#emeditor" class="headerlink" title="emeditor"></a>emeditor</h2><p>大文本文件编辑器，方便查找；</p>
<h2 id="ListDLLs"><a href="#ListDLLs" class="headerlink" title="ListDLLs"></a>ListDLLs</h2><p>检测当前运行的进程已经加载的dll文件</p>
<h2 id="WinHex"><a href="#WinHex" class="headerlink" title="WinHex"></a>WinHex</h2><p>是在Windows下执行的十六进制编辑软件，此软件功能很强大，有完好的分区管理功能和文件管理功能。能自己主动分析分区链和文件簇链。能对硬盘进行不同方式不同程度的备份。甚至克隆整个硬盘；它可以编辑不论什么一种文件类型的二进制内容（用十六进制显示）其磁盘编辑器可以编辑物理磁盘或逻辑磁盘的随意扇区。是手工恢复数据的首选工具软件。</p>
<h2 id="PEid"><a href="#PEid" class="headerlink" title="PEid"></a>PEid</h2><p>PEiD(PE Identifier)是一款著名的查壳工具，其功能强大，几乎可以侦测出所有的壳，其数量已超过470 种PE 文档 的加壳类型和签名。</p>
<h2 id="cmder"><a href="#cmder" class="headerlink" title="cmder"></a>cmder</h2><p>命令行增强工具</p>
<h2 id="VLC-mediaplayer"><a href="#VLC-mediaplayer" class="headerlink" title="VLC mediaplayer"></a>VLC mediaplayer</h2><p>视频流播放软件</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/11/16/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/16/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">字符编码笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-16 13:26:06" itemprop="dateCreated datePublished" datetime="2019-11-16T13:26:06+00:00">2019-11-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-07 08:51:18" itemprop="dateModified" datetime="2022-09-07T08:51:18+00:00">2022-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">计算机基础</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ASCII-码"><a href="#ASCII-码" class="headerlink" title="ASCII 码"></a>ASCII 码</h2><p>每一个二进制位（bit）有0和1两种状态，因此八个二进制位就可以组合出256种状态，这被称为一个字节（byte）。也就是说，一个字节一共可以用来表示256种不同的状态，每一个状态对应一个符号，就是256个符号，从00000000到11111111。<br>ASCII，美国信息交换标准代码，是基于拉丁字母的一套电脑编码系统。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191116140828.png" alt="QQ截图20191116140828.png"></p>
<p>参考：<a target="_blank" rel="noopener" href="https://tool.oschina.net/commons?type=4">ASCII对照表</a></p>
<h2 id="Unicode-与-UCS"><a href="#Unicode-与-UCS" class="headerlink" title="Unicode 与 UCS"></a>Unicode 与 UCS</h2><p>Unicode也是一种字符编码方法，不过它是由国际组织设计，可以容纳全世界所有语言文字的编码方案。Unicode的学名是”Universal Multiple-Octet Coded Character Set”，简称为UCS。UCS可以看作是”Unicode Character Set”的缩写。</p>
<p>在表示一个Unicode的字符时，通常会用“U+”然后紧接着一组十六进制的数字来表示这一个字符。</p>
<p>Unicode 当然是一个很大的集合，现在的规模可以容纳100多万个符号。每个符号的编码都不一样，比如，U+0639表示阿拉伯字母Ain，U+0041表示英语的大写字母A，U+4E25表示汉字严。</p>
<p><a target="_blank" rel="noopener" href="https://home.unicode.org/">Unicode符号对应表</a></p>
<h2 id="UTF编码"><a href="#UTF编码" class="headerlink" title="UTF编码"></a>UTF编码</h2><p>UTF-8就是以8位为单元对UCS进行编码。从UCS-2到UTF-8的编码方式如下：</p>
<table>
<thead>
<tr>
<th>UCS-2编码(16进制)</th>
<th>UTF-8 字节流(二进制)</th>
</tr>
</thead>
<tbody><tr>
<td>0000 - 007F</td>
<td>0xxxxxxx</td>
</tr>
<tr>
<td>0080 - 07FF</td>
<td>110xxxxx 10xxxxxx</td>
</tr>
<tr>
<td>0800 - FFFF</td>
<td>1110xxxx 10xxxxxx 10xxxxxx</td>
</tr>
</tbody></table>
<h2 id="BOM"><a href="#BOM" class="headerlink" title="BOM"></a>BOM</h2><p>BOM —— <code>Byte Order Mark</code>，中文名译作“字节顺序标记”。在这里找到一段关于 BOM 的说明：</p>
<p>在UCS 编码中有一个叫做 “Zero Width No-Break Space” ，中文译名作“零宽无间断间隔”的字符，它的编码是 FEFF。而 FFFE 在 UCS 中是不存在的字符，所以不应该出现在实际传输中。</p>
<p>UCS 规范建议我们在传输字节流前，先传输字符 “Zero Width No-Break Space”。这样如果接收者收到 FEFF，就表明这个字节流是 Big-Endian 的；如果收到FFFE，就表明这个字节流是 Little- Endian 的。因此字符 “Zero Width No-Break Space” （“零宽无间断间隔”）又被称作 BOM。</p>
<p>UTF-8 不需要 BOM 来表明字节顺序，但可以用 BOM 来表明编码方式。字符 “Zero Width No-Break Space” 的 UTF-8 编码是 <code>EF BB BF</code>。所以如果接收者收到以 <code>EF BB BF</code> 开头的字节流，就知道这是 UTF-8 编码了。Windows 就是使用 BOM 来标记文本文件的编码方式的。</p>
<h2 id="UTF-8"><a href="#UTF-8" class="headerlink" title="UTF-8"></a>UTF-8</h2><p>UTF-8的一个特别的好处是它与ISO-8859-1完全兼容。UTF是 <code>UCS Transformation Format</code> 的缩写。</p>
<p>UTF-8 就是在互联网上使用最广的一种 Unicode 的实现方式。UTF-8 是 Unicode 的实现方式之一。</p>
<p>UTF-8 最大的一个特点，就是它是一种变长的编码方式。它可以使用1~4个字节表示一个符号，根据不同的符号而变化字节长度。</p>
<p>UTF-8 的编码规则很简单，只有二条：</p>
<p>1）对于单字节的符号，字节的第一位设为0，后面7位为这个符号的 Unicode 码。因此对于英语字母，UTF-8 编码和 ASCII 码是相同的。</p>
<p>2）对于n字节的符号（n &gt; 1），第一个字节的前n位都设为1，第n + 1位设为0，后面字节的前两位一律设为10。剩下的没有提及的二进制位，全部为这个符号的 Unicode 码。</p>
<p>下表总结了编码规则，字母x表示可用编码的位。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191116141405.png" alt="QQ截图20191116141405.png"></p>
<p>下面，还是以汉字严为例，演示如何实现 UTF-8 编码。</p>
<p>严的 Unicode 是4E25（100111000100101），根据上表，可以发现4E25处在第三行的范围内（0000 0800 - 0000 FFFF），因此严的 UTF-8 编码需要三个字节，即格式是1110xxxx 10xxxxxx 10xxxxxx。然后，从严的最后一个二进制位开始，依次从后向前填入格式中的x，多出的位补0。这样就得到了，严的 UTF-8 编码是11100100 10111000 10100101，转换成十六进制就是E4B8A5。</p>
<h2 id="UCS-2、UCS-4、BMP"><a href="#UCS-2、UCS-4、BMP" class="headerlink" title="UCS-2、UCS-4、BMP"></a>UCS-2、UCS-4、BMP</h2><p>CS有两种格式：UCS-2和UCS-4。顾名思义，UCS-2就是用两个字节编码，UCS-4就是用4个字节（实际上只用了31位，最高位必须为0）编码。下面让我们做一些简单的数学游戏：</p>
<p>UCS-2有2^16=65536个码位，UCS-4有2^31=2147483648个码位。</p>
<p>UCS-4根据最高位为0的最高字节分成2^7=128个group。每个group再根据次高字节分为256个plane。每个plane根据第3个字节分为256行 (rows)，每行包含256个cells。当然同一行的cells只是最后一个字节不同，其余都相同。</p>
<p>group 0的plane 0被称作 <code>Basic Multilingual Plane</code>, 即BMP。或者说UCS-4中，高两个字节为0的码位被称作BMP。</p>
<p>将UCS-4的BMP去掉前面的两个零字节就得到了UCS-2。在UCS-2的两个字节前加上两个零字节，就得到了UCS-4的BMP。而目前的UCS-4规范中还没有任何字符被分配在BMP之外。</p>
<h2 id="Unicode-与-UTF-8-之间的转换"><a href="#Unicode-与-UTF-8-之间的转换" class="headerlink" title="Unicode 与 UTF-8 之间的转换"></a>Unicode 与 UTF-8 之间的转换</h2><p>Windows平台，有一个最简单的转化方法，就是使用内置的记事本小程序notepad.exe。打开文件后，点击文件菜单中的另存为命令，会跳出一个对话框，在最底部有一个编码的下拉条。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191116155852.png" alt="QQ截图20191116155852.png"></p>
<p>里面有四个选项：ANSI，Unicode，Unicode big endian和UTF-8。</p>
<p>1）ANSI是默认的编码方式。对于英文文件是ASCII编码，对于简体中文文件是GB2312编码（只针对 Windows 简体中文版，如果是繁体中文版会采用 Big5 码）。</p>
<p>2）Unicode编码这里指的是notepad.exe使用的 UCS-2 编码方式，即直接用两个字节存入字符的 Unicode 码，这个选项用的 little endian 格式。</p>
<p>3）Unicode big endian编码与上一个选项相对应。</p>
<p>4）UTF-8编码，也就是上一节谈到的编码方法。</p>
<p>选择完”编码方式”后，点击”保存”按钮，文件的编码方式就立刻转换好了。</p>
<h2 id="Little-endian-LE-和-Big-endian-BE"><a href="#Little-endian-LE-和-Big-endian-BE" class="headerlink" title="Little endian (LE) 和 Big endian (BE)"></a>Little endian (LE) 和 Big endian (BE)</h2><p>Unicode 规范定义，每一个文件的最前面分别加入一个表示编码顺序的字符，这个字符的名字叫做”零宽度非换行空格”（zero width no-break space），用FEFF表示。这正好是两个字节，而且FF比FE大1。</p>
<p>如果一个文本文件的头两个字节是<code>FE FF</code>，就表示该文件采用大头方式；如果头两个字节是<code>FF FE</code>，就表示该文件采用小头方式。</p>
<p>对照表：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191229134206.png" alt="QQ截图20191229134206.png"></p>
<p>示例：</p>
<p>用文本编辑软件UltraEdit 中的”十六进制功能”，观察该文件的内部编码方式。</p>
<p>1）ANSI：文件的编码就是两个字节<code>D1 CF</code>，这正是严的 <code>GB2312</code> 编码，这也暗示 <code>GB2312</code> 是采用大头方式存储的。</p>
<p>2）Unicode：编码是四个字节<code>FF FE 25 4E</code>，其中<code>FF FE</code>表明是小头方式存储，真正的编码是<code>4E 25</code>。</p>
<p>3）Unicode big endian：编码是四个字节<code>FE FF 4E 25</code>，其中<code>FE FF</code>表明是大头方式存储。</p>
<p>4）UTF-8：编码是六个字节<code>EF BB BF E4 B8 A5</code>，前三个字节<code>EF BB BF</code>表示这是UTF-8编码，后三个<code>E4 B8 A5</code>就是严的具体编码，它的存储顺序与编码顺序是一致的。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html">字符编码笔记：ASCII，Unicode 和 UTF-8</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6bdc0d52620a">彻底弄懂 Unicode 编码</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/malecrab/p/5300503.html">细说：Unicode, UTF-8, UTF-16, UTF-32, UCS-2, UCS-4</a></p>
<p><a target="_blank" rel="noopener" href="http://www.fmddlmyy.cn/text6.html">谈谈Unicode编码，简要解释UCS、UTF、BMP、BOM等名词</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/11/16/bit(%E6%AF%94%E7%89%B9)%20%E5%92%8C%20Byte(%E5%AD%97%E8%8A%82)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/16/bit(%E6%AF%94%E7%89%B9)%20%E5%92%8C%20Byte(%E5%AD%97%E8%8A%82)/" class="post-title-link" itemprop="url">bit(比特) 和 Byte(字节)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-16 10:57:11" itemprop="dateCreated datePublished" datetime="2019-11-16T10:57:11+00:00">2019-11-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-07 08:51:18" itemprop="dateModified" datetime="2022-09-07T08:51:18+00:00">2022-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">计算机基础</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>384</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="bit（比特）"><a href="#bit（比特）" class="headerlink" title="bit（比特）"></a>bit（比特）</h2><p>bit 是信息量的单位，是表示信息的最小单位，只有两种状态：0和1。二进制的一位，就叫做 1 bit。<br>它的简写为小写字母 “b”。</p>
<h2 id="Byte-字节"><a href="#Byte-字节" class="headerlink" title="Byte (字节)"></a>Byte (字节)</h2><p>表示一个 8 位无符号整数。</p>
<p>即，8 bit（比特位）= 1 Byte（字节）；</p>
<h2 id="bit（比特）与-Byte-字节-的关系"><a href="#bit（比特）与-Byte-字节-的关系" class="headerlink" title="bit（比特）与 Byte (字节) 的关系"></a>bit（比特）与 Byte (字节) 的关系</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>MB = <span class="number">1024</span>KB = <span class="number">1024</span> * <span class="number">1024B</span> = <span class="number">1048576B</span>；</span><br><span class="line"><span class="number">1024B</span>yte = <span class="number">1</span>KB；</span><br><span class="line"><span class="number">1024</span>KB = <span class="number">1</span>MB;</span><br><span class="line"><span class="number">1024</span>MB = <span class="number">1</span>GB;</span><br><span class="line"><span class="number">1024</span>GB = <span class="number">1</span>TB;</span><br></pre></td></tr></table></figure>

<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191116112021.png" alt="QQ截图20191116112021.png"></p>
<p>例如：</p>
<p>根据 一字节 等于 8 比特的 换算方法，就可以得出以下结论。</p>
<p>下载速度从理论上来说，应该是 带宽的 八分之一。</p>
<p>2M 宽带理论下载速度是 256 KB</p>
<p>10M 宽带理论下载速度是 1280 KB</p>
<p>总结：</p>
<p>存储单位和网速的单位，不管是 B 还是 b，代表的都是 字节 Byte。<br>带宽的单位，不管是 B 还是 b，代表的都是 比特 bit 。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/46040087">bit ( 比特 )和 Byte（字节）的关系？</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.byte?view=netframework-4.8">Byte 结构</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/11/15/CSharp%E4%BD%8D%E8%BF%90%E7%AE%97%E4%B8%8E%E7%A7%BB%E4%BD%8D%E8%BF%90%E7%AE%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/15/CSharp%E4%BD%8D%E8%BF%90%E7%AE%97%E4%B8%8E%E7%A7%BB%E4%BD%8D%E8%BF%90%E7%AE%97/" class="post-title-link" itemprop="url">CSharp位运算与移位运算</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-15 15:54:17" itemprop="dateCreated datePublished" datetime="2019-11-15T15:54:17+00:00">2019-11-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-07 08:51:18" itemprop="dateModified" datetime="2022-09-07T08:51:18+00:00">2022-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSharp%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">CSharp基础</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>移位运算符仅针对 int、uint、long 和 ulong 类型定义，因此运算的结果始终包含至少 32 位。 如果左侧操作数是其他整数类型（sbyte、byte、short、ushort 或 char），则其值将转换为 int 类型。</p>
<h2 id="左移位运算符-lt-lt"><a href="#左移位运算符-lt-lt" class="headerlink" title="左移位运算符 &lt;&lt;"></a>左移位运算符 &lt;&lt;</h2><p><code>&lt;&lt;</code> 运算符将其左侧操作数向左移动右侧操作数定义的位数。<br>左移运算会放弃超出结果类型范围的高阶位，并将低阶空位位置设置为零</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">uint</span> x = <span class="number">0b</span>_1100_1001_0000_0000_0000_0000_0001_0001;</span><br><span class="line">Console.WriteLine(<span class="string">$&quot;Before: <span class="subst">&#123;Convert.ToString(x, toBase: <span class="number">2</span>)&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">uint</span> y = x &lt;&lt; <span class="number">4</span>;</span><br><span class="line">Console.WriteLine(<span class="string">$&quot;After:  <span class="subst">&#123;Convert.ToString(y, toBase: <span class="number">2</span>)&#125;</span>&quot;</span>);</span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// Before: 11001001000000000000000000010001</span></span><br><span class="line"><span class="comment">// After:  10010000000000000000000100010000</span></span><br></pre></td></tr></table></figure>

<p>总结：左移相当于 X * 2的N次方 (乘以 2 的N次方)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x&lt;&lt;<span class="number">1</span>= x*<span class="number">2</span></span><br><span class="line">x&lt;&lt;<span class="number">2</span>= x*<span class="number">4</span></span><br><span class="line">x&lt;&lt;<span class="number">3</span>= x*<span class="number">8</span></span><br><span class="line">x&lt;&lt;<span class="number">4</span>= x*<span class="number">16</span></span><br></pre></td></tr></table></figure>

<h2 id="右移位运算符-gt-gt"><a href="#右移位运算符-gt-gt" class="headerlink" title="右移位运算符 &gt;&gt;"></a>右移位运算符 &gt;&gt;</h2><p><code>&gt;&gt;</code> 运算符将其左侧操作数向右移动右侧操作数定义的位数。<br>右移位运算会放弃低阶位。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">uint</span> x = <span class="number">0b</span>_1001;</span><br><span class="line">Console.WriteLine(<span class="string">$&quot;Before: <span class="subst">&#123;Convert.ToString(x, toBase: <span class="number">2</span>), <span class="number">4</span>&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">uint</span> y = x &gt;&gt; <span class="number">2</span>;</span><br><span class="line">Console.WriteLine(<span class="string">$&quot;After:  <span class="subst">&#123;Convert.ToString(y, toBase: <span class="number">2</span>), <span class="number">4</span>&#125;</span>&quot;</span>);</span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// Before: 1001</span></span><br><span class="line"><span class="comment">// After:    10</span></span><br></pre></td></tr></table></figure>

<p>总结：左移相当于 X / 2的N次方 (除以 2 的N次方)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x&gt;&gt;<span class="number">1</span>= x/<span class="number">2</span></span><br><span class="line">x&gt;&gt;<span class="number">2</span>= x/<span class="number">4</span></span><br><span class="line">x&gt;&gt;<span class="number">3</span>= x/<span class="number">8</span></span><br><span class="line">x&gt;&gt;<span class="number">4</span>=x/<span class="number">16</span></span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/operators/bitwise-and-shift-operators#left-shift-operator-">位运算符和移位运算符（C# 参考）</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kakimsun/archive/2010/04/27/1722403.html">C#移位运算(左移和右移)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/11/13/dot%20net%E6%95%B0%E5%AD%97%E6%A0%BC%E5%BC%8F%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/13/dot%20net%E6%95%B0%E5%AD%97%E6%A0%BC%E5%BC%8F%E5%8C%96/" class="post-title-link" itemprop="url">dot net数字格式化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-13 16:06:35" itemprop="dateCreated datePublished" datetime="2019-11-13T16:06:35+00:00">2019-11-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-07 08:51:18" itemprop="dateModified" datetime="2022-09-07T08:51:18+00:00">2022-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSharp%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">CSharp基础</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>标准数字格式字符串用于格式化通用数值类型。 标准数字格式字符串采用 Axx 的形式。</p>
<p>A 是称为“格式说明符” 的单个字母字符。</p>
<p>xx 是称为“精度说明符” 的可选整数。 精度说明符的范围从 0 到 99，并且影响结果中的位数。</p>
<h2 id="常用格式"><a href="#常用格式" class="headerlink" title="常用格式"></a>常用格式</h2><h3 id="十进制（“D”）格式说明符"><a href="#十进制（“D”）格式说明符" class="headerlink" title="十进制（“D”）格式说明符"></a>十进制（“D”）格式说明符</h3><p>“D”或“d” ：表示10进制；</p>
<p>示例：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> <span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">value</span> = <span class="number">12345</span>;</span><br><span class="line">Console.WriteLine(<span class="keyword">value</span>.ToString(<span class="string">&quot;D&quot;</span>));</span><br><span class="line"><span class="comment">// Displays 12345</span></span><br><span class="line">Console.WriteLine(<span class="keyword">value</span>.ToString(<span class="string">&quot;D8&quot;</span>));</span><br><span class="line"><span class="comment">// Displays 00012345</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">value</span> = <span class="number">-12345</span>;</span><br><span class="line">Console.WriteLine(<span class="keyword">value</span>.ToString(<span class="string">&quot;D&quot;</span>));</span><br><span class="line"><span class="comment">// Displays -12345</span></span><br><span class="line">Console.WriteLine(<span class="keyword">value</span>.ToString(<span class="string">&quot;D8&quot;</span>));</span><br><span class="line"><span class="comment">// Displays -00012345</span></span><br></pre></td></tr></table></figure>

<h3 id="定点（“F”）格式说明符"><a href="#定点（“F”）格式说明符" class="headerlink" title="定点（“F”）格式说明符"></a>定点（“F”）格式说明符</h3><p>定点（“F”）格式说明符将数字转换为“-ddd.ddd…”形式的字符串，其中每个“d”表示一个数字 (0-9)。 如果该数字为负，则该字符串以减号开头。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> integerNumber;</span><br><span class="line">integerNumber = <span class="number">17843</span>;</span><br><span class="line">Console.WriteLine(integerNumber.ToString(<span class="string">&quot;F&quot;</span>, </span><br><span class="line">                  CultureInfo.InvariantCulture));</span><br><span class="line"><span class="comment">// Displays 17843.00</span></span><br><span class="line"></span><br><span class="line">integerNumber = <span class="number">-29541</span>;</span><br><span class="line">Console.WriteLine(integerNumber.ToString(<span class="string">&quot;F3&quot;</span>, </span><br><span class="line">                  CultureInfo.InvariantCulture));</span><br><span class="line"><span class="comment">// Displays -29541.000</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">double</span> doubleNumber;</span><br><span class="line">doubleNumber = <span class="number">18934.1879</span>;</span><br><span class="line">Console.WriteLine(doubleNumber.ToString(<span class="string">&quot;F&quot;</span>, CultureInfo.InvariantCulture));</span><br><span class="line"><span class="comment">// Displays 18934.19</span></span><br><span class="line"></span><br><span class="line">Console.WriteLine(doubleNumber.ToString(<span class="string">&quot;F0&quot;</span>, CultureInfo.InvariantCulture));</span><br><span class="line"><span class="comment">// Displays 18934</span></span><br><span class="line"></span><br><span class="line">doubleNumber = <span class="number">-1898300.1987</span>;</span><br><span class="line">Console.WriteLine(doubleNumber.ToString(<span class="string">&quot;F1&quot;</span>, CultureInfo.InvariantCulture));  </span><br><span class="line"><span class="comment">// Displays -1898300.2</span></span><br><span class="line"></span><br><span class="line">Console.WriteLine(doubleNumber.ToString(<span class="string">&quot;F3&quot;</span>, </span><br><span class="line">                  CultureInfo.CreateSpecificCulture(<span class="string">&quot;es-ES&quot;</span>)));</span><br><span class="line"><span class="comment">// Displays -1898300,199</span></span><br></pre></td></tr></table></figure>

<h3 id="百分比（“P”）格式说明符"><a href="#百分比（“P”）格式说明符" class="headerlink" title="百分比（“P”）格式说明符"></a>百分比（“P”）格式说明符</h3><p>百分比（“P”）格式说明符将数字乘以 100 并将其转换为表示百分比的字符串。</p>
<p>“P”或“p”</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">double</span> number = <span class="number">.2468013</span>;</span><br><span class="line">Console.WriteLine(number.ToString(<span class="string">&quot;P&quot;</span>, CultureInfo.InvariantCulture));</span><br><span class="line"><span class="comment">// Displays 24.68 %</span></span><br><span class="line">Console.WriteLine(number.ToString(<span class="string">&quot;P&quot;</span>, </span><br><span class="line">                  CultureInfo.CreateSpecificCulture(<span class="string">&quot;hr-HR&quot;</span>)));</span><br><span class="line"><span class="comment">// Displays 24,68%</span></span><br><span class="line">Console.WriteLine(number.ToString(<span class="string">&quot;P1&quot;</span>, CultureInfo.InvariantCulture));</span><br><span class="line"><span class="comment">// Displays 24.7 %</span></span><br></pre></td></tr></table></figure>

<h3 id="数字（“N”）格式说明符"><a href="#数字（“N”）格式说明符" class="headerlink" title="数字（“N”）格式说明符"></a>数字（“N”）格式说明符</h3><p>数字（”N”）格式说明符将数字转换为”-d,ddd,ddd.ddd…”形式的字符串</p>
<p>“N”或“n”</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">double</span> dblValue = <span class="number">-12445.6789</span>;</span><br><span class="line">Console.WriteLine(dblValue.ToString(<span class="string">&quot;N&quot;</span>, CultureInfo.InvariantCulture));</span><br><span class="line"><span class="comment">// Displays -12,445.68</span></span><br><span class="line">Console.WriteLine(dblValue.ToString(<span class="string">&quot;N1&quot;</span>, </span><br><span class="line">                  CultureInfo.CreateSpecificCulture(<span class="string">&quot;sv-SE&quot;</span>)));</span><br><span class="line"><span class="comment">// Displays -12 445,7</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> intValue = <span class="number">123456789</span>;</span><br><span class="line">Console.WriteLine(intValue.ToString(<span class="string">&quot;N1&quot;</span>, CultureInfo.InvariantCulture));</span><br><span class="line"><span class="comment">// Displays 123,456,789.0 </span></span><br></pre></td></tr></table></figure>

<h3 id="十六进制（“X”）格式说明符"><a href="#十六进制（“X”）格式说明符" class="headerlink" title="十六进制（“X”）格式说明符"></a>十六进制（“X”）格式说明符</h3><p>十六进制（“X”）格式说明符将数字转换为十六进制数的字符串。</p>
<p>“X”或“x”</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> <span class="keyword">value</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">value</span> = <span class="number">0x2045e</span>;</span><br><span class="line">Console.WriteLine(<span class="keyword">value</span>.ToString(<span class="string">&quot;x&quot;</span>));</span><br><span class="line"><span class="comment">// Displays 2045e</span></span><br><span class="line">Console.WriteLine(<span class="keyword">value</span>.ToString(<span class="string">&quot;X&quot;</span>));</span><br><span class="line"><span class="comment">// Displays 2045E</span></span><br><span class="line">Console.WriteLine(<span class="keyword">value</span>.ToString(<span class="string">&quot;X8&quot;</span>));</span><br><span class="line"><span class="comment">// Displays 0002045E</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">value</span> = <span class="number">123456789</span>;</span><br><span class="line">Console.WriteLine(<span class="keyword">value</span>.ToString(<span class="string">&quot;X&quot;</span>));</span><br><span class="line"><span class="comment">// Displays 75BCD15</span></span><br><span class="line">Console.WriteLine(<span class="keyword">value</span>.ToString(<span class="string">&quot;X2&quot;</span>));</span><br><span class="line"><span class="comment">// Displays 75BCD15</span></span><br></pre></td></tr></table></figure>

<p>十六进制的表示:<br>C语言、Shell、Python语言及其他相近的语言使用字首“0x”，例如“0x5A3”。开头的“0”令解析器更易辨认数，而“x”则代表十六进制。在“0x”中的“x”可以大写或小写。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/standard/base-types/formatting-types?view=netframework-4.8">.NET 中的格式类型</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/standard/base-types/standard-numeric-format-strings?view=netframework-4.8#using-standard-numeric-format-strings">标准数字格式字符串</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/standard/base-types/composite-formatting">复合格式设置</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/standard/base-types/custom-numeric-format-strings?view=netframework-4.8">自定义数字格式字符串</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/10/17/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8826%EF%BC%89-%20Authorization%20%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/17/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8826%EF%BC%89-%20Authorization%20%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">ABP框架学习记录（26）- Authorization 解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-17 15:22:11" itemprop="dateCreated datePublished" datetime="2019-10-17T15:22:11+00:00">2019-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-07 08:51:18" itemprop="dateModified" datetime="2022-09-07T08:51:18+00:00">2022-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ABP/" itemprop="url" rel="index"><span itemprop="name">ABP</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ABP框架学习记录（26）-Authorization-解析"><a href="#ABP框架学习记录（26）-Authorization-解析" class="headerlink" title="ABP框架学习记录（26）- Authorization 解析"></a>ABP框架学习记录（26）- Authorization 解析</h1><p>本文 以 <code>Volo.Abp</code> 解决方案展开研究；</p>
<p>在 <code>Volo.Abp</code> 解决方案中，提供了单独的项目 实现 <code>Authorization</code> 功能，如下图:</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191017152520.png" alt="QQ截图20191017152520.png"></p>
<p><code>Authorization</code>：中文解释，授权。ABP 中检查是否对 <code>用户或者角色</code> 授予权限。整个功能可以分为两个方面理解：<br>1，许可定义；<br>2，检查许可；</p>
<h2 id="Permission"><a href="#Permission" class="headerlink" title="Permission"></a>Permission</h2><p><code>Permission</code> 的中文解释为：许可，允许。</p>
<p>首先介绍 <code>Permission</code> 相关的类定义：</p>
<p><code>PermissionDefinition</code>：许可定义，包括父级权限和子级列表。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021114332.png" alt="QQ截图20191021114332.png"></p>
<p><code>PermissionGroupDefinition</code>：定义许可组；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021131218.png" alt="QQ截图20191021131218.png"></p>
<p><code>PermissionGrantResult</code>：授权结果；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021131648.png" alt="QQ截图20191021131648.png"></p>
<p><code>IPermissionChecker</code>：检查授权，提供 <code>IsGrantedAsync</code> 方法检查是否有权限。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021104232.png" alt="QQ截图20191021104232.png"></p>
<p><code>PermissionChecker</code>：实现 <code>IPermissionChecker</code> 接口；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021131755.png" alt="QQ截图20191021131755.png"></p>
<p><code>IPermissionDefinitionContext</code>：许可定义上下文，封装了 <code>PermissionGroupDefinition</code> 对象，并且提供了添加，移除的方法；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021132317.png" alt="QQ截图20191021132317.png"></p>
<p><code>PermissionDefinitionContext</code>：实现 <code>IPermissionDefinitionContext</code> 接口；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021132414.png" alt="QQ截图20191021132414.png"></p>
<p><code>IPermissionDefinitionManager</code>：管理 <code>PermissionDefinition</code>;</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021135949.png" alt="QQ截图20191021135949.png"></p>
<p><code>PermissionDefinitionManager</code>：默认实现 <code>IPermissionDefinitionManager</code> 接口。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021140150.png" alt="QQ截图20191021140150.png"></p>
<p><code>IPermissionDefinitionProvider</code>：定义 <code>PermissionDefinition</code> 提供者接口；对 <code>Define</code> 方法传入的 <code>IPermissionDefinitionContext</code> 对象进行操作；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021140648.png" alt="QQ截图20191021140648.png"></p>
<p><code>PermissionDefinitionProvider</code>：实现 <code>IPermissionDefinitionProvider</code> 接口；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021140742.png" alt="QQ截图20191021140742.png"></p>
<p><code>IPermissionStore</code>：定义许可 存储接口；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021141034.png" alt="QQ截图20191021141034.png"></p>
<p><code>NullPermissionStore</code> ：<code>IPermissionStore</code> 接口的空实现。</p>
<p><code>IPermissionValueProvider</code>：定义获取 <code>PermissionValue</code> 的接口；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021151209.png" alt="QQ截图20191021151209.png"></p>
<p><code>PermissionValueProvider</code>：实现 <code>IPermissionValueProvider</code> 接口；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021171013.png" alt="QQ截图20191021171013.png"></p>
<p><code>RolePermissionValueProvider</code>：提供角色相关许可；</p>
<p><code>UserPermissionValueProvider</code>：提供用户相关许可；</p>
<p><code>ClientPermissionValueProvider</code>：提供客户端相关许可；</p>
<p><code>IPermissionValueProviderManager</code>：定义管理 <code>IPermissionValueProvider</code> 的接口；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021171140.png" alt="QQ截图20191021171140.png"></p>
<p><code>PermissionValueProviderManager</code>：实现 <code>IPermissionValueProviderManager</code> 接口；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021171437.png" alt="QQ截图20191021171437.png"></p>
<p><code>PermissionOptions</code>：许可选项；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021141758.png" alt="QQ截图20191021141758.png"></p>
<p><code>PermissionValueCheckContext</code>：检查 <code>PermissionValue</code> 的上下文；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021171820.png" alt="QQ截图20191021171820.png"></p>
<h2 id="AbpAuthorizationModule"><a href="#AbpAuthorizationModule" class="headerlink" title="AbpAuthorizationModule"></a>AbpAuthorizationModule</h2><p>这一部分主要分析 <code>AbpAuthorizationModule</code> 的实现。</p>
<p>在 <code>Volo.Abp</code> 解决方案中，其 <code>Module</code> 系统集成 Core 自带的 <code>IServiceCollection</code> ，通过自定义的 <code>ServiceConfigurationContext</code> 类，封装了 <code>IServiceCollection</code> 对象：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021175125.png" alt="QQ截图20191021175125.png"></p>
<p><code>AbpAuthorizationModule</code>：定义<code>Module</code>，<code>OnRegistred</code> 扩展方法 添加 拦截器注册者；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021174716.png" alt="QQ截图20191021174716.png"></p>
<h3 id="PreConfigureServices"><a href="#PreConfigureServices" class="headerlink" title="PreConfigureServices"></a>PreConfigureServices</h3><p><code>AuthorizationInterceptorRegistrar</code>：拦截器注册类；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021175737.png" alt="QQ截图20191021175737.png"></p>
<p><code>AuthorizationInterceptor</code>：定义拦截器；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021175839.png" alt="QQ截图20191021175839.png"></p>
<p><code>MethodInvocationAuthorizationContext</code>：定义方法调用 许可上下文，校验方法是否被允许；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021180118.png" alt="QQ截图20191021180118.png"></p>
<p><code>IMethodInvocationAuthorizationService</code>：定义校验方法许可的接口；</p>
<p><code>MethodInvocationAuthorizationService</code>：实现 <code>IMethodInvocationAuthorizationService</code> 接口；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021180541.png" alt="QQ截图20191021180541.png"></p>
<h3 id="ConfigureServices"><a href="#ConfigureServices" class="headerlink" title="ConfigureServices"></a>ConfigureServices</h3><p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021180851.png" alt="QQ截图20191021180851.png"></p>
<p><code>PermissionRequirement</code>：许可参数；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021181401.png" alt="QQ截图20191021181401.png"></p>
<p><code>PermissionRequirementHandler</code>：定义 回调 <code>Handler</code>；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021181600.png" alt="QQ截图20191021181600.png"></p>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><p><code>IAbpAuthorizationService</code>：定义 <code>Abp</code> 授权服务接口；继承 Dot Net Core自带 <code>IAuthorizationService</code> 接口；</p>
<p><code>AbpAuthorizationService</code>：实现  <code>IAuthorizationService</code> 接口;</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021182258.png" alt="QQ截图20191021182258.png"></p>
<p><code>IAbpAuthorizationPolicyProvider</code>：定义 授权 策略 提供者接口；继承 Dot Net Core 自带 <code>IAuthorizationPolicyProvider</code> 接口；</p>
<p><code>AbpAuthorizationPolicyProvider</code>：实现 <code>IAbpAuthorizationPolicyProvider</code> 接口；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191021182527.png" alt="QQ截图20191021182527.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/10/17/Identity%E7%AC%94%E8%AE%B0%E4%B9%8B%20-%20Claim/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/17/Identity%E7%AC%94%E8%AE%B0%E4%B9%8B%20-%20Claim/" class="post-title-link" itemprop="url">Identity笔记之 - Claim</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-17 14:45:07" itemprop="dateCreated datePublished" datetime="2019-10-17T14:45:07+00:00">2019-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-07 08:51:18" itemprop="dateModified" datetime="2022-09-07T08:51:18+00:00">2022-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83/" itemprop="url" rel="index"><span itemprop="name">认证与授权</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>259</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Identity笔记之-Claim"><a href="#Identity笔记之-Claim" class="headerlink" title="Identity笔记之 - Claim"></a>Identity笔记之 - Claim</h1><p>本文介绍 <code>Claim</code> 相关概念，具体类在 <code>System.Security.Claims</code> 命名空间下。</p>
<h2 id="Claim"><a href="#Claim" class="headerlink" title="Claim"></a>Claim</h2><p><code>Claim</code>：要求；主张；声称; 宣称; 自称; 认领</p>
<p>在 <code>Identity</code> 可以理解成 <code>证件单元</code>，以键值对表示：</p>
<p>例如：<code>姓名：特斯拉</code></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191017150008.png" alt="QQ截图20191017150008.png"></p>
<h2 id="ClaimsIdentity"><a href="#ClaimsIdentity" class="headerlink" title="ClaimsIdentity"></a>ClaimsIdentity</h2><p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191017150602.png" alt="QQ截图20191017150602.png"></p>
<p>在 <code>Identity</code> 可以理解成 <code>身份证件</code>，即包括一系列 <code>Claim</code> 的集合；</p>
<h2 id="ClaimsPrincipal"><a href="#ClaimsPrincipal" class="headerlink" title="ClaimsPrincipal"></a>ClaimsPrincipal</h2><p><code>Principal</code>：主体，委托人</p>
<p><code>ClaimsPrincipal</code> 可以理解成 <code>证件当事人</code>;</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191017151234.png" alt="QQ截图20191017151234.png"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/savorboard/p/aspnetcore-identity.html">ASP.NET Core 之 Identity 入门（一）</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/10/14/CSharp-%E9%A2%84%E5%A4%84%E7%90%86%E5%99%A8%E6%8C%87%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/14/CSharp-%E9%A2%84%E5%A4%84%E7%90%86%E5%99%A8%E6%8C%87%E4%BB%A4/" class="post-title-link" itemprop="url">CSharp-预处理器指令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-14 13:06:11" itemprop="dateCreated datePublished" datetime="2019-10-14T13:06:11+00:00">2019-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-07 08:51:18" itemprop="dateModified" datetime="2022-09-07T08:51:18+00:00">2022-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSharp%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">CSharp基础</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>829</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CSharp-预处理器指令"><a href="#CSharp-预处理器指令" class="headerlink" title="CSharp-预处理器指令"></a>CSharp-预处理器指令</h1><h2 id="预处理器指令"><a href="#预处理器指令" class="headerlink" title="预处理器指令"></a>预处理器指令</h2><p>预处理器指令（preprocessor directive）：用于在 C# 源代码中嵌入的编译器命令，告诉C#编译器要编译哪些代码，并指出如何处理特定的错误和警告。C#预处理器指令还可以告诉C#编辑器有关代码组织的信息。</p>
<p>选中 项目 ，右键 属性，在 <code>生成</code> 标签：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20191014141323.png" alt="QQ截图20191014141323.png"></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;DEBUG&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TRACE</span></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;TRACE&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>具体预处理器指令参考：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">warning</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">error</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">line</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">region</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">checksum</span></span></span><br></pre></td></tr></table></figure>

<h2 id="ConditionalAttribute"><a href="#ConditionalAttribute" class="headerlink" title="ConditionalAttribute"></a>ConditionalAttribute</h2><p>指示编译器，除非定义了指定的有条件编译符号，否则，应忽略方法调用或属性。</p>
<p>注意：</p>
<p>#if DEBUG：此处的代码在发布时甚至不会到达IL。</p>
<p>[Conditional(“DEBUG”)]：这个代码将到达IL，但是当设置为DEBUG时，才会被调用。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Conditional(<span class="string">&quot;DEBUG&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoSomething</span>()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Foo</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    DoSomething(); <span class="comment">//Code compiles and is cleaner, DoSomething always</span></span><br><span class="line">                   <span class="comment">//exists, however this is only called during DEBUG.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/preprocessor-directives/">C# 预处理器指令</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/debug-trace-profile/how-to-compile-conditionally-with-trace-and-debug">如何：使用跟踪和调试执行有条件编译</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/debug-trace-profile/how-to-create-initialize-and-configure-trace-switches">如何：创建、初始化和配置跟踪开关</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/compiler-options/define-compiler-option">-define（C# 编译器选项）</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/visualstudio/ide/managing-project-and-solution-properties?view=vs-2019">管理项目和解决方案属性</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3788605/if-debug-vs-conditionaldebug">#if DEBUG vs. Conditional(“DEBUG”)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/09/27/ThreadLocal%E5%92%8CAsyncLocal%E7%94%A8%E6%B3%95%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/27/ThreadLocal%E5%92%8CAsyncLocal%E7%94%A8%E6%B3%95%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">ThreadLocal和AsyncLocal用法记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-27 15:38:41" itemprop="dateCreated datePublished" datetime="2019-09-27T15:38:41+00:00">2019-09-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-07 08:51:18" itemprop="dateModified" datetime="2022-09-07T08:51:18+00:00">2022-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/net%E5%BC%82%E6%AD%A5%E4%B8%8E%E5%B9%B6%E8%A1%8C/" itemprop="url" rel="index"><span itemprop="name">.net异步与并行</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="AsyncLocal"><a href="#AsyncLocal" class="headerlink" title="AsyncLocal"></a>AsyncLocal</h2><p>表示对于给定异步控制流（如异步方法）是本地数据的环境数据。</p>
<p>注意：<font color=#ff0000 size=4 face="黑体">await外的AsyncLocal值可以传递到await内, await内的AsyncLocal值无法传递到await外(只能读取不能修改)。</font></p>
<p>例子：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp7</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> task = Task.Run(<span class="keyword">async</span> () =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                v.Value = <span class="number">123</span>;</span><br><span class="line">                <span class="keyword">await</span> Intercept.Invoke(); <span class="comment">// value = 888</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 恢复备份的上下文</span></span><br><span class="line">                Console.WriteLine(Program.v.Value); <span class="comment">// 输出 123</span></span><br><span class="line">            &#125;);</span><br><span class="line">            task.Wait();</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">static</span> AsyncLocal&lt;<span class="built_in">int</span>&gt; v = <span class="keyword">new</span> AsyncLocal&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Intercept</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Invoke</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> Task.FromResult(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            Program.v.Value = <span class="number">888</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>msdn例子：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Example</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> AsyncLocal&lt;<span class="built_in">string</span>&gt; _asyncLocalString = <span class="keyword">new</span> AsyncLocal&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> ThreadLocal&lt;<span class="built_in">string</span>&gt; _threadLocalString = <span class="keyword">new</span> ThreadLocal&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">AsyncMethodA</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Start multiple async method calls, with different AsyncLocal values.</span></span><br><span class="line">        <span class="comment">// We also set ThreadLocal values, to demonstrate how the two mechanisms differ.</span></span><br><span class="line">        _asyncLocalString.Value = <span class="string">&quot;Value 1&quot;</span>;</span><br><span class="line">        _threadLocalString.Value = <span class="string">&quot;Value 1&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> t1 = AsyncMethodB(<span class="string">&quot;Value 1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        _asyncLocalString.Value = <span class="string">&quot;Value 2&quot;</span>;</span><br><span class="line">        _threadLocalString.Value = <span class="string">&quot;Value 2&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> t2 = AsyncMethodB(<span class="string">&quot;Value 2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Await both calls</span></span><br><span class="line">        <span class="keyword">await</span> t1;</span><br><span class="line">        <span class="keyword">await</span> t2;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">AsyncMethodB</span>(<span class="params"><span class="built_in">string</span> expectedValue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Entering AsyncMethodB.&quot;</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;   Expected &#x27;&#123;0&#125;&#x27;, AsyncLocal value is &#x27;&#123;1&#125;&#x27;, ThreadLocal value is &#x27;&#123;2&#125;&#x27;&quot;</span>, </span><br><span class="line">                          expectedValue, _asyncLocalString.Value, _threadLocalString.Value);</span><br><span class="line">        <span class="keyword">await</span> Task.Delay(<span class="number">100</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Exiting AsyncMethodB.&quot;</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;   Expected &#x27;&#123;0&#125;&#x27;, got &#x27;&#123;1&#125;&#x27;, ThreadLocal value is &#x27;&#123;2&#125;&#x27;&quot;</span>, </span><br><span class="line">                          expectedValue, _asyncLocalString.Value, _threadLocalString.Value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> AsyncMethodA();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// The example displays the following output:</span></span><br><span class="line"><span class="comment">//   Entering AsyncMethodB.</span></span><br><span class="line"><span class="comment">//      Expected &#x27;Value 1&#x27;, AsyncLocal value is &#x27;Value 1&#x27;, ThreadLocal value is &#x27;Value 1&#x27;</span></span><br><span class="line"><span class="comment">//   Entering AsyncMethodB.</span></span><br><span class="line"><span class="comment">//      Expected &#x27;Value 2&#x27;, AsyncLocal value is &#x27;Value 2&#x27;, ThreadLocal value is &#x27;Value 2&#x27;</span></span><br><span class="line"><span class="comment">//   Exiting AsyncMethodB.</span></span><br><span class="line"><span class="comment">//      Expected &#x27;Value 2&#x27;, got &#x27;Value 2&#x27;, ThreadLocal value is &#x27;&#x27;</span></span><br><span class="line"><span class="comment">//   Exiting AsyncMethodB.</span></span><br><span class="line"><span class="comment">//      Expected &#x27;Value 1&#x27;, got &#x27;Value 1&#x27;, ThreadLocal value is &#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h2><p>提供数据的线程本地存储。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">ThreadLocalDemo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Demonstrates:</span></span><br><span class="line">    <span class="comment">//      ThreadLocal(T) constructor</span></span><br><span class="line">    <span class="comment">//      ThreadLocal(T).Value</span></span><br><span class="line">    <span class="comment">//      One usage of ThreadLocal(T)</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Thread-Local variable that yields a name for a thread</span></span><br><span class="line">        ThreadLocal&lt;<span class="built_in">string</span>&gt; ThreadName = <span class="keyword">new</span> ThreadLocal&lt;<span class="built_in">string</span>&gt;(() =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Thread&quot;</span> + Thread.CurrentThread.ManagedThreadId;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Action that prints out ThreadName for the current thread</span></span><br><span class="line">        Action action = () =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// If ThreadName.IsValueCreated is true, it means that we are not the</span></span><br><span class="line">            <span class="comment">// first action to run on this thread.</span></span><br><span class="line">            <span class="built_in">bool</span> repeat = ThreadName.IsValueCreated;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;ThreadName = &#123;0&#125; &#123;1&#125;&quot;</span>, ThreadName.Value, repeat ? <span class="string">&quot;(repeat)&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Launch eight of them.  On 4 cores or less, you should see some repeat ThreadNames</span></span><br><span class="line">        Parallel.Invoke(action, action, action, action, action, action, action, action);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Dispose when you are done</span></span><br><span class="line">        ThreadName.Dispose();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// This multithreading example can produce different outputs for each &#x27;action&#x27; invocation and will vary with each run.</span></span><br><span class="line"><span class="comment">// Therefore, the example output will resemble but may not exactly match the following output (from a 4 core processor):</span></span><br><span class="line"><span class="comment">// ThreadName = Thread5 </span></span><br><span class="line"><span class="comment">// ThreadName = Thread6 </span></span><br><span class="line"><span class="comment">// ThreadName = Thread4 </span></span><br><span class="line"><span class="comment">// ThreadName = Thread6 (repeat)</span></span><br><span class="line"><span class="comment">// ThreadName = Thread1 </span></span><br><span class="line"><span class="comment">// ThreadName = Thread4 (repeat)</span></span><br><span class="line"><span class="comment">// ThreadName = Thread7 </span></span><br><span class="line"><span class="comment">// ThreadName = Thread5 (repeat)</span></span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.threading.asynclocal-1?view=netframework-4.8">AsyncLocal<T></a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.threading.threadlocal-1?view=netframework-4.8">ThreadLocal<T></a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zkweb/p/7747162.html">AsyncLocal的运作机制和陷阱</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/37306203/how-to-make-asynclocal-flow-to-siblings">How to make AsyncLocal flow to siblings?</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/09/25/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8825%EF%BC%89-%20MultiTenancy%20%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/25/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8825%EF%BC%89-%20MultiTenancy%20%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">ABP框架学习记录（25）- MultiTenancy 解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-25 13:48:54" itemprop="dateCreated datePublished" datetime="2019-09-25T13:48:54+00:00">2019-09-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-07 08:51:18" itemprop="dateModified" datetime="2022-09-07T08:51:18+00:00">2022-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ABP/" itemprop="url" rel="index"><span itemprop="name">ABP</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ABP框架学习记录（25）-MultiTenancy-解析"><a href="#ABP框架学习记录（25）-MultiTenancy-解析" class="headerlink" title="ABP框架学习记录（25）- MultiTenancy 解析"></a>ABP框架学习记录（25）- MultiTenancy 解析</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>多租户和单租户托管是SaaS公司提供服务的两种方式。多租户托管是指在同一软件实例上存在许多客户端，它们共享基础结构，数据库和/或应用程序服务器。它便宜一些，但是有风险。单租户是指租户不共享任何东西。它更昂贵并且需要更多的管理，因为它需要为每个客户端运行完整的软件堆栈。</p>
<p>软件即服务（SaaS）产品可以具有各种级别的多租户。在应用程序服务器级别，可以有一个具有负载均衡功能的应用程序服务器池，可以为多个客户端提供服务。在数据库级别，每个租户可以有一个数据库，也可以在所有租户之间共享一个数据库。</p>
<h2 id="详解"><a href="#详解" class="headerlink" title="详解"></a>详解</h2><p>MultiTenancy：多租户</p>
<p><code>MultiTenancy</code> 在ABP项目的目录位置：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190925151033.png" alt="QQ截图20190925151033.png"></p>
<p><code>MultiTenancySides</code>：标识是租户，租主；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190925153759.png" alt="QQ截图20190925153759.png"></p>
<p><code>MultiTenancySideAttribute</code>：声明多租户 特性；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190925162718.png" alt="QQ截图20190925162718.png"></p>
<p><code>TenantInfo</code>：租户信息，只有Id,和租户名称；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190925155312.png" alt="QQ截图20190925155312.png"></p>
<p><code>ITenantStore</code>：查找租户信息；</p>
<p><code>NullTenantStore</code>：默认实现 <code>ITenantStore</code> 接口，</p>
<p>在 <code>AbpKernelModule</code> 注册，如果没有注册过，则注册 <code>NullTenantStore</code>：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190925160412.png" alt="QQ截图20190925160412.png"></p>
<p><code>Abp.Zero.Common</code> 项目中，<code>TenantStore</code> 实现 <code>ITenantStore</code>:</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190925160718.png" alt="QQ截图20190925160718.png"></p>
<p><code>TenantResolverCacheItem</code>：租户获取缓存项</p>
<p><code>ITenantResolverCache</code>：定义获取租户缓存接口；</p>
<p><code>NullTenantResolverCache</code>：<code>ITenantResolverCache</code> 接口的空实现；</p>
<p><code>Abp.AspNetCore.MultiTenancy</code> 项目， 在 <code>HttpContextTenantResolverCache</code> 类实现 <code>HttpContextTenantResolverCache</code> 接口：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190925162409.png" alt="QQ截图20190925162409.png"></p>
<p><code>ITenantResolveContributor</code>：定义租户解析参与者接口；即实际解析租户的实现类</p>
<p>例如，在 <code>Abp.AspNetCore.MultiTenancy</code> 项目的 <code>DomainTenantResolveContributor</code> 类：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190925163152.png" alt="QQ截图20190925163152.png"></p>
<p><code>ITenantResolver/TenantResolver</code>：租户解析者，相当于 <code>Manager</code> 的角色；</p>
<p>匹配到真正的 <code>ITenantResolveContributor</code> 接口实现：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190925163736.png" alt="QQ截图20190925163736.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190925163623.png" alt="QQ截图20190925163623.png"></p>
<h2 id="Abp-Zero-Common"><a href="#Abp-Zero-Common" class="headerlink" title="Abp.Zero.Common"></a>Abp.Zero.Common</h2><p><code>AbpTenantManager</code>：管理 租户信息，包括持久化，<code>Feature</code>等；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190925165017.png" alt="QQ截图20190925165017.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190925170710.png" alt="QQ截图20190925170710.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190925170749.png" alt="QQ截图20190925170749.png"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://shareplm.com/single-tenant-vs-multi-tenant-hosting/">Single-tenant vs multi-tenant hosting</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2019/09/23/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8824%EF%BC%89-%20Notifications%20%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="syxdevcode的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/23/ABP%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%8824%EF%BC%89-%20Notifications%20%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">ABP框架学习记录（24）- Notifications 解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-23 09:39:48" itemprop="dateCreated datePublished" datetime="2019-09-23T09:39:48+00:00">2019-09-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-07 08:51:18" itemprop="dateModified" datetime="2022-09-07T08:51:18+00:00">2022-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ABP/" itemprop="url" rel="index"><span itemprop="name">ABP</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ABP框架学习记录（24）-Notifications-解析"><a href="#ABP框架学习记录（24）-Notifications-解析" class="headerlink" title="ABP框架学习记录（24）- Notifications 解析"></a>ABP框架学习记录（24）- Notifications 解析</h1><p><code>Notifications</code> 封装了通知的功能，实现 <code>Notification</code> 的定义，存储，发送，订阅等功能，支持租户通知，用户通知。通过 <code>IRealTimeNotifier</code> 接口，实现统一的 <code>Notification</code> 功能。支持 <code>SignalR</code>。</p>
<p><code>Notifications</code> 在ABP项目中的位置：<br><img src="/img/QQ%E6%88%AA%E5%9B%BE20190923141119.png" alt="QQ截图20190923141119.png"></p>
<h2 id="表-实体类对应"><a href="#表-实体类对应" class="headerlink" title="表-实体类对应"></a>表-实体类对应</h2><p>首先，介绍关于 <code>Notifications</code> 的表-实体类；</p>
<p><code>NotificationInfo</code>：用于存储需要发送的通知；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190923181330.png" alt="QQ截图20190923181330.png"></p>
<p><code>NotificationSubscriptionInfo</code>: 用于存储 通知订阅。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190923181457.png" alt="QQ截图20190923181457.png"></p>
<p><code>TenantNotificationInfo</code>: 分配给其相关租户的通知。</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924092140.png" alt="QQ截图20190924092140.png"></p>
<p><code>UserNotificationInfo</code>：用户存储用户通知</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924092240.png" alt="QQ截图20190924092240.png"></p>
<h2 id="通知数据"><a href="#通知数据" class="headerlink" title="通知数据"></a>通知数据</h2><p><code>NotificationData</code>：用户 通知数据的 存储；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924134512.png" alt="QQ截图20190924134512.png"></p>
<p><code>MessageNotificationData</code>：继承 <code>NotificationData</code>, 可以用户简单的通知消息；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924134619.png" alt="QQ截图20190924134619.png"></p>
<p><code>LocalizableMessageNotificationData</code>：继承 <code>NotificationData</code>, 可以用户表示本地的通知消息数据；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924134652.png" alt="QQ截图20190924134652.png"></p>
<h2 id="通知定义管理"><a href="#通知定义管理" class="headerlink" title="通知定义管理"></a>通知定义管理</h2><p><code>NotificationDefinition</code>：定义通知</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924143636.png" alt="QQ截图20190924143636.png"></p>
<p><code>NotificationDefinitionManager</code>：实现 <code>INotificationDefinitionManager</code> 接口，用于管理 <code>NotificationDefinition</code>;</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924143805.png" alt="QQ截图20190924143805.png"></p>
<p><code>AbpKernelModule</code>：<code>PostInitialize</code> 方法中初始化；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924144304.png" alt="QQ截图20190924144304.png"></p>
<p><code>NotificationDefinitionContext</code>：定义 <code>NotificationDefinition</code> 上下文；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924143854.png" alt="QQ截图20190924143854.png"></p>
<p><code>NotificationDefinitionManagerExtensions</code>：扩展方法，获取给定用户的所有通知；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924144047.png" alt="QQ截图20190924144047.png"></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p><code>INotificationConfiguration</code>：配置通知；</p>
<p><code>NotificationConfiguration</code>：实现 <code>INotificationConfiguration</code> 接口；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924150138.png" alt="QQ截图20190924150138.png"></p>
<p><code>AbpCoreInstaller</code> 中注册：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924150305.png" alt="QQ截图20190924150305.png"></p>
<h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><p><code>INotificationStore</code>：定义通知持久化接口；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924151312.png" alt="QQ截图20190924151312.png"></p>
<p><code>Abp.Zero.Common</code> 项目中，使用仓储模式，提供 <code>INotificationStore</code> 接口的实现 <code>NotificationStore</code>；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924151629.png" alt="QQ截图20190924151629.png"></p>
<p><code>UserNotificationState</code>：定义通知的状态，已读，未读；</p>
<h2 id="管理用户通知"><a href="#管理用户通知" class="headerlink" title="管理用户通知"></a>管理用户通知</h2><p><code>IUserNotificationManager</code>：定义用户通知管理接口；</p>
<p><code>UserNotificationManager</code>：实现 <code>IUserNotificationManager</code> 接口；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924165743.png" alt="QQ截图20190924165743.png"></p>
<p><code>UserNotification</code>：表示发送给用户的通知；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924165934.png" alt="QQ截图20190924165934.png"></p>
<p><code>TenantNotification</code>：代表租户/用户 已经发送的通知；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924170219.png" alt="QQ截图20190924170219.png"></p>
<h2 id="发布通知"><a href="#发布通知" class="headerlink" title="发布通知"></a>发布通知</h2><p><code>INotificationPublisher</code>：定义发布通知的接口；</p>
<p><code>NotificationPublisher</code>：实现 <code>INotificationPublisher</code> 接口；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924170626.png" alt="QQ截图20190924170626.png"></p>
<p><code>PublishAsync</code> 异步方法:</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924170842.png" alt="QQ截图20190924170842.png"></p>
<p><code>NotificationDistributionJob</code>：后台工作，去通知用户；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924172001.png" alt="QQ截图20190924172001.png"></p>
<h2 id="订阅通知"><a href="#订阅通知" class="headerlink" title="订阅通知"></a>订阅通知</h2><p><code>NotificationSubscription</code>：表示一个用户订阅的通知；</p>
<p><code>INotificationSubscriptionManager</code>：管理订阅通知；</p>
<p><code>NotificationSubscriptionManager</code>：实现 <code>INotificationSubscriptionManager</code>；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924171659.png" alt="QQ截图20190924171659.png"></p>
<h2 id="通知设置"><a href="#通知设置" class="headerlink" title="通知设置"></a>通知设置</h2><p><code>NotificationSettingNames</code>：定义通知开关 配置名；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924172434.png" alt="QQ截图20190924172434.png"></p>
<p><code>NotificationSettingProvider</code>：适配器</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924172654.png" alt="QQ截图20190924172654.png"></p>
<p><code>AbpKernelModule</code> 模块初始化：</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924172751.png" alt="QQ截图20190924172751.png"></p>
<h2 id="发送通知"><a href="#发送通知" class="headerlink" title="发送通知"></a>发送通知</h2><p><code>INotificationDistributer</code>：定义发送给用户通知的接口；</p>
<p><code>DefaultNotificationDistributer</code>：实现 <code>INotificationDistributer</code> 接口；</p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924173343.png" alt="QQ截图20190924173343.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924173922.png" alt="QQ截图20190924173922.png"></p>
<p><img src="/img/QQ%E6%88%AA%E5%9B%BE20190924174210.png" alt="QQ截图20190924174210.png"></p>
<p><code>IRealTimeNotifier</code>：定义向用户发送实时通知的接口；</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/23/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><span class="page-number current">24</span><a class="page-number" href="/page/25/">25</a><span class="space">&hellip;</span><a class="page-number" href="/page/38/">38</a><a class="extend next" rel="next" href="/page/25/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="syxdevcode"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">syxdevcode</p>
  <div class="site-description" itemprop="description">syxdevcode的个人博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">562</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">140</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">210</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/syxdevcode" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;syxdevcode" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">syxdevcode</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.8m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">27:05</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
