<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"syxdevcode.github.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="syxdevcode博客">
<meta property="og:url" content="https://syxdevcode.github.com/page/3/index.html">
<meta property="og:site_name" content="syxdevcode博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="syxdevcode">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://syxdevcode.github.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>syxdevcode博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">syxdevcode博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/syxdevcode" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/10/16/C-%E6%89%98%E7%AE%A1%E7%B1%BB%E5%9E%8B%E3%80%81%E9%9D%9E%E6%89%98%E7%AE%A1%E7%B1%BB%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/16/C-%E6%89%98%E7%AE%A1%E7%B1%BB%E5%9E%8B%E3%80%81%E9%9D%9E%E6%89%98%E7%AE%A1%E7%B1%BB%E5%9E%8B/" class="post-title-link" itemprop="url">C#托管类型、非托管类型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-16 17:47:44" itemprop="dateCreated datePublished" datetime="2020-10-16T17:47:44+00:00">2020-10-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-13 09:35:52" itemprop="dateModified" datetime="2021-01-13T09:35:52+00:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSharp%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">CSharp基础</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="托管类型"><a href="#托管类型" class="headerlink" title="托管类型"></a>托管类型</h2><p>托管类型包括 引用类型 以及 包含有引用类型或托管类型成员的结构。</p>
<ul>
<li>引用类型</li>
<li>含引用类型或托管类型成员（字段、自动实现 get 访问器的属性）的结构（managed structure）</li>
</ul>
<h2 id="非托管类型"><a href="#非托管类型" class="headerlink" title="非托管类型"></a>非托管类型</h2><p>如果某个类型是以下类型之一，则它是非托管类型 ：</p>
<ul>
<li>sbyte、byte、short、ushort、int、uint、long、ulong、char、float、double、decimal 或 bool</li>
<li>任何枚举类型</li>
<li>任何指针类型</li>
<li>任何用户定义的 struct 类型，只包含非托管类型的字段，并且在 C# 7.3 及更早版本中，不是构造类型（包含至少一个类型参数的类型）</li>
</ul>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/builtin-types/unmanaged-types">非托管类型（C# 参考）
</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/10/16/C-8-0-%E4%B8%AD%E7%9A%84%E6%96%B0%E5%A2%9E%E5%8A%9F%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/16/C-8-0-%E4%B8%AD%E7%9A%84%E6%96%B0%E5%A2%9E%E5%8A%9F%E8%83%BD/" class="post-title-link" itemprop="url">C# 8.0 中的新增功能</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-16 14:30:28" itemprop="dateCreated datePublished" datetime="2020-10-16T14:30:28+00:00">2020-10-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-13 09:35:52" itemprop="dateModified" datetime="2021-01-13T09:35:52+00:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSharp%E6%96%B0%E5%A2%9E%E5%8A%9F%E8%83%BD/" itemprop="url" rel="index"><span itemprop="name">CSharp新增功能</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>“.NET Core 3.x”和“.NET Standard 2.1”支持 C# 8.0 。有关详细信息，请参阅<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/configure-language-version">C# 语言版本控制</a></p>
<h2 id="Readonly-成员"><a href="#Readonly-成员" class="headerlink" title="Readonly 成员"></a>Readonly 成员</h2><p>可将 readonly 修饰符应用于结构的成员。 它指示该成员不会修改状态。 这比将 readonly 修饰符应用于 struct 声明更精细。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> Point</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">double</span> X &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">double</span> Y &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">readonly</span>  <span class="built_in">double</span> Distance =&gt; Math.Sqrt(X * X + Y * Y);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>(<span class="params"></span>)</span> =&gt;</span><br><span class="line">        <span class="string">$&quot;(<span class="subst">&#123;X&#125;</span>, <span class="subst">&#123;Y&#125;</span>) is <span class="subst">&#123;Distance&#125;</span> from the origin&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>readonly 修饰符对于只读属性是必需的。 编译器会假设 get 访问器可以修改状态；必须显式声明 readonly。 自动实现的属性是一个例外；编译器会将所有自动实现的 Getter 视为 readonly，因此，此处无需向 X 和 Y 属性添加 readonly 修饰符。</p>
<h2 id="默认接口方法"><a href="#默认接口方法" class="headerlink" title="默认接口方法"></a>默认接口方法</h2><p>现在可以将成员添加到接口，并为这些成员提供实现。 借助此语言功能，API 作者可以将方法添加到以后版本的接口中，而不会破坏与该接口当前实现的源或二进制文件兼容性。 现有的实现继承默认实现。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/dotnet/samples/tree/master/csharp/tutorials/default-interface-members-versions/starter/customer-relationship">https://github.com/dotnet/samples/tree/master/csharp/tutorials/default-interface-members-versions/starter/customer-relationship</a></p>
<p>[教程：在 C# 8.0 中使用默认接口方法更新接口](<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/tutorials/default-interface-methods-versions">https://docs.microsoft.com/zh-cn/dotnet/csharp/tutorials/default-interface-methods-versions</a></p>
<h2 id="switch-表达式"><a href="#switch-表达式" class="headerlink" title="switch 表达式"></a>switch 表达式</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RGBColor <span class="title">FromRainbow</span>(<span class="params">Rainbow colorBand</span>)</span> =&gt;</span><br><span class="line">    colorBand <span class="keyword">switch</span></span><br><span class="line">    &#123;</span><br><span class="line">        Rainbow.Red    =&gt; <span class="keyword">new</span> RGBColor(<span class="number">0xFF</span>, <span class="number">0x00</span>, <span class="number">0x00</span>),</span><br><span class="line">        Rainbow.Orange =&gt; <span class="keyword">new</span> RGBColor(<span class="number">0xFF</span>, <span class="number">0x7F</span>, <span class="number">0x00</span>),</span><br><span class="line">        Rainbow.Yellow =&gt; <span class="keyword">new</span> RGBColor(<span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0x00</span>),</span><br><span class="line">        Rainbow.Green  =&gt; <span class="keyword">new</span> RGBColor(<span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0x00</span>),</span><br><span class="line">        Rainbow.Blue   =&gt; <span class="keyword">new</span> RGBColor(<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>),</span><br><span class="line">        Rainbow.Indigo =&gt; <span class="keyword">new</span> RGBColor(<span class="number">0x4B</span>, <span class="number">0x00</span>, <span class="number">0x82</span>),</span><br><span class="line">        Rainbow.Violet =&gt; <span class="keyword">new</span> RGBColor(<span class="number">0x94</span>, <span class="number">0x00</span>, <span class="number">0xD3</span>),</span><br><span class="line">        _              =&gt; <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(message: <span class="string">&quot;invalid enum value&quot;</span>, paramName: <span class="keyword">nameof</span>(colorBand)),</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>变量位于 switch 关键字之前。 不同的顺序使得在视觉上可以很轻松地区分 switch 表达式和 switch 语句。</li>
<li>将 case 和 : 元素替换为 =&gt;。 它更简洁，更直观。</li>
<li>将 default 事例替换为 _ 弃元。</li>
<li>正文是表达式，不是语句。</li>
</ul>
<h2 id="属性模式"><a href="#属性模式" class="headerlink" title="属性模式"></a>属性模式</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">decimal</span> <span class="title">ComputeSalesTax</span>(<span class="params">Address location, <span class="built_in">decimal</span> salePrice</span>)</span> =&gt;</span><br><span class="line">    location <span class="keyword">switch</span></span><br><span class="line">    &#123;</span><br><span class="line">        &#123; State: <span class="string">&quot;WA&quot;</span> &#125; =&gt; salePrice * <span class="number">0.06</span>M,</span><br><span class="line">        &#123; State: <span class="string">&quot;MN&quot;</span> &#125; =&gt; salePrice * <span class="number">0.075</span>M,</span><br><span class="line">        &#123; State: <span class="string">&quot;MI&quot;</span> &#125; =&gt; salePrice * <span class="number">0.05</span>M,</span><br><span class="line">        <span class="comment">// other cases removed for brevity...</span></span><br><span class="line">        _ =&gt; <span class="number">0</span>M</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<h2 id="元组模式"><a href="#元组模式" class="headerlink" title="元组模式"></a>元组模式</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">RockPaperScissors</span>(<span class="params"><span class="built_in">string</span> first, <span class="built_in">string</span> second</span>)</span></span><br><span class="line"><span class="function"></span>    =&gt; (first, second) <span class="keyword">switch</span></span><br><span class="line">    &#123;</span><br><span class="line">        (<span class="string">&quot;rock&quot;</span>, <span class="string">&quot;paper&quot;</span>) =&gt; <span class="string">&quot;rock is covered by paper. Paper wins.&quot;</span>,</span><br><span class="line">        (<span class="string">&quot;rock&quot;</span>, <span class="string">&quot;scissors&quot;</span>) =&gt; <span class="string">&quot;rock breaks scissors. Rock wins.&quot;</span>,</span><br><span class="line">        (<span class="string">&quot;paper&quot;</span>, <span class="string">&quot;rock&quot;</span>) =&gt; <span class="string">&quot;paper covers rock. Paper wins.&quot;</span>,</span><br><span class="line">        (<span class="string">&quot;paper&quot;</span>, <span class="string">&quot;scissors&quot;</span>) =&gt; <span class="string">&quot;paper is cut by scissors. Scissors wins.&quot;</span>,</span><br><span class="line">        (<span class="string">&quot;scissors&quot;</span>, <span class="string">&quot;rock&quot;</span>) =&gt; <span class="string">&quot;scissors is broken by rock. Rock wins.&quot;</span>,</span><br><span class="line">        (<span class="string">&quot;scissors&quot;</span>, <span class="string">&quot;paper&quot;</span>) =&gt; <span class="string">&quot;scissors cuts paper. Scissors wins.&quot;</span>,</span><br><span class="line">        (_, _) =&gt; <span class="string">&quot;tie&quot;</span></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<h2 id="位置模式"><a href="#位置模式" class="headerlink" title="位置模式"></a>位置模式</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Point</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> X &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Y &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Point</span>(<span class="params"><span class="built_in">int</span> x, <span class="built_in">int</span> y</span>)</span> =&gt; (X, Y) = (x, y);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Deconstruct</span>(<span class="params"><span class="keyword">out</span> <span class="built_in">int</span> x, <span class="keyword">out</span> <span class="built_in">int</span> y</span>)</span> =&gt;</span><br><span class="line">        (x, y) = (X, Y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> Quadrant</span><br><span class="line">&#123;</span><br><span class="line">    Unknown,</span><br><span class="line">    Origin,</span><br><span class="line">    One,</span><br><span class="line">    Two,</span><br><span class="line">    Three,</span><br><span class="line">    Four,</span><br><span class="line">    OnBorder</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> Quadrant <span class="title">GetQuadrant</span>(<span class="params">Point point</span>)</span> =&gt; point <span class="keyword">switch</span></span><br><span class="line">&#123;</span><br><span class="line">    (<span class="number">0</span>, <span class="number">0</span>) =&gt; Quadrant.Origin,</span><br><span class="line">    <span class="keyword">var</span> (x, y) <span class="keyword">when</span> x &gt; <span class="number">0</span> &amp;&amp; y &gt; <span class="number">0</span> =&gt; Quadrant.One,</span><br><span class="line">    <span class="keyword">var</span> (x, y) <span class="keyword">when</span> x &lt; <span class="number">0</span> &amp;&amp; y &gt; <span class="number">0</span> =&gt; Quadrant.Two,</span><br><span class="line">    <span class="keyword">var</span> (x, y) <span class="keyword">when</span> x &lt; <span class="number">0</span> &amp;&amp; y &lt; <span class="number">0</span> =&gt; Quadrant.Three,</span><br><span class="line">    <span class="keyword">var</span> (x, y) <span class="keyword">when</span> x &gt; <span class="number">0</span> &amp;&amp; y &lt; <span class="number">0</span> =&gt; Quadrant.Four,</span><br><span class="line">    <span class="keyword">var</span> (_, _) =&gt; Quadrant.OnBorder,</span><br><span class="line">    _ =&gt; Quadrant.Unknown</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="using-声明"><a href="#using-声明" class="headerlink" title="using 声明"></a>using 声明</h2><p>using 声明是前面带 using 关键字的变量声明。它指示编译器声明的变量应在封闭范围的末尾进行处理。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="built_in">int</span> <span class="title">WriteLinesToFile</span>(<span class="params">IEnumerable&lt;<span class="built_in">string</span>&gt; lines</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 当到达方法的右括号时，将对该文件进行处理。</span></span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">var</span> file = <span class="keyword">new</span> System.IO.StreamWriter(<span class="string">&quot;WriteLines2.txt&quot;</span>);</span><br><span class="line">    <span class="comment">// Notice how we declare skippedLines after the using statement.</span></span><br><span class="line">    <span class="built_in">int</span> skippedLines = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="built_in">string</span> line <span class="keyword">in</span> lines)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!line.Contains(<span class="string">&quot;Second&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            file.WriteLine(line);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            skippedLines++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Notice how skippedLines is in scope here.</span></span><br><span class="line">    <span class="keyword">return</span> skippedLines;</span><br><span class="line">    <span class="comment">// file is disposed here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="静态本地函数"><a href="#静态本地函数" class="headerlink" title="静态本地函数"></a>静态本地函数</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">int</span> <span class="title">M</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">int</span> y = <span class="number">5</span>;</span><br><span class="line">    <span class="built_in">int</span> x = <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">return</span> Add(x, y);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="built_in">int</span> <span class="title">Add</span>(<span class="params"><span class="built_in">int</span> left, <span class="built_in">int</span> right</span>)</span> =&gt; left + right;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="可处置的-ref-结构"><a href="#可处置的-ref-结构" class="headerlink" title="可处置的 ref 结构"></a>可处置的 ref 结构</h2><p>用 ref 修饰符声明的 struct 可能无法实现任何接口，因此无法实现 IDisposable。 因此，要能够处理 ref struct，它必须有一个可访问的 void Dispose() 方法。 此功能同样适用于 readonly ref struct 声明。</p>
<h2 id="可为空引用类型"><a href="#可为空引用类型" class="headerlink" title="可为空引用类型"></a>可为空引用类型</h2><h2 id="异步流"><a href="#异步流" class="headerlink" title="异步流"></a>异步流</h2><p>从 C# 8.0 开始，可以创建并以异步方式使用流。 返回异步流的方法有三个属性：</p>
<ul>
<li>它是用 async 修饰符声明的。</li>
<li>它将返回 IAsyncEnumerable<T>。</li>
<li>该方法包含用于在异步流中返回连续元素的 yield return 语句。</li>
</ul>
<p>使用异步流需要在枚举流元素时在 foreach 关键字前面添加 await 关键字。 添加 await 关键字需要枚举异步流的方法，以使用 async 修饰符进行声明并返回 async 方法允许的类型。 通常这意味着返回 Task 或 Task<TResult>。 也可以为 ValueTask 或 ValueTask<TResult>。 方法既可以使用异步流，也可以生成异步流，这意味着它将返回 IAsyncEnumerable<T>。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="keyword">foreach</span> (<span class="function"><span class="keyword">var</span> number <span class="keyword">in</span> <span class="title">GenerateSequence</span>(<span class="params"></span>))</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Console.WriteLine(number);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="异步可释放"><a href="#异步可释放" class="headerlink" title="异步可释放"></a>异步可释放</h2><p>从 C# 8.0 开始，语言支持实现 System.IAsyncDisposable 接口的异步可释放类型。 可使用 await using 语句来处理异步可释放对象。</p>
<h2 id="索引和范围"><a href="#索引和范围" class="headerlink" title="索引和范围"></a>索引和范围</h2><p>索引和范围为访问序列中的单个元素或范围提供了简洁的语法。</p>
<p>此语言支持依赖于两个新类型和两个新运算符：</p>
<ul>
<li>System.Index 表示一个序列索引。</li>
<li>来自末尾运算符 ^ 的索引，指定一个索引与序列末尾相关。</li>
<li>System.Range 表示序列的子范围。</li>
<li>范围运算符 ..，用于指定范围的开始和末尾，就像操作数一样。</li>
</ul>
<p>0 索引与 sequence[0] 相同。 ^0 索引与 sequence[sequence.Length] 相同。 请注意，sequence[^0] 不会引发异常，就像 sequence[sequence.Length] 一样。 对于任何数字 n，索引 ^n 与 sequence.Length - n 相同。</p>
<p>范围指定范围的开始和末尾 。 包括此范围的开始，但不包括此范围的末尾，这表示此范围包含开始但不包含末尾 。 范围 [0..^0] 表示整个范围，就像 [0..sequence.Length] 表示整个范围。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> words = <span class="keyword">new</span> <span class="built_in">string</span>[]</span><br><span class="line">&#123;</span><br><span class="line">                <span class="comment">// index from start    index from end</span></span><br><span class="line">    <span class="string">&quot;The&quot;</span>,      <span class="comment">// 0                   ^9</span></span><br><span class="line">    <span class="string">&quot;quick&quot;</span>,    <span class="comment">// 1                   ^8</span></span><br><span class="line">    <span class="string">&quot;brown&quot;</span>,    <span class="comment">// 2                   ^7</span></span><br><span class="line">    <span class="string">&quot;fox&quot;</span>,      <span class="comment">// 3                   ^6</span></span><br><span class="line">    <span class="string">&quot;jumped&quot;</span>,   <span class="comment">// 4                   ^5</span></span><br><span class="line">    <span class="string">&quot;over&quot;</span>,     <span class="comment">// 5                   ^4</span></span><br><span class="line">    <span class="string">&quot;the&quot;</span>,      <span class="comment">// 6                   ^3</span></span><br><span class="line">    <span class="string">&quot;lazy&quot;</span>,     <span class="comment">// 7                   ^2</span></span><br><span class="line">    <span class="string">&quot;dog&quot;</span>       <span class="comment">// 8                   ^1</span></span><br><span class="line">&#125;;              <span class="comment">// 9 (or words.Length) ^0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 ^1 索引检索最后一个词</span></span><br><span class="line">Console.WriteLine(<span class="string">$&quot;The last word is <span class="subst">&#123;words[^<span class="number">1</span>]&#125;</span>&quot;</span>);</span><br><span class="line"><span class="comment">// writes &quot;dog&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 包括 words[1] 到 words[3]</span></span><br><span class="line"><span class="keyword">var</span> quickBrownFox = words[<span class="number">1.</span><span class="number">.4</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 包括 words[^2] 和 words[^1]</span></span><br><span class="line"><span class="keyword">var</span> lazyDog = words[^<span class="number">2.</span>.^<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> allWords = words[..]; <span class="comment">// contains &quot;The&quot; through &quot;dog&quot;.</span></span><br><span class="line"><span class="keyword">var</span> firstPhrase = words[.<span class="number">.4</span>]; <span class="comment">// contains &quot;The&quot; through &quot;fox&quot;</span></span><br><span class="line"><span class="keyword">var</span> lastPhrase = words[<span class="number">6.</span>.]; <span class="comment">// contains &quot;the&quot;, &quot;lazy&quot; and &quot;dog&quot;</span></span><br><span class="line"></span><br><span class="line">Range phrase = <span class="number">1.</span><span class="number">.4</span>;</span><br><span class="line"><span class="keyword">var</span> text = words[phrase];</span><br></pre></td></tr></table></figure>
<h2 id="Null-合并赋值"><a href="#Null-合并赋值" class="headerlink" title="Null 合并赋值"></a>Null 合并赋值</h2><p>C# 8.0 引入了 null 合并赋值运算符 ??=。 仅当左操作数计算为 null 时，才能使用运算符 ??= 将其右操作数的值分配给左操作数。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List&lt;<span class="built_in">int</span>&gt; numbers = <span class="literal">null</span>;</span><br><span class="line"><span class="built_in">int</span>? i = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">numbers ??= <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">numbers.Add(i ??= <span class="number">17</span>);</span><br><span class="line">numbers.Add(i ??= <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Join(<span class="string">&quot; &quot;</span>, numbers));  <span class="comment">// output: 17 17</span></span><br><span class="line">Console.WriteLine(i);  <span class="comment">// output: 17</span></span><br></pre></td></tr></table></figure>
<h2 id="非托管构造类型"><a href="#非托管构造类型" class="headerlink" title="非托管构造类型"></a>非托管构造类型</h2><p>在 C# 7.3 及更低版本中，构造类型（包含至少一个类型参数的类型）不能为非托管类型。 从 C# 8.0 开始，如果构造的值类型仅包含非托管类型的字段，则该类型不受管理。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> Coords&lt;T&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> T X;</span><br><span class="line">    <span class="keyword">public</span> T Y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Coords<int> 类型为 C# 8.0 及更高版本中的非托管类型。 与任何非托管类型一样，可以创建指向此类型的变量的指针，或针对此类型的实例在堆栈上分配内存块：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Span&lt;Coords&lt;<span class="built_in">int</span>&gt;&gt; coordinates = <span class="keyword">stackalloc</span>[]</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">new</span> Coords&lt;<span class="built_in">int</span>&gt; &#123; X = <span class="number">0</span>, Y = <span class="number">0</span> &#125;,</span><br><span class="line">    <span class="keyword">new</span> Coords&lt;<span class="built_in">int</span>&gt; &#123; X = <span class="number">0</span>, Y = <span class="number">3</span> &#125;,</span><br><span class="line">    <span class="keyword">new</span> Coords&lt;<span class="built_in">int</span>&gt; &#123; X = <span class="number">4</span>, Y = <span class="number">0</span> &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="嵌套表达式中的-stackalloc"><a href="#嵌套表达式中的-stackalloc" class="headerlink" title="嵌套表达式中的 stackalloc"></a>嵌套表达式中的 stackalloc</h2><p>stackalloc 表达式在堆栈上分配内存块。该方法返回时，将自动丢弃在方法执行期间创建的堆栈中分配的内存块。 不能显式释放使用 stackalloc 分配的内存。 堆栈中分配的内存块不受垃圾回收的影响，也不必通过 fixed 语句固定。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Span&lt;<span class="built_in">int</span>&gt; numbers = <span class="keyword">stackalloc</span>[] &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> ind = numbers.IndexOfAny(<span class="keyword">stackalloc</span>[] &#123; <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span> &#125;);</span><br><span class="line">Console.WriteLine(ind);  <span class="comment">// output: 1</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/operators/stackalloc">stackalloc 表达式（C# 参考）</a></p>
<h2 id="内插逐字字符串的增强功能"><a href="#内插逐字字符串的增强功能" class="headerlink" title="内插逐字字符串的增强功能"></a>内插逐字字符串的增强功能</h2><p>内插逐字字符串中 $ 和 @ 标记的顺序可以任意安排：$@”…” 和 @$”…” 均为有效的内插逐字字符串。 在早期 C# 版本中，$ 标记必须出现在 @ 标记之前。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/whats-new/csharp-8">C# 8.0 中的新增功能</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/10/16/C-7-0-%E4%B8%AD%E7%9A%84%E6%96%B0%E5%A2%9E%E5%8A%9F%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/16/C-7-0-%E4%B8%AD%E7%9A%84%E6%96%B0%E5%A2%9E%E5%8A%9F%E8%83%BD/" class="post-title-link" itemprop="url">C# 7.0 中的新增功能</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-16 11:09:57" itemprop="dateCreated datePublished" datetime="2020-10-16T11:09:57+00:00">2020-10-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-13 09:35:52" itemprop="dateModified" datetime="2021-01-13T09:35:52+00:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSharp%E6%96%B0%E5%A2%9E%E5%8A%9F%E8%83%BD/" itemprop="url" rel="index"><span itemprop="name">CSharp新增功能</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="out-变量"><a href="#out-变量" class="headerlink" title="out 变量"></a>out 变量</h2><p>可以将 out 值内联作为参数声明到使用这些参数的方法中。</p>
<p>无需分配初始值</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">int</span>.TryParse(input, <span class="keyword">out</span> <span class="keyword">var</span> answer))</span><br><span class="line">    Console.WriteLine(answer);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;Could not parse input&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="元组"><a href="#元组" class="headerlink" title="元组"></a>元组</h2><p>低于 C# 7.0 的版本中也提供元组，但它们效率低下且不具有语言支持。 这意味着元组元素只能作为 Item1 和 Item2 等引用。 C# 7.0 引入了对元组的语言支持，可利用更有效的新元组类型向元组字段赋予语义名称。这些名称仅存在于编译时且不保留，例如在运行时使用反射来检查元组时。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一种写法</span></span><br><span class="line">(<span class="built_in">string</span> Alpha, <span class="built_in">string</span> Beta) namedLetters = (<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  第二种写法</span></span><br><span class="line"><span class="keyword">var</span> alphabetStart = (Alpha: <span class="string">&quot;a&quot;</span>, Beta: <span class="string">&quot;b&quot;</span>);</span><br><span class="line">Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;namedLetters.Alpha&#125;</span>, <span class="subst">&#123;namedLetters.Beta&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  第三种写法</span></span><br><span class="line">(<span class="built_in">int</span> max, <span class="built_in">int</span> min) = Range(numbers);</span><br><span class="line">Console.WriteLine(max);</span><br><span class="line">Console.WriteLine(min);</span><br></pre></td></tr></table></figure>
<p>从 C# 7.3 开始，元组类型支持 == 和 != 运算符。这些运算符按照元组元素的顺序将左侧操作数的成员与相应的右侧操作数的成员进行比较。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/builtin-types/value-tuples">元组类型（C# 参考）</a></p>
<h2 id="弃元"><a href="#弃元" class="headerlink" title="弃元"></a>弃元</h2><p>弃元是一个名为 _（下划线字符）的只写变量，可向单个变量赋予要放弃的所有值。 弃元类似于未赋值的变量；不可在代码中使用弃元（赋值语句除外）。</p>
<p>在以下方案中支持弃元：</p>
<ul>
<li>在对元组或用户定义的类型进行解构时。</li>
<li>在使用 out 参数调用方法时。</li>
<li>在使用 is 和 switch 语句匹配操作的模式中。</li>
<li>在要将某赋值的值显式标识为弃元时用作独立标识符。</li>
</ul>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Example</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> (_, _, _, pop1, _, pop2) = QueryCityDataForYears(<span class="string">&quot;New York City&quot;</span>, <span class="number">1960</span>, <span class="number">2010</span>);</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;Population change, 1960 to 2010: <span class="subst">&#123;pop2 - pop1:N0&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> (<span class="params"><span class="built_in">string</span>, <span class="built_in">double</span>, <span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span></span>) <span class="title">QueryCityDataForYears</span>(<span class="params"><span class="built_in">string</span> name, <span class="built_in">int</span> year1, <span class="built_in">int</span> year2</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="built_in">int</span> population1 = <span class="number">0</span>, population2 = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">double</span> area = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name == <span class="string">&quot;New York City&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            area = <span class="number">468.48</span>;</span><br><span class="line">            <span class="keyword">if</span> (year1 == <span class="number">1960</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                population1 = <span class="number">7781984</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (year2 == <span class="number">2010</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                population2 = <span class="number">8175133</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (name, area, year1, population1, year2, population2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="string">&quot;&quot;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// The example displays the following output:</span></span><br><span class="line"><span class="comment">//      Population change, 1960 to 2010: 393,149</span></span><br></pre></td></tr></table></figure>
<h2 id="模式匹配"><a href="#模式匹配" class="headerlink" title="模式匹配"></a>模式匹配</h2><p>模式匹配支持 is 表达式和 switch 表达式。 每个表达式都允许检查对象及其属性以确定该对象是否满足所寻求的模式。 使用 when 关键字来指定模式的其他规则。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (input <span class="keyword">is</span> <span class="built_in">int</span> count)</span><br><span class="line">    sum += count;</span><br></pre></td></tr></table></figure>
<p>更新后的 switch 语句有几个新构造：</p>
<ul>
<li>switch 表达式的控制类型不再局限于整数类型、Enum 类型、string 或与这些类型之一对应的可为 null 的类型。 可能会使用任何类型。</li>
<li>可以在每个 case 标签中测试 switch 表达式的类型。 与 is 表达式一样，可以为该类型指定一个新变量。</li>
<li>可以添加 when 子句以进一步测试该变量的条件。</li>
<li>case 标签的顺序现在很重要。 执行匹配的第一个分支；其他将跳过。</li>
</ul>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">SumPositiveNumbers</span>(<span class="params">IEnumerable&lt;<span class="built_in">object</span>&gt; sequence</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> i <span class="keyword">in</span> sequence)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> IEnumerable&lt;<span class="built_in">int</span>&gt; childSequence:</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span>(<span class="keyword">var</span> item <span class="keyword">in</span> childSequence)</span><br><span class="line">                    sum += (item &gt; <span class="number">0</span>) ? item : <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">int</span> n <span class="keyword">when</span> n &gt; <span class="number">0</span>:</span><br><span class="line">                sum += n;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="literal">null</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullReferenceException(<span class="string">&quot;Null found in sequence&quot;</span>);</span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">&quot;Unrecognized type&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>case 0: 是常见的常量模式。</li>
<li>case IEnumerable<int> childSequence: 是一种类型模式。</li>
<li>case int n when n &gt; 0: 是具有附加 when 条件的类型模式。</li>
<li>case null: 是 null 模式。</li>
<li>default: 是常见的默认事例。</li>
</ul>
<h2 id="Ref-局部变量和返回结果"><a href="#Ref-局部变量和返回结果" class="headerlink" title="Ref 局部变量和返回结果"></a>Ref 局部变量和返回结果</h2><p>此功能允许使用并返回对变量的引用的算法，这些变量在其他位置定义。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">ref</span> <span class="built_in">int</span> <span class="title">Find</span>(<span class="params"><span class="built_in">int</span>[,] matrix, Func&lt;<span class="built_in">int</span>, <span class="built_in">bool</span>&gt; predicate</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; matrix.GetLength(<span class="number">0</span>); i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; matrix.GetLength(<span class="number">1</span>); j++)</span><br><span class="line">            <span class="keyword">if</span> (predicate(matrix[i, j]))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">ref</span> matrix[i, j];</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">&quot;Not found&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改该值</span></span><br><span class="line"><span class="keyword">ref</span> <span class="keyword">var</span> item = <span class="keyword">ref</span> MatrixSearch.Find(matrix, (val) =&gt; val == <span class="number">42</span>);</span><br><span class="line">Console.WriteLine(item);</span><br><span class="line">item = <span class="number">24</span>;</span><br><span class="line">Console.WriteLine(matrix[<span class="number">4</span>, <span class="number">2</span>]);</span><br></pre></td></tr></table></figure>
<p>C# 语言还有多个规则，可保护你免于误用 ref 局部变量和返回结果：</p>
<ul>
<li>必须将 ref 关键字添加到方法签名和方法中的所有 return 语句中。表明，该方法在整个方法中通过引用返回。</li>
<li>可以将 ref return 分配给值变量或 ref 变量。调用方控制是否复制返回值。 在分配返回值时省略 ref 修饰符表示调用方需要该值的副本，而不是对存储的引用。</li>
<li>不可向 ref 本地变量赋予标准方法返回值。因为那将禁止类似 ref int i = sequence.Count(); 这样的语句</li>
<li>不能将 ref 返回给其生存期不超出方法执行的变量。这意味着不可返回对本地变量或对类似作用域变量的引用。</li>
<li>ref 局部变量和返回结果不可用于异步方法。编译器无法知道异步方法返回时，引用的变量是否已设置为其最终值。</li>
</ul>
<p>添加 ref 局部变量和 ref 返回结果可通过避免复制值或多次执行取消引用的操作，允许更为高效的算法。</p>
<h2 id="本地函数"><a href="#本地函数" class="headerlink" title="本地函数"></a>本地函数</h2><p>方法套方法。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">PerformLongRunningWork</span>(<span class="params"><span class="built_in">string</span> address, <span class="built_in">int</span> index, <span class="built_in">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(address))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(message: <span class="string">&quot;An address is required&quot;</span>, paramName: <span class="keyword">nameof</span>(address));</span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(paramName: <span class="keyword">nameof</span>(index), message: <span class="string">&quot;The index must be non-negative&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(name))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(message: <span class="string">&quot;You must supply a name&quot;</span>, paramName: <span class="keyword">nameof</span>(name));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> longRunningWorkImplementation();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">longRunningWorkImplementation</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> interimResult = <span class="keyword">await</span> FirstWork(address);</span><br><span class="line">        <span class="keyword">var</span> secondResult = <span class="keyword">await</span> SecondStep(index, name);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">$&quot;The results are <span class="subst">&#123;interimResult&#125;</span> and <span class="subst">&#123;secondResult&#125;</span>. Enjoy.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="更多的-expression-bodied-成员"><a href="#更多的-expression-bodied-成员" class="headerlink" title="更多的 expression-bodied 成员"></a>更多的 expression-bodied 成员</h2><p>C# 7.0 扩展了可作为表达式实现的允许的成员。 在 C# 7.0 中，你可以在属性和索引器上实现构造函数、终结器以及 get 和 set 访问器。 以下代码演示了每种情况的示例：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Expression-bodied constructor</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ExpressionMembersExample</span>(<span class="params"><span class="built_in">string</span> label</span>)</span> =&gt; <span class="keyword">this</span>.Label = label;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Expression-bodied finalizer</span></span><br><span class="line">~ExpressionMembersExample() =&gt; Console.Error.WriteLine(<span class="string">&quot;Finalized!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">string</span> label;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Expression-bodied get / set accessors.</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> Label</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span> =&gt; label;</span><br><span class="line">    <span class="keyword">set</span> =&gt; <span class="keyword">this</span>.label = <span class="keyword">value</span> ?? <span class="string">&quot;Default label&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本示例不需要终结器，但显示它是为了演示语法。 不应在类中实现终结器，除非有必要发布非托管资源。 还应考虑使用 SafeHandle 类，而不是直接管理非托管资源。</p>
<h2 id="throw-表达式"><a href="#throw-表达式" class="headerlink" title="throw 表达式"></a>throw 表达式</h2><ul>
<li>条件运算符。 下例使用 throw 表达式在向方法传递空字符串数组时引发 ArgumentException。 在 C# 7.0 之前，此逻辑将需要显示在 if/else 语句中。</li>
</ul>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DisplayFirstNumber</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="built_in">string</span> arg = args.Length &gt;= <span class="number">1</span> ? args[<span class="number">0</span>] :</span><br><span class="line">                              <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;You must supply an argument&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (Int64.TryParse(arg, <span class="keyword">out</span> <span class="keyword">var</span> number))</span><br><span class="line">      Console.WriteLine(<span class="string">$&quot;You entered <span class="subst">&#123;number:F0&#125;</span>&quot;</span>);</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">      Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;arg&#125;</span> is not a number.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>null 合并运算符。 在以下示例中，如果分配给 Name 属性的字符串为 null，则将 throw 表达式与 null 合并运算符结合使用以引发异常。</li>
</ul>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> Name</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span> =&gt; name;</span><br><span class="line">    <span class="keyword">set</span> =&gt; name = <span class="keyword">value</span> ??</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(paramName: <span class="keyword">nameof</span>(<span class="keyword">value</span>), message: <span class="string">&quot;Name cannot be null&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>expression-bodied lambda 或方法。 下例说明了 expression-bodied 方法，由于不支持对 DateTime 值的转换，该方法引发 InvalidCastException。</li>
</ul>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DateTime <span class="title">ToDateTime</span>(<span class="params">IFormatProvider provider</span>)</span> =&gt;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> InvalidCastException(<span class="string">&quot;Conversion to a DateTime is not supported.&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="通用的异步返回类型"><a href="#通用的异步返回类型" class="headerlink" title="通用的异步返回类型"></a>通用的异步返回类型</h2><p>添加 NuGet 包 System.Threading.Tasks.Extensions 才能使用 ValueTask<TResult> 类型。</p>
<p>新语言功能意味着异步方法返回类型不限于 Task、Task<T> 和 void。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> ValueTask&lt;<span class="built_in">int</span>&gt; <span class="title">Func</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">await</span> Task.Delay(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="数字文本语法改进"><a href="#数字文本语法改进" class="headerlink" title="数字文本语法改进"></a>数字文本语法改进</h2><p>C# 7.0 包括两项新功能，可用于以最可读的方式写入数字来用于预期用途：二进制文本和数字分隔符 。<br>在创建位掩码时，或每当数字的二进制表示形式使代码最具可读性时，以二进制形式写入该数字：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> Sixteen =   <span class="number">0b0001</span>_0000;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> ThirtyTwo = <span class="number">0b0010</span>_0000;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> SixtyFour = <span class="number">0b0100</span>_0000;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> OneHundredTwentyEight = <span class="number">0b1000</span>_0000;</span><br></pre></td></tr></table></figure>
<p>常量开头的 0b 表示该数字以二进制数形式写入。 二进制数可能会很长，因此通过引入 _ 作为数字分隔符通常更易于查看位模式，如上面二进制常量所示。 </p>
<p>数字分隔符可以出现在常量的任何位置。 对于十进制数字，通常将其用作千位分隔符：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">long</span> BillionsAndBillions = <span class="number">100</span>_000_000_000;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数字分隔符也可以与 decimal、float 和 double 类型一起使用：</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">double</span> AvogadroConstant = <span class="number">6.022</span>_140_857_747_474e23;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">decimal</span> GoldenRatio = <span class="number">1.618</span>_033_988_749_894_848_204_586_834_365_638_117_720_309_179M;</span><br></pre></td></tr></table></figure>
<p>综观来说，你可以声明可读性更强的数值常量。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/whats-new/csharp-7">C# 7.0 中的新增功能</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/10/16/C-6-%E4%B8%AD%E7%9A%84%E6%96%B0%E5%A2%9E%E5%8A%9F%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/16/C-6-%E4%B8%AD%E7%9A%84%E6%96%B0%E5%A2%9E%E5%8A%9F%E8%83%BD/" class="post-title-link" itemprop="url">C# 6 中的新增功能</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-16 10:12:35" itemprop="dateCreated datePublished" datetime="2020-10-16T10:12:35+00:00">2020-10-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-13 09:35:52" itemprop="dateModified" datetime="2021-01-13T09:35:52+00:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSharp%E6%96%B0%E5%A2%9E%E5%8A%9F%E8%83%BD/" itemprop="url" rel="index"><span itemprop="name">CSharp新增功能</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="只读自动属性"><a href="#只读自动属性" class="headerlink" title="只读自动属性"></a>只读自动属性</h2><p>只读自动属性 提供了更简洁的语法来创建不可变类型。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> FirstName &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> LastName &#123; <span class="keyword">get</span>;  &#125;</span><br></pre></td></tr></table></figure>
<p>FirstName 和 LastName 属性只能在同一个类的构造函数的主体中设置：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Student</span>(<span class="params"><span class="built_in">string</span> firstName, <span class="built_in">string</span> lastName</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (IsNullOrWhiteSpace(lastName))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(message: <span class="string">&quot;Cannot be blank&quot;</span>, paramName: <span class="keyword">nameof</span>(lastName));</span><br><span class="line">    FirstName = firstName;</span><br><span class="line">    LastName = lastName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尝试在另一种方法中设置 LastName 会生成 CS0200 编译错误：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Student</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> LastName &#123; <span class="keyword">get</span>;  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ChangeName</span>(<span class="params"><span class="built_in">string</span> newLastName</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Generates CS0200: Property or indexer cannot be assigned to -- it is read only</span></span><br><span class="line">        LastName = newLastName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="自动属性初始化"><a href="#自动属性初始化" class="headerlink" title="自动属性初始化"></a>自动属性初始化</h2><p>自动属性初始值设定项 可让你在属性声明中声明自动属性的初始值。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ICollection</span>&lt;<span class="title">double</span>&gt; Grades</span> &#123; <span class="keyword">get</span>; &#125; = <span class="keyword">new</span> List&lt;<span class="built_in">double</span>&gt;();</span><br></pre></td></tr></table></figure>
<p>Grades 成员在声明它的位置处被初始化。 这样，就能更容易地仅执行一次初始化。 初始化是属性声明的一部分，可更轻松地将存储分配等同于 Student 对象的公用接口。</p>
<h2 id="Expression-bodied-函数成员"><a href="#Expression-bodied-函数成员" class="headerlink" title="Expression-bodied 函数成员"></a>Expression-bodied 函数成员</h2><p>编写的许多成员是可以作为单个表达式的单个语句。 改为编写 expression-bodied 成员。 这适用于方法和只读属性。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>(<span class="params"></span>)</span> =&gt; <span class="string">$&quot;<span class="subst">&#123;LastName&#125;</span>, <span class="subst">&#123;FirstName&#125;</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以将此语法用于只读属性：</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> FullName =&gt; <span class="string">$&quot;<span class="subst">&#123;FirstName&#125;</span> <span class="subst">&#123;LastName&#125;</span>&quot;</span>;</span><br></pre></td></tr></table></figure>
<h2 id="using-static"><a href="#using-static" class="headerlink" title="using static"></a>using static</h2><p>using static 增强功能可用于导入单个类的静态方法。 指定要使用的类：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">static</span> System.Math;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">static</span> System.Linq.Enumerable;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">static</span> System.String;</span><br></pre></td></tr></table></figure>
<p>备注：在 static using 语句中必须使用完全限定的类名 System.String。 而不能使用 string 关键字。</p>
<p>在 LINQ 查询中会经常看到这种情况。 可以通过导入 Enumerable 或 Queryable 来导入 LINQ 模式。</p>
<p>using static 语法导入一个类型，然后就可以在其全局作用域范围内（当前文件内）使用它可以访问（遵循访问修饰符的限定）类型的静态成员了，需要注意的几点是：</p>
<ul>
<li>导入的成员签名和现有的成员签名相同时，使用现有的成员。</li>
<li>导入的成员之间出现成员签名相同的情况，使用的时候会编译不通过，需要一处一个 using static 才可，或者改为正常的调用方式。</li>
<li>class,struct,emun 类型可以使用 using static 导入。</li>
<li>静态属性，字段，事件等等，，，静态成员均可依靠 using static 省略类型前缀。</li>
<li>扩展方法也可以使用 using static，但是需要按照实例方法的调用方式来使用。</li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/linianhui/p/csharp6_using-static.html">[C#6] 1-using static</a></p>
<h2 id="Null-条件运算符"><a href="#Null-条件运算符" class="headerlink" title="Null 条件运算符"></a>Null 条件运算符</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果 Person 对象是 null，则将变量 first 赋值为 null。 否则，将 FirstName 属性的值分配给该变量。</span></span><br><span class="line"><span class="keyword">var</span> first = person?.FirstName;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无论 person 的值是什么，以下表达式均返回 string。</span></span><br><span class="line"><span class="comment">// 通常，将此构造与 null coalescing (null 合并) 运算符一起使用</span></span><br><span class="line">first = person?.FirstName ?? <span class="string">&quot;Unspecified&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用该委托</span></span><br><span class="line"><span class="keyword">this</span>.SomethingHappened?.Invoke(<span class="keyword">this</span>, eventArgs);</span><br></pre></td></tr></table></figure>
<h2 id="字符串内插"><a href="#字符串内插" class="headerlink" title="字符串内插"></a>字符串内插</h2><p>关键符号：<code>$&#123;&#125;</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> FullName =&gt; <span class="string">$&quot;<span class="subst">&#123;FirstName&#125;</span> <span class="subst">&#123;LastName&#125;</span>&quot;</span>;</span><br></pre></td></tr></table></figure>
<h2 id="异常筛选器"><a href="#异常筛选器" class="headerlink" title="异常筛选器"></a>异常筛选器</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">MakeRequest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WebRequestHandler webRequestHandler = <span class="keyword">new</span> WebRequestHandler();</span><br><span class="line">    webRequestHandler.AllowAutoRedirect = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">using</span> (HttpClient client = <span class="keyword">new</span> HttpClient(webRequestHandler))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> stringTask = client.GetStringAsync(<span class="string">&quot;https://docs.microsoft.com/en-us/dotnet/about/&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> responseText = <span class="keyword">await</span> stringTask;</span><br><span class="line">            <span class="keyword">return</span> responseText;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (System.Net.Http.HttpRequestException e) <span class="keyword">when</span> (e.Message.Contains(<span class="string">&quot;301&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Site Moved&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="nameof-表达式"><a href="#nameof-表达式" class="headerlink" title="nameof 表达式"></a>nameof 表达式</h2><p>nameof 表达式的计算结果为符号的名称。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (IsNullOrWhiteSpace(lastName))</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(message: <span class="string">&quot;Cannot be blank&quot;</span>, paramName: <span class="keyword">nameof</span>(lastName));</span><br></pre></td></tr></table></figure>
<h2 id="Catch-和-Finally-块中的-Await"><a href="#Catch-和-Finally-块中的-Await" class="headerlink" title="Catch 和 Finally 块中的 Await"></a>Catch 和 Finally 块中的 Await</h2><p>C# 5 对于可放置 await 表达式的位置有若干限制。 使用 C# 6，现在可以在 catch 或 finally 表达式中使用 await。<br>鉴于此行为，建议仔细编写 catch 和 finally 子句，避免引入新的异常。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">MakeRequestAndLogFailures</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">await</span> logMethodEntrance();</span><br><span class="line">    <span class="keyword">var</span> client = <span class="keyword">new</span> System.Net.Http.HttpClient();</span><br><span class="line">    <span class="keyword">var</span> streamTask = client.GetStringAsync(<span class="string">&quot;https://localHost:10000&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> responseText = <span class="keyword">await</span> streamTask;</span><br><span class="line">        <span class="keyword">return</span> responseText;</span><br><span class="line">    &#125; catch (System.Net.Http.HttpRequestException e) <span class="keyword">when</span> (e.Message.Contains(<span class="string">&quot;301&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> logError(<span class="string">&quot;Recovered from redirect&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Site Moved&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> logMethodExit();</span><br><span class="line">        client.Dispose();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用索引器初始化关联集合"><a href="#使用索引器初始化关联集合" class="headerlink" title="使用索引器初始化关联集合"></a>使用索引器初始化关联集合</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原来语法</span></span><br><span class="line"><span class="keyword">private</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; messages = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    &#123; <span class="number">404</span>, <span class="string">&quot;Page not Found&quot;</span>&#125;,</span><br><span class="line">    &#123; <span class="number">302</span>, <span class="string">&quot;Page moved, but left a forwarding address.&quot;</span>&#125;,</span><br><span class="line">    &#123; <span class="number">500</span>, <span class="string">&quot;The web server can&#x27;t come out to play today.&quot;</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新语法支持使用索引分配到集合中：</span></span><br><span class="line"><span class="keyword">private</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; webErrors = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">404</span>] = <span class="string">&quot;Page not Found&quot;</span>,</span><br><span class="line">    [<span class="meta">302</span>] = <span class="string">&quot;Page moved, but left a forwarding address.&quot;</span>,</span><br><span class="line">    [<span class="meta">500</span>] = <span class="string">&quot;The web server can&#x27;t come out to play today.&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>此功能意味着，可以使用与多个版本中已有的序列容器语法类似的语法初始化关联容器。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/whats-new/csharp-6?WT.mc_id=DOP-MVP-5003704">C# 6 中的新增功能</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/29/MongoDB%E5%9C%A8C-%E4%B8%AD%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/29/MongoDB%E5%9C%A8C-%E4%B8%AD%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">MongoDB在C#中使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-29 14:31:05" itemprop="dateCreated datePublished" datetime="2020-09-29T14:31:05+00:00">2020-09-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-13 09:35:52" itemprop="dateModified" datetime="2021-01-13T09:35:52+00:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MongoDB.Bson;</span><br><span class="line"><span class="keyword">using</span> MongoDB.Driver;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MongoDBTest</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> MongoDBConnection = <span class="string">&quot;mongodb://localhost:27017/admin&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> IMongoClient _client = <span class="keyword">new</span> MongoClient(MongoDBConnection);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> IMongoDatabase _database = _client.GetDatabase(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="title">IMongoCollection</span>&lt;<span class="title">CollectionModel</span>&gt; _collection</span> = _database.GetCollection&lt;CollectionModel&gt;(<span class="string">&quot;TestCollection&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// 添加</span></span><br><span class="line">            <span class="keyword">await</span> InsertOneAsyncTest();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;-----------FindAsyncTest输出---------------&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> FindAsyncTest();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;-----------Query输出---------------&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> Query(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;-----------SkipAndSortAndLimitAndProjections输出---------------&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> request = <span class="keyword">new</span> PageRequest &#123;PageIndex = <span class="number">1</span>, PageSize = <span class="number">2</span>&#125;;</span><br><span class="line">            <span class="keyword">await</span> SkipAndSortAndLimitAndProjections(request);</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 查询，支持模糊查询</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;keyword&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Query</span>(<span class="params"><span class="built_in">string</span> keyword</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            FilterDefinitionBuilder&lt;CollectionModel&gt; builder = Builders&lt;CollectionModel&gt;.Filter;</span><br><span class="line">            <span class="built_in">string</span> p = keyword == <span class="literal">null</span> ? <span class="string">$&quot;.*<span class="subst">&#123;Regex.Escape(<span class="string">&quot;&quot;</span>)&#125;</span>.*&quot;</span> : <span class="string">$&quot;.*<span class="subst">&#123;Regex.Escape(keyword)&#125;</span>.*&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//1,条件为空</span></span><br><span class="line">            <span class="comment">//FilterDefinition&lt;CollectionModel&gt; filter2 = FilterDefinition&lt;CollectionModel&gt;.Empty;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//2,不区分大小写</span></span><br><span class="line">            FilterDefinition&lt;CollectionModel&gt; filter2 = builder.Regex(<span class="string">&quot;title&quot;</span>, <span class="keyword">new</span> BsonRegularExpression(<span class="keyword">new</span> Regex(p, RegexOptions.IgnoreCase)));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 以下两种写法区分大小写</span></span><br><span class="line">            <span class="comment">//FilterDefinition&lt;CollectionModel&gt; filter2 = builder.Regex(&quot;title&quot;, new BsonRegularExpression(p));</span></span><br><span class="line">            <span class="comment">//BsonDocument filter2 = new BsonDocument &#123; &#123; &quot;title&quot;, $&quot;/&#123;keyword&#125;/&quot; &#125; &#125;;</span></span><br><span class="line"></span><br><span class="line">            FindOptions&lt;CollectionModel&gt; options = <span class="keyword">new</span> FindOptions&lt;CollectionModel&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                BatchSize = <span class="number">2</span>,</span><br><span class="line">                NoCursorTimeout = <span class="literal">false</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">var</span> cursor = <span class="keyword">await</span> _collection.FindAsync(filter2, options);</span><br><span class="line">            <span class="keyword">var</span> batch = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">await</span> cursor.MoveNextAsync())</span><br><span class="line">            &#123;</span><br><span class="line">                batch++;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;Batch: <span class="subst">&#123;batch&#125;</span>&quot;</span>);</span><br><span class="line">                IEnumerable&lt;CollectionModel&gt; documents = cursor.Current;</span><br><span class="line">                <span class="keyword">foreach</span> (CollectionModel document <span class="keyword">in</span> documents)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(document.ToJson());</span><br><span class="line">                    Console.WriteLine();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Skip, Sort, Limit, Projections</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;request&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">SkipAndSortAndLimitAndProjections</span>(<span class="params">PageRequest request</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">await</span> _collection.Find(FilterDefinition&lt;CollectionModel&gt;.Empty)</span><br><span class="line">                .Skip((request.PageIndex - <span class="number">1</span>) * request.PageSize)</span><br><span class="line">                .Limit(request.PageSize)</span><br><span class="line">                <span class="comment">//.Sort(Builders&lt;CollectionModel&gt;.Sort.Descending(&quot;title&quot;))</span></span><br><span class="line">                <span class="comment">//.Sort(Builders&lt;CollectionModel&gt;.Sort.Descending(x =&gt; x.title).Ascending(x =&gt; x.content))</span></span><br><span class="line">                .Sort(<span class="string">&quot;&#123;title: 1&#125;&quot;</span>)</span><br><span class="line">                .Project(x =&gt; <span class="keyword">new</span> &#123; x.m_id, x.title, x.content, x.userinfo &#125;)</span><br><span class="line">                .ForEachAsync(</span><br><span class="line">                    obj =&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        Console.WriteLine(<span class="string">$&quot;S/N: <span class="subst">&#123;count&#125;</span>, \t Id: <span class="subst">&#123;obj.m_id&#125;</span>, title: <span class="subst">&#123;obj.title&#125;</span>, content: <span class="subst">&#123;obj.content&#125;</span>, serinfo.name: <span class="subst">&#123;obj?.userinfo?.name&#125;</span>&quot;</span>);</span><br><span class="line">                        count++;</span><br><span class="line">                    &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">InsertOneAsyncTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            CollectionModel model = <span class="keyword">new</span> CollectionModel();</span><br><span class="line">            model.title = <span class="string">&quot;A1&quot;</span>;</span><br><span class="line">            model.content = <span class="string">&quot;可以测试&quot;</span>;</span><br><span class="line">            model.userinfo = <span class="keyword">new</span> UserModel</span><br><span class="line">            &#123;</span><br><span class="line">                name = <span class="string">&quot;测试&quot;</span>,</span><br><span class="line">                addressList = <span class="keyword">new</span> List&lt;AddressModel&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">new</span> AddressModel &#123; address = <span class="string">&quot;北京&quot;</span> &#125;,</span><br><span class="line">                    <span class="keyword">new</span> AddressModel &#123; address = <span class="string">&quot;上海&quot;</span> &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">await</span> _collection.InsertOneAsync(model);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">FindAsyncTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">using</span> IAsyncCursor&lt;CollectionModel&gt; cursor = <span class="keyword">await</span> _collection.FindAsync(<span class="keyword">new</span> BsonDocument());</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">await</span> cursor.MoveNextAsync())</span><br><span class="line">            &#123;</span><br><span class="line">                IEnumerable&lt;CollectionModel&gt; batch = cursor.Current;</span><br><span class="line">                <span class="keyword">foreach</span> (CollectionModel document <span class="keyword">in</span> batch)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(document.ToJson());</span><br><span class="line">                    Console.WriteLine();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="公共类"><a href="#公共类" class="headerlink" title="公共类"></a>公共类</h2><p>做通用查询的时候，可以使用。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 公共页面请求参数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PageRequest</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> PageIndex &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> PageSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 公用页面参数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ParameterBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> CollectName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> PageIndex &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> PageSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 公用页面参数-MongoDB</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PageMongoParameter</span> : <span class="title">ParameterBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> BsonDocument Sort &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> BsonDocument Skip &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> BsonDocument Limit &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> BsonDocument Filter2 &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BsonDocument[] Pipeline &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PageMongoParameter</span>(<span class="params">PageRequest req, <span class="built_in">string</span> collectName, BsonDocument filter = <span class="literal">null</span>, </span></span></span><br><span class="line"><span class="function"><span class="params">            BsonDocument sort = <span class="literal">null</span>, BsonDocument filter2 = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        CollectName = collectName;</span><br><span class="line">        PageIndex = req.PageIndex;</span><br><span class="line">        PageSize = req.PageSize;</span><br><span class="line">        Limit = <span class="keyword">new</span> BsonDocument &#123; &#123; <span class="string">&quot;$limit&quot;</span>, PageSize &#125; &#125;;</span><br><span class="line">        Skip = <span class="keyword">new</span> BsonDocument &#123; &#123; <span class="string">&quot;$skip&quot;</span>, (PageIndex - <span class="number">1</span>) * PageSize &#125; &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sort == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(req.Order)) Sort = <span class="keyword">new</span> BsonDocument &#123; &#123; <span class="string">&quot;$sort&quot;</span>, <span class="keyword">new</span> BsonDocument &#123; &#123; req.Order, <span class="number">1</span> &#125; &#125; &#125; &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Sort = sort;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (filter != <span class="literal">null</span> &amp;&amp; filter2 == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> dom = filter.GetElement(<span class="number">0</span>);</span><br><span class="line">            Filter2 = BsonDocument.Parse(dom.Value.ToJson());</span><br><span class="line">        &#125;</span><br><span class="line">        Filter2 ??= <span class="keyword">new</span> BsonDocument();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (filter == <span class="literal">null</span> &amp;&amp; Sort == <span class="literal">null</span>)</span><br><span class="line">            Pipeline = <span class="keyword">new</span>[] &#123; Skip, Limit &#125;;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="literal">null</span> &amp;&amp; Sort != <span class="literal">null</span>)</span><br><span class="line">                Pipeline = <span class="keyword">new</span>[] &#123; filter, Skip, Limit, Sort &#125;;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Pipeline = filter == <span class="literal">null</span> ? <span class="keyword">new</span>[] &#123; Skip, Limit, Sort &#125; : <span class="keyword">new</span>[] &#123; filter, Skip, Limit &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/28/MongoDB%20Dotnet%20Core%E6%95%B0%E6%8D%AE%E6%98%A0%E5%B0%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/28/MongoDB%20Dotnet%20Core%E6%95%B0%E6%8D%AE%E6%98%A0%E5%B0%84/" class="post-title-link" itemprop="url">MongoDB Dotnet Core数据映射</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-28 13:56:36" itemprop="dateCreated datePublished" datetime="2020-09-28T13:56:36+00:00">2020-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-13 09:35:52" itemprop="dateModified" datetime="2021-01-13T09:35:52+00:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>作为一个数据库，基本的操作就是 <code>CRUD</code>。<code>MongoDB</code> 的 <code>CRUD</code>，不使用 <code>SQL</code> 来写，而是提供了更简单的方式。</p>
<p><strong>BsonDocument方式</strong></p>
<p><code>BsonDocument</code> 方式，适合能熟练使用 <code>MongoDB Shell</code> 的开发者。<code>MongoDB Driver</code> 提供了完全覆盖 <code>Shell</code> 命令的各种方式，来处理用户的 <code>CRUD</code> 操作。</p>
<p>这种方法自由度很高，可以在不需要知道完整数据集结构的情况下，完成数据库的CRUD操作。</p>
<p><strong>数据映射方式</strong></p>
<p>数据映射是最常用的一种方式。准备好需要处理的数据类，直接把数据类映射到 <code>MongoDB</code>，并对数据集进行 <code>CRUD</code> 操作。</p>
<h2 id="字段映射"><a href="#字段映射" class="headerlink" title="字段映射"></a>字段映射</h2><h3 id="ID字段"><a href="#ID字段" class="headerlink" title="ID字段"></a>ID字段</h3><p><code>MongoDB</code> 数据集中存放的数据，称之为文档（<code>Document</code>）。每个文档在存放时，都需要有一个ID，而这个 <code>ID</code> 的名称，固定叫 <code>_id</code>，类型是 <code>MongoDB.Bson.ObjectId</code>。</p>
<p>当建立映射时，如果给出 <code>_id</code> 字段，则 <code>MongoDB</code> 会采用这个 <code>ID</code> 做为这个文档的 <code>ID</code> ，如果不给出，<code>MongoDB</code> 会自动添加一个 <code>_id</code> 字段。在使用上是完全一样的。唯一的区别是，如果映射类中不写 <code>_id</code>，则 <code>MongoDB</code> 自动添加 <code>_id</code> 时，会用 <code>ObjectId</code> 作为这个字段的数据类型。</p>
<p><code>ObjectId</code> 是一个全局唯一的数据。</p>
<p><code>MongoDB</code> 允许使用其它类型的数据作为 <code>ID</code>，例如：<code>string</code>，<code>int</code>，<code>long</code>，<code>GUID</code> 等，但这就需要你自己去保证这些数据不超限并且唯一。</p>
<p>可以在类中修改 <code>_id</code> 名称为别的名称，但需要加一个描述属性 <code>BsonId</code>，<code>BsonId</code> 属性会告诉映射，<code>topic_id</code> 就是这个文档数据的<code>ID</code> 。<code>MongoDB</code>在保存时，会将这个 <code>topic_id</code> 转成 <code>_id</code> 保存到数据集中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CollectionModel</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">BsonId</span>]</span><br><span class="line">    <span class="keyword">public</span> ObjectId topic_id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> content &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：在 <code>MongoDB</code> 数据集中，<code>ID</code> 字段的名称固定叫 <code>_id</code>。为了代码的阅读方便，可以在类中改为别的名称，但这不会影响 <code>MongoDB</code> 中存放的 <code>ID</code> 名称。</p>
<h2 id="2-特殊类型-Decimal"><a href="#2-特殊类型-Decimal" class="headerlink" title="2. 特殊类型 - Decimal"></a>2. 特殊类型 - Decimal</h2><p><code>MongoDB</code> 在早期，是不支持 <code>Decimal</code> 的。直到 <code>MongoDB v3.4</code> 开始，数据库才正式支持 <code>Decimal</code>。</p>
<p>所以，如果使用的是 <code>v3.4</code> 以后的版本，可以直接使用，而如果是以前的版本，需要用以下的方式：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonRepresentation(BsonType.Double, AllowTruncation = true)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">decimal</span> price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>
<p>其实就是把 <code>Decimal</code> 通过映射，转为 <code>Double</code> 存储。</p>
<h2 id="类字段"><a href="#类字段" class="headerlink" title="类字段"></a>类字段</h2><p>添加两个类 <code>Contact</code> 和 <code>Author</code>：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Contact</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> mobile &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Author</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;Contact&gt; contacts &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CollectionModel</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">BsonId</span>]</span><br><span class="line">    <span class="keyword">public</span> ObjectId topic_id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> content &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> favor &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> Author author &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">调用 代码:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Demo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CollectionModel new_item = <span class="keyword">new</span> CollectionModel()</span><br><span class="line">    &#123;</span><br><span class="line">        title = <span class="string">&quot;Demo&quot;</span>,</span><br><span class="line">        content = <span class="string">&quot;Demo content&quot;</span>,</span><br><span class="line">        favor = <span class="number">100</span>,</span><br><span class="line">        author = <span class="keyword">new</span> Author</span><br><span class="line">        &#123;</span><br><span class="line">            name = <span class="string">&quot;WangPlus&quot;</span>,</span><br><span class="line">            contacts = <span class="keyword">new</span> List&lt;Contact&gt;(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    Contact contact_item1 = <span class="keyword">new</span> Contact()</span><br><span class="line">    &#123;</span><br><span class="line">        mobile = <span class="string">&quot;13800000000&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    Contact contact_item2 = <span class="keyword">new</span> Contact()</span><br><span class="line">    &#123;</span><br><span class="line">        mobile = <span class="string">&quot;13811111111&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    new_item.author.contacts.Add(contact_item1);</span><br><span class="line">    new_item.author.contacts.Add(contact_item2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> _collection.InsertOneAsync(new_item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文档结构：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5ef1e635ce129908a22dfb5e&quot;</span>), </span><br><span class="line">    <span class="string">&quot;title&quot;</span> : <span class="string">&quot;Demo&quot;</span>, </span><br><span class="line">    <span class="string">&quot;content&quot;</span> : <span class="string">&quot;Demo content&quot;</span>, </span><br><span class="line">    <span class="string">&quot;favor&quot;</span> : NumberInt(<span class="number">100</span>),</span><br><span class="line">    <span class="string">&quot;author&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;WangPlus&quot;</span>, </span><br><span class="line">        <span class="string">&quot;contacts&quot;</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;mobile&quot;</span> : <span class="string">&quot;13800000000&quot;</span></span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;mobile&quot;</span> : <span class="string">&quot;13811111111&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="枚举字段"><a href="#枚举字段" class="headerlink" title="枚举字段"></a>枚举字段</h2><p>创建一个枚举 <code>TagEnumeration</code>:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> TagEnumeration</span><br><span class="line">&#123;</span><br><span class="line">    CSharp = <span class="number">1</span>,</span><br><span class="line">    Python = <span class="number">2</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加到 <code>CollectionModel</code> 中:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CollectionModel</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">BsonId</span>]</span><br><span class="line">    <span class="keyword">public</span> ObjectId topic_id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> content &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> favor &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> Author author &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> TagEnumeration tag &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Demo代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Demo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CollectionModel new_item = <span class="keyword">new</span> CollectionModel()</span><br><span class="line">    &#123;</span><br><span class="line">        title = <span class="string">&quot;Demo&quot;</span>,</span><br><span class="line">        content = <span class="string">&quot;Demo content&quot;</span>,</span><br><span class="line">        favor = <span class="number">100</span>,</span><br><span class="line">        author = <span class="keyword">new</span> Author</span><br><span class="line">        &#123;</span><br><span class="line">            name = <span class="string">&quot;WangPlus&quot;</span>,</span><br><span class="line">            contacts = <span class="keyword">new</span> List&lt;Contact&gt;(),</span><br><span class="line">        &#125;,</span><br><span class="line">        tag = TagEnumeration.CSharp,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    Contact contact_item1 = <span class="keyword">new</span> Contact()</span><br><span class="line">    &#123;</span><br><span class="line">        mobile = <span class="string">&quot;13800000000&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    Contact contact_item2 = <span class="keyword">new</span> Contact()</span><br><span class="line">    &#123;</span><br><span class="line">        mobile = <span class="string">&quot;13811111111&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    new_item.author.contacts.Add(contact_item1);</span><br><span class="line">    new_item.author.contacts.Add(contact_item2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> _collection.InsertOneAsync(new_item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>保存后的文档：注意，<code>tag</code> 保存了枚举的值。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5ef1eb87cbb6b109031fcc31&quot;</span>), </span><br><span class="line">    <span class="string">&quot;title&quot;</span> : <span class="string">&quot;Demo&quot;</span>, </span><br><span class="line">    <span class="string">&quot;content&quot;</span> : <span class="string">&quot;Demo content&quot;</span>, </span><br><span class="line">    <span class="string">&quot;favor&quot;</span> : NumberInt(<span class="number">100</span>), </span><br><span class="line">    <span class="string">&quot;author&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;WangPlus&quot;</span>, </span><br><span class="line">        <span class="string">&quot;contacts&quot;</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;mobile&quot;</span> : <span class="string">&quot;13800000000&quot;</span></span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;mobile&quot;</span> : <span class="string">&quot;13811111111&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">&quot;tag&quot;</span> : NumberInt(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以保存枚举的字符串。只要在 <code>CollectionModel</code> 中，<code>tag</code> 声明上加个属性：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonRepresentation(BsonType.String)</span>]</span><br><span class="line"><span class="keyword">public</span> TagEnumeration tag &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>
<p>数据会变成：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5ef1ec448f1d540919d15904&quot;</span>), </span><br><span class="line">    <span class="string">&quot;title&quot;</span> : <span class="string">&quot;Demo&quot;</span>, </span><br><span class="line">    <span class="string">&quot;content&quot;</span> : <span class="string">&quot;Demo content&quot;</span>, </span><br><span class="line">    <span class="string">&quot;favor&quot;</span> : NumberInt(<span class="number">100</span>), </span><br><span class="line">    <span class="string">&quot;author&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;WangPlus&quot;</span>, </span><br><span class="line">        <span class="string">&quot;contacts&quot;</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;mobile&quot;</span> : <span class="string">&quot;13800000000&quot;</span></span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;mobile&quot;</span> : <span class="string">&quot;13811111111&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">&quot;tag&quot;</span> : <span class="string">&quot;CSharp&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="日期字段"><a href="#日期字段" class="headerlink" title="日期字段"></a>日期字段</h2><p><code>CollectionModel</code> 中增加一个时间字段：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DateTime post_time &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>
<p><code>MongoDB</code> 的 <code>datetime</code> 存储的是 <code>unixtimestamp</code> ，所以默认只能是 <code>utc0</code> 时区的，它问题出在 <code>C#</code> 的 <code>DateTime</code> 对时区的处理上遗留的问题，可以换成 <code>DateTimeOffset</code>。</p>
<p>如果只是保存（像上边这样），或者查询时使用时间作为条件（例如查询 <code>post_time &lt; DateTime.Now</code> 的数据）时，是可以使用的，不会出现问题。</p>
<p>但是，如果是查询结果中有时间字段，那这个字段，会被 <code>DateTime</code> 默认设置为 <code>DateTimeKind.Unspecified</code> 类型。而这个类型，是无时区信息的，输出显示时，会造成混乱。</p>
<p>为了避免这种情况，在进行时间字段的映射时，需要加上属性：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonDateTimeOptions(Kind = DateTimeKind.Local)</span>]</span><br><span class="line"><span class="keyword">public</span> DateTime post_time &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>
<p>这样做，会强制 <code>DateTime</code> 类型的字段为 <code>DateTimeKind.Local</code> 类型。这时候，从显示到使用就正确了。</p>
<p>数据集中存放的是 <code>UTC</code> 时间，跟我们正常的时间有8小时时差，如果我们需要按日统计，比方每天的销售额/点击量。</p>
<p><strong>按年月日时分秒拆开存放</strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Post_Time</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> year &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> month &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> day &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> hour &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> minute &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> second &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>MyDateTimeSerializer</strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyDateTimeSerializer</span> : <span class="title">DateTimeSerializer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> DateTime <span class="title">Deserialize</span>(<span class="params">BsonDeserializationContext context, BsonDeserializationArgs args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> obj = <span class="keyword">base</span>.Deserialize(context, args);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DateTime(obj.Ticks, DateTimeKind.Unspecified);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Serialize</span>(<span class="params">BsonSerializationContext context, BsonSerializationArgs args, DateTime <span class="keyword">value</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> utcValue = <span class="keyword">new</span> DateTime(<span class="keyword">value</span>.Ticks, DateTimeKind.Utc);</span><br><span class="line">        <span class="keyword">base</span>.Serialize(context, args, utcValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：使用这个方法，一定不要添加时间的属性 <code>[BsonDateTimeOptions(Kind = DateTimeKind.Local)]</code></p>
<p>对某个特定映射的特定字段使用，比方只对 <code>CollectionModel</code> 的 <code>post_time</code> 字段来使用，可以这么写：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonSerializer(typeof(MyDateTimeSerializer))</span>]</span><br><span class="line"><span class="keyword">public</span> DateTime post_time &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//或者全局使用：</span></span><br><span class="line"></span><br><span class="line">BsonSerializer.RegisterSerializer(<span class="keyword">typeof</span>(DateTime), <span class="keyword">new</span> MongoDBDateTimeSerializer());</span><br><span class="line"></span><br><span class="line"><span class="comment">// BsonSerializer是 MongoDB.Driver 的全局对象,可以放到使用数据库前的任何地方。例如在Demo中，放在Main里：</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BsonSerializer.RegisterSerializer(<span class="keyword">typeof</span>(DateTime), <span class="keyword">new</span> MyDateTimeSerializer());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> Demo();</span><br><span class="line">    Console.ReadKey();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Dictionary字段"><a href="#Dictionary字段" class="headerlink" title="Dictionary字段"></a>Dictionary字段</h2><p>数据声明很简单：</p>
<p><code>public Dictionary&lt;string, int&gt; extra_info &#123; get; set; &#125;</code></p>
<p><code>MongoDB</code> 定义了三种保存属性：<code>Document</code>、<code>ArrayOfDocuments</code>、<code>ArrayOfArrays</code>，默认是 <code>Document</code>。</p>
<p>属性写法是这样的：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonDictionaryOptions(DictionaryRepresentation.ArrayOfDocuments)</span>]</span><br><span class="line"><span class="keyword">public</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">int</span>&gt; extra_info &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>
<p>这三种属性下，保存在数据集中的数据结构有区别。多数情况用 <code>DictionaryRepresentation.ArrayOfDocuments</code>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DictionaryRepresentation.Document：</span></span><br><span class="line">&#123; </span><br><span class="line">    <span class="attr">&quot;extra_info&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span> : NumberInt(<span class="number">1</span>), </span><br><span class="line">        <span class="attr">&quot;mode&quot;</span> : NumberInt(<span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// DictionaryRepresentation.ArrayOfDocuments：</span></span><br><span class="line">&#123; </span><br><span class="line">    <span class="attr">&quot;extra_info&quot;</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;k&quot;</span> : <span class="string">&quot;type&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;v&quot;</span> : NumberInt(<span class="number">1</span>)</span><br><span class="line">        &#125;, </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;k&quot;</span> : <span class="string">&quot;mode&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;v&quot;</span> : NumberInt(<span class="number">2</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DictionaryRepresentation.ArrayOfArrays：</span></span><br><span class="line">&#123; </span><br><span class="line">    <span class="attr">&quot;extra_info&quot;</span> : [</span><br><span class="line">        [</span><br><span class="line">            <span class="string">&quot;type&quot;</span>, </span><br><span class="line">            NumberInt(<span class="number">1</span>)</span><br><span class="line">        ], </span><br><span class="line">        [</span><br><span class="line">            <span class="string">&quot;mode&quot;</span>, </span><br><span class="line">            NumberInt(<span class="number">2</span>)</span><br><span class="line">        ]</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这三种方式，从数据保存上并没有什么区别，但从查询来讲，如果这个字段需要进行查询，那三种方式区别很大。</p>
<p>如果采用 <code>BsonDocument</code> 方式查询，<code>DictionaryRepresentation.Document</code> 无疑是写着最方便的。</p>
<p>如果用 <code>Builder</code> 方式查询，<code>DictionaryRepresentation.ArrayOfDocuments</code> 是最容易写的。</p>
<p><code>DictionaryRepresentation.ArrayOfArrays</code> 就算了。数组套数组，查询条件写死人。</p>
<h2 id="BsonElement属性"><a href="#BsonElement属性" class="headerlink" title="BsonElement属性"></a>BsonElement属性</h2><p>用来改数据集中的字段名称。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonElement(<span class="meta-string">&quot;pt&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> DateTime post_time &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>
<p>在不加 <code>BsonElement</code> 的情况下，通过数据映射写到数据集中的文档，字段名就是变量名，上面这个例子，字段名就是 <code>post_time</code> 。</p>
<p>加上 <code>BsonElement</code> 后，数据集中的字段名会变为 <code>pt</code>。</p>
<h2 id="BsonDefaultValue属性"><a href="#BsonDefaultValue属性" class="headerlink" title="BsonDefaultValue属性"></a>BsonDefaultValue属性</h2><p>设置字段的默认值。<br>当写入的时候，如果映射中不传入值，则数据库会把这个默认值存到数据集中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonDefaultValue(<span class="meta-string">&quot;This is a default title&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>
<h2 id="BsonRepresentation属性"><a href="#BsonRepresentation属性" class="headerlink" title="BsonRepresentation属性"></a>BsonRepresentation属性</h2><p>用来在映射类中的数据类型和数据集中的数据类型做转换。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonRepresentation(BsonType.String)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> favor &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>
<p>表示，在映射类中，<code>favor</code> 字段是 <code>int</code> 类型的，而存到数据集中，会保存为 <code>string</code> 类型。</p>
<p>前边 <code>Decimal</code> 转换和枚举转换，就是用的这个属性。</p>
<h2 id="BsonIgnore属性"><a href="#BsonIgnore属性" class="headerlink" title="BsonIgnore属性"></a>BsonIgnore属性</h2><p>用来忽略某些字段。<br>忽略的意思是：映射类中某些字段，不希望被保存到数据集中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BsonIgnore</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> ignore_string &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>
<p>这样，在保存数据时，字段 <code>ignore_string</code> 就不会被保存到数据集中。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/M3zdBDc2ci5xfL-fazTH7A">MongoDB via Dotnet Core数据映射详解</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/28/hexo%E6%B7%BB%E5%8A%A0categories%E5%92%8Ctags%E9%A1%B5%E9%9D%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/28/hexo%E6%B7%BB%E5%8A%A0categories%E5%92%8Ctags%E9%A1%B5%E9%9D%A2/" class="post-title-link" itemprop="url">hexo添加categories和tags页面</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-28 10:40:24" itemprop="dateCreated datePublished" datetime="2020-09-28T10:40:24+00:00">2020-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-13 09:35:52" itemprop="dateModified" datetime="2021-01-13T09:35:52+00:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hexo/" itemprop="url" rel="index"><span itemprop="name">Hexo</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>默认是没有 <code>categories</code> 和 <code>tags</code> 的：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo new page <span class="string">&quot;tags&quot;</span></span><br><span class="line">hexo new page <span class="string">&quot;categories&quot;</span></span><br></pre></td></tr></table></figure>
<p>编辑 <code>/tags/index.md</code></p>
<p>添加：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span>: tags</span><br><span class="line">layout: tags</span><br></pre></td></tr></table></figure>
<p><code>/categories/index.md</code></p>
<p>添加：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span>: categories</span><br><span class="line">layout: categories</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/28/%E8%8B%B1%E8%AF%AD%E6%9C%88%E4%BB%BD%E5%8D%95%E8%AF%8D%E7%AE%80%E5%86%99%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/28/%E8%8B%B1%E8%AF%AD%E6%9C%88%E4%BB%BD%E5%8D%95%E8%AF%8D%E7%AE%80%E5%86%99%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">英语月份单词简写记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-28 10:30:20" itemprop="dateCreated datePublished" datetime="2020-09-28T10:30:20+00:00">2020-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-13 09:35:52" itemprop="dateModified" datetime="2021-01-13T09:35:52+00:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8D%95%E8%AF%8D%E6%94%B6%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">单词收录</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>一月 January，缩写 Jan</li>
<li>二月 February，缩写 Feb</li>
<li>三月 March，缩写 Mar</li>
<li>四月 April，缩写 Apr</li>
<li>五月 May，缩写 May</li>
<li>六月 June，缩写 Jun</li>
<li>七月 July，缩写 Jul</li>
<li>八月 August，缩写 Aug</li>
<li>九月 September，缩写 Sep/Sept</li>
<li>十月 October，缩写 Oct</li>
<li>十一月 November，缩写 Nov</li>
<li>十二月 December，缩写 Dec</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/28/linux%E6%9F%A5%E7%9C%8B%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/28/linux%E6%9F%A5%E7%9C%8B%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97/" class="post-title-link" itemprop="url">linux查看系统日志</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-28 10:19:47" itemprop="dateCreated datePublished" datetime="2020-09-28T10:19:47+00:00">2020-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-13 09:35:52" itemprop="dateModified" datetime="2021-01-13T09:35:52+00:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/" itemprop="url" rel="index"><span itemprop="name">Linux基础命令</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="常见文件注解"><a href="#常见文件注解" class="headerlink" title="常见文件注解"></a>常见文件注解</h2><p>linux系统文件通常在 <code>/var/log</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 系统启动后的信息和错误日志</span></span><br><span class="line">/var/<span class="built_in">log</span>/message</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与安全相关的日志信息</span></span><br><span class="line">/var/<span class="built_in">log</span>/secure</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与邮件相关的日志信息</span></span><br><span class="line">/var/<span class="built_in">log</span>/maillog</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与定时任务相关的日志信息</span></span><br><span class="line">/var/<span class="built_in">log</span>/cron</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与UUCP和news设备相关的日志信息</span></span><br><span class="line">/var/<span class="built_in">log</span>/spooler</span><br><span class="line"></span><br><span class="line"><span class="comment"># 守护进程启动和停止相关的日志消息</span></span><br><span class="line">/var/<span class="built_in">log</span>/boot.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久记录每个用户登录、注销及系统的启动、停机的事件</span></span><br><span class="line">/var/<span class="built_in">log</span>/wtmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录当前正在登录系统的用户信息</span></span><br><span class="line">/var/run/utmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录失败的登录尝试信息</span></span><br><span class="line">/var/<span class="built_in">log</span>/btmp</span><br></pre></td></tr></table></figure>
<h2 id="历史记录"><a href="#历史记录" class="headerlink" title="历史记录"></a>历史记录</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看重启的命令</span></span><br><span class="line">last | grep reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 历史操作</span></span><br><span class="line"><span class="built_in">history</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 立即清空当前所有的历史记录</span></span><br><span class="line"><span class="built_in">history</span> -c </span><br></pre></td></tr></table></figure>
<h2 id="最近重启记录"><a href="#最近重启记录" class="headerlink" title="最近重启记录"></a>最近重启记录</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有重启日志信息</span></span><br><span class="line">last reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看最近的一条</span></span><br><span class="line">last reboot | head -1</span><br><span class="line"></span><br><span class="line">last -x|grep shutdown | head -1</span><br><span class="line"></span><br><span class="line"><span class="comment"># -x：显示系统关机和运行等级改变信息</span></span><br><span class="line">last</span><br><span class="line">last -x</span><br><span class="line">last -x reboot</span><br><span class="line">last -x shutdown</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机时间</span></span><br><span class="line">uptime -s</span><br></pre></td></tr></table></figure>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gzy19870815/article/details/88632729">linux系统重启 查看日志及历史记录</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/25/MongoDB-%E9%AB%98%E7%BA%A7%E6%93%8D%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/25/MongoDB-%E9%AB%98%E7%BA%A7%E6%93%8D%E4%BD%9C/" class="post-title-link" itemprop="url">MongoDB 高级操作</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-25 09:53:19" itemprop="dateCreated datePublished" datetime="2020-09-25T09:53:19+00:00">2020-09-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-13 09:35:52" itemprop="dateModified" datetime="2021-01-13T09:35:52+00:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ObjectId"><a href="#ObjectId" class="headerlink" title="ObjectId"></a>ObjectId</h2><p>ObjectId 是一个12字节 <code>BSON</code> 类型数据，有以下格式：</p>
<ul>
<li>前4个字节表示时间戳</li>
<li>接下来的3个字节是机器标识码</li>
<li>紧接的两个字节由进程id组成（PID）</li>
<li>最后三个字节是随机数。</li>
</ul>
<p><code>MongoDB</code> 中存储的文档必须有一个 <code>_id</code> 键。这个键的值可以是任何类型的，默认是个 <code>ObjectId</code> 对象。</p>
<p>在一个集合里面，每个文档都有唯一的 <code>_id</code> 值，来确保集合里面每个文档都能被唯一标识。</p>
<p><code>MongoDB</code> 采用 <code>ObjectId</code>，而不是其他比较常规的做法（比如自动增加的主键）的主要原因，因为在多个服务器上同步自动增加主键值既费力还费时。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.创建新的ObjectId</span></span><br><span class="line">newObjectId = ObjectId()</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">ObjectId(<span class="string">&quot;5f6d62d8b7424d4010318ac6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以使用生成的id来取代MongoDB自动生成的ObjectId：</span></span><br><span class="line">myObjectId = ObjectId(<span class="string">&quot;5f6d62d8b7424d4010318ac6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.创建文档的时间戳</span></span><br><span class="line"><span class="comment"># 由于 ObjectId 中存储了4个字节的时间戳，所以你不需要为你的文档保存时间戳字段，</span></span><br><span class="line"><span class="comment"># 可以通过 getTimestamp 函数来获取文档的创建时间:</span></span><br><span class="line">ObjectId(<span class="string">&quot;5f6d62d8b7424d4010318ac6&quot;</span>).getTimestamp()</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">ISODate(<span class="string">&quot;2020-09-25T03:24:08Z&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.ObjectId 转换为字符串</span></span><br><span class="line">new ObjectId().str</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">5f6d6374b7424d4010318ac7</span><br></pre></td></tr></table></figure>
<h2 id="文档关系"><a href="#文档关系" class="headerlink" title="文档关系"></a>文档关系</h2><p><code>MongoDB</code> 中的关系分为：<code>嵌入式关系</code> 和 <code>引用式关系</code>。</p>
<h3 id="嵌入式关系"><a href="#嵌入式关系" class="headerlink" title="嵌入式关系"></a>嵌入式关系</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;_id&quot;</span>:ObjectId(<span class="string">&quot;52ffc33cd85242f436000001&quot;</span>),</span><br><span class="line">   <span class="attr">&quot;phone&quot;</span>: <span class="string">&quot;123345345&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;address&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">&quot;pincode&quot;</span>: <span class="number">123456</span>,</span><br><span class="line">         <span class="attr">&quot;city&quot;</span>: <span class="string">&quot;beijing&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;state&quot;</span>: <span class="string">&quot;California&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">&quot;pincode&quot;</span>: <span class="number">456789</span>,</span><br><span class="line">         <span class="attr">&quot;city&quot;</span>: <span class="string">&quot;shanghai&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;state&quot;</span>: <span class="string">&quot;Illinois&quot;</span></span><br><span class="line">      &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询：</p>
<p><code>db.users.findOne(&#123;&quot;name&quot;:&quot;test&quot;&#125;,&#123;&quot;address&quot;:1&#125;)</code></p>
<p>这种数据结构的缺点是，如果用户和用户地址在不断增加，数据量不断变大，会影响读写性能。</p>
<h3 id="引用式关系"><a href="#引用式关系" class="headerlink" title="引用式关系"></a>引用式关系</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;_id&quot;</span>:ObjectId(<span class="string">&quot;52ffc33cd85242f436000001&quot;</span>),</span><br><span class="line">   <span class="attr">&quot;contact&quot;</span>: <span class="string">&quot;987654321&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;dob&quot;</span>: <span class="string">&quot;01-01-1991&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;address_ids&quot;</span>: [</span><br><span class="line">      ObjectId(<span class="string">&quot;52ffc4a5d85242602e000000&quot;</span>),</span><br><span class="line">      ObjectId(<span class="string">&quot;52ffc4a5d85242602e000001&quot;</span>)</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var result = db.users.findOne(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;test&quot;</span>&#125;,&#123;<span class="string">&quot;address_ids&quot;</span>:1&#125;)</span><br><span class="line">var addresses = db.address.find(&#123;<span class="string">&quot;_id&quot;</span>:&#123;<span class="string">&quot;<span class="variable">$in</span>&quot;</span>:result[<span class="string">&quot;address_ids&quot;</span>]&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">var result = db.users.find(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;test&quot;</span>&#125;,&#123;<span class="string">&quot;address_ids&quot;</span>:1&#125;)</span><br><span class="line">var addresses = db.address.find(&#123;<span class="string">&quot;_id&quot;</span>:&#123;<span class="string">&quot;<span class="variable">$in</span>&quot;</span>:result[0][<span class="string">&quot;address_ids&quot;</span>]&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>注意：<code>find</code> 返回的数据类型是数组，<code>findOne</code> 返回的数据类型是对象。</p>
<h2 id="引用关系"><a href="#引用关系" class="headerlink" title="引用关系"></a>引用关系</h2><p><code>MongoDB</code> 引用有两种：</p>
<ul>
<li>手动引用（Manual References）</li>
<li>DBRefs</li>
</ul>
<h3 id="DBRefs"><a href="#DBRefs" class="headerlink" title="DBRefs"></a>DBRefs</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># $ref：集合名称</span></span><br><span class="line"><span class="comment"># $id：引用的id</span></span><br><span class="line"><span class="comment"># $db:数据库名称，可选参数</span></span><br><span class="line">&#123; <span class="variable">$ref</span> : , <span class="variable">$id</span> : , <span class="variable">$db</span> :  &#125;</span><br></pre></td></tr></table></figure>
<p>实例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;_id&quot;</span>:ObjectId(<span class="string">&quot;53402597d852426020000002&quot;</span>),</span><br><span class="line">   <span class="attr">&quot;address&quot;</span>: &#123;</span><br><span class="line">   <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;address_home&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;$id&quot;</span>: ObjectId(<span class="string">&quot;534009e4d852427820000002&quot;</span>),</span><br><span class="line">   <span class="attr">&quot;$db&quot;</span>: <span class="string">&quot;runoob&quot;</span>&#125;,</span><br><span class="line">   <span class="attr">&quot;contact&quot;</span>: <span class="string">&quot;987654321&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;dob&quot;</span>: <span class="string">&quot;01-01-1991&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;test1&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var user = db.users.findOne(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;test1&quot;</span>&#125;)</span><br><span class="line">var dbRef = user.address</span><br><span class="line"></span><br><span class="line">db[dbRef.<span class="variable">$ref</span>].findOne(&#123;<span class="string">&quot;_id&quot;</span>:(dbRef.<span class="variable">$id</span>)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># MongoDB4.0 版本写法</span></span><br><span class="line">db[dbRef.<span class="variable">$ref</span>].findOne(&#123;<span class="string">&quot;_id&quot;</span>:ObjectId(dbRef.<span class="variable">$id</span>)&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="覆盖索引查询"><a href="#覆盖索引查询" class="headerlink" title="覆盖索引查询"></a>覆盖索引查询</h2><p>官方的 <code>MongoDB</code> 的文档中说明，覆盖查询是以下的查询：</p>
<ul>
<li>所有的查询字段是索引的一部分</li>
<li>所有的查询返回字段在同一个索引中</li>
</ul>
<p>由于所有出现在查询中的字段是索引的一部分， <code>MongoDB</code> 无需在整个数据文档中检索匹配查询条件和返回使用相同索引的查询结果。<br>因为索引存在于 <code>RAM</code> 中，从索引中获取数据比通过扫描文档读取数据要快得多。</p>
<h3 id="使用覆盖索引查询"><a href="#使用覆盖索引查询" class="headerlink" title="使用覆盖索引查询"></a>使用覆盖索引查询</h3><p>实例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;_id&quot;</span>: ObjectId(<span class="string">&quot;53402597d852426020000002&quot;</span>),</span><br><span class="line">   <span class="attr">&quot;contact&quot;</span>: <span class="string">&quot;987654321&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;dob&quot;</span>: <span class="string">&quot;01-01-1991&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;gender&quot;</span>: <span class="string">&quot;M&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;test1&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;user_name&quot;</span>: <span class="string">&quot;tombenzamin&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>users</code> 集合中创建联合索引，字段为 <code>gender</code> 和 <code>user_name</code> :</p>
<p><code>db.users.createIndex(&#123;gender:1,user_name:1&#125;)</code></p>
<p>该索引会覆盖以下查询：</p>
<p><code>db.users.find(&#123;gender:&quot;M&quot;&#125;,&#123;user_name:1,_id:0&#125;)</code></p>
<p>上述查询，<code>MongoDB</code> 的不会去数据库文件中查找。它会从索引中提取数据，这是非常快速的数据查询。</p>
<p>由于索引中不包括 <code>_id</code> 字段，<code>_id</code> 在查询中会默认返回，我们可以在 <code>MongoDB</code> 的查询结果集中排除它。</p>
<p>下面的实例没有排除 <code>_id</code>，查询就不会被覆盖：</p>
<p><code>db.users.find(&#123;gender:&quot;M&quot;&#125;,&#123;user_name:1&#125;)</code></p>
<p>最后，如果是以下的查询，不能使用覆盖索引查询：</p>
<ul>
<li>所有索引字段是一个数组</li>
<li>所有索引字段是一个子文档</li>
</ul>
<h2 id="查询分析"><a href="#查询分析" class="headerlink" title="查询分析"></a>查询分析</h2><p><code>MongoDB</code> 查询分析常用函数有：<code>explain()</code> 和 <code>hint()</code>。</p>
<h3 id="explain"><a href="#explain" class="headerlink" title="explain()"></a>explain()</h3><p><code>explain</code> 操作提供了查询信息，使用索引及查询统计等。有利于我们对索引的优化。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># users 集合中创建 gender 和 user_name 的索引：</span></span><br><span class="line">db.users.createIndex(&#123;gender:1,user_name:1&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在查询语句中使用 explain ：</span></span><br><span class="line">db.users.find(&#123;gender:<span class="string">&quot;M&quot;</span>&#125;,&#123;user_name:1,_id:0&#125;).explain()</span><br></pre></td></tr></table></figure>
<p> explain() 查询返回:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;cursor&quot;</span> : <span class="string">&quot;BtreeCursor gender_1_user_name_1&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;isMultiKey&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">   <span class="attr">&quot;n&quot;</span> : <span class="number">1</span>,</span><br><span class="line">   <span class="attr">&quot;nscannedObjects&quot;</span> : <span class="number">0</span>,</span><br><span class="line">   <span class="attr">&quot;nscanned&quot;</span> : <span class="number">1</span>,</span><br><span class="line">   <span class="attr">&quot;nscannedObjectsAllPlans&quot;</span> : <span class="number">0</span>,</span><br><span class="line">   <span class="attr">&quot;nscannedAllPlans&quot;</span> : <span class="number">1</span>,</span><br><span class="line">   <span class="attr">&quot;scanAndOrder&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">   <span class="attr">&quot;indexOnly&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">&quot;nYields&quot;</span> : <span class="number">0</span>,</span><br><span class="line">   <span class="attr">&quot;nChunkSkips&quot;</span> : <span class="number">0</span>,</span><br><span class="line">   <span class="attr">&quot;millis&quot;</span> : <span class="number">0</span>,</span><br><span class="line">   <span class="attr">&quot;indexBounds&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;gender&quot;</span> : [</span><br><span class="line">         [</span><br><span class="line">            <span class="string">&quot;M&quot;</span>,</span><br><span class="line">            <span class="string">&quot;M&quot;</span></span><br><span class="line">         ]</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;user_name&quot;</span> : [</span><br><span class="line">         [</span><br><span class="line">            &#123;</span><br><span class="line">               <span class="attr">&quot;$minElement&quot;</span> : <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">               <span class="attr">&quot;$maxElement&quot;</span> : <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">         ]</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果集的字段：</p>
<ul>
<li>indexOnly: 字段为 true ，表示我们使用了索引。</li>
<li>cursor：因为这个查询使用了索引，<code>MongoDB</code> 中索引存储在B树结构中，所以这是也使用了 <code>BtreeCursor</code> 类型的游标。如果没有使用索引，游标的类型是 <code>BasicCursor</code>。这个键还会给出你所使用的索引的名称，你通过这个名称可以查看当前数据库下的 <code>system.indexes</code> 集合（系统自动创建，由于存储索引信息，这个稍微会提到）来得到索引的详细信息。</li>
<li>n：当前查询返回的文档数量。</li>
<li>nscanned/nscannedObjects：表明当前这次查询一共扫描了集合中多少个文档，我们的目的是，让这个数值和返回文档的数量越接近越好。</li>
<li>millis：当前查询所需时间，毫秒数。</li>
<li>indexBounds：当前查询具体使用的索引。</li>
</ul>
<h3 id="hint"><a href="#hint" class="headerlink" title="hint()"></a>hint()</h3><p><code>hint()</code> 来强制 <code>MongoDB</code> 使用一个指定的索引。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.users.find(&#123;gender:<span class="string">&quot;M&quot;</span>&#125;,&#123;user_name:1,_id:0&#125;).hint(&#123;gender:1,user_name:1&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以使用 explain() 函数来分析以上查询：</span></span><br><span class="line">db.users.find(&#123;gender:<span class="string">&quot;M&quot;</span>&#125;,&#123;user_name:1,_id:0&#125;).hint(&#123;gender:1,user_name:1&#125;).explain()</span><br></pre></td></tr></table></figure>
<h2 id="原子操作"><a href="#原子操作" class="headerlink" title="原子操作"></a>原子操作</h2><p><code>MongoDB</code> 提供了许多原子操作，比如文档的保存，修改，删除等，都是原子操作。</p>
<p>所谓原子操作就是要么这个文档保存到 <code>MongoDB</code>，要么没有保存到 <code>MongoDB</code>，不会出现查询到的文档没有保存完整的情况。</p>
<p><code>db.collection.findAndModify()</code> 方法来判断书籍是否可结算并更新新的结算信息。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.books.findAndModify ( &#123;</span><br><span class="line">   query: &#123;</span><br><span class="line">            _id: 123456789,</span><br><span class="line">            available: &#123; <span class="variable">$gt</span>: 0 &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">   update: &#123;</span><br><span class="line">             <span class="variable">$inc</span>: &#123; available: -1 &#125;,</span><br><span class="line">             <span class="variable">$push</span>: &#123; checkout: &#123; by: <span class="string">&quot;abc&quot;</span>, date: new Date() &#125; &#125;</span><br><span class="line">           &#125;</span><br><span class="line">&#125; )</span><br></pre></td></tr></table></figure>
<h3 id="原子操作常用命令"><a href="#原子操作常用命令" class="headerlink" title="原子操作常用命令"></a>原子操作常用命令</h3><p><strong>$set</strong></p>
<p>用来指定一个键并更新键值，若键不存在并创建。</p>
<p><code>&#123; $set : &#123; field : value &#125; &#125;</code></p>
<p><strong>$unset</strong></p>
<p>用来删除一个键。</p>
<p><code>&#123; $unset : &#123; field : 1&#125; &#125;</code></p>
<p><strong>$inc</strong></p>
<p>$inc可以对文档的某个值为数字型（只能为满足要求的数字）的键进行增减的操作。</p>
<p><code>&#123; $inc : &#123; field : value &#125; &#125;</code></p>
<p><strong>$push</strong></p>
<p>把value追加到field里面去，field一定要是数组类型才行，如果field不存在，会新增一个数组类型加进去。</p>
<p><code>&#123; $push : &#123; field : value &#125; &#125;</code></p>
<p><strong>$pushAll</strong></p>
<p>同 <code>$push</code>,只是一次可以追加多个值到一个数组字段内。</p>
<p><code>&#123; $pushAll : &#123; field : value_array &#125; &#125;</code></p>
<p><strong>$pull</strong></p>
<p>从数组field内删除一个等于value值。</p>
<p><code>&#123; $pull : &#123; field : _value &#125; &#125;</code></p>
<p><strong>$addToSet</strong></p>
<p>增加一个值到数组内，而且只有当这个值不在数组内才增加。</p>
<p><strong>$pop</strong></p>
<p>删除数组的第一个或最后一个元素</p>
<p><code>&#123; $pop : &#123; field : 1 &#125; &#125;</code></p>
<p><strong>$rename</strong></p>
<p>修改字段名称</p>
<p><code>&#123; $rename : &#123; old_field_name : new_field_name &#125; &#125;</code></p>
<p><strong>$bit</strong></p>
<p>位操作，integer类型</p>
<p><code>&#123;$bit : &#123; field : &#123;and : 5&#125;&#125;&#125;</code></p>
<p><strong>偏移操作符</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">t.<span class="function"><span class="title">find</span></span>() &#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;4b97e62bf1d8c7152c9ccb74&quot;</span>), <span class="string">&quot;title&quot;</span> : <span class="string">&quot;ABC&quot;</span>, <span class="string">&quot;comments&quot;</span> : [ &#123; <span class="string">&quot;by&quot;</span> : <span class="string">&quot;joe&quot;</span>, <span class="string">&quot;votes&quot;</span> : 3 &#125;, &#123; <span class="string">&quot;by&quot;</span> : <span class="string">&quot;jane&quot;</span>, <span class="string">&quot;votes&quot;</span> : 7 &#125; ] &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 重点</span></span><br><span class="line">t.update( &#123;<span class="string">&#x27;comments.by&#x27;</span>:<span class="string">&#x27;joe&#x27;</span>&#125;, &#123;<span class="variable">$inc</span>:&#123;<span class="string">&#x27;comments.$.votes&#x27;</span>:1&#125;&#125;, <span class="literal">false</span>, <span class="literal">true</span> )</span><br><span class="line"> </span><br><span class="line">t.<span class="function"><span class="title">find</span></span>() &#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;4b97e62bf1d8c7152c9ccb74&quot;</span>), <span class="string">&quot;title&quot;</span> : <span class="string">&quot;ABC&quot;</span>, <span class="string">&quot;comments&quot;</span> : [ &#123; <span class="string">&quot;by&quot;</span> : <span class="string">&quot;joe&quot;</span>, <span class="string">&quot;votes&quot;</span> : 4 &#125;, &#123; <span class="string">&quot;by&quot;</span> : <span class="string">&quot;jane&quot;</span>, <span class="string">&quot;votes&quot;</span> : 7 &#125; ] &#125;</span><br></pre></td></tr></table></figure>
<h2 id="高级索引"><a href="#高级索引" class="headerlink" title="高级索引"></a>高级索引</h2><p>实例 文档集合（users）包含了 <code>address</code> 子文档和 <code>tags</code> 数组：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;address&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;city&quot;</span>: <span class="string">&quot;Los Angeles&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;state&quot;</span>: <span class="string">&quot;California&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;pincode&quot;</span>: <span class="string">&quot;123&quot;</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;music&quot;</span>,</span><br><span class="line">      <span class="string">&quot;cricket&quot;</span>,</span><br><span class="line">      <span class="string">&quot;blogs&quot;</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Tom Benzamin&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="索引数组字段"><a href="#索引数组字段" class="headerlink" title="索引数组字段"></a>索引数组字段</h3><p>在数组中创建索引，需要对数组中的每个字段依次建立索引。所以在我们为数组 <code>tags</code> 创建索引时，会为 <code>music、cricket、blogs</code> 三个值建立单独的索引。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建数组索引：</span></span><br><span class="line"></span><br><span class="line">db.users.createIndex(&#123;<span class="string">&quot;tags&quot;</span>:1&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建索引后，我们可以这样检索集合的 tags 字段：</span></span><br><span class="line">db.users.find(&#123;tags:<span class="string">&quot;cricket&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为了验证我们使用使用了索引，可以使用 explain 命令：</span></span><br><span class="line"><span class="comment"># 执行结果中会显示 &quot;cursor&quot; : &quot;BtreeCursor tags_1&quot; ，则表示已经使用了索引。</span></span><br><span class="line">db.users.find(&#123;tags:<span class="string">&quot;cricket&quot;</span>&#125;).explain()</span><br></pre></td></tr></table></figure>
<h3 id="索引子文档字段"><a href="#索引子文档字段" class="headerlink" title="索引子文档字段"></a>索引子文档字段</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为子文档的三个字段创建索引，命令如下：</span></span><br><span class="line">db.users.createIndex(&#123;<span class="string">&quot;address.city&quot;</span>:1,<span class="string">&quot;address.state&quot;</span>:1,<span class="string">&quot;address.pincode&quot;</span>:1&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一旦创建索引，我们可以使用子文档的字段来检索数据：</span></span><br><span class="line">db.users.find(&#123;<span class="string">&quot;address.city&quot;</span>:<span class="string">&quot;Los Angeles&quot;</span>&#125;)   </span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询表达不一定遵循指定的索引的顺序，mongodb 会自动优化。所以上面创建的索引将支持以下查询：</span></span><br><span class="line">db.users.find(&#123;<span class="string">&quot;address.state&quot;</span>:<span class="string">&quot;California&quot;</span>,<span class="string">&quot;address.city&quot;</span>:<span class="string">&quot;Los Angeles&quot;</span>&#125;) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 同样支持以下查询：</span></span><br><span class="line">db.users.find(&#123;<span class="string">&quot;address.city&quot;</span>:<span class="string">&quot;Los Angeles&quot;</span>,<span class="string">&quot;address.state&quot;</span>:<span class="string">&quot;California&quot;</span>,<span class="string">&quot;address.pincode&quot;</span>:<span class="string">&quot;123&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="索引限制"><a href="#索引限制" class="headerlink" title="索引限制"></a>索引限制</h2><p><strong>额外开销</strong></p>
<p>每个索引占据一定的存储空间，在进行插入，更新和删除操作时也需要对索引进行操作。所以，如果你很少对集合进行读取操作，建议不使用索引。</p>
<p><strong>内存(RAM)使用</strong></p>
<p>由于索引是存储在内存( <code>RAM</code> )中,你应该确保该索引的大小不超过内存的限制。</p>
<p>如果索引的大小大于内存的限制，<code>MongoDB</code> 会删除一些索引，这将导致性能下降。</p>
<p><strong>查询限制</strong></p>
<p>索引不能被以下的查询使用：</p>
<p>正则表达式及非操作符，如 <code>$nin</code>, <code>$not</code>, 等。<br>算术运算符，如 <code>$mod</code>, 等。<br><code>$where</code> 子句<br>所以，检测你的语句是否使用索引是一个好的习惯，可以用 <code>explain</code> 来查看。</p>
<p><strong>索引键限制</strong></p>
<p>从2.6版本开始，如果现有的索引字段的值超过索引键的限制，<code>MongoDB</code> 中不会创建索引。</p>
<p><strong>插入文档超过索引键限制</strong></p>
<p>如果文档的索引字段值超过了索引键的限制，<code>MongoDB</code> 不会将任何文档转换成索引的集合。与 <code>mongorestore</code> 和 <code>mongoimport</code> 工具类似。</p>
<p><strong>最大范围</strong></p>
<p>集合中索引不能超过64个<br>索引名的长度不能超过128个字符<br>一个复合索引最多可以有31个字段</p>
<h2 id="Map-Reduce"><a href="#Map-Reduce" class="headerlink" title="Map Reduce"></a>Map Reduce</h2><p><code>Map-Reduce</code> 是一种计算模型，简单的说就是将大批量的工作（数据）分解（<code>MAP</code>）执行，然后再将结果合并成最终结果（<code>REDUCE</code>）。</p>
<p><code>MongoDB</code> 提供的 <code>Map-Reduce</code> 非常灵活，对于大规模数据分析也相当实用。</p>
<p><code>MapReduce 命令基本语法</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.collection.mapReduce(</span><br><span class="line">   <span class="function"><span class="title">function</span></span>() &#123;emit(key,value);&#125;,  //map 函数</span><br><span class="line">   <span class="keyword">function</span>(key,values) &#123;<span class="built_in">return</span> reduceFunction&#125;,   //reduce 函数</span><br><span class="line">   &#123;</span><br><span class="line">      out: collection,</span><br><span class="line">      query: document,</span><br><span class="line">      sort: document,</span><br><span class="line">      <span class="built_in">limit</span>: number</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>使用 <code>MapReduce</code> 要实现两个函数 <code>Map</code> 函数和 <code>Reduce</code> 函数,<code>Map</code> 函数调用 <code>emit(key, value)</code>, 遍历 <code>collection</code> 中所有的记录, 将 <code>key</code> 与 <code>value</code> 传递给 <code>Reduce</code> 函数进行处理。</p>
<p><code>Map</code> 函数必须调用 <code>emit(key, value)</code> 返回键值对。</p>
<p>参数说明:</p>
<ul>
<li><code>map</code> ：映射函数 (生成键值对序列,作为 <code>reduce</code> 函数参数)。</li>
<li><code>reduce</code> 统计函数，<code>reduce</code> 函数的任务就是将 <code>key-values</code> 变成 <code>key-value</code> ，也就是把 <code>values</code> 数组变成一个单一的值 <code>value</code>。。</li>
<li><code>out</code> 统计结果存放集合 (不指定则使用临时集合，在客户端断开后自动删除)。</li>
<li><code>query</code> 一个筛选条件，只有满足条件的文档才会调用 <code>map</code> 函数。（ <code>query</code>,<code>limit</code>，<code>sort</code>可以随意组合）</li>
<li><code>sort</code> 和 <code>limit</code> 结合的 <code>sort</code> 排序参数（也是在发往 <code>map</code> 函数前给文档排序），可以优化分组机制</li>
<li><code>limit</code> 发往 <code>map</code> 函数的文档数量的上限（要是没有 <code>limit</code>，单独使用 <code>sort</code> 的用处不大）</li>
</ul>
<p>以下实例在集合 <code>orders</code> 中查找 <code>status:&quot;A&quot;</code> 的数据，并根据 <code>cust_id</code> 来分组，并计算 <code>amount</code> 的总和。</p>
<p><img src="/img/map-reduce.bakedsvg.svg" alt="map-reduce.bakedsvg.svg"></p>
<p><strong>使用MapReduce</strong></p>
<p>在 <code>posts</code> 集合中使用 <code>mapReduce</code> 函数来选取已发布的文章(status:”active”)，并通过 <code>user_name</code> 分组，计算每个用户的文章数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">db.posts.mapReduce( </span><br><span class="line">   <span class="function"><span class="title">function</span></span>() &#123; emit(this.user_name,1); &#125;, </span><br><span class="line">   <span class="keyword">function</span>(key, values) &#123;<span class="built_in">return</span> Array.sum(values)&#125;, </span><br><span class="line">      &#123;  </span><br><span class="line">         query:&#123;status:<span class="string">&quot;active&quot;</span>&#125;,  </span><br><span class="line">         out:<span class="string">&quot;post_total&quot;</span> </span><br><span class="line">      &#125;</span><br><span class="line">)</span><br><span class="line">db.post_total.find()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;runoob&quot;</span>, <span class="string">&quot;value&quot;</span> : 1 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;mark&quot;</span>, <span class="string">&quot;value&quot;</span> : 4 &#125;</span><br></pre></td></tr></table></figure>
<h2 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a>全文检索</h2><p>全文检索对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。MongoDB 从 2.4 版本开始支持全文检索，MongoDB 从3.2 版本以后添加了对中文索引的支持。</p>
<p><strong>启用全文检索</strong></p>
<p>MongoDB 在 2.6 版本以后是默认开启全文检索的，如果你使用之前的版本，你需要使用以下代码来启用全文检索:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.adminCommand(&#123;setParameter:<span class="literal">true</span>,textSearchEnabled:<span class="literal">true</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用命令：</span></span><br><span class="line">mongod --setParameter textSearchEnabled=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><strong>创建全文索引</strong></p>
<p>实例：posts 集合的文档数据，包含了文章内容（post_text）及标签(tags)：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="string">&quot;post_text&quot;</span>: <span class="string">&quot;enjoy the mongodb articles on Runoob&quot;</span>,</span><br><span class="line">   <span class="string">&quot;tags&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;mongodb&quot;</span>,</span><br><span class="line">      <span class="string">&quot;runoob&quot;</span></span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对 post_text 字段建立全文索引，这样我们可以搜索文章内的内容：</p>
<p><code>db.posts.createIndex(&#123;post_text:&quot;text&quot;&#125;)</code></p>
<p><strong>使用全文索引</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.posts.find(&#123;<span class="variable">$text</span>:&#123;<span class="variable">$search</span>:<span class="string">&quot;runoob&quot;</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果：</span></span><br><span class="line">&#123; </span><br><span class="line">   <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;53493d14d852429c10000002&quot;</span>), </span><br><span class="line">   <span class="string">&quot;post_text&quot;</span> : <span class="string">&quot;enjoy the mongodb articles on Runoob&quot;</span>, </span><br><span class="line">   <span class="string">&quot;tags&quot;</span> : [ <span class="string">&quot;mongodb&quot;</span>, <span class="string">&quot;runoob&quot;</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>旧版本的 MongoDB，可以使用以下命令：</p>
<p><code>db.posts.runCommand(&quot;text&quot;,&#123;search:&quot;runoob&quot;&#125;)</code></p>
<p>使用全文索引可以提高搜索效率。</p>
<p><strong>删除全文索引</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除已存在的全文索引，可以使用 find 命令查找索引名：</span></span><br><span class="line">db.posts.getIndexes()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行以下命令来删除索引：</span></span><br><span class="line">db.posts.dropIndex(<span class="string">&quot;post_text_text&quot;</span>)</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/23/Linux-CentOS7%E7%A3%81%E7%9B%98%E6%89%A9%E5%85%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/23/Linux-CentOS7%E7%A3%81%E7%9B%98%E6%89%A9%E5%85%85/" class="post-title-link" itemprop="url">Linux-CentOS7磁盘扩充</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-23 17:52:59" itemprop="dateCreated datePublished" datetime="2020-09-23T17:52:59+00:00">2020-09-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-13 09:35:52" itemprop="dateModified" datetime="2021-01-13T09:35:52+00:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux-LVM/" itemprop="url" rel="index"><span itemprop="name">Linux LVM</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建物理卷</span></span><br><span class="line">pvcreate  /dev/vdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扩展卷组</span></span><br><span class="line">vgextend centos /dev/vdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扩展逻辑卷大小</span></span><br><span class="line">lvextend -L +500G /dev/mapper/centos-root</span><br><span class="line"><span class="comment"># 或 将卷组 100% 分配到 逻辑卷unicomvol</span></span><br><span class="line">lvextend -l 100%VG /dev/mapper/centos-root</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认文件系统是xfs</span></span><br><span class="line">cat /etc/fstab | grep centos-root</span><br><span class="line"></span><br><span class="line"><span class="comment"># xfs_growfs: 调整一个 xfs 文件系统大小（只能扩展)</span></span><br><span class="line">xfs_growfs /dev/mapper/centos-root</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选，resize2fs</span></span><br><span class="line"><span class="comment"># resize2fs -p /dev/mapper/centos-root</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">df -hT</span><br></pre></td></tr></table></figure>
<p>xfs 相关：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">xfs_admin: 调整 xfs 文件系统的各种参数</span><br><span class="line">xfs_copy: 拷贝 xfs 文件系统的内容到一个或多个目标系统（并行方式） </span><br><span class="line">xfs_db: 调试或检测 xfs 文件系统（查看文件系统碎片等） </span><br><span class="line">xfs_check: 检测 xfs 文件系统的完整性 </span><br><span class="line">xfs_bmap: 查看一个文件的块映射 </span><br><span class="line">xfs_repair: 尝试修复受损的 xfs 文件系统 </span><br><span class="line">xfs_fsr: 碎片整理 </span><br><span class="line">xfs_quota: 管理 xfs 文件系统的磁盘配额 </span><br><span class="line">xfs_metadump: 将 xfs 文件系统的元数据 (metadata) 拷贝到一个文件中 </span><br><span class="line">xfs_mdrestore: 从一个文件中将元数据 (metadata) 恢复到 xfs 文件系统 </span><br><span class="line">xfs_growfs: 调整一个 xfs 文件系统大小（只能扩展） </span><br><span class="line">xfs_freeze    暂停（-f）和恢复（-u）xfs 文件系统</span><br><span class="line">xfs_logprint: 打印xfs文件系统的日志 </span><br><span class="line">xfs_mkfile: 创建xfs文件系统 </span><br><span class="line">xfs_info: 查询文件系统详细信息 </span><br><span class="line">xfs_ncheck: generate pathnames from i-numbers <span class="keyword">for</span> XFS </span><br><span class="line">xfs_rtcp: XFS实时拷贝命令 </span><br><span class="line">xfs_io: 调试xfs I/O路径</span><br></pre></td></tr></table></figure>
<p>resize2fs 相关</p>
<p>此命令的适用范围：<code>RedHat、RHEL、Ubuntu、CentOS、SUSE、openSUSE、Fedora</code>。</p>
<p>调整 <code>ext2\ext3\ext4</code> 文件系统的大小，它可以放大或者缩小没有挂载的文件系统的大小。如果文件系统已经挂载，它可以扩大文件系统的大小，前提是内核支持在线调整大小。</p>
<p><code>size</code> 参数指定所请求的文件系统的新大小。如果没有指定任何单元，那么 <code>size</code> 参数的单位应该是文件系统的文件系统块大小。<code>size</code> 参数可以由下列单位编号之一后缀：<code>s</code>、<code>K</code>、<code>M</code> 或 <code>G</code>，分别用于512字节扇区、千字节、兆字节或千兆字节。文件系统的大小可能永远不会大于分区的大小。如果未指定 <code>Size</code> 参数，则它将默认为分区的大小。</p>
<p><code>resize2fs</code> 程序不操作分区的大小。如果希望扩大文件系统，必须首先确保可以扩展基础分区的大小。如果您使用逻辑卷管理器 <code>LVM(8)</code> ，可以使用 <code>fdisk(8)</code> 删除分区并以更大的大小重新创建它，或者使用 <code>lvexport(8)</code> 。在重新创建分区时，请确保使用与以前相同的启动磁盘圆柱来创建分区！否则，调整大小操作肯定无法工作，您可能会丢失整个文件系统。运行 <code>fdisk(8)</code> 后，运行 <code>resize2fs</code> 来调整 <code>ext 2</code>文件系统的大小，以使用新扩大的分区中的所有空间。</p>
<p>如果希望缩小 <code>ext2</code> 分区，请首先使用 <code>resize2fs</code> 缩小文件系统的大小。然后可以使用 <code>fdisk(8)</code> 缩小分区的大小。缩小分区大小时，请确保不使其小于 <code>ext2</code> 文件系统的新大小。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 语法相关</span></span><br><span class="line">resize2fs  [选项]  device  [size]</span><br><span class="line">resize2fs  [ -fFpPM ]  [ -d debug-flags ]  [ -S RAID-stride ]  device  [ size ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 选项列表</span></span><br><span class="line">-d debug-flags</span><br><span class="line">    打开各种resize2fs调试特性，如果它们已经编译成二进制文件的话。调试标志应该通过从以下列表中添加所需功能的数量来计算：</span><br><span class="line">    2，调试块重定位。</span><br><span class="line">    4，调试iNode重定位。</span><br><span class="line">    8，调试移动inode表。</span><br><span class="line">-f  强制执行，覆盖一些通常强制执行的安全检查。</span><br><span class="line">-F  执行之前，刷新文件系统的缓冲区</span><br><span class="line">-M  将文件系统缩小到最小值</span><br><span class="line">-p  显示已经完成任务的百分比</span><br><span class="line">-P  显示文件系统的最小值</span><br><span class="line">-S RAID-stride</span><br></pre></td></tr></table></figure>
<p><code>resize2fs</code> 程序将启发式地确定在创建文件系统时指定的 <code>RAID</code> 步长。此选项允许用户显式地指定 <code>RAID</code> 步长设置，以便由 <code>resize2fs</code> 代替。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/23/Linux-red-hat-CentOS7%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/23/Linux-red-hat-CentOS7%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99/" class="post-title-link" itemprop="url">Linux Red hat/CentOS7关闭防火墙</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-23 11:06:19" itemprop="dateCreated datePublished" datetime="2020-09-23T11:06:19+00:00">2020-09-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-13 09:35:52" itemprop="dateModified" datetime="2021-01-13T09:35:52+00:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看防火状态</span></span><br><span class="line"><span class="comment"># CentOS7</span></span><br><span class="line">systemctl status firewalld</span><br><span class="line"><span class="comment"># Red hat</span></span><br><span class="line">service iptables status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂时关闭防火墙</span></span><br><span class="line"><span class="comment"># CentOS7</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="comment"># Red hat</span></span><br><span class="line">service iptables stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启防火墙</span></span><br><span class="line"><span class="comment"># CentOS7</span></span><br><span class="line">systemctl <span class="built_in">enable</span> firewalld</span><br><span class="line"><span class="comment"># Red hat</span></span><br><span class="line">service iptables restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久关闭防火墙</span></span><br><span class="line"><span class="comment"># CentOS7</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"><span class="comment"># Red hat</span></span><br><span class="line">chkconfig iptables off</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/22/MongoDB-%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/22/MongoDB-%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5/" class="post-title-link" itemprop="url">MongoDB 增删改查</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-22 16:25:18" itemprop="dateCreated datePublished" datetime="2020-09-22T16:25:18+00:00">2020-09-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-13 09:35:52" itemprop="dateModified" datetime="2021-01-13T09:35:52+00:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="MongoDB-连接"><a href="#MongoDB-连接" class="headerlink" title="MongoDB 连接"></a>MongoDB 连接</h2><p>标准 URI 连接语法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>mongodb:// 这是固定的格式，必须要指定。</p>
</li>
<li><p>username:password@ 可选项，如果设置，在连接数据库服务器之后，驱动都会尝试登录这个数据库</p>
</li>
<li><p>host1 必须的指定至少一个host, host1 是这个URI唯一要填写的。它指定了要连接服务器的地址。如果要连接复制集，请指定多个主机地址。</p>
</li>
<li><p>portX 可选的指定端口，如果不填，默认为27017</p>
</li>
<li><p>/database 如果指定username:password@，连接并验证登录指定数据库。若不指定，默认打开 test 数据库。</p>
</li>
<li><p>?options 是连接选项。如果不使用 <code>/database</code>，则前面需要加上/。所有连接选项都是键值对name=value，键值对之间通过&amp;或;（分号）隔开</p>
</li>
</ul>
<p>标准的连接格式包含了多个选项(options):</p>
<p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200922163649.png" alt="微信截图_20200922163649.png"></p>
<h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><p><strong>语法格式</strong></p>
<p>MongoDB 创建数据库的语法格式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use DATABASE_NAME</span><br></pre></td></tr></table></figure>
<p><strong>实例</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> use test1</span><br><span class="line">switched <span class="keyword">to</span> db test1</span><br><span class="line"><span class="operator">&gt;</span> db</span><br><span class="line">test1</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">show</span> dbs</span><br><span class="line">admin   <span class="number">0.000</span>GB</span><br><span class="line">config  <span class="number">0.000</span>GB</span><br><span class="line"><span class="keyword">local</span>   <span class="number">0.000</span>GB</span><br><span class="line">&gt; db.test1.insert(&#123;&quot;name&quot;:&quot;test1&quot;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">show</span> dbs</span><br><span class="line">admin   <span class="number">0.000</span>GB</span><br><span class="line">config  <span class="number">0.000</span>GB</span><br><span class="line"><span class="keyword">local</span>   <span class="number">0.000</span>GB</span><br><span class="line">test1   <span class="number">0.000</span>GB</span><br></pre></td></tr></table></figure>
<p>如果数据库不存在，则创建数据库，否则切换到指定数据库。</p>
<p>ongoDB 中默认的数据库为 test，如果你没有创建新的数据库，集合将存放在 test 数据库中。</p>
<p>注意: 在 MongoDB 中，集合只有在内容插入后才会创建! 就是说，创建集合(数据表)后要再插入一个文档(记录)，集合才会真正创建。</p>
<h2 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h2><p><strong>语法格式</strong></p>
<p>MongoDB 删除数据库的语法格式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.dropDatabase()</span><br></pre></td></tr></table></figure>
<p>删除当前数据库，默认为 test，你可以使用 db 命令查看当前数据库名。</p>
<p><strong>实例</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> use test1</span><br><span class="line">switched <span class="keyword">to</span> db test1</span><br><span class="line"><span class="operator">&gt;</span> db.dropDatabase()</span><br><span class="line">&#123; &quot;dropped&quot; : &quot;test1&quot;, &quot;ok&quot; : 1 &#125;</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">show</span> dbs</span><br><span class="line">admin   <span class="number">0.000</span>GB</span><br><span class="line">config  <span class="number">0.000</span>GB</span><br><span class="line"><span class="keyword">local</span>   <span class="number">0.000</span>GB</span><br></pre></td></tr></table></figure>
<h2 id="创建集合"><a href="#创建集合" class="headerlink" title="创建集合"></a>创建集合</h2><p><strong>语法格式</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection(name, options)</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li>name: 要创建的集合名称</li>
<li>options: 可选参数, 指定有关内存大小及索引的选项</li>
</ul>
<p>options 可以是如下参数</p>
<p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200922165116.png" alt="微信截图_20200922165116.png"></p>
<p>在插入文档时，MongoDB 首先检查固定集合的 size 字段，然后检查 max 字段。</p>
<p>在 MongoDB 中，你不需要创建集合。当你插入一些文档时，MongoDB 会自动创建集合。</p>
<p>可以使用 <code>show collections</code> 或 <code>show tables</code> 命令查看已有集合。</p>
<h2 id="删除集合"><a href="#删除集合" class="headerlink" title="删除集合"></a>删除集合</h2><p><strong>语法格式：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.drop()</span><br></pre></td></tr></table></figure>
<p>如果成功删除选定集合，则 drop() 方法返回 true，否则返回 false。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.createCollection(<span class="string">&quot;test1&quot;</span>)</span><br><span class="line">&#123; <span class="string">&quot;ok&quot;</span> : 1 &#125;</span><br><span class="line">&gt; db.test1.drop()</span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="插入文档"><a href="#插入文档" class="headerlink" title="插入文档"></a>插入文档</h2><p>所有存储在集合中的数据都是 BSON 格式。</p>
<p>BSON 是一种类似 JSON 的二进制形式的存储格式，是 Binary JSON 的简称。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 若插入的数据主键已经存在，则会抛 org.springframework.dao.DuplicateKeyException 异常，提示主键重复，不保存当前数据。</span></span><br><span class="line">db.COLLECTION_NAME.insert(document)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 该方法新版本中已废弃</span></span><br><span class="line">db.COLLECTION_NAME.save(document)</span><br></pre></td></tr></table></figure>

<p>3.2 版本之后新增insertOne,insertMany</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参数说明：</span></span><br><span class="line"><span class="comment"># document：要写入的文档。</span></span><br><span class="line"><span class="comment"># writeConcern：写入策略，默认为 1，即要求确认写操作，0 是不要求。</span></span><br><span class="line"><span class="comment"># ordered：指定是否按顺序写入，默认 true，按顺序写入。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 向集合插入一个新文档</span></span><br><span class="line">db.collection.insertOne(</span><br><span class="line">   &lt;document&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">      writeConcern: &lt;document&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 向集合插入一个多个文档</span></span><br><span class="line">db.collection.insertMany(</span><br><span class="line">   [ &lt;document 1&gt; , &lt;document 2&gt;, ... ],</span><br><span class="line">   &#123;</span><br><span class="line">      writeConcern: &lt;document&gt;,</span><br><span class="line">      ordered: &lt;boolean&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="异常级别"><a href="#异常级别" class="headerlink" title="异常级别"></a>异常级别</h2><ul>
<li>WriteConcern.NONE:没有异常抛出</li>
<li>WriteConcern.NORMAL:仅抛出网络错误异常，没有服务器错误异常</li>
<li>WriteConcern.SAFE:抛出网络错误异常、服务器错误异常；并等待服务器完成写操作。</li>
<li>WriteConcern.MAJORITY: 抛出网络错误异常、服务器错误异常；并等待一个主服务器完成写操作。</li>
<li>WriteConcern.FSYNC_SAFE: 抛出网络错误异常、服务器错误异常；写操作等待服务器将数据刷新到磁盘。</li>
<li>WriteConcern.JOURNAL_SAFE:抛出网络错误异常、服务器错误异常；写操作等待服务器提交到磁盘的日志文件。</li>
<li>WriteConcern.REPLICAS_SAFE:抛出网络错误异常、服务器错误异常；等待至少2台服务器完成写操作。</li>
</ul>
<h2 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h2><h3 id="update-方法"><a href="#update-方法" class="headerlink" title="update() 方法"></a>update() 方法</h3><p><strong>语法格式</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.collection.update(</span><br><span class="line">   &lt;query&gt;,</span><br><span class="line">   &lt;update&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">     upsert: &lt;boolean&gt;,</span><br><span class="line">     multi: &lt;boolean&gt;,</span><br><span class="line">     writeConcern: &lt;document&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li>query : update的查询条件，类似sql update查询内where后面的。</li>
<li>update : update的对象和一些更新的操作符（如$,$inc…）等，也可以理解为sql update查询内set后面的</li>
<li>upsert : 可选，这个参数的意思是，如果不存在update的记录，是否插入objNew,true为插入，默认是false，不插入。</li>
<li>multi : 可选，mongodb 默认是false,只更新找到的第一条记录，如果这个参数为true,就把按条件查出来多条记录全部更新。</li>
<li>writeConcern :可选，抛出异常的级别。</li>
</ul>
<p><strong>实例</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.test1.update(&#123;<span class="string">&#x27;title&#x27;</span>:<span class="string">&#x27;MongoDB 教程&#x27;</span>&#125;,&#123;<span class="variable">$set</span>:&#123;<span class="string">&#x27;title&#x27;</span>:<span class="string">&#x27;MongoDB&#x27;</span>&#125;&#125;)</span><br><span class="line">db.test1.find().pretty()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以上语句只会修改第一条发现的文档，如果你要修改多条相同的文档，</span></span><br><span class="line"><span class="comment"># 则需要设置 multi 参数为 true。</span></span><br><span class="line">db.test1.update(&#123;<span class="string">&#x27;title&#x27;</span>:<span class="string">&#x27;MongoDB 教程&#x27;</span>&#125;,&#123;<span class="variable">$set</span>:&#123;<span class="string">&#x27;title&#x27;</span>:<span class="string">&#x27;MongoDB&#x27;</span>&#125;&#125;,&#123;multi:<span class="literal">true</span>&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="save-方法"><a href="#save-方法" class="headerlink" title="save() 方法"></a>save() 方法</h3><p>save() 方法通过传入的文档来替换已有文档，_id 主键存在就更新，不存在就插入。</p>
<p><strong>语法格式如下：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.collection.save(</span><br><span class="line">   &lt;document&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">     writeConcern: &lt;document&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li>document : 文档数据。</li>
<li>writeConcern :可选，抛出异常的级别。</li>
</ul>
<p>在3.2版本开始，MongoDB提供以下更新集合文档的方法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 向指定集合更新单个文档</span></span><br><span class="line">db.collection.updateOne()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 向指定集合更新多个文档</span></span><br><span class="line">db.collection.updateMany()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移除集合中的键值对，使用的 $unset 操作符：</span></span><br><span class="line">db.col.update(&#123;<span class="string">&quot;_id&quot;</span>:<span class="string">&quot;56064f89ade2f21f36b03136&quot;</span>&#125;, &#123;<span class="variable">$set</span>:&#123; <span class="string">&quot;test2&quot;</span> : <span class="string">&quot;OK&quot;</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line">db.col.update(&#123;<span class="string">&quot;_id&quot;</span>:<span class="string">&quot;56064f89ade2f21f36b03136&quot;</span>&#125;, &#123;<span class="variable">$unset</span>:&#123; <span class="string">&quot;test2&quot;</span> : <span class="string">&quot;OK&quot;</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h2><p>MongoDB 最早删除文档使用的是 <code>remove()</code> 方法，后来官方把它移除了因为 <code>remove()</code> 并不会真正释放空间。需要继续执行 <code>db.repairDatabase()</code> 来回收磁盘空间。</p>
<p>建议在执行删除文档函数前先执行 <code>find()</code> 命令来判断执行的条件是否正确 <code>db.test1.find()</code> 。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.repairDatabase()</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">db.runCommand(&#123;repairDatabase: 1&#125;)</span><br></pre></td></tr></table></figure>
<p>官方推荐使用 <code>deleteOne()</code> 和 <code>deleteMany()</code> 方法。</p>
<p><strong>语法</strong></p>
<p><code>deleteOne()</code> 语法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.collection.deleteOne(</span><br><span class="line">   &lt;filter&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">      writeConcern: &lt;document&gt;,</span><br><span class="line">      collation: &lt;document&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><code>deleteMany()</code> 语法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.collection.deleteMany(</span><br><span class="line">   &lt;filter&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">      writeConcern: &lt;document&gt;,</span><br><span class="line">      collation: &lt;document&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除集合下全部文档</span></span><br><span class="line">db.inventory.deleteMany(&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 status 等于 A 的全部文档</span></span><br><span class="line">db.inventory.deleteMany(&#123; status : <span class="string">&quot;A&quot;</span> &#125;)</span><br></pre></td></tr></table></figure>
<h2 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h2><p>MongoDB 查询文档使用 <code>find()</code>, <code>findOne()</code> 方法。</p>
<p><code>find()</code> 方法以非结构化的方式来显示所有文档。</p>
<p><strong>语法格式</strong></p>
<p><code>db.collection.find(query, projection)</code></p>
<ul>
<li>query ：可选，使用查询操作符指定查询条件</li>
<li>projection ：可选，使用投影操作符指定返回的键。若不指定 projection，则默认返回所有键（默认省略）。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># projection入参格式为&#123;columnA : 0/1,columnB : 0/1&#125;</span></span><br><span class="line"><span class="comment"># columnA 和 columnB 表示你要查询的表中的字段，0/1 表示取或不取。</span></span><br><span class="line">db.collection.find(query, projection)</span><br></pre></td></tr></table></figure>
<p>如：<code>&#123;title:1&#125;</code>，表示查询出的每条记录中只显示 title 字段内容。<code>&#123;description:0&#125;</code>，表示查询出的每条记录中不显示 description 字段内容(其他字段都展示)。</p>
<p>注：_id(主键)字段默认为 1，可指定 {_id:0} 来不输出 _id 字段值。</p>
<p>指定 <code>projection</code> 格式如下，有两种模式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(query, &#123;title: 1, by: 1&#125;) // inclusion模式 指定返回的键，不返回其他键</span><br><span class="line">db.collection.find(query, &#123;title: 0, by: 0&#125;) // exclusion模式 指定不返回的键,返回其他键</span><br></pre></td></tr></table></figure>
<p>两种模式不可混用（因为这样的话无法推断其他键是否应返回）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(query, &#123;title: 1, by: 0&#125;) <span class="comment"># 错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只能全1或全0，除了在inclusion模式时可以指定_id为0</span></span><br><span class="line">db.collection.find(query, &#123;_id:0, title: 1, by: 1&#125;) <span class="comment"># 正确</span></span><br></pre></td></tr></table></figure>
<p>若不想指定查询条件参数 <code>query</code> 可以 用 <code>&#123;&#125;</code> 代替，但是需要指定 <code>projection</code> 参数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">querydb.collection.find(&#123;&#125;, &#123;title: 1&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>AND 条件</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.test1.find(&#123;key1:value1, key2:value2&#125;).pretty()</span><br></pre></td></tr></table></figure>
<p><strong>OR 条件</strong></p>
<p>使用关键字 <code>$or</code>,语法格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.test1.find(</span><br><span class="line">   &#123;</span><br><span class="line">      $or: [</span><br><span class="line">         &#123;key1: value1&#125;, &#123;key2:value2&#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">).pretty()</span><br></pre></td></tr></table></figure>
<p><strong>AND 和 OR 联合使用</strong></p>
<p><code>where likes&gt;50 AND (by = &#39;test1&#39; OR title = &#39;MongoDB&#39;)</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.test1.find(&#123;<span class="string">&quot;likes&quot;</span>: &#123;<span class="variable">$gt</span>:50&#125;, <span class="variable">$or</span>: [&#123;<span class="string">&quot;by&quot;</span>: <span class="string">&quot;test1&quot;</span>&#125;,&#123;<span class="string">&quot;title&quot;</span>: <span class="string">&quot;MongoDB&quot;</span>&#125;]&#125;).pretty()</span><br></pre></td></tr></table></figure>
<p><strong>模糊查询</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询 title 包含&quot;教&quot;字的文档：</span></span><br><span class="line">db.col.find(&#123;title:/教/&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询 title 字段以&quot;教&quot;字开头的文档：</span></span><br><span class="line">db.col.find(&#123;title:/^教/&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询 titl e字段以&quot;教&quot;字结尾的文档：</span></span><br><span class="line">db.col.find(&#123;title:/教$/&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="条件操作符"><a href="#条件操作符" class="headerlink" title="条件操作符"></a>条件操作符</h2><p>结合查询语句使用。</p>
<ul>
<li>$gt — greater than  &gt;</li>
<li>$gte — gt equal  &gt;=</li>
<li>$lt — less than  &lt;</li>
<li>$lte — lt equal  &lt;=</li>
<li>$ne — not equal  !=</li>
<li>$eq —  equal  =</li>
</ul>
<h2 id="type-操作符"><a href="#type-操作符" class="headerlink" title="$type 操作符"></a>$type 操作符</h2><p><code>$type</code> 操作符是基于BSON类型来检索集合中匹配的数据类型，并返回结果。</p>
<p>获取 <code>test1</code> 集合中 title 为 String 的数据</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.test1.find(&#123;<span class="string">&quot;title&quot;</span> : &#123;<span class="variable">$type</span> : 2&#125;&#125;)</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">db.test1.find(&#123;<span class="string">&quot;title&quot;</span> : &#123;<span class="variable">$type</span> : <span class="string">&#x27;string&#x27;</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="Limit与Skip方法"><a href="#Limit与Skip方法" class="headerlink" title="Limit与Skip方法"></a>Limit与Skip方法</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Limit() 方法</span></span><br><span class="line">db.COLLECTION_NAME.find().<span class="built_in">limit</span>(NUMBER)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果你们没有指定limit()方法中的参数则显示集合中的所有数据。</span></span><br><span class="line">db.test1.find(&#123;&#125;,&#123;<span class="string">&quot;title&quot;</span>:1,_id:0&#125;).<span class="built_in">limit</span>(2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Skip() 方法</span></span><br><span class="line"><span class="comment"># skip()方法默认参数为 0</span></span><br><span class="line">db.COLLECTION_NAME.find().<span class="built_in">limit</span>(NUMBER).skip(NUMBER)</span><br></pre></td></tr></table></figure>
<p>skip 和limit方法只适合小数据量分页，如果是百万级效率就会非常低，因为skip方法是一条条数据数过去的，建议使用 <code>where limit</code>。</p>
<h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><p><code>sort()</code> 方法对数据进行排序，<code>sort()</code> 方法可以通过参数指定排序的字段，并使用 1 和 -1 来指定排序的方式，其中 1 为升序排列，而 -1 是用于降序排列。</p>
<p>语法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 语法</span></span><br><span class="line">db.COLLECTION_NAME.find().sort(&#123;KEY:1&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例</span></span><br><span class="line"><span class="comment"># 按字段 likes 的降序排列</span></span><br><span class="line">db.test1.find(&#123;&#125;,&#123;<span class="string">&quot;title&quot;</span>:1,_id:0&#125;).sort(&#123;<span class="string">&quot;likes&quot;</span>:-1&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p>3.0.0 版本前创建索引方法为 <code>db.collection.ensureIndex()</code> ，之后的版本使用了 <code>db.collection.createIndex()</code> 方法，<code>ensureIndex()</code> 还能用，但只是 <code>createIndex()</code> 的别名。</p>
<p><strong>语法</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.collection.createIndex(keys, options)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例</span></span><br><span class="line">db.test1.createIndex(&#123;<span class="string">&quot;title&quot;</span>:1&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以设置使用多个字段创建索引（关系型数据库中称作复合索引）</span></span><br><span class="line">db.test1.createIndex(&#123;<span class="string">&quot;title&quot;</span>:1,<span class="string">&quot;description&quot;</span>:-1&#125;)</span><br></pre></td></tr></table></figure>
<p>语法中 Key 值为你要创建的索引字段，1 为指定按升序创建索引 -1 按降序来创建索引。</p>
<p>可选参数:</p>
<p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200924134809.png" alt="微信截图_20200924134809.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集合索引</span></span><br><span class="line">db.test1.getIndexes()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集合索引大小</span></span><br><span class="line">db.test1.totalIndexSize()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除集合所有索引</span></span><br><span class="line">db.test1.dropIndexes()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除集合指定索引</span></span><br><span class="line">db.test1.dropIndex(<span class="string">&quot;索引名称&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="TTL索引"><a href="#TTL索引" class="headerlink" title="TTL索引"></a>TTL索引</h3><p>保存最近三个月的文档（单位秒），当中途修改了createdAt的值时，<br>则不会删除文档（指定的时间是字段与当前时间的差值）。</p>
<p><code>db.user.createIndex(&#123;&quot;createdAt&quot;: 1&#125;,&#123;expireAfterSeconds: 60*60*24*3&#125;);</code></p>
<p>若需求变动，需要将三个月修改为一个月可以使用collMod，如下：</p>
<p><code>db.runCommand(&#123;collMod: &#39;user&#39;, index: &#123;keyPattern:&#123;&quot;createdAt&quot;: 1&#125;, expireAfterSeconds:60*60*24*1&#125;&#125;);</code></p>
<p>TTL索引限制：</p>
<ul>
<li>TTL索引是单字段索引，不能使用在聚合索引上</li>
<li>不能在普通索引上再创建TTL索引，只能删除再建</li>
<li>_id主键上不能建立TTL索引</li>
<li>一个集合上可以建立多个TTL索引</li>
<li>索引不能包含多个字段</li>
<li>TTL索引可以用于普通索引一样进行排序和查询</li>
<li>如果定义的字段不存在，则永不过期</li>
<li>不能对capped集合创建TTL索引</li>
<li>TTL索引会每分钟检查超时文档，并进行删除操作。需要注意删除时候的并发问题（不要影响线上业务）</li>
</ul>
<h2 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h2><p>MongoDB中聚合( <code>aggregate</code> )主要用于处理数据(诸如统计平均值,求和等)，并返回计算后的数据结果。有点类似sql语句中的 <code>count(*)</code>。</p>
<p><strong>aggregate() 方法</strong></p>
<p><code>db.COLLECTION_NAME.aggregate(AGGREGATE_OPERATION)</code></p>
<p>聚合的表达式：</p>
<p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200924142403.png" alt="微信截图_20200924142403.png"></p>
<p>实例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">db.test1.aggregate([&#123;<span class="variable">$group</span> : &#123;_id : <span class="string">&quot;<span class="variable">$by_user</span>&quot;</span>, num_tutorial : &#123;<span class="variable">$sum</span> : 1&#125;&#125;&#125;])</span><br><span class="line"><span class="comment"># 类似：</span></span><br><span class="line">select by_user, count(*) from mycol group by by_user</span><br><span class="line"></span><br><span class="line"><span class="comment"># $project实例</span></span><br><span class="line"><span class="comment"># 只展示_id,tilte和author三个字段</span></span><br><span class="line">db.article.aggregate(</span><br><span class="line">    &#123; <span class="variable">$project</span> : &#123;</span><br><span class="line">        title : 1 ,</span><br><span class="line">        author : 1 ,</span><br><span class="line">    &#125;&#125;</span><br><span class="line"> );</span><br><span class="line"></span><br><span class="line"><span class="comment"># $match实例</span></span><br><span class="line">db.article.aggregate(</span><br><span class="line">    &#123; <span class="variable">$project</span> : &#123;</span><br><span class="line">        _id : 0 ,</span><br><span class="line">        title : 1 ,</span><br><span class="line">        author : 1</span><br><span class="line">    &#125;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment"># $match实例</span></span><br><span class="line">db.articles.aggregate( [</span><br><span class="line">                        &#123; <span class="variable">$match</span> : &#123; score : &#123; <span class="variable">$gt</span> : 70, <span class="variable">$lte</span> : 90 &#125; &#125; &#125;,</span><br><span class="line">                        &#123; <span class="variable">$group</span>: &#123; _id: null, count: &#123; <span class="variable">$sum</span>: 1 &#125; &#125; &#125;</span><br><span class="line">                       ] );</span><br></pre></td></tr></table></figure>
<h2 id="管道操作"><a href="#管道操作" class="headerlink" title="管道操作"></a>管道操作</h2><p><code>MongoDB</code> 的聚合管道将 <code>MongoDB</code> 文档在一个管道处理完毕后将结果传递给下一个管道处理。管道操作是可以重复的。</p>
<ul>
<li>$project：修改输入文档的结构。可以用来重命名、增加或删除域，也可以用于创建计算结果以及嵌套文档。</li>
<li>$match：用于过滤数据，只输出符合条件的文档。<code>$match</code> 使用 <code>MongoDB</code> 的标准查询操作。</li>
<li>$limit：用来限制 <code>MongoDB</code> 聚合管道返回的文档数。</li>
<li>$skip：在聚合管道中跳过指定数量的文档，并返回余下的文档。</li>
<li>$unwind：将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值。</li>
<li>$group：将集合中的文档分组，可用于统计结果。</li>
<li>$sort：将输入文档排序后输出。</li>
<li>$geoNear：输出接近某一地理位置的有序文档。</li>
</ul>
<p>注意：当 <code>match</code> 条件和 <code>group</code> 同时存在时，顺序会影响检索结果，必须先写 <code>match</code> 在前面。</p>
<p>时间关键字如下：</p>
<ul>
<li>$dayOfYear: 返回该日期是这一年的第几天（全年 366 天）。</li>
<li>$dayOfMonth: 返回该日期是这一个月的第几天（1到31）。</li>
<li>$dayOfWeek: 返回的是这个周的星期几（1：星期日，7：星期六）。</li>
<li>$year: 返回该日期的年份部分。</li>
<li>$month： 返回该日期的月份部分（ 1 到 12）。</li>
<li>$week： 返回该日期是所在年的第几个星期（ 0 到 53）。</li>
<li>$hour： 返回该日期的小时部分。</li>
<li>$minute: 返回该日期的分钟部分。</li>
<li>$second: 返回该日期的秒部分（以0到59之间的数字形式返回日期的第二部分，但可以是60来计算闰秒）。</li>
<li>$millisecond：返回该日期的毫秒部分（ 0 到 999）。</li>
<li>$dateToString： { $dateToString: { format: , date: } }。</li>
</ul>
<p>实例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">&#x27;m_msg_tb&#x27;</span>).aggregate(</span><br><span class="line">[</span><br><span class="line">    &#123;<span class="variable">$match</span>:&#123;m_id:10001,mark_time:&#123;<span class="variable">$gt</span>:new Date(2017,8,0)&#125;&#125;&#125;,</span><br><span class="line">    &#123;<span class="variable">$group</span>: &#123;</span><br><span class="line">       _id: &#123;<span class="variable">$dayOfMonth</span>:<span class="string">&#x27;$mark_time&#x27;</span>&#125;,</span><br><span class="line">        pv: &#123;<span class="variable">$sum</span>: 1&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;<span class="variable">$sort</span>: &#123;<span class="string">&quot;_id&quot;</span>: 1&#125;&#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/mongodb/mongodb-tutorial.html">MongoDB 教程</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/22/MySql-%E4%BF%AE%E6%94%B9%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%BAutf8mb4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/22/MySql-%E4%BF%AE%E6%94%B9%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%BAutf8mb4/" class="post-title-link" itemprop="url">MySql 修改字符集为utf8mb4</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-22 09:56:56" itemprop="dateCreated datePublished" datetime="2020-09-22T09:56:56+00:00">2020-09-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-13 09:35:52" itemprop="dateModified" datetime="2021-01-13T09:35:52+00:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySql/" itemprop="url" rel="index"><span itemprop="name">MySql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><code>utf8mb4</code> 的最低mysql版本支持版本为5.5.3+，若不是，请升级到较新版本。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> VARIABLES <span class="keyword">WHERE</span> Variable_name <span class="keyword">LIKE</span> <span class="string">&#x27;character_set_%&#x27;</span> <span class="keyword">OR</span> Variable_name <span class="keyword">LIKE</span> <span class="string">&#x27;collation%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name            <span class="operator">|</span> <span class="keyword">Value</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> character_set_client     <span class="operator">|</span> utf8                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_connection <span class="operator">|</span> utf8                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_database   <span class="operator">|</span> utf8                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_filesystem <span class="operator">|</span> <span class="type">binary</span>                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_results    <span class="operator">|</span> utf8                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_server     <span class="operator">|</span> utf8                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_system     <span class="operator">|</span> utf8                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_sets_dir       <span class="operator">|</span> <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>mysql<span class="operator">/</span>share<span class="operator">/</span>charsets<span class="operator">/</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> collation_connection     <span class="operator">|</span> utf8_general_ci                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> collation_database       <span class="operator">|</span> utf8_general_ci                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> collation_server         <span class="operator">|</span> utf8_general_ci                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+----------------------------------+</span></span><br><span class="line"><span class="number">11</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 修改database默认的字符集</span><br><span class="line"># 虽然修改了database的字符集为utf8mb4，但是实际只是修改了database新创建的表，默认使用utf8mb4，</span><br><span class="line"># 原来已经存在的表，字符集并没有跟着改变，需要手动为每张表设置字符集</span><br><span class="line">ALTER DATABASE database_name CHARACTER SET &#x3D; utf8mb4 COLLATE &#x3D; utf8mb4_unicode_ci</span><br><span class="line"></span><br><span class="line"># 修改表默认的字符集 </span><br><span class="line">ALTER TABLE table_name DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</span><br><span class="line"></span><br><span class="line"># 修改表默认的字符集和所有字符列的字符集 </span><br><span class="line">ALTER TABLE table_name CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure>
<h2 id="修改MySQL配置文件"><a href="#修改MySQL配置文件" class="headerlink" title="修改MySQL配置文件"></a>修改MySQL配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 对本地的mysql客户端的配置</span><br><span class="line">[client]</span><br><span class="line">default-character-set &#x3D; utf8mb4</span><br><span class="line"></span><br><span class="line"># 对其他远程连接的mysql客户端的配置</span><br><span class="line">[mysql]</span><br><span class="line">default-character-set &#x3D; utf8mb4</span><br><span class="line"></span><br><span class="line"># 本地mysql服务的配置</span><br><span class="line">[mysqld]</span><br><span class="line">character-set-client-handshake &#x3D; FALSE</span><br><span class="line">character-set-server &#x3D; utf8mb4</span><br><span class="line">collation-server &#x3D; utf8mb4_unicode_ci</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 必须保证一下系统变量是 utf8mb4</span><br><span class="line"></span><br><span class="line"># 客户端来源数据使用的字符集</span><br><span class="line">character_set_client</span><br><span class="line"></span><br><span class="line"># 连接层字符集</span><br><span class="line">character_set_connection</span><br><span class="line"></span><br><span class="line"># 当前选中数据库的默认字符集</span><br><span class="line">character_set_database</span><br><span class="line"></span><br><span class="line"># 查询结果字符集</span><br><span class="line">character_set_results</span><br><span class="line"></span><br><span class="line"># 默认的内部操作字符集</span><br><span class="line">character_set_server</span><br></pre></td></tr></table></figure>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39390545/article/details/106946166">MySQL中的 utf8 并不是真正的UTF-8编码 ! !</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wang666/p/10282755.html">mysql 修改字符集为utf8mb4</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/eagle89/article/details/82148751">更改MySQL数据库的编码为utf8mb4</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://syxdevcode.github.com/2020/09/21/MongoDB%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="syxdevcode">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="syxdevcode博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/21/MongoDB%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" class="post-title-link" itemprop="url">MongoDB基本概念</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-21 17:00:48" itemprop="dateCreated datePublished" datetime="2020-09-21T17:00:48+00:00">2020-09-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-13 09:35:52" itemprop="dateModified" datetime="2021-01-13T09:35:52+00:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="MongoDB基本概念"><a href="#MongoDB基本概念" class="headerlink" title="MongoDB基本概念"></a>MongoDB基本概念</h2><p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200921170214.png" alt="微信截图_20200921170214.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以显示所有数据的列表</span></span><br><span class="line">show dbs</span><br><span class="line"></span><br><span class="line"><span class="comment"># db 显示当前数据库对象或集合</span></span><br><span class="line">&gt; db</span><br><span class="line"><span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># use 可以连接到一个指定的数据库</span></span><br><span class="line">use <span class="built_in">local</span></span><br></pre></td></tr></table></figure>
<p>数据库也通过名字来标识。数据库名可以是满足以下条件的任意 <code>UTF-8</code> 字符串。</p>
<ul>
<li>不能是空字符串（””)。</li>
<li>不得含有’ ‘（空格)、.、$、/、\和\0 (空字符)。</li>
<li>应全部小写。</li>
<li>最多64字节。</li>
</ul>
<p>有一些数据库名是保留的，可以直接访问这些有特殊作用的数据库。</p>
<ul>
<li>admin： 从权限的角度来看，这是 <code>root</code> 数据库。要是将一个用户添加到这个数据库，这个用户自动继承所有数据库的权限。一些特定的服务器端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器。</li>
<li>local: 这个数据永远不会被复制，可以用来存储限于本地单台服务器的任意集合</li>
<li>config: 当Mongo用于分片设置时，<code>config</code> 数据库在内部使用，用于保存分片的相关信息。</li>
</ul>
<h3 id="文档-Document"><a href="#文档-Document" class="headerlink" title="文档(Document)"></a>文档(Document)</h3><p>RDBMS (关系数据库管理系统：Relational Database Management System) 与 MongoDB 对应的术语:</p>
<p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200921170852.png" alt="微信截图_20200921170852.png"></p>
<p>需要注意的是：</p>
<ul>
<li>文档中的键/值对是有序的。</li>
<li>文档中的值不仅可以是在双引号里面的字符串，还可以是其他几种数据类型（甚至可以是整个嵌入的文档)。</li>
<li>MongoDB区分类型和大小写。</li>
<li>MongoDB的文档不能有重复的键。</li>
<li>文档的键是字符串。除了少数例外情况，键可以使用任意UTF-8字符。</li>
</ul>
<p>文档键命名规范：</p>
<ul>
<li>键不能含有\0 (空字符)。这个字符用来表示键的结尾。</li>
<li>.和$有特别的意义，只有在特定环境下才能使用。</li>
<li>以下划线”_”开头的键是保留的(不是严格要求的)。</li>
</ul>
<h3 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h3><p>当第一个文档插入时，集合就会被创建。</p>
<p>合法的集合名</p>
<ul>
<li>集合名不能是空字符串””。</li>
<li>集合名不能含有\0字符（空字符)，这个字符表示集合名的结尾。</li>
<li>集合名不能以”system.”开头，这是为系统集合保留的前缀。</li>
<li>用户创建的集合名字不能含有保留字符。有些驱动程序的确支持在集合名里面包含，这是因为某些系统生成的集合中包含该字符。除非你要访问这种系统创建的集合，否则千万不要在名字里出现$。</li>
</ul>
<h3 id="capped-collections"><a href="#capped-collections" class="headerlink" title="capped collections"></a>capped collections</h3><p>名词解释：</p>
<p>capped：用…覆盖顶部（或端部）</p>
<p><code>Capped collections</code> 就是固定大小的 <code>collection</code>。</p>
<p>它有很高的性能以及队列过期的特性(过期按照插入的顺序). 有点和 “RRD” 概念类似(round robin database,即环形数据库)。</p>
<p><code>Capped collections</code> 是高性能自动的维护对象的插入顺序。它非常适合类似记录日志的功能和标准的 <code>collection</code> 不同，你必须要显式的创建一个 <code>capped collection</code>，指定一个 <code>collection</code> 的大小，单位是字节。<code>collection</code> 的数据存储空间值提前分配的。</p>
<p><code>Capped collections</code> 可以按照文档的插入顺序保存到集合中，而且这些文档在磁盘上存放位置也是按照插入顺序来保存的，所以当我们更新 <code>Capped collections</code> 中文档的时候，更新后的文档不可以超过之前文档的大小，这样话就可以确保所有文档在磁盘上的位置一直保持不变。</p>
<p>由于 <code>Capped collection</code> 是按照文档的插入顺序而不是使用索引确定插入位置，这样的话可以提高增添数据的效率。<code>MongoDB</code> 的操作日志文件 <code>oplog.rs</code> 就是利用 <code>Capped Collection</code> 来实现的。</p>
<p>要注意的是指定的存储大小包含了数据库的头信息。</p>
<p><code>db.createCollection(&quot;mycoll&quot;, &#123;capped:true, size:100000&#125;)</code></p>
<p>size 是整个集合空间大小，单位为【KB】</p>
<p>max 是集合文档个数上线，单位是【个】</p>
<p>如果空间大小到达上限，则插入下一个文档时，会覆盖第一个文档；如果文档个数到达上限，同样插入下一个文档时，会覆盖第一个文档。<br>两个参数上限判断取的是【与】的逻辑。</p>
<ul>
<li>在 capped collection 中，你能添加新的对象。</li>
<li>能进行更新，然而，对象不会增加存储空间。如果增加，更新就会失败 。</li>
<li>使用 Capped Collection 不能删除一个文档，可以使用 <code>drop()</code> 方法删除 <code>collection</code> 所有的行。</li>
<li>删除之后，你必须显式的重新创建这个 <code>collection</code>。</li>
<li>在 32位机器中，capped collection 最大存储为 1e9( 1X109)个字节，约为482.5M,64位上只受系统文件大小的限制。。</li>
<li>对固定集合进行插入速度极快</li>
<li>按照插入顺序的查询输出速度极快</li>
<li>能够在插入最新数据时,淘汰最早的数据</li>
</ul>
<p>用法</p>
<p>用法1:储存日志信息<br>用法2:缓存一些少量的文档</p>
<h3 id="元数据"><a href="#元数据" class="headerlink" title="元数据"></a>元数据</h3><p>数据库的信息是存储在集合中。它们使用了系统的命名空间：</p>
<p><code>dbname.system.*</code></p>
<p>在MongoDB数据库中名字空间 <code>&lt;dbname&gt;.system.*</code> 是包含多种系统信息的特殊集合 <code>(Collection)</code>，如下:</p>
<p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200921174139.png" alt="微信截图_20200921174139.png"></p>
<p>对于修改系统集合中的对象有如下限制。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在 &#123;&#123;system.indexes&#125;&#125; 插入数据，可以创建索引。</span><br><span class="line">但除此之外该表信息是不可变的(特殊的 `drop index` 命令将自动更新相关信息)。</span><br><span class="line"></span><br><span class="line">&#123;&#123;system.users&#125;&#125; 是可修改的。 &#123;&#123;system.profile&#125;&#125; 是可删除的。</span><br></pre></td></tr></table></figure>
<h2 id="MongoDB-数据类型"><a href="#MongoDB-数据类型" class="headerlink" title="MongoDB 数据类型"></a>MongoDB 数据类型</h2><p><img src="/img/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200921174631.png" alt="微信截图_20200921174631.png"></p>
<p><strong>ObjectId</strong></p>
<p>ObjectId 类似唯一主键，可以很快的去生成和排序，包含 12 bytes，含义是：</p>
<ul>
<li>前 4 个字节表示创建 unix 时间戳,格林尼治时间 UTC 时间，比北京时间晚了 8 个小时</li>
<li>接下来的 3 个字节是机器标识码</li>
<li>紧接的两个字节由进程 id 组成 PID</li>
<li>最后三个字节是随机数</li>
</ul>
<p>MongoDB 中存储的文档必须有一个 <code>_id</code> 键。这个键的值可以是任何类型的，默认是个 <code>ObjectId</code>对象</p>
<p>由于 <code>ObjectId</code> 中保存了创建的时间戳，所以你不需要为你的文档保存时间戳字段，你可以通过 <code>getTimestamp</code> 函数来获取文档的创建时间:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; var newObject = ObjectId()</span><br><span class="line">&gt; newObject.getTimestamp()</span><br><span class="line">ISODate(<span class="string">&quot;2017-11-25T07:21:10Z&quot;</span>)</span><br><span class="line">ObjectId 转为字符串</span><br><span class="line"></span><br><span class="line">&gt; newObject.str</span><br><span class="line">5a1919e63df83ce79df8b38f</span><br></pre></td></tr></table></figure>
<p><strong>字符串</strong></p>
<p>BSON 字符串都是 UTF-8 编码。</p>
<p><strong>时间戳</strong></p>
<p>BSON 有一个特殊的时间戳类型用于 MongoDB 内部使用，与普通的 日期 类型不相关。 时间戳值是一个 64 位的值。其中：</p>
<p>前32位是一个 time_t 值（与Unix新纪元相差的秒数）<br>后32位是在某秒中操作的一个递增的序数<br>在单个 mongod 实例中，时间戳值通常是唯一的。</p>
<p>在复制集中， oplog 有一个 ts 字段。这个字段中的值使用BSON时间戳表示了操作时间。</p>
<p>BSON 时间戳类型主要用于 MongoDB 内部使用。在大多数情况下的应用开发中，你可以使用 BSON 日期类型。</p>
<p><strong>日期</strong></p>
<p>表示当前距离 Unix新纪元（1970年1月1日）的毫秒数。日期类型是有符号的, 负数表示 1970 年之前的日期。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; var mydate1 = new Date()     //格林尼治时间</span><br><span class="line">&gt; mydate1</span><br><span class="line">ISODate(<span class="string">&quot;2020-09-21T09:49:56.273Z&quot;</span>)</span><br><span class="line">&gt; typeof mydate1</span><br><span class="line">object</span><br><span class="line">&gt; var mydate2 = ISODate() //格林尼治时间</span><br><span class="line">&gt; mydate2</span><br><span class="line">ISODate(<span class="string">&quot;2020-09-21T09:50:29.386Z&quot;</span>)</span><br><span class="line">&gt; typeof mydate2</span><br><span class="line">object</span><br></pre></td></tr></table></figure>
<p>这样创建的时间是日期类型，可以使用 <code>JS</code> 中的 <code>Date</code> 类型的方法。</p>
<p>返回一个时间类型的字符串：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; var mydate1str = mydate1.toString()</span><br><span class="line">&gt; mydate1str</span><br><span class="line">Mon Sep 21 2020 17:49:56 GMT+0800</span><br><span class="line">&gt; typeof mydate1str</span><br><span class="line">string</span><br><span class="line">&gt; Date()</span><br><span class="line">Mon Sep 21 2020 17:51:15 GMT+0800  </span><br></pre></td></tr></table></figure>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/mongodb/mongodb-databases-documents-collections.html">MongoDB 概念解析</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">syxdevcode</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">343</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">111</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">152</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/syxdevcode" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;syxdevcode" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">syxdevcode</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
